!function(){"use strict";function e(e){return e.charCodeAt(0)-97+8*(e.charCodeAt(1)-49)}function t(e,t){const n=7&e,r=7&t,c=e>>3,s=t>>3;return Math.max(Math.abs(n-r),Math.abs(c-s))}function n(e){return e===e.toLowerCase()}const r=[8,1,-8,-1],c=[9,-9,7,-7],s=r.concat(c);function i(e,n,r){const c=[];return n.forEach((function(n){for(let s=e+n;s>=0&&s<64&&1===t(s,s-n)&&(c.push(s),!r.pieces[s]);s+=n);})),c}function o(o,u){if(u.includes("@"))return function(e){return"P"===e[0]?e.slice(1):e}(u);const l=function(e){return[e.slice(0,2),e.slice(2,4),e.slice(4,5)]}(u),a=e(l[0]),f=e(l[1]),h=o.pieces[a],p=o.pieces[f],d=o.pieces[a].toLowerCase();if("p"===d){let e;return e=u[0]===u[2]?l[1]:u[0]+"x"+l[1],l[2]&&(e+="="+l[2].toUpperCase()),e}if("k"==d&&(p&&n(h)===n(p)||t(a,f)>1))return f<a?"O-O-O":"O-O";let w=d.toUpperCase(),m=[];var g;"k"==d?m=[(g=f)-1,g-9,g-8,g-7,g+1,g+9,g+8,g+7].filter((function(e){return e>=0&&e<64&&1===t(g,e)})):"n"==d?m=function(e){return[e+17,e+15,e+10,e+6,e-6,e-10,e-15,e-17].filter((function(n){return n>=0&&n<64&&t(e,n)<=2}))}(f):"r"==d?m=i(f,r,o):"b"==d?m=i(f,c,o):"q"==d&&(m=i(f,s,o));let L=!1,C=!1;for(let e=0;e<m.length;e++)m[e]!==a&&o.pieces[m[e]]===h&&(a>>3==m[e]>>3&&(C=!0),(7&a)==(7&m[e])?L=!0:C=!0);return C&&(w+=u[0]),L&&(w+=u[1]),p&&(w+="x"),w+=l[1],w}function u(e,t){const n=function(e){const t=e.split(" "),n={pieces:{},turn:"w"===t[1]};return t[0].split("/").slice(0,8).forEach(((e,t)=>{let r=0;e.split("").forEach((e=>{if("~"==e)return;const c=parseInt(e,10);c?r+=c:(n.pieces[8*(7-t)+r]=e,r++)}))})),n}(e),r={};return t.forEach((function(e){const t=o(n,e);r[t]=e,t.includes("x")&&(r[t.replace("x","")]=e)})),r}const l=/^[a-h][1-8]$/,a=/^[a-h]$/,f=/^\w?@[a-h][1-8]$/,h=/^([a-h]x?)?[a-h](1|8)$/,p=/^([a-h]x?)?[a-h](1|8)=?[nbrqNBRQ]$/;function d(e,t){if(e in t)return t[e];const n=e.toLowerCase();for(const e in t)if(e.toLowerCase()===n)return t[e]}function w(e,t){return`${e} ${t}${1!=e?"s":""}`}lichess.keyboardMove=function(e){if(e.input.classList.contains("ready"))return;e.input.classList.add("ready");let t=null;const n=e=>!!e.match(l),r=function(r,s){if(!s.isTrusted)return;const i=(r=r.replace(/0/g,"O")).length>=2&&t&&d(r,t);if("resign"==r)e.ctrl.resign(!0,!0),c();else if(t&&i){if("o-o"===r.toLowerCase()&&t["O-O-O"]&&!s.force)return;if(n(r)&&e.ctrl.hasSelected()&&e.ctrl.select(r),r.match(h)&&t[r]&&!s.force)return;e.ctrl.san(i.slice(0,2),i.slice(2)),c()}else if(t&&n(r))e.ctrl.select(r),c();else if(t&&r.match(a));else if(t&&r.match(p)){const n=d(r.replace("=","").slice(0,-1),t);if(!n)return;e.ctrl.promote(n.slice(0,2),n.slice(2),r.slice(-1).toUpperCase()),c()}else if(r.match(f))3===r.length&&(r="P"+r),e.ctrl.drop(r.slice(2),r[0].toUpperCase()),c();else if(r.length>0&&"clock".startsWith(r.toLowerCase()))"clock"===r.toLowerCase()&&(!function(e){if(!e)return;const t=["white","black"].map((t=>{const n=e.millisOf(t),r=new Date(n);return`${t}: ${(n>=36e5?w(Math.floor(n/36e5),"hour"):"")+" "+w(r.getUTCMinutes(),"minute")+" "+w(r.getUTCSeconds(),"second")}`}));lichess.sound.say(t.join(". "))}(e.ctrl.clock()),c());else if(s.yourMove&&r.length>1)setTimeout((()=>lichess.sound.play("error")),500),e.input.value="";else{const n=r.length&&t&&!function(e,t){const n=e.replace("=","").toLowerCase();return Object.keys(t).filter((function(e){return e.toLowerCase().startsWith(n)}))}(r,t).length;n&&!e.input.classList.contains("wrong")&&lichess.sound.play("error"),e.input.classList.toggle("wrong",!!n)}},c=()=>{e.input.value="",e.input.classList.remove("wrong")};return function(e,t,n){window.Mousetrap.bind("enter",(()=>e.input.focus())),e.input.addEventListener("keyup",(r=>{if(!r.isTrusted)return;const c=r.target.value;c.includes("/")?(!function(){const e=document.querySelector(".mchat .mchat__say");e&&e.focus()}(),n()):""===c&&13==r.which?e.ctrl.confirmMove():t(c,{force:13===r.which,isTrusted:r.isTrusted})})),e.input.addEventListener("focus",(()=>e.ctrl.setFocus(!0))),e.input.addEventListener("blur",(()=>e.ctrl.setFocus(!1))),e.input.addEventListener("keydown",(t=>{t.which>36&&t.which<41&&(37==t.which?e.ctrl.jump(-1):38==t.which?e.ctrl.jump(-999):39==t.which?e.ctrl.jump(1):e.ctrl.jump(999),t.preventDefault())}))}(e,r,c),(n,c,s)=>{t=c&&c.size>0?u(n,function(e){const t=[];for(const[n,r]of e)r.forEach((function(e){t.push(n+e)}));return t}(c)):null,r(e.input.value,{isTrusted:!0,yourMove:s})}}}();
