var LichessTournament=function(){"use strict";const e={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,n){return document.createElementNS(e,t,n)},createTextNode:function(e){return document.createTextNode(e)},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,n){e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){e.appendChild(t)},parentNode:function(e){return e.parentNode},nextSibling:function(e){return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType}};function t(e,t,n,o,r){return{sel:e,data:t,children:n,text:o,elm:r,key:void 0===t?void 0:t.key}}const n=Array.isArray;function o(e){return"string"==typeof e||"number"==typeof e}function r(e){return void 0===e}function a(e){return void 0!==e}const s=t("",{},[],void 0,void 0);function i(e,t){var n,o;const r=e.key===t.key,a=(null===(n=e.data)||void 0===n?void 0:n.is)===(null===(o=t.data)||void 0===o?void 0:o.is);return e.sel===t.sel&&r&&a}function c(e,t,n){var o;const r={};for(let a=t;a<=n;++a){const t=null===(o=e[a])||void 0===o?void 0:o.key;void 0!==t&&(r[t]=a)}return r}const l=["create","update","remove","destroy","pre","post"];function d(d,u){let h,p;const m={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},f=void 0!==u?u:e;for(h=0;h<l.length;++h)for(m[l[h]]=[],p=0;p<d.length;++p){const e=d[p][l[h]];void 0!==e&&m[l[h]].push(e)}function g(e){const n=e.id?"#"+e.id:"",o=e.className?"."+e.className.split(" ").join("."):"";return t(f.tagName(e).toLowerCase()+n+o,{},[],void 0,e)}function v(e,t){return function(){if(0==--t){const t=f.parentNode(e);f.removeChild(t,e)}}}function b(e,t){var i,c;let l,d=e.data;if(void 0!==d){const t=null===(i=d.hook)||void 0===i?void 0:i.init;a(t)&&(t(e),d=e.data)}const u=e.children,h=e.sel;if("!"===h)r(e.text)&&(e.text=""),e.elm=f.createComment(e.text);else if(void 0!==h){const r=h.indexOf("#"),i=h.indexOf(".",r),p=r>0?r:h.length,g=i>0?i:h.length,v=-1!==r||-1!==i?h.slice(0,Math.min(p,g)):h,w=e.elm=a(d)&&a(l=d.ns)?f.createElementNS(l,v,d):f.createElement(v,d);for(p<g&&w.setAttribute("id",h.slice(p+1,g)),i>0&&w.setAttribute("class",h.slice(g+1).replace(/\./g," ")),l=0;l<m.create.length;++l)m.create[l](s,e);if(n(u))for(l=0;l<u.length;++l){const e=u[l];null!=e&&f.appendChild(w,b(e,t))}else o(e.text)&&f.appendChild(w,f.createTextNode(e.text));const y=e.data.hook;a(y)&&(null===(c=y.create)||void 0===c||c.call(y,s,e),y.insert&&t.push(e))}else e.elm=f.createTextNode(e.text);return e.elm}function w(e,t,n,o,r,a){for(;o<=r;++o){const r=n[o];null!=r&&f.insertBefore(e,b(r,a),t)}}function y(e){var t,n;const o=e.data;if(void 0!==o){null===(n=null===(t=null==o?void 0:o.hook)||void 0===t?void 0:t.destroy)||void 0===n||n.call(t,e);for(let t=0;t<m.destroy.length;++t)m.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const n=e.children[t];null!=n&&"string"!=typeof n&&y(n)}}}function k(e,t,n,o){for(var r,s;n<=o;++n){let o,i;const c=t[n];if(null!=c)if(a(c.sel)){y(c),o=m.remove.length+1,i=v(c.elm,o);for(let e=0;e<m.remove.length;++e)m.remove[e](c,i);const e=null===(s=null===(r=null==c?void 0:c.data)||void 0===r?void 0:r.hook)||void 0===s?void 0:s.remove;a(e)?e(c,i):i()}else f.removeChild(e,c.elm)}}function T(e,t,n){var o,s,l,d,u;const h=null===(o=t.data)||void 0===o?void 0:o.hook;null===(s=null==h?void 0:h.prepatch)||void 0===s||s.call(h,e,t);const p=t.elm=e.elm,g=e.children,v=t.children;if(e!==t){if(void 0!==t.data){for(let n=0;n<m.update.length;++n)m.update[n](e,t);null===(d=null===(l=t.data.hook)||void 0===l?void 0:l.update)||void 0===d||d.call(l,e,t)}r(t.text)?a(g)&&a(v)?g!==v&&function(e,t,n,o){let a,s,l,d,u=0,h=0,p=t.length-1,m=t[0],g=t[p],v=n.length-1,y=n[0],x=n[v];for(;u<=p&&h<=v;)null==m?m=t[++u]:null==g?g=t[--p]:null==y?y=n[++h]:null==x?x=n[--v]:i(m,y)?(T(m,y,o),m=t[++u],y=n[++h]):i(g,x)?(T(g,x,o),g=t[--p],x=n[--v]):i(m,x)?(T(m,x,o),f.insertBefore(e,m.elm,f.nextSibling(g.elm)),m=t[++u],x=n[--v]):i(g,y)?(T(g,y,o),f.insertBefore(e,g.elm,m.elm),g=t[--p],y=n[++h]):(void 0===a&&(a=c(t,u,p)),s=a[y.key],r(s)?f.insertBefore(e,b(y,o),m.elm):(l=t[s],l.sel!==y.sel?f.insertBefore(e,b(y,o),m.elm):(T(l,y,o),t[s]=void 0,f.insertBefore(e,l.elm,m.elm))),y=n[++h]);(u<=p||h<=v)&&(u>p?(d=null==n[v+1]?null:n[v+1].elm,w(e,d,n,h,v,o)):k(e,t,u,p))}(p,g,v,n):a(v)?(a(e.text)&&f.setTextContent(p,""),w(p,null,v,0,v.length-1,n)):a(g)?k(p,g,0,g.length-1):a(e.text)&&f.setTextContent(p,""):e.text!==t.text&&(a(g)&&k(p,g,0,g.length-1),f.setTextContent(p,t.text)),null===(u=null==h?void 0:h.postpatch)||void 0===u||u.call(h,e,t)}}return function(e,t){let n,o,r;const a=[];for(n=0;n<m.pre.length;++n)m.pre[n]();for(function(e){return void 0!==e.sel}(e)||(e=g(e)),i(e,t)?T(e,t,a):(o=e.elm,r=f.parentNode(o),b(t,a),null!==r&&(f.insertBefore(r,t.elm,f.nextSibling(o)),k(r,[e],0,0))),n=0;n<a.length;++n)a[n].data.hook.insert(a[n]);for(n=0;n<m.post.length;++n)m.post[n]();return t}}function u(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let e=0;e<t.length;++e){const n=t[e].data;void 0!==n&&u(n,t[e].children,t[e].sel)}}function h(e,r,a){let s,i,c,l={};if(void 0!==a?(null!==r&&(l=r),n(a)?s=a:o(a)?i=a:a&&a.sel&&(s=[a])):null!=r&&(n(r)?s=r:o(r)?i=r:r&&r.sel?s=[r]:l=r),void 0!==s)for(c=0;c<s.length;++c)o(s[c])&&(s[c]=t(void 0,void 0,void 0,s[c],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||u(l,s,e),t(e,l,s,i,void 0)}function p(e,t){e.data.fn=t.data.fn,e.data.args=t.data.args,t.data=e.data,t.children=e.children,t.text=e.text,t.elm=e.elm}function m(e){const t=e.data;p(t.fn(...t.args),e)}function f(e,t){let n;const o=e.data,r=t.data,a=o.args,s=r.args;if(o.fn===r.fn&&a.length===s.length){for(n=0;n<s.length;++n)if(a[n]!==s[n])return void p(r.fn(...s),t);p(e,t)}else p(r.fn(...s),t)}function g(e,t){let n;const o=t.elm;let r=e.data.attrs,a=t.data.attrs;if((r||a)&&r!==a){for(n in r=r||{},a=a||{},a){const e=a[n];r[n]!==e&&(!0===e?o.setAttribute(n,""):!1===e?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,e):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,e):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,e):o.setAttribute(n,e))}for(n in r)n in a||o.removeAttribute(n)}}const v={create:g,update:g};function b(e,t){let n,o;const r=t.elm;let a=e.data.class,s=t.data.class;if((a||s)&&a!==s){for(o in a=a||{},s=s||{},a)a[o]&&!Object.prototype.hasOwnProperty.call(s,o)&&r.classList.remove(o);for(o in s)n=s[o],n!==a[o]&&r.classList[n?"add":"remove"](o)}}const w={create:b,update:b},y=["white","black"],k=["a","b","c","d","e","f","g","h"],T=["1","2","3","4","5","6","7","8"],x=[...T].reverse(),C=Array.prototype.concat(...k.map((e=>T.map((t=>e+t))))),S=e=>C[8*e[0]+e[1]],P=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],_=C.map(P);const M=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},I=e=>"white"===e?"black":"white",O=(e,t)=>{const n=e[0]-t[0],o=e[1]-t[1];return n*n+o*o},j=(e,t)=>e.role===t.role&&e.color===t.color,L=(e,t,n,o)=>[(t?e[0]:7-e[0])*n,(t?7-e[1]:e[1])*o],N=e=>{const t=e.width/8,n=e.height/8;return(e,o)=>L(e,o,t,n)},A=(e,t)=>L(e,t,100,100),q=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},E=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},B=(e,t)=>{e.style.visibility=t?"visible":"hidden"},R=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},W=e=>2===e.buttons||2===e.button,F=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function D(e,t,n){const o=P(e);return t||(o[0]=7-o[0],o[1]=7-o[1]),[n.left+n.width*o[0]/8+n.width/16,n.top+n.height*(7-o[1])/8+n.height/16]}function K(e,t){return Math.abs(e-t)}const G=(e,t,n,o)=>{const r=K(e,n),a=K(t,o);return 1===r&&2===a||2===r&&1===a},z=(e,t,n,o)=>K(e,n)===K(t,o),H=(e,t,n,o)=>e===n||t===o,V=(e,t,n,o)=>z(e,t,n,o)||H(e,t,n,o);function U(e,t,n){const o=e.get(t);if(!o)return[];const r=P(t),a=o.role,s="pawn"===a?(i=o.color,(e,t,n,o)=>K(e,n)<2&&("white"===i?o===t+1||t<=1&&o===t+2&&e===n:o===t-1||t>=6&&o===t-2&&e===n)):"knight"===a?G:"bishop"===a?z:"rook"===a?H:"queen"===a?V:function(e,t,n){return(o,r,a,s)=>K(o,a)<2&&K(r,s)<2||n&&r===s&&r===("white"===e?0:7)&&(4===o&&(2===a&&t.includes(0)||6===a&&t.includes(7))||t.includes(a))}(o.color,function(e,t){const n="white"===t?"1":"8",o=[];for(const[r,a]of e)r[1]===n&&a.color===t&&"rook"===a.role&&o.push(P(r)[0]);return o}(e,o.color),n);var i;return _.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&s(r[0],r[1],e[0],e[1]))).map(S)}function X(e,...t){e&&setTimeout((()=>e(...t)),1)}function Y(e){e.premovable.current&&(e.premovable.current=void 0,X(e.premovable.events.unset))}function Z(e){const t=e.predroppable;t.current&&(t.current=void 0,X(t.events.unset))}function Q(e,t,n){const o=e.pieces.get(t),r=e.pieces.get(n);if(t===n||!o)return!1;const a=r&&r.color!==o.color?r:void 0;return n===e.selected&&ae(e),X(e.events.move,t,n,a),function(e,t,n){if(!e.autoCastle)return!1;const o=e.pieces.get(t);if(!o||"king"!==o.role)return!1;const r=P(t),a=P(n);if(0!==r[1]&&7!==r[1]||r[1]!==a[1])return!1;4!==r[0]||e.pieces.has(n)||(6===a[0]?n=S([7,a[1]]):2===a[0]&&(n=S([0,a[1]])));const s=e.pieces.get(n);return!(!s||s.color!==o.color||"rook"!==s.role||(e.pieces.delete(t),e.pieces.delete(n),r[0]<a[0]?(e.pieces.set(S([6,a[1]]),o),e.pieces.set(S([5,a[1]]),s)):(e.pieces.set(S([2,a[1]]),o),e.pieces.set(S([3,a[1]]),s)),0))}(e,t,n)||(e.pieces.set(n,o),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,X(e.events.change),a||!0}function J(e,t,n,o){if(e.pieces.has(n)){if(!o)return!1;e.pieces.delete(n)}return X(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,X(e.events.change),e.movable.dests=void 0,e.turnColor=I(e.turnColor),!0}function ee(e,t,n){const o=Q(e,t,n);return o&&(e.movable.dests=void 0,e.turnColor=I(e.turnColor),e.animation.current=void 0),o}function te(e,t,n){if(ie(e,t,n)){const o=ee(e,t,n);if(o){const r=e.hold.stop();ae(e);const a={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==o&&(a.captured=o),X(e.movable.events.after,t,n,a),!0}}else if(function(e,t,n){return t!==n&&ce(e,t)&&U(e.pieces,t,e.premovable.castle).includes(n)}(e,t,n))return function(e,t,n,o){Z(e),e.premovable.current=[t,n],X(e.premovable.events.set,t,n,o)}(e,t,n,{ctrlKey:e.stats.ctrlKey}),ae(e),!0;return ae(e),!1}function ne(e,t,n,o){const r=e.pieces.get(t);r&&(function(e,t,n){const o=e.pieces.get(t);return!(!o||t!==n&&e.pieces.has(n)||"both"!==e.movable.color&&(e.movable.color!==o.color||e.turnColor!==o.color))}(e,t,n)||o)?(e.pieces.delete(t),J(e,r,n,o),X(e.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&function(e,t,n){const o=e.pieces.get(t),r=e.pieces.get(n);return!!o&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==o.role||"1"!==n[1]&&"8"!==n[1])&&e.movable.color===o.color&&e.turnColor!==o.color}(e,t,n)?function(e,t,n){Y(e),e.predroppable.current={role:t,key:n},X(e.predroppable.events.set,t,n)}(e,r.role,n):(Y(e),Z(e)),e.pieces.delete(t),ae(e)}function oe(e,t,n){if(X(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return ae(e),void e.hold.cancel();if((e.selectable.enabled||n)&&e.selected!==t&&te(e,e.selected,t))return void(e.stats.dragged=!1)}(se(e,t)||ce(e,t))&&(re(e,t),e.hold.start())}function re(e,t){e.selected=t,ce(e,t)?e.premovable.dests=U(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function ae(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function se(e,t){const n=e.pieces.get(t);return!!n&&("both"===e.movable.color||e.movable.color===n.color&&e.turnColor===n.color)}function ie(e,t,n){var o,r;return t!==n&&se(e,t)&&(e.movable.free||!!(null===(r=null===(o=e.movable.dests)||void 0===o?void 0:o.get(t))||void 0===r?void 0:r.includes(n)))}function ce(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function le(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],o=t[1];let r=!1;if(ie(e,n,o)){const t=ee(e,n,o);if(t){const a={premove:!0};!0!==t&&(a.captured=t),X(e.movable.events.after,n,o,a),r=!0}}return Y(e),r}function de(e){Y(e),Z(e),ae(e)}function ue(e){e.movable.color=e.movable.dests=e.animation.current=void 0,de(e)}function he(e,t,n){let o=Math.floor(8*(e[0]-n.left)/n.width);t||(o=7-o);let r=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(r=7-r),o>=0&&o<8&&r>=0&&r<8?S([o,r]):void 0}function pe(e){return"white"===e.orientation}const me="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",fe={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},ge={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function ve(e){"start"===e&&(e=me);const t=new Map;let n=7,o=0;for(const r of e)switch(r){case" ":return t;case"/":if(--n,n<0)return t;o=0;break;case"~":{const e=t.get(S([o,n]));e&&(e.promoted=!0);break}default:{const e=r.charCodeAt(0);if(e<57)o+=e-48;else{const e=r.toLowerCase();t.set(S([o,n]),{role:fe[e],color:r===e?"black":"white"}),++o}}}return t}function be(e,t){var n,o;if((null===(n=t.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(o=t.drawable)||void 0===o?void 0:o.autoShapes)&&(e.drawable.autoShapes=[]),we(e,t),t.fen&&(e.pieces=ve(t.fen),e.drawable.shapes=[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[n,o]of e.pieces)"king"===o.role&&o.color===t&&(e.check=n)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&re(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",n="e"+t,o=e.movable.dests.get(n),r=e.pieces.get(n);if(!o||!r||"king"!==r.role)return;e.movable.dests.set(n,o.filter((e=>!(e==="a"+t&&o.includes("c"+t)||e==="h"+t&&o.includes("g"+t)))))}}function we(e,t){for(const n in t)ye(e[n])&&ye(t[n])?we(e[n],t[n]):e[n]=t[n]}function ye(e){return"object"==typeof e}function ke(e,t){return t.animation.enabled?function(e,t){const n=new Map(t.pieces),o=e(t),r=function(e,t){const n=new Map,o=[],r=new Map,a=[],s=[],i=new Map;let c,l,d;for(const[t,n]of e)i.set(t,xe(t,n));for(const e of C)c=t.pieces.get(e),l=i.get(e),c?l?j(c,l.piece)||(a.push(l),s.push(xe(e,c))):s.push(xe(e,c)):l&&a.push(l);for(const e of s)l=Ce(e,a.filter((t=>j(e.piece,t.piece)))),l&&(d=[l.pos[0]-e.pos[0],l.pos[1]-e.pos[1]],n.set(e.key,d.concat(d)),o.push(l.key));for(const e of a)o.includes(e.key)||r.set(e.key,e.piece);return{anims:n,fadings:r}}(n,t);if(r.anims.size||r.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},e||Se(t,performance.now())}else t.dom.redraw();return o}(e,t):Te(e,t)}function Te(e,t){const n=e(t);return t.dom.redraw(),n}function xe(e,t){return{key:e,pos:P(e),piece:t}}function Ce(e,t){return t.sort(((t,n)=>O(e.pos,t.pos)-O(e.pos,n.pos)))[0]}function Se(e,t){const n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());const o=1-(t-n.start)*n.frequency;if(o<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=(r=o)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of n.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>Se(e,t)))}var r}const Pe=["green","red","blue","yellow"];function _e(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?ae(e):de(e);const n=R(t),o=he(n,pe(e),e.dom.bounds());o&&(e.drawable.current={orig:o,pos:n,brush:$e(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Me(e))}function Me(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const n=he(t.pos,pe(e),e.dom.bounds());n||(t.snapToValidMove=!1);const o=t.snapToValidMove?function(e,t,n,o){const r=P(e),a=_.filter((e=>V(r[0],r[1],e[0],e[1])||G(r[0],r[1],e[0],e[1]))),s=a.map((e=>D(S(e),n,o))).map((e=>O(t,e))),[,i]=s.reduce(((e,t,n)=>e[0]<t?e:[t,n]),[s[0],0]);return S(a[i])}(t.orig,t.pos,pe(e),e.dom.bounds()):n;o!==t.mouseSq&&(t.mouseSq=o,t.dest=o!==t.orig?o:void 0,e.dom.redrawNow()),Me(e)}}))}function Ie(e,t){e.drawable.current&&(e.drawable.current.pos=R(t))}function Oe(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const n=e=>e.orig===t.orig&&e.dest===t.dest,o=e.shapes.find(n);o&&(e.shapes=e.shapes.filter((e=>!n(e))));o&&o.brush===t.brush||e.shapes.push(t);Le(e)}(e.drawable,t),je(e))}function je(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function $e(e){var t;const n=(e.shiftKey||e.ctrlKey)&&W(e),o=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return Pe[(n?1:0)+(o?2:0)]}function Le(e){e.onChange&&e.onChange(e.shapes)}function Ne(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),o=R(t),r=he(o,pe(e),n);if(!r)return;const a=e.pieces.get(r),s=e.selected;var i;s||!e.drawable.enabled||!e.drawable.eraseOnClick&&a&&a.color===e.turnColor||(i=e).drawable.shapes.length&&(i.drawable.shapes=[],i.dom.redraw(),Le(i.drawable)),!1===t.cancelable||t.touches&&e.movable.color&&!a&&!s&&!function(e,t){const n=pe(e),o=e.dom.bounds(),r=Math.pow(o.width/8,2);for(const a in e.pieces){const e=D(a,n,o);if(O(e,t)<=r)return!0}return!1}(e,o)||t.preventDefault();const c=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&ie(e,e.selected,r)?ke((e=>oe(e,r)),e):oe(e,r);const d=e.selected===r,u=We(e,r);if(a&&u&&d&&function(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:a,origPos:o,pos:o,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:s,originTarget:t.target},u.cgDragging=!0,u.classList.add("dragging");const i=e.dom.elements.ghost;i&&(i.className=`ghost ${a.color} ${a.role}`,q(i,N(n)(P(r),pe(e))),B(i,!0)),Ae(e)}else c&&Y(e),l&&Z(e);e.dom.redraw()}function Ae(e){requestAnimationFrame((()=>{var t;const n=e.draggable.current;if(!n)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(n.orig))&&(e.animation.current=void 0);const o=e.pieces.get(n.orig);if(o&&j(o,n.piece)){if(!n.started&&O(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const e=n.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),n.element=e}const t=e.dom.bounds();q(n.element,[n.pos[0]-t.left-t.width/16,n.pos[1]-t.top-t.height/16])}}else Be(e);Ae(e)}))}function qe(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=R(t))}function Ee(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);Y(e),Z(e);const o=he(R(t)||n.pos,pe(e),e.dom.bounds());o&&n.started&&n.orig!==o?n.newPiece?ne(e,n.orig,o,n.force):(e.stats.ctrlKey=t.ctrlKey,te(e,n.orig,o)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!o&&(e.pieces.delete(n.orig),X(e.events.change)),(n.orig!==n.previouslySelected||n.orig!==o&&o)&&e.selectable.enabled||ae(e),Re(e),e.draggable.current=void 0,e.dom.redraw()}function Be(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,ae(e),Re(e),e.dom.redraw())}function Re(e){const t=e.dom.elements;t.ghost&&B(t.ghost,!1)}function We(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function Fe(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function De(e,t){function n(){!function(e){e.orientation=I(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&n(),(t.fen?ke:Te)((e=>be(e,t)),e)},state:e,getFen:()=>{return t=e.pieces,x.map((e=>k.map((n=>{const o=t.get(n+e);if(o){const e=ge[o.role];return"white"===o.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:n,setPieces(t){ke((e=>function(e,t){for(const[n,o]of t)o?e.pieces.set(n,o):e.pieces.delete(n)}(e,t)),e)},selectSquare(t,n){t?ke((e=>oe(e,t,n)),e):e.selected&&(ae(e),e.dom.redraw())},move(t,n){ke((e=>Q(e,t,n)),e)},newPiece(t,n){ke((e=>J(e,t,n)),e)},playPremove(){if(e.premovable.current){if(ke(le,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const n=function(e,t){const n=e.predroppable.current;let o=!1;if(!n)return!1;t(n)&&J(e,{role:n.role,color:e.movable.color},n.key)&&(X(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),o=!0);return Z(e),o}(e,t);return e.dom.redraw(),n}return!1},cancelPremove(){Te(Y,e)},cancelPredrop(){Te(Z,e)},cancelMove(){Te((e=>{de(e),Be(e)}),e)},stop(){Te((e=>{ue(e),Be(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{Fe(e,2),setTimeout((()=>Fe(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){Te((e=>e.drawable.autoShapes=t),e)},setShapes(t){Te((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>he(t,pe(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,n,o){!function(e,t,n,o){const r="a0";e.pieces.set(r,t),e.dom.redraw();const a=R(n);e.draggable.current={orig:r,piece:t,origPos:a,pos:a,started:!0,element:()=>We(e,r),originTarget:n.target,newPiece:!0,force:!!o},Ae(e)}(e,t,n,o)},destroy(){ue(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Ke(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Ge(e,t,n){const o=e.drawable,r=o.current,a=r&&r.mouseSq?r:void 0,s=new Map,i=e.dom.bounds();for(const e of o.shapes.concat(o.autoShapes).concat(a?[a]:[]))e.dest&&s.set(e.dest,(s.get(e.dest)||0)+1);const c=o.shapes.concat(o.autoShapes).map((e=>({shape:e,current:!1,hash:He(e,s,!1,i)})));a&&c.push({shape:a,current:!0,hash:He(a,s,!0,i)});const l=c.map((e=>e.hash)).join(";");if(l===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=l;const d=t.querySelector("defs"),u=t.querySelector("g"),h=n.querySelector("g");!function(e,t,n){const o=new Map;let r;for(const n of t)n.shape.dest&&(r=e.brushes[n.shape.brush],n.shape.modifiers&&(r=Je(r,n.shape.modifiers)),o.set(r.key,r));const a=new Set;let s=n.firstChild;for(;s;)a.add(s.getAttribute("cgKey")),s=s.nextSibling;for(const[e,t]of o.entries())a.has(e)||n.appendChild(Ye(t))}(o,c,d),ze(e,c.filter((e=>!e.shape.customSvg)),o.brushes,s,u),ze(e,c.filter((e=>e.shape.customSvg)),o.brushes,s,h)}function ze(e,t,n,o,r){const a=e.dom.bounds(),s=new Map,i=[];for(const e of t)s.set(e.hash,!1);let c,l=r.firstChild;for(;l;)c=l.getAttribute("cgHash"),s.has(c)?s.set(c,!0):i.push(l),l=l.nextSibling;for(const e of i)r.removeChild(e);for(const i of t)s.get(i.hash)||r.appendChild(Xe(e,i,n,o,a))}function He({orig:e,dest:t,brush:n,piece:o,modifiers:r,customSvg:a},s,i,c){return[c.width,c.height,i,e,t,n,t&&(s.get(t)||0)>1,o&&Ve(o),r&&(l=r,""+(l.lineWidth||"")),a&&Ue(a)].filter((e=>e)).join(",");var l}function Ve(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function Ue(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return"custom-"+t.toString()}function Xe(e,{shape:t,current:n,hash:o},r,a,s){let i;if(t.customSvg){const n=Qe(P(t.orig),e.orientation);i=function(e,t,n){const{width:o,height:r}=n,a=o/8,s=r/8,i=t[0]*a,c=(7-t[1])*s,l=Ze(Ke("g"),{transform:`translate(${i},${c})`}),d=Ze(Ke("svg"),{width:a,height:s,viewBox:"0 0 100 100"});return l.appendChild(d),d.innerHTML=e,l}(t.customSvg,n,s)}else if(t.piece)i=function(e,t,n,o){const r=nt(t,o),a=o.width/8*(n.scale||1),s=n.color[0]+("knight"===n.role?"n":n.role[0]).toUpperCase();return Ze(Ke("image"),{className:`${n.role} ${n.color}`,x:r[0]-a/2,y:r[1]-a/2,width:a,height:a,href:e+s+".svg"})}(e.drawable.pieces.baseUrl,Qe(P(t.orig),e.orientation),t.piece,s);else{const o=Qe(P(t.orig),e.orientation);if(t.dest){let c=r[t.brush];t.modifiers&&(c=Je(c,t.modifiers)),i=function(e,t,n,o,r,a){const s=function(e,t){return(t?20:10)/512*e.width}(a,r&&!o),i=nt(t,a),c=nt(n,a),l=c[0]-i[0],d=c[1]-i[1],u=Math.atan2(d,l),h=Math.cos(u)*s,p=Math.sin(u)*s;return Ze(Ke("line"),{stroke:e.color,"stroke-width":et(e,o,a),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:tt(e,o),x1:i[0],y1:i[1],x2:c[0]-h,y2:c[1]-p})}(c,o,Qe(P(t.dest),e.orientation),n,(a.get(t.dest)||0)>1,s)}else i=function(e,t,n,o){const r=nt(t,o),a=function(e){const t=e.width/512;return[3*t,4*t]}(o),s=(o.width+o.height)/32;return Ze(Ke("circle"),{stroke:e.color,"stroke-width":a[n?0:1],fill:"none",opacity:tt(e,n),cx:r[0],cy:r[1],r:s-a[1]/2})}(r[t.brush],o,n,s)}return i.setAttribute("cgHash",o),i}function Ye(e){const t=Ze(Ke("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(Ze(Ke("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Ze(e,t){for(const n in t)e.setAttribute(n,t[n]);return e}function Qe(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function Je(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function et(e,t,n){return(e.lineWidth||10)*(t?.85:1)/512*n.width}function tt(e,t){return(e.opacity||1)*(t?.9:1)}function nt(e,t){return[(e[0]+.5)*t.width/8,(7.5-e[1])*t.height/8]}function ot(e,t){const n=F("coords",t);let o;for(const t of e)o=F("coord"),o.textContent=t,n.appendChild(o);return n}function rt(e,t){const n=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(n)}if(e.viewOnly)return;const o=function(e){return t=>{e.draggable.current?Be(e):e.drawable.current?je(e):t.shiftKey||W(t)?e.drawable.enabled&&_e(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;Y(e),Z(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const o=R(t),r=o&&he(o,pe(e),e.dom.bounds());r&&ne(e,"a0",r)}e.dom.redraw()}(e,t):Ne(e,t))}}(e);n.addEventListener("touchstart",o,{passive:!1}),n.addEventListener("mousedown",o,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault()))}function at(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function st(e,t,n){return o=>{e.drawable.current?e.drawable.enabled&&n(e,o):e.viewOnly||t(e,o)}}function it(e){const t=pe(e),n=e.dom.relative?A:N(e.dom.bounds()),o=e.dom.relative?E:q,r=e.dom.elements.board,a=e.pieces,s=e.animation.current,i=s?s.plan.anims:new Map,c=s?s.plan.fadings:new Map,l=e.draggable.current,d=function(e){var t;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)pt(n,t,"last-move");e.check&&e.highlight.check&&pt(n,e.check,"check");if(e.selected&&(pt(n,e.selected,"selected"),e.movable.showDests)){const o=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(o)for(const t of o)pt(n,t,"move-dest"+(e.pieces.has(t)?" oc":""));const r=e.premovable.dests;if(r)for(const t of r)pt(n,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const o=e.premovable.current;if(o)for(const e of o)pt(n,e,"current-premove");else e.predroppable.current&&pt(n,e.predroppable.current.key,"current-premove");const r=e.exploding;if(r)for(const e of r.keys)pt(n,e,"exploding"+r.stage);return n}(e),u=new Set,h=new Set,p=new Map,m=new Map;let f,g,v,b,w,y,k,T,x,C;for(g=r.firstChild;g;){if(f=g.cgKey,ct(g))if(v=a.get(f),w=i.get(f),y=c.get(f),b=g.cgPiece,!g.cgDragging||l&&l.orig===f||(g.classList.remove("dragging"),o(g,n(P(f),t)),g.cgDragging=!1),!y&&g.cgFading&&(g.cgFading=!1,g.classList.remove("fading")),v){if(w&&g.cgAnimating&&b===ht(v)){const e=P(f);e[0]+=w[2],e[1]+=w[3],g.classList.add("anim"),o(g,n(e,t))}else g.cgAnimating&&(g.cgAnimating=!1,g.classList.remove("anim"),o(g,n(P(f),t)),e.addPieceZIndex&&(g.style.zIndex=ut(P(f),t)));b!==ht(v)||y&&g.cgFading?y&&b===ht(y)?(g.classList.add("fading"),g.cgFading=!0):mt(p,b,g):u.add(f)}else mt(p,b,g);else if(lt(g)){const e=g.className;d.get(f)===e?h.add(f):mt(m,e,g)}g=g.nextSibling}for(const[e,a]of d)if(!h.has(e)){x=m.get(a),C=x&&x.pop();const s=n(P(e),t);if(C)C.cgKey=e,o(C,s);else{const t=F("square",a);t.cgKey=e,o(t,s),r.insertBefore(t,r.firstChild)}}for(const[s,c]of a)if(w=i.get(s),!u.has(s))if(k=p.get(ht(c)),T=k&&k.pop(),T){T.cgKey=s,T.cgFading&&(T.classList.remove("fading"),T.cgFading=!1);const r=P(s);e.addPieceZIndex&&(T.style.zIndex=ut(r,t)),w&&(T.cgAnimating=!0,T.classList.add("anim"),r[0]+=w[2],r[1]+=w[3]),o(T,n(r,t))}else{const a=ht(c),i=F("piece",a),l=P(s);i.cgPiece=a,i.cgKey=s,w&&(i.cgAnimating=!0,l[0]+=w[2],l[1]+=w[3]),o(i,n(l,t)),e.addPieceZIndex&&(i.style.zIndex=ut(l,t)),r.appendChild(i)}for(const t of p.values())dt(e,t);for(const t of m.values())dt(e,t)}function ct(e){return"PIECE"===e.tagName}function lt(e){return"SQUARE"===e.tagName}function dt(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function ut(e,t){let n=2+8*e[1]+(7-e[0]);return t&&(n=67-n),n+""}function ht(e){return`${e.color} ${e.role}`}function pt(e,t,n){const o=e.get(t);o?e.set(t,`${o} ${n}`):e.set(t,n)}function mt(e,t,n){const o=e.get(t);o?o.push(n):e.set(t,[n])}function ft(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}function gt(e,t){const n=e.substring(0,14);return h("a",{class:{"user-link":!0,ulpt:!0},attrs:{href:"/@/"+e}},t&&"BOT"!=t?[h("span.utitle",t),n]:[n])}function vt(e,t){return{insert(n){n.elm.addEventListener(e,t)}}}const bt={start:["hi/Hello","gl/Good luck","hf/Have fun!","u2/You too!"].map(wt),end:["gg/Good game","wp/Well played","ty/Thank you","gtg/I've got to go","bye/Bye!"].map(wt)};function wt(e){const t=e.split("/");return{key:t[0],text:t[1]}}const yt=e=>void 0!==e,kt=e=>{let t=e;return function(e){return yt(e)&&(t=e),t}},Tt={Accept:"application/vnd.lichess.v5+json"},xt={cache:"no-cache",credentials:"same-origin"},Ct={"X-Requested-With":"XMLHttpRequest"},St=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},xt),{headers:Object.assign(Object.assign({},Tt),Ct)}),t)).then((e=>{if(e.ok)return e.json();throw e.statusText})),Pt=(e,t={})=>_t(e,t).then((e=>{if(e.ok)return e.text();throw e.statusText})),_t=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},xt),{headers:Object.assign({},Ct)}),t)),Mt=e=>{const t=new FormData;for(const n of Object.keys(e))t.append(n,e[n]);return t},It=e=>Pt(Ot(e)),Ot=e=>`/${e}/note`;function jt(e){let t=e.text;const n=function(e,t,n=!1){let o,r=0;return function(...a){const s=this;o&&clearTimeout(o),o=void 0;const i=performance.now()-r;r=performance.now(),n&&i>t?e.apply(s,a):o=setTimeout((()=>{o=void 0,e.apply(s,a)}),t)}}((()=>{((e,t)=>{St(Ot(e),{method:"post",body:Mt({text:t})})})(e.id,t||"")}),1e3);return{id:e.id,trans:e.trans,text:()=>t,fetch(){It(e.id).then((n=>{t=n||"",e.redraw()}))},post(e){t=e,n()}}}function $t(e){const t=e.text();return null==t?h("div.loading",{hook:{insert:e.fetch}}):h("textarea",{attrs:{placeholder:e.trans("typePrivateNotesHere")},hook:{insert(n){const o=$(n.elm);o.val(t).on("change keyup paste",(()=>e.post(o.val())))}}})}let Lt=!1;const Nt=e=>(!1===Lt&&(Lt=window.Intl&&Intl.NumberFormat?new Intl.NumberFormat:null),null===Lt?""+e:Lt.format(e));function At(e){let t,n=!1;const o=()=>{t=void 0,n=!1,e.redraw()};return{loading:()=>n,data:()=>t,reasons:e.reasons,permissions:()=>e.permissions,open:o=>{const r=o.querySelector("a.user-link"),a=o.querySelector("t").innerText,s=r.href.split("/")[4];e.permissions.timeout?(n=!0,(e=>St("/mod/chat-user/"+e))(s).then((o=>{t=Object.assign(Object.assign({},o),{text:a}),n=!1,e.redraw()}))):t={id:s.toLowerCase(),username:s,text:a},e.redraw()},close:o,timeout(n,r){t&&lichess.pubsub.emit("socket.send","timeout",{userId:t.id,reason:n.key,text:r}),o(),e.redraw()}}}const qt=()=>h("i.mod",{attrs:{"data-icon":""}});function Et(e,t){const n=e.data;n.domVersion=1;const o={instance:void 0,loaded:!1,enabled:kt(!!n.palantir)},r=["discussion"];e.noteId&&r.push("note"),e.plugin&&r.push(e.plugin.tab.key);const a=lichess.storage.make("chat.tab"),s=a.get();let i;const c={tab:r.find((e=>e===s))||r[0],enabled:e.alwaysEnabled||!lichess.storage.get("nochat"),placeholderKey:"talkInChat",loading:!1,timeout:e.timeout,writeable:e.writeable};r.length>1&&"discussion"===c.tab&&lichess.storage.get("nochat")&&(c.tab=r[1]);const l=e=>!!(e=e.trim())&&(!("You too!"==e&&!n.lines.some((e=>e.u!=n.userId)))&&(e.length>140?(alert("Max length: 140 chars. "+e.length+" chars used."),!1):(lichess.pubsub.emit("socket.send","talk",e),!0))),d=lichess.trans(e.i18n);function u(){(e.permissions.timeout||e.permissions.local)&&(i=At({reasons:e.timeoutReasons||[{key:"other",name:"Inappropriate behavior"}],permissions:e.permissions,redraw:t}),e.loadCss("chat.mod"))}u();const h=e.noteId?jt({id:e.noteId,text:e.noteText,trans:d,redraw:t}):void 0,p=function(e){let t=e.initialGroup,n=[];return{group:()=>t,said:()=>n,setGroup(o){o!==t&&(t=o,o||(n=[]),e.redraw())},post(o){t&&bt[t]&&(n.includes(o.key)||e.post(o.text)&&n.push(o.key))}}}({initialGroup:e.preset,post:l,redraw:t}),m=[["socket.in.message",e=>{n.lines.push(e);const o=n.lines.length;o>200&&(n.lines.splice(0,o-200+50),n.domVersion++),t()}],["socket.in.chat_timeout",e=>{let o=!1;n.lines.forEach((t=>{t.u&&t.u.toLowerCase()==e&&(t.d=!0,o=!0)})),e==n.userId&&(c.timeout=o=!0),o&&(n.domVersion++,t())}],["socket.in.chat_reinstate",e=>{e==n.userId&&(c.timeout=!1,t())}],["chat.writeable",e=>{c.writeable=e,t()}],["chat.permissions",n=>{let o;for(o in n)e.permissions[o]=n[o];u(),t()}],["palantir.toggle",o.enabled]];m.forEach((([e,t])=>lichess.pubsub.on(e,t)));const f=()=>lichess.pubsub.emit("chat.enabled",c.enabled);return f(),{data:n,opts:e,vm:c,allTabs:r,setTab(e){c.tab=e,a.set(e),"discussion"===e&&lichess.requestIdleCallback((()=>$(".mchat__say").each((function(){this.focus()}))),500),t()},moderation:()=>i,note:h,preset:p,post:l,trans:d,plugin:e.plugin,setEnabled(e){c.enabled=e,f(),e?lichess.storage.remove("nochat"):lichess.storage.set("nochat","1"),t()},redraw:t,palantir:o,destroy:()=>{m.forEach((([e,t])=>lichess.pubsub.off(e,t)))}}}const Bt=/(^|[^\w@#/])@([a-z0-9][a-z0-9_-]{0,28}[a-z0-9])/gi;function Rt(e,t,n){return e.includes("&quot;")?e:`<a target="_blank" rel="noopener nofollow noreferrer" href="${e.startsWith("/")||e.includes("://")?e:"//"+e}"${n?` class="${n}"`:""}>${t||e}</a>`}const Wt=/\b\b(?:https?:\/\/)?(lichess\.org\/[-–—\w+&'@#\/%?=()~|!:,.;]+[\w+&@#\/%=~|])/gi,Ft=/^[a-h][2-7]$/,Dt=/\b(\d+)\s*(\.+)\s*(?:[o0-]+[o0]|[NBRQKP\u2654\u2655\u2656\u2657\u2658\u2659]?[a-h]?[1-8]?[x@]?[a-z][1-8](?:=[NBRQK\u2654\u2655\u2656\u2657\u2658\u2659])?)\+?#?[!\?=]{0,5}/gi;function Kt(e,t,n){if(t<1||t>200)return e;return'<a class="jump" data-ply="'+(2*t-(n.length>1?0:1))+'">'+e+"</a>"}function Gt(e,t,n){return n.match(Ft)?e:function(e,t,n){return t+Rt("/@/"+n,"@"+n)}(0,t,n)}function zt(e,t){const n=lichess.escapeHtml(e),o=n.replace(Bt,Gt).replace(Wt,Rt);return t&&o===n?o.replace(Dt,Kt):o}const Ht=()=>"1"==lichess.storage.get("chat-spam"),Vt=new RegExp(["xcamweb.com","(^|[^i])chess-bot","chess-cheat","coolteenbitch","letcafa.webcam","tinyurl.com/","wooga.info/","bit.ly/","wbt.link/","eb.by/","001.rs/","shr.name/","u.to/",".3-a.net",".ssl443.org",".ns02.us",".myftp.info",".flinkup.com",".serveusers.com","badoogirls.com","hide.su","wyon.de","sexdatingcz.club","qps.ru","tiny.cc/"].map((e=>e.replace(/\./g,"\\.").replace(/\//g,"\\/"))).join("|")),Ut=e=>!!e.match(Vt),Xt=/follow me|join my team/i,Yt=e=>!!e.match(Xt),Zt=/lichess\.org\/team\//i,Qt=/^\/[wW](?:hisper)?\s/;function Jt(e){if(!e.vm.enabled)return[];const t=t=>{const n=t.elm;if(e.data.lines.length>5){(0===n.scrollTop||n.scrollTop>n.scrollHeight-n.clientHeight-100)&&(n.scrollTop=999999,setTimeout((e=>n.scrollTop=999999),300))}},n=!!e.moderation(),o=[h("ol.mchat__messages.chat-v-"+e.data.domVersion,{attrs:{role:"log","aria-live":"polite","aria-atomic":"false"},hook:{insert(o){const r=$(o.elm).on("click","a.jump",(e=>{lichess.pubsub.emit("jump",e.target.getAttribute("data-ply"))}));n?r.on("click",".mod",(t=>{var n;return null===(n=e.moderation())||void 0===n?void 0:n.open(t.target.parentNode)})):r.on("click",".flag",(t=>function(e,t){const n=t.querySelector("a.user-link"),o=t.querySelector("t").innerText;n&&confirm(`Report "${o}" to moderators?`)&&((e,t,n)=>{St("/report/flag",{method:"post",body:Mt({username:t,resource:e,text:n})})})(e.data.resourceId,n.href.split("/")[4],o)}(e,t.target.parentNode))),t(o)},postpatch:(e,n)=>t(n)}},on(e).map((t=>function(e,t){const n=function(e,t){if(n=e,/(\n|(@|#|\.)\w{2,})/.test(n)){const n=function(e){return(t,n)=>{n.data.lichessChat!==t.data.lichessChat&&(n.elm.innerHTML=zt(n.data.lichessChat,e))}}(t);return h("t",{lichessChat:e,hook:{create:n,update:n}})}var n;return h("t",e)}(t.t,e.opts.parseMoves);if("lichess"===t.u)return h("li.system",n);if(t.c)return h("li",[h("span.color","["+t.c+"]"),n]);const o=(r="a",a=t.u,s=gt,i=[t.u,t.title],void 0===i&&(i=s,s=a,a=void 0),h(r,{key:a,hook:{init:m,prepatch:f},fn:s,args:i}));var r,a,s,i;return h("li",e.moderation()?[t.u?qt():null,o," ",n]:[e.data.userId&&t.u&&e.data.userId!=t.u?h("i.flag",{attrs:{"data-icon":"!",title:"Report"}}):null,o," ",n])}(e,t)))),en(e)],r=function(e){const t=e.group();if(!t)return;const n=bt[t],o=e.said();return n&&o.length<2?h("div.mchat__presets",n.map((t=>{const n=o.includes(t.key);return h("span",{class:{disabled:n},attrs:{title:t.text,disabled:n},hook:vt("click",(()=>{!n&&e.post(t)}))},t.key)}))):void 0}(e.preset);return r&&o.push(r),o}function en(e){if(!e.vm.writeable)return;if(e.data.loginRequired&&!e.data.userId||e.data.restricted)return h("input.mchat__say",{attrs:{placeholder:e.trans("loginToChat"),disabled:!0}});let t;return t=e.vm.timeout?e.trans("youHaveBeenTimedOut"):e.opts.blind?"Chat":e.trans.noarg(e.vm.placeholderKey),h("input.mchat__say",{attrs:{placeholder:t,autocomplete:"off",maxlength:140,disabled:e.vm.timeout||!e.vm.writeable,"aria-label":"Chat input"},hook:{insert(t){nn(e,t.elm)}}})}let tn;const nn=(e,t)=>{const n=lichess.tempStorage.make("chat.input"),o=n.get();o&&(t.value=o,t.focus(),!e.opts.public&&o.match(Qt)&&t.classList.add("whisper")),t.addEventListener("keydown",(t=>{"Enter"===t.key&&setTimeout((()=>{const o=t.target,r=o.value,a=e.opts.public;""===r?$(".keyboard-move input").each((function(){this.focus()})):(e.opts.kobold||(e=>{if(Ht())return;const t=Ut(e);t&&Pt(`/jslog/${window.location.href.substr(-12)}?n=spam`,{method:"post"}),(t||Yt(e))&&lichess.storage.set("chat-spam","1")})(r),a&&(e=>!!e.match(Zt))(r)?alert("Please don't advertise teams in the chat."):e.post(r),o.value="",n.remove(),a||o.classList.remove("whisper"))}))})),t.addEventListener("input",(t=>setTimeout((()=>{const o=t.target,r=o.value;o.removeAttribute("placeholder"),e.opts.public||o.classList.toggle("whisper",!!r.match(Qt)),n.set(r)})))),window.Mousetrap.bind("c",(()=>t.focus()));const r=["touchstart","mousedown"];tn&&r.forEach((e=>document.body.removeEventListener(e,tn,{capture:!0}))),tn=e=>{e.shiftKey||2===e.buttons||2===e.button||t.blur()},t.onfocus=()=>r.forEach((e=>document.body.addEventListener(e,tn,{passive:!0,capture:!0}))),t.onblur=()=>r.forEach((e=>document.body.removeEventListener(e,tn,{capture:!0})))};function on(e){const t=[];let n;return e.data.lines.forEach((o=>{var r,a,s;o.d||n&&(s=o,(a=n).d&&s.d&&a.u===s.u)||o.r&&(o.u||"").toLowerCase()!=e.data.userId||(r=o.t,(Ut(r)||Yt(r))&&!Ht())||t.push(o),n=o})),t}function rn(e){const t=e.moderation();return h("section.mchat"+(e.opts.alwaysEnabled?"":".mchat-optional"),{class:{"mchat-mod":!!t},hook:{destroy:e.destroy}},function(e){if(!e)return;if(e.loading())return[h("div.loading")];const t=e.data();if(!t)return;const n=e.permissions(),o=t.history?h("div.infos.block",[Nt(t.games||0)+" games",t.troll?"TROLL":void 0,t.engine?"ENGINE":void 0,t.booster?"BOOSTER":void 0].map((e=>e&&h("span",e))).concat([h("a",{attrs:{href:"/@/"+t.username+"?mod"}},"profile")]).concat(n.shadowban?[h("a",{attrs:{href:"/mod/"+t.username+"/communication"}},"coms")]:[])):void 0,r=n.timeout?h("div.timeout.block",[h("strong","Timeout 15 minutes for"),...e.reasons.map((n=>h("a.text",{attrs:{"data-icon":"p"},hook:vt("click",(()=>e.timeout(n,t.text)))},n.name)))]):h("div.timeout.block",[h("strong","Moderation"),h("a.text",{attrs:{"data-icon":"p"},hook:vt("click",(()=>e.timeout(e.reasons[0],t.text)))},"Timeout 15 minutes")]),a=t.history?h("div.history.block",[h("strong","Timeout history"),h("table",h("tbody.slist",{hook:{insert(){lichess.contentLoaded()}}},t.history.map((function(e){return h("tr",[h("td.reason",e.reason),h("td.mod",e.mod),h("td",h("time.timeago",{attrs:{datetime:e.date}}))])}))))]):void 0;return[h("div.top",{key:"mod-"+t.id},[h("span.text",{attrs:{"data-icon":""}},[gt(t.username)]),h("a",{attrs:{"data-icon":"L"},hook:vt("click",e.close)})]),h("div.mchat__content.moderation",[h("i.line-text.block",['"',t.text,'"']),o,r,a])]}(t)||function(e){const t=e.vm.tab;return[h("div.mchat__tabs.nb_"+e.allTabs.length,[...e.allTabs.map((n=>function(e,t,n){return h("div.mchat__tab."+t,{class:{"mchat__tab-active":t===n},hook:vt("click",(()=>e.setTab(t)))},function(e,t){return"discussion"===t?[h("span",e.data.name),e.opts.alwaysEnabled?void 0:h("input",{attrs:{type:"checkbox",title:e.trans.noarg("toggleTheChat"),checked:e.vm.enabled},hook:vt("change",(t=>{e.setEnabled(t.target.checked)}))})]:"note"===t?[h("span",e.trans.noarg("notes"))]:e.plugin&&t===e.plugin.tab.key?[h("span",e.plugin.tab.name)]:[]}(e,t))}(e,n,t))),an(e)]),h("div.mchat__content."+t,"note"===t&&e.note?[$t(e.note)]:e.plugin&&t===e.plugin.tab.key?[e.plugin.view()]:Jt(e))]}(e))}function an(e){const t=e.palantir;if(t.enabled())return t.instance?t.instance.render(h):h("div.mchat__tab.palantir.palantir-slot",{attrs:{"data-icon":"",title:"Voice chat"},hook:vt("click",(()=>{t.loaded||(t.loaded=!0,lichess.loadScript("javascripts/vendor/peerjs.min.js").then((()=>{lichess.loadModule("palantir").then((()=>{t.instance=window.Palantir.palantir({uid:e.data.userId,redraw:e.redraw}),e.redraw()}))})))}))})}function sn(e,t){let n,o=0;return function(...r){const a=this,s=performance.now()-o;function i(){n=void 0,o=performance.now(),t.apply(a,r)}n&&clearTimeout(n),s>e?i():n=setTimeout(i,e-s)}}const cn=()=>lichess.reload(),ln=sn(1e3,((e,t,n)=>_t("/tournament/"+e.data.id+"/join",{method:"POST",body:JSON.stringify({p:t||null,team:n||null}),headers:{"Content-Type":"application/json"}}).then((e=>{e.ok||e.text().then((e=>{e.startsWith("<!DOCTYPE html>")?lichess.reload():alert(e)}))})))),dn=sn(1e3,(e=>Pt("/tournament/"+e.data.id+"/withdraw",{method:"POST"}).catch(cn))),un=sn(1e3,((e,t)=>St(`/tournament/${e.data.id}/standing/${t}`).then((t=>{e.loadPage(t),e.redraw()}),cn))),hn=e=>St(((e,t)=>{const n=new URLSearchParams;for(const e of Object.keys(t))yt(t[e])&&n.append(e,t[e]);const o=n.toString();return o?`${e}?${o}`:e})("/tournament/"+e.data.id,{page:e.focusOnMe?void 0:e.page,playerInfo:e.playerInfo.id,partial:!0})).then((t=>{e.reload(t),e.redraw()}),cn),pn=sn(4e3,hn);function mn(e,t,n){return fn((o=>o.addEventListener(e,(e=>{const o=t(e);return n&&n(),o}))))}function fn(e){return{insert(t){e(t.elm)}}}function gn(e){return{"data-icon":e}}function vn(e){return Math.round(100*e)+"%"}function bn(e){return e.title?[h("span.utitle",e.title)," "+e.name]:e.name}function wn(e,t,n,o=!1,r=!1){return h("a.ulpt.user-link"+(((e.title||"")+e.name).length>15?".long":""),{attrs:t||"ontouchstart"in window?{href:"/@/"+e.name}:{"data-href":"/@/"+e.name},hook:{destroy:e=>$.powerTip.destroy(e.elm)}},[h("span.name"+(o?".defender":r?".leader":""),o?{attrs:gn("5")}:r?{attrs:gn("8")}:{},bn(e)),n?h("span.rating"," "+e.rating+(e.provisional?"?":"")):null])}function yn(e,t,n){return h("tr",[h("th",e),h("td","raw"===n?t:"percent"===n?t[1]>0?vn(t[0]/t[1]):0:Nt(t))])}function kn(){return h("div.spinner",[h("svg",{attrs:{viewBox:"0 0 40 40"}},[h("circle",{attrs:{cx:20,cy:20,r:18,fill:"none"}})])])}function Tn(e){return h("button.fbt",{class:{active:e.searching},attrs:{"data-icon":e.searching?"L":"y",title:"Search tournament players"},hook:mn("click",e.toggleSearch,e.redraw)})}function xn(e){return h("div.search",h("input",{hook:fn((t=>lichess.userComplete().then((n=>{n({input:t,tour:e.data.id,tag:"span",focus:!0,onSelect(t){e.jumpToPageOf(t.id),e.redraw()}}),t.focus()}))))}))}function Cn(e,t,n,o,r){return h("button.fbt.is",{attrs:{"data-icon":t,disabled:!o,title:e},hook:mn("mousedown",n,r.redraw)})}function Sn(e){if(e.data.me)return h("button.fbt"+(e.focusOnMe?".active":""),{attrs:{"data-icon":"7",title:"Scroll to your player"},hook:mn("mousedown",e.toggleFocusOnMe,e.redraw)})}function Pn(e,t){const n=!!t.currentPageResults,o=e.page;return t.nbPages>-1?[Tn(e),...e.searching?[xn(e)]:[Cn("First","W",(()=>e.userSetPage(1)),n&&o>1,e),Cn("Prev","Y",e.userPrevPage,n&&o>1,e),h("span.page",(t.nbResults?t.from+1:0)+"-"+t.to+" / "+t.nbResults),Cn("Next","X",e.userNextPage,n&&o<t.nbPages,e),Cn("Last","V",e.userLastPage,n&&o<t.nbPages,e),Sn(e)]]:[]}function _n(e){const t=e.page,n=e.data.nbPlayers;return{currentPage:t,maxPerPage:10,from:10*(t-1),to:Math.min(n,10*t),currentPageResults:e.pages[t],nbResults:n,nbPages:Math.ceil(n/10)}}let Mn,In=[],On=!1;function jn(e){const t=lichess.storage.make("just-notified");if(document.hasFocus()||Date.now()-parseInt(t.get(),10)<1e3)return;t.set(""+Date.now()),$.isFunction(e)&&(e=e());const n=new Notification("lichess.org",{icon:lichess.assetUrl("logo/lichess-favicon-256.png",{noVersion:!0}),body:e});n.onclick=()=>window.focus(),In.push(n),On||(On=!0,window.addEventListener("focus",(()=>{In.forEach((e=>e.close())),In=[]})))}function $n(e){let t=!1;return function n(){const o=(e-performance.now())/1e3,r=Math.max(0,Math.round(o));if(r<=10&&lichess.sound.play("countDown"+r),r>0){const e=Math.min(10,r-1);Mn=setTimeout(n,1e3*Math.min(1.1,Math.max(.8,o-e)))}var a;!t&&r<=10&&(t=!0,a="The tournament is starting!",!document.hasFocus()&&"Notification"in window&&"granted"===Notification.permission&&setTimeout(jn,10+500*Math.random(),a))}}function Ln(e){if(e.me&&e.isRecentlyFinished&&lichess.once("tournament.end.sound."+e.id)){let t="Other";e.me.rank<4?t="1st":e.me.rank<11?t="2nd":e.me.rank<21&&(t="3rd"),lichess.sound.play("tournament"+t)}}function Nn(e){if(!e.me||!e.secondsToStart)return Mn&&clearTimeout(Mn),void(Mn=void 0);if(!(Mn||e.secondsToStart>86400)){Mn=setTimeout($n(performance.now()+1e3*e.secondsToStart-100),900);for(let e=10;e>=0;e--){const t="countDown"+e;lichess.sound.loadStandard(t)}}}function An(e){return e.data.me&&!e.data.me.withdraw}class qn{constructor(e,t){this.pages={},this.joinSpinner=!1,this.playerInfo={},this.teamInfo={},this.disableClicks=!0,this.searching=!1,this.joinWithTeamSelector=!1,this.lastStorage=lichess.storage.make("last-redirect"),this.askReload=()=>{this.joinSpinner?hn(this):pn(this)},this.reload=e=>{!this.data.me&&e.me&&this.data.private&&lichess.reload(),this.data=Object.assign(Object.assign({},this.data),e),this.data.me=e.me,e.playerInfo&&e.playerInfo.player.id===this.playerInfo.id&&(this.playerInfo.data=e.playerInfo),this.loadPage(e.standing),this.focusOnMe&&this.scrollToMe(),Ln(e),Nn(e),this.joinSpinner=!1,this.recountTeams(),this.redirectToMyGame()},this.myGameId=()=>{var e;return null===(e=this.data.me)||void 0===e?void 0:e.gameId},this.redirectFirst=(e,t)=>{const n=t||document.hasFocus()?10:1e3+500*Math.random();setTimeout((()=>{this.lastStorage.get()!==e&&(this.lastStorage.set(e),lichess.redirect("/"+e))}),n)},this.loadPage=e=>{e.failed&&this.pages[e.page]||(this.pages[e.page]=e.players)},this.setPage=e=>{this.page=e,un(this,e)},this.jumpToPageOf=e=>{const t=e.toLowerCase();((e,t)=>St(`/tournament/${e.data.id}/page-of/${t}`))(this,t).then((e=>{this.loadPage(e),this.page=e.page,this.searching=!1,this.focusOnMe=!1,this.pages[this.page].filter((e=>e.name.toLowerCase()==t)).forEach(this.showPlayerInfo),this.redraw()}))},this.userSetPage=e=>{this.focusOnMe=!1,this.setPage(e)},this.userNextPage=()=>this.userSetPage(this.page+1),this.userPrevPage=()=>this.userSetPage(this.page-1),this.userLastPage=()=>this.userSetPage(_n(this).nbPages),this.withdraw=()=>{dn(this),this.joinSpinner=!0,this.focusOnMe=!1},this.join=e=>{if(this.joinWithTeamSelector=!1,!this.data.verdicts.accepted)return this.data.verdicts.list.forEach((e=>{"ok"!==e.verdict&&alert(e.verdict)}));if(!this.data.teamBattle||e||this.data.me){let t;if(this.data.private&&!this.data.me&&(t=prompt(this.trans.noarg("password")),null===t))return;ln(this,t,e),this.joinSpinner=!0,this.focusOnMe=!0}else this.joinWithTeamSelector=!0},this.scrollToMe=()=>{const e=function(e){if(e.data.me)return Math.floor((e.data.me.rank-1)/10)+1}(this);e&&e!==this.page&&this.setPage(e)},this.toggleFocusOnMe=()=>{this.data.me&&(this.focusOnMe=!this.focusOnMe,this.focusOnMe&&this.scrollToMe())},this.showPlayerInfo=e=>{if(this.data.secondsToStart)return;const t=e.name.toLowerCase();this.teamInfo.requested=void 0,this.playerInfo={id:this.playerInfo.id===t?null:t,player:e,data:null},this.playerInfo.id&&((e,t)=>{St(`/tournament/${e.data.id}/player/${t}`).then((t=>{e.setPlayerInfoData(t),e.redraw()}),cn)})(this,this.playerInfo.id)},this.setPlayerInfoData=e=>{e.player.id===this.playerInfo.id&&(this.playerInfo.data=e)},this.showTeamInfo=e=>{this.playerInfo.id=void 0,this.teamInfo={requested:this.teamInfo.requested===e?void 0:e,loaded:void 0},this.teamInfo.requested&&((e,t)=>{St(`/tournament/${e.data.id}/team/${t}`).then((t=>{e.setTeamInfo(t),e.redraw()}),cn)})(this,this.teamInfo.requested)},this.setTeamInfo=e=>{e.id===this.teamInfo.requested&&(this.teamInfo.loaded=e)},this.toggleSearch=()=>this.searching=!this.searching,this.opts=e,this.data=e.data,this.redraw=t,this.trans=lichess.trans(e.i18n),this.socket=function(e,t){const n={reload(){setTimeout(t.askReload,Math.floor(4e3*Math.random()))},redirect:e=>(t.redirectFirst(e.slice(0,8),!0),!0)};return{send:e,receive:(e,t)=>!!n[e]&&n[e](t)}}(e.socketSend,this),this.page=this.data.standing.page,this.focusOnMe=An(this),setTimeout((()=>this.disableClicks=!1),1500),this.loadPage(this.data.standing),this.scrollToMe(),Ln(this.data),Nn(this.data),this.recountTeams(),this.redirectToMyGame()}recountTeams(){this.data.teamBattle&&(this.data.teamBattle.hasMoreThanTenTeams=Object.keys(this.data.teamBattle.teams).length>10)}redirectToMyGame(){const e=this.myGameId();e&&this.redirectFirst(e)}}function En(e){const t=()=>{e.joinWithTeamSelector=!1,e.redraw()},n=e.data.teamBattle;return h("div#modal-overlay",{hook:mn("click",t)},[h("div#modal-wrap.team-battle__choice",{hook:fn((e=>{e.addEventListener("click",(e=>e.stopPropagation()))}))},[h("span.close",{attrs:{"data-icon":"L"},hook:mn("click",t)}),h("div.team-picker",[h("h2","Pick your team"),h("br"),...n.joinWith.length?[h("p","Which team will you represent in this battle?"),...n.joinWith.map((t=>h("a.button",{hook:mn("click",(()=>e.join(t)),e.redraw)},n.teams[t])))]:[h("p","You must join one of these teams to participate!"),h("ul",Kn(Object.keys(n.teams)).map((e=>h("li",h("a",{attrs:{href:"/team/"+e}},n.teams[e])))))]])])])}function Bn(e,t){const n=e.data.teamBattle,o=e.data.teamStanding,r=n&&Object.keys(n.teams).length>10;return n&&o?h("table.slist.tour__team-standing"+(t?"."+t:""),[h("tbody",[...o.map((t=>Dn(e,n,t))),...r?[Rn(e),Wn(e,n)]:[]])]):null}function Rn(e){return h("tr",h("td.more-teams",{attrs:{colspan:4}},h("a",{attrs:{href:`/tournament/${e.data.id}/teams`}},e.trans("viewAllXTeams",Object.keys(e.data.teamBattle.teams).length))))}function Wn(e,t){const n=e.data.myTeam;return n&&n.rank>10?Dn(e,t,n):void 0}function Fn(e,t){return h(e.hasMoreThanTenTeams?"team":"team.ttc-"+Object.keys(e.teams).indexOf(t),e.teams[t])}function Dn(e,t,n){const o=[];return n.players.forEach(((t,n)=>{n>0&&o.push("+"),o.push(h("score.ulpt.user-link",{key:t.user.name,class:{top:0===n},attrs:{"data-href":"/@/"+t.user.name,"data-name":t.user.name},hook:Object.assign({destroy:e=>$.powerTip.destroy(e.elm)},mn("click",(n=>e.jumpToPageOf(t.user.name)),e.redraw))},[...0===n?[h("username",bn(t.user))," "]:[],""+t.score]))})),h("tr",{key:n.id,class:{active:e.teamInfo.requested==n.id},hook:mn("click",(t=>e.showTeamInfo(n.id)),e.redraw)},[h("td.rank",""+n.rank),h("td.team",[Fn(t,n.id)]),h("td.players",o),h("td.total",[h("strong",""+n.score)])])}function Kn(e){for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}function Gn(e,t){return e.joinSpinner?kn():t()}function zn(e){return e.opts.userId?e.data.isFinished?void 0:An(e)?function(e){return Gn(e,(()=>{const t=e.data.isStarted;return h("button.fbt.text",{attrs:gn(t?"Z":"b"),hook:mn("click",e.withdraw,e.redraw)},e.trans.noarg(t?"pause":"withdraw"))}))}(e):function(e){return Gn(e,(()=>{const t=e.data.me&&e.data.me.pauseDelay,n=e.data.verdicts.accepted&&!t,o=h("button.fbt.text"+(n?".highlight":""),{attrs:{disabled:!n,"data-icon":"G"},hook:mn("click",(t=>e.join()),e.redraw)},e.trans.noarg("join"));return t?h("div.delay-wrap",{attrs:{title:"Waiting to be able to re-join the tournament"}},[h("div.delay",{hook:{insert(n){n.elm.style.animation=`tour-delay ${t}s linear`,setTimeout((()=>{t===e.data.me.pauseDelay&&(e.data.me.pauseDelay=0,e.redraw())}),1e3*t)}}},[o])]):o}))}(e):h("a.fbt.text.highlight",{attrs:{href:"/login?referrer="+window.location.pathname,"data-icon":"G"}},e.trans("signIn"))}const Hn=["score","streak","double"];function Vn(e){return h(Hn[(e[1]||1)-1],[Array.isArray(e)?e[0]:e])}function Un(e){return h("a.text.ulpt.user-link",{attrs:{href:"/@/"+e.name}},bn(e))}function Xn(e,t,n){const o=n.noarg,r=e.nb;return h("table.stats",[e.performance?h("tr",[h("th",o("performance")),h("td",e.performance)]):null,h("tr",[h("th",o("gamesPlayed")),h("td",r.game)]),...r.game?[h("tr",[h("th",o("winRate")),h("td",vn(r.win/r.game))]),t?h("tr",[h("th",o("berserkRate")),h("td",vn(r.berserk/r.game))]):null]:[]])}function Yn(e,t,n,o){if(e)return h("div."+t,[h("div.trophy"),Un(e),Xn(e,n,o)])}let Zn;function Qn(e){const t=e.data.podium||[];return h("div.podium",[Yn(t[1],"second",e.data.berserkable,e.trans),Yn(t[0],"first",e.data.berserkable,e.trans),Yn(t[2],"third",e.data.berserkable,e.trans)])}function Jn(e){lichess.powertip.manualUserIn(e)}function eo(e,t){return h("div.tour__controls",[h("div.pager",Pn(e,t)),zn(e)])}function to(e,t,n){const o=t.currentPageResults?t.currentPageResults.map((t=>function(e,t){const n=t.name.toLowerCase(),o=t.sheet.scores.length,r=e.data.teamBattle;return h("tr",{key:n,class:{me:e.opts.userId===n,long:o>35,xlong:o>80,active:e.playerInfo.id===n},hook:mn("click",(n=>e.showPlayerInfo(t)),e.redraw)},[h("td.rank",t.withdraw?h("i",{attrs:{"data-icon":"Z",title:e.trans.noarg("pause")}}):t.rank),h("td.player",[wn(t,!1,!0,n===e.data.defender),...r&&t.team?[" ",Fn(r,t.team)]:[]]),h("td.sheet",t.sheet.scores.map(Vn)),h("td.total",[t.sheet.fire&&!e.data.isFinished?h("strong.is-gold",{attrs:gn("Q")},t.sheet.total):h("strong",t.sheet.total)])])}(e,t))):Zn;return t.currentPageResults&&(Zn=o),h("table.slist.tour__standing"+(n?"."+n:""),{class:{loading:!t.currentPageResults}},[h("tbody",{hook:{insert:e=>Jn(e.elm),update(e,t){Jn(t.elm)}}},o)])}function no(e){var t,n;const o=e.data.teamBattle,r=e.teamInfo.loaded,a=e.trans.noarg;if(!o)return;const s=e.teamInfo.requested?Fn(o,e.teamInfo.requested):null,i="div.tour__team-info.tour__actor-info";if(!r||r.id!==e.teamInfo.requested)return h(i,[h("div.stats",[h("h2",[s]),kn()])]);const c=(null===(n=null===(t=e.data.teamStanding)||void 0===t?void 0:t.find((e=>e.id==r.id)))||void 0===n?void 0:n.players.length)||0,l=e=>{lichess.powertip.manualUserIn(e.elm)};return h(i,{hook:{insert:l,postpatch(e,t){l(t)}}},[h("a.close",{attrs:gn("L"),hook:mn("click",(()=>e.showTeamInfo(r.id)),e.redraw)}),h("div.stats",[h("h2",[s]),h("table",[yn("Players",r.nbPlayers),...r.rating?[yn(a("averageElo"),r.rating,"raw"),...r.perf?[yn("Average performance",r.perf,"raw"),yn("Average score",r.score,"raw")]:[]]:[],h("tr",h("th",h("a",{attrs:{href:"/team/"+r.id}},"Team page")))])]),h("div",[h("table.players.sublist",r.topPlayers.map(((t,n)=>h("tr",{key:t.name,hook:mn("click",(()=>e.jumpToPageOf(t.name)))},[h("th",""+(n+1)),h("td",wn(t,!1,!0,!1,n<c)),h("td.total",[t.fire&&!e.data.isFinished?h("strong.is-gold",{attrs:gn("Q")},""+t.score):h("strong",""+t.score)])]))))])])}function oo(e){return{insert:t=>$(t.elm).clock({time:e})}}function ro(e,t){return t.schedule&&t.schedule.freq===e}function ao(e){if(!e.isFinished)return e.secondsToFinish?h("div.clock",[h("div.time",{hook:oo(e.secondsToFinish)})]):e.secondsToStart?e.secondsToStart>86400?h("div.clock",[h("time.timeago.shy",{attrs:{title:new Date(e.startsAt).toLocaleString(),datetime:Date.now()+1e3*e.secondsToStart},hook:{insert(t){t.elm.setAttribute("datetime",""+(Date.now()+1e3*e.secondsToStart))}}})]):h("div.clock.clock-created",[h("span.shy","Starting in"),h("span.time.text",{hook:oo(e.secondsToStart)})]):void 0}function so(e){if(e.isFinished)return;if(ro("shield",e)||ro("marathon",e))return;const t=e.spotlight;return t&&t.iconImg?h("img.img",{attrs:{src:lichess.assetUrl("images/"+t.iconImg)}}):h("i.img",{attrs:gn(t&&t.iconFont||"g")})}function io(e){const t=e.data;return ro("marathon",t)?h("h1",[h("i.fire-trophy","\\"),t.fullName]):ro("shield",t)?h("h1",[h("a.shield-trophy",{attrs:{href:"/tournament/shields"}},t.perf.icon),t.fullName]):h("h1",(t.greatPlayer?[h("a",{attrs:{href:t.greatPlayer.url,target:"_blank",rel:"noopener"}},t.greatPlayer.name)," Arena"]:[t.fullName]).concat(t.private?[" ",h("span",{attrs:gn("a")})]:[]))}function co(e){return h("div.tour__main__header",[so(e.data),io(e),ao(e.data)])}var lo=Object.freeze({__proto__:null,name:"created",main:function(e){const t=_n(e);return[co(e),Bn(e,"created"),eo(e,t),to(e,t,"created"),h("blockquote.pull-quote",[h("p",e.data.quote.text),h("footer",e.data.quote.author)]),e.opts.$faq?h("div",{hook:fn((t=>$(t).replaceWith(e.opts.$faq)))}):null]},table:function(e){return e.teamInfo.requested?no(e):void 0}});function uo(e,t){const n=e[t],o=e.c||e.clock;return h("span.mini-game__player",[h("span.mini-game__user",[h("strong","#"+n.rank),wn(n,!0,!0,!1),n.berserk?h("i",{attrs:{"data-icon":"`",title:"Berserk"}}):null]),o?h(`span.mini-game__clock.mini-game__clock--${t}`,{attrs:{"data-time":o[t],"data-managed":1}}):h("span.mini-game__result",e.winner?e.winner==t?1:0:"½")])}function ho(e){return[h("em.rank","#"+e.k),e.t?h("em.utitle",e.t):null,h("em.rating",""+e.r)]}const po=e=>lichess.miniGame.initAll(e.elm);const mo=30;function fo(e){return h("h2",[h("span.rank",e.rank+". "),wn(e,!0,!1,!1)])}function go(e){const t=e.elm,n=lichess.powertip;n.manualUserIn(t),n.manualGameIn(t)}function vo(e){const t=e.playerInfo.data,n=e.trans.noarg,o="div.tour__player-info.tour__actor-info";if(!t||t.player.id!==e.playerInfo.id)return h(o,[h("div.stats",[fo(e.playerInfo.player),kn()])]);const r=t.player.nb,a=t.pairings.length,s=a?Math.round(t.pairings.reduce((function(e,t){return e+t.op.rating}),0)/a):void 0;return h(o,{hook:{insert:go,postpatch(e,t){go(t)}}},[h("a.close",{attrs:gn("L"),hook:mn("click",(()=>e.showPlayerInfo(t.player)),e.redraw)}),h("div.stats",[fo(t.player),t.player.team?h("team",{hook:mn("click",(()=>e.showTeamInfo(t.player.team)),e.redraw)},[Fn(e.data.teamBattle,t.player.team)]):null,h("table",[t.player.performance?yn(n("performance"),t.player.performance+(r.game<3?"?":""),"raw"):null,yn(n("gamesPlayed"),r.game),...r.game?[yn(n("winRate"),[r.win,r.game],"percent"),yn(n("berserkRate"),[r.berserk,r.game],"percent"),yn(n("averageOpponent"),s,"raw")]:[]])]),h("div",[h("table.pairings.sublist",{hook:mn("click",(e=>{const t=e.target.parentNode.getAttribute("data-href");t&&window.open(t,"_blank","noopener")}))},t.pairings.map((function(e,t){const n=function(e,t){switch(e){case!0:return"1";case!1:return"0";default:return t>=mo?"½":"*"}}(e.win,e.status);return h("tr.glpt."+("1"===n?" win":"0"===n?" loss":""),{key:e.id,attrs:{"data-href":"/"+e.id+"/"+e.color},hook:{destroy:e=>$.powerTip.destroy(e.elm)}},[h("th",""+(Math.max(r.game,a)-t)),h("td",bn(e.op)),h("td",e.op.rating),h("td.is.color-icon."+e.color),h("td",n)])})))])])}function bo(e,t){return h("a.tour__ur-playing.button.is.is-after",{attrs:{href:"/"+t}},[e.trans("youArePlaying"),h("br"),e.trans("joinTheGame")])}function wo(e){return function(e){return An(e)&&!e.data.pairingsClosed}(e)?h("div.tour__notice.bar-glider",e.trans("standByX",e.data.me.username)):h("div.tour__notice.closed",e.trans("tournamentPairingsAreNowClosed"))}var yo=Object.freeze({__proto__:null,name:"started",main:function(e){const t=e.myGameId(),n=_n(e);return[co(e),t?bo(e,t):An(e)?wo(e):null,Bn(e,"started"),eo(e,n),to(e,n,"started")]},table:function(e){return e.playerInfo.id?vo(e):e.teamInfo.requested?no(e):function(e){return h("div.tour__table",{hook:{insert:po,postpatch:po}},[e.data.featured?(o=e.data.featured,h(`div.tour__featured.mini-game.mini-game-${o.id}.mini-game--init.is2d`,{attrs:{"data-state":`${o.fen},${o.orientation},${o.lastMove}`,"data-live":o.id},hook:fn(lichess.powertip.manualUserIn)},[uo(o,I(o.orientation)),h("a.cg-wrap",{attrs:{href:`/${o.id}/${o.orientation}`}}),uo(o,o.orientation)])):null,e.data.duels.length?h("section.tour__duels",{hook:mn("click",(t=>!e.disableClicks))},[h("h2","Top games")].concat(e.data.duels.map((t=e.data.teamBattle,n=e.data.duelTeams,e=>h("a.glpt",{key:e.id,attrs:{href:"/"+e.id}},[t&&n?h("line.t",[0,1].map((o=>Fn(t,n[e.p[o].n.toLowerCase()])))):void 0,h("line.a",[h("strong",e.p[0].n),h("span",ho(e.p[1]).reverse())]),h("line.b",[h("span",ho(e.p[0])),h("strong",e.p[1].n)])]))))):null]);var t,n,o}(e)}});function ko(e){if(e.me&&e.isRecentlyFinished&&lichess.once("tournament.end.canvas."+e.id))return h("canvas#confetti",{hook:{insert:e=>lichess.loadScript("javascripts/confetti.js")}})}function To(e,t){const n=t.noarg,o=[yn(n("averageElo"),e.stats.averageRating,"raw"),yn(n("gamesPlayed"),e.stats.games),yn(n("movesPlayed"),e.stats.moves),yn(n("whiteWins"),[e.stats.whiteWins,e.stats.games],"percent"),yn(n("blackWins"),[e.stats.blackWins,e.stats.games],"percent"),yn(n("draws"),[e.stats.draws,e.stats.games],"percent")];if(e.berserkable){const t=[e.stats.berserks/2,e.stats.games];o.push(yn(n("berserkRate"),t,"percent"))}return h("div.tour__stats",[h("h2",n("tournamentComplete")),h("table",o),h("div.tour__stats__links",[...e.teamBattle?[h("a",{attrs:{href:`/tournament/${e.id}/teams`}},t("viewAllXTeams",Object.keys(e.teamBattle.teams).length)),h("br")]:[],h("a.text",{attrs:{"data-icon":"x",href:`/api/tournament/${e.id}/games`,download:!0}},"Download all games"),h("a.text",{attrs:{"data-icon":"x",href:`/api/tournament/${e.id}/results`,download:!0}},"Download results as NDJSON"),h("a.text",{attrs:{"data-icon":"x",href:`/api/tournament/${e.id}/results?as=csv`,download:!0}},"Download results as CSV"),h("br"),h("a.text",{attrs:{"data-icon":"",href:"https://lichess.org/api#tag/Arena-tournaments"}},"Arena API documentation")])])}var xo=Object.freeze({__proto__:null,name:"finished",main:function(e){const t=_n(e),n=Bn(e,"finished");return[...n?[co(e),n]:[h("div.podium-wrap",[ko(e.data),co(e),Qn(e)])],eo(e,t),to(e,t)]},table:function(e){return e.playerInfo.id?vo(e):e.teamInfo.requested?no(e):To?To(e.data,e.trans):void 0}});function Co(e){let t;return t=e.data.isFinished?xo:e.data.isStarted?yo:lo,h("main."+e.opts.classes,[h("aside.tour__side",{hook:fn((t=>{$(t).replaceWith(e.opts.$side),e.opts.chat&&lichess.makeChat(e.opts.chat)}))}),h("div.tour__underchat",{hook:fn((e=>{$(e).replaceWith($(".tour__underchat.none").removeClass("none"))}))}),t.table(e),h("div.tour__main",h("div.box."+t.name,{class:{"tour__main-finished":e.data.isFinished}},t.main(e))),e.opts.chat?h("div.chat__members.none",{hook:fn(lichess.watchers)}):null,e.joinWithTeamSelector?En(e):null])}const So=d([w,v]);return window.Chessground=function(e,t){const n={pieces:ve(me),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:M()};function o(){const t="dom"in n?n.dom.unbind:void 0,o=n.viewOnly&&!n.drawable.visible,r=function(e,t,n){e.innerHTML="",e.classList.add("cg-wrap");for(const n of y)e.classList.toggle("orientation-"+n,t.orientation===n);e.classList.toggle("manipulable",!t.viewOnly);const o=F("cg-helper");e.appendChild(o);const r=F("cg-container");o.appendChild(r);const a=F("cg-board");let s,i,c;if(r.appendChild(a),t.drawable.visible&&!n&&(s=Ze(Ke("svg"),{class:"cg-shapes"}),s.appendChild(Ke("defs")),s.appendChild(Ke("g")),i=Ze(Ke("svg"),{class:"cg-custom-svgs"}),i.appendChild(Ke("g")),r.appendChild(s),r.appendChild(i)),t.coordinates){const e="black"===t.orientation?" black":"";r.appendChild(ot(T,"ranks"+e)),r.appendChild(ot(k,"files"+e))}return t.draggable.showGhost&&!n&&(c=F("piece","ghost"),B(c,!1),r.appendChild(c)),{board:a,container:r,ghost:c,svg:s,customSvg:i}}(e,n,o),a=function(e){let t;const n=()=>(void 0===t&&(t=e()),t);return n.clear=()=>{t=void 0},n}((()=>r.board.getBoundingClientRect())),s=e=>{it(c),!e&&r.svg&&Ge(c,r.svg,r.customSvg)},i=()=>{a.clear(),function(e){if(e.dom.relative)return;const t=pe(e),n=N(e.dom.bounds());let o=e.dom.elements.board.firstChild;for(;o;)(ct(o)&&!o.cgAnimating||lt(o))&&q(o,n(P(o.cgKey),t)),o=o.nextSibling}(c),r.svg&&Ge(c,r.svg,r.customSvg)},c=n;return c.dom={elements:r,bounds:a,redraw:ft(s),redrawNow:s,unbind:t,relative:o},c.drawable.prevSvgHash="",s(!1),rt(c,i),t||(c.dom.unbind=function(e,t){const n=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||n.push(at(document.body,"chessground.resize",t)),!e.viewOnly){const t=st(e,qe,Ie),o=st(e,Ee,Oe);for(const e of["touchmove","mousemove"])n.push(at(document,e,t));for(const e of["touchend","mouseup"])n.push(at(document,e,o));const r=()=>e.dom.bounds.clear();n.push(at(document,"scroll",r,{capture:!0,passive:!0})),n.push(at(window,"resize",r,{passive:!0}))}return()=>n.forEach((e=>e()))}(c,i)),c.events.insert&&c.events.insert(r),c}return be(n,t||{}),De(o(),o)},window.LichessChat=function(e,t){const n=d([w,v]),o=Et(t,(function(){a=n(a,rn(o))})),r=rn(o);e.innerHTML="";let a=n(e,r);return o},function(e){$("body").data("tournament-id",e.data.id),lichess.socket=new lichess.StrongSocket(`/tournament/${e.data.id}/socket/v5`,e.data.socketVersion,{receive:(e,n)=>t.socket.receive(e,n)}),e.socketSend=lichess.socket.send,e.element=document.querySelector("main.tour"),e.classes=e.element.getAttribute("class"),e.$side=$(".tour__side").clone(),e.$faq=$(".tour__faq").clone();const t=new qn(e,(function(){o=So(o,Co(t))})),n=Co(t);e.element.innerHTML="";let o=So(e.element,n)}}();
