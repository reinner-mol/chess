var LichessMsg=function(){"use strict";const t={createElement:function(t,e){return document.createElement(t,e)},createElementNS:function(t,e,n){return document.createElementNS(t,e,n)},createTextNode:function(t){return document.createTextNode(t)},createComment:function(t){return document.createComment(t)},insertBefore:function(t,e,n){t.insertBefore(e,n)},removeChild:function(t,e){t.removeChild(e)},appendChild:function(t,e){t.appendChild(e)},parentNode:function(t){return t.parentNode},nextSibling:function(t){return t.nextSibling},tagName:function(t){return t.tagName},setTextContent:function(t,e){t.textContent=e},getTextContent:function(t){return t.textContent},isElement:function(t){return 1===t.nodeType},isText:function(t){return 3===t.nodeType},isComment:function(t){return 8===t.nodeType}};function e(t,e,n,o,s){return{sel:t,data:e,children:n,text:o,elm:s,key:void 0===e?void 0:e.key}}const n=Array.isArray;function o(t){return"string"==typeof t||"number"==typeof t}function s(t){return void 0===t}function i(t){return void 0!==t}const a=e("",{},[],void 0,void 0);function r(t,e){var n,o;const s=t.key===e.key,i=(null===(n=t.data)||void 0===n?void 0:n.is)===(null===(o=e.data)||void 0===o?void 0:o.is);return t.sel===e.sel&&s&&i}function c(t,e,n){var o;const s={};for(let i=e;i<=n;++i){const e=null===(o=t[i])||void 0===o?void 0:o.key;void 0!==e&&(s[e]=i)}return s}const d=["create","update","remove","destroy","pre","post"];function l(l,u){let h,p;const m={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},v=void 0!==u?u:t;for(h=0;h<d.length;++h)for(m[d[h]]=[],p=0;p<l.length;++p){const t=l[p][d[h]];void 0!==t&&m[d[h]].push(t)}function g(t){const n=t.id?"#"+t.id:"",o=t.className?"."+t.className.split(" ").join("."):"";return e(v.tagName(t).toLowerCase()+n+o,{},[],void 0,t)}function f(t,e){return function(){if(0==--e){const e=v.parentNode(t);v.removeChild(e,t)}}}function _(t,e){var r,c;let d,l=t.data;if(void 0!==l){const e=null===(r=l.hook)||void 0===r?void 0:r.init;i(e)&&(e(t),l=t.data)}const u=t.children,h=t.sel;if("!"===h)s(t.text)&&(t.text=""),t.elm=v.createComment(t.text);else if(void 0!==h){const s=h.indexOf("#"),r=h.indexOf(".",s),p=s>0?s:h.length,g=r>0?r:h.length,f=-1!==s||-1!==r?h.slice(0,Math.min(p,g)):h,b=t.elm=i(l)&&i(d=l.ns)?v.createElementNS(d,f,l):v.createElement(f,l);for(p<g&&b.setAttribute("id",h.slice(p+1,g)),r>0&&b.setAttribute("class",h.slice(g+1).replace(/\./g," ")),d=0;d<m.create.length;++d)m.create[d](a,t);if(n(u))for(d=0;d<u.length;++d){const t=u[d];null!=t&&v.appendChild(b,_(t,e))}else o(t.text)&&v.appendChild(b,v.createTextNode(t.text));const w=t.data.hook;i(w)&&(null===(c=w.create)||void 0===c||c.call(w,a,t),w.insert&&e.push(t))}else t.elm=v.createTextNode(t.text);return t.elm}function b(t,e,n,o,s,i){for(;o<=s;++o){const s=n[o];null!=s&&v.insertBefore(t,_(s,i),e)}}function w(t){var e,n;const o=t.data;if(void 0!==o){null===(n=null===(e=null==o?void 0:o.hook)||void 0===e?void 0:e.destroy)||void 0===n||n.call(e,t);for(let e=0;e<m.destroy.length;++e)m.destroy[e](t);if(void 0!==t.children)for(let e=0;e<t.children.length;++e){const n=t.children[e];null!=n&&"string"!=typeof n&&w(n)}}}function y(t,e,n,o){for(var s,a;n<=o;++n){let o,r;const c=e[n];if(null!=c)if(i(c.sel)){w(c),o=m.remove.length+1,r=f(c.elm,o);for(let t=0;t<m.remove.length;++t)m.remove[t](c,r);const t=null===(a=null===(s=null==c?void 0:c.data)||void 0===s?void 0:s.hook)||void 0===a?void 0:a.remove;i(t)?t(c,r):r()}else v.removeChild(t,c.elm)}}function k(t,e,n){var o,a,d,l,u;const h=null===(o=e.data)||void 0===o?void 0:o.hook;null===(a=null==h?void 0:h.prepatch)||void 0===a||a.call(h,t,e);const p=e.elm=t.elm,g=t.children,f=e.children;if(t!==e){if(void 0!==e.data){for(let n=0;n<m.update.length;++n)m.update[n](t,e);null===(l=null===(d=e.data.hook)||void 0===d?void 0:d.update)||void 0===l||l.call(d,t,e)}s(e.text)?i(g)&&i(f)?g!==f&&function(t,e,n,o){let i,a,d,l,u=0,h=0,p=e.length-1,m=e[0],g=e[p],f=n.length-1,w=n[0],x=n[f];for(;u<=p&&h<=f;)null==m?m=e[++u]:null==g?g=e[--p]:null==w?w=n[++h]:null==x?x=n[--f]:r(m,w)?(k(m,w,o),m=e[++u],w=n[++h]):r(g,x)?(k(g,x,o),g=e[--p],x=n[--f]):r(m,x)?(k(m,x,o),v.insertBefore(t,m.elm,v.nextSibling(g.elm)),m=e[++u],x=n[--f]):r(g,w)?(k(g,w,o),v.insertBefore(t,g.elm,m.elm),g=e[--p],w=n[++h]):(void 0===i&&(i=c(e,u,p)),a=i[w.key],s(a)?v.insertBefore(t,_(w,o),m.elm):(d=e[a],d.sel!==w.sel?v.insertBefore(t,_(w,o),m.elm):(k(d,w,o),e[a]=void 0,v.insertBefore(t,d.elm,m.elm))),w=n[++h]);(u<=p||h<=f)&&(u>p?(l=null==n[f+1]?null:n[f+1].elm,b(t,l,n,h,f,o)):y(t,e,u,p))}(p,g,f,n):i(f)?(i(t.text)&&v.setTextContent(p,""),b(p,null,f,0,f.length-1,n)):i(g)?y(p,g,0,g.length-1):i(t.text)&&v.setTextContent(p,""):t.text!==e.text&&(i(g)&&y(p,g,0,g.length-1),v.setTextContent(p,e.text)),null===(u=null==h?void 0:h.postpatch)||void 0===u||u.call(h,t,e)}}return function(t,e){let n,o,s;const i=[];for(n=0;n<m.pre.length;++n)m.pre[n]();for(function(t){return void 0!==t.sel}(t)||(t=g(t)),r(t,e)?k(t,e,i):(o=t.elm,s=v.parentNode(o),_(e,i),null!==s&&(v.insertBefore(s,e.elm,v.nextSibling(o)),y(s,[t],0,0))),n=0;n<i.length;++n)i[n].data.hook.insert(i[n]);for(n=0;n<m.post.length;++n)m.post[n]();return e}}function u(t,e,n){if(t.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==e)for(let t=0;t<e.length;++t){const n=e[t].data;void 0!==n&&u(n,e[t].children,e[t].sel)}}function h(t,s,i){let a,r,c,d={};if(void 0!==i?(null!==s&&(d=s),n(i)?a=i:o(i)?r=i:i&&i.sel&&(a=[i])):null!=s&&(n(s)?a=s:o(s)?r=s:s&&s.sel?a=[s]:d=s),void 0!==a)for(c=0;c<a.length;++c)o(a[c])&&(a[c]=e(void 0,void 0,void 0,a[c],void 0));return"s"!==t[0]||"v"!==t[1]||"g"!==t[2]||3!==t.length&&"."!==t[3]&&"#"!==t[3]||u(d,a,t),e(t,d,a,r,void 0)}function p(t,e){let n;const o=e.elm;let s=t.data.attrs,i=e.data.attrs;if((s||i)&&s!==i){for(n in s=s||{},i=i||{},i){const t=i[n];s[n]!==t&&(!0===t?o.setAttribute(n,""):!1===t?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,t):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,t):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,t):o.setAttribute(n,t))}for(n in s)n in i||o.removeAttribute(n)}}const m={create:p,update:p};function v(t,e){let n,o;const s=e.elm;let i=t.data.class,a=e.data.class;if((i||a)&&i!==a){for(o in i=i||{},a=a||{},i)i[o]&&!Object.prototype.hasOwnProperty.call(a,o)&&s.classList.remove(o);for(o in a)n=a[o],n!==i[o]&&s.classList[n?"add":"remove"](o)}}const g={create:v,update:v};function f(t,e){return h("div.user-link."+e,{class:{online:t.online,offline:!t.online}},[h("i.line"+(t.patron?".patron":""))])}const _=t=>t.title?[h("span.utitle","BOT"==t.title?{attrs:{"data-bot":!0}}:{},t.title)," ",t.name]:[t.name];function b(t,e){return{insert(n){n.elm.addEventListener(t,(t=>(t.stopPropagation(),e(t),!1)))}}}function w(t){return b("ontouchstart"in window?"click":"mousedown",t)}function y(t,e){if("lichess"==e.user.id)return[];const n=[],o="msg-app__convo__action.button.button-empty";return n.push(h(`a.${o}.play`,{key:"play",attrs:{"data-icon":"U",href:`/?user=${e.user.name}#friend`,title:t.trans.noarg("challengeToPlay")}})),n.push(h("div.msg-app__convo__action__sep","|")),!1===e.relations.out?n.push(h(`button.${o}.text.hover-text`,{key:"unblock",attrs:{"data-icon":"k",title:t.trans.noarg("blocked"),"data-hover-text":t.trans.noarg("unblock")},hook:b("click",t.unblock)})):n.push(h(`button.${o}.bad`,{key:"block",attrs:{"data-icon":"k",title:t.trans.noarg("block")},hook:b("click",k(t.block))})),n.push(h(`button.${o}.bad`,{key:"delete",attrs:{"data-icon":"q",title:t.trans.noarg("delete")},hook:b("click",k(t.delete))})),e.msgs[0]&&n.push(h(`button.${o}.bad`,{key:"report",attrs:{"data-icon":"!",title:t.trans("reportXToModerators",e.user.name)},hook:b("click",k(t.report))})),n}const k=t=>e=>{confirm(`${e.target.getAttribute("title")||"Confirm"}?`)&&t()};function x(t,e){let n,o=0;return function(...s){const i=this,a=performance.now()-o;function r(){n=void 0,o=performance.now(),e.apply(i,s)}n&&clearTimeout(n),a>t?r():n=setTimeout(r,t-a)}}function C(t,e){const n=t.connected();return h("form.msg-app__convo__post",{hook:b("submit",(t=>{t.preventDefault();const e=t.target.querySelector("textarea");e&&(e.dispatchEvent(new Event("send")),e.focus())}))},[T(t,e),h("button.msg-app__convo__post__submit.button",{class:{connected:n},attrs:{type:"submit","data-icon":"G",disabled:!n}})])}function T(t,e){return h("textarea.msg-app__convo__post__text",{attrs:{rows:1},hook:{insert(n){!function(t,e,n){const o=n.textStore;let s=0;function i(){const e=Date.now();if(s>e-1e3||!n.connected())return;s=e;const i=t.value.trim();if(i.length>8e3)return alert("The message is too long.");i&&n.post(i),t.value="",t.dispatchEvent(new Event("input")),o.remove()}t.value="";const a=t.scrollHeight;t.addEventListener("input",x(500,(()=>{const s=t.value.trim();t.rows=1,s&&(t.rows=Math.min(10,1+Math.ceil((t.scrollHeight-a)/19))),o.set(s),n.sendTyping(e)}))),t.value=o.get()||"",t.value&&t.dispatchEvent(new Event("input"));t.addEventListener("keypress",(t=>{10!=t.which&&13!=t.which||t.shiftKey||(t.preventDefault(),setTimeout(i))})),t.addEventListener("send",i),"ontouchstart"in window||t.focus()}(n.elm,e.id,t)}}})}const M=new class{constructor(){this.enabled=!1,this.init=t=>{this.enabled=!0,this.element=t,this.element.addEventListener("scroll",x(500,(t=>{const e=this.element;this.enable(!!e&&e.offsetHeight+e.scrollTop>e.scrollHeight-20)})),{passive:!0}),window.el=this.element},this.auto=()=>{this.element&&this.enabled&&requestAnimationFrame((()=>this.element.scrollTop=9999999))},this.enable=t=>{this.enabled=t},this.setMarker=()=>{this.marker=this.element&&this.element.querySelector("mine,their")},this.toMarker=()=>!(!this.marker||!this.to(this.marker))&&(this.marker=void 0,!0),this.to=t=>{if(this.element){const e=t.offsetTop-this.element.offsetHeight/2+t.offsetHeight/2;return e>0&&(this.element.scrollTop=e),e>0}return!1}}},E=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:(?:https?|ftp):\/\/|lichess\.org)[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,L=/\n/g,j=/(^|[^\w@#/])@([a-z0-9][a-z0-9_-]{0,28}[a-z0-9])/gi;function S(t,e,n){return t.includes("&quot;")?t:`<a target="_blank" rel="noopener nofollow noreferrer" href="${t.startsWith("/")||t.includes("://")?t:"//"+t}"${n?` class="${n}"`:""}>${e||t}</a>`}function O(t,e,n){return e+S("/@/"+n,"@"+n)}const A=/https?:\/\/(?:i\.)?imgur\.com\/(\w+)(?:\.jpe?g|\.png|\.gif)?/,N=/https:\/\/(?:media\.giphy\.com\/media\/|giphy\.com\/gifs\/(?:\w+-)*)(\w+)(?:\/giphy\.gif)?/,B=t=>S(t,(t=>`<img src="${t}"/>`)(t)),D=t=>(t=>A.test(t)?t.replace(A,((t,e)=>B(`https://i.imgur.com/${e}.jpg`))):void 0)(t)||(t=>N.test(t)?t.replace(N,((t,e)=>B(`https://media.giphy.com/media/${e}/giphy.gif`))):void 0)(t)||(t=>/\.(jpg|jpeg|png|gif)$/.test(t)?B(t):void 0)(t)||(t=>S(t,t.replace(/^https?:\/\//,"")))(t),H=t=>{return(t=>t.replace(/\s#([\w]{8})($|[^\w-])/g,((t,e,n)=>" "+S("/"+e,"#"+e,"text")+n)))((t=>t.replace(j,O))((e=lichess.escapeHtml(t),e.replace(E,((t,e,n)=>`${e}${D(n)}`))))).replace(L,"<br>");var e},q=window.location.host,R=new RegExp(`(?:https?://)${q}/(?:embed/)?(\\w{8})(?:(?:/(white|black))|\\w{4}|)(#\\d+)?$`),P=["training","analysis","insights","practice","features","password","streamer","timeline"];function F(t){const e=[];var n;t.querySelectorAll("a:not(.text)").forEach((t=>{const n=function(t){const[e,n,o]=Array.from(t.href.match(R)||[]).slice(1);return e&&!P.includes(e)?{type:"game",src:I(`/embed/${e}${n?`/${n}`:""}${o||""}`)}:void 0}(t);n&&e.push({element:t,link:n})})),(n=e.filter((t=>"game"==t.link.type))).length<3?n.forEach(G):n.forEach((t=>{t.element.title="Click to expand",t.element.classList.add("text"),t.element.setAttribute("data-icon","="),t.element.addEventListener("click",(e=>{0===e.button&&(e.preventDefault(),G(t))}))}))}function G(t){const e=$("<iframe>").attr("src",t.link.src);return $(t.element).parent().parent().addClass("has-embed"),$(t.element).replaceWith($('<div class="embed">').prepend(e)),e.on("load",(function(){var t;(null===(t=this.contentDocument)||void 0===t?void 0:t.title.startsWith("404"))&&this.parentNode.classList.add("not-found"),M.auto()})).on("mouseenter",(function(){this.focus()}))}const z=["blue","blue2","blue3","blue-marble","canvas","wood","wood2","wood3","wood4","maple","maple2","brown","leather","green","marble","green-plastic","grey","metal","olive","newspaper","purple","purple-diag","pink","ic","horsey"];function I(t){if(t.includes("://"))return t;const e=new URL(t,window.location.href);return e.searchParams.append("theme",z.find((t=>document.body.classList.contains(t)))),e.searchParams.append("bg",document.body.getAttribute("data-theme")),e.href}function U(t,e){return h("div.msg-app__convo__msgs",{hook:{insert:tt(!0),postpatch:tt(!1)}},[h("div.msg-app__convo__msgs__init"),h("div.msg-app__convo__msgs__content",[t.canGetMoreSince?h("button.msg-app__convo__msgs__more.button.button-empty",{key:"more",hook:b("click",(e=>{M.setMarker(),t.getMore()}))},"Load more"):null,...W(t,e.msgs),t.typing?h("div.msg-app__convo__msgs__typing",`${e.user.name} is typing...`):null])])}function W(t,e){const n=function(t){let e=t[0];if(!e)return[{date:new Date,msgs:[]}];const n=[{date:e.date,msgs:[[e]]}];return t.slice(1).forEach((t=>{J(t.date,e.date)?t.user==e.user?n[0].msgs[0].unshift(t):n[0].msgs.unshift([t]):n.unshift({date:t.date,msgs:[[t]]}),e=t})),n}(e),o=[];return n.forEach((e=>o.push(...function(t,e){return[h("day",K(e.date,t.trans)),...e.msgs.map((e=>h("group",e.map((e=>function(t,e){return h(e.user==t.data.me.id?"mine":"their",[Q(e),h("em",`${X(e.date.getHours())}:${X(e.date.getMinutes())}`)])}(t,e))))))]}(t,e)))),o}const X=t=>(t<10?"0":"")+t;const Y=new Date,Z=new Date;function K(t,e){return J(t,Y)?e.noarg("today").toUpperCase():J(t,Z)?e.noarg("yesterday").toUpperCase():V(t)}Z.setDate(Z.getDate()-1);const V=t=>`${t.getDate()}/${t.getMonth()+1}/${t.getFullYear()}`,J=(t,e)=>t.getDate()==e.getDate()&&t.getMonth()==e.getMonth()&&t.getFullYear()==e.getFullYear(),Q=t=>{return e=t.text,/(\n|(@|#|\.)\w{2,})/.test(e)?h("t",{hook:{create(e,n){const o=n.elm;o.innerHTML=H(t.text),o.querySelectorAll("img").forEach((t=>t.addEventListener("load",M.auto,{once:!0})))}}}):h("t",t.text);var e},tt=t=>e=>{const n=e.elm;t&&M.init(n),F(n),M.toMarker()||M.auto()};function et(t,e){const n=e.user;return h("div.msg-app__convo",{key:n.id},[h("div.msg-app__convo__head",[h("div.msg-app__convo__head__left",[h("span.msg-app__convo__head__back",{attrs:{"data-icon":"I"},hook:w(t.showSide)}),h("a.user-link.ulpt",{attrs:{href:`/@/${n.name}`},class:{online:n.online,offline:!n.online}},[h("i.line"+("lichess"==n.id?".moderator":n.patron?".patron":"")),..._(n)])]),h("div.msg-app__convo__head__actions",y(t,e))]),U(t,e),h("div.msg-app__convo__reply",[!1===e.relations.out||!1===e.relations.in?h("div.msg-app__convo__reply__block.text",{attrs:{"data-icon":"k"}},"This conversation is blocked."):e.postable?C(t,n):h("div.msg-app__convo__reply__block.text",{attrs:{"data-icon":"k"}},`${n.name} doesn't accept new messages.`)])])}function nt(t,e,n){const o=e.user,s=e.lastMsg,i=!s.read&&s.user!=t.data.me.id;return h("div.msg-app__side__contact",{key:o.id,class:{active:n==o.id},hook:w((e=>t.openConvo(o.id)))},[f(o,"msg-app__side__contact__icon"),h("div.msg-app__side__contact__user",[h("div.msg-app__side__contact__head",[h("div.msg-app__side__contact__name",_(o)),h("div.msg-app__side__contact__date",ot(s))]),h("div.msg-app__side__contact__body",[h("div.msg-app__side__contact__msg",{class:{"msg-app__side__contact__msg--new":i}},s.text),i?h("i.msg-app__side__contact__new",{attrs:{"data-icon":"î€"}}):null])])])}function ot(t){return h("time.timeago",{key:t.date.getTime(),attrs:{title:t.date.toLocaleString(),datetime:t.date.getTime()}},lichess.timeago(t.date))}function st(t){return h("div.msg-app__side__search",[h("input",{attrs:{value:"",placeholder:t.trans.noarg("searchOrStartNewDiscussion")},hook:{insert(e){const n=e.elm;n.addEventListener("input",x(500,(()=>t.searchInput(n.value.trim())))),n.addEventListener("blur",(()=>setTimeout((()=>{n.value="",t.searchInput("")}),500)))}}})])}function it(t,e){return h("div.msg-app__search.msg-app__side__content",[e.contacts[0]&&h("section",[h("h2",t.trans.noarg("discussions")),h("div.msg-app__search__contacts",e.contacts.map((e=>nt(t,e))))]),e.friends[0]&&h("section",[h("h2",t.trans.noarg("friends")),h("div.msg-app__search__users",e.friends.map((e=>at(t,e))))]),e.users[0]&&h("section",[h("h2",t.trans.noarg("players")),h("div.msg-app__search__users",e.users.map((e=>at(t,e))))])])}function at(t,e){return h("div.msg-app__side__contact",{key:e.id,hook:w((n=>t.openConvo(e.id)))},[f(e,"msg-app__side__contact__icon"),h("div.msg-app__side__contact__user",[h("div.msg-app__side__contact__head",[h("div.msg-app__side__contact__name",_(e))])])])}function rt(t){var e;const n=null===(e=t.data.convo)||void 0===e?void 0:e.user.id;return h("main.box.msg-app",{class:{[`pane-${t.pane}`]:!0}},[h("div.msg-app__side",[st(t),t.search.result?it(t,t.search.result):h("div.msg-app__contacts.msg-app__side__content",t.data.contacts.map((e=>nt(t,e,n))))]),t.data.convo?et(t,t.data.convo):t.loading?h("div.msg-app__convo",{key:":"},[h("div.msg-app__convo__head"),h("div.spinner",[h("svg",{attrs:{viewBox:"0 0 40 40"}},[h("circle",{attrs:{cx:20,cy:20,r:18,fill:"none"}})])])]):""])}const ct={Accept:"application/vnd.lichess.v5+json"},dt={cache:"no-cache",credentials:"same-origin"},lt={"X-Requested-With":"XMLHttpRequest"},ut=(t,e={})=>fetch(t,Object.assign(Object.assign(Object.assign({},dt),{headers:Object.assign(Object.assign({},ct),lt)}),e)).then((t=>{if(t.ok)return t.json();throw t.statusText})),ht=t=>{const e=new FormData;for(const n of Object.keys(t))e.append(n,t[n]);return e};function pt(){return ut("/inbox").then(mt)}function mt(t){return Object.assign(Object.assign({},t),{convo:t.convo&&(e=t.convo,Object.assign(Object.assign({},e),{user:gt(e.user),msgs:e.msgs.map(vt)})),contacts:t.contacts.map(ft)});var e}function vt(t){return Object.assign(Object.assign({},t),{date:new Date(t.date)})}function gt(t){return Object.assign(Object.assign({},t),{id:t.name.toLowerCase()})}function ft(t){return Object.assign(Object.assign({},t),{user:gt(t.user),lastMsg:vt(t.lastMsg)})}let _t=[],bt=!1;function wt(t){const e=lichess.storage.make("just-notified");if(document.hasFocus()||Date.now()-parseInt(e.get(),10)<1e3)return;e.set(""+Date.now()),$.isFunction(t)&&(t=t());const n=new Notification("lichess.org",{icon:lichess.assetUrl("logo/lichess-favicon-256.png",{noVersion:!0}),body:t});n.onclick=()=>window.focus(),_t.push(n),bt||(bt=!0,window.addEventListener("focus",(()=>{_t.forEach((t=>t.close())),_t=[]})))}class yt{constructor(t,e,n){this.trans=e,this.redraw=n,this.search={input:""},this.loading=!1,this.connected=()=>!0,this.msgsPerPage=100,this.openConvo=t=>{var e;(null===(e=this.data.convo)||void 0===e?void 0:e.user.id)!=t&&(this.data.convo=void 0,this.loading=!0),function(t){return ut(`/inbox/${t}`).then(mt)}(t).then((e=>{this.data=e,this.search.result=void 0,this.loading=!1,e.convo?(history.replaceState({contact:t},"",`/inbox/${e.convo.user.name}`),this.onLoadConvo(e.convo),this.redraw()):this.showSide()})),this.pane="convo",this.redraw()},this.showSide=()=>{this.pane="side",this.redraw()},this.getMore=()=>{var t,e;this.data.convo&&this.canGetMoreSince&&(t=this.data.convo.user.id,e=this.canGetMoreSince,ut(`/inbox/${t}?before=${e.getTime()}`).then(mt)).then((t=>{this.data.convo&&t.convo&&t.convo.user.id==this.data.convo.user.id&&t.convo.msgs[0]&&(t.convo.msgs[0].date>=this.data.convo.msgs[this.data.convo.msgs.length-1].date||(this.data.convo.msgs=this.data.convo.msgs.concat(t.convo.msgs),this.onLoadMsgs(t.convo.msgs),this.redraw()))})),this.canGetMoreSince=void 0,this.redraw()},this.onLoadConvo=t=>{this.textStore=lichess.storage.make(`msg:area:${t.user.id}`),this.onLoadMsgs(t.msgs),this.typing&&(clearTimeout(this.typing.timeout),this.typing=void 0),setTimeout(this.setRead,500)},this.onLoadMsgs=t=>{const e=t[this.msgsPerPage-1];this.canGetMoreSince=null==e?void 0:e.date},this.post=t=>{if(this.data.convo){!function(t,e){lichess.pubsub.emit("socket.send","msgSend",{dest:t,text:e})}(this.data.convo.user.id,t);const e={text:t,user:this.data.me.id,date:new Date,read:!0};this.data.convo.msgs.unshift(e);const n=this.currentContact();n?this.addMsg(e,n):setTimeout((()=>pt().then((t=>{this.data.contacts=t.contacts,this.redraw()}))),1e3),M.enable(!0),this.redraw()}},this.receive=t=>{var e;const n=this.findContact(t.user);if(this.addMsg(t,n),n){let o=!1;t.user==(null===(e=this.data.convo)||void 0===e?void 0:e.user.id)&&(this.data.convo.msgs.unshift(t),document.hasFocus()?o=this.setRead():this.notify(n,t),this.receiveTyping(t.user,!0)),o||this.redraw()}else pt().then((e=>{this.data.contacts=e.contacts,this.notify(this.findContact(t.user),t),this.redraw()}))},this.addMsg=(t,e)=>{e&&(e.lastMsg=t,this.data.contacts=[e].concat(this.data.contacts.filter((t=>t.user.id!=e.user.id))))},this.findContact=t=>this.data.contacts.find((e=>e.user.id==t)),this.currentContact=()=>this.data.convo&&this.findContact(this.data.convo.user.id),this.notify=(t,e)=>{!function(t){!document.hasFocus()&&"Notification"in window&&"granted"===Notification.permission&&setTimeout(wt,10+500*Math.random(),t)}((()=>`${t.user.name}: ${e.text}`))},this.searchInput=t=>{this.search.input=t,t[1]?function(t){return ut(`/inbox/search?q=${t}`).then((t=>Object.assign(Object.assign({},t),{contacts:t.contacts.map(ft)})))}(t).then((t=>{this.search.result=this.search.input[1]?t:void 0,this.redraw()})):(this.search.result=void 0,this.redraw())},this.setRead=()=>{var t;const e=null===(t=this.currentContact())||void 0===t?void 0:t.lastMsg;return!(!e||e.user==this.data.me.id)&&(lichess.pubsub.emit("notify-app.set-read",e.user),!e.read&&(e.read=!0,n=e.user,lichess.pubsub.emit("socket.send","msgRead",n),this.redraw(),!0));var n},this.delete=()=>{var t;const e=null===(t=this.data.convo)||void 0===t?void 0:t.user.id;var n;e&&(n=e,ut(`/inbox/${n}`,{method:"delete"}).then(mt)).then((t=>{this.data=t,this.redraw(),history.replaceState({},"","/inbox")}))},this.report=()=>{var t,e,n;const o=null===(t=this.data.convo)||void 0===t?void 0:t.user;if(o){const t=null===(n=null===(e=this.data.convo)||void 0===e?void 0:e.msgs.find((t=>t.user!=this.data.me.id)))||void 0===n?void 0:n.text.slice(0,140);t&&function(t,e){return ut("/report/flag",{method:"post",body:ht({username:t,text:e,resource:"msg"})})}(o.name,t).then((t=>alert("Your report has been sent.")))}},this.block=()=>{var t;const e=null===(t=this.data.convo)||void 0===t?void 0:t.user.id;var n;e&&(n=e,ut(`/rel/block/${n}`,{method:"post"})).then((()=>this.openConvo(e)))},this.unblock=()=>{var t;const e=null===(t=this.data.convo)||void 0===t?void 0:t.user.id;var n;e&&(n=e,ut(`/rel/unblock/${n}`,{method:"post"})).then((()=>this.openConvo(e)))},this.changeBlockBy=t=>{var e;t==(null===(e=this.data.convo)||void 0===e?void 0:e.user.id)&&this.openConvo(t)},this.sendTyping=x(3e3,(t=>{var e,n;(null===(e=this.textStore)||void 0===e?void 0:e.get())&&(n=t,lichess.pubsub.emit("socket.send","msgType",n))})),this.receiveTyping=(t,e)=>{var n;this.typing&&(clearTimeout(this.typing.timeout),this.typing=void 0),!0!==e&&(null===(n=this.data.convo)||void 0===n?void 0:n.user.id)==t&&(this.typing={user:t,timeout:setTimeout((()=>{var e;(null===(e=this.data.convo)||void 0===e?void 0:e.user.id)==t&&(this.typing=void 0),this.redraw()}),3e3)}),this.redraw()},this.onReconnect=()=>{this.data.convo&&this.openConvo(this.data.convo.user.id),this.redraw()},this.data=t,this.pane=t.convo?"convo":"side",this.connected=function(t){const e=lichess.pubsub.on;e("socket.in.msgNew",(e=>{t.receive(Object.assign(Object.assign({},vt(e)),{read:!1}))})),e("socket.in.msgType",t.receiveTyping),e("socket.in.blockedBy",t.changeBlockBy),e("socket.in.unblockedBy",t.changeBlockBy);let n=!0;return e("socket.close",(()=>{n=!1,t.redraw()})),e("socket.open",(()=>{n||(n=!0,t.onReconnect())})),()=>n}(this),this.data.convo&&this.onLoadConvo(this.data.convo),window.addEventListener("focus",this.setRead)}}return function(t){const e=document.querySelector(".msg-app"),n=l([g,m]),o=()=>document.body.style.setProperty("--app-height",`${window.innerHeight}px`);window.addEventListener("resize",o),o();const s=new yt(mt(t.data),lichess.trans(t.i18n),r),i=rt(s);e.innerHTML="";let a=n(e,i);function r(){a=n(a,rt(s))}r()}}();
