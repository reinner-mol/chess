var LichessStorm=function(t){"use strict";const e={createElement:function(t,e){return document.createElement(t,e)},createElementNS:function(t,e,n){return document.createElementNS(t,e,n)},createTextNode:function(t){return document.createTextNode(t)},createComment:function(t){return document.createComment(t)},insertBefore:function(t,e,n){t.insertBefore(e,n)},removeChild:function(t,e){t.removeChild(e)},appendChild:function(t,e){t.appendChild(e)},parentNode:function(t){return t.parentNode},nextSibling:function(t){return t.nextSibling},tagName:function(t){return t.tagName},setTextContent:function(t,e){t.textContent=e},getTextContent:function(t){return t.textContent},isElement:function(t){return 1===t.nodeType},isText:function(t){return 3===t.nodeType},isComment:function(t){return 8===t.nodeType}};function n(t,e,n,o,r){return{sel:t,data:e,children:n,text:o,elm:r,key:void 0===e?void 0:e.key}}const o=Array.isArray;function r(t){return"string"==typeof t||"number"==typeof t}function i(t){return void 0===t}function s(t){return void 0!==t}const a=n("",{},[],void 0,void 0);function c(t,e){var n,o;const r=t.key===e.key,i=(null===(n=t.data)||void 0===n?void 0:n.is)===(null===(o=e.data)||void 0===o?void 0:o.is);return t.sel===e.sel&&r&&i}function l(t,e,n){var o;const r={};for(let i=e;i<=n;++i){const e=null===(o=t[i])||void 0===o?void 0:o.key;void 0!==e&&(r[e]=i)}return r}const u=["create","update","remove","destroy","pre","post"];function h(t,e,n){if(t.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==e)for(let t=0;t<e.length;++t){const n=e[t].data;void 0!==n&&h(n,e[t].children,e[t].sel)}}function d(t,e,i){let s,a,c,l={};if(void 0!==i?(null!==e&&(l=e),o(i)?s=i:r(i)?a=i:i&&i.sel&&(s=[i])):null!=e&&(o(e)?s=e:r(e)?a=e:e&&e.sel?s=[e]:l=e),void 0!==s)for(c=0;c<s.length;++c)r(s[c])&&(s[c]=n(void 0,void 0,void 0,s[c],void 0));return"s"!==t[0]||"v"!==t[1]||"g"!==t[2]||3!==t.length&&"."!==t[3]&&"#"!==t[3]||h(l,s,t),n(t,l,s,a,void 0)}function p(t,e){let n;const o=e.elm;let r=t.data.attrs,i=e.data.attrs;if((r||i)&&r!==i){for(n in r=r||{},i=i||{},i){const t=i[n];r[n]!==t&&(!0===t?o.setAttribute(n,""):!1===t?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,t):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,t):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,t):o.setAttribute(n,t))}for(n in r)n in i||o.removeAttribute(n)}}const f={create:p,update:p};function m(t,e){let n,o;const r=e.elm;let i=t.data.class,s=e.data.class;if((i||s)&&i!==s){for(o in i=i||{},s=s||{},i)i[o]&&!Object.prototype.hasOwnProperty.call(s,o)&&r.classList.remove(o);for(o in s)n=s[o],n!==i[o]&&r.classList[n?"add":"remove"](o)}}const v={create:m,update:m};const g=t=>void 0!==t,b=t=>{let e=t;return function(t){return g(t)&&(e=t),e}},w={Accept:"application/vnd.lichess.v5+json"},k={cache:"no-cache",credentials:"same-origin"},y={"X-Requested-With":"XMLHttpRequest"},S=(t,e={})=>fetch(t,Object.assign(Object.assign(Object.assign({},k),{headers:Object.assign({},y)}),e)),C=t=>{const e=new FormData;for(const n of Object.keys(t))e.append(n,t[n]);return e};function _(t,e){return((t,e={})=>fetch(t,Object.assign(Object.assign(Object.assign({},k),{headers:Object.assign(Object.assign({},w),y)}),e)).then((t=>{if(t.ok)return t.json();throw t.statusText})))("/storm",{method:"POST",body:C(Object.assign(Object.assign({},t),{time:Math.round(t.time),notAnExploit:e}))})}const E={clock:{initial:180,malus:10},combo:{levels:[[0,0],[5,3],[12,5],[20,7],[30,10]]},timeToStart:12e4,minFirstMoveTime:400},z=["a","b","c","d","e","f","g","h"],M=["1","2","3","4","5","6","7","8"],x=["white","black"],A=["pawn","knight","bishop","rook","queen","king"],q=["a","h"];function T(t){return"role"in t}function P(t){return void 0!==t}function O(t){return"white"===t?"black":"white"}function R(t){return t>>3}function N(t){return 7&t}function F(t){switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}}function I(t){switch(t){case"P":case"p":return"pawn";case"N":case"n":return"knight";case"B":case"b":return"bishop";case"R":case"r":return"rook";case"Q":case"q":return"queen";case"K":case"k":return"king";default:return}}function D(t){if(2!==t.length)return;const e=t.charCodeAt(0)-"a".charCodeAt(0),n=t.charCodeAt(1)-"1".charCodeAt(0);return e<0||e>=8||n<0||n>=8?void 0:e+8*n}function L(t){return z[N(t)]+M[R(t)]}function K(t){if("@"===t[1]&&4===t.length){const e=I(t[0]),n=D(t.slice(2));if(e&&P(n))return{role:e,to:n}}else if(4===t.length||5===t.length){const e=D(t.slice(0,2)),n=D(t.slice(2,4));let o;if(5===t.length&&(o=I(t[4]),!o))return;if(P(e)&&P(n))return{from:e,to:n,promotion:o}}}function B(t,e){return"white"===t?"a"===e?2:6:"a"===e?58:62}function j(t){return t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24}function H(t){return(t=t>>>8&16711935|(16711935&t)<<8)>>>16&65535|(65535&t)<<16}function W(t){return H(t=(t=(t=t>>>1&1431655765|(1431655765&t)<<1)>>>2&858993459|(858993459&t)<<2)>>>4&252645135|(252645135&t)<<4)}class X{constructor(t,e){this.lo=t,this.hi=e,this.lo=0|t,this.hi=0|e}static fromSquare(t){return t>=32?new X(0,1<<t-32):new X(1<<t,0)}static fromRank(t){return new X(255,0).shl64(8*t)}static fromFile(t){return new X(16843009<<t,16843009<<t)}static empty(){return new X(0,0)}static full(){return new X(4294967295,4294967295)}static corners(){return new X(129,2164260864)}static center(){return new X(402653184,24)}static backranks(){return new X(255,4278190080)}static backrank(t){return"white"===t?new X(255,0):new X(0,4278190080)}static lightSquares(){return new X(1437226410,1437226410)}static darkSquares(){return new X(2857740885,2857740885)}complement(){return new X(~this.lo,~this.hi)}xor(t){return new X(this.lo^t.lo,this.hi^t.hi)}union(t){return new X(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new X(this.lo&t.lo,this.hi&t.hi)}diff(t){return new X(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?X.empty():t>=32?new X(this.hi>>>t-32,0):t>0?new X(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?X.empty():t>=32?new X(0,this.lo<<t-32):t>0?new X(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new X(H(this.hi),H(this.lo))}rbit64(){return new X(W(this.hi),W(this.lo))}minus64(t){const e=this.lo-t.lo,n=(e&t.lo&1)+(t.lo>>>1)+(e>>>1)>>>31;return new X(e,this.hi-(t.hi+n))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return j(this.lo)+j(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(t){return 0!=(t>=32?this.hi&1<<t-32:this.lo&1<<t)}set(t,e){return e?this.with(t):this.without(t)}with(t){return t>=32?new X(this.lo,this.hi|1<<t-32):new X(this.lo|1<<t,this.hi)}without(t){return t>=32?new X(this.lo,this.hi&~(1<<t-32)):new X(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new X(this.lo,this.hi^1<<t-32):new X(this.lo^1<<t,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new X(this.lo&this.lo-1,this.hi):new X(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||0!=(this.lo&this.lo-1)||0!=(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}isSingleSquare(){return this.nonEmpty()&&!this.moreThanOne()}*[Symbol.iterator](){let t=this.lo,e=this.hi;for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield e}for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield 32+t}}*reversed(){let t=this.lo,e=this.hi;for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield 32+t}for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield e}}}function U(t,e){let n=X.empty();for(const o of e){const e=t+o;0<=e&&e<64&&Math.abs(N(t)-N(e))<=2&&(n=n.with(e))}return n}function G(t){const e=[];for(let n=0;n<64;n++)e[n]=t(n);return e}const Q=G((t=>U(t,[-9,-8,-7,-1,1,7,8,9]))),V=G((t=>U(t,[-17,-15,-10,-6,6,10,15,17]))),Y={white:G((t=>U(t,[7,9]))),black:G((t=>U(t,[-7,-9])))};function Z(t){return Q[t]}function J(t){return V[t]}function tt(t,e){return Y[t][e]}const et=G((t=>X.fromFile(N(t)).without(t))),nt=G((t=>X.fromRank(R(t)).without(t))),ot=G((t=>{const e=new X(134480385,2151686160),n=8*(R(t)-N(t));return(n>=0?e.shl64(n):e.shr64(-n)).without(t)})),rt=G((t=>{const e=new X(270549120,16909320),n=8*(R(t)+N(t)-7);return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}));function it(t,e,n){let o=n.intersect(e),r=o.bswap64();return o=o.minus64(t),r=r.minus64(t.bswap64()),o.xor(r.bswap64()).intersect(e)}function st(t,e){const n=X.fromSquare(t);return it(n,ot[t],e).xor(it(n,rt[t],e))}function at(t,e){return function(t,e){return it(X.fromSquare(t),et[t],e)}(t,e).xor(function(t,e){const n=nt[t];let o=e.intersect(n),r=o.rbit64();return o=o.minus64(X.fromSquare(t)),r=r.minus64(X.fromSquare(63-t)),o.xor(r.rbit64()).intersect(n)}(t,e))}function ct(t,e){return st(t,e).xor(at(t,e))}function lt(t,e){const n=X.fromSquare(e);return nt[t].intersects(n)?nt[t].with(t):rt[t].intersects(n)?rt[t].with(t):ot[t].intersects(n)?ot[t].with(t):et[t].intersects(n)?et[t].with(t):X.empty()}function ut(t,e){return lt(t,e).intersect(X.full().shl64(t).xor(X.full().shl64(e))).withoutFirst()}class ht{constructor(){}static default(){const t=new ht;return t.reset(),t}static racingKings(){const t=new ht;return t.occupied=new X(65535,0),t.promoted=X.empty(),t.white=new X(61680,0),t.black=new X(3855,0),t.pawn=X.empty(),t.knight=new X(6168,0),t.bishop=new X(9252,0),t.rook=new X(16962,0),t.queen=new X(129,0),t.king=new X(33024,0),t}static horde(){const t=new ht;return t.occupied=new X(4294967295,4294901862),t.promoted=X.empty(),t.white=new X(4294967295,102),t.black=new X(0,4294901760),t.pawn=new X(4294967295,16711782),t.knight=new X(0,1107296256),t.bishop=new X(0,603979776),t.rook=new X(0,2164260864),t.queen=new X(0,134217728),t.king=new X(0,268435456),t}reset(){this.occupied=new X(65535,4294901760),this.promoted=X.empty(),this.white=new X(65535,0),this.black=new X(0,4294901760),this.pawn=new X(65280,16711680),this.knight=new X(66,1107296256),this.bishop=new X(36,603979776),this.rook=new X(129,2164260864),this.queen=new X(8,134217728),this.king=new X(16,268435456)}static empty(){const t=new ht;return t.clear(),t}clear(){this.occupied=X.empty(),this.promoted=X.empty();for(const t of x)this[t]=X.empty();for(const t of A)this[t]=X.empty()}clone(){const t=new ht;t.occupied=this.occupied,t.promoted=this.promoted;for(const e of x)t[e]=this[e];for(const e of A)t[e]=this[e];return t}equalsIgnorePromoted(t){return!!this.white.equals(t.white)&&A.every((e=>this[e].equals(t[e])))}equals(t){return this.equalsIgnorePromoted(t)&&this.promoted.equals(t.promoted)}getColor(t){return this.white.has(t)?"white":this.black.has(t)?"black":void 0}getRole(t){for(const e of A)if(this[e].has(t))return e}get(t){const e=this.getColor(t);if(!e)return;return{color:e,role:this.getRole(t),promoted:this.promoted.has(t)}}take(t){const e=this.get(t);return e&&(this.occupied=this.occupied.without(t),this[e.color]=this[e.color].without(t),this[e.role]=this[e.role].without(t),e.promoted&&(this.promoted=this.promoted.without(t))),e}set(t,e){const n=this.take(t);return this.occupied=this.occupied.with(t),this[e.color]=this[e.color].with(t),this[e.role]=this[e.role].with(t),e.promoted&&(this.promoted=this.promoted.with(t)),n}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,e){return this[t].intersect(this[e])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.king.intersect(this[t]).diff(this.promoted).singleSquare()}}class dt{constructor(){}static empty(){const t=new dt;for(const e of A)t[e]=0;return t}static fromBoard(t,e){const n=new dt;for(const o of A)n[o]=t.pieces(e,o).size();return n}clone(){const t=new dt;for(const e of A)t[e]=this[e];return t}equals(t){return A.every((e=>this[e]===t[e]))}add(t){const e=new dt;for(const n of A)e[n]=this[n]+t[n];return e}nonEmpty(){return A.some((t=>this[t]>0))}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}count(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class pt{constructor(t,e){this.white=t,this.black=e}static empty(){return new pt(dt.empty(),dt.empty())}static fromBoard(t){return new pt(dt.fromBoard(t,"white"),dt.fromBoard(t,"black"))}clone(){return new pt(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new pt(this.white.add(t.white),this.black.add(t.black))}count(){return this.white.count()+this.black.count()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class ft{constructor(t,e){this.white=t,this.black=e}static default(){return new ft(3,3)}clone(){return new ft(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}function mt(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var vt,gt,bt,wt=function(){function t(){}var e=t.prototype;return e.unwrap=function(t,e){var n=this._chain((function(e){return vt.ok(t?t(e):e)}),(function(t){return e?vt.ok(e(t)):vt.err(t)}));if(n.isErr)throw n.error;return n.value},e.map=function(t,e){return this._chain((function(e){return vt.ok(t(e))}),(function(t){return vt.err(e?e(t):t)}))},e.chain=function(t,e){return this._chain(t,e||function(t){return vt.err(t)})},t}(),kt=function(t){function e(e){var n;return(n=t.call(this)||this).value=e,n.isOk=!0,n.isErr=!1,n}return mt(e,t),e.prototype._chain=function(t,e){return t(this.value)},e}(wt),yt=function(t){function e(e){var n;return(n=t.call(this)||this).error=e,n.isOk=!1,n.isErr=!0,n}return mt(e,t),e.prototype._chain=function(t,e){return e(this.error)},e}(wt);!function(t){t.ok=function(t){return new kt(t)},t.err=function(t){return new yt(t||new Error)},t.all=function(e){if(Array.isArray(e)){for(var n=[],o=0;o<e.length;o++){var r=e[o];if(r.isErr)return r;n.push(r.value)}return t.ok(n)}for(var i={},s=Object.keys(e),a=0;a<s.length;a++){var c=e[s[a]];if(c.isErr)return c;i[s[a]]=c.value}return t.ok(i)}}(vt||(vt={})),function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"}(gt||(gt={}));class St extends Error{}function Ct(t,e){return"white"===t?"a"===e?3:5:"a"===e?59:61}class _t{constructor(){}static default(){const t=new _t;return t.unmovedRooks=X.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new X(14,0),h:new X(96,0)},black:{a:new X(0,234881024),h:new X(0,1610612736)}},t}static empty(){const t=new _t;return t.unmovedRooks=X.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:X.empty(),h:X.empty()},black:{a:X.empty(),h:X.empty()}},t}clone(){const t=new _t;return t.unmovedRooks=this.unmovedRooks,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,e,n,o){const r=B(t,e),i=Ct(t,e);this.unmovedRooks=this.unmovedRooks.with(o),this.rook[t][e]=o,this.path[t][e]=ut(o,i).with(i).union(ut(n,r).with(r)).without(n).without(o)}static fromSetup(t){const e=_t.empty(),n=t.unmovedRooks.intersect(t.board.rook);for(const o of x){const r=X.backrank(o),i=t.board.kingOf(o);if(!P(i)||!r.has(i))continue;const s=n.intersect(t.board[o]).intersect(r),a=s.first();P(a)&&a<i&&e.add(o,"a",i,a);const c=s.last();P(c)&&i<c&&e.add(o,"h",i,c)}return e}discardRook(t){if(this.unmovedRooks.has(t)){this.unmovedRooks=this.unmovedRooks.without(t);for(const e of x)for(const n of q)this.rook[e][n]===t&&(this.rook[e][n]=void 0)}}discardSide(t){this.unmovedRooks=this.unmovedRooks.diff(X.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class Et extends class{constructor(t){this.rules=t}kingAttackers(t,e,n){return function(t,e,n,o){return n[e].intersect(at(t,o).intersect(n.rooksAndQueens()).union(st(t,o).intersect(n.bishopsAndQueens())).union(J(t).intersect(n.knight)).union(Z(t).intersect(n.king)).union(tt(O(e),t).intersect(n.pawn)))}(t,e,this.board,n)}dropDests(t){return X.empty()}playCaptureAt(t,e){this.halfmoves=0,"rook"===e.role&&this.castles.discardRook(t),this.pockets&&this.pockets[O(e.color)][e.role]++}ctx(){const t=this.isVariantEnd(),e=this.board.kingOf(this.turn);if(!P(e))return{king:e,blockers:X.empty(),checkers:X.empty(),variantEnd:t,mustCapture:!1};const n=at(e,X.empty()).intersect(this.board.rooksAndQueens()).union(st(e,X.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[O(this.turn)]);let o=X.empty();for(const t of n){const n=ut(e,t).intersect(this.board.occupied);n.moreThanOne()||(o=o.union(n))}return{king:e,blockers:o,checkers:this.kingAttackers(e,O(this.turn),this.board.occupied),variantEnd:t,mustCapture:!1}}clone(){var t,e;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=null===(t=this.pockets)||void 0===t?void 0:t.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=null===(e=this.remainingChecks)||void 0===e?void 0:e.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}equalsIgnoreMoves(t){var e,n;return this.rules===t.rules&&(this.pockets?this.board.equals(t.board):this.board.equalsIgnorePromoted(t.board))&&(t.pockets&&(null===(e=this.pockets)||void 0===e?void 0:e.equals(t.pockets))||!this.pockets&&!t.pockets)&&this.turn===t.turn&&this.castles.unmovedRooks.equals(t.castles.unmovedRooks)&&this.legalEpSquare()===t.legalEpSquare()&&(t.remainingChecks&&(null===(n=this.remainingChecks)||void 0===n?void 0:n.equals(t.remainingChecks))||!this.remainingChecks&&!t.remainingChecks)}toSetup(){var t,e;return{board:this.board.clone(),pockets:null===(t=this.pockets)||void 0===t?void 0:t.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:this.legalEpSquare(),remainingChecks:null===(e=this.remainingChecks)||void 0===e?void 0:e.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return x.every((t=>this.hasInsufficientMaterial(t)))}hasDests(t){t=t||this.ctx();for(const e of this.board[this.turn])if(this.dests(e,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,e){if(T(t))return!(!this.pockets||this.pockets[this.turn][t.role]<=0)&&(("pawn"!==t.role||!X.backranks().has(t.to))&&this.dropDests(e).has(t.to));{if("pawn"===t.promotion)return!1;if("king"===t.promotion&&"antichess"!==this.rules)return!1;if(!!t.promotion!==(this.board.pawn.has(t.from)&&X.backranks().has(t.to)))return!1;const n=this.dests(t.from,e);return n.has(t.to)||n.has(this.normalizeMove(t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return P(t)&&this.kingAttackers(t,O(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return!!(t?t.variantEnd:this.isVariantEnd())||(this.isInsufficientMaterial()||!this.hasDests(t))}isCheckmate(t){return!(t=t||this.ctx()).variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return!(t=t||this.ctx()).variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const e=this.variantOutcome(t);return e||(t=t||this.ctx(),this.isCheckmate(t)?{winner:O(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const e=new Map;if(t.variantEnd)return e;for(const n of this.board[this.turn])e.set(n,this.dests(n,t));return e}castlingSide(t){if(T(t))return;const e=t.to-t.from;return(2===Math.abs(e)||this.board[this.turn].has(t.to))&&this.board.king.has(t.from)?e>0?"h":"a":void 0}normalizeMove(t){const e=this.castlingSide(t);if(!e)return t;const n=this.castles.rook[this.turn][e];return{from:t.from,to:P(n)?n:t.to}}play(t){const e=this.turn,n=this.epSquare,o=this.castlingSide(t);if(this.epSquare=void 0,this.halfmoves+=1,"black"===e&&(this.fullmoves+=1),this.turn=O(e),T(t))this.board.set(t.to,{role:t.role,color:e}),this.pockets&&this.pockets[e][t.role]--,"pawn"===t.role&&(this.halfmoves=0);else{const r=this.board.take(t.from);if(!r)return;let i;if("pawn"===r.role){this.halfmoves=0,t.to===n&&(i=this.board.take(t.to+("white"===e?-8:8)));const o=t.from-t.to;16===Math.abs(o)&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(r.role=t.promotion,r.promoted=!0)}else if("rook"===r.role)this.castles.discardRook(t.from);else if("king"===r.role){if(o){const t=this.castles.rook[e][o];if(P(t)){const n=this.board.take(t);this.board.set(B(e,o),r),n&&this.board.set(Ct(e,o),n)}}if(this.castles.discardSide(e),o)return}const s=this.board.set(t.to,r)||i;s&&this.playCaptureAt(t.to,s)}}legalEpSquare(t){if(!P(this.epSquare))return;t=t||this.ctx();const e=this.board.pieces(this.turn,"pawn").intersect(tt(O(this.turn),this.epSquare));for(const n of e)if(this.dests(n,t).has(this.epSquare))return this.epSquare}}{constructor(t){super(t||"chess")}static default(){const t=new this;return t.board=ht.default(),t.pockets=void 0,t.turn="white",t.castles=_t.default(),t.epSquare=void 0,t.remainingChecks=void 0,t.halfmoves=0,t.fullmoves=1,t}static fromSetup(t){const e=new this;return e.board=t.board.clone(),e.pockets=void 0,e.turn=t.turn,e.castles=_t.fromSetup(t),e.epSquare=e.validEpSquare(t.epSquare),e.remainingChecks=void 0,e.halfmoves=t.halfmoves,e.fullmoves=t.fullmoves,e.validate().map((t=>e))}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return vt.err(new St(gt.Empty));if(2!==this.board.king.size())return vt.err(new St(gt.Kings));if(!P(this.board.kingOf(this.turn)))return vt.err(new St(gt.Kings));const t=this.board.kingOf(O(this.turn));return P(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?vt.err(new St(gt.OppositeCheck)):X.backranks().intersects(this.board.pawn)?vt.err(new St(gt.PawnsOnBackrank)):this.validateCheckers():vt.err(new St(gt.Kings))}validateCheckers(){const t=this.board.kingOf(this.turn);if(P(t)){const e=this.kingAttackers(t,O(this.turn),this.board.occupied);if(e.size()>2||2===e.size()&&lt(e.first(),e.last()).has(t))return vt.err(new St(gt.ImpossibleCheck));if(P(this.epSquare))for(const n of e)if(lt(n,this.epSquare).has(t))return vt.err(new St(gt.ImpossibleCheck))}return vt.ok(void 0)}validEpSquare(t){if(!P(t))return;const e="white"===this.turn?5:2,n="white"===this.turn?8:-8;if(R(t)!==e)return;if(this.board.occupied.has(t+n))return;const o=t-n;return this.board.pawn.has(o)&&this.board[O(this.turn)].has(o)?t:void 0}castlingDest(t,e){if(!P(e.king)||e.checkers.nonEmpty())return X.empty();const n=this.castles.rook[this.turn][t];if(!P(n))return X.empty();if(this.castles.path[this.turn][t].intersects(this.board.occupied))return X.empty();const o=B(this.turn,t),r=ut(e.king,o),i=this.board.occupied.without(e.king);for(const t of r)if(this.kingAttackers(t,O(this.turn),i).nonEmpty())return X.empty();const s=Ct(this.turn,t),a=this.board.occupied.toggle(e.king).toggle(n).toggle(s);return this.kingAttackers(o,O(this.turn),a).nonEmpty()?X.empty():X.fromSquare(n)}canCaptureEp(t,e){if(!P(this.epSquare))return!1;if(!tt(this.turn,t).has(this.epSquare))return!1;if(!P(e.king))return!0;const n=this.epSquare+("white"===this.turn?-8:8),o=this.board.occupied.toggle(t).toggle(this.epSquare).toggle(n);return!this.kingAttackers(e.king,O(this.turn),o).intersects(o)}pseudoDests(t,e){if(e.variantEnd)return X.empty();const n=this.board.get(t);if(!n||n.color!==this.turn)return X.empty();let o=function(t,e,n){switch(t.role){case"pawn":return tt(t.color,e);case"knight":return J(e);case"bishop":return st(e,n);case"rook":return at(e,n);case"queen":return ct(e,n);case"king":return Z(e)}}(n,t,this.board.occupied);if("pawn"===n.role){let e=this.board[O(this.turn)];P(this.epSquare)&&(e=e.with(this.epSquare)),o=o.intersect(e);const n="white"===this.turn?8:-8,r=t+n;if(0<=r&&r<64&&!this.board.occupied.has(r)){o=o.with(r);const e=r+n;("white"===this.turn?t<16:t>=48)&&!this.board.occupied.has(e)&&(o=o.with(e))}return o}return o=o.diff(this.board[this.turn]),t===e.king?o.union(this.castlingDest("a",e)).union(this.castlingDest("h",e)):o}dests(t,e){if((e=e||this.ctx()).variantEnd)return X.empty();const n=this.board.get(t);if(!n||n.color!==this.turn)return X.empty();let o,r;if("pawn"===n.role){o=tt(this.turn,t).intersect(this.board[O(this.turn)]);const n="white"===this.turn?8:-8,i=t+n;if(0<=i&&i<64&&!this.board.occupied.has(i)){o=o.with(i);const e=i+n;("white"===this.turn?t<16:t>=48)&&!this.board.occupied.has(e)&&(o=o.with(e))}if(P(this.epSquare)&&this.canCaptureEp(t,e)){const t=this.epSquare-n;(e.checkers.isEmpty()||e.checkers.singleSquare()===t)&&(r=X.fromSquare(this.epSquare))}}else o="bishop"===n.role?st(t,this.board.occupied):"knight"===n.role?J(t):"rook"===n.role?at(t,this.board.occupied):"queen"===n.role?ct(t,this.board.occupied):Z(t);if(o=o.diff(this.board[this.turn]),P(e.king)){if("king"===n.role){const n=this.board.occupied.without(t);for(const t of o)this.kingAttackers(t,O(this.turn),n).nonEmpty()&&(o=o.without(t));return o.union(this.castlingDest("a",e)).union(this.castlingDest("h",e))}if(e.checkers.nonEmpty()){const t=e.checkers.singleSquare();if(!P(t))return X.empty();o=o.intersect(ut(t,e.king).with(t))}e.blockers.has(t)&&(o=o.intersect(lt(t,e.king)))}return r&&(o=o.union(r)),o}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){if(this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty())return!1;if(this.board[t].intersects(this.board.knight))return this.board[t].size()<=2&&this.board[O(t)].diff(this.board.king).diff(this.board.queen).isEmpty();if(this.board[t].intersects(this.board.bishop)){return(!this.board.bishop.intersects(X.darkSquares())||!this.board.bishop.intersects(X.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty()}return!0}}function zt(t,e){const n=new Map,o=t.ctx();for(const[r,i]of t.allDests(o))if(i.nonEmpty()){const t=Array.from(i,L);(null==e?void 0:e.chess960)||r!==o.king||4!==N(r)||(i.has(0)?t.push("c1"):i.has(56)&&t.push("c8"),i.has(7)?t.push("g1"):i.has(63)&&t.push("g8")),n.set(L(r),t)}return n}!function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"}(bt||(bt={}));class Mt extends Error{}function xt(t){return/^\d{1,4}$/.test(t)?parseInt(t,10):void 0}function At(t){const e=I(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}}function qt(t){const e=ht.empty();let n=7,o=0;for(let r=0;r<t.length;r++){const i=t[r];if("/"===i&&8===o)o=0,n--;else{const s=parseInt(i,10);if(s>0)o+=s;else{if(o>=8||n<0)return vt.err(new Mt(bt.Board));const s=o+8*n,a=At(i);if(!a)return vt.err(new Mt(bt.Board));"~"===t[r+1]&&(a.promoted=!0,r++),e.set(s,a),o++}}}return 0!==n||8!==o?vt.err(new Mt(bt.Board)):vt.ok(e)}function Tt(t){if(t.length>64)return vt.err(new Mt(bt.Pockets));const e=pt.empty();for(const n of t){const t=At(n);if(!t)return vt.err(new Mt(bt.Pockets));e[t.color][t.role]++}return vt.ok(e)}function Pt(t){const e=t.split("+");if(3===e.length&&""===e[0]){const t=xt(e[1]),n=xt(e[2]);return!P(t)||t>3||!P(n)||n>3?vt.err(new Mt(bt.RemainingChecks)):vt.ok(new ft(3-t,3-n))}if(2===e.length){const t=xt(e[0]),n=xt(e[1]);return!P(t)||t>3||!P(n)||n>3?vt.err(new Mt(bt.RemainingChecks)):vt.ok(new ft(t,n))}return vt.err(new Mt(bt.RemainingChecks))}function Ot(t){const e=t.split(" "),n=e.shift();let o,r,i=vt.ok(void 0);if(n.endsWith("]")){const t=n.indexOf("[");if(-1===t)return vt.err(new Mt(bt.Fen));o=qt(n.substr(0,t)),i=Tt(n.substr(t+1,n.length-1-t-1))}else{const t=function(t,e,n){let o=t.indexOf(e);for(;n-- >0&&-1!==o;)o=t.indexOf(e,o+e.length);return o}(n,"/",7);-1===t?o=qt(n):(o=qt(n.substr(0,t)),i=Tt(n.substr(t+1)))}const s=e.shift();if(P(s)&&"w"!==s){if("b"!==s)return vt.err(new Mt(bt.Turn));r="black"}else r="white";return o.chain((t=>{const n=e.shift(),o=P(n)?function(t,e){let n=X.empty();if("-"===e)return vt.ok(n);if(!/^[KQABCDEFGH]{0,2}[kqabcdefgh]{0,2}$/.test(e))return vt.err(new Mt(bt.Castling));for(const o of e){const e=o.toLowerCase(),r=o===e?"black":"white",i=X.backrank(r).intersect(t[r]);let s;s="q"===e?i:"k"===e?i.reversed():X.fromSquare(e.charCodeAt(0)-"a".charCodeAt(0)).intersect(i);for(const e of s){if(t.king.has(e)&&!t.promoted.has(e))break;if(t.rook.has(e)){n=n.with(e);break}}}return vt.ok(n)}(t,n):vt.ok(X.empty()),s=e.shift();let a;if(P(s)&&"-"!==s&&(a=D(s),!P(a)))return vt.err(new Mt(bt.EpSquare));let c,l=e.shift();P(l)&&l.includes("+")&&(c=Pt(l),l=e.shift());const u=P(l)?xt(l):0;if(!P(u))return vt.err(new Mt(bt.Halfmoves));const h=e.shift(),d=P(h)?xt(h):1;if(!P(d))return vt.err(new Mt(bt.Fullmoves));const p=e.shift();let f=vt.ok(void 0);if(P(p)){if(P(c))return vt.err(new Mt(bt.RemainingChecks));f=Pt(p)}else P(c)&&(f=c);return e.length>0?vt.err(new Mt(bt.Fen)):i.chain((e=>o.chain((n=>f.map((o=>({board:t,pockets:e,turn:r,unmovedRooks:n,remainingChecks:o,epSquare:a,halfmoves:u,fullmoves:Math.max(1,d)})))))))}))}function Rt(t,e){let n=F(t.role);return"white"===t.color&&(n=n.toUpperCase()),(null==e?void 0:e.promoted)&&t.promoted&&(n+="~"),n}function Nt(t,e){let n="",o=0;for(let r=7;r>=0;r--)for(let i=0;i<8;i++){const s=i+8*r,a=t.get(s);a?(o>0&&(n+=o,o=0),n+=Rt(a,e)):o++,7===i&&(o>0&&(n+=o,o=0),0!==r&&(n+="/"))}return n}function Ft(t){return A.map((e=>F(e).repeat(t[e]))).join("")}function It(t,e,n){const o=null==n?void 0:n.shredder;let r="";for(const n of x){const i=X.backrank(n),s=t.kingOf(n);if(!P(s)||!i.has(s))continue;const a=t.pieces(n,"rook").intersect(i);for(const t of e.intersect(a).reversed())if(!o&&t===a.first()&&t<s)r+="white"===n?"Q":"q";else if(!o&&t===a.last()&&s<t)r+="white"===n?"K":"k";else{const e=z[N(t)];r+="white"===n?e.toUpperCase():e}}return r||"-"}function Dt(t,e){return[Nt(t.board,e)+(t.pockets?`[${o=t.pockets,Ft(o.white).toUpperCase()+Ft(o.black)}]`:""),t.turn[0],It(t.board,t.unmovedRooks,e),P(t.epSquare)?L(t.epSquare):"-",...t.remainingChecks?[(n=t.remainingChecks,`${n.white}+${n.black}`)]:[],...(null==e?void 0:e.epd)?[]:[Math.max(0,Math.min(t.halfmoves,9999)),Math.max(1,Math.min(t.fullmoves,9999))]].join(" ");var n,o}function Lt(t,e,n){return Kt((o=>o.addEventListener(t,(t=>{const o=e(t);return n&&n(),o}))))}function Kt(t){return{insert:e=>t(e.elm)}}const Bt=()=>Math.round(performance.now()),$t=(t,e,n)=>(setTimeout((()=>lichess.sound.loadOggOrMp3(t,`${lichess.sound.baseUrl}/${t}`)),n||1e3),()=>lichess.sound.play(t,e)),jt={move:t=>lichess.sound.play(t?"capture":"move"),good:$t("lisp/PuzzleStormGood",.9,1e3),wrong:$t("lisp/Error",1,1e3),end:$t("lisp/PuzzleStormEnd",1,5e3)},Ht=["white","black"],Wt=["a","b","c","d","e","f","g","h"],Xt=["1","2","3","4","5","6","7","8"],Ut=[...Xt].reverse(),Gt=Array.prototype.concat(...Wt.map((t=>Xt.map((e=>t+e))))),Qt=t=>Gt[8*t[0]+t[1]],Vt=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],Yt=Gt.map(Vt);const Zt=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},Jt=t=>"white"===t?"black":"white",te=(t,e)=>{const n=t[0]-e[0],o=t[1]-e[1];return n*n+o*o},ee=(t,e)=>t.role===e.role&&t.color===e.color,ne=(t,e,n,o)=>[(e?t[0]:7-t[0])*n,(e?7-t[1]:t[1])*o],oe=t=>{const e=t.width/8,n=t.height/8;return(t,o)=>ne(t,o,e,n)},re=(t,e)=>ne(t,e,100,100),ie=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},se=(t,e)=>{t.style.transform=`translate(${e[0]}%,${e[1]}%)`},ae=(t,e)=>{t.style.visibility=e?"visible":"hidden"},ce=t=>{var e;return t.clientX||0===t.clientX?[t.clientX,t.clientY]:(null===(e=t.targetTouches)||void 0===e?void 0:e[0])?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:void 0},le=t=>2===t.buttons||2===t.button,ue=(t,e)=>{const n=document.createElement(t);return e&&(n.className=e),n};function he(t,e,n){const o=Vt(t);return e||(o[0]=7-o[0],o[1]=7-o[1]),[n.left+n.width*o[0]/8+n.width/16,n.top+n.height*(7-o[1])/8+n.height/16]}function de(t,e,n){let o=!1;function r(e){o&&t((t=>function(t,e,n){const o=t.state.pieces.get(e);o&&"pawn"==o.role&&t.setPieces(new Map([[e,{color:o.color,role:n,promoted:!0}]]))}(t,o.dest,e))),o.callback&&o.callback(o.orig,o.dest,e),o=!1}function i(){o&&(o=!1,t((t=>t.set(e()))),n())}return{start:function(e,r,i){return!!t((t=>{const s=t.state.pieces.get(r);return!(!s||"pawn"!=s.role||!("8"==r[1]&&"black"==t.state.turnColor||"1"==r[1]&&"white"==t.state.turnColor))&&(o={orig:e,dest:r,callback:i},n(),!0)}))},cancel:i,view(){if(!o)return;const e=["queen","knight","rook","bishop"];return t((t=>function(t,e,n,s){if(!o)return;let a=12.5*(7-Vt(t)[0]);return"white"===s&&(a=87.5-a),d("div#promotion-choice."+(n===s?"top":"bottom"),{hook:Kt((t=>{t.addEventListener("click",i),t.oncontextmenu=()=>!1}))},e.map((function(t,e){return d("square",{attrs:{style:"top: "+12.5*(n===s?e:7-e)+"%;left: "+a+"%"},hook:Lt("click",(e=>{e.stopPropagation(),r(t)}))},[d("piece."+t+"."+n)])})))}(o.dest,e,Jt(t.state.turnColor),t.state.orientation)))||null}}}function pe(t){const e=function(t){const e=[];for(let n=0;n<t;n++)e.push(String.fromCharCode(34+Math.floor(92*Math.random())));return e.join("")}(64);return lichess.socket.send("sk1",`${t}!${e}`),new Promise((t=>lichess.pubsub.on("socket.in.sk1",(n=>t(function(t,e){const n=[];for(let o=0;o<t.length;o++)n.push(String.fromCharCode(t.charCodeAt(o)^e.charCodeAt(o)));return n.join("")}(n,e))))))}const fe=(t,e,n)=>{const o=t.current,r=o.position();return{fen:Dt(r.toSetup()),orientation:n?Jt(t.pov):t.pov,turnColor:r.turn,movable:{color:t.pov,dests:e?zt(r):void 0},check:!!r.isCheck(),lastMove:(i=o.lastMove(),[i.substr(0,2),i.substr(2,2)])};var i},me=t=>`youPlayThe${"white"==t.pov?"White":"Black"}PiecesInAllPuzzles`;class ve{constructor(t){this.config=t,this.current=0,this.best=0,this.inc=()=>{this.current++,this.best=Math.max(this.best,this.current)},this.reset=()=>{this.current=0},this.level=()=>this.config.combo.levels.reduce(((t,[e,n],o)=>e<=this.current?o:t),0),this.percent=()=>{const t=this.level(),e=this.config.combo.levels,n=e[e.length-1];if(t>=e.length-1){const t=n[0]-e[e.length-2][0];return(this.current-n[0])/t*100%100}const o=[e[t][0],e[t+1][0]];return Math.floor((this.current-o[0])/(o[1]-o[0])*100)},this.bonus=()=>{if(0==this.percent()){const t=this.level();if(t>0)return{seconds:this.config.combo.levels[t][1],at:Bt()}}}}}class ge{constructor(t,e){this.index=t,this.puzzle=e,this.moveIndex=0,this.position=()=>{const t=Et.fromSetup(Ot(this.puzzle.fen).unwrap()).unwrap();return this.line.slice(0,this.moveIndex+1).forEach((e=>t.play(K(e)))),t},this.expectedMove=()=>this.line[this.moveIndex+1],this.lastMove=()=>this.line[this.moveIndex],this.isOver=()=>this.moveIndex>=this.line.length-1,this.line=e.line.split(" "),this.pov=O(Ot(e.fen).unwrap().turn),this.startAt=Bt()}}class be{constructor(t,e=0){this.config=t,this.start=()=>{this.startAt||(this.startAt=Bt())},this.started=()=>!!this.startAt,this.millis=()=>this.startAt?Math.max(0,this.startAt+this.initialMillis-Bt()):this.initialMillis,this.addSeconds=t=>{this.initialMillis+=1e3*t},this.flag=()=>!this.millis(),this.initialMillis=1e3*t.clock.initial-(e||0)}}class we{constructor(t,e){var n;this.ground=b(!1),this.flipped=!1,this.end=()=>{this.run.history.reverse(),this.run.endAt=Bt(),this.ground(!1),this.redraw(),jt.end(),_(this.runStats(),this.data.notAnExploit).then((t=>{this.vm.response=t,this.redraw()})),this.redrawSlow()},this.endNow=()=>{this.pushToHistory(!1),this.end()},this.userMove=(t,e)=>{this.promotion.start(t,e,this.playUserMove)||this.playUserMove(t,e)},this.playUserMove=(t,e,n)=>{const o=Bt(),r=this.run.current;if(r.startAt+E.minFirstMoveTime>o)console.log("reverted!");else{this.run.clock.start(),this.run.moves++,this.promotion.cancel();const i=`${t}${e}${n?"knight"==n?"n":n[0]:""}`,s=r.position(),a=K(i);let c=s.board.occupied.has(a.to);s.play(a);if(s.isCheckmate()||i==r.expectedMove()){r.moveIndex++,this.run.combo.inc(),this.run.modifier.moveAt=o;const t=this.run.combo.bonus();t&&(this.run.modifier.bonus=t,this.run.clock.addSeconds(t.seconds)),r.isOver()?(this.pushToHistory(!0),this.incPuzzle()||this.end()):(r.moveIndex++,c=c||s.board.occupied.has(K(r.line[r.moveIndex]).to)),jt.move(c)}else jt.wrong(),this.pushToHistory(!1),this.run.errors++,this.run.combo.reset(),this.run.clock.addSeconds(-E.clock.malus),this.run.modifier.malus={seconds:E.clock.malus,at:Bt()},this.run.clock.flag()?this.end():this.incPuzzle()||this.end();this.redraw(),this.redrawQuick(),this.redrawSlow()}this.withGround((t=>t.set(fe(this.run,!this.run.endAt,this.flipped)))),lichess.pubsub.emit("ply",this.run.moves)},this.redrawQuick=()=>setTimeout(this.redraw,100),this.redrawSlow=()=>setTimeout(this.redraw,1e3),this.pushToHistory=t=>this.run.history.push({puzzle:this.run.current.puzzle,win:t,millis:this.run.history.length?Bt()-this.run.current.startAt:0}),this.incPuzzle=()=>{const t=this.run.current.index;return t<this.data.puzzles.length-1&&(this.run.current=new ge(t+1,this.data.puzzles[t+1]),!0)},this.withGround=t=>{const e=this.ground();return e&&t(e)},this.countWins=()=>this.run.history.reduce(((t,e)=>t+(e.win?1:0)),0),this.runStats=()=>({puzzles:this.run.history.length,score:this.countWins(),moves:this.run.moves,errors:this.run.errors,combo:this.run.combo.best,time:(this.run.endAt-this.run.clock.startAt)/1e3,highest:this.run.history.reduce(((t,e)=>e.win&&e.puzzle.rating>t?e.puzzle.rating:t),0),signed:this.vm.signed()}),this.toggleFilterSlow=()=>{this.vm.filterSlow=!this.vm.filterSlow,this.redraw()},this.toggleFilterFailed=()=>{this.vm.filterFailed=!this.vm.filterFailed,this.redraw()},this.flip=()=>{this.flipped=!this.flipped,this.withGround((t=>t.toggleOrientation())),this.redraw()},this.checkDupTab=()=>{const t=lichess.storage.make("storm.tab");t.fire(this.data.puzzles[0].id),t.listen((t=>{this.run.clock.startAt||t.value!=this.data.puzzles[0].id||(this.vm.dupTab=!0,this.redraw())}))},this.hotkeys=()=>window.Mousetrap.bind("space",(()=>location.reload())).bind("return",this.end).bind("f",this.flip),this.data=t.data,this.pref=t.pref,this.redraw=()=>e(this.data),this.trans=lichess.trans(t.i18n),this.run={pov:(n=this.data.puzzles[0],O(Ot(n.fen).unwrap().turn)),moves:0,errors:0,current:new ge(0,this.data.puzzles[0]),clock:new be(E),history:[],combo:new ve(E),modifier:{moveAt:0}},this.vm={signed:b(void 0),lateStart:!1,filterFailed:!1,filterSlow:!1},this.promotion=de(this.withGround,(()=>fe(this.run,!this.run.endAt,this.flipped)),this.redraw),this.checkDupTab(),setTimeout(this.hotkeys,1e3),this.data.key&&setTimeout((()=>pe(this.data.key).then(this.vm.signed)),4e4),setTimeout((()=>{this.run.clock.startAt||(this.vm.lateStart=!0,this.redraw())}),E.timeToStart+1e3)}}function ke(t,e){return Math.abs(t-e)}const ye=(t,e,n,o)=>{const r=ke(t,n),i=ke(e,o);return 1===r&&2===i||2===r&&1===i},Se=(t,e,n,o)=>ke(t,n)===ke(e,o),Ce=(t,e,n,o)=>t===n||e===o,_e=(t,e,n,o)=>Se(t,e,n,o)||Ce(t,e,n,o);function Ee(t,e,n){const o=t.get(e);if(!o)return[];const r=Vt(e),i=o.role,s="pawn"===i?(a=o.color,(t,e,n,o)=>ke(t,n)<2&&("white"===a?o===e+1||e<=1&&o===e+2&&t===n:o===e-1||e>=6&&o===e-2&&t===n)):"knight"===i?ye:"bishop"===i?Se:"rook"===i?Ce:"queen"===i?_e:function(t,e,n){return(o,r,i,s)=>ke(o,i)<2&&ke(r,s)<2||n&&r===s&&r===("white"===t?0:7)&&(4===o&&(2===i&&e.includes(0)||6===i&&e.includes(7))||e.includes(i))}(o.color,function(t,e){const n="white"===e?"1":"8",o=[];for(const[r,i]of t)r[1]===n&&i.color===e&&"rook"===i.role&&o.push(Vt(r)[0]);return o}(t,o.color),n);var a;return Yt.filter((t=>(r[0]!==t[0]||r[1]!==t[1])&&s(r[0],r[1],t[0],t[1]))).map(Qt)}function ze(t,...e){t&&setTimeout((()=>t(...e)),1)}function Me(t){t.premovable.current&&(t.premovable.current=void 0,ze(t.premovable.events.unset))}function xe(t){const e=t.predroppable;e.current&&(e.current=void 0,ze(e.events.unset))}function Ae(t,e,n){const o=t.pieces.get(e),r=t.pieces.get(n);if(e===n||!o)return!1;const i=r&&r.color!==o.color?r:void 0;return n===t.selected&&Fe(t),ze(t.events.move,e,n,i),function(t,e,n){if(!t.autoCastle)return!1;const o=t.pieces.get(e);if(!o||"king"!==o.role)return!1;const r=Vt(e),i=Vt(n);if(0!==r[1]&&7!==r[1]||r[1]!==i[1])return!1;4!==r[0]||t.pieces.has(n)||(6===i[0]?n=Qt([7,i[1]]):2===i[0]&&(n=Qt([0,i[1]])));const s=t.pieces.get(n);return!(!s||s.color!==o.color||"rook"!==s.role||(t.pieces.delete(e),t.pieces.delete(n),r[0]<i[0]?(t.pieces.set(Qt([6,i[1]]),o),t.pieces.set(Qt([5,i[1]]),s)):(t.pieces.set(Qt([2,i[1]]),o),t.pieces.set(Qt([3,i[1]]),s)),0))}(t,e,n)||(t.pieces.set(n,o),t.pieces.delete(e)),t.lastMove=[e,n],t.check=void 0,ze(t.events.change),i||!0}function qe(t,e,n,o){if(t.pieces.has(n)){if(!o)return!1;t.pieces.delete(n)}return ze(t.events.dropNewPiece,e,n),t.pieces.set(n,e),t.lastMove=[n],t.check=void 0,ze(t.events.change),t.movable.dests=void 0,t.turnColor=Jt(t.turnColor),!0}function Te(t,e,n){const o=Ae(t,e,n);return o&&(t.movable.dests=void 0,t.turnColor=Jt(t.turnColor),t.animation.current=void 0),o}function Pe(t,e,n){if(De(t,e,n)){const o=Te(t,e,n);if(o){const r=t.hold.stop();Fe(t);const i={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:r};return!0!==o&&(i.captured=o),ze(t.movable.events.after,e,n,i),!0}}else if(function(t,e,n){return e!==n&&Le(t,e)&&Ee(t.pieces,e,t.premovable.castle).includes(n)}(t,e,n))return function(t,e,n,o){xe(t),t.premovable.current=[e,n],ze(t.premovable.events.set,e,n,o)}(t,e,n,{ctrlKey:t.stats.ctrlKey}),Fe(t),!0;return Fe(t),!1}function Oe(t,e,n,o){const r=t.pieces.get(e);r&&(function(t,e,n){const o=t.pieces.get(e);return!(!o||e!==n&&t.pieces.has(n)||"both"!==t.movable.color&&(t.movable.color!==o.color||t.turnColor!==o.color))}(t,e,n)||o)?(t.pieces.delete(e),qe(t,r,n,o),ze(t.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&function(t,e,n){const o=t.pieces.get(e),r=t.pieces.get(n);return!!o&&(!r||r.color!==t.movable.color)&&t.predroppable.enabled&&("pawn"!==o.role||"1"!==n[1]&&"8"!==n[1])&&t.movable.color===o.color&&t.turnColor!==o.color}(t,e,n)?function(t,e,n){Me(t),t.predroppable.current={role:e,key:n},ze(t.predroppable.events.set,e,n)}(t,r.role,n):(Me(t),xe(t)),t.pieces.delete(e),Fe(t)}function Re(t,e,n){if(ze(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled)return Fe(t),void t.hold.cancel();if((t.selectable.enabled||n)&&t.selected!==e&&Pe(t,t.selected,e))return void(t.stats.dragged=!1)}(Ie(t,e)||Le(t,e))&&(Ne(t,e),t.hold.start())}function Ne(t,e){t.selected=e,Le(t,e)?t.premovable.dests=Ee(t.pieces,e,t.premovable.castle):t.premovable.dests=void 0}function Fe(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function Ie(t,e){const n=t.pieces.get(e);return!!n&&("both"===t.movable.color||t.movable.color===n.color&&t.turnColor===n.color)}function De(t,e,n){var o,r;return e!==n&&Ie(t,e)&&(t.movable.free||!!(null===(r=null===(o=t.movable.dests)||void 0===o?void 0:o.get(e))||void 0===r?void 0:r.includes(n)))}function Le(t,e){const n=t.pieces.get(e);return!!n&&t.premovable.enabled&&t.movable.color===n.color&&t.turnColor!==n.color}function Ke(t){const e=t.premovable.current;if(!e)return!1;const n=e[0],o=e[1];let r=!1;if(De(t,n,o)){const e=Te(t,n,o);if(e){const i={premove:!0};!0!==e&&(i.captured=e),ze(t.movable.events.after,n,o,i),r=!0}}return Me(t),r}function Be(t){Me(t),xe(t),Fe(t)}function $e(t){t.movable.color=t.movable.dests=t.animation.current=void 0,Be(t)}function je(t,e,n){let o=Math.floor(8*(t[0]-n.left)/n.width);e||(o=7-o);let r=7-Math.floor(8*(t[1]-n.top)/n.height);return e||(r=7-r),o>=0&&o<8&&r>=0&&r<8?Qt([o,r]):void 0}function He(t){return"white"===t.orientation}const We="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Xe={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Ue={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Ge(t){"start"===t&&(t=We);const e=new Map;let n=7,o=0;for(const r of t)switch(r){case" ":return e;case"/":if(--n,n<0)return e;o=0;break;case"~":{const t=e.get(Qt([o,n]));t&&(t.promoted=!0);break}default:{const t=r.charCodeAt(0);if(t<57)o+=t-48;else{const t=r.toLowerCase();e.set(Qt([o,n]),{role:Xe[t],color:r===t?"black":"white"}),++o}}}return e}function Qe(t,e){var n,o;if((null===(n=e.movable)||void 0===n?void 0:n.dests)&&(t.movable.dests=void 0),(null===(o=e.drawable)||void 0===o?void 0:o.autoShapes)&&(t.drawable.autoShapes=[]),Ve(t,e),e.fen&&(t.pieces=Ge(e.fen),t.drawable.shapes=[]),"check"in e&&function(t,e){if(t.check=void 0,!0===e&&(e=t.turnColor),e)for(const[n,o]of t.pieces)"king"===o.role&&o.color===e&&(t.check=n)}(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&Ne(t,t.selected),(!t.animation.duration||t.animation.duration<100)&&(t.animation.enabled=!1),!t.movable.rookCastle&&t.movable.dests){const e="white"===t.movable.color?"1":"8",n="e"+e,o=t.movable.dests.get(n),r=t.pieces.get(n);if(!o||!r||"king"!==r.role)return;t.movable.dests.set(n,o.filter((t=>!(t==="a"+e&&o.includes("c"+e)||t==="h"+e&&o.includes("g"+e)))))}}function Ve(t,e){for(const n in e)Ye(t[n])&&Ye(e[n])?Ve(t[n],e[n]):t[n]=e[n]}function Ye(t){return"object"==typeof t}function Ze(t,e){return e.animation.enabled?function(t,e){const n=new Map(e.pieces),o=t(e),r=function(t,e){const n=new Map,o=[],r=new Map,i=[],s=[],a=new Map;let c,l,u;for(const[e,n]of t)a.set(e,tn(e,n));for(const t of Gt)c=e.pieces.get(t),l=a.get(t),c?l?ee(c,l.piece)||(i.push(l),s.push(tn(t,c))):s.push(tn(t,c)):l&&i.push(l);for(const t of s)l=en(t,i.filter((e=>ee(t.piece,e.piece)))),l&&(u=[l.pos[0]-t.pos[0],l.pos[1]-t.pos[1]],n.set(t.key,u.concat(u)),o.push(l.key));for(const t of i)o.includes(t.key)||r.set(t.key,t.piece);return{anims:n,fadings:r}}(n,e);if(r.anims.size||r.fadings.size){const t=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:r},t||nn(e,performance.now())}else e.dom.redraw();return o}(t,e):Je(t,e)}function Je(t,e){const n=t(e);return e.dom.redraw(),n}function tn(t,e){return{key:t,pos:Vt(t),piece:e}}function en(t,e){return e.sort(((e,n)=>te(t.pos,e.pos)-te(t.pos,n.pos)))[0]}function nn(t,e){const n=t.animation.current;if(void 0===n)return void(t.dom.destroyed||t.dom.redrawNow());const o=1-(e-n.start)*n.frequency;if(o<=0)t.animation.current=void 0,t.dom.redrawNow();else{const e=function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}(o);for(const t of n.plan.anims.values())t[2]=t[0]*e,t[3]=t[1]*e;t.dom.redrawNow(!0),requestAnimationFrame(((e=performance.now())=>nn(t,e)))}}const on=["green","red","blue","yellow"];function rn(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?Fe(t):Be(t);const n=ce(e),o=je(n,He(t),t.dom.bounds());o&&(t.drawable.current={orig:o,pos:n,brush:un(e),snapToValidMove:t.drawable.defaultSnapToValidMove},sn(t))}function sn(t){requestAnimationFrame((()=>{const e=t.drawable.current;if(e){const n=je(e.pos,He(t),t.dom.bounds());n||(e.snapToValidMove=!1);const o=e.snapToValidMove?function(t,e,n,o){const r=Vt(t),i=Yt.filter((t=>_e(r[0],r[1],t[0],t[1])||ye(r[0],r[1],t[0],t[1]))),s=i.map((t=>he(Qt(t),n,o))).map((t=>te(e,t))),[,a]=s.reduce(((t,e,n)=>t[0]<e?t:[e,n]),[s[0],0]);return Qt(i[a])}(e.orig,e.pos,He(t),t.dom.bounds()):n;o!==e.mouseSq&&(e.mouseSq=o,e.dest=o!==e.orig?o:void 0,t.dom.redrawNow()),sn(t)}}))}function an(t,e){t.drawable.current&&(t.drawable.current.pos=ce(e))}function cn(t){const e=t.drawable.current;e&&(e.mouseSq&&function(t,e){const n=t=>t.orig===e.orig&&t.dest===e.dest,o=t.shapes.find(n);o&&(t.shapes=t.shapes.filter((t=>!n(t))));o&&o.brush===e.brush||t.shapes.push(e);hn(t)}(t.drawable,e),ln(t))}function ln(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function un(t){var e;const n=(t.shiftKey||t.ctrlKey)&&le(t),o=t.altKey||t.metaKey||(null===(e=t.getModifierState)||void 0===e?void 0:e.call(t,"AltGraph"));return on[(n?1:0)+(o?2:0)]}function hn(t){t.onChange&&t.onChange(t.shapes)}function dn(t,e){if(!e.isTrusted||void 0!==e.button&&0!==e.button)return;if(e.touches&&e.touches.length>1)return;const n=t.dom.bounds(),o=ce(e),r=je(o,He(t),n);if(!r)return;const i=t.pieces.get(r),s=t.selected;var a;s||!t.drawable.enabled||!t.drawable.eraseOnClick&&i&&i.color===t.turnColor||(a=t).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),hn(a.drawable)),!1===e.cancelable||e.touches&&t.movable.color&&!i&&!s&&!function(t,e){const n=He(t),o=t.dom.bounds(),r=Math.pow(o.width/8,2);for(const i in t.pieces){const t=he(i,n,o);if(te(t,e)<=r)return!0}return!1}(t,o)||e.preventDefault();const c=!!t.premovable.current,l=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&De(t,t.selected,r)?Ze((t=>Re(t,r)),t):Re(t,r);const u=t.selected===r,h=bn(t,r);if(i&&h&&u&&function(t,e){const n=t.pieces.get(e);return!!n&&t.draggable.enabled&&("both"===t.movable.color||t.movable.color===n.color&&(t.turnColor===n.color||t.premovable.enabled))}(t,r)){t.draggable.current={orig:r,piece:i,origPos:o,pos:o,started:t.draggable.autoDistance&&t.stats.dragged,element:h,previouslySelected:s,originTarget:e.target},h.cgDragging=!0,h.classList.add("dragging");const a=t.dom.elements.ghost;a&&(a.className=`ghost ${i.color} ${i.role}`,ie(a,oe(n)(Vt(r),He(t))),ae(a,!0)),pn(t)}else c&&Me(t),l&&xe(t);t.dom.redraw()}function pn(t){requestAnimationFrame((()=>{var e;const n=t.draggable.current;if(!n)return;(null===(e=t.animation.current)||void 0===e?void 0:e.plan.anims.has(n.orig))&&(t.animation.current=void 0);const o=t.pieces.get(n.orig);if(o&&ee(o,n.piece)){if(!n.started&&te(n.pos,n.origPos)>=Math.pow(t.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const t=n.element();if(!t)return;t.cgDragging=!0,t.classList.add("dragging"),n.element=t}const e=t.dom.bounds();ie(n.element,[n.pos[0]-e.left-e.width/16,n.pos[1]-e.top-e.height/16])}}else vn(t);pn(t)}))}function fn(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=ce(e))}function mn(t,e){const n=t.draggable.current;if(!n)return;if("touchend"===e.type&&!1!==e.cancelable&&e.preventDefault(),"touchend"===e.type&&n.originTarget!==e.target&&!n.newPiece)return void(t.draggable.current=void 0);Me(t),xe(t);const o=je(ce(e)||n.pos,He(t),t.dom.bounds());o&&n.started&&n.orig!==o?n.newPiece?Oe(t,n.orig,o,n.force):(t.stats.ctrlKey=e.ctrlKey,Pe(t,n.orig,o)&&(t.stats.dragged=!0)):n.newPiece?t.pieces.delete(n.orig):t.draggable.deleteOnDropOff&&!o&&(t.pieces.delete(n.orig),ze(t.events.change)),(n.orig!==n.previouslySelected||n.orig!==o&&o)&&t.selectable.enabled||Fe(t),gn(t),t.draggable.current=void 0,t.dom.redraw()}function vn(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,Fe(t),gn(t),t.dom.redraw())}function gn(t){const e=t.dom.elements;e.ghost&&ae(e.ghost,!1)}function bn(t,e){let n=t.dom.elements.board.firstChild;for(;n;){if(n.cgKey===e&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function wn(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function kn(t,e){function n(){!function(t){t.orientation=Jt(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}(t),e()}return{set(e){e.orientation&&e.orientation!==t.orientation&&n(),(e.fen?Ze:Je)((t=>Qe(t,e)),t)},state:t,getFen:()=>{return e=t.pieces,Ut.map((t=>Wt.map((n=>{const o=e.get(n+t);if(o){const t=Ue[o.role];return"white"===o.color?t.toUpperCase():t}return"1"})).join(""))).join("/").replace(/1{2,}/g,(t=>t.length.toString()));var e},toggleOrientation:n,setPieces(e){Ze((t=>function(t,e){for(const[n,o]of e)o?t.pieces.set(n,o):t.pieces.delete(n)}(t,e)),t)},selectSquare(e,n){e?Ze((t=>Re(t,e,n)),t):t.selected&&(Fe(t),t.dom.redraw())},move(e,n){Ze((t=>Ae(t,e,n)),t)},newPiece(e,n){Ze((t=>qe(t,e,n)),t)},playPremove(){if(t.premovable.current){if(Ze(Ke,t))return!0;t.dom.redraw()}return!1},playPredrop(e){if(t.predroppable.current){const n=function(t,e){const n=t.predroppable.current;let o=!1;if(!n)return!1;e(n)&&qe(t,{role:n.role,color:t.movable.color},n.key)&&(ze(t.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),o=!0);return xe(t),o}(t,e);return t.dom.redraw(),n}return!1},cancelPremove(){Je(Me,t)},cancelPredrop(){Je(xe,t)},cancelMove(){Je((t=>{Be(t),vn(t)}),t)},stop(){Je((t=>{$e(t),vn(t)}),t)},explode(e){!function(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout((()=>{wn(t,2),setTimeout((()=>wn(t,void 0)),120)}),120)}(t,e)},setAutoShapes(e){Je((t=>t.drawable.autoShapes=e),t)},setShapes(e){Je((t=>t.drawable.shapes=e),t)},getKeyAtDomPos:e=>je(e,He(t),t.dom.bounds()),redrawAll:e,dragNewPiece(e,n,o){!function(t,e,n,o){const r="a0";t.pieces.set(r,e),t.dom.redraw();const i=ce(n);t.draggable.current={orig:r,piece:e,origPos:i,pos:i,started:!0,element:()=>bn(t,r),originTarget:n.target,newPiece:!0,force:!!o},pn(t)}(t,e,n,o)},destroy(){$e(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function yn(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function Sn(t,e,n){const o=t.drawable,r=o.current,i=r&&r.mouseSq?r:void 0,s=new Map,a=t.dom.bounds();for(const t of o.shapes.concat(o.autoShapes).concat(i?[i]:[]))t.dest&&s.set(t.dest,(s.get(t.dest)||0)+1);const c=o.shapes.concat(o.autoShapes).map((t=>({shape:t,current:!1,hash:_n(t,s,!1,a)})));i&&c.push({shape:i,current:!0,hash:_n(i,s,!0,a)});const l=c.map((t=>t.hash)).join(";");if(l===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=l;const u=e.querySelector("defs"),h=e.querySelector("g"),d=n.querySelector("g");!function(t,e,n){const o=new Map;let r;for(const n of e)n.shape.dest&&(r=t.brushes[n.shape.brush],n.shape.modifiers&&(r=Tn(r,n.shape.modifiers)),o.set(r.key,r));const i=new Set;let s=n.firstChild;for(;s;)i.add(s.getAttribute("cgKey")),s=s.nextSibling;for(const[t,e]of o.entries())i.has(t)||n.appendChild(xn(e))}(o,c,u),Cn(t,c.filter((t=>!t.shape.customSvg)),o.brushes,s,h),Cn(t,c.filter((t=>t.shape.customSvg)),o.brushes,s,d)}function Cn(t,e,n,o,r){const i=t.dom.bounds(),s=new Map,a=[];for(const t of e)s.set(t.hash,!1);let c,l=r.firstChild;for(;l;)c=l.getAttribute("cgHash"),s.has(c)?s.set(c,!0):a.push(l),l=l.nextSibling;for(const t of a)r.removeChild(t);for(const a of e)s.get(a.hash)||r.appendChild(Mn(t,a,n,o,i))}function _n({orig:t,dest:e,brush:n,piece:o,modifiers:r,customSvg:i},s,a,c){return[c.width,c.height,a,t,e,n,e&&(s.get(e)||0)>1,o&&En(o),r&&(l=r,""+(l.lineWidth||"")),i&&zn(i)].filter((t=>t)).join(",");var l}function En(t){return[t.color,t.role,t.scale].filter((t=>t)).join(",")}function zn(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n)>>>0;return"custom-"+e.toString()}function Mn(t,{shape:e,current:n,hash:o},r,i,s){let a;if(e.customSvg){const n=qn(Vt(e.orig),t.orientation);a=function(t,e,n){const{width:o,height:r}=n,i=o/8,s=r/8,a=e[0]*i,c=(7-e[1])*s,l=An(yn("g"),{transform:`translate(${a},${c})`}),u=An(yn("svg"),{width:i,height:s,viewBox:"0 0 100 100"});return l.appendChild(u),u.innerHTML=t,l}(e.customSvg,n,s)}else if(e.piece)a=function(t,e,n,o){const r=Rn(e,o),i=o.width/8*(n.scale||1),s=n.color[0]+("knight"===n.role?"n":n.role[0]).toUpperCase();return An(yn("image"),{className:`${n.role} ${n.color}`,x:r[0]-i/2,y:r[1]-i/2,width:i,height:i,href:t+s+".svg"})}(t.drawable.pieces.baseUrl,qn(Vt(e.orig),t.orientation),e.piece,s);else{const o=qn(Vt(e.orig),t.orientation);if(e.dest){let c=r[e.brush];e.modifiers&&(c=Tn(c,e.modifiers)),a=function(t,e,n,o,r,i){const s=function(t,e){return(e?20:10)/512*t.width}(i,r&&!o),a=Rn(e,i),c=Rn(n,i),l=c[0]-a[0],u=c[1]-a[1],h=Math.atan2(u,l),d=Math.cos(h)*s,p=Math.sin(h)*s;return An(yn("line"),{stroke:t.color,"stroke-width":Pn(t,o,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+t.key+")",opacity:On(t,o),x1:a[0],y1:a[1],x2:c[0]-d,y2:c[1]-p})}(c,o,qn(Vt(e.dest),t.orientation),n,(i.get(e.dest)||0)>1,s)}else a=function(t,e,n,o){const r=Rn(e,o),i=function(t){const e=t.width/512;return[3*e,4*e]}(o),s=(o.width+o.height)/32;return An(yn("circle"),{stroke:t.color,"stroke-width":i[n?0:1],fill:"none",opacity:On(t,n),cx:r[0],cy:r[1],r:s-i[1]/2})}(r[e.brush],o,n,s)}return a.setAttribute("cgHash",o),a}function xn(t){const e=An(yn("marker"),{id:"arrowhead-"+t.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return e.appendChild(An(yn("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function An(t,e){for(const n in e)t.setAttribute(n,e[n]);return t}function qn(t,e){return"white"===e?t:[7-t[0],7-t[1]]}function Tn(t,e){return{color:t.color,opacity:Math.round(10*t.opacity)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter((t=>t)).join("")}}function Pn(t,e,n){return(t.lineWidth||10)*(e?.85:1)/512*n.width}function On(t,e){return(t.opacity||1)*(e?.9:1)}function Rn(t,e){return[(t[0]+.5)*e.width/8,(7.5-t[1])*e.height/8]}function Nn(t,e){const n=ue("coords",e);let o;for(const e of t)o=ue("coord"),o.textContent=e,n.appendChild(o);return n}function Fn(t,e){const n=t.dom.elements.board;if(!t.dom.relative&&t.resizable&&"ResizeObserver"in window){new window.ResizeObserver(e).observe(n)}if(t.viewOnly)return;const o=function(t){return e=>{t.draggable.current?vn(t):t.drawable.current?ln(t):e.shiftKey||le(e)?t.drawable.enabled&&rn(t,e):t.viewOnly||(t.dropmode.active?function(t,e){if(!t.dropmode.active)return;Me(t),xe(t);const n=t.dropmode.piece;if(n){t.pieces.set("a0",n);const o=ce(e),r=o&&je(o,He(t),t.dom.bounds());r&&Oe(t,"a0",r)}t.dom.redraw()}(t,e):dn(t,e))}}(t);n.addEventListener("touchstart",o,{passive:!1}),n.addEventListener("mousedown",o,{passive:!1}),(t.disableContextMenu||t.drawable.enabled)&&n.addEventListener("contextmenu",(t=>t.preventDefault()))}function In(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function Dn(t,e,n){return o=>{t.drawable.current?t.drawable.enabled&&n(t,o):t.viewOnly||e(t,o)}}function Ln(t){const e=He(t),n=t.dom.relative?re:oe(t.dom.bounds()),o=t.dom.relative?se:ie,r=t.dom.elements.board,i=t.pieces,s=t.animation.current,a=s?s.plan.anims:new Map,c=s?s.plan.fadings:new Map,l=t.draggable.current,u=function(t){var e;const n=new Map;if(t.lastMove&&t.highlight.lastMove)for(const e of t.lastMove)Wn(n,e,"last-move");t.check&&t.highlight.check&&Wn(n,t.check,"check");if(t.selected&&(Wn(n,t.selected,"selected"),t.movable.showDests)){const o=null===(e=t.movable.dests)||void 0===e?void 0:e.get(t.selected);if(o)for(const e of o)Wn(n,e,"move-dest"+(t.pieces.has(e)?" oc":""));const r=t.premovable.dests;if(r)for(const e of r)Wn(n,e,"premove-dest"+(t.pieces.has(e)?" oc":""))}const o=t.premovable.current;if(o)for(const t of o)Wn(n,t,"current-premove");else t.predroppable.current&&Wn(n,t.predroppable.current.key,"current-premove");const r=t.exploding;if(r)for(const t of r.keys)Wn(n,t,"exploding"+r.stage);return n}(t),h=new Set,d=new Set,p=new Map,f=new Map;let m,v,g,b,w,k,y,S,C,_;for(v=r.firstChild;v;){if(m=v.cgKey,Kn(v))if(g=i.get(m),w=a.get(m),k=c.get(m),b=v.cgPiece,!v.cgDragging||l&&l.orig===m||(v.classList.remove("dragging"),o(v,n(Vt(m),e)),v.cgDragging=!1),!k&&v.cgFading&&(v.cgFading=!1,v.classList.remove("fading")),g){if(w&&v.cgAnimating&&b===Hn(g)){const t=Vt(m);t[0]+=w[2],t[1]+=w[3],v.classList.add("anim"),o(v,n(t,e))}else v.cgAnimating&&(v.cgAnimating=!1,v.classList.remove("anim"),o(v,n(Vt(m),e)),t.addPieceZIndex&&(v.style.zIndex=jn(Vt(m),e)));b!==Hn(g)||k&&v.cgFading?k&&b===Hn(k)?(v.classList.add("fading"),v.cgFading=!0):Xn(p,b,v):h.add(m)}else Xn(p,b,v);else if(Bn(v)){const t=v.className;u.get(m)===t?d.add(m):Xn(f,t,v)}v=v.nextSibling}for(const[t,i]of u)if(!d.has(t)){C=f.get(i),_=C&&C.pop();const s=n(Vt(t),e);if(_)_.cgKey=t,o(_,s);else{const e=ue("square",i);e.cgKey=t,o(e,s),r.insertBefore(e,r.firstChild)}}for(const[s,c]of i)if(w=a.get(s),!h.has(s))if(y=p.get(Hn(c)),S=y&&y.pop(),S){S.cgKey=s,S.cgFading&&(S.classList.remove("fading"),S.cgFading=!1);const r=Vt(s);t.addPieceZIndex&&(S.style.zIndex=jn(r,e)),w&&(S.cgAnimating=!0,S.classList.add("anim"),r[0]+=w[2],r[1]+=w[3]),o(S,n(r,e))}else{const i=Hn(c),a=ue("piece",i),l=Vt(s);a.cgPiece=i,a.cgKey=s,w&&(a.cgAnimating=!0,l[0]+=w[2],l[1]+=w[3]),o(a,n(l,e)),t.addPieceZIndex&&(a.style.zIndex=jn(l,e)),r.appendChild(a)}for(const e of p.values())$n(t,e);for(const e of f.values())$n(t,e)}function Kn(t){return"PIECE"===t.tagName}function Bn(t){return"SQUARE"===t.tagName}function $n(t,e){for(const n of e)t.dom.elements.board.removeChild(n)}function jn(t,e){let n=2+8*t[1]+(7-t[0]);return e&&(n=67-n),n+""}function Hn(t){return`${t.color} ${t.role}`}function Wn(t,e,n){const o=t.get(e);o?t.set(e,`${o} ${n}`):t.set(e,n)}function Xn(t,e,n){const o=t.get(e);o?o.push(n):t.set(e,[n])}function Un(t,e){const n={pieces:Ge(We),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:Zt()};function o(){const e="dom"in n?n.dom.unbind:void 0,o=n.viewOnly&&!n.drawable.visible,r=function(t,e,n){t.innerHTML="",t.classList.add("cg-wrap");for(const n of Ht)t.classList.toggle("orientation-"+n,e.orientation===n);t.classList.toggle("manipulable",!e.viewOnly);const o=ue("cg-helper");t.appendChild(o);const r=ue("cg-container");o.appendChild(r);const i=ue("cg-board");let s,a,c;if(r.appendChild(i),e.drawable.visible&&!n&&(s=An(yn("svg"),{class:"cg-shapes"}),s.appendChild(yn("defs")),s.appendChild(yn("g")),a=An(yn("svg"),{class:"cg-custom-svgs"}),a.appendChild(yn("g")),r.appendChild(s),r.appendChild(a)),e.coordinates){const t="black"===e.orientation?" black":"";r.appendChild(Nn(Xt,"ranks"+t)),r.appendChild(Nn(Wt,"files"+t))}return e.draggable.showGhost&&!n&&(c=ue("piece","ghost"),ae(c,!1),r.appendChild(c)),{board:i,container:r,ghost:c,svg:s,customSvg:a}}(t,n,o),i=function(t){let e;const n=()=>(void 0===e&&(e=t()),e);return n.clear=()=>{e=void 0},n}((()=>r.board.getBoundingClientRect())),s=t=>{Ln(c),!t&&r.svg&&Sn(c,r.svg,r.customSvg)},a=()=>{i.clear(),function(t){if(t.dom.relative)return;const e=He(t),n=oe(t.dom.bounds());let o=t.dom.elements.board.firstChild;for(;o;)(Kn(o)&&!o.cgAnimating||Bn(o))&&ie(o,n(Vt(o.cgKey),e)),o=o.nextSibling}(c),r.svg&&Sn(c,r.svg,r.customSvg)},c=n;return c.dom={elements:r,bounds:i,redraw:Gn(s),redrawNow:s,unbind:e,relative:o},c.drawable.prevSvgHash="",s(!1),Fn(c,a),e||(c.dom.unbind=function(t,e){const n=[];if(t.dom.relative||!t.resizable||"ResizeObserver"in window||n.push(In(document.body,"chessground.resize",e)),!t.viewOnly){const e=Dn(t,fn,an),o=Dn(t,mn,cn);for(const t of["touchmove","mousemove"])n.push(In(document,t,e));for(const t of["touchend","mouseup"])n.push(In(document,t,o));const r=()=>t.dom.bounds.clear();n.push(In(document,"scroll",r,{capture:!0,passive:!0})),n.push(In(window,"resize",r,{passive:!0}))}return()=>n.forEach((t=>t()))}(c,a)),c.events.insert&&c.events.insert(r),c}return Qe(n,e||{}),kn(o(),o)}function Gn(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame((()=>{t(),e=!1})))}}let Qn,Vn;function Yn(t,e,n){return d("div.puz-clock__time",{hook:{insert(o){const r=o.elm;r.innerText=Zn(t.clock.millis()),Qn=setInterval((()=>function(t,e,n,o){if(!t.clock.startAt)return;const r=t.modifier,i=Bt(),s=t.clock.millis(),a=o?Jn(i,r.bonus)-Jn(i,r.malus):0,c=Zn(s-a);c!=Vn&&(n.innerText=c);Vn=c,s<1&&!t.endAt&&e()}(t,e,r,n)),100)},destroy(){Qn&&clearInterval(Qn)}}})}const Zn=t=>{const e=new Date(Math.max(0,1e3*Math.ceil(t/1e3))),n=e.getUTCMinutes(),o=e.getUTCSeconds();return n+":"+(((r=o)<10?"0":"")+r);var r};function Jn(t,e){const n=e&&(t-e.at<1e3?t-e.at:void 0);return g(n)?1e3*e.seconds*(1-n/1e3):0}const to=(t,e,n,o)=>{var r,i,s;window.Chessground?(r=t,i="chessground",s=window.Chessground(t,{orientation:n,coordinates:!1,viewOnly:!t.getAttribute("data-playable"),resizable:!1,fen:e,lastMove:o&&("@"===o[1]?[o.slice(2)]:[o[0]+o[1],o[2]+o[3]]),drawable:{enabled:!1,visible:!1}}),r[(t=>`lichess-${t}`)(i)]=s):setTimeout((()=>(t=>{const[e,n,o]=t.getAttribute("data-state").split(",");to(t,e,n,o)})(t)),500)};let eo=!1;const no=(t,e,n,o)=>{let r;const i=(n,o,i)=>{const s=(t=>(!1===eo&&(eo=window.Intl&&Intl.NumberFormat?new Intl.NumberFormat:null),null===eo?""+t:eo.format(t)))(Math.round((n*(e-1-i)+o*(i+1))/e));s!==r&&(t.textContent=s,r=s)};let s=[];return(r,a)=>{if(!t||!r&&0!==r)return;a&&(e=Math.abs(a)),s.forEach(clearTimeout),s=[];const c=0===o?0:o||r;o=r;const l=Math.abs(n/e);for(let t=0;t<e;t++)s.push(setTimeout(i.bind(null,c,r,t),Math.round(t*l)))}},oo={day:"newDailyHighscore",week:"newWeeklyHighscore",month:"newMonthlyHighscore",allTime:"newAllTimeHighscore"},ro=t=>{var e;const n=t.runStats(),o=null===(e=t.vm.response)||void 0===e?void 0:e.newHigh,r=100*(n.moves-n.errors)/n.moves,i=t.trans.noarg,s=Math.min(n.score,50);return[...o?[d("div.storm--end__high.storm--end__high-daily.bar-glider",d("div.storm--end__high__content",[d("div.storm--end__high__text",[d("strong",i(oo[o.key])),o.prev?d("span",t.trans("previousHighscoreWasX",o.prev)):null])]))]:[],d("div.storm--end__score",[d("span.storm--end__score__number",{hook:Kt((t=>no(t,s,Math.round(50*s),0)(n.score)))},"0"),d("p",i("puzzlesSolved"))]),d("div.storm--end__stats.box.box-pad",[d("table.slist",[d("tbody",[d("tr",[d("th",i("moves")),d("td",d("number",n.moves))]),d("tr",[d("th",i("accuracy")),d("td",[d("number",Number(r).toFixed(1)),"%"])]),d("tr",[d("th",i("combo")),d("td",d("number",t.run.combo.best))]),d("tr",[d("th",i("time")),d("td",[d("number",Math.round(n.time)),"s"])]),d("tr",[d("th",i("timePerMove")),d("td",[d("number",Number(n.time/n.moves).toFixed(2)),"s"])]),d("tr",[d("th",i("highestSolved")),d("td",d("number",n.highest))])])])]),d("a.storm-play-again.button",{attrs:t.run.endAt<Bt()-900?{href:"/storm"}:{}},i("playAgain"))]},io=t=>{const e=so(t);return d("div.storm--end__history.box.box-pad",[d("div.box__top",[d("h2",t.trans("puzzlesPlayed")),d("div.box__top__actions",[d("button.storm--end__history__filter.button",{class:{active:t.vm.filterFailed,"button-empty":!t.vm.filterFailed},hook:Kt((e=>e.addEventListener("click",t.toggleFilterFailed)))},"Failed puzzles"),d("button.storm--end__history__filter.button",{class:{active:t.vm.filterSlow,"button-empty":!t.vm.filterSlow},hook:Kt((e=>e.addEventListener("click",t.toggleFilterSlow)))},"Slow puzzles")])]),d("div.storm--end__history__rounds",t.run.history.filter((n=>(!n.win||!t.vm.filterFailed)&&(!e||e.has(n.puzzle.id)))).map((t=>d("div.storm--end__history__round",{key:t.puzzle.id},[d("a.storm--end__history__round__puzzle.mini-board.cg-wrap.is2d",{attrs:{href:`/training/${t.puzzle.id}`,target:"_blank"},hook:Kt((e=>{const n=Et.fromSetup(Ot(t.puzzle.fen).unwrap()).unwrap(),o=t.puzzle.line.split(" ")[0];n.play(K(o)),to(e,Dt(n.toSetup()),n.turn,o)}))}),d("span.storm--end__history__round__meta",[d("span.storm--end__history__round__result",[d(t.win?"good":"bad",Math.round(t.millis/1e3)+"s"),d("rating",t.puzzle.rating)]),d("span.storm--end__history__round__id","#"+t.puzzle.id)])]))))])},so=t=>{if(!t.vm.filterSlow||!t.run.history.length)return;const e=1.5*(t.run.history.reduce(((t,e)=>t+e.millis),0)/t.run.history.length);return new Set(t.run.history.filter((t=>t.millis>e)).map((t=>t.puzzle.id)))};function ao(t,e,n,o){if(0===e)return;const r=document.createElement("cg-resize");t.container.appendChild(r);const i=t=>{t.preventDefault();const e="touchstart"===t.type?"touchmove":"mousemove",n="touchstart"===t.type?"touchend":"mouseup",o=co(t),r=parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"));let i=r;const s=function(t,e,n=!1){let o,r=0;return function(...i){const s=this;o&&clearTimeout(o),o=void 0;const a=performance.now()-r;r=performance.now(),n&&a>e?t.apply(s,i):o=setTimeout((()=>{o=void 0,t.apply(s,i)}),e)}}((()=>((t,e={})=>S(t,e).then((t=>{if(t.ok)return t.text();throw t.statusText})))(`/pref/zoom?v=${100+i}`,{method:"post"})),700),a=t=>{const e=co(t),n=e[0]-o[0]+e[1]-o[1];i=Math.round(Math.min(100,Math.max(0,r+n/10))),document.body.setAttribute("style","--zoom:"+i),window.dispatchEvent(new Event("resize")),s()};document.body.classList.add("resizing"),document.addEventListener(e,a),document.addEventListener(n,(()=>{document.removeEventListener(e,a),document.body.classList.remove("resizing")}),{once:!0})};if(r.addEventListener("touchstart",i,{passive:!1}),r.addEventListener("mousedown",i,{passive:!1}),1===e){const t=t=>r.classList.toggle("none",o?!o(t):t>=2);t(n),lichess.pubsub.on("ply",t)}}function co(t){var e;return t.clientX||0===t.clientX?[t.clientX,t.clientY]:(null===(e=t.targetTouches)||void 0===e?void 0:e[0])?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:void 0}function lo(t,e,n){return{fen:t.fen,orientation:t.orientation,turnColor:t.turnColor,check:t.check,lastMove:t.lastMove,coordinates:0!==e.coords,addPieceZIndex:e.is3d,movable:{free:!1,color:t.movable.color,dests:t.movable.dests,showDests:e.destination,rookCastle:e.rookCastle},draggable:{enabled:e.moveEvent>0,showGhost:e.highlight},selectable:{enabled:1!==e.moveEvent},events:{move:n,insert(t){ao(t,1,0,(t=>0==t)),1==e.coords&&(()=>{const t={blue:"#DEE3E6 #788a94",blue2:"#97b2c7 #546f82",blue3:"#d9e0e6 #315991",canvas:"#d7daeb #547388",wood:"#d8a45b #9b4d0f",wood2:"#a38b5d #6c5017",wood3:"#d0ceca #755839",wood4:"#caaf7d #7b5330",maple:"#e8ceab #bc7944",maple2:"#E2C89F #996633",leather:"#d1d1c9 #c28e16",green:"#FFFFDD #6d8753",brown:"#F0D9B5 #946f51",pink:"#E8E9B7 #ED7272",marble:"#93ab91 #4f644e","blue-marble":"#EAE6DD #7C7F87","green-plastic":"#f2f9bb #59935d",grey:"#b8b8b8 #7d7d7d",metal:"#c9c9c9 #727272",olive:"#b8b19f #6d6655",newspaper:"#fff #8d8d8d",purple:"#9f90b0 #7d4a8d","purple-diag":"#E5DAF0 #957AB0",ic:"#ececec #c1c18e",horsey:"#F0D9B5 #946f51"};for(const e of document.body.className.split(" "))if(e in t){const n=document.documentElement.style,o=t[e].split(" ");n.setProperty("--cg-coord-color-white",o[0]),n.setProperty("--cg-coord-color-black",o[1]),n.setProperty("--cg-coord-shadow","none")}})()}},premovable:{enabled:!1},drawable:{enabled:!0,defaultSnapToValidMove:"0"!=(lichess.storage.get("arrow.snap")||1)},highlight:{lastMove:e.highlight,check:e.highlight},animation:{enabled:!1},disableContextMenu:!0}}const uo=t=>{const e=Bt(),n=t.modifier.malus,o=t.modifier.bonus;return{"puz-mod-puzzle":t.current.startAt>e-90,"puz-mod-move":t.modifier.moveAt>e-90,"puz-mod-malus-slow":!!n&&n.at>e-950,"puz-mod-bonus-slow":!!o&&o.at>e-950}},ho=(t,e)=>n=>{const o=n.combo.level();return d("div.puz-combo",[d("div.puz-combo__counter",[d("span.puz-combo__counter__value",n.combo.current),d("span.puz-combo__counter__combo","COMBO")]),d("div.puz-combo__bars",[d("div.puz-combo__bar",[d("div.puz-combo__bar__in",{attrs:{style:`width:${n.combo.percent()}%`}}),d("div.puz-combo__bar__in-full")]),d("div.puz-combo__levels",[0,1,2,3].map((n=>d("div.puz-combo__level",{class:{active:n<o}},d("span",e(t.combo.levels[n+1][1]))))))])])};function po(t){return t.vm.dupTab?ko("This run was opened in another tab!"):t.vm.lateStart?ko("This run has expired!"):t.run.endAt?d("main.storm.storm--end",(t=>[...ro(t),io(t)])(t)):d("div.storm.storm-app.storm--play",{class:uo(t.run)},vo(t))}const fo=t=>d("div.cg-wrap",{hook:{insert:e=>t.ground(Un(e.elm,lo(fe(t.run,!t.run.endAt),t.pref,t.userMove)))}}),mo=t=>`${t}s`,vo=t=>{const e=t.run,n=e.modifier.malus,o=e.modifier.bonus,r=Bt();return[d("div.puz-board.main-board",[fo(t),t.promotion.view()]),d("div.puz-side",[e.clock.startAt?go(t):wo(t),d("div.puz-clock",[Yn(e,t.endNow,!0),n&&n.at>r-900?d("div.puz-clock__malus","-"+n.seconds):null,o&&o.at>r-900?d("div.puz-clock__bonus","+"+o.seconds):null,...e.clock.started()?[]:[d("span.puz-clock__pov",t.trans.noarg(me(e)))]]),d("div.puz-side__table",[bo(t),ho(E,mo)(e)])])]},go=t=>d("div.puz-side__top.puz-side__solved",[d("div.puz-side__solved__text",t.countWins())]),bo=t=>d("div.puz-side__control",[d("a.puz-side__control__flip.button",{class:{active:t.flipped,"button-empty":!t.flipped},attrs:{"data-icon":"B",title:t.trans.noarg("flipBoard")+" (Keyboard: f)"},hook:Kt((e=>e.addEventListener("click",t.flip)))}),d("a.puz-side__control__reload.button.button-empty",{attrs:{href:"/storm","data-icon":"q",title:t.trans("newRun")}}),d("a.puz-side__control__end.button.button-empty",{attrs:{"data-icon":"b",title:t.trans("endRun")},hook:Kt((e=>e.addEventListener("click",t.endNow)))})]),wo=t=>d("div.puz-side__top.puz-side__start",[d("div.puz-side__start__text",[d("strong","Puzzle Storm"),d("span",t.trans("moveToStart"))])]),ko=t=>d("div.storm.storm--reload.box.box-pad",[d("i",{attrs:{"data-icon":"~"}}),d("p",t),d("a.storm--dup__reload.button",{attrs:{href:"/storm"}},"Click to reload")]),yo=function(t,h){let d,p;const f={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},m=void 0!==h?h:e;for(d=0;d<u.length;++d)for(f[u[d]]=[],p=0;p<t.length;++p){const e=t[p][u[d]];void 0!==e&&f[u[d]].push(e)}function v(t){const e=t.id?"#"+t.id:"",o=t.className?"."+t.className.split(" ").join("."):"";return n(m.tagName(t).toLowerCase()+e+o,{},[],void 0,t)}function g(t,e){return function(){if(0==--e){const e=m.parentNode(t);m.removeChild(e,t)}}}function b(t,e){var n,c;let l,u=t.data;if(void 0!==u){const e=null===(n=u.hook)||void 0===n?void 0:n.init;s(e)&&(e(t),u=t.data)}const h=t.children,d=t.sel;if("!"===d)i(t.text)&&(t.text=""),t.elm=m.createComment(t.text);else if(void 0!==d){const n=d.indexOf("#"),i=d.indexOf(".",n),p=n>0?n:d.length,v=i>0?i:d.length,g=-1!==n||-1!==i?d.slice(0,Math.min(p,v)):d,w=t.elm=s(u)&&s(l=u.ns)?m.createElementNS(l,g,u):m.createElement(g,u);for(p<v&&w.setAttribute("id",d.slice(p+1,v)),i>0&&w.setAttribute("class",d.slice(v+1).replace(/\./g," ")),l=0;l<f.create.length;++l)f.create[l](a,t);if(o(h))for(l=0;l<h.length;++l){const t=h[l];null!=t&&m.appendChild(w,b(t,e))}else r(t.text)&&m.appendChild(w,m.createTextNode(t.text));const k=t.data.hook;s(k)&&(null===(c=k.create)||void 0===c||c.call(k,a,t),k.insert&&e.push(t))}else t.elm=m.createTextNode(t.text);return t.elm}function w(t,e,n,o,r,i){for(;o<=r;++o){const r=n[o];null!=r&&m.insertBefore(t,b(r,i),e)}}function k(t){var e,n;const o=t.data;if(void 0!==o){null===(n=null===(e=null==o?void 0:o.hook)||void 0===e?void 0:e.destroy)||void 0===n||n.call(e,t);for(let e=0;e<f.destroy.length;++e)f.destroy[e](t);if(void 0!==t.children)for(let e=0;e<t.children.length;++e){const n=t.children[e];null!=n&&"string"!=typeof n&&k(n)}}}function y(t,e,n,o){for(var r,i;n<=o;++n){let o,a;const c=e[n];if(null!=c)if(s(c.sel)){k(c),o=f.remove.length+1,a=g(c.elm,o);for(let t=0;t<f.remove.length;++t)f.remove[t](c,a);const t=null===(i=null===(r=null==c?void 0:c.data)||void 0===r?void 0:r.hook)||void 0===i?void 0:i.remove;s(t)?t(c,a):a()}else m.removeChild(t,c.elm)}}function S(t,e,n){var o,r,a,u,h;const d=null===(o=e.data)||void 0===o?void 0:o.hook;null===(r=null==d?void 0:d.prepatch)||void 0===r||r.call(d,t,e);const p=e.elm=t.elm,v=t.children,g=e.children;if(t!==e){if(void 0!==e.data){for(let n=0;n<f.update.length;++n)f.update[n](t,e);null===(u=null===(a=e.data.hook)||void 0===a?void 0:a.update)||void 0===u||u.call(a,t,e)}i(e.text)?s(v)&&s(g)?v!==g&&function(t,e,n,o){let r,s,a,u,h=0,d=0,p=e.length-1,f=e[0],v=e[p],g=n.length-1,k=n[0],C=n[g];for(;h<=p&&d<=g;)null==f?f=e[++h]:null==v?v=e[--p]:null==k?k=n[++d]:null==C?C=n[--g]:c(f,k)?(S(f,k,o),f=e[++h],k=n[++d]):c(v,C)?(S(v,C,o),v=e[--p],C=n[--g]):c(f,C)?(S(f,C,o),m.insertBefore(t,f.elm,m.nextSibling(v.elm)),f=e[++h],C=n[--g]):c(v,k)?(S(v,k,o),m.insertBefore(t,v.elm,f.elm),v=e[--p],k=n[++d]):(void 0===r&&(r=l(e,h,p)),s=r[k.key],i(s)?m.insertBefore(t,b(k,o),f.elm):(a=e[s],a.sel!==k.sel?m.insertBefore(t,b(k,o),f.elm):(S(a,k,o),e[s]=void 0,m.insertBefore(t,a.elm,f.elm))),k=n[++d]);(h<=p||d<=g)&&(h>p?(u=null==n[g+1]?null:n[g+1].elm,w(t,u,n,d,g,o)):y(t,e,h,p))}(p,v,g,n):s(g)?(s(t.text)&&m.setTextContent(p,""),w(p,null,g,0,g.length-1,n)):s(v)?y(p,v,0,v.length-1):s(t.text)&&m.setTextContent(p,""):t.text!==e.text&&(s(v)&&y(p,v,0,v.length-1),m.setTextContent(p,e.text)),null===(h=null==d?void 0:d.postpatch)||void 0===h||h.call(d,t,e)}}return function(t,e){let n,o,r;const i=[];for(n=0;n<f.pre.length;++n)f.pre[n]();for(function(t){return void 0!==t.sel}(t)||(t=v(t)),c(t,e)?S(t,e,i):(o=t.elm,r=m.parentNode(o),b(e,i),null!==r&&(m.insertBefore(r,e.elm,m.nextSibling(o)),y(r,[t],0,0))),n=0;n<i.length;++n)i[n].data.hook.insert(i[n]);for(n=0;n<f.post.length;++n)f.post[n]();return e}}([v,f]);return window.Chessground=Un,t.start=function(t){const e=document.querySelector(".storm-app");let n;const o=new we(t,(function(){n=yo(n,po(o))})),r=po(o);e.innerHTML="",n=yo(e,r),function(){if("ontouchstart"in window)return;let t,e;const n=n=>{t=n.pageX,e=n.pageY};let o={};$("#topnav.hover").each((function(){const r=$(this).removeClass("hover"),i=()=>r.toggleClass("hover"),s=()=>{Math.sqrt((o.pX-t)*(o.pX-t)+(o.pY-e)*(o.pY-e))<8?(r.off(o.event,n),delete o.timeoutId,o.isActive=!0,i()):(o.pX=t,o.pY=e,o.timeoutId=setTimeout(s,200))},a=function(t){o.timeoutId&&(o.timeoutId=clearTimeout(o.timeoutId));const e=o.event="mousemove";if("mouseover"==t.type){if(o.isActive||t.buttons)return;o.pX=t.pageX,o.pY=t.pageY,r.off(e,n).on(e,n),o.timeoutId=setTimeout(s,200)}else{if(!o.isActive)return;r.off(e,n),o={},i()}};r.on("mouseover",a).on("mouseleave",a)}))}(),$("script").remove()},Object.defineProperty(t,"__esModule",{value:!0}),t}({});
