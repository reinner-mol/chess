var LichessRacer=function(e){"use strict";const t={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,n){return document.createElementNS(e,t,n)},createTextNode:function(e){return document.createTextNode(e)},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,n){e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){e.appendChild(t)},parentNode:function(e){return e.parentNode},nextSibling:function(e){return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType}};function n(e,t,n,r,o){return{sel:e,data:t,children:n,text:r,elm:o,key:void 0===t?void 0:t.key}}const r=Array.isArray;function o(e){return"string"==typeof e||"number"==typeof e}function i(e){return void 0===e}function s(e){return void 0!==e}const a=n("",{},[],void 0,void 0);function c(e,t){var n,r;const o=e.key===t.key,i=(null===(n=e.data)||void 0===n?void 0:n.is)===(null===(r=t.data)||void 0===r?void 0:r.is);return e.sel===t.sel&&o&&i}function u(e,t,n){var r;const o={};for(let i=t;i<=n;++i){const t=null===(r=e[i])||void 0===r?void 0:r.key;void 0!==t&&(o[t]=i)}return o}const l=["create","update","remove","destroy","pre","post"];function h(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let e=0;e<t.length;++e){const n=t[e].data;void 0!==n&&h(n,t[e].children,t[e].sel)}}function d(e,t,i){let s,a,c,u={};if(void 0!==i?(null!==t&&(u=t),r(i)?s=i:o(i)?a=i:i&&i.sel&&(s=[i])):null!=t&&(r(t)?s=t:o(t)?a=t:t&&t.sel?s=[t]:u=t),void 0!==s)for(c=0;c<s.length;++c)o(s[c])&&(s[c]=n(void 0,void 0,void 0,s[c],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||h(u,s,e),n(e,u,s,a,void 0)}function p(e,t){let n;const r=t.elm;let o=e.data.attrs,i=t.data.attrs;if((o||i)&&o!==i){for(n in o=o||{},i=i||{},i){const e=i[n];o[n]!==e&&(!0===e?r.setAttribute(n,""):!1===e?r.removeAttribute(n):120!==n.charCodeAt(0)?r.setAttribute(n,e):58===n.charCodeAt(3)?r.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,e):58===n.charCodeAt(5)?r.setAttributeNS("http://www.w3.org/1999/xlink",n,e):r.setAttribute(n,e))}for(n in o)n in i||r.removeAttribute(n)}}const f={create:p,update:p};function m(e,t){let n,r;const o=t.elm;let i=e.data.class,s=t.data.class;if((i||s)&&i!==s){for(r in i=i||{},s=s||{},i)i[r]&&!Object.prototype.hasOwnProperty.call(s,r)&&o.classList.remove(r);for(r in s)n=s[r],n!==i[r]&&o.classList[n?"add":"remove"](r)}}const v={create:m,update:m};var g={clock:{initial:90,malus:0},combo:{levels:[[0,0],[5,1],[12,2],[20,3],[30,4]]},minFirstMoveTime:400};const b=["a","b","c","d","e","f","g","h"],w=["1","2","3","4","5","6","7","8"],k=["white","black"],y=["pawn","knight","bishop","rook","queen","king"],_=["a","h"];function S(e){return"role"in e}function C(e){return void 0!==e}function E(e){return"white"===e?"black":"white"}function M(e){return e>>3}function x(e){return 7&e}function q(e){switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}}function A(e){switch(e){case"P":case"p":return"pawn";case"N":case"n":return"knight";case"B":case"b":return"bishop";case"R":case"r":return"rook";case"Q":case"q":return"queen";case"K":case"k":return"king";default:return}}function P(e){if(2!==e.length)return;const t=e.charCodeAt(0)-"a".charCodeAt(0),n=e.charCodeAt(1)-"1".charCodeAt(0);return t<0||t>=8||n<0||n>=8?void 0:t+8*n}function z(e){return b[x(e)]+w[M(e)]}function R(e){if("@"===e[1]&&4===e.length){const t=A(e[0]),n=P(e.slice(2));if(t&&C(n))return{role:t,to:n}}else if(4===e.length||5===e.length){const t=P(e.slice(0,2)),n=P(e.slice(2,4));let r;if(5===e.length&&(r=A(e[4]),!r))return;if(C(t)&&C(n))return{from:t,to:n,promotion:r}}}function O(e,t){return"white"===e?"a"===t?2:6:"a"===t?58:62}function T(e){return e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24}function I(e){return(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16}function N(e){return I(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4)}class D{constructor(e,t){this.lo=e,this.hi=t,this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new D(0,1<<e-32):new D(1<<e,0)}static fromRank(e){return new D(255,0).shl64(8*e)}static fromFile(e){return new D(16843009<<e,16843009<<e)}static empty(){return new D(0,0)}static full(){return new D(4294967295,4294967295)}static corners(){return new D(129,2164260864)}static center(){return new D(402653184,24)}static backranks(){return new D(255,4278190080)}static backrank(e){return"white"===e?new D(255,0):new D(0,4278190080)}static lightSquares(){return new D(1437226410,1437226410)}static darkSquares(){return new D(2857740885,2857740885)}complement(){return new D(~this.lo,~this.hi)}xor(e){return new D(this.lo^e.lo,this.hi^e.hi)}union(e){return new D(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new D(this.lo&e.lo,this.hi&e.hi)}diff(e){return new D(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?D.empty():e>=32?new D(this.hi>>>e-32,0):e>0?new D(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?D.empty():e>=32?new D(0,this.lo<<e-32):e>0?new D(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new D(I(this.hi),I(this.lo))}rbit64(){return new D(N(this.hi),N(this.lo))}minus64(e){const t=this.lo-e.lo,n=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new D(t,this.hi-(e.hi+n))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return T(this.lo)+T(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return 0!=(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new D(this.lo,this.hi|1<<e-32):new D(this.lo|1<<e,this.hi)}without(e){return e>=32?new D(this.lo,this.hi&~(1<<e-32)):new D(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new D(this.lo,this.hi^1<<e-32):new D(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new D(this.lo&this.lo-1,this.hi):new D(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||0!=(this.lo&this.lo-1)||0!=(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}isSingleSquare(){return this.nonEmpty()&&!this.moreThanOne()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield t}}}function L(e,t){let n=D.empty();for(const r of t){const t=e+r;0<=t&&t<64&&Math.abs(x(e)-x(t))<=2&&(n=n.with(t))}return n}function B(e){const t=[];for(let n=0;n<64;n++)t[n]=e(n);return t}const K=B((e=>L(e,[-9,-8,-7,-1,1,7,8,9]))),F=B((e=>L(e,[-17,-15,-10,-6,6,10,15,17]))),j={white:B((e=>L(e,[7,9]))),black:B((e=>L(e,[-7,-9])))};function U(e){return K[e]}function G(e){return F[e]}function X(e,t){return j[e][t]}const H=B((e=>D.fromFile(x(e)).without(e))),W=B((e=>D.fromRank(M(e)).without(e))),Q=B((e=>{const t=new D(134480385,2151686160),n=8*(M(e)-x(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)})),V=B((e=>{const t=new D(270549120,16909320),n=8*(M(e)+x(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}));function Y(e,t,n){let r=n.intersect(t),o=r.bswap64();return r=r.minus64(e),o=o.minus64(e.bswap64()),r.xor(o.bswap64()).intersect(t)}function Z(e,t){const n=D.fromSquare(e);return Y(n,Q[e],t).xor(Y(n,V[e],t))}function J(e,t){return function(e,t){return Y(D.fromSquare(e),H[e],t)}(e,t).xor(function(e,t){const n=W[e];let r=t.intersect(n),o=r.rbit64();return r=r.minus64(D.fromSquare(e)),o=o.minus64(D.fromSquare(63-e)),r.xor(o.rbit64()).intersect(n)}(e,t))}function ee(e,t){return Z(e,t).xor(J(e,t))}function te(e,t){const n=D.fromSquare(t);return W[e].intersects(n)?W[e].with(e):V[e].intersects(n)?V[e].with(e):Q[e].intersects(n)?Q[e].with(e):H[e].intersects(n)?H[e].with(e):D.empty()}function ne(e,t){return te(e,t).intersect(D.full().shl64(e).xor(D.full().shl64(t))).withoutFirst()}class re{constructor(){}static default(){const e=new re;return e.reset(),e}static racingKings(){const e=new re;return e.occupied=new D(65535,0),e.promoted=D.empty(),e.white=new D(61680,0),e.black=new D(3855,0),e.pawn=D.empty(),e.knight=new D(6168,0),e.bishop=new D(9252,0),e.rook=new D(16962,0),e.queen=new D(129,0),e.king=new D(33024,0),e}static horde(){const e=new re;return e.occupied=new D(4294967295,4294901862),e.promoted=D.empty(),e.white=new D(4294967295,102),e.black=new D(0,4294901760),e.pawn=new D(4294967295,16711782),e.knight=new D(0,1107296256),e.bishop=new D(0,603979776),e.rook=new D(0,2164260864),e.queen=new D(0,134217728),e.king=new D(0,268435456),e}reset(){this.occupied=new D(65535,4294901760),this.promoted=D.empty(),this.white=new D(65535,0),this.black=new D(0,4294901760),this.pawn=new D(65280,16711680),this.knight=new D(66,1107296256),this.bishop=new D(36,603979776),this.rook=new D(129,2164260864),this.queen=new D(8,134217728),this.king=new D(16,268435456)}static empty(){const e=new re;return e.clear(),e}clear(){this.occupied=D.empty(),this.promoted=D.empty();for(const e of k)this[e]=D.empty();for(const e of y)this[e]=D.empty()}clone(){const e=new re;e.occupied=this.occupied,e.promoted=this.promoted;for(const t of k)e[t]=this[t];for(const t of y)e[t]=this[t];return e}equalsIgnorePromoted(e){return!!this.white.equals(e.white)&&y.every((t=>this[t].equals(e[t])))}equals(e){return this.equalsIgnorePromoted(e)&&this.promoted.equals(e.promoted)}getColor(e){return this.white.has(e)?"white":this.black.has(e)?"black":void 0}getRole(e){for(const t of y)if(this[t].has(e))return t}get(e){const t=this.getColor(e);if(!t)return;return{color:t,role:this.getRole(e),promoted:this.promoted.has(e)}}take(e){const t=this.get(e);return t&&(this.occupied=this.occupied.without(e),this[t.color]=this[t.color].without(e),this[t.role]=this[t.role].without(e),t.promoted&&(this.promoted=this.promoted.without(e))),t}set(e,t){const n=this.take(e);return this.occupied=this.occupied.with(e),this[t.color]=this[t.color].with(e),this[t.role]=this[t.role].with(e),t.promoted&&(this.promoted=this.promoted.with(e)),n}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,t){return this[e].intersect(this[t])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.king.intersect(this[e]).diff(this.promoted).singleSquare()}}class oe{constructor(){}static empty(){const e=new oe;for(const t of y)e[t]=0;return e}static fromBoard(e,t){const n=new oe;for(const r of y)n[r]=e.pieces(t,r).size();return n}clone(){const e=new oe;for(const t of y)e[t]=this[t];return e}equals(e){return y.every((t=>this[t]===e[t]))}add(e){const t=new oe;for(const n of y)t[n]=this[n]+e[n];return t}nonEmpty(){return y.some((e=>this[e]>0))}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}count(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class ie{constructor(e,t){this.white=e,this.black=t}static empty(){return new ie(oe.empty(),oe.empty())}static fromBoard(e){return new ie(oe.fromBoard(e,"white"),oe.fromBoard(e,"black"))}clone(){return new ie(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new ie(this.white.add(e.white),this.black.add(e.black))}count(){return this.white.count()+this.black.count()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class se{constructor(e,t){this.white=e,this.black=t}static default(){return new se(3,3)}clone(){return new se(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}function ae(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var ce,ue,le=function(){function e(){}var t=e.prototype;return t.unwrap=function(e,t){var n=this._chain((function(t){return ce.ok(e?e(t):t)}),(function(e){return t?ce.ok(t(e)):ce.err(e)}));if(n.isErr)throw n.error;return n.value},t.map=function(e,t){return this._chain((function(t){return ce.ok(e(t))}),(function(e){return ce.err(t?t(e):e)}))},t.chain=function(e,t){return this._chain(e,t||function(e){return ce.err(e)})},e}(),he=function(e){function t(t){var n;return(n=e.call(this)||this).value=t,n.isOk=!0,n.isErr=!1,n}return ae(t,e),t.prototype._chain=function(e,t){return e(this.value)},t}(le),de=function(e){function t(t){var n;return(n=e.call(this)||this).error=t,n.isOk=!1,n.isErr=!0,n}return ae(t,e),t.prototype._chain=function(e,t){return t(this.error)},t}(le);!function(e){e.ok=function(e){return new he(e)},e.err=function(e){return new de(e||new Error)},e.all=function(t){if(Array.isArray(t)){for(var n=[],r=0;r<t.length;r++){var o=t[r];if(o.isErr)return o;n.push(o.value)}return e.ok(n)}for(var i={},s=Object.keys(t),a=0;a<s.length;a++){var c=t[s[a]];if(c.isErr)return c;i[s[a]]=c.value}return e.ok(i)}}(ce||(ce={})),function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"}(ue||(ue={}));class pe extends Error{}function fe(e,t){return"white"===e?"a"===t?3:5:"a"===t?59:61}class me{constructor(){}static default(){const e=new me;return e.unmovedRooks=D.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new D(14,0),h:new D(96,0)},black:{a:new D(0,234881024),h:new D(0,1610612736)}},e}static empty(){const e=new me;return e.unmovedRooks=D.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:D.empty(),h:D.empty()},black:{a:D.empty(),h:D.empty()}},e}clone(){const e=new me;return e.unmovedRooks=this.unmovedRooks,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,t,n,r){const o=O(e,t),i=fe(e,t);this.unmovedRooks=this.unmovedRooks.with(r),this.rook[e][t]=r,this.path[e][t]=ne(r,i).with(i).union(ne(n,o).with(o)).without(n).without(r)}static fromSetup(e){const t=me.empty(),n=e.unmovedRooks.intersect(e.board.rook);for(const r of k){const o=D.backrank(r),i=e.board.kingOf(r);if(!C(i)||!o.has(i))continue;const s=n.intersect(e.board[r]).intersect(o),a=s.first();C(a)&&a<i&&t.add(r,"a",i,a);const c=s.last();C(c)&&i<c&&t.add(r,"h",i,c)}return t}discardRook(e){if(this.unmovedRooks.has(e)){this.unmovedRooks=this.unmovedRooks.without(e);for(const t of k)for(const n of _)this.rook[t][n]===e&&(this.rook[t][n]=void 0)}}discardSide(e){this.unmovedRooks=this.unmovedRooks.diff(D.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}function ve(e,t){const n=new Map,r=e.ctx();for(const[o,i]of e.allDests(r))if(i.nonEmpty()){const e=Array.from(i,z);(null==t?void 0:t.chess960)||o!==r.king||4!==x(o)||(i.has(0)?e.push("c1"):i.has(56)&&e.push("c8"),i.has(7)?e.push("g1"):i.has(63)&&e.push("g8")),n.set(z(o),e)}return n}var ge;!function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"}(ge||(ge={}));class be extends Error{}function we(e){return/^\d{1,4}$/.test(e)?parseInt(e,10):void 0}function ke(e){const t=A(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}}function ye(e){const t=re.empty();let n=7,r=0;for(let o=0;o<e.length;o++){const i=e[o];if("/"===i&&8===r)r=0,n--;else{const s=parseInt(i,10);if(s>0)r+=s;else{if(r>=8||n<0)return ce.err(new be(ge.Board));const s=r+8*n,a=ke(i);if(!a)return ce.err(new be(ge.Board));"~"===e[o+1]&&(a.promoted=!0,o++),t.set(s,a),r++}}}return 0!==n||8!==r?ce.err(new be(ge.Board)):ce.ok(t)}function _e(e){if(e.length>64)return ce.err(new be(ge.Pockets));const t=ie.empty();for(const n of e){const e=ke(n);if(!e)return ce.err(new be(ge.Pockets));t[e.color][e.role]++}return ce.ok(t)}function Se(e){const t=e.split("+");if(3===t.length&&""===t[0]){const e=we(t[1]),n=we(t[2]);return!C(e)||e>3||!C(n)||n>3?ce.err(new be(ge.RemainingChecks)):ce.ok(new se(3-e,3-n))}if(2===t.length){const e=we(t[0]),n=we(t[1]);return!C(e)||e>3||!C(n)||n>3?ce.err(new be(ge.RemainingChecks)):ce.ok(new se(e,n))}return ce.err(new be(ge.RemainingChecks))}function Ce(e){const t=e.split(" "),n=t.shift();let r,o,i=ce.ok(void 0);if(n.endsWith("]")){const e=n.indexOf("[");if(-1===e)return ce.err(new be(ge.Fen));r=ye(n.substr(0,e)),i=_e(n.substr(e+1,n.length-1-e-1))}else{const e=function(e,t,n){let r=e.indexOf(t);for(;n-- >0&&-1!==r;)r=e.indexOf(t,r+t.length);return r}(n,"/",7);-1===e?r=ye(n):(r=ye(n.substr(0,e)),i=_e(n.substr(e+1)))}const s=t.shift();if(C(s)&&"w"!==s){if("b"!==s)return ce.err(new be(ge.Turn));o="black"}else o="white";return r.chain((e=>{const n=t.shift(),r=C(n)?function(e,t){let n=D.empty();if("-"===t)return ce.ok(n);if(!/^[KQABCDEFGH]{0,2}[kqabcdefgh]{0,2}$/.test(t))return ce.err(new be(ge.Castling));for(const r of t){const t=r.toLowerCase(),o=r===t?"black":"white",i=D.backrank(o).intersect(e[o]);let s;s="q"===t?i:"k"===t?i.reversed():D.fromSquare(t.charCodeAt(0)-"a".charCodeAt(0)).intersect(i);for(const t of s){if(e.king.has(t)&&!e.promoted.has(t))break;if(e.rook.has(t)){n=n.with(t);break}}}return ce.ok(n)}(e,n):ce.ok(D.empty()),s=t.shift();let a;if(C(s)&&"-"!==s&&(a=P(s),!C(a)))return ce.err(new be(ge.EpSquare));let c,u=t.shift();C(u)&&u.includes("+")&&(c=Se(u),u=t.shift());const l=C(u)?we(u):0;if(!C(l))return ce.err(new be(ge.Halfmoves));const h=t.shift(),d=C(h)?we(h):1;if(!C(d))return ce.err(new be(ge.Fullmoves));const p=t.shift();let f=ce.ok(void 0);if(C(p)){if(C(c))return ce.err(new be(ge.RemainingChecks));f=Se(p)}else C(c)&&(f=c);return t.length>0?ce.err(new be(ge.Fen)):i.chain((t=>r.chain((n=>f.map((r=>({board:e,pockets:t,turn:o,unmovedRooks:n,remainingChecks:r,epSquare:a,halfmoves:l,fullmoves:Math.max(1,d)})))))))}))}function Ee(e,t){let n=q(e.role);return"white"===e.color&&(n=n.toUpperCase()),(null==t?void 0:t.promoted)&&e.promoted&&(n+="~"),n}function Me(e,t){let n="",r=0;for(let o=7;o>=0;o--)for(let i=0;i<8;i++){const s=i+8*o,a=e.get(s);a?(r>0&&(n+=r,r=0),n+=Ee(a,t)):r++,7===i&&(r>0&&(n+=r,r=0),0!==o&&(n+="/"))}return n}function xe(e){return y.map((t=>q(t).repeat(e[t]))).join("")}function qe(e,t,n){const r=null==n?void 0:n.shredder;let o="";for(const n of k){const i=D.backrank(n),s=e.kingOf(n);if(!C(s)||!i.has(s))continue;const a=e.pieces(n,"rook").intersect(i);for(const e of t.intersect(a).reversed())if(!r&&e===a.first()&&e<s)o+="white"===n?"Q":"q";else if(!r&&e===a.last()&&s<e)o+="white"===n?"K":"k";else{const t=b[x(e)];o+="white"===n?t.toUpperCase():t}}return o||"-"}function Ae(e,t,n){return Pe((r=>r.addEventListener(e,(e=>{const r=t(e);return n&&n(),r}))))}function Pe(e){return{insert:t=>e(t.elm)}}const ze=()=>Math.round(performance.now()),Re=(e,t,n)=>(setTimeout((()=>lichess.sound.loadOggOrMp3(e,`${lichess.sound.baseUrl}/${e}`)),n||1e3),()=>lichess.sound.play(e,t)),Oe={move:e=>lichess.sound.play(e?"capture":"move"),good:Re("lisp/PuzzleStormGood",.9,1e3),wrong:Re("lisp/Error",1,1e3),end:Re("lisp/PuzzleStormEnd",1,5e3)};class Te{constructor(e,t){this.index=e,this.puzzle=t,this.moveIndex=0,this.position=()=>{const e=class extends class{constructor(e){this.rules=e}kingAttackers(e,t,n){return function(e,t,n,r){return n[t].intersect(J(e,r).intersect(n.rooksAndQueens()).union(Z(e,r).intersect(n.bishopsAndQueens())).union(G(e).intersect(n.knight)).union(U(e).intersect(n.king)).union(X(E(t),e).intersect(n.pawn)))}(e,t,this.board,n)}dropDests(e){return D.empty()}playCaptureAt(e,t){this.halfmoves=0,"rook"===t.role&&this.castles.discardRook(e),this.pockets&&this.pockets[E(t.color)][t.role]++}ctx(){const e=this.isVariantEnd(),t=this.board.kingOf(this.turn);if(!C(t))return{king:t,blockers:D.empty(),checkers:D.empty(),variantEnd:e,mustCapture:!1};const n=J(t,D.empty()).intersect(this.board.rooksAndQueens()).union(Z(t,D.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[E(this.turn)]);let r=D.empty();for(const e of n){const n=ne(t,e).intersect(this.board.occupied);n.moreThanOne()||(r=r.union(n))}return{king:t,blockers:r,checkers:this.kingAttackers(t,E(this.turn),this.board.occupied),variantEnd:e,mustCapture:!1}}clone(){var e,t;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=null===(e=this.pockets)||void 0===e?void 0:e.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}equalsIgnoreMoves(e){var t,n;return this.rules===e.rules&&(this.pockets?this.board.equals(e.board):this.board.equalsIgnorePromoted(e.board))&&(e.pockets&&(null===(t=this.pockets)||void 0===t?void 0:t.equals(e.pockets))||!this.pockets&&!e.pockets)&&this.turn===e.turn&&this.castles.unmovedRooks.equals(e.castles.unmovedRooks)&&this.legalEpSquare()===e.legalEpSquare()&&(e.remainingChecks&&(null===(n=this.remainingChecks)||void 0===n?void 0:n.equals(e.remainingChecks))||!this.remainingChecks&&!e.remainingChecks)}toSetup(){var e,t;return{board:this.board.clone(),pockets:null===(e=this.pockets)||void 0===e?void 0:e.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:this.legalEpSquare(),remainingChecks:null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return k.every((e=>this.hasInsufficientMaterial(e)))}hasDests(e){e=e||this.ctx();for(const t of this.board[this.turn])if(this.dests(t,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,t){if(S(e))return!(!this.pockets||this.pockets[this.turn][e.role]<=0)&&("pawn"!==e.role||!D.backranks().has(e.to))&&this.dropDests(t).has(e.to);{if("pawn"===e.promotion)return!1;if("king"===e.promotion&&"antichess"!==this.rules)return!1;if(!!e.promotion!==(this.board.pawn.has(e.from)&&D.backranks().has(e.to)))return!1;const n=this.dests(e.from,t);return n.has(e.to)||n.has(this.normalizeMove(e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return C(e)&&this.kingAttackers(e,E(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return!!(e?e.variantEnd:this.isVariantEnd())||this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){return this.variantOutcome(e)||(e=e||this.ctx(),this.isCheckmate(e)?{winner:E(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const t=new Map;if(e.variantEnd)return t;for(const n of this.board[this.turn])t.set(n,this.dests(n,e));return t}castlingSide(e){if(S(e))return;const t=e.to-e.from;return(2===Math.abs(t)||this.board[this.turn].has(e.to))&&this.board.king.has(e.from)?t>0?"h":"a":void 0}normalizeMove(e){const t=this.castlingSide(e);if(!t)return e;const n=this.castles.rook[this.turn][t];return{from:e.from,to:C(n)?n:e.to}}play(e){const t=this.turn,n=this.epSquare,r=this.castlingSide(e);if(this.epSquare=void 0,this.halfmoves+=1,"black"===t&&(this.fullmoves+=1),this.turn=E(t),S(e))this.board.set(e.to,{role:e.role,color:t}),this.pockets&&this.pockets[t][e.role]--,"pawn"===e.role&&(this.halfmoves=0);else{const o=this.board.take(e.from);if(!o)return;let i;if("pawn"===o.role){this.halfmoves=0,e.to===n&&(i=this.board.take(e.to+("white"===t?-8:8)));const r=e.from-e.to;16===Math.abs(r)&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(o.role=e.promotion,o.promoted=!0)}else if("rook"===o.role)this.castles.discardRook(e.from);else if("king"===o.role){if(r){const e=this.castles.rook[t][r];if(C(e)){const n=this.board.take(e);this.board.set(O(t,r),o),n&&this.board.set(fe(t,r),n)}}if(this.castles.discardSide(t),r)return}const s=this.board.set(e.to,o)||i;s&&this.playCaptureAt(e.to,s)}}legalEpSquare(e){if(!C(this.epSquare))return;e=e||this.ctx();const t=this.board.pieces(this.turn,"pawn").intersect(X(E(this.turn),this.epSquare));for(const n of t)if(this.dests(n,e).has(this.epSquare))return this.epSquare}}{constructor(e){super(e||"chess")}static default(){const e=new this;return e.board=re.default(),e.pockets=void 0,e.turn="white",e.castles=me.default(),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){const t=new this;return t.board=e.board.clone(),t.pockets=void 0,t.turn=e.turn,t.castles=me.fromSetup(e),t.epSquare=t.validEpSquare(e.epSquare),t.remainingChecks=void 0,t.halfmoves=e.halfmoves,t.fullmoves=e.fullmoves,t.validate().map((e=>t))}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return ce.err(new pe(ue.Empty));if(2!==this.board.king.size())return ce.err(new pe(ue.Kings));if(!C(this.board.kingOf(this.turn)))return ce.err(new pe(ue.Kings));const e=this.board.kingOf(E(this.turn));return C(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?ce.err(new pe(ue.OppositeCheck)):D.backranks().intersects(this.board.pawn)?ce.err(new pe(ue.PawnsOnBackrank)):this.validateCheckers():ce.err(new pe(ue.Kings))}validateCheckers(){const e=this.board.kingOf(this.turn);if(C(e)){const t=this.kingAttackers(e,E(this.turn),this.board.occupied);if(t.size()>2||2===t.size()&&te(t.first(),t.last()).has(e))return ce.err(new pe(ue.ImpossibleCheck));if(C(this.epSquare))for(const n of t)if(te(n,this.epSquare).has(e))return ce.err(new pe(ue.ImpossibleCheck))}return ce.ok(void 0)}validEpSquare(e){if(!C(e))return;const t="white"===this.turn?5:2,n="white"===this.turn?8:-8;if(M(e)!==t)return;if(this.board.occupied.has(e+n))return;const r=e-n;return this.board.pawn.has(r)&&this.board[E(this.turn)].has(r)?e:void 0}castlingDest(e,t){if(!C(t.king)||t.checkers.nonEmpty())return D.empty();const n=this.castles.rook[this.turn][e];if(!C(n))return D.empty();if(this.castles.path[this.turn][e].intersects(this.board.occupied))return D.empty();const r=O(this.turn,e),o=ne(t.king,r),i=this.board.occupied.without(t.king);for(const e of o)if(this.kingAttackers(e,E(this.turn),i).nonEmpty())return D.empty();const s=fe(this.turn,e),a=this.board.occupied.toggle(t.king).toggle(n).toggle(s);return this.kingAttackers(r,E(this.turn),a).nonEmpty()?D.empty():D.fromSquare(n)}canCaptureEp(e,t){if(!C(this.epSquare))return!1;if(!X(this.turn,e).has(this.epSquare))return!1;if(!C(t.king))return!0;const n=this.epSquare+("white"===this.turn?-8:8),r=this.board.occupied.toggle(e).toggle(this.epSquare).toggle(n);return!this.kingAttackers(t.king,E(this.turn),r).intersects(r)}pseudoDests(e,t){if(t.variantEnd)return D.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return D.empty();let r=function(e,t,n){switch(e.role){case"pawn":return X(e.color,t);case"knight":return G(t);case"bishop":return Z(t,n);case"rook":return J(t,n);case"queen":return ee(t,n);case"king":return U(t)}}(n,e,this.board.occupied);if("pawn"===n.role){let t=this.board[E(this.turn)];C(this.epSquare)&&(t=t.with(this.epSquare)),r=r.intersect(t);const n="white"===this.turn?8:-8,o=e+n;if(0<=o&&o<64&&!this.board.occupied.has(o)){r=r.with(o);const t=o+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(r=r.with(t))}return r}return r=r.diff(this.board[this.turn]),e===t.king?r.union(this.castlingDest("a",t)).union(this.castlingDest("h",t)):r}dests(e,t){if((t=t||this.ctx()).variantEnd)return D.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return D.empty();let r,o;if("pawn"===n.role){r=X(this.turn,e).intersect(this.board[E(this.turn)]);const n="white"===this.turn?8:-8,i=e+n;if(0<=i&&i<64&&!this.board.occupied.has(i)){r=r.with(i);const t=i+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(r=r.with(t))}if(C(this.epSquare)&&this.canCaptureEp(e,t)){const e=this.epSquare-n;(t.checkers.isEmpty()||t.checkers.singleSquare()===e)&&(o=D.fromSquare(this.epSquare))}}else r="bishop"===n.role?Z(e,this.board.occupied):"knight"===n.role?G(e):"rook"===n.role?J(e,this.board.occupied):"queen"===n.role?ee(e,this.board.occupied):U(e);if(r=r.diff(this.board[this.turn]),C(t.king)){if("king"===n.role){const n=this.board.occupied.without(e);for(const e of r)this.kingAttackers(e,E(this.turn),n).nonEmpty()&&(r=r.without(e));return r.union(this.castlingDest("a",t)).union(this.castlingDest("h",t))}if(t.checkers.nonEmpty()){const e=t.checkers.singleSquare();if(!C(e))return D.empty();r=r.intersect(ne(e,t.king).with(e))}t.blockers.has(e)&&(r=r.intersect(te(e,t.king)))}return o&&(r=r.union(o)),r}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return!this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()&&(this.board[e].intersects(this.board.knight)?this.board[e].size()<=2&&this.board[E(e)].diff(this.board.king).diff(this.board.queen).isEmpty():!this.board[e].intersects(this.board.bishop)||(!this.board.bishop.intersects(D.darkSquares())||!this.board.bishop.intersects(D.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty())}}.fromSetup(Ce(this.puzzle.fen).unwrap()).unwrap();return this.line.slice(0,this.moveIndex+1).forEach((t=>e.play(R(t)))),e},this.expectedMove=()=>this.line[this.moveIndex+1],this.lastMove=()=>this.line[this.moveIndex],this.isOver=()=>this.moveIndex>=this.line.length-1,this.line=t.line.split(" "),this.pov=E(Ce(t.fen).unwrap().turn),this.startAt=ze()}}const Ie=["white","black"],Ne=["a","b","c","d","e","f","g","h"],De=["1","2","3","4","5","6","7","8"],Le=[...De].reverse(),Be=Array.prototype.concat(...Ne.map((e=>De.map((t=>e+t))))),Ke=e=>Be[8*e[0]+e[1]],Fe=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],je=Be.map(Fe);const $e=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},Ue=e=>"white"===e?"black":"white",Ge=(e,t)=>{const n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},Xe=(e,t)=>e.role===t.role&&e.color===t.color,He=(e,t,n,r)=>[(t?e[0]:7-e[0])*n,(t?7-e[1]:e[1])*r],We=e=>{const t=e.width/8,n=e.height/8;return(e,r)=>He(e,r,t,n)},Qe=(e,t)=>He(e,t,100,100),Ve=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},Ye=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},Ze=(e,t)=>{e.style.visibility=t?"visible":"hidden"},Je=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},et=e=>2===e.buttons||2===e.button,tt=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function nt(e,t,n){const r=Fe(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}function rt(e,t,n){let r=!1;function o(t){r&&e((e=>function(e,t,n){const r=e.state.pieces.get(t);r&&"pawn"==r.role&&e.setPieces(new Map([[t,{color:r.color,role:n,promoted:!0}]]))}(e,r.dest,t))),r.callback&&r.callback(r.orig,r.dest,t),r=!1}function i(){r&&(r=!1,e((e=>e.set(t()))),n())}return{start:function(t,o,i){return!!e((e=>{const s=e.state.pieces.get(o);return!(!s||"pawn"!=s.role||!("8"==o[1]&&"black"==e.state.turnColor||"1"==o[1]&&"white"==e.state.turnColor))&&(r={orig:t,dest:o,callback:i},n(),!0)}))},cancel:i,view(){if(!r)return;const t=["queen","knight","rook","bishop"];return e((e=>function(e,t,n,s){if(!r)return;let a=12.5*(7-Fe(e)[0]);return"white"===s&&(a=87.5-a),d("div#promotion-choice."+(n===s?"top":"bottom"),{hook:Pe((e=>{e.addEventListener("click",i),e.oncontextmenu=()=>!1}))},t.map((function(e,t){return d("square",{attrs:{style:"top: "+12.5*(n===s?t:7-t)+"%;left: "+a+"%"},hook:Ae("click",(t=>{t.stopPropagation(),o(e)}))},[d("piece."+e+"."+n)])})))}(r.dest,t,Ue(e.state.turnColor),e.state.orientation)))||null}}}var ot=function(){var e=this;this.cars=[],this.setPlayers=function(t){t.length!=e.cars.length?e.cars=t.map((function(e){return{score:e.score,time:-9999999}})):e.cars=e.cars.map((function(e,n){return{score:t[n].score,time:t[n].score>e.score?ze():e.time}}))},this.isBoosting=function(t){var n,r;return(null===(n=e.cars[t])||void 0===n?void 0:n.score)&&(null===(r=e.cars[t])||void 0===r?void 0:r.time)>ze()-1e3}};class it{constructor(e,t=0){this.config=e,this.start=()=>{this.startAt||(this.startAt=ze())},this.started=()=>!!this.startAt,this.millis=()=>this.startAt?Math.max(0,this.startAt+this.initialMillis-ze()):this.initialMillis,this.addSeconds=e=>{this.initialMillis+=1e3*e},this.flag=()=>!this.millis(),this.initialMillis=1e3*e.clock.initial-(t||0)}}class st{constructor(e){this.config=e,this.current=0,this.best=0,this.inc=()=>{this.current++,this.best=Math.max(this.best,this.current)},this.reset=()=>{this.current=0},this.level=()=>this.config.combo.levels.reduce(((e,[t,n],r)=>t<=this.current?r:e),0),this.percent=()=>{const e=this.level(),t=this.config.combo.levels,n=t[t.length-1];if(e>=t.length-1){const e=n[0]-t[t.length-2][0];return(this.current-n[0])/e*100%100}const r=[t[e][0],t[e+1][0]];return Math.floor((this.current-r[0])/(r[1]-r[0])*100)},this.bonus=()=>{if(0==this.percent()){const e=this.level();if(e>0)return{seconds:this.config.combo.levels[e][1],at:ze()}}}}}var at=function(e,t,n){var r=this;this.clock=e,this.resetGround=t,this.redraw=n,this.played=new Set,this.start=function(e,t){var n=function(){var o=e.getTime()-Date.now();o>0?(t&&o%1e3>500&&r.playOnce(Math.ceil(o/1e3)),setTimeout(n,o%1e3)):(t&&r.playOnce(0),r.clock.start(),r.resetGround()),r.redraw()};n()},this.playOnce=function(e){r.played.has(e)||(r.played.add(e),lichess.sound.play("countDown"+e))};for(var o=10;o>=0;o--)lichess.sound.loadStandard("countDown"+o)};const ct=(e,t,n)=>{const r=e.current,o=r.position();return{fen:(s=o.toSetup(),[Me(s.board,a)+(s.pockets?`[${u=s.pockets,xe(u.white).toUpperCase()+xe(u.black)}]`:""),s.turn[0],qe(s.board,s.unmovedRooks,a),C(s.epSquare)?z(s.epSquare):"-",...s.remainingChecks?[(c=s.remainingChecks,`${c.white}+${c.black}`)]:[],...(null==a?void 0:a.epd)?[]:[Math.max(0,Math.min(s.halfmoves,9999)),Math.max(1,Math.min(s.fullmoves,9999))]].join(" ")),orientation:n?Ue(e.pov):e.pov,turnColor:o.turn,movable:{color:e.pov,dests:t?ve(o):void 0},check:!!o.isCheck(),lastMove:(i=r.lastMove(),[i.substr(0,2),i.substr(2,2)])};var i,s,a,c,u},ut=e=>void 0!==e,lt=lichess.storage;var ht=function(e,t){var n,r=this;this.sign=Math.random().toString(36),this.localScore=0,this.boost=new ot,this.skipAvailable=!0,this.knowsSkip=function(e,t){const n="analyse."+e,r=!0===t||!1===t;let o;return function(e){return ut(e)&&e!=o?(o=e+"",lt.set(n,e)):ut(o)||(o=lt.get(n),null===o&&(o=t+"")),r?"true"===o:o}}("racer.skip",!1),this.ground=(e=>{let t=e;return function(e){return ut(e)&&(t=e),t}})(!1),this.flipped=!1,this.serverUpdate=function(e){r.data.players=e.players,r.boost.setPlayers(e.players),e.startsIn&&(r.vm.startsAt=new Date(Date.now()+e.startsIn),e.startsIn>0?r.countdown.start(r.vm.startsAt,r.isPlayer()):r.run.clock.start())},this.player=function(){return r.data.player},this.players=function(){return r.data.players},this.isPlayer=function(){return!r.vm.alreadyStarted&&r.data.players.some((function(e){return e.name==r.data.player.name}))},this.raceFull=function(){return r.data.players.length>=10},this.status=function(){return r.run.clock.started()?r.run.clock.flag()?"post":"racing":"pre"},this.isRacing=function(){return"racing"==r.status()},this.myScore=function(){var e=r.data.players.find((function(e){return e.name==r.data.player.name}));return null==e?void 0:e.score},this.join=function(e,t){let n,r=0;return function(...o){const i=this,s=performance.now()-r;function a(){n=void 0,r=performance.now(),t.apply(i,o)}n&&clearTimeout(n),s>e?a():n=setTimeout(a,e-s)}}(1e3,(function(){r.isPlayer()||r.socketSend("racerJoin")})),this.countdownSeconds=function(){return"pre"==r.status()&&r.vm.startsAt&&r.vm.startsAt>new Date?Math.min(9,Math.ceil((r.vm.startsAt.getTime()-Date.now())/1e3)):void 0},this.end=function(){r.resetGround(),r.redraw(),Oe.end(),lichess.pubsub.emit("ply",0),r.redrawSlow()},this.canSkip=function(){return r.skipAvailable},this.skip=function(){r.skipAvailable&&r.run.clock.started()&&(r.skipAvailable=!1,Oe.good(),r.playUci(r.run.current.expectedMove()),r.knowsSkip(!0))},this.userMove=function(e,t){r.promotion.start(e,t,r.playUserMove)||r.playUserMove(e,t)},this.playUserMove=function(e,t,n){return r.playUci(""+e+t+(n?"knight"==n?"n":n[0]:""))},this.playUci=function(e){var t=ze(),n=r.run.current;if(n.startAt+g.minFirstMoveTime>t)console.log("reverted!");else{r.run.moves++,r.promotion.cancel();var o=n.position(),i=R(e),s=o.board.occupied.has(i.to);if(o.play(i),o.isCheckmate()||e==n.expectedMove()){n.moveIndex++,r.localScore++,r.run.combo.inc(),r.run.modifier.moveAt=t;var a=r.run.combo.bonus();a&&(r.run.modifier.bonus=a,r.localScore+=a.seconds),r.socketSend("racerScore",r.localScore),n.isOver()?r.incPuzzle()||r.end():(n.moveIndex++,s=s||o.board.occupied.has(R(n.line[n.moveIndex]).to)),Oe.move(s)}else Oe.wrong(),r.run.errors++,r.run.combo.reset(),r.run.clock.flag()?r.end():r.incPuzzle()||r.end();r.redraw(),r.redrawQuick(),r.redrawSlow()}r.resetGround(),lichess.pubsub.emit("ply",r.run.moves)},this.redrawQuick=function(){return setTimeout(r.redraw,100)},this.redrawSlow=function(){return setTimeout(r.redraw,1e3)},this.cgOpts=function(){return r.isPlayer()?ct(r.run,r.isRacing(),r.flipped):{orientation:r.run.pov}},this.resetGround=function(){return r.withGround((function(e){return e.set(r.cgOpts())}))},this.incPuzzle=function(){var e=r.run.current.index;return e<r.data.puzzles.length-1&&(r.run.current=new Te(e+1,r.data.puzzles[e+1]),!0)},this.withGround=function(e){var t=r.ground();return t&&e(t)},this.flip=function(){r.flipped=!r.flipped,r.withGround((function(e){return e.toggleOrientation()})),r.redraw()},this.socketSend=function(e,t){return lichess.socket.send(e,t,{sign:r.sign})},this.hotkeys=function(){return window.Mousetrap.bind("f",r.flip)},this.data=e.data,this.race=this.data.race,this.pref=e.pref,this.redraw=function(){return t(r.data)},this.trans=lichess.trans(e.i18n),this.run={pov:(n=this.data.puzzles[0],E(Ce(n.fen).unwrap().turn)),moves:0,errors:0,current:new Te(0,this.data.puzzles[0]),clock:new it(g,Math.max(0,-e.data.startsIn)),history:[],combo:new st(g),modifier:{moveAt:0}},this.vm={alreadyStarted:e.data.startsIn&&e.data.startsIn<=0},this.countdown=new at(this.run.clock,this.resetGround,(function(){return setTimeout(r.redraw)})),this.promotion=rt(this.withGround,this.cgOpts,this.redraw),this.serverUpdate(e.data),lichess.socket=new lichess.StrongSocket("/racer/"+this.race.id,!1,{events:{racerState:function(e){r.serverUpdate(e),r.redraw(),r.redrawSlow()}}}),lichess.socket.sign(this.sign),setInterval(this.redraw,1e3),setTimeout(this.hotkeys,1e3)};function dt(e,t){return Math.abs(e-t)}const pt=(e,t,n,r)=>{const o=dt(e,n),i=dt(t,r);return 1===o&&2===i||2===o&&1===i},ft=(e,t,n,r)=>dt(e,n)===dt(t,r),mt=(e,t,n,r)=>e===n||t===r,vt=(e,t,n,r)=>ft(e,t,n,r)||mt(e,t,n,r);function gt(e,t,n){const r=e.get(t);if(!r)return[];const o=Fe(t),i=r.role,s="pawn"===i?(a=r.color,(e,t,n,r)=>dt(e,n)<2&&("white"===a?r===t+1||t<=1&&r===t+2&&e===n:r===t-1||t>=6&&r===t-2&&e===n)):"knight"===i?pt:"bishop"===i?ft:"rook"===i?mt:"queen"===i?vt:function(e,t,n){return(r,o,i,s)=>dt(r,i)<2&&dt(o,s)<2||n&&o===s&&o===("white"===e?0:7)&&(4===r&&(2===i&&t.includes(0)||6===i&&t.includes(7))||t.includes(i))}(r.color,function(e,t){const n="white"===t?"1":"8",r=[];for(const[o,i]of e)o[1]===n&&i.color===t&&"rook"===i.role&&r.push(Fe(o)[0]);return r}(e,r.color),n);var a;return je.filter((e=>(o[0]!==e[0]||o[1]!==e[1])&&s(o[0],o[1],e[0],e[1]))).map(Ke)}function bt(e,...t){e&&setTimeout((()=>e(...t)),1)}function wt(e){e.premovable.current&&(e.premovable.current=void 0,bt(e.premovable.events.unset))}function kt(e){const t=e.predroppable;t.current&&(t.current=void 0,bt(t.events.unset))}function yt(e,t,n){const r=e.pieces.get(t),o=e.pieces.get(n);if(t===n||!r)return!1;const i=o&&o.color!==r.color?o:void 0;return n===e.selected&&qt(e),bt(e.events.move,t,n,i),function(e,t,n){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||"king"!==r.role)return!1;const o=Fe(t),i=Fe(n);if(0!==o[1]&&7!==o[1]||o[1]!==i[1])return!1;4!==o[0]||e.pieces.has(n)||(6===i[0]?n=Ke([7,i[1]]):2===i[0]&&(n=Ke([0,i[1]])));const s=e.pieces.get(n);return!(!s||s.color!==r.color||"rook"!==s.role||(e.pieces.delete(t),e.pieces.delete(n),o[0]<i[0]?(e.pieces.set(Ke([6,i[1]]),r),e.pieces.set(Ke([5,i[1]]),s)):(e.pieces.set(Ke([2,i[1]]),r),e.pieces.set(Ke([3,i[1]]),s)),0))}(e,t,n)||(e.pieces.set(n,r),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,bt(e.events.change),i||!0}function _t(e,t,n,r){if(e.pieces.has(n)){if(!r)return!1;e.pieces.delete(n)}return bt(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,bt(e.events.change),e.movable.dests=void 0,e.turnColor=Ue(e.turnColor),!0}function St(e,t,n){const r=yt(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=Ue(e.turnColor),e.animation.current=void 0),r}function Ct(e,t,n){if(Pt(e,t,n)){const r=St(e,t,n);if(r){const o=e.hold.stop();qt(e);const i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:o};return!0!==r&&(i.captured=r),bt(e.movable.events.after,t,n,i),!0}}else if(function(e,t,n){return t!==n&&zt(e,t)&&gt(e.pieces,t,e.premovable.castle).includes(n)}(e,t,n))return function(e,t,n,r){kt(e),e.premovable.current=[t,n],bt(e.premovable.events.set,t,n,r)}(e,t,n,{ctrlKey:e.stats.ctrlKey}),qt(e),!0;return qt(e),!1}function Et(e,t,n,r){const o=e.pieces.get(t);o&&(function(e,t,n){const r=e.pieces.get(t);return!(!r||t!==n&&e.pieces.has(n)||"both"!==e.movable.color&&(e.movable.color!==r.color||e.turnColor!==r.color))}(e,t,n)||r)?(e.pieces.delete(t),_t(e,o,n,r),bt(e.movable.events.afterNewPiece,o.role,n,{premove:!1,predrop:!1})):o&&function(e,t,n){const r=e.pieces.get(t),o=e.pieces.get(n);return!!r&&(!o||o.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==r.role||"1"!==n[1]&&"8"!==n[1])&&e.movable.color===r.color&&e.turnColor!==r.color}(e,t,n)?function(e,t,n){wt(e),e.predroppable.current={role:t,key:n},bt(e.predroppable.events.set,t,n)}(e,o.role,n):(wt(e),kt(e)),e.pieces.delete(t),qt(e)}function Mt(e,t,n){if(bt(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return qt(e),void e.hold.cancel();if((e.selectable.enabled||n)&&e.selected!==t&&Ct(e,e.selected,t))return void(e.stats.dragged=!1)}(At(e,t)||zt(e,t))&&(xt(e,t),e.hold.start())}function xt(e,t){e.selected=t,zt(e,t)?e.premovable.dests=gt(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function qt(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function At(e,t){const n=e.pieces.get(t);return!!n&&("both"===e.movable.color||e.movable.color===n.color&&e.turnColor===n.color)}function Pt(e,t,n){var r,o;return t!==n&&At(e,t)&&(e.movable.free||!!(null===(o=null===(r=e.movable.dests)||void 0===r?void 0:r.get(t))||void 0===o?void 0:o.includes(n)))}function zt(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function Rt(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],r=t[1];let o=!1;if(Pt(e,n,r)){const t=St(e,n,r);if(t){const i={premove:!0};!0!==t&&(i.captured=t),bt(e.movable.events.after,n,r,i),o=!0}}return wt(e),o}function Ot(e){wt(e),kt(e),qt(e)}function Tt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Ot(e)}function It(e,t,n){let r=Math.floor(8*(e[0]-n.left)/n.width);t||(r=7-r);let o=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(o=7-o),r>=0&&r<8&&o>=0&&o<8?Ke([r,o]):void 0}function Nt(e){return"white"===e.orientation}const Dt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Lt={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Bt={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Kt(e){"start"===e&&(e=Dt);const t=new Map;let n=7,r=0;for(const o of e)switch(o){case" ":return t;case"/":if(--n,n<0)return t;r=0;break;case"~":{const e=t.get(Ke([r,n]));e&&(e.promoted=!0);break}default:{const e=o.charCodeAt(0);if(e<57)r+=e-48;else{const e=o.toLowerCase();t.set(Ke([r,n]),{role:Lt[e],color:o===e?"black":"white"}),++r}}}return t}function Ft(e,t){var n,r;if((null===(n=t.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(r=t.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),jt(e,t),t.fen&&(e.pieces=Kt(t.fen),e.drawable.shapes=[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[n,r]of e.pieces)"king"===r.role&&r.color===t&&(e.check=n)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&xt(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",n="e"+t,r=e.movable.dests.get(n),o=e.pieces.get(n);if(!r||!o||"king"!==o.role)return;e.movable.dests.set(n,r.filter((e=>!(e==="a"+t&&r.includes("c"+t)||e==="h"+t&&r.includes("g"+t)))))}}function jt(e,t){for(const n in t)$t(e[n])&&$t(t[n])?jt(e[n],t[n]):e[n]=t[n]}function $t(e){return"object"==typeof e}function Ut(e,t){return t.animation.enabled?function(e,t){const n=new Map(t.pieces),r=e(t),o=function(e,t){const n=new Map,r=[],o=new Map,i=[],s=[],a=new Map;let c,u,l;for(const[t,n]of e)a.set(t,Xt(t,n));for(const e of Be)c=t.pieces.get(e),u=a.get(e),c?u?Xe(c,u.piece)||(i.push(u),s.push(Xt(e,c))):s.push(Xt(e,c)):u&&i.push(u);for(const e of s)u=Ht(e,i.filter((t=>Xe(e.piece,t.piece)))),u&&(l=[u.pos[0]-e.pos[0],u.pos[1]-e.pos[1]],n.set(e.key,l.concat(l)),r.push(u.key));for(const e of i)r.includes(e.key)||o.set(e.key,e.piece);return{anims:n,fadings:o}}(n,t);if(o.anims.size||o.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:o},e||Wt(t,performance.now())}else t.dom.redraw();return r}(e,t):Gt(e,t)}function Gt(e,t){const n=e(t);return t.dom.redraw(),n}function Xt(e,t){return{key:e,pos:Fe(e),piece:t}}function Ht(e,t){return t.sort(((t,n)=>Ge(e.pos,t.pos)-Ge(e.pos,n.pos)))[0]}function Wt(e,t){const n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());const r=1-(t-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=function(e){return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1}(r);for(const e of n.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>Wt(e,t)))}}const Qt=["green","red","blue","yellow"];function Vt(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?qt(e):Ot(e);const n=Je(t),r=It(n,Nt(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:tn(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Yt(e))}function Yt(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const n=It(t.pos,Nt(e),e.dom.bounds());n||(t.snapToValidMove=!1);const r=t.snapToValidMove?function(e,t,n,r){const o=Fe(e),i=je.filter((e=>vt(o[0],o[1],e[0],e[1])||pt(o[0],o[1],e[0],e[1]))),s=i.map((e=>nt(Ke(e),n,r))).map((e=>Ge(t,e))),[,a]=s.reduce(((e,t,n)=>e[0]<t?e:[t,n]),[s[0],0]);return Ke(i[a])}(t.orig,t.pos,Nt(e),e.dom.bounds()):n;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),Yt(e)}}))}function Zt(e,t){e.drawable.current&&(e.drawable.current.pos=Je(t))}function Jt(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const n=e=>e.orig===t.orig&&e.dest===t.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter((e=>!n(e))));r&&r.brush===t.brush||e.shapes.push(t);nn(e)}(e.drawable,t),en(e))}function en(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function tn(e){var t;const n=(e.shiftKey||e.ctrlKey)&&et(e),r=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return Qt[(n?1:0)+(r?2:0)]}function nn(e){e.onChange&&e.onChange(e.shapes)}function rn(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),r=Je(t),o=It(r,Nt(e),n);if(!o)return;const i=e.pieces.get(o),s=e.selected;var a;s||!e.drawable.enabled||!e.drawable.eraseOnClick&&i&&i.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),nn(a.drawable)),!1===t.cancelable||t.touches&&e.movable.color&&!i&&!s&&!function(e,t){const n=Nt(e),r=e.dom.bounds(),o=Math.pow(r.width/8,2);for(const i in e.pieces){const e=nt(i,n,r);if(Ge(e,t)<=o)return!0}return!1}(e,r)||t.preventDefault();const c=!!e.premovable.current,u=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Pt(e,e.selected,o)?Ut((e=>Mt(e,o)),e):Mt(e,o);const l=e.selected===o,h=ln(e,o);if(i&&h&&l&&function(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}(e,o)){e.draggable.current={orig:o,piece:i,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:h,previouslySelected:s,originTarget:t.target},h.cgDragging=!0,h.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${i.color} ${i.role}`,Ve(a,We(n)(Fe(o),Nt(e))),Ze(a,!0)),on(e)}else c&&wt(e),u&&kt(e);e.dom.redraw()}function on(e){requestAnimationFrame((()=>{var t;const n=e.draggable.current;if(!n)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(n.orig))&&(e.animation.current=void 0);const r=e.pieces.get(n.orig);if(r&&Xe(r,n.piece)){if(!n.started&&Ge(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const e=n.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),n.element=e}const t=e.dom.bounds();Ve(n.element,[n.pos[0]-t.left-t.width/16,n.pos[1]-t.top-t.height/16])}}else cn(e);on(e)}))}function sn(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=Je(t))}function an(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);wt(e),kt(e);const r=It(Je(t)||n.pos,Nt(e),e.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?Et(e,n.orig,r,n.force):(e.stats.ctrlKey=t.ctrlKey,Ct(e,n.orig,r)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(n.orig),bt(e.events.change)),(n.orig!==n.previouslySelected||n.orig!==r&&r)&&e.selectable.enabled||qt(e),un(e),e.draggable.current=void 0,e.dom.redraw()}function cn(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,qt(e),un(e),e.dom.redraw())}function un(e){const t=e.dom.elements;t.ghost&&Ze(t.ghost,!1)}function ln(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function hn(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function dn(e,t){function n(){!function(e){e.orientation=Ue(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&n(),(t.fen?Ut:Gt)((e=>Ft(e,t)),e)},state:e,getFen:()=>{return t=e.pieces,Le.map((e=>Ne.map((n=>{const r=t.get(n+e);if(r){const e=Bt[r.role];return"white"===r.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:n,setPieces(t){Ut((e=>function(e,t){for(const[n,r]of t)r?e.pieces.set(n,r):e.pieces.delete(n)}(e,t)),e)},selectSquare(t,n){t?Ut((e=>Mt(e,t,n)),e):e.selected&&(qt(e),e.dom.redraw())},move(t,n){Ut((e=>yt(e,t,n)),e)},newPiece(t,n){Ut((e=>_t(e,t,n)),e)},playPremove(){if(e.premovable.current){if(Ut(Rt,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const n=function(e,t){const n=e.predroppable.current;let r=!1;if(!n)return!1;t(n)&&_t(e,{role:n.role,color:e.movable.color},n.key)&&(bt(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0);return kt(e),r}(e,t);return e.dom.redraw(),n}return!1},cancelPremove(){Gt(wt,e)},cancelPredrop(){Gt(kt,e)},cancelMove(){Gt((e=>{Ot(e),cn(e)}),e)},stop(){Gt((e=>{Tt(e),cn(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{hn(e,2),setTimeout((()=>hn(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){Gt((e=>e.drawable.autoShapes=t),e)},setShapes(t){Gt((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>It(t,Nt(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,n,r){!function(e,t,n,r){const o="a0";e.pieces.set(o,t),e.dom.redraw();const i=Je(n);e.draggable.current={orig:o,piece:t,origPos:i,pos:i,started:!0,element:()=>ln(e,o),originTarget:n.target,newPiece:!0,force:!!r},on(e)}(e,t,n,r)},destroy(){Tt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function pn(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function fn(e,t,n){const r=e.drawable,o=r.current,i=o&&o.mouseSq?o:void 0,s=new Map,a=e.dom.bounds();for(const e of r.shapes.concat(r.autoShapes).concat(i?[i]:[]))e.dest&&s.set(e.dest,(s.get(e.dest)||0)+1);const c=r.shapes.concat(r.autoShapes).map((e=>({shape:e,current:!1,hash:vn(e,s,!1,a)})));i&&c.push({shape:i,current:!0,hash:vn(i,s,!0,a)});const u=c.map((e=>e.hash)).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const l=t.querySelector("defs"),h=t.querySelector("g"),d=n.querySelector("g");!function(e,t,n){const r=new Map;let o;for(const n of t)n.shape.dest&&(o=e.brushes[n.shape.brush],n.shape.modifiers&&(o=Sn(o,n.shape.modifiers)),r.set(o.key,o));const i=new Set;let s=n.firstChild;for(;s;)i.add(s.getAttribute("cgKey")),s=s.nextSibling;for(const[e,t]of r.entries())i.has(e)||n.appendChild(kn(t))}(r,c,l),mn(e,c.filter((e=>!e.shape.customSvg)),r.brushes,s,h),mn(e,c.filter((e=>e.shape.customSvg)),r.brushes,s,d)}function mn(e,t,n,r,o){const i=e.dom.bounds(),s=new Map,a=[];for(const e of t)s.set(e.hash,!1);let c,u=o.firstChild;for(;u;)c=u.getAttribute("cgHash"),s.has(c)?s.set(c,!0):a.push(u),u=u.nextSibling;for(const e of a)o.removeChild(e);for(const a of t)s.get(a.hash)||o.appendChild(wn(e,a,n,r,i))}function vn({orig:e,dest:t,brush:n,piece:r,modifiers:o,customSvg:i},s,a,c){return[c.width,c.height,a,e,t,n,t&&(s.get(t)||0)>1,r&&gn(r),o&&(u=o,""+(u.lineWidth||"")),i&&bn(i)].filter((e=>e)).join(",");var u}function gn(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function bn(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return"custom-"+t.toString()}function wn(e,{shape:t,current:n,hash:r},o,i,s){let a;if(t.customSvg){const n=_n(Fe(t.orig),e.orientation);a=function(e,t,n){const{width:r,height:o}=n,i=r/8,s=o/8,a=t[0]*i,c=(7-t[1])*s,u=yn(pn("g"),{transform:`translate(${a},${c})`}),l=yn(pn("svg"),{width:i,height:s,viewBox:"0 0 100 100"});return u.appendChild(l),l.innerHTML=e,u}(t.customSvg,n,s)}else if(t.piece)a=function(e,t,n,r){const o=Mn(t,r),i=r.width/8*(n.scale||1),s=n.color[0]+("knight"===n.role?"n":n.role[0]).toUpperCase();return yn(pn("image"),{className:`${n.role} ${n.color}`,x:o[0]-i/2,y:o[1]-i/2,width:i,height:i,href:e+s+".svg"})}(e.drawable.pieces.baseUrl,_n(Fe(t.orig),e.orientation),t.piece,s);else{const r=_n(Fe(t.orig),e.orientation);if(t.dest){let c=o[t.brush];t.modifiers&&(c=Sn(c,t.modifiers)),a=function(e,t,n,r,o,i){const s=function(e,t){return(t?20:10)/512*e.width}(i,o&&!r),a=Mn(t,i),c=Mn(n,i),u=c[0]-a[0],l=c[1]-a[1],h=Math.atan2(l,u),d=Math.cos(h)*s,p=Math.sin(h)*s;return yn(pn("line"),{stroke:e.color,"stroke-width":Cn(e,r,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:En(e,r),x1:a[0],y1:a[1],x2:c[0]-d,y2:c[1]-p})}(c,r,_n(Fe(t.dest),e.orientation),n,(i.get(t.dest)||0)>1,s)}else a=function(e,t,n,r){const o=Mn(t,r),i=function(e){const t=e.width/512;return[3*t,4*t]}(r),s=(r.width+r.height)/32;return yn(pn("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:En(e,n),cx:o[0],cy:o[1],r:s-i[1]/2})}(o[t.brush],r,n,s)}return a.setAttribute("cgHash",r),a}function kn(e){const t=yn(pn("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(yn(pn("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function yn(e,t){for(const n in t)e.setAttribute(n,t[n]);return e}function _n(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function Sn(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function Cn(e,t,n){return(e.lineWidth||10)*(t?.85:1)/512*n.width}function En(e,t){return(e.opacity||1)*(t?.9:1)}function Mn(e,t){return[(e[0]+.5)*t.width/8,(7.5-e[1])*t.height/8]}function xn(e,t){const n=tt("coords",t);let r;for(const t of e)r=tt("coord"),r.textContent=t,n.appendChild(r);return n}function qn(e,t){const n=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(n)}if(e.viewOnly)return;const r=function(e){return t=>{e.draggable.current?cn(e):e.drawable.current?en(e):t.shiftKey||et(t)?e.drawable.enabled&&Vt(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;wt(e),kt(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const r=Je(t),o=r&&It(r,Nt(e),e.dom.bounds());o&&Et(e,"a0",o)}e.dom.redraw()}(e,t):rn(e,t))}}(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault()))}function An(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}function Pn(e,t,n){return r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||t(e,r)}}function zn(e){const t=Nt(e),n=e.dom.relative?Qe:We(e.dom.bounds()),r=e.dom.relative?Ye:Ve,o=e.dom.elements.board,i=e.pieces,s=e.animation.current,a=s?s.plan.anims:new Map,c=s?s.plan.fadings:new Map,u=e.draggable.current,l=function(e){var t;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)Dn(n,t,"last-move");e.check&&e.highlight.check&&Dn(n,e.check,"check");if(e.selected&&(Dn(n,e.selected,"selected"),e.movable.showDests)){const r=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(r)for(const t of r)Dn(n,t,"move-dest"+(e.pieces.has(t)?" oc":""));const o=e.premovable.dests;if(o)for(const t of o)Dn(n,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const r=e.premovable.current;if(r)for(const e of r)Dn(n,e,"current-premove");else e.predroppable.current&&Dn(n,e.predroppable.current.key,"current-premove");const o=e.exploding;if(o)for(const e of o.keys)Dn(n,e,"exploding"+o.stage);return n}(e),h=new Set,d=new Set,p=new Map,f=new Map;let m,v,g,b,w,k,y,_,S,C;for(v=o.firstChild;v;){if(m=v.cgKey,Rn(v))if(g=i.get(m),w=a.get(m),k=c.get(m),b=v.cgPiece,!v.cgDragging||u&&u.orig===m||(v.classList.remove("dragging"),r(v,n(Fe(m),t)),v.cgDragging=!1),!k&&v.cgFading&&(v.cgFading=!1,v.classList.remove("fading")),g){if(w&&v.cgAnimating&&b===Nn(g)){const e=Fe(m);e[0]+=w[2],e[1]+=w[3],v.classList.add("anim"),r(v,n(e,t))}else v.cgAnimating&&(v.cgAnimating=!1,v.classList.remove("anim"),r(v,n(Fe(m),t)),e.addPieceZIndex&&(v.style.zIndex=In(Fe(m),t)));b!==Nn(g)||k&&v.cgFading?k&&b===Nn(k)?(v.classList.add("fading"),v.cgFading=!0):Ln(p,b,v):h.add(m)}else Ln(p,b,v);else if(On(v)){const e=v.className;l.get(m)===e?d.add(m):Ln(f,e,v)}v=v.nextSibling}for(const[e,i]of l)if(!d.has(e)){S=f.get(i),C=S&&S.pop();const s=n(Fe(e),t);if(C)C.cgKey=e,r(C,s);else{const t=tt("square",i);t.cgKey=e,r(t,s),o.insertBefore(t,o.firstChild)}}for(const[s,c]of i)if(w=a.get(s),!h.has(s))if(y=p.get(Nn(c)),_=y&&y.pop(),_){_.cgKey=s,_.cgFading&&(_.classList.remove("fading"),_.cgFading=!1);const o=Fe(s);e.addPieceZIndex&&(_.style.zIndex=In(o,t)),w&&(_.cgAnimating=!0,_.classList.add("anim"),o[0]+=w[2],o[1]+=w[3]),r(_,n(o,t))}else{const i=Nn(c),a=tt("piece",i),u=Fe(s);a.cgPiece=i,a.cgKey=s,w&&(a.cgAnimating=!0,u[0]+=w[2],u[1]+=w[3]),r(a,n(u,t)),e.addPieceZIndex&&(a.style.zIndex=In(u,t)),o.appendChild(a)}for(const t of p.values())Tn(e,t);for(const t of f.values())Tn(e,t)}function Rn(e){return"PIECE"===e.tagName}function On(e){return"SQUARE"===e.tagName}function Tn(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function In(e,t){let n=2+8*e[1]+(7-e[0]);return t&&(n=67-n),n+""}function Nn(e){return`${e.color} ${e.role}`}function Dn(e,t,n){const r=e.get(t);r?e.set(t,`${r} ${n}`):e.set(t,n)}function Ln(e,t,n){const r=e.get(t);r?r.push(n):e.set(t,[n])}function Bn(e,t){const n={pieces:Kt(Dt),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:$e()};function r(){const t="dom"in n?n.dom.unbind:void 0,r=n.viewOnly&&!n.drawable.visible,o=function(e,t,n){e.innerHTML="",e.classList.add("cg-wrap");for(const n of Ie)e.classList.toggle("orientation-"+n,t.orientation===n);e.classList.toggle("manipulable",!t.viewOnly);const r=tt("cg-helper");e.appendChild(r);const o=tt("cg-container");r.appendChild(o);const i=tt("cg-board");let s,a,c;if(o.appendChild(i),t.drawable.visible&&!n&&(s=yn(pn("svg"),{class:"cg-shapes"}),s.appendChild(pn("defs")),s.appendChild(pn("g")),a=yn(pn("svg"),{class:"cg-custom-svgs"}),a.appendChild(pn("g")),o.appendChild(s),o.appendChild(a)),t.coordinates){const e="black"===t.orientation?" black":"";o.appendChild(xn(De,"ranks"+e)),o.appendChild(xn(Ne,"files"+e))}return t.draggable.showGhost&&!n&&(c=tt("piece","ghost"),Ze(c,!1),o.appendChild(c)),{board:i,container:o,ghost:c,svg:s,customSvg:a}}(e,n,r),i=function(e){let t;const n=()=>(void 0===t&&(t=e()),t);return n.clear=()=>{t=void 0},n}((()=>o.board.getBoundingClientRect())),s=e=>{zn(c),!e&&o.svg&&fn(c,o.svg,o.customSvg)},a=()=>{i.clear(),function(e){if(e.dom.relative)return;const t=Nt(e),n=We(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(Rn(r)&&!r.cgAnimating||On(r))&&Ve(r,n(Fe(r.cgKey),t)),r=r.nextSibling}(c),o.svg&&fn(c,o.svg,o.customSvg)},c=n;return c.dom={elements:o,bounds:i,redraw:Kn(s),redrawNow:s,unbind:t,relative:r},c.drawable.prevSvgHash="",s(!1),qn(c,a),t||(c.dom.unbind=function(e,t){const n=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||n.push(An(document.body,"chessground.resize",t)),!e.viewOnly){const t=Pn(e,sn,Zt),r=Pn(e,an,Jt);for(const e of["touchmove","mousemove"])n.push(An(document,e,t));for(const e of["touchend","mouseup"])n.push(An(document,e,r));const o=()=>e.dom.bounds.clear();n.push(An(document,"scroll",o,{capture:!0,passive:!0})),n.push(An(window,"resize",o,{passive:!0}))}return()=>n.forEach((e=>e()))}(c,a)),c.events.insert&&c.events.insert(o),c}return Ft(n,t||{}),dn(r(),r)}function Kn(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}var Fn=function(){return(Fn=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};let jn,$n;function Un(e,t,n){return d("div.puz-clock__time",{hook:{insert(r){const o=r.elm;o.innerText=Gn(e.clock.millis()),jn=setInterval((()=>function(e,t,n,r){if(!e.clock.startAt)return;const o=e.modifier,i=ze(),s=e.clock.millis(),a=r?Xn(i,o.bonus)-Xn(i,o.malus):0,c=Gn(s-a);c!=$n&&(n.innerText=c);$n=c,s<1&&!e.endAt&&t()}(e,t,o,n)),100)},destroy(){jn&&clearInterval(jn)}}})}const Gn=e=>{const t=new Date(Math.max(0,1e3*Math.ceil(e/1e3))),n=t.getUTCMinutes(),r=t.getUTCSeconds();return n+":"+(((o=r)<10?"0":"")+o);var o};function Xn(e,t){const n=t&&(e-t.at<1e3?e-t.at:void 0);return ut(n)?1e3*t.seconds*(1-n/1e3):0}const Hn=e=>{const t=ze(),n=e.modifier.malus,r=e.modifier.bonus;return{"puz-mod-puzzle":e.current.startAt>t-90,"puz-mod-move":e.modifier.moveAt>t-90,"puz-mod-malus-slow":!!n&&n.at>t-950,"puz-mod-bonus-slow":!!r&&r.at>t-950}},Wn=(e,t)=>n=>{const r=n.combo.level();return d("div.puz-combo",[d("div.puz-combo__counter",[d("span.puz-combo__counter__value",n.combo.current),d("span.puz-combo__counter__combo","COMBO")]),d("div.puz-combo__bars",[d("div.puz-combo__bar",[d("div.puz-combo__bar__in",{attrs:{style:`width:${n.combo.percent()}%`}}),d("div.puz-combo__bar__in-full")]),d("div.puz-combo__levels",[0,1,2,3].map((n=>d("div.puz-combo__level",{class:{active:n<r}},d("span",t(e.combo.levels[n+1][1]))))))])])};var Qn=function(e){var t=e.players(),n=t.reduce((function(e,t){return t.score<e?t.score:e}),130)/3,r=t.reduce((function(e,t){return t.score>e?t.score:e}),35)-n,o=function(e){return(e-n)/r},i=t.reduce((function(e,t){return t.score>e?t.score:e}),0),s=e.player().name,a=[];return t.forEach((function(t,n){var r=t.name==s,c=Vn(o,r,i,e.boost,t,n);r?a.unshift(c):a.push(c)})),d("div.racer__race",{attrs:{style:"height:"+(25*t.length+14)+"px"}},d("div.racer__race__tracks",a))},Vn=function(e,t,n,r,o,i){return d("div.racer__race__track",{class:{"racer__race__track--me":t,"racer__race__track--first":o.score&&o.score==n,"racer__race__track--boost":r.isBoosting(i)}},[d("div.racer__race__player",{attrs:{style:"transform:translateX("+95*e(o.score)+"%)"}},[d("div.racer__race__player__car.car-"+i,[0]),d("span.racer__race__player__name",Yn(o,t))]),d("div.racer__race__score",o.score)])},Yn=function(e,t){return e.userId?d("a.user-link.ulpt",{attrs:{href:"/@/"+e.name}},e.title?[d("span.utitle",e.title),e.name]:[e.name]):d("anonymous",{attrs:{title:"Anonymous player"}},[e.name,t?" (you)":void 0])};const Zn={cache:"no-cache",credentials:"same-origin"},Jn={"X-Requested-With":"XMLHttpRequest"},er=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},Zn),{headers:Object.assign({},Jn)}),t));function tr(e,t,n,r){if(0===t)return;const o=document.createElement("cg-resize");e.container.appendChild(o);const i=e=>{e.preventDefault();const t="touchstart"===e.type?"touchmove":"mousemove",n="touchstart"===e.type?"touchend":"mouseup",r=nr(e),o=parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"));let i=o;const s=function(e,t,n=!1){let r,o=0;return function(...i){const s=this;r&&clearTimeout(r),r=void 0;const a=performance.now()-o;o=performance.now(),n&&a>t?e.apply(s,i):r=setTimeout((()=>{r=void 0,e.apply(s,i)}),t)}}((()=>((e,t={})=>er(e,t).then((e=>{if(e.ok)return e.text();throw e.statusText})))(`/pref/zoom?v=${100+i}`,{method:"post"})),700),a=e=>{const t=nr(e),n=t[0]-r[0]+t[1]-r[1];i=Math.round(Math.min(100,Math.max(0,o+n/10))),document.body.setAttribute("style","--zoom:"+i),window.dispatchEvent(new Event("resize")),s()};document.body.classList.add("resizing"),document.addEventListener(t,a),document.addEventListener(n,(()=>{document.removeEventListener(t,a),document.body.classList.remove("resizing")}),{once:!0})};if(o.addEventListener("touchstart",i,{passive:!1}),o.addEventListener("mousedown",i,{passive:!1}),1===t){const e=e=>o.classList.toggle("none",r?!r(e):e>=2);e(n),lichess.pubsub.on("ply",e)}}function nr(e){var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0}function rr(e,t,n){return{fen:e.fen,orientation:e.orientation,turnColor:e.turnColor,check:e.check,lastMove:e.lastMove,coordinates:0!==t.coords,addPieceZIndex:t.is3d,movable:{free:!1,color:e.movable.color,dests:e.movable.dests,showDests:t.destination,rookCastle:t.rookCastle},draggable:{enabled:t.moveEvent>0,showGhost:t.highlight},selectable:{enabled:1!==t.moveEvent},events:{move:n,insert(e){tr(e,1,0,(e=>0==e)),1==t.coords&&(()=>{const e={blue:"#DEE3E6 #788a94",blue2:"#97b2c7 #546f82",blue3:"#d9e0e6 #315991",canvas:"#d7daeb #547388",wood:"#d8a45b #9b4d0f",wood2:"#a38b5d #6c5017",wood3:"#d0ceca #755839",wood4:"#caaf7d #7b5330",maple:"#e8ceab #bc7944",maple2:"#E2C89F #996633",leather:"#d1d1c9 #c28e16",green:"#FFFFDD #6d8753",brown:"#F0D9B5 #946f51",pink:"#E8E9B7 #ED7272",marble:"#93ab91 #4f644e","blue-marble":"#EAE6DD #7C7F87","green-plastic":"#f2f9bb #59935d",grey:"#b8b8b8 #7d7d7d",metal:"#c9c9c9 #727272",olive:"#b8b19f #6d6655",newspaper:"#fff #8d8d8d",purple:"#9f90b0 #7d4a8d","purple-diag":"#E5DAF0 #957AB0",ic:"#ececec #c1c18e",horsey:"#F0D9B5 #946f51"};for(const t of document.body.className.split(" "))if(t in e){const n=document.documentElement.style,r=e[t].split(" ");n.setProperty("--cg-coord-color-white",r[0]),n.setProperty("--cg-coord-color-black",r[1]),n.setProperty("--cg-coord-shadow","none")}})()}},premovable:{enabled:!1},drawable:{enabled:!0,defaultSnapToValidMove:"0"!=(lichess.storage.get("arrow.snap")||1)},highlight:{lastMove:t.highlight,check:t.highlight},animation:{enabled:!1},disableContextMenu:!0}}var or=function(e){return d("div.puz-board.main-board",[ir(e),e.promotion.view(),e.countdownSeconds()?sr(e.countdownSeconds()):void 0])},ir=function(e){return d("div.cg-wrap",{hook:{insert:function(t){return e.ground(Bn(t.elm,rr(e.isRacing()&&e.isPlayer()?ct(e.run,!0):{fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",orientation:e.run.pov,movable:{color:e.run.pov}},e.pref,e.userMove)))}}})},sr=function(e){return d("div.racer__countdown",[d("div.racer__countdown__lights",[d("light.red",{class:{active:e>4}}),d("light.orange",{class:{active:3==e||4==e}}),d("light.green",{class:{active:e<=2}})]),d("div.racer__countdown__seconds",e)])};function ar(e){var t;return d("div.racer.racer-app.racer--play",{class:Fn(Fn({},Hn(e.run)),(t={},t["racer--"+e.status()]=!0,t))},[Qn(e),or(e),d("div.puz-side",cr(e))])}var cr=function(e){var t=e.trans.noarg;switch(e.status()){case"pre":var n=d("p.racer__pre__message__pov",e.trans(`youPlayThe${"white"==e.run.pov?"White":"Black"}PiecesInAllPuzzles`));return e.race.lobby?[dr(t),d("div.racer__pre__message.racer__pre__message--with-skip",[d("div.racer__pre__message__text",[d("p",e.knowsSkip()?t(e.vm.startsAt?"getReady":"waitingForMorePlayers"):lr(t)),n]),e.knowsSkip()?null:ur(e)]),vr(e)]:[dr(t),d("div.racer__pre__message",[e.raceFull()?void 0:e.isPlayer()?br(e):wr(e),n]),vr(e)];case"racing":var r=Un(e.run,e.end,!1);return e.isPlayer()?[gr(e),d("div.puz-clock",[r,ur(e)]),vr(e)]:[pr(t),d("div.racer__spectating",[d("div.puz-clock",r),e.race.lobby?_r(e):yr(t)]),vr(e)];case"post":var o=e.race.lobby?_r(e):Sr(e),i=d("h2",t("raceComplete"));return e.isPlayer()?[gr(e),d("div.racer__post",[i,kr(e),o]),vr(e)]:[pr(t),d("div.racer__post",[i,o]),vr(e)]}},ur=function(e){return d("button.racer__skip.button.button-red",{class:{disabled:!e.canSkip()},attrs:{title:e.trans.noarg("skipExplanation")},hook:Ae("click",e.skip)},e.trans.noarg("skip"))},lr=function(e){return d("p",e("skipHelp"))},hr=function(){return d("strong","Puzzle Racer")},dr=function(e){return d("div.puz-side__top.puz-side__start",d("div.puz-side__start__text",[hr(),d("span",e("waitingToStart"))]))},pr=function(e){return d("div.puz-side__top.puz-side__start",d("div.puz-side__start__text",[hr(),d("span",e("spectating"))]))},fr=function(e){return"+"+e},mr=function(e){return d("div.puz-side__control",d("a.puz-side__control__flip.button",{class:{active:e.flipped,"button-empty":!e.flipped},attrs:{"data-icon":"B",title:e.trans.noarg("flipBoard")+" (Keyboard: f)"},hook:Ae("click",e.flip)}))},vr=function(e){return d("div.puz-side__table",[mr(e),Wn(g,fr)(e.run)])},gr=function(e){return d("div.puz-side__top.puz-side__solved",[d("div.puz-side__solved__text",e.myScore()||0)])},br=function(e){return d("div.puz-side__link",[d("p",e.trans.noarg("toInviteSomeoneToPlayGiveThisUrl")),d("div",[d("input#racer-url-"+e.race.id+".copyable.autoselect",{attrs:{spellcheck:!1,readonly:"readonly",value:window.location.protocol+"//"+window.location.host+"/racer/"+e.race.id}}),d("button.copy.button",{attrs:{title:"Copy URL","data-rel":"racer-url-"+e.race.id,"data-icon":'"'}})])])},wr=function(e){return d("div.puz-side__join",d("button.button.button-fat",{hook:Ae("click",e.join)},e.trans.noarg("joinTheRace")))},kr=function(e){var t=e.myScore();if(t){var n=e.players(),r=n.filter((function(e){return e.score>t})).length+1;return d("strong.race__post__rank",e.trans("yourRankX",r+"/"+n.length))}},yr=function(e){return d("a.racer__new-race.button.button-fat.button-navaway.disabled",{attrs:{disabled:!0}},e("waitForRematch"))},_r=function(e){return d("form",{attrs:{action:"/racer/lobby",method:"post"}},[d("button.racer__new-race.button.button-navaway"+(e.race.lobby?".button-fat":".button-empty"),e.trans.noarg("nextRace"))])},Sr=function(e){return d("div.racer__post__next",[d("a.racer__rematch.button.button-fat.button-navaway",{attrs:{href:"/racer/"+e.race.id+"/rematch"}},e.trans.noarg("joinRematch")),d("form.racer__post__next__new",{attrs:{action:"/racer",method:"post"}},d("button.racer__post__next__button.button.button-empty",{attrs:{type:"submit"}},e.trans.noarg("createNewGame")))])},Cr=function(e,h){let d,p;const f={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},m=void 0!==h?h:t;for(d=0;d<l.length;++d)for(f[l[d]]=[],p=0;p<e.length;++p){const t=e[p][l[d]];void 0!==t&&f[l[d]].push(t)}function v(e){const t=e.id?"#"+e.id:"",r=e.className?"."+e.className.split(" ").join("."):"";return n(m.tagName(e).toLowerCase()+t+r,{},[],void 0,e)}function g(e,t){return function(){if(0==--t){const t=m.parentNode(e);m.removeChild(t,e)}}}function b(e,t){var n,c;let u,l=e.data;if(void 0!==l){const t=null===(n=l.hook)||void 0===n?void 0:n.init;s(t)&&(t(e),l=e.data)}const h=e.children,d=e.sel;if("!"===d)i(e.text)&&(e.text=""),e.elm=m.createComment(e.text);else if(void 0!==d){const n=d.indexOf("#"),i=d.indexOf(".",n),p=n>0?n:d.length,v=i>0?i:d.length,g=-1!==n||-1!==i?d.slice(0,Math.min(p,v)):d,w=e.elm=s(l)&&s(u=l.ns)?m.createElementNS(u,g,l):m.createElement(g,l);for(p<v&&w.setAttribute("id",d.slice(p+1,v)),i>0&&w.setAttribute("class",d.slice(v+1).replace(/\./g," ")),u=0;u<f.create.length;++u)f.create[u](a,e);if(r(h))for(u=0;u<h.length;++u){const e=h[u];null!=e&&m.appendChild(w,b(e,t))}else o(e.text)&&m.appendChild(w,m.createTextNode(e.text));const k=e.data.hook;s(k)&&(null===(c=k.create)||void 0===c||c.call(k,a,e),k.insert&&t.push(e))}else e.elm=m.createTextNode(e.text);return e.elm}function w(e,t,n,r,o,i){for(;r<=o;++r){const o=n[r];null!=o&&m.insertBefore(e,b(o,i),t)}}function k(e){var t,n;const r=e.data;if(void 0!==r){null===(n=null===(t=null==r?void 0:r.hook)||void 0===t?void 0:t.destroy)||void 0===n||n.call(t,e);for(let t=0;t<f.destroy.length;++t)f.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const n=e.children[t];null!=n&&"string"!=typeof n&&k(n)}}}function y(e,t,n,r){for(var o,i;n<=r;++n){let r,a;const c=t[n];if(null!=c)if(s(c.sel)){k(c),r=f.remove.length+1,a=g(c.elm,r);for(let e=0;e<f.remove.length;++e)f.remove[e](c,a);const e=null===(i=null===(o=null==c?void 0:c.data)||void 0===o?void 0:o.hook)||void 0===i?void 0:i.remove;s(e)?e(c,a):a()}else m.removeChild(e,c.elm)}}function _(e,t,n){var r,o,a,l,h;const d=null===(r=t.data)||void 0===r?void 0:r.hook;null===(o=null==d?void 0:d.prepatch)||void 0===o||o.call(d,e,t);const p=t.elm=e.elm,v=e.children,g=t.children;if(e!==t){if(void 0!==t.data){for(let n=0;n<f.update.length;++n)f.update[n](e,t);null===(l=null===(a=t.data.hook)||void 0===a?void 0:a.update)||void 0===l||l.call(a,e,t)}i(t.text)?s(v)&&s(g)?v!==g&&function(e,t,n,r){let o,s,a,l,h=0,d=0,p=t.length-1,f=t[0],v=t[p],g=n.length-1,k=n[0],S=n[g];for(;h<=p&&d<=g;)null==f?f=t[++h]:null==v?v=t[--p]:null==k?k=n[++d]:null==S?S=n[--g]:c(f,k)?(_(f,k,r),f=t[++h],k=n[++d]):c(v,S)?(_(v,S,r),v=t[--p],S=n[--g]):c(f,S)?(_(f,S,r),m.insertBefore(e,f.elm,m.nextSibling(v.elm)),f=t[++h],S=n[--g]):c(v,k)?(_(v,k,r),m.insertBefore(e,v.elm,f.elm),v=t[--p],k=n[++d]):(void 0===o&&(o=u(t,h,p)),s=o[k.key],i(s)?m.insertBefore(e,b(k,r),f.elm):(a=t[s],a.sel!==k.sel?m.insertBefore(e,b(k,r),f.elm):(_(a,k,r),t[s]=void 0,m.insertBefore(e,a.elm,f.elm))),k=n[++d]);(h<=p||d<=g)&&(h>p?(l=null==n[g+1]?null:n[g+1].elm,w(e,l,n,d,g,r)):y(e,t,h,p))}(p,v,g,n):s(g)?(s(e.text)&&m.setTextContent(p,""),w(p,null,g,0,g.length-1,n)):s(v)?y(p,v,0,v.length-1):s(e.text)&&m.setTextContent(p,""):e.text!==t.text&&(s(v)&&y(p,v,0,v.length-1),m.setTextContent(p,t.text)),null===(h=null==d?void 0:d.postpatch)||void 0===h||h.call(d,e,t)}}return function(e,t){let n,r,o;const i=[];for(n=0;n<f.pre.length;++n)f.pre[n]();for(function(e){return void 0!==e.sel}(e)||(e=v(e)),c(e,t)?_(e,t,i):(r=e.elm,o=m.parentNode(r),b(t,i),null!==o&&(m.insertBefore(o,t.elm,m.nextSibling(r)),y(o,[e],0,0))),n=0;n<i.length;++n)i[n].data.hook.insert(i[n]);for(n=0;n<f.post.length;++n)f.post[n]();return t}}([v,f]);return window.Chessground=Bn,e.start=function(e){var t,n=document.querySelector(".racer-app"),r=new ht(e,(function(){t=Cr(t,ar(r))})),o=ar(r);n.innerHTML="",t=Cr(n,o),function(){if("ontouchstart"in window)return;let e,t;const n=n=>{e=n.pageX,t=n.pageY};let r={};$("#topnav.hover").each((function(){const o=$(this).removeClass("hover"),i=()=>o.toggleClass("hover"),s=()=>{Math.sqrt((r.pX-e)*(r.pX-e)+(r.pY-t)*(r.pY-t))<8?(o.off(r.event,n),delete r.timeoutId,r.isActive=!0,i()):(r.pX=e,r.pY=t,r.timeoutId=setTimeout(s,200))},a=function(e){r.timeoutId&&(r.timeoutId=clearTimeout(r.timeoutId));const t=r.event="mousemove";if("mouseover"==e.type){if(r.isActive||e.buttons)return;r.pX=e.pageX,r.pY=e.pageY,o.off(t,n).on(t,n),r.timeoutId=setTimeout(s,200)}else{if(!r.isActive)return;o.off(t,n),r={},i()}};o.on("mouseover",a).on("mouseleave",a)}))}(),$("script").remove()},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
