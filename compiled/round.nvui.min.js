!function(){"use strict";function e(e,t,n,o,r){return{sel:e,data:t,children:n,text:o,elm:r,key:void 0===t?void 0:t.key}}const t=Array.isArray;function n(e){return"string"==typeof e||"number"==typeof e}function o(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let e=0;e<t.length;++e){const n=t[e].data;void 0!==n&&o(n,t[e].children,t[e].sel)}}function r(r,i,s){let a,c,l,u={};if(void 0!==s?(null!==i&&(u=i),t(s)?a=s:n(s)?c=s:s&&s.sel&&(a=[s])):null!=i&&(t(i)?a=i:n(i)?c=i:i&&i.sel?a=[i]:u=i),void 0!==a)for(l=0;l<a.length;++l)n(a[l])&&(a[l]=e(void 0,void 0,void 0,a[l],void 0));return"s"!==r[0]||"v"!==r[1]||"g"!==r[2]||3!==r.length&&"."!==r[3]&&"#"!==r[3]||o(u,a,r),e(r,u,a,c,void 0)}function i(e){return e.charCodeAt(0)-97+8*(e.charCodeAt(1)-49)}function s(e,t){const n=7&e,o=7&t,r=e>>3,i=t>>3;return Math.max(Math.abs(n-o),Math.abs(r-i))}function a(e){return e===e.toLowerCase()}const c=[8,1,-8,-1],l=[9,-9,7,-7],u=c.concat(l);function h(e,t,n){const o=[];return t.forEach((function(t){for(let r=e+t;r>=0&&r<64&&1===s(r,r-t)&&(o.push(r),!n.pieces[r]);r+=t);})),o}function d(e,t){if(t.includes("@"))return function(e){return"P"===e[0]?e.slice(1):e}(t);const n=function(e){return[e.slice(0,2),e.slice(2,4),e.slice(4,5)]}(t),o=i(n[0]),r=i(n[1]),d=e.pieces[o],p=e.pieces[r],f=e.pieces[o].toLowerCase();if("p"===f){let e;return e=t[0]===t[2]?n[1]:t[0]+"x"+n[1],n[2]&&(e+="="+n[2].toUpperCase()),e}if("k"==f&&(p&&a(d)===a(p)||s(o,r)>1))return r<o?"O-O-O":"O-O";let m=f.toUpperCase(),g=[];var b;"k"==f?g=[(b=r)-1,b-9,b-8,b-7,b+1,b+9,b+8,b+7].filter((function(e){return e>=0&&e<64&&1===s(b,e)})):"n"==f?g=function(e){return[e+17,e+15,e+10,e+6,e-6,e-10,e-15,e-17].filter((function(t){return t>=0&&t<64&&s(e,t)<=2}))}(r):"r"==f?g=h(r,c,e):"b"==f?g=h(r,l,e):"q"==f&&(g=h(r,u,e));let v=!1,k=!1;for(let t=0;t<g.length;t++)g[t]!==o&&e.pieces[g[t]]===d&&(o>>3==g[t]>>3&&(k=!0),(7&o)==(7&g[t])?v=!0:k=!0);return k&&(m+=t[0]),v&&(m+=t[1]),p&&(m+="x"),m+=n[1],m}function p(e,t){const n=function(e){const t=e.split(" "),n={pieces:{},turn:"w"===t[1]};return t[0].split("/").slice(0,8).forEach(((e,t)=>{let o=0;e.split("").forEach((e=>{if("~"==e)return;const r=parseInt(e,10);r?o+=r:(n.pieces[8*(7-t)+o]=e,o++)}))})),n}(e),o={};return t.forEach((function(e){const t=d(n,e);o[t]=e,t.includes("x")&&(o[t.replace("x","")]=e)})),o}const f=["white","black"],m=["a","b","c","d","e","f","g","h"],g=["1","2","3","4","5","6","7","8"],b=[...g].reverse(),v=Array.prototype.concat(...m.map((e=>g.map((t=>e+t))))),k=e=>v[8*e[0]+e[1]],w=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],y=v.map(w);const C=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},S=e=>"white"===e?"black":"white",E=(e,t)=>{const n=e[0]-t[0],o=e[1]-t[1];return n*n+o*o},q=(e,t)=>e.role===t.role&&e.color===t.color,M=(e,t,n,o)=>[(t?e[0]:7-e[0])*n,(t?7-e[1]:e[1])*o],x=e=>{const t=e.width/8,n=e.height/8;return(e,o)=>M(e,o,t,n)},R=(e,t)=>M(e,t,100,100),P=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},A=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},O=(e,t)=>{e.style.visibility=t?"visible":"hidden"},T=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},L=e=>2===e.buttons||2===e.button,D=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function N(e,t,n){const o=w(e);return t||(o[0]=7-o[0],o[1]=7-o[1]),[n.left+n.width*o[0]/8+n.width/16,n.top+n.height*(7-o[1])/8+n.height/16]}const B=e=>({attrs:{"data-icon":e}}),K=e=>{if(e)return"@"===e[1]?[e.slice(2,4)]:[e.slice(0,2),e.slice(2,4)]},I=e=>({insert(t){e(t.elm)}}),z=(e,t,n,o=!0)=>I((r=>{r.addEventListener(e,(e=>{t(e),n&&n()}),{passive:o})}));function F(e){const t=new Map;if(!e)return t;if("string"==typeof e)for(const n of e.split(" "))t.set(n.slice(0,2),n.slice(2).match(/.{2}/g));else for(const n in e)t.set(n,e[n].match(/.{2}/g));return t}const U=25,_=30;function H(e){return e.game.status.id>=_}function W(e){return e.game.status.id===U}const j=e=>e.game.status.id<U&&!Z(e),G=e=>j(e)&&!e.player.spectator,Q=e=>(e=>e.game.turns-(e.game.startedAtTurn||0))(e)>1,V=e=>j(e)&&!Q(e)&&!(e=>!!e.tournament||!!e.simul||!!e.swiss)(e),Y=e=>j(e)&&e.takebackable&&Q(e)&&!e.player.proposingTakeback&&!e.opponent.proposingTakeback,X=e=>j(e)&&!V(e),Z=e=>"import"===e.game.source;function J(e,t,n){return(n?"/embed/":"/")+(e.game?e.game.id:e)+(t?"/"+t:"")}function ee(e){const t=e.data,n=J(t,"racingKings"===(o=t).game.variant.key?"white":o.player.color)+"#"+e.ply;var o;return(e=>Z(e)||H(e)||W(e)&&Q(e))(t)?r("a.fbt",{attrs:{href:n},hook:z("click",(e=>{location.pathname===n.split("#")[0]&&location.reload()}))},e.noarg("analysis")):null}function te(e,t,n,o,i,s){const a=()=>!t||t(e.data);return r("button.fbt."+i,{attrs:{disabled:!a(),title:e.noarg(o)},hook:z("click",(t=>{a()&&(s?s():e.socket.sendLoading(i))}))},[r("span","offerDraw"==o?["½"]:e.nvui?[e.noarg(o)]:B(n))])}function ne(e){const t=e.opponentGone();return!0===t?r("div.suggestion",[r("p",{hook:ve},e.noarg("opponentLeftChoices")),r("button.button",{hook:z("click",(()=>e.socket.sendLoading("resign-force")))},e.noarg("forceResignation")),r("button.button",{hook:z("click",(()=>e.socket.sendLoading("draw-force")))},e.noarg("forceDraw"))]):t?r("div.suggestion",[r("p",e.trans.vdomPlural("opponentLeftCounter",t,r("strong",""+t)))]):null}const oe=(e,t)=>r("button.fbt.no",{attrs:{title:e.noarg("cancel"),"data-icon":"L"},hook:z("click",(()=>t(!1)))}),re=e=>r("div.act-confirm",[r("button.fbt.yes",{attrs:{title:e.noarg("resign"),"data-icon":"b"},hook:z("click",(()=>e.resign(!0)))}),oe(e,e.resign)]),ie=e=>r("div.act-confirm",[r("button.fbt.yes.draw-yes",{attrs:{title:e.noarg("offerDraw")},hook:z("click",(()=>e.offerDraw(!0)))},r("span","½")),oe(e,e.offerDraw)]);function se(e){return e.data.game.threefold?r("div.suggestion",[r("p",{hook:ve},e.noarg("threefoldRepetition")),r("button.button",{hook:z("click",(()=>e.socket.sendLoading("draw-claim")))},e.noarg("claimADraw"))]):null}function ae(e){return e.data.player.offeringDraw?r("div.pending",[r("p",e.noarg("drawOfferSent"))]):null}function ce(e){return e.data.opponent.offeringDraw?r("div.negotiation.draw",[he(e,(()=>e.socket.sendLoading("draw-no"))),r("p",e.noarg("yourOpponentOffersADraw")),ue(e,"draw-yes",(()=>e.socket.sendLoading("draw-yes")))]):null}function le(e){return e.data.player.proposingTakeback?r("div.pending",[r("p",e.noarg("takebackPropositionSent")),r("button.button",{hook:z("click",(()=>e.socket.sendLoading("takeback-no")))},e.noarg("cancel"))]):null}function ue(e,t,n,o="accept"){const i=e.noarg(o);return e.nvui?r("button."+t,{hook:z("click",n)},i):r("a.accept",{attrs:{"data-icon":"E",title:i},hook:z("click",n)})}function he(e,t,n="decline"){const o=e.noarg(n);return e.nvui?r("button",{hook:z("click",t)},o):r("a.decline",{attrs:{"data-icon":"L",title:o},hook:z("click",t)})}function de(e){return e.data.opponent.proposingTakeback?r("div.negotiation.takeback",[he(e,(()=>e.socket.sendLoading("takeback-no"))),r("p",e.noarg("yourOpponentProposesATakeback")),ue(e,"takeback-yes",e.takebackYes)]):null}function pe(e){var t;const n=e.data;return(null===(t=n.tournament)||void 0===t?void 0:t.running)?r("div.follow-up",[r("a.text.fbt.strong.glowing",{attrs:{"data-icon":"G",href:"/tournament/"+n.tournament.id},hook:z("click",e.setRedirecting)},e.noarg("backToTournament")),r("form",{attrs:{method:"post",action:"/tournament/"+n.tournament.id+"/withdraw"}},[r("button.text.fbt.weak",B("Z"),"Pause")]),ee(e)]):void 0}function fe(e){var t;const n=e.data;return(null===(t=n.swiss)||void 0===t?void 0:t.running)?r("div.follow-up",[r("a.text.fbt.strong.glowing",{attrs:{"data-icon":"G",href:"/swiss/"+n.swiss.id},hook:z("click",e.setRedirecting)},e.noarg("backToTournament")),ee(e)]):void 0}function me(e){return t=e.data,G(t)&&t.moretimeable&&(t.clock||t.correspondence&&t.correspondence[t.opponent.color]<t.correspondence.increment-3600)?r("a.moretime",{attrs:{title:e.data.clock?e.trans("giveNbSeconds",e.data.clock.moretime):e.noarg("giveMoreTime"),"data-icon":"O"},hook:z("click",e.socket.moreTime)}):null;var t}function ge(e){const t=e.data,n=!t.game.rematch&&(H(t)||W(t))&&!t.tournament&&!t.simul&&!t.swiss&&!t.game.boosted,o=(H(t)||W(t))&&("lobby"===t.game.source||"pool"===t.game.source),i=e.challengeRematched?[r("div.suggestion.text",{hook:ve},e.noarg("rematchOfferSent"))]:n||t.game.rematch?function(e){const t=e.data,n=!!t.player.offeringRematch,o=!!t.opponent.offeringRematch,i=e.noarg;return[o?r("button.rematch-decline",{attrs:{"data-icon":"L",title:i("decline")},hook:z("click",(()=>e.socket.send("rematch-no")))},e.nvui?i("decline"):""):null,r("button.fbt.rematch.white",{class:{me:n,glowing:o,disabled:!n&&!(t.opponent.onGame||!t.clock&&t.player.user&&t.opponent.user)},attrs:{title:o?i("yourOpponentWantsToPlayANewGameWithYou"):n?i("rematchOfferSent"):""},hook:z("click",(t=>{const n=e.data;n.game.rematch?location.href=J(n.game.rematch,n.opponent.color):n.player.offeringRematch?(n.player.offeringRematch=!1,e.socket.send("rematch-no")):n.opponent.onGame?(n.player.offeringRematch=!0,e.socket.send("rematch-yes")):t.currentTarget.classList.contains("disabled")||e.challengeRematch()}),e.redraw)},[n?r("div.spinner",{"aria-label":"loading"},[r("svg",{attrs:{viewBox:"0 0 40 40"}},[r("circle",{attrs:{cx:20,cy:20,r:18,fill:"none"}})])]):r("span",i("rematch"))])]}(e):[];return r("div.follow-up",[...i,t.tournament?r("a.fbt",{attrs:{href:"/tournament/"+t.tournament.id}},e.noarg("viewTournament")):null,t.swiss?r("a.fbt",{attrs:{href:"/swiss/"+t.swiss.id}},e.noarg("viewTournament")):null,o?r("a.fbt",{attrs:{href:"pool"===t.game.source?(s=t.clock,a=t.opponent.user,"/#pool/"+s.initial/60+"+"+s.increment+(a?"/"+a.id:"")):"/?hook_like="+t.game.id}},e.noarg("newOpponent")):null,ee(e)]);var s,a}function be(e){const t=e.data,n=[t.game.rematch?r("a.fbt.text",{attrs:{href:`/${t.game.rematch}/${t.opponent.color}`}},e.noarg("viewRematch")):null,t.tournament?r("a.fbt",{attrs:{href:"/tournament/"+t.tournament.id}},e.noarg("viewTournament")):null,t.swiss?r("a.fbt",{attrs:{href:"/swiss/"+t.swiss.id}},e.noarg("viewTournament")):null,ee(e)];return n.find((e=>!!e))?r("div.follow-up",n):null}const ve=I((e=>lichess.pubsub.emit("round.suggestion",e.textContent)));function ke(e,t,n){const o=e.clock,i=o.millisOf(t.color),s=e.data.player.color===t.color,a=t.color===o.times.activeColor,c=e=>{const n=o.elements[t.color],r=o.millisOf(t.color),i=t.color===o.times.activeColor;n.time=e,n.clock=e.parentElement,e.innerHTML=function(e,t,n,o){const r=new Date(e);if(o)return(e>=36e5?Math.floor(e/36e5)+"H:":"")+r.getUTCMinutes()+"M:"+r.getUTCSeconds()+"S";const i=r.getUTCMilliseconds(),s=n&&i<500?Ce:ye,a=we(r.getUTCMinutes())+s+we(r.getUTCSeconds());if(e>=36e5){return we(Math.floor(e/36e5))+ye+a}if(t){let t=Math.floor(i/100).toString();return!n&&e<1e3&&(t+="<huns>"+Math.floor(i/10)%10+"</huns>"),a+"<tenths><sep>.</sep>"+t+"</tenths>"}return a}(r,o.showTenths(r),i,o.opts.nvui)},l={insert:e=>c(e.elm),postpatch:(e,t)=>c(t.elm)};return r("div.rclock.rclock-"+n,{class:{outoftime:i<=0,running:a,emerg:i<o.emergMs}},o.opts.nvui?[r("div.time",{attrs:{role:"timer"},hook:l})]:[o.showBar&&Q(e.data)?Se(e,t.color):void 0,r("div.time",{class:{hour:i>36e5},hook:l}),qe(e,t.color,n),s?Me(e):me(e),xe(e,t.color,n)])}const we=e=>(e<10?"0":"")+e,ye="<sep>:</sep>",Ce='<sep class="low">:</sep>';function Se(e,t){const n=e.clock,o=e=>{if(void 0!==e.animate){let o=n.elements[t].barAnim;void 0!==o&&o.effect&&o.effect.target===e||(o=e.animate([{transform:"scale(1)"},{transform:"scale(0, 1)"}],{duration:n.barTime,fill:"both"}),n.elements[t].barAnim=o);const r=n.millisOf(t);o.currentTime=n.barTime-r,t===n.times.activeColor?r>0&&o.play():o.pause()}else n.elements[t].bar=e,e.style.transform="scale("+n.timeRatio(n.millisOf(t))+",1)"};return r("div.bar",{class:{berserk:!!e.goneBerserk[t]},hook:{insert:e=>o(e.elm),postpatch:(e,t)=>o(t.elm)}})}function Ee(e,t){return!!e.goneBerserk[t]&&e.data.game.turns<=1&&j(e.data)}function qe(e,t,n){return Ee(e,t)?r("div.berserked."+n,B("`")):null}function Me(e){var t;if((t=e.data).tournament&&t.tournament.berserkable&&G(t)&&!Q(t)&&!e.goneBerserk[e.data.player.color])return r("button.fbt.go-berserk",{attrs:{title:"GO BERSERK! Half the time, no increment, bonus point","data-icon":"`"},hook:z("click",e.goBerserk)})}function xe(e,t,n){var o,i;const s=e.data,a=(null===(o=s.tournament)||void 0===o?void 0:o.ranks)||(null===(i=s.swiss)||void 0===i?void 0:i.ranks);return a&&!Ee(e,t)?r("div.tour-rank."+n,{attrs:{title:"Current tournament rank"}},"#"+a[t]):null}const Re=(e,t)=>(e/Math.pow(10,t)).toFixed(t).substr(2),Pe=e=>`<b>${e}</b>`;function Ae(e,t,n,o,i){const s=e.millisOf(n),a=e=>{e.innerHTML=function(e,t){const n=new Date(t),o=Re(n.getUTCMinutes(),2),r=Re(n.getSeconds(),2);let i,s="";if(t>=864e5){const t=n.getUTCDate()-1;i=n.getUTCHours(),s+=(1===t?e("oneDay"):e.plural("nbDays",t))+" ",0!==i&&(s+=e.plural("nbHours",i))}else t>=36e5?(i=n.getUTCHours(),s+=Pe(Re(i,2))+":"+Pe(o)):s+=Pe(o)+":"+Pe(r);return s}(t,s)},c=e.root.data.player.color===n;return r("div.rclock.rclock-correspondence.rclock-"+o,{class:{outoftime:s<=0,running:i===n}},[e.data.showBar?r("div.bar",[r("span",{attrs:{style:`width: ${e.timePercent(n)}%`}})]):null,r("div.time",{hook:{insert:e=>a(e.elm),postpatch:(e,t)=>a(t.elm)}}),c?null:me(e.root)])}const Oe=e=>e.steps[0].ply,Te=e=>$e(e).ply,$e=e=>e.steps[e.steps.length-1],Le=(e,t)=>e.steps[t-Oe(e)];let De="init";function Ne(){return"string"==typeof De&&("init"==De&&(window.addEventListener("resize",(()=>{De="rec"})),navigator.userAgent.indexOf("Edge/")>-1&&requestAnimationFrame((()=>{De="rec"}))),De=!!getComputedStyle(document.body).getPropertyValue("--col1")),De}function Be(e,t){let n,o=0;return function(...r){const i=this,s=performance.now()-o;function a(){n=void 0,o=performance.now(),t.apply(i,r)}n&&clearTimeout(n),s>e?a():n=setTimeout(a,e-s)}}function Ke(e){const t=e.trans.noarg,n=e.data;switch(n.game.status.name){case"started":return t("playingRightNow");case"aborted":return t("gameAborted");case"mate":return t("checkmate");case"resign":return t("white"==n.game.winner?"blackResigned":"whiteResigned");case"stalemate":return t("stalemate");case"timeout":switch(n.game.winner){case"white":return t("blackLeftTheGame");case"black":return t("whiteLeftTheGame")}return t("draw");case"draw":return t("draw");case"outoftime":return`${n.game.turns%2==0?t("whiteTimeOut"):t("blackTimeOut")}${n.game.winner?"":` • ${t("draw")}`}`;case"noStart":return("white"==n.game.winner?"Black":"White")+" didn't move";case"cheat":return t("cheatDetected");case"variantEnd":switch(n.game.variant.key){case"kingOfTheHill":return t("kingInTheCenter");case"threeCheck":return t("threeChecks")}return t("variantEnding");case"unknownFinish":return"Finished";default:return n.game.status.name}}const Ie="u8t",ze="i5z".toUpperCase(),Fe=Be(100,((e,t)=>window.requestAnimationFrame((()=>{if(t.data.steps.length<7)return;let n;if(t.ply<3)n=0;else if(t.ply==Te(t.data))n=99999;else{const t=e.querySelector(".a1t");t&&(n=Ne()?t.offsetLeft-e.offsetWidth/2+t.offsetWidth/2:t.offsetTop-e.offsetHeight/2+t.offsetHeight/2)}"number"==typeof n&&(99999==n?e.scrollLeft=e.scrollTop=n:Ne()?e.scrollLeft=n:e.scrollTop=n)}))));function Ue(e,t,n,o){return e?r(Ie,{class:{a1t:e.ply===t}},["P"===e.san[0]?e.san.slice(1):e.san,o.has(e.ply)?r("draw",{attrs:{title:"Draw offer"}},"½?"):void 0]):n?r(Ie,"…"):void 0}function _e(e){let t;if(H(e.data))switch(e.data.game.winner){case"white":t="1-0";break;case"black":t="0-1";break;default:t="½-½"}if(t||W(e.data)){const n=e.data.game.winner;return r("div.result-wrap",[r("p.result",t||""),r("p.status",{hook:I((()=>{e.autoScroll?e.autoScroll():setTimeout((()=>e.autoScroll()),200)}))},[Ke(e),n?" • "+e.noarg(n+"IsVictorious"):""])])}}function He(e){const t=e.data.forecastCount;return H(n=e.data)||j(n)&&(!n.clock||!G(n))?r("a.fbt.analysis",{class:{text:!!t},attrs:{title:e.noarg("analysis"),href:J(e.data,e.data.player.color)+"/analysis#"+e.ply,"data-icon":"A"}},t?[""+t]:[]):void 0;var n}function We(e){const t=e.data,n=Oe(t),o=Te(t);return r("div.buttons",{hook:z("mousedown",(n=>{const o=n.target,r=parseInt(o.getAttribute("data-ply")||"");if(isNaN(r)){"flip"===(o.getAttribute("data-act")||o.parentNode.getAttribute("data-act"))&&(t.tv?location.href="/tv/"+t.tv.channel+(t.tv.flip?"":"?flip=1"):t.player.spectator?location.href=J(t,t.opponent.color):e.flipNow())}else e.userJump(r)}),e.redraw)},[r("button.fbt.flip",{class:{active:e.flip},attrs:{title:e.noarg("flipBoard"),"data-act":"flip","data-icon":"B"}}),...[["W",n],["Y",e.ply-1],["X",e.ply+1],["V",o]].map(((t,i)=>{const s=e.ply!==t[1]&&t[1]>=n&&t[1]<=o;return r("button.fbt",{class:{glowing:3===i&&e.isLate()},attrs:{disabled:!s,"data-icon":t[0],"data-ply":s?t[1]:"-"}})})),He(e)||r("div.noop")])}function je(e,t){return j(e)&&0===e.game.turns&&!e.player.spectator?r("div.message",B(""),[r("div",[t("white"===e.player.color?"youPlayTheWhitePieces":"youPlayTheBlackPieces"),..."white"===e.player.color?[r("br"),r("strong",t("itsYourTurn"))]:[]])]):null}function Ge(e,t,n,o){return o?null:r("button.fbt",{attrs:{disabled:o,"data-icon":n,"data-ply":e.ply+t},hook:z("mousedown",(n=>{n.preventDefault(),e.userJump(e.ply+t),e.redraw()}))})}function Qe(e){const t=e.data,n=e.replayEnabledByPref()&&r("l4x",{hook:I((t=>{t.addEventListener("mousedown",(t=>{let n=t.target,o=-2;if(n.tagName===Ie.toUpperCase())for(;n=n.previousSibling;)if(o++,n.tagName===ze){e.userJump(2*parseInt(n.textContent||"")+o),e.redraw();break}})),e.autoScroll=()=>Fe(t,e),e.autoScroll()}))},function(e){const t=e.data.steps,n=Oe(e.data),o=Te(e.data),i=new Set(e.data.game.drawOffers||[]);if(void 0===o)return[];const s=[];let a=1;n%2==1&&(s.push([null,t[1]]),a=2);for(let e=a;e<t.length;e+=2)s.push([t[e],t[e+1]]);const c=[],l=e.ply;for(let e=0;e<s.length;e++)c.push(r("i5z",e+1+"")),c.push(Ue(s[e][0],l,!0,i)),c.push(Ue(s[e][1],l,!1,i));return c.push(_e(e)),c}(e));return e.nvui?void 0:r("rm6",[We(e),je(t,e.trans.noarg)||(n?Ne()?r("div.col1-moves",[Ge(e,-1,"Y",e.ply==Oe(t)),n,Ge(e,1,"X",e.ply==Te(t))]):n:_e(e))])}const Ve=e=>e.loading||e.redirecting,Ye=()=>r("i.ddloader"),Xe=(e,t)=>[Qe(e),t.find((e=>!!e))?r("div.rcontrols",t):null],Ze=e=>Xe(e,[Ve(e)?Ye():pe(e)||fe(e)||ge(e)]),Je=e=>Xe(e,[Ve(e)?Ye():j(e.data)?void 0:be(e)]),et=e=>{const t=e.data,n=Ve(e),o=function(e){return e.moveToSubmit||e.dropToSubmit?r("div.negotiation.move-confirm",[he(e,(()=>e.submitMove(!1)),"cancel"),r("p",e.noarg("confirmMove")),ue(e,"confirm-yes",(()=>e.submitMove(!0)))]):void 0}(e),i=n||o?[]:[V(t)?te(e,void 0,"L","abortGame","abort"):te(e,Y,"i","proposeATakeback","takeback-yes",e.takebackYes),e.drawConfirm?ie(e):te(e,e.canOfferDraw,"2","offerDraw","draw-yes",(()=>e.offerDraw(!0))),e.resignConfirm?re(e):te(e,X,"b","resign","resign",(()=>e.resign(!0))),He(e)],s=n?[Ye()]:o?[o]:[ne(e),se(e),ae(e),ce(e),le(e),de(e)];return[Qe(e),r("div.rcontrols",[...s,r("div.ricons",{class:{confirm:!(!e.drawConfirm&&!e.resignConfirm)}},i)])]};function tt(e,t){return Math.abs(e-t)}const nt=(e,t,n,o)=>{const r=tt(e,n),i=tt(t,o);return 1===r&&2===i||2===r&&1===i},ot=(e,t,n,o)=>tt(e,n)===tt(t,o),rt=(e,t,n,o)=>e===n||t===o,it=(e,t,n,o)=>ot(e,t,n,o)||rt(e,t,n,o);function st(e,t,n){const o=e.get(t);if(!o)return[];const r=w(t),i=o.role,s="pawn"===i?(a=o.color,(e,t,n,o)=>tt(e,n)<2&&("white"===a?o===t+1||t<=1&&o===t+2&&e===n:o===t-1||t>=6&&o===t-2&&e===n)):"knight"===i?nt:"bishop"===i?ot:"rook"===i?rt:"queen"===i?it:function(e,t,n){return(o,r,i,s)=>tt(o,i)<2&&tt(r,s)<2||n&&r===s&&r===("white"===e?0:7)&&(4===o&&(2===i&&t.includes(0)||6===i&&t.includes(7))||t.includes(i))}(o.color,function(e,t){const n="white"===t?"1":"8",o=[];for(const[r,i]of e)r[1]===n&&i.color===t&&"rook"===i.role&&o.push(w(r)[0]);return o}(e,o.color),n);var a;return y.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&s(r[0],r[1],e[0],e[1]))).map(k)}function at(e,...t){e&&setTimeout((()=>e(...t)),1)}function ct(e){e.premovable.current&&(e.premovable.current=void 0,at(e.premovable.events.unset))}function lt(e){const t=e.predroppable;t.current&&(t.current=void 0,at(t.events.unset))}function ut(e,t,n){const o=e.pieces.get(t),r=e.pieces.get(n);if(t===n||!o)return!1;const i=r&&r.color!==o.color?r:void 0;return n===e.selected&&bt(e),at(e.events.move,t,n,i),function(e,t,n){if(!e.autoCastle)return!1;const o=e.pieces.get(t);if(!o||"king"!==o.role)return!1;const r=w(t),i=w(n);if(0!==r[1]&&7!==r[1]||r[1]!==i[1])return!1;4!==r[0]||e.pieces.has(n)||(6===i[0]?n=k([7,i[1]]):2===i[0]&&(n=k([0,i[1]])));const s=e.pieces.get(n);return!(!s||s.color!==o.color||"rook"!==s.role||(e.pieces.delete(t),e.pieces.delete(n),r[0]<i[0]?(e.pieces.set(k([6,i[1]]),o),e.pieces.set(k([5,i[1]]),s)):(e.pieces.set(k([2,i[1]]),o),e.pieces.set(k([3,i[1]]),s)),0))}(e,t,n)||(e.pieces.set(n,o),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,at(e.events.change),i||!0}function ht(e,t,n,o){if(e.pieces.has(n)){if(!o)return!1;e.pieces.delete(n)}return at(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,at(e.events.change),e.movable.dests=void 0,e.turnColor=S(e.turnColor),!0}function dt(e,t,n){const o=ut(e,t,n);return o&&(e.movable.dests=void 0,e.turnColor=S(e.turnColor),e.animation.current=void 0),o}function pt(e,t,n){if(kt(e,t,n)){const o=dt(e,t,n);if(o){const r=e.hold.stop();bt(e);const i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==o&&(i.captured=o),at(e.movable.events.after,t,n,i),!0}}else if(function(e,t,n){return t!==n&&wt(e,t)&&st(e.pieces,t,e.premovable.castle).includes(n)}(e,t,n))return function(e,t,n,o){lt(e),e.premovable.current=[t,n],at(e.premovable.events.set,t,n,o)}(e,t,n,{ctrlKey:e.stats.ctrlKey}),bt(e),!0;return bt(e),!1}function ft(e,t,n,o){const r=e.pieces.get(t);r&&(function(e,t,n){const o=e.pieces.get(t);return!(!o||t!==n&&e.pieces.has(n)||"both"!==e.movable.color&&(e.movable.color!==o.color||e.turnColor!==o.color))}(e,t,n)||o)?(e.pieces.delete(t),ht(e,r,n,o),at(e.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&function(e,t,n){const o=e.pieces.get(t),r=e.pieces.get(n);return!!o&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==o.role||"1"!==n[1]&&"8"!==n[1])&&e.movable.color===o.color&&e.turnColor!==o.color}(e,t,n)?function(e,t,n){ct(e),e.predroppable.current={role:t,key:n},at(e.predroppable.events.set,t,n)}(e,r.role,n):(ct(e),lt(e)),e.pieces.delete(t),bt(e)}function mt(e,t,n){if(at(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return bt(e),void e.hold.cancel();if((e.selectable.enabled||n)&&e.selected!==t&&pt(e,e.selected,t))return void(e.stats.dragged=!1)}(vt(e,t)||wt(e,t))&&(gt(e,t),e.hold.start())}function gt(e,t){e.selected=t,wt(e,t)?e.premovable.dests=st(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function bt(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function vt(e,t){const n=e.pieces.get(t);return!!n&&("both"===e.movable.color||e.movable.color===n.color&&e.turnColor===n.color)}function kt(e,t,n){var o,r;return t!==n&&vt(e,t)&&(e.movable.free||!!(null===(r=null===(o=e.movable.dests)||void 0===o?void 0:o.get(t))||void 0===r?void 0:r.includes(n)))}function wt(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function yt(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],o=t[1];let r=!1;if(kt(e,n,o)){const t=dt(e,n,o);if(t){const i={premove:!0};!0!==t&&(i.captured=t),at(e.movable.events.after,n,o,i),r=!0}}return ct(e),r}function Ct(e){ct(e),lt(e),bt(e)}function St(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Ct(e)}function Et(e,t,n){let o=Math.floor(8*(e[0]-n.left)/n.width);t||(o=7-o);let r=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(r=7-r),o>=0&&o<8&&r>=0&&r<8?k([o,r]):void 0}function qt(e){return"white"===e.orientation}const Mt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",xt={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Rt={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Pt(e){"start"===e&&(e=Mt);const t=new Map;let n=7,o=0;for(const r of e)switch(r){case" ":return t;case"/":if(--n,n<0)return t;o=0;break;case"~":{const e=t.get(k([o,n]));e&&(e.promoted=!0);break}default:{const e=r.charCodeAt(0);if(e<57)o+=e-48;else{const e=r.toLowerCase();t.set(k([o,n]),{role:xt[e],color:r===e?"black":"white"}),++o}}}return t}function At(e,t){var n,o;if((null===(n=t.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(o=t.drawable)||void 0===o?void 0:o.autoShapes)&&(e.drawable.autoShapes=[]),Ot(e,t),t.fen&&(e.pieces=Pt(t.fen),e.drawable.shapes=[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[n,o]of e.pieces)"king"===o.role&&o.color===t&&(e.check=n)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&gt(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",n="e"+t,o=e.movable.dests.get(n),r=e.pieces.get(n);if(!o||!r||"king"!==r.role)return;e.movable.dests.set(n,o.filter((e=>!(e==="a"+t&&o.includes("c"+t)||e==="h"+t&&o.includes("g"+t)))))}}function Ot(e,t){for(const n in t)Tt(e[n])&&Tt(t[n])?Ot(e[n],t[n]):e[n]=t[n]}function Tt(e){return"object"==typeof e}function $t(e,t){return t.animation.enabled?function(e,t){const n=new Map(t.pieces),o=e(t),r=function(e,t){const n=new Map,o=[],r=new Map,i=[],s=[],a=new Map;let c,l,u;for(const[t,n]of e)a.set(t,Dt(t,n));for(const e of v)c=t.pieces.get(e),l=a.get(e),c?l?q(c,l.piece)||(i.push(l),s.push(Dt(e,c))):s.push(Dt(e,c)):l&&i.push(l);for(const e of s)l=Nt(e,i.filter((t=>q(e.piece,t.piece)))),l&&(u=[l.pos[0]-e.pos[0],l.pos[1]-e.pos[1]],n.set(e.key,u.concat(u)),o.push(l.key));for(const e of i)o.includes(e.key)||r.set(e.key,e.piece);return{anims:n,fadings:r}}(n,t);if(r.anims.size||r.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},e||Bt(t,performance.now())}else t.dom.redraw();return o}(e,t):Lt(e,t)}function Lt(e,t){const n=e(t);return t.dom.redraw(),n}function Dt(e,t){return{key:e,pos:w(e),piece:t}}function Nt(e,t){return t.sort(((t,n)=>E(e.pos,t.pos)-E(e.pos,n.pos)))[0]}function Bt(e,t){const n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());const o=1-(t-n.start)*n.frequency;if(o<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=function(e){return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1}(o);for(const e of n.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>Bt(e,t)))}}const Kt=["green","red","blue","yellow"];function It(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?bt(e):Ct(e);const n=T(t),o=Et(n,qt(e),e.dom.bounds());o&&(e.drawable.current={orig:o,pos:n,brush:Ht(t),snapToValidMove:e.drawable.defaultSnapToValidMove},zt(e))}function zt(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const n=Et(t.pos,qt(e),e.dom.bounds());n||(t.snapToValidMove=!1);const o=t.snapToValidMove?function(e,t,n,o){const r=w(e),i=y.filter((e=>it(r[0],r[1],e[0],e[1])||nt(r[0],r[1],e[0],e[1]))),s=i.map((e=>N(k(e),n,o))).map((e=>E(t,e))),[,a]=s.reduce(((e,t,n)=>e[0]<t?e:[t,n]),[s[0],0]);return k(i[a])}(t.orig,t.pos,qt(e),e.dom.bounds()):n;o!==t.mouseSq&&(t.mouseSq=o,t.dest=o!==t.orig?o:void 0,e.dom.redrawNow()),zt(e)}}))}function Ft(e,t){e.drawable.current&&(e.drawable.current.pos=T(t))}function Ut(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const n=e=>e.orig===t.orig&&e.dest===t.dest,o=e.shapes.find(n);o&&(e.shapes=e.shapes.filter((e=>!n(e))));o&&o.brush===t.brush||e.shapes.push(t);Wt(e)}(e.drawable,t),_t(e))}function _t(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Ht(e){var t;const n=(e.shiftKey||e.ctrlKey)&&L(e),o=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return Kt[(n?1:0)+(o?2:0)]}function Wt(e){e.onChange&&e.onChange(e.shapes)}function jt(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),o=T(t),r=Et(o,qt(e),n);if(!r)return;const i=e.pieces.get(r),s=e.selected;var a;s||!e.drawable.enabled||!e.drawable.eraseOnClick&&i&&i.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),Wt(a.drawable)),!1===t.cancelable||t.touches&&e.movable.color&&!i&&!s&&!function(e,t){const n=qt(e),o=e.dom.bounds(),r=Math.pow(o.width/8,2);for(const i in e.pieces){const e=N(i,n,o);if(E(e,t)<=r)return!0}return!1}(e,o)||t.preventDefault();const c=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&kt(e,e.selected,r)?$t((e=>mt(e,r)),e):mt(e,r);const u=e.selected===r,h=Zt(e,r);if(i&&h&&u&&function(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:i,origPos:o,pos:o,started:e.draggable.autoDistance&&e.stats.dragged,element:h,previouslySelected:s,originTarget:t.target},h.cgDragging=!0,h.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${i.color} ${i.role}`,P(a,x(n)(w(r),qt(e))),O(a,!0)),Gt(e)}else c&&ct(e),l&&lt(e);e.dom.redraw()}function Gt(e){requestAnimationFrame((()=>{var t;const n=e.draggable.current;if(!n)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(n.orig))&&(e.animation.current=void 0);const o=e.pieces.get(n.orig);if(o&&q(o,n.piece)){if(!n.started&&E(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const e=n.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),n.element=e}const t=e.dom.bounds();P(n.element,[n.pos[0]-t.left-t.width/16,n.pos[1]-t.top-t.height/16])}}else Yt(e);Gt(e)}))}function Qt(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=T(t))}function Vt(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);ct(e),lt(e);const o=Et(T(t)||n.pos,qt(e),e.dom.bounds());o&&n.started&&n.orig!==o?n.newPiece?ft(e,n.orig,o,n.force):(e.stats.ctrlKey=t.ctrlKey,pt(e,n.orig,o)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!o&&(e.pieces.delete(n.orig),at(e.events.change)),(n.orig!==n.previouslySelected||n.orig!==o&&o)&&e.selectable.enabled||bt(e),Xt(e),e.draggable.current=void 0,e.dom.redraw()}function Yt(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,bt(e),Xt(e),e.dom.redraw())}function Xt(e){const t=e.dom.elements;t.ghost&&O(t.ghost,!1)}function Zt(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function Jt(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function en(e,t){function n(){!function(e){e.orientation=S(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&n(),(t.fen?$t:Lt)((e=>At(e,t)),e)},state:e,getFen:()=>{return t=e.pieces,b.map((e=>m.map((n=>{const o=t.get(n+e);if(o){const e=Rt[o.role];return"white"===o.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:n,setPieces(t){$t((e=>function(e,t){for(const[n,o]of t)o?e.pieces.set(n,o):e.pieces.delete(n)}(e,t)),e)},selectSquare(t,n){t?$t((e=>mt(e,t,n)),e):e.selected&&(bt(e),e.dom.redraw())},move(t,n){$t((e=>ut(e,t,n)),e)},newPiece(t,n){$t((e=>ht(e,t,n)),e)},playPremove(){if(e.premovable.current){if($t(yt,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const n=function(e,t){const n=e.predroppable.current;let o=!1;if(!n)return!1;t(n)&&ht(e,{role:n.role,color:e.movable.color},n.key)&&(at(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),o=!0);return lt(e),o}(e,t);return e.dom.redraw(),n}return!1},cancelPremove(){Lt(ct,e)},cancelPredrop(){Lt(lt,e)},cancelMove(){Lt((e=>{Ct(e),Yt(e)}),e)},stop(){Lt((e=>{St(e),Yt(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{Jt(e,2),setTimeout((()=>Jt(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){Lt((e=>e.drawable.autoShapes=t),e)},setShapes(t){Lt((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>Et(t,qt(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,n,o){!function(e,t,n,o){const r="a0";e.pieces.set(r,t),e.dom.redraw();const i=T(n);e.draggable.current={orig:r,piece:t,origPos:i,pos:i,started:!0,element:()=>Zt(e,r),originTarget:n.target,newPiece:!0,force:!!o},Gt(e)}(e,t,n,o)},destroy(){St(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function tn(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function nn(e,t,n){const o=e.drawable,r=o.current,i=r&&r.mouseSq?r:void 0,s=new Map,a=e.dom.bounds();for(const e of o.shapes.concat(o.autoShapes).concat(i?[i]:[]))e.dest&&s.set(e.dest,(s.get(e.dest)||0)+1);const c=o.shapes.concat(o.autoShapes).map((e=>({shape:e,current:!1,hash:rn(e,s,!1,a)})));i&&c.push({shape:i,current:!0,hash:rn(i,s,!0,a)});const l=c.map((e=>e.hash)).join(";");if(l===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=l;const u=t.querySelector("defs"),h=t.querySelector("g"),d=n.querySelector("g");!function(e,t,n){const o=new Map;let r;for(const n of t)n.shape.dest&&(r=e.brushes[n.shape.brush],n.shape.modifiers&&(r=dn(r,n.shape.modifiers)),o.set(r.key,r));const i=new Set;let s=n.firstChild;for(;s;)i.add(s.getAttribute("cgKey")),s=s.nextSibling;for(const[e,t]of o.entries())i.has(e)||n.appendChild(ln(t))}(o,c,u),on(e,c.filter((e=>!e.shape.customSvg)),o.brushes,s,h),on(e,c.filter((e=>e.shape.customSvg)),o.brushes,s,d)}function on(e,t,n,o,r){const i=e.dom.bounds(),s=new Map,a=[];for(const e of t)s.set(e.hash,!1);let c,l=r.firstChild;for(;l;)c=l.getAttribute("cgHash"),s.has(c)?s.set(c,!0):a.push(l),l=l.nextSibling;for(const e of a)r.removeChild(e);for(const a of t)s.get(a.hash)||r.appendChild(cn(e,a,n,o,i))}function rn({orig:e,dest:t,brush:n,piece:o,modifiers:r,customSvg:i},s,a,c){return[c.width,c.height,a,e,t,n,t&&(s.get(t)||0)>1,o&&sn(o),r&&(l=r,""+(l.lineWidth||"")),i&&an(i)].filter((e=>e)).join(",");var l}function sn(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function an(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return"custom-"+t.toString()}function cn(e,{shape:t,current:n,hash:o},r,i,s){let a;if(t.customSvg){const n=hn(w(t.orig),e.orientation);a=function(e,t,n){const{width:o,height:r}=n,i=o/8,s=r/8,a=t[0]*i,c=(7-t[1])*s,l=un(tn("g"),{transform:`translate(${a},${c})`}),u=un(tn("svg"),{width:i,height:s,viewBox:"0 0 100 100"});return l.appendChild(u),u.innerHTML=e,l}(t.customSvg,n,s)}else if(t.piece)a=function(e,t,n,o){const r=mn(t,o),i=o.width/8*(n.scale||1),s=n.color[0]+("knight"===n.role?"n":n.role[0]).toUpperCase();return un(tn("image"),{className:`${n.role} ${n.color}`,x:r[0]-i/2,y:r[1]-i/2,width:i,height:i,href:e+s+".svg"})}(e.drawable.pieces.baseUrl,hn(w(t.orig),e.orientation),t.piece,s);else{const o=hn(w(t.orig),e.orientation);if(t.dest){let c=r[t.brush];t.modifiers&&(c=dn(c,t.modifiers)),a=function(e,t,n,o,r,i){const s=function(e,t){return(t?20:10)/512*e.width}(i,r&&!o),a=mn(t,i),c=mn(n,i),l=c[0]-a[0],u=c[1]-a[1],h=Math.atan2(u,l),d=Math.cos(h)*s,p=Math.sin(h)*s;return un(tn("line"),{stroke:e.color,"stroke-width":pn(e,o,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:fn(e,o),x1:a[0],y1:a[1],x2:c[0]-d,y2:c[1]-p})}(c,o,hn(w(t.dest),e.orientation),n,(i.get(t.dest)||0)>1,s)}else a=function(e,t,n,o){const r=mn(t,o),i=function(e){const t=e.width/512;return[3*t,4*t]}(o),s=(o.width+o.height)/32;return un(tn("circle"),{stroke:e.color,"stroke-width":i[n?0:1],fill:"none",opacity:fn(e,n),cx:r[0],cy:r[1],r:s-i[1]/2})}(r[t.brush],o,n,s)}return a.setAttribute("cgHash",o),a}function ln(e){const t=un(tn("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(un(tn("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function un(e,t){for(const n in t)e.setAttribute(n,t[n]);return e}function hn(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function dn(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function pn(e,t,n){return(e.lineWidth||10)*(t?.85:1)/512*n.width}function fn(e,t){return(e.opacity||1)*(t?.9:1)}function mn(e,t){return[(e[0]+.5)*t.width/8,(7.5-e[1])*t.height/8]}function gn(e,t){const n=D("coords",t);let o;for(const t of e)o=D("coord"),o.textContent=t,n.appendChild(o);return n}function bn(e,t){const n=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(n)}if(e.viewOnly)return;const o=function(e){return t=>{e.draggable.current?Yt(e):e.drawable.current?_t(e):t.shiftKey||L(t)?e.drawable.enabled&&It(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;ct(e),lt(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const o=T(t),r=o&&Et(o,qt(e),e.dom.bounds());r&&ft(e,"a0",r)}e.dom.redraw()}(e,t):jt(e,t))}}(e);n.addEventListener("touchstart",o,{passive:!1}),n.addEventListener("mousedown",o,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault()))}function vn(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function kn(e,t,n){return o=>{e.drawable.current?e.drawable.enabled&&n(e,o):e.viewOnly||t(e,o)}}function wn(e){const t=qt(e),n=e.dom.relative?R:x(e.dom.bounds()),o=e.dom.relative?A:P,r=e.dom.elements.board,i=e.pieces,s=e.animation.current,a=s?s.plan.anims:new Map,c=s?s.plan.fadings:new Map,l=e.draggable.current,u=function(e){var t;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)Mn(n,t,"last-move");e.check&&e.highlight.check&&Mn(n,e.check,"check");if(e.selected&&(Mn(n,e.selected,"selected"),e.movable.showDests)){const o=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(o)for(const t of o)Mn(n,t,"move-dest"+(e.pieces.has(t)?" oc":""));const r=e.premovable.dests;if(r)for(const t of r)Mn(n,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const o=e.premovable.current;if(o)for(const e of o)Mn(n,e,"current-premove");else e.predroppable.current&&Mn(n,e.predroppable.current.key,"current-premove");const r=e.exploding;if(r)for(const e of r.keys)Mn(n,e,"exploding"+r.stage);return n}(e),h=new Set,d=new Set,p=new Map,f=new Map;let m,g,b,v,k,y,C,S,E,q;for(g=r.firstChild;g;){if(m=g.cgKey,yn(g))if(b=i.get(m),k=a.get(m),y=c.get(m),v=g.cgPiece,!g.cgDragging||l&&l.orig===m||(g.classList.remove("dragging"),o(g,n(w(m),t)),g.cgDragging=!1),!y&&g.cgFading&&(g.cgFading=!1,g.classList.remove("fading")),b){if(k&&g.cgAnimating&&v===qn(b)){const e=w(m);e[0]+=k[2],e[1]+=k[3],g.classList.add("anim"),o(g,n(e,t))}else g.cgAnimating&&(g.cgAnimating=!1,g.classList.remove("anim"),o(g,n(w(m),t)),e.addPieceZIndex&&(g.style.zIndex=En(w(m),t)));v!==qn(b)||y&&g.cgFading?y&&v===qn(y)?(g.classList.add("fading"),g.cgFading=!0):xn(p,v,g):h.add(m)}else xn(p,v,g);else if(Cn(g)){const e=g.className;u.get(m)===e?d.add(m):xn(f,e,g)}g=g.nextSibling}for(const[e,i]of u)if(!d.has(e)){E=f.get(i),q=E&&E.pop();const s=n(w(e),t);if(q)q.cgKey=e,o(q,s);else{const t=D("square",i);t.cgKey=e,o(t,s),r.insertBefore(t,r.firstChild)}}for(const[s,c]of i)if(k=a.get(s),!h.has(s))if(C=p.get(qn(c)),S=C&&C.pop(),S){S.cgKey=s,S.cgFading&&(S.classList.remove("fading"),S.cgFading=!1);const r=w(s);e.addPieceZIndex&&(S.style.zIndex=En(r,t)),k&&(S.cgAnimating=!0,S.classList.add("anim"),r[0]+=k[2],r[1]+=k[3]),o(S,n(r,t))}else{const i=qn(c),a=D("piece",i),l=w(s);a.cgPiece=i,a.cgKey=s,k&&(a.cgAnimating=!0,l[0]+=k[2],l[1]+=k[3]),o(a,n(l,t)),e.addPieceZIndex&&(a.style.zIndex=En(l,t)),r.appendChild(a)}for(const t of p.values())Sn(e,t);for(const t of f.values())Sn(e,t)}function yn(e){return"PIECE"===e.tagName}function Cn(e){return"SQUARE"===e.tagName}function Sn(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function En(e,t){let n=2+8*e[1]+(7-e[0]);return t&&(n=67-n),n+""}function qn(e){return`${e.color} ${e.role}`}function Mn(e,t,n){const o=e.get(t);o?e.set(t,`${o} ${n}`):e.set(t,n)}function xn(e,t,n){const o=e.get(t);o?o.push(n):e.set(t,[n])}function Rn(e,t){const n={pieces:Pt(Mt),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:C()};function o(){const t="dom"in n?n.dom.unbind:void 0,o=n.viewOnly&&!n.drawable.visible,r=function(e,t,n){e.innerHTML="",e.classList.add("cg-wrap");for(const n of f)e.classList.toggle("orientation-"+n,t.orientation===n);e.classList.toggle("manipulable",!t.viewOnly);const o=D("cg-helper");e.appendChild(o);const r=D("cg-container");o.appendChild(r);const i=D("cg-board");let s,a,c;if(r.appendChild(i),t.drawable.visible&&!n&&(s=un(tn("svg"),{class:"cg-shapes"}),s.appendChild(tn("defs")),s.appendChild(tn("g")),a=un(tn("svg"),{class:"cg-custom-svgs"}),a.appendChild(tn("g")),r.appendChild(s),r.appendChild(a)),t.coordinates){const e="black"===t.orientation?" black":"";r.appendChild(gn(g,"ranks"+e)),r.appendChild(gn(m,"files"+e))}return t.draggable.showGhost&&!n&&(c=D("piece","ghost"),O(c,!1),r.appendChild(c)),{board:i,container:r,ghost:c,svg:s,customSvg:a}}(e,n,o),i=function(e){let t;const n=()=>(void 0===t&&(t=e()),t);return n.clear=()=>{t=void 0},n}((()=>r.board.getBoundingClientRect())),s=e=>{wn(c),!e&&r.svg&&nn(c,r.svg,r.customSvg)},a=()=>{i.clear(),function(e){if(e.dom.relative)return;const t=qt(e),n=x(e.dom.bounds());let o=e.dom.elements.board.firstChild;for(;o;)(yn(o)&&!o.cgAnimating||Cn(o))&&P(o,n(w(o.cgKey),t)),o=o.nextSibling}(c),r.svg&&nn(c,r.svg,r.customSvg)},c=n;return c.dom={elements:r,bounds:i,redraw:Pn(s),redrawNow:s,unbind:t,relative:o},c.drawable.prevSvgHash="",s(!1),bn(c,a),t||(c.dom.unbind=function(e,t){const n=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||n.push(vn(document.body,"chessground.resize",t)),!e.viewOnly){const t=kn(e,Qt,Ft),o=kn(e,Vt,Ut);for(const e of["touchmove","mousemove"])n.push(vn(document,e,t));for(const e of["touchend","mouseup"])n.push(vn(document,e,o));const r=()=>e.dom.bounds.clear();n.push(vn(document,"scroll",r,{capture:!0,passive:!0})),n.push(vn(window,"resize",r,{passive:!0}))}return()=>n.forEach((e=>e()))}(c,a)),c.events.insert&&c.events.insert(r),c}return At(n,t||{}),en(o(),o)}function Pn(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}const An={cache:"no-cache",credentials:"same-origin"},On={"X-Requested-With":"XMLHttpRequest"},Tn=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},An),{headers:Object.assign({},On)}),t));function $n(e,t,n,o){if(0===t)return;const r=document.createElement("cg-resize");e.container.appendChild(r);const i=e=>{e.preventDefault();const t="touchstart"===e.type?"touchmove":"mousemove",n="touchstart"===e.type?"touchend":"mouseup",o=Ln(e),r=parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"));let i=r;const s=function(e,t,n=!1){let o,r=0;return function(...i){const s=this;o&&clearTimeout(o),o=void 0;const a=performance.now()-r;r=performance.now(),n&&a>t?e.apply(s,i):o=setTimeout((()=>{o=void 0,e.apply(s,i)}),t)}}((()=>((e,t={})=>Tn(e,t).then((e=>{if(e.ok)return e.text();throw e.statusText})))(`/pref/zoom?v=${100+i}`,{method:"post"})),700),a=e=>{const t=Ln(e),n=t[0]-o[0]+t[1]-o[1];i=Math.round(Math.min(100,Math.max(0,r+n/10))),document.body.setAttribute("style","--zoom:"+i),window.dispatchEvent(new Event("resize")),s()};document.body.classList.add("resizing"),document.addEventListener(t,a),document.addEventListener(n,(()=>{document.removeEventListener(t,a),document.body.classList.remove("resizing")}),{once:!0})};if(r.addEventListener("touchstart",i,{passive:!1}),r.addEventListener("mousedown",i,{passive:!1}),1===t){const e=e=>r.classList.toggle("none",o?!o(e):e>=2);e(n),lichess.pubsub.on("ply",e)}}function Ln(e){var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0}function Dn(e){const t=e.data,n=e.makeCgHooks(),o=Le(t,e.ply),r=e.isPlaying();return{fen:o.fen,orientation:Nn(t,e.flip),turnColor:o.ply%2==0?"white":"black",lastMove:K(o.uci),check:!!o.check,coordinates:0!==t.pref.coords,addPieceZIndex:e.data.pref.is3d,highlight:{lastMove:t.pref.highlight,check:t.pref.highlight},events:{move:n.onMove,dropNewPiece:n.onNewPiece,insert(n){$n(n,e.data.pref.resizeHandle,e.ply),1===t.pref.coords&&(()=>{const e={blue:"#DEE3E6 #788a94",blue2:"#97b2c7 #546f82",blue3:"#d9e0e6 #315991",canvas:"#d7daeb #547388",wood:"#d8a45b #9b4d0f",wood2:"#a38b5d #6c5017",wood3:"#d0ceca #755839",wood4:"#caaf7d #7b5330",maple:"#e8ceab #bc7944",maple2:"#E2C89F #996633",leather:"#d1d1c9 #c28e16",green:"#FFFFDD #6d8753",brown:"#F0D9B5 #946f51",pink:"#E8E9B7 #ED7272",marble:"#93ab91 #4f644e","blue-marble":"#EAE6DD #7C7F87","green-plastic":"#f2f9bb #59935d",grey:"#b8b8b8 #7d7d7d",metal:"#c9c9c9 #727272",olive:"#b8b19f #6d6655",newspaper:"#fff #8d8d8d",purple:"#9f90b0 #7d4a8d","purple-diag":"#E5DAF0 #957AB0",ic:"#ececec #c1c18e",horsey:"#F0D9B5 #946f51"};for(const t of document.body.className.split(" "))if(t in e){const n=document.documentElement.style,o=e[t].split(" ");n.setProperty("--cg-coord-color-white",o[0]),n.setProperty("--cg-coord-color-black",o[1]),n.setProperty("--cg-coord-shadow","none")}})()}},movable:{free:!1,color:r?t.player.color:void 0,dests:r?F(t.possibleMoves):new Map,showDests:t.pref.destination,rookCastle:t.pref.rookCastle,events:{after:n.onUserMove,afterNewPiece:n.onUserNewPiece}},animation:{enabled:!0,duration:t.pref.animationDuration},premovable:{enabled:t.pref.enablePremove,showDests:t.pref.destination,castle:"antichess"!==t.game.variant.key,events:{set:n.onPremove,unset:n.onCancelPremove}},predroppable:{enabled:t.pref.enablePremove&&"crazyhouse"===t.game.variant.key,events:{set:n.onPredrop,unset(){n.onPredrop(void 0)}}},draggable:{enabled:0!==t.pref.moveEvent,showGhost:t.pref.highlight},selectable:{enabled:1!==t.pref.moveEvent},drawable:{enabled:!0,defaultSnapToValidMove:"0"!=(lichess.storage.get("arrow.snap")||1)},disableContextMenu:!0}}function Nn(e,t){return"racingKings"===e.game.variant.key?t?"black":"white":t?e.opponent.color:e.player.color}function Bn(e){return{choices:e.choices,get:()=>e.storage.get()||e.default,set:t=>(e.storage.set(t),t)}}function Kn(e,t){const n=e.get();return r("select",{hook:{insert(n){n.elm.addEventListener("change",(n=>{e.set(n.target.value),t()}))}}},e.choices.map((e=>{const[t,o]=e;return r("option",{attrs:{value:""+t,selected:t===n}},o)})))}function In(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var zn,Fn=function(){function e(){}var t=e.prototype;return t.unwrap=function(e,t){var n=this._chain((function(t){return zn.ok(e?e(t):t)}),(function(e){return t?zn.ok(t(e)):zn.err(e)}));if(n.isErr)throw n.error;return n.value},t.map=function(e,t){return this._chain((function(t){return zn.ok(e(t))}),(function(e){return zn.err(t?t(e):e)}))},t.chain=function(e,t){return this._chain(e,t||function(e){return zn.err(e)})},e}(),Un=function(e){function t(t){var n;return(n=e.call(this)||this).value=t,n.isOk=!0,n.isErr=!1,n}return In(t,e),t.prototype._chain=function(e,t){return e(this.value)},t}(Fn),_n=function(e){function t(t){var n;return(n=e.call(this)||this).error=t,n.isOk=!1,n.isErr=!0,n}return In(t,e),t.prototype._chain=function(e,t){return t(this.error)},t}(Fn);!function(e){e.ok=function(e){return new Un(e)},e.err=function(e){return new _n(e||new Error)},e.all=function(t){if(Array.isArray(t)){for(var n=[],o=0;o<t.length;o++){var r=t[o];if(r.isErr)return r;n.push(r.value)}return e.ok(n)}for(var i={},s=Object.keys(t),a=0;a<s.length;a++){var c=t[s[a]];if(c.isErr)return c;i[s[a]]=c.value}return e.ok(i)}}(zn||(zn={}));const Hn=["a","b","c","d","e","f","g","h"],Wn=["1","2","3","4","5","6","7","8"],jn=["white","black"],Gn=["pawn","knight","bishop","rook","queen","king"],Qn=["a","h"];function Vn(e){return"role"in e}function Yn(e){return e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24}function Xn(e){return(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16}function Zn(e){return Xn(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4)}class Jn{constructor(e,t){this.lo=e,this.hi=t,this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new Jn(0,1<<e-32):new Jn(1<<e,0)}static fromRank(e){return new Jn(255,0).shl64(8*e)}static fromFile(e){return new Jn(16843009<<e,16843009<<e)}static empty(){return new Jn(0,0)}static full(){return new Jn(4294967295,4294967295)}static corners(){return new Jn(129,2164260864)}static center(){return new Jn(402653184,24)}static backranks(){return new Jn(255,4278190080)}static backrank(e){return"white"===e?new Jn(255,0):new Jn(0,4278190080)}static lightSquares(){return new Jn(1437226410,1437226410)}static darkSquares(){return new Jn(2857740885,2857740885)}complement(){return new Jn(~this.lo,~this.hi)}xor(e){return new Jn(this.lo^e.lo,this.hi^e.hi)}union(e){return new Jn(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new Jn(this.lo&e.lo,this.hi&e.hi)}diff(e){return new Jn(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?Jn.empty():e>=32?new Jn(this.hi>>>e-32,0):e>0?new Jn(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?Jn.empty():e>=32?new Jn(0,this.lo<<e-32):e>0?new Jn(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new Jn(Xn(this.hi),Xn(this.lo))}rbit64(){return new Jn(Zn(this.hi),Zn(this.lo))}minus64(e){const t=this.lo-e.lo,n=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new Jn(t,this.hi-(e.hi+n))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return Yn(this.lo)+Yn(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return 0!=(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new Jn(this.lo,this.hi|1<<e-32):new Jn(this.lo|1<<e,this.hi)}without(e){return e>=32?new Jn(this.lo,this.hi&~(1<<e-32)):new Jn(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new Jn(this.lo,this.hi^1<<e-32):new Jn(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new Jn(this.lo&this.lo-1,this.hi):new Jn(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||0!=(this.lo&this.lo-1)||0!=(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}isSingleSquare(){return this.nonEmpty()&&!this.moreThanOne()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield t}}}class eo{constructor(){}static default(){const e=new eo;return e.reset(),e}static racingKings(){const e=new eo;return e.occupied=new Jn(65535,0),e.promoted=Jn.empty(),e.white=new Jn(61680,0),e.black=new Jn(3855,0),e.pawn=Jn.empty(),e.knight=new Jn(6168,0),e.bishop=new Jn(9252,0),e.rook=new Jn(16962,0),e.queen=new Jn(129,0),e.king=new Jn(33024,0),e}static horde(){const e=new eo;return e.occupied=new Jn(4294967295,4294901862),e.promoted=Jn.empty(),e.white=new Jn(4294967295,102),e.black=new Jn(0,4294901760),e.pawn=new Jn(4294967295,16711782),e.knight=new Jn(0,1107296256),e.bishop=new Jn(0,603979776),e.rook=new Jn(0,2164260864),e.queen=new Jn(0,134217728),e.king=new Jn(0,268435456),e}reset(){this.occupied=new Jn(65535,4294901760),this.promoted=Jn.empty(),this.white=new Jn(65535,0),this.black=new Jn(0,4294901760),this.pawn=new Jn(65280,16711680),this.knight=new Jn(66,1107296256),this.bishop=new Jn(36,603979776),this.rook=new Jn(129,2164260864),this.queen=new Jn(8,134217728),this.king=new Jn(16,268435456)}static empty(){const e=new eo;return e.clear(),e}clear(){this.occupied=Jn.empty(),this.promoted=Jn.empty();for(const e of jn)this[e]=Jn.empty();for(const e of Gn)this[e]=Jn.empty()}clone(){const e=new eo;e.occupied=this.occupied,e.promoted=this.promoted;for(const t of jn)e[t]=this[t];for(const t of Gn)e[t]=this[t];return e}equalsIgnorePromoted(e){return!!this.white.equals(e.white)&&Gn.every((t=>this[t].equals(e[t])))}equals(e){return this.equalsIgnorePromoted(e)&&this.promoted.equals(e.promoted)}getColor(e){return this.white.has(e)?"white":this.black.has(e)?"black":void 0}getRole(e){for(const t of Gn)if(this[t].has(e))return t}get(e){const t=this.getColor(e);if(!t)return;return{color:t,role:this.getRole(e),promoted:this.promoted.has(e)}}take(e){const t=this.get(e);return t&&(this.occupied=this.occupied.without(e),this[t.color]=this[t.color].without(e),this[t.role]=this[t.role].without(e),t.promoted&&(this.promoted=this.promoted.without(e))),t}set(e,t){const n=this.take(e);return this.occupied=this.occupied.with(e),this[t.color]=this[t.color].with(e),this[t.role]=this[t.role].with(e),t.promoted&&(this.promoted=this.promoted.with(e)),n}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,t){return this[e].intersect(this[t])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.king.intersect(this[e]).diff(this.promoted).singleSquare()}}class to{constructor(){}static empty(){const e=new to;for(const t of Gn)e[t]=0;return e}static fromBoard(e,t){const n=new to;for(const o of Gn)n[o]=e.pieces(t,o).size();return n}clone(){const e=new to;for(const t of Gn)e[t]=this[t];return e}equals(e){return Gn.every((t=>this[t]===e[t]))}add(e){const t=new to;for(const n of Gn)t[n]=this[n]+e[n];return t}nonEmpty(){return Gn.some((e=>this[e]>0))}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}count(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class no{constructor(e,t){this.white=e,this.black=t}static empty(){return new no(to.empty(),to.empty())}static fromBoard(e){return new no(to.fromBoard(e,"white"),to.fromBoard(e,"black"))}clone(){return new no(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new no(this.white.add(e.white),this.black.add(e.black))}count(){return this.white.count()+this.black.count()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class oo{constructor(e,t){this.white=e,this.black=t}static default(){return new oo(3,3)}clone(){return new oo(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}function ro(e){return void 0!==e}function io(e){return"white"===e?"black":"white"}function so(e){return e>>3}function ao(e){return 7&e}function co(e){return Hn[ao(e)]+Wn[so(e)]}function lo(e,t){return"white"===e?"a"===t?2:6:"a"===t?58:62}var uo;!function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"}(uo||(uo={}));class ho extends Error{}function po(e){return/^\d{1,4}$/.test(e)?parseInt(e,10):void 0}function fo(e){const t=function(e){switch(e){case"P":case"p":return"pawn";case"N":case"n":return"knight";case"B":case"b":return"bishop";case"R":case"r":return"rook";case"Q":case"q":return"queen";case"K":case"k":return"king";default:return}}(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}}function mo(e){const t=eo.empty();let n=7,o=0;for(let r=0;r<e.length;r++){const i=e[r];if("/"===i&&8===o)o=0,n--;else{const s=parseInt(i,10);if(s>0)o+=s;else{if(o>=8||n<0)return zn.err(new ho(uo.Board));const s=o+8*n,a=fo(i);if(!a)return zn.err(new ho(uo.Board));"~"===e[r+1]&&(a.promoted=!0,r++),t.set(s,a),o++}}}return 0!==n||8!==o?zn.err(new ho(uo.Board)):zn.ok(t)}function go(e){if(e.length>64)return zn.err(new ho(uo.Pockets));const t=no.empty();for(const n of e){const e=fo(n);if(!e)return zn.err(new ho(uo.Pockets));t[e.color][e.role]++}return zn.ok(t)}function bo(e){const t=e.split("+");if(3===t.length&&""===t[0]){const e=po(t[1]),n=po(t[2]);return!ro(e)||e>3||!ro(n)||n>3?zn.err(new ho(uo.RemainingChecks)):zn.ok(new oo(3-e,3-n))}if(2===t.length){const e=po(t[0]),n=po(t[1]);return!ro(e)||e>3||!ro(n)||n>3?zn.err(new ho(uo.RemainingChecks)):zn.ok(new oo(e,n))}return zn.err(new ho(uo.RemainingChecks))}function vo(e){const t=e.split(" "),n=t.shift();let o,r,i=zn.ok(void 0);if(n.endsWith("]")){const e=n.indexOf("[");if(-1===e)return zn.err(new ho(uo.Fen));o=mo(n.substr(0,e)),i=go(n.substr(e+1,n.length-1-e-1))}else{const e=function(e,t,n){let o=e.indexOf(t);for(;n-- >0&&-1!==o;)o=e.indexOf(t,o+t.length);return o}(n,"/",7);-1===e?o=mo(n):(o=mo(n.substr(0,e)),i=go(n.substr(e+1)))}const s=t.shift();if(ro(s)&&"w"!==s){if("b"!==s)return zn.err(new ho(uo.Turn));r="black"}else r="white";return o.chain((e=>{const n=t.shift(),o=ro(n)?function(e,t){let n=Jn.empty();if("-"===t)return zn.ok(n);if(!/^[KQABCDEFGH]{0,2}[kqabcdefgh]{0,2}$/.test(t))return zn.err(new ho(uo.Castling));for(const o of t){const t=o.toLowerCase(),r=o===t?"black":"white",i=Jn.backrank(r).intersect(e[r]);let s;s="q"===t?i:"k"===t?i.reversed():Jn.fromSquare(t.charCodeAt(0)-"a".charCodeAt(0)).intersect(i);for(const t of s){if(e.king.has(t)&&!e.promoted.has(t))break;if(e.rook.has(t)){n=n.with(t);break}}}return zn.ok(n)}(e,n):zn.ok(Jn.empty()),s=t.shift();let a;if(ro(s)&&"-"!==s&&(a=function(e){if(2!==e.length)return;const t=e.charCodeAt(0)-"a".charCodeAt(0),n=e.charCodeAt(1)-"1".charCodeAt(0);return t<0||t>=8||n<0||n>=8?void 0:t+8*n}(s),!ro(a)))return zn.err(new ho(uo.EpSquare));let c,l=t.shift();ro(l)&&l.includes("+")&&(c=bo(l),l=t.shift());const u=ro(l)?po(l):0;if(!ro(u))return zn.err(new ho(uo.Halfmoves));const h=t.shift(),d=ro(h)?po(h):1;if(!ro(d))return zn.err(new ho(uo.Fullmoves));const p=t.shift();let f=zn.ok(void 0);if(ro(p)){if(ro(c))return zn.err(new ho(uo.RemainingChecks));f=bo(p)}else ro(c)&&(f=c);return t.length>0?zn.err(new ho(uo.Fen)):i.chain((t=>o.chain((n=>f.map((o=>({board:e,pockets:t,turn:r,unmovedRooks:n,remainingChecks:o,epSquare:a,halfmoves:u,fullmoves:Math.max(1,d)})))))))}))}function ko(e,t){let n=Jn.empty();for(const o of t){const t=e+o;0<=t&&t<64&&Math.abs(ao(e)-ao(t))<=2&&(n=n.with(t))}return n}function wo(e){const t=[];for(let n=0;n<64;n++)t[n]=e(n);return t}const yo=wo((e=>ko(e,[-9,-8,-7,-1,1,7,8,9]))),Co=wo((e=>ko(e,[-17,-15,-10,-6,6,10,15,17]))),So={white:wo((e=>ko(e,[7,9]))),black:wo((e=>ko(e,[-7,-9])))};function Eo(e){return yo[e]}function qo(e){return Co[e]}function Mo(e,t){return So[e][t]}const xo=wo((e=>Jn.fromFile(ao(e)).without(e))),Ro=wo((e=>Jn.fromRank(so(e)).without(e))),Po=wo((e=>{const t=new Jn(134480385,2151686160),n=8*(so(e)-ao(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)})),Ao=wo((e=>{const t=new Jn(270549120,16909320),n=8*(so(e)+ao(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}));function Oo(e,t,n){let o=n.intersect(t),r=o.bswap64();return o=o.minus64(e),r=r.minus64(e.bswap64()),o.xor(r.bswap64()).intersect(t)}function To(e,t){const n=Jn.fromSquare(e);return Oo(n,Po[e],t).xor(Oo(n,Ao[e],t))}function $o(e,t){return function(e,t){return Oo(Jn.fromSquare(e),xo[e],t)}(e,t).xor(function(e,t){const n=Ro[e];let o=t.intersect(n),r=o.rbit64();return o=o.minus64(Jn.fromSquare(e)),r=r.minus64(Jn.fromSquare(63-e)),o.xor(r.rbit64()).intersect(n)}(e,t))}function Lo(e,t){return To(e,t).xor($o(e,t))}function Do(e,t){const n=Jn.fromSquare(t);return Ro[e].intersects(n)?Ro[e].with(e):Ao[e].intersects(n)?Ao[e].with(e):Po[e].intersects(n)?Po[e].with(e):xo[e].intersects(n)?xo[e].with(e):Jn.empty()}function No(e,t){return Do(e,t).intersect(Jn.full().shl64(e).xor(Jn.full().shl64(t))).withoutFirst()}var Bo;!function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"}(Bo||(Bo={}));class Ko extends Error{}function Io(e,t){return"white"===e?"a"===t?3:5:"a"===t?59:61}class zo{constructor(){}static default(){const e=new zo;return e.unmovedRooks=Jn.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new Jn(14,0),h:new Jn(96,0)},black:{a:new Jn(0,234881024),h:new Jn(0,1610612736)}},e}static empty(){const e=new zo;return e.unmovedRooks=Jn.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:Jn.empty(),h:Jn.empty()},black:{a:Jn.empty(),h:Jn.empty()}},e}clone(){const e=new zo;return e.unmovedRooks=this.unmovedRooks,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,t,n,o){const r=lo(e,t),i=Io(e,t);this.unmovedRooks=this.unmovedRooks.with(o),this.rook[e][t]=o,this.path[e][t]=No(o,i).with(i).union(No(n,r).with(r)).without(n).without(o)}static fromSetup(e){const t=zo.empty(),n=e.unmovedRooks.intersect(e.board.rook);for(const o of jn){const r=Jn.backrank(o),i=e.board.kingOf(o);if(!ro(i)||!r.has(i))continue;const s=n.intersect(e.board[o]).intersect(r),a=s.first();ro(a)&&a<i&&t.add(o,"a",i,a);const c=s.last();ro(c)&&i<c&&t.add(o,"h",i,c)}return t}discardRook(e){if(this.unmovedRooks.has(e)){this.unmovedRooks=this.unmovedRooks.without(e);for(const t of jn)for(const n of Qn)this.rook[t][n]===e&&(this.rook[t][n]=void 0)}}discardSide(e){this.unmovedRooks=this.unmovedRooks.diff(Jn.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}const Fo={a:"alpha",b:"bravo",c:"charlie",d:"delta",e:"echo",f:"foxtrot",g:"golf",h:"hotel"},Uo={a:"anna",b:"bella",c:"cesar",d:"david",e:"eva",f:"felix",g:"gustav",h:"hector"},_o={P:"pawn",R:"rook",N:"knight",B:"bishop",Q:"queen",K:"king"},Ho={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"},Wo={p:"p",r:"r",n:"n",b:"b",q:"q",k:"k",P:"p",R:"r",N:"n",B:"b",Q:"q",K:"k"},jo={p:"p",r:"r",n:"n",b:"b",q:"q",k:"k",P:"P",R:"R",N:"N",B:"B",Q:"Q",K:"K"},Go={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king",P:"pawn",R:"rook",N:"knight",B:"bishop",Q:"queen",K:"king"},Qo={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king",P:"Pawn",R:"Rook",N:"Knight",B:"Bishop",Q:"Queen",K:"King"},Vo={"!":"a","@":"b","#":"c",$:"d","%":"e","^":"f","&":"g","*":"h"};const Yo=(e,t)=>{switch(t){case"letter":return Wo[e];case"white uppercase letter":return jo[e];case"name":return Go[e];case"white uppercase name":return Qo[e]}},Xo=(e,t)=>{switch(t){case"letter":return e.charAt(0);case"name":return e+" ";case"none":return""}};function Zo(e,t,n){if(!e)return"";let o;return o=e.includes("O-O-O")?"long castling":e.includes("O-O")?"short castling":"san"===n?e.replace(/[\+#]/,""):"uci"===n?t||e:e.replace(/[\+#]/,"").split("").map((e=>{if("x"==e)return"takes";if("+"==e)return"check";if("#"==e)return"checkmate";if("="==e)return"promotion";const t=e.charCodeAt(0);return t>48&&t<58?e:t>96&&t<105?tr(e,n):_o[e]||e})).join(" "),e.includes("+")&&(o+=" check"),e.includes("#")&&(o+=" checkmate"),o}function Jo(e,t){return r("div",["white","black"].map((n=>{const o=[];return["king","queen","rook","bishop","knight","pawn"].forEach((t=>{const r=[];for(const[o,i]of e)i.color===n&&i.role===t&&r.push(o);r.length&&o.push([`${t}${r.length>1?"s":""}`,...r])})),r("div",[r("h3",`${n} pieces`),...o.map((e=>`${e[0]}: ${e.slice(1).map((e=>nr(e,t))).join(", ")}`)).join(", ")])})))}function er(e,t,n,o,i,s){const a=e=>r("th",{attrs:{scope:"row"}},e),c=()=>{const e=m.map((e=>r("th",{attrs:{scope:"col"}},e)));return"black"===t&&e.reverse(),r("tr",[r("td"),...e,r("td")])},l=(e,t,n)=>{switch(i){case"before":return t.toUpperCase()+e+" "+n;case"after":return n+" "+t.toUpperCase()+e;case"none":return n}},u=(e,t,n,o,i)=>r("button",{attrs:{rank:e,file:t,piece:n.toLowerCase(),color:o}},i),h=(t,i)=>{const c=[];return"table"===s&&c.push(a(i)),c.push(...m.map((t=>((t,i)=>{const a=i+t,c=e.get(a),h="table"===s?"td":"span";if(c){const e=Ho[c.role],s=Yo("white"===c.color?e.toUpperCase():e,n),a=Xo(c.color,o),d=l(t,i,a+s);return r(h,u(t,i,e,c.color,d))}{const e=(a.charCodeAt(0)+a.charCodeAt(1))%2?"-":"+",n=l(t,i,e);return r(h,u(t,i,e,"none",n))}})(i,t)))),"table"===s&&c.push(a(i)),"black"===t&&c.reverse(),r("table"===s?"tr":"div",c)},d=[];return"table"===s&&d.push(c()),d.push(...b.map((e=>h(t,e)))),"table"===s&&d.push(c()),"black"===t&&d.reverse(),r("table"===s?"table.board-wrapper":"div.board-wrapper",d)}function tr(e,t){return"nato"===t?Fo[e]:"anna"===t?Uo[e]:e}function nr(e,t){return`${tr(e[0],t)} ${e[1]}`}function or(){return e=>{var t,n;const o=$(e.target),r=null!==(t=o.attr("file"))&&void 0!==t?t:"",i=null!==(n=o.attr("rank"))&&void 0!==n?n:"";let s="",a="";if(e.key.match(/^[1-8]$/))s=e.key,a=r;else{if(!e.key.match(/^[!@#$%^&*]$/))return!0;s=i,a=function(e){var t;return null!==(t=Vo[e])&&void 0!==t?t:""}(e.key)}const c=document.querySelector('.board-wrapper button[rank="'+s+'"][file="'+a+'"]');return!c||(c.focus(),!1)}}function rr(e,t,n){return o=>{const r=$(".boardstatus");return"c"!==o.key||(r.text(),r.text(function(e,t,n){const o=e(),r=o[o.length-2],i=o[o.length-1];if(!r||!i)return"none";const s=r.split(" ")[0],a=i.split(" ")[0];for(const e of"kKqQrRbBnNpP"){const o=s.split(e).length-1-(a.split(e).length-1),r=e.toUpperCase()===e?"white":"black";if(1===o)return Xo(r,n)+Yo(e,t)}return"none"}(e,t,n)),!1)}}function ir(e,t,n){return o=>{var r,i;if("m"!==o.key&&"M"!==o.key)return!0;const s=$(".boardstatus"),a=n(),c="white"===e?"w":"b",l="white"===e?"b":"w",u=$(o.target),h=(null!==(r=u.attr("file"))&&void 0!==r?r:"")+u.attr("rank"),d=null===(i=function(e,t){const n=new Map,o=e.ctx();for(const[r,i]of e.allDests(o))if(i.nonEmpty()){const e=Array.from(i,co);(null==t?void 0:t.chess960)||r!==o.king||4!==ao(r)||(i.has(0)?e.push("c1"):i.has(56)&&e.push("c8"),i.has(7)?e.push("g1"):i.has(63)&&e.push("g8")),n.set(co(r),e)}return n}(class extends class{constructor(e){this.rules=e}kingAttackers(e,t,n){return function(e,t,n,o){return n[t].intersect($o(e,o).intersect(n.rooksAndQueens()).union(To(e,o).intersect(n.bishopsAndQueens())).union(qo(e).intersect(n.knight)).union(Eo(e).intersect(n.king)).union(Mo(io(t),e).intersect(n.pawn)))}(e,t,this.board,n)}dropDests(e){return Jn.empty()}playCaptureAt(e,t){this.halfmoves=0,"rook"===t.role&&this.castles.discardRook(e),this.pockets&&this.pockets[io(t.color)][t.role]++}ctx(){const e=this.isVariantEnd(),t=this.board.kingOf(this.turn);if(!ro(t))return{king:t,blockers:Jn.empty(),checkers:Jn.empty(),variantEnd:e,mustCapture:!1};const n=$o(t,Jn.empty()).intersect(this.board.rooksAndQueens()).union(To(t,Jn.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[io(this.turn)]);let o=Jn.empty();for(const e of n){const n=No(t,e).intersect(this.board.occupied);n.moreThanOne()||(o=o.union(n))}return{king:t,blockers:o,checkers:this.kingAttackers(t,io(this.turn),this.board.occupied),variantEnd:e,mustCapture:!1}}clone(){var e,t;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=null===(e=this.pockets)||void 0===e?void 0:e.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}equalsIgnoreMoves(e){var t,n;return this.rules===e.rules&&(this.pockets?this.board.equals(e.board):this.board.equalsIgnorePromoted(e.board))&&(e.pockets&&(null===(t=this.pockets)||void 0===t?void 0:t.equals(e.pockets))||!this.pockets&&!e.pockets)&&this.turn===e.turn&&this.castles.unmovedRooks.equals(e.castles.unmovedRooks)&&this.legalEpSquare()===e.legalEpSquare()&&(e.remainingChecks&&(null===(n=this.remainingChecks)||void 0===n?void 0:n.equals(e.remainingChecks))||!this.remainingChecks&&!e.remainingChecks)}toSetup(){var e,t;return{board:this.board.clone(),pockets:null===(e=this.pockets)||void 0===e?void 0:e.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:this.legalEpSquare(),remainingChecks:null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return jn.every((e=>this.hasInsufficientMaterial(e)))}hasDests(e){e=e||this.ctx();for(const t of this.board[this.turn])if(this.dests(t,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,t){if(Vn(e))return!(!this.pockets||this.pockets[this.turn][e.role]<=0)&&("pawn"!==e.role||!Jn.backranks().has(e.to))&&this.dropDests(t).has(e.to);{if("pawn"===e.promotion)return!1;if("king"===e.promotion&&"antichess"!==this.rules)return!1;if(!!e.promotion!==(this.board.pawn.has(e.from)&&Jn.backranks().has(e.to)))return!1;const n=this.dests(e.from,t);return n.has(e.to)||n.has(this.normalizeMove(e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return ro(e)&&this.kingAttackers(e,io(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return!!(e?e.variantEnd:this.isVariantEnd())||this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){return this.variantOutcome(e)||(e=e||this.ctx(),this.isCheckmate(e)?{winner:io(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const t=new Map;if(e.variantEnd)return t;for(const n of this.board[this.turn])t.set(n,this.dests(n,e));return t}castlingSide(e){if(Vn(e))return;const t=e.to-e.from;return(2===Math.abs(t)||this.board[this.turn].has(e.to))&&this.board.king.has(e.from)?t>0?"h":"a":void 0}normalizeMove(e){const t=this.castlingSide(e);if(!t)return e;const n=this.castles.rook[this.turn][t];return{from:e.from,to:ro(n)?n:e.to}}play(e){const t=this.turn,n=this.epSquare,o=this.castlingSide(e);if(this.epSquare=void 0,this.halfmoves+=1,"black"===t&&(this.fullmoves+=1),this.turn=io(t),Vn(e))this.board.set(e.to,{role:e.role,color:t}),this.pockets&&this.pockets[t][e.role]--,"pawn"===e.role&&(this.halfmoves=0);else{const r=this.board.take(e.from);if(!r)return;let i;if("pawn"===r.role){this.halfmoves=0,e.to===n&&(i=this.board.take(e.to+("white"===t?-8:8)));const o=e.from-e.to;16===Math.abs(o)&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(r.role=e.promotion,r.promoted=!0)}else if("rook"===r.role)this.castles.discardRook(e.from);else if("king"===r.role){if(o){const e=this.castles.rook[t][o];if(ro(e)){const n=this.board.take(e);this.board.set(lo(t,o),r),n&&this.board.set(Io(t,o),n)}}if(this.castles.discardSide(t),o)return}const s=this.board.set(e.to,r)||i;s&&this.playCaptureAt(e.to,s)}}legalEpSquare(e){if(!ro(this.epSquare))return;e=e||this.ctx();const t=this.board.pieces(this.turn,"pawn").intersect(Mo(io(this.turn),this.epSquare));for(const n of t)if(this.dests(n,e).has(this.epSquare))return this.epSquare}}{constructor(e){super(e||"chess")}static default(){const e=new this;return e.board=eo.default(),e.pockets=void 0,e.turn="white",e.castles=zo.default(),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){const t=new this;return t.board=e.board.clone(),t.pockets=void 0,t.turn=e.turn,t.castles=zo.fromSetup(e),t.epSquare=t.validEpSquare(e.epSquare),t.remainingChecks=void 0,t.halfmoves=e.halfmoves,t.fullmoves=e.fullmoves,t.validate().map((e=>t))}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return zn.err(new Ko(Bo.Empty));if(2!==this.board.king.size())return zn.err(new Ko(Bo.Kings));if(!ro(this.board.kingOf(this.turn)))return zn.err(new Ko(Bo.Kings));const e=this.board.kingOf(io(this.turn));return ro(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?zn.err(new Ko(Bo.OppositeCheck)):Jn.backranks().intersects(this.board.pawn)?zn.err(new Ko(Bo.PawnsOnBackrank)):this.validateCheckers():zn.err(new Ko(Bo.Kings))}validateCheckers(){const e=this.board.kingOf(this.turn);if(ro(e)){const t=this.kingAttackers(e,io(this.turn),this.board.occupied);if(t.size()>2||2===t.size()&&Do(t.first(),t.last()).has(e))return zn.err(new Ko(Bo.ImpossibleCheck));if(ro(this.epSquare))for(const n of t)if(Do(n,this.epSquare).has(e))return zn.err(new Ko(Bo.ImpossibleCheck))}return zn.ok(void 0)}validEpSquare(e){if(!ro(e))return;const t="white"===this.turn?5:2,n="white"===this.turn?8:-8;if(so(e)!==t)return;if(this.board.occupied.has(e+n))return;const o=e-n;return this.board.pawn.has(o)&&this.board[io(this.turn)].has(o)?e:void 0}castlingDest(e,t){if(!ro(t.king)||t.checkers.nonEmpty())return Jn.empty();const n=this.castles.rook[this.turn][e];if(!ro(n))return Jn.empty();if(this.castles.path[this.turn][e].intersects(this.board.occupied))return Jn.empty();const o=lo(this.turn,e),r=No(t.king,o),i=this.board.occupied.without(t.king);for(const e of r)if(this.kingAttackers(e,io(this.turn),i).nonEmpty())return Jn.empty();const s=Io(this.turn,e),a=this.board.occupied.toggle(t.king).toggle(n).toggle(s);return this.kingAttackers(o,io(this.turn),a).nonEmpty()?Jn.empty():Jn.fromSquare(n)}canCaptureEp(e,t){if(!ro(this.epSquare))return!1;if(!Mo(this.turn,e).has(this.epSquare))return!1;if(!ro(t.king))return!0;const n=this.epSquare+("white"===this.turn?-8:8),o=this.board.occupied.toggle(e).toggle(this.epSquare).toggle(n);return!this.kingAttackers(t.king,io(this.turn),o).intersects(o)}pseudoDests(e,t){if(t.variantEnd)return Jn.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return Jn.empty();let o=function(e,t,n){switch(e.role){case"pawn":return Mo(e.color,t);case"knight":return qo(t);case"bishop":return To(t,n);case"rook":return $o(t,n);case"queen":return Lo(t,n);case"king":return Eo(t)}}(n,e,this.board.occupied);if("pawn"===n.role){let t=this.board[io(this.turn)];ro(this.epSquare)&&(t=t.with(this.epSquare)),o=o.intersect(t);const n="white"===this.turn?8:-8,r=e+n;if(0<=r&&r<64&&!this.board.occupied.has(r)){o=o.with(r);const t=r+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(o=o.with(t))}return o}return o=o.diff(this.board[this.turn]),e===t.king?o.union(this.castlingDest("a",t)).union(this.castlingDest("h",t)):o}dests(e,t){if((t=t||this.ctx()).variantEnd)return Jn.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return Jn.empty();let o,r;if("pawn"===n.role){o=Mo(this.turn,e).intersect(this.board[io(this.turn)]);const n="white"===this.turn?8:-8,i=e+n;if(0<=i&&i<64&&!this.board.occupied.has(i)){o=o.with(i);const t=i+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(o=o.with(t))}if(ro(this.epSquare)&&this.canCaptureEp(e,t)){const e=this.epSquare-n;(t.checkers.isEmpty()||t.checkers.singleSquare()===e)&&(r=Jn.fromSquare(this.epSquare))}}else o="bishop"===n.role?To(e,this.board.occupied):"knight"===n.role?qo(e):"rook"===n.role?$o(e,this.board.occupied):"queen"===n.role?Lo(e,this.board.occupied):Eo(e);if(o=o.diff(this.board[this.turn]),ro(t.king)){if("king"===n.role){const n=this.board.occupied.without(e);for(const e of o)this.kingAttackers(e,io(this.turn),n).nonEmpty()&&(o=o.without(e));return o.union(this.castlingDest("a",t)).union(this.castlingDest("h",t))}if(t.checkers.nonEmpty()){const e=t.checkers.singleSquare();if(!ro(e))return Jn.empty();o=o.intersect(No(e,t.king).with(e))}t.blockers.has(e)&&(o=o.intersect(Do(e,t.king)))}return r&&(o=o.union(r)),o}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return!this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()&&(this.board[e].intersects(this.board.knight)?this.board[e].size()<=2&&this.board[io(e)].diff(this.board.king).diff(this.board.queen).isEmpty():!this.board[e].intersects(this.board.bishop)||(!this.board.bishop.intersects(Jn.darkSquares())||!this.board.bishop.intersects(Jn.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty())}}.fromSetup(vo(t().replace(" "+l+" "," "+c+" ")).unwrap()).unwrap()).get(h))||void 0===i?void 0:i.map((e=>{const t=a.get(e);return t?e+" captures "+t.role:e})).filter((e=>"m"===o.key||e.includes("captures")));return d?0===d.length?s.text("No captures"):s.text(d.join(", ")):s.text("None"),!1}}class sr{constructor(e,t=3e3){this.redraw=e,this.timeout=t,this.set=e=>{this.notification&&this.notification.text==e&&(e+=" "),this.notification={text:e,date:new Date},lichess.requestIdleCallback(this.redraw,500)},this.currentText=()=>this.notification&&this.notification.date.getTime()>Date.now()-this.timeout?this.notification.text:"",this.render=()=>r("div.notify",{attrs:{"aria-live":"assertive","aria-atomic":"true"}},this.currentText())}}const ar={piece:{help:"p: Read locations of a piece type. Example: p N, p k.",apply:(e,t,n)=>cr(e,/^p ([p|n|b|r|q|k])$/i,(e=>function(e,t,n){const o=`${t===t.toUpperCase()?"white":"black"} ${_o[t.toUpperCase()]}`,r=[];for(const[t,n]of e)n&&`${n.color} ${n.role}`===o&&r.push(t);return`${o}: ${r.length?r.map((e=>nr(e,n))).join(", "):"none"}`}(t,e,n)))},scan:{help:"s: Read pieces on a rank or file. Example: s a, s 1.",apply:(e,t,n)=>cr(e,/^s ([a-h1-8])$/i,(e=>function(e,t,n){const o=[];for(const r of v)if(r.includes(t)){const t=e.get(r);t&&o.push(`${nr(r,n)} ${t.color} ${t.role}`)}return o.length?o.join(", "):"blank"}(t,e,n)))}};function cr(e,t,n){if(e.match(t))return n(e.replace(t,"$1"))}const lr=e=>Be(100,(()=>lichess.sound.play(e))),ur=lr("select"),hr=lr("wrapAround"),dr=lr("outOfBound"),pr=lr("error");lichess.RoundNVUI=function(e){const t=new sr(e),n=Bn({choices:[["san","SAN: Nxf3"],["uci","UCI: g1f3"],["literate","Literate: knight takes f 3"],["anna","Anna: knight takes felix 3"],["nato","Nato: knight takes foxtrot 3"]],default:"anna",storage:lichess.storage.make("nvui.moveNotation")}),o=Bn({choices:[["letter","Letter: w/b"],["name","Name: white/black"],["none","None"]],default:"letter",storage:lichess.storage.make("nvui.prefixStyle")}),i=Bn({choices:[["letter","Letter: p, p"],["white uppercase letter","White uppecase letter: P, p"],["name","Name: pawn, pawn"],["white uppercase name","White uppercase name: Pawn, pawn"]],default:"letter",storage:lichess.storage.make("nvui.pieceStyle")}),s=Bn({choices:[["before","before: c2: wp"],["after","after: wp: c2"],["none","none"]],default:"before",storage:lichess.storage.make("nvui.positionStyle")}),a=Bn({choices:[["plain","plain: layout with no semantic rows or columns"],["table","table: layout using a table with rank and file columns and row headers"]],default:"plain",storage:lichess.storage.make("nvui.boardLayout")});return lichess.pubsub.on("socket.in.message",(e=>{"lichess"===e.u&&t.set(e.t)})),lichess.pubsub.on("round.suggestion",t.set),{render(e){const c=e.data,l=Le(c,e.ply),u=n.get(),h=(d=c.game.variant.key,!["standard","chess960","kingOfTheHill","threeCheck","fromPosition"].includes(d)&&"Sorry, this variant is not supported in blind mode.");var d;return e.chessground||(e.setChessground(Rn(document.createElement("div"),Object.assign(Object.assign({},Dn(e)),{animation:{enabled:!1},drawable:{enabled:!1},coordinates:!1}))),h&&setTimeout((()=>t.set(h)),3e3)),r("div.nvui",{hook:I((n=>setTimeout((()=>t.set(Sr(e))),2e3)))},[r("h1",Sr(e)),r("h2","Game info"),...["white","black"].map((t=>r("p",[t+" player: ",yr(e,e.playerByColor(t))]))),r("p",`${c.game.rated?"Rated":"Casual"} ${c.game.perf}`),c.clock?r("p",`Clock: ${c.clock.initial/60} + ${c.clock.increment}`):null,r("h2","Moves"),r("p.moves",{attrs:{role:"log","aria-live":"off"}},kr(c.steps.slice(1),u)),r("h2","Pieces"),r("div.pieces",Jo(e.chessground.state.pieces,u)),r("h2","Game status"),r("div.status",{attrs:{role:"status","aria-live":"assertive","aria-atomic":"true"}},["started"===e.data.game.status.name?"Playing":_e(e)]),r("h2","Last move"),r("p.lastMove",{attrs:{"aria-live":"assertive","aria-atomic":"true"}},Zo(l.san,l.uci,u)+(e.ply%2==0?"":" ")),...e.isPlaying()?[r("h2","Move form"),r("form",{hook:I((o=>{const r=$(o),i=r.find(".move").val("");i[0].focus(),r.on("submit",function(e,t,n,o){return()=>{let r=function(e){switch(e.toLowerCase().replace(/[-\s]+/g,"")){case"oo":case"00":return"o-o";case"ooo":case"000":return"o-o-o"}return e}(o.val().trim());if(function(e){return gr.includes(e.split(" ")[0].toLowerCase())}(r)&&(r="/"+r),"/"===r[0])!function(e,t,n,o){const r=n.toLowerCase();if("c"==r||"clock"==r)t($(".nvui .botc").text()+", "+$(".nvui .topc").text());else if("l"==r||"last"==r)t($(".lastMove").text());else if("abort"==r)$(".nvui button.abort").trigger("click");else if("resign"==r)$(".nvui button.resign-confirm").trigger("click");else if("draw"==r)$(".nvui button.draw-yes").trigger("click");else if("takeback"==r)$(".nvui button.takeback-yes").trigger("click");else if("o"==r||"opponent"==r)t(Cr(e,e.data.opponent));else{const r=e.chessground.state.pieces;t(ar.piece.apply(n,r,o)||ar.scan.apply(n,r,o)||`Invalid command: ${n}`)}}(e,t,r.slice(1),n());else{const n=e.data,o=function(e){const t=[];for(const[n,o]of e)o&&o.forEach((function(e){t.push(n+e)}));return t}(e.chessground.state.movable.dests),i=p(Le(n,e.ply).fen,o);let s=vr(r,i)||r,a="";r.match(fr)?(s=vr(r.slice(0,-2),i)||r,a=r.slice(-1).toLowerCase()):r.match(mr)&&(s=r.slice(0,-1),a=r.slice(-1).toLowerCase()),console.log(s),console.log(s.slice(0,-1)),console.log(a),console.log(i),o.includes(s.toLowerCase())?e.socket.send("move",{u:s+a},{ackable:!0}):t(n.player.color===n.game.player?`Invalid move: ${r}`:"Not your turn")}return o.val(""),!1}}(e,t.set,n.get,i))}))},[r("label",[c.player.color===c.game.player?"Your move":"Waiting",r("input.move.mousetrap",{attrs:{name:"move",type:"text",autocomplete:"off",autofocus:!0,disabled:!!h,title:h}})])])]:[],r("h2","Your clock"),r("div.botc",br(e,"bottom")),r("h2","Opponent clock"),r("div.topc",br(e,"top")),t.render(),r("h2","Actions"),...e.data.player.spectator?Je(e):j(e.data)?et(e):Ze(e),r("h2","Board"),r("div.board",{hook:I((t=>{const n=$(t);n.on("keypress",(e=>{var t,n;const o=$(e.target),r=$(".boardstatus"),i=(null!==(t=o.attr("file"))&&void 0!==t?t:"")+(null!==(n=o.attr("rank"))&&void 0!==n?n:"");if("o"===e.key)return r.text(),r.text(i),!1;if("l"===e.key){const e=$("p.lastMove").text();return r.text(),r.text(e),!1}return"t"!==e.key||(r.text(),r.text($(".nvui .botc").text()+", "+$(".nvui .topc").text()),!1)})),n.on("keypress",(()=>console.log(e))),n.on("keypress",rr((()=>e.data.steps.map((e=>e.fen))),i.get(),o.get()));const r=n.find("button");r.on("click",function(e,t){return n=>{var o,r;const i=$(n.target),s=i.attr("rank"),a=(null!==(o=i.attr("file"))&&void 0!==o?o:"")+s,c=$(".boardstatus"),l="black"===e?"8":"1",u=$(document.querySelector("input.move"));if(!u)return!1;if(""===u.val()){if(i.attr("color")===e)return!1;i.text().match(/^[^\-+]+/g)&&(u.val(a),t())}else{if(i.attr("color")===("black"===e?"white":"black"))return!1;const t=u.val(),n=$('.board-wrapper [file="'+t[0]+'"][rank="'+t[1]+'"]');if(u.val(u.val()+a),s===l&&"p"===(null===(r=n.attr("piece"))||void 0===r?void 0:r.toLowerCase()))return i.attr("promotion","true"),c.text("Promote to? q for queen, n for knight, r for rook, b for bishop"),!1;const o=u.parent().parent(),h=new Event("submit",{cancelable:!0,bubbles:!0});o.trigger(h)}return!1}}(e.data.opponent.color,ur)),r.on("keydown",function(e,t){return n=>{var o;const r=$(n.target),i="white"===e;let s=null!==(o=r.attr("file"))&&void 0!==o?o:" ",a=Number(r.attr("rank"));if("ArrowUp"===n.key)a=i?a+=1:a-=1;else if("ArrowDown"===n.key)a=i?a-=1:a+=1;else if("ArrowLeft"===n.key)s=String.fromCharCode(i?s.charCodeAt(0)-1:s.charCodeAt(0)+1);else{if("ArrowRight"!==n.key)return!0;s=String.fromCharCode(i?s.charCodeAt(0)+1:s.charCodeAt(0)-1)}const c=document.querySelector('.board-wrapper [file="'+s+'"][rank="'+a+'"]');return c?c.focus():t(),n.preventDefault(),!1}}(e.data.player.color,dr)),r.on("keypress",ir(e.data.player.color,e.chessground.getFen,(()=>e.chessground.state.pieces))),r.on("keypress",or()),r.on("keypress",function(e,t){return n=>{if(!n.key.match(/^[kqrbnp]$/i))return!0;const o=$(n.target);if("true"===o.attr("promotion")){const e=$("input.move"),t=$(".boardstatus"),r=n.key.toLowerCase(),i=e.parent().parent();if(!r.match(/^[qnrb]$/))return t.text("Invalid promotion piece. q for queen, n for knight, r for rook, b for bisho"),!1;e.val(e.val()+r),o.removeAttr("promotion");const s=new Event("submit",{cancelable:!0,bubbles:!0});return i.trigger(s),!1}const r='.board-wrapper [rank="'+o.attr("rank")+'"][file="'+o.attr("file")+'"]',i=$('.board-wrapper [piece="'+n.key.toLowerCase()+'"], '+r),s=i.index(r),a=n.key.toLowerCase()===n.key,c=a?i.slice(s+1):i.slice(0,s),l=a?c.get(0):c.get(c.length-1);if(l)l.focus();else if(i.length>=2){const t=a?i.get(0):i.get(i.length-1);null==t||t.focus(),e()}else t();return!1}}(hr,pr))}))},er(e.chessground.state.pieces,e.data.player.color,i.get(),o.get(),s.get(),a.get())),r("div.boardstatus",{attrs:{"aria-live":"polite","aria-atomic":"true"}},""),r("h2","Settings"),r("label",["Move notation",Kn(n,e.redraw)]),r("h3","Board Settings"),r("label",["Piece style",Kn(i,e.redraw)]),r("label",["Piece prefix style",Kn(o,e.redraw)]),r("label",["Show position",Kn(s,e.redraw)]),r("label",["Board layout",Kn(a,e.redraw)]),r("h2","Commands"),r("p",["Type these commands in the move input.",r("br"),"c: Read clocks.",r("br"),"l: Read last move.",r("br"),"o: Read name and rating of the opponent.",r("br"),ar.piece.help,r("br"),ar.scan.help,r("br"),"abort: Abort game.",r("br"),"resign: Resign game.",r("br"),"draw: Offer or accept draw.",r("br"),"takeback: Offer or accept take back.",r("br")]),r("h2","Board Mode commands"),r("p",["Use these commands when focused on the board itself.",r("br"),"o: announce current position.",r("br"),"c: announce last move's captured piece.",r("br"),"l: announce last move.",r("br"),"t: announce clocks.",r("br"),"m: announce possible moves for the selected piece.",r("br"),"shift+m: announce possible moves for the selected pieces which capture..",r("br"),"arrow keys: move left, right, up or down.",r("br"),"kqrbnp/KQRBNP: move forward/backward to a piece.",r("br"),"1-8: move to rank 1-8.",r("br"),"Shift+1-8: move to file a-h.",r("br")]),r("h2","Promotion"),r("p",["Standard PGN notation selects the piece to promote to. Example: a8=n promotes to a knight.",r("br"),"Omission results in promotion to queen"])])}}};const fr=/^([a-h]x?)?[a-h](1|8)=\w$/,mr=/^([a-h][1-8])([a-h](1|8))[qrbn]$/;const gr=["c","clock","l","last","abort","resign","draw","takeback","p","s","o","opponent"];function br(e,t){const n=e.data,o=e.playerAt(t);return e.clock&&ke(e,o,t)||n.correspondence&&Ae(e.corresClock,e.trans,o.color,t,n.game.player)||void 0}function vr(e,t){if(e in t)return t[e];const n=e.toLowerCase();for(const e in t)if(e.toLowerCase()===n)return t[e]}function kr(e,t){const n=[];return e.forEach((e=>{1&e.ply&&n.push(Math.ceil(e.ply/2)+" "),n.push(Zo(e.san,e.uci,t)+", "),e.ply%2==0&&n.push(r("br"))})),n}function wr(e,t){return e.trans("aiNameLevelAiLevel","Stockfish",t)}function yr(e,t){if(t.ai)return wr(e,t.ai);const n=e.data,o=t.user,i=o?o.perfs[n.game.perf]:null,s=t.rating?t.rating:i&&i.rating,a=t.ratingDiff,c=a?a>0?"+"+a:a<0?"−"+-a:"":"";return o?r("span",[r("a",{attrs:{href:"/@/"+o.username}},o.title?`${o.title} ${o.username}`:o.username),s?` ${s}`:""," "+c]):"Anonymous"}function Cr(e,t){if(t.ai)return wr(e,t.ai);const n=e.data,o=t.user,r=o?o.perfs[n.game.perf]:null,i=t.rating?t.rating:r&&r.rating;return o?`${o.title||""} ${o.username} rated ${i||"unknown"}`:"Anonymous"}function Sr(e){const t=e.data;return["started"==t.game.status.name?e.isPlaying()?"You play the "+e.data.player.color+" pieces.":"Spectating.":"Game over.",t.game.rated?"Rated":"Casual",t.clock?`${t.clock.initial/60} + ${t.clock.increment}`:"",t.game.perf,"game versus",Cr(e,e.data.opponent)].join(" ")}}();
