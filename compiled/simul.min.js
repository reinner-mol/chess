var LichessSimul=function(t){"use strict";const e={createElement:function(t,e){return document.createElement(t,e)},createElementNS:function(t,e,n){return document.createElementNS(t,e,n)},createTextNode:function(t){return document.createTextNode(t)},createComment:function(t){return document.createComment(t)},insertBefore:function(t,e,n){t.insertBefore(e,n)},removeChild:function(t,e){t.removeChild(e)},appendChild:function(t,e){t.appendChild(e)},parentNode:function(t){return t.parentNode},nextSibling:function(t){return t.nextSibling},tagName:function(t){return t.tagName},setTextContent:function(t,e){t.textContent=e},getTextContent:function(t){return t.textContent},isElement:function(t){return 1===t.nodeType},isText:function(t){return 3===t.nodeType},isComment:function(t){return 8===t.nodeType}};function n(t,e,n,a,o){return{sel:t,data:e,children:n,text:a,elm:o,key:void 0===e?void 0:e.key}}const a=Array.isArray;function o(t){return"string"==typeof t||"number"==typeof t}function s(t){return void 0===t}function i(t){return void 0!==t}const r=n("",{},[],void 0,void 0);function l(t,e){var n,a;const o=t.key===e.key,s=(null===(n=t.data)||void 0===n?void 0:n.is)===(null===(a=e.data)||void 0===a?void 0:a.is);return t.sel===e.sel&&o&&s}function c(t,e,n){var a;const o={};for(let s=e;s<=n;++s){const e=null===(a=t[s])||void 0===a?void 0:a.key;void 0!==e&&(o[e]=s)}return o}const d=["create","update","remove","destroy","pre","post"];function u(t,u){let h,p;const m={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},f=void 0!==u?u:e;for(h=0;h<d.length;++h)for(m[d[h]]=[],p=0;p<t.length;++p){const e=t[p][d[h]];void 0!==e&&m[d[h]].push(e)}function g(t){const e=t.id?"#"+t.id:"",a=t.className?"."+t.className.split(" ").join("."):"";return n(f.tagName(t).toLowerCase()+e+a,{},[],void 0,t)}function v(t,e){return function(){if(0==--e){const e=f.parentNode(t);f.removeChild(e,t)}}}function b(t,e){var n,l;let c,d=t.data;if(void 0!==d){const e=null===(n=d.hook)||void 0===n?void 0:n.init;i(e)&&(e(t),d=t.data)}const u=t.children,h=t.sel;if("!"===h)s(t.text)&&(t.text=""),t.elm=f.createComment(t.text);else if(void 0!==h){const n=h.indexOf("#"),s=h.indexOf(".",n),p=n>0?n:h.length,g=s>0?s:h.length,v=-1!==n||-1!==s?h.slice(0,Math.min(p,g)):h,k=t.elm=i(d)&&i(c=d.ns)?f.createElementNS(c,v,d):f.createElement(v,d);for(p<g&&k.setAttribute("id",h.slice(p+1,g)),s>0&&k.setAttribute("class",h.slice(g+1).replace(/\./g," ")),c=0;c<m.create.length;++c)m.create[c](r,t);if(a(u))for(c=0;c<u.length;++c){const t=u[c];null!=t&&f.appendChild(k,b(t,e))}else o(t.text)&&f.appendChild(k,f.createTextNode(t.text));const y=t.data.hook;i(y)&&(null===(l=y.create)||void 0===l||l.call(y,r,t),y.insert&&e.push(t))}else t.elm=f.createTextNode(t.text);return t.elm}function k(t,e,n,a,o,s){for(;a<=o;++a){const o=n[a];null!=o&&f.insertBefore(t,b(o,s),e)}}function y(t){var e,n;const a=t.data;if(void 0!==a){null===(n=null===(e=null==a?void 0:a.hook)||void 0===e?void 0:e.destroy)||void 0===n||n.call(e,t);for(let e=0;e<m.destroy.length;++e)m.destroy[e](t);if(void 0!==t.children)for(let e=0;e<t.children.length;++e){const n=t.children[e];null!=n&&"string"!=typeof n&&y(n)}}}function w(t,e,n,a){for(var o,s;n<=a;++n){let a,r;const l=e[n];if(null!=l)if(i(l.sel)){y(l),a=m.remove.length+1,r=v(l.elm,a);for(let t=0;t<m.remove.length;++t)m.remove[t](l,r);const t=null===(s=null===(o=null==l?void 0:l.data)||void 0===o?void 0:o.hook)||void 0===s?void 0:s.remove;i(t)?t(l,r):r()}else f.removeChild(t,l.elm)}}function x(t,e,n){var a,o,r,d,u;const h=null===(a=e.data)||void 0===a?void 0:a.hook;null===(o=null==h?void 0:h.prepatch)||void 0===o||o.call(h,t,e);const p=e.elm=t.elm,g=t.children,v=e.children;if(t!==e){if(void 0!==e.data){for(let n=0;n<m.update.length;++n)m.update[n](t,e);null===(d=null===(r=e.data.hook)||void 0===r?void 0:r.update)||void 0===d||d.call(r,t,e)}s(e.text)?i(g)&&i(v)?g!==v&&function(t,e,n,a){let o,i,r,d,u=0,h=0,p=e.length-1,m=e[0],g=e[p],v=n.length-1,y=n[0],_=n[v];for(;u<=p&&h<=v;)null==m?m=e[++u]:null==g?g=e[--p]:null==y?y=n[++h]:null==_?_=n[--v]:l(m,y)?(x(m,y,a),m=e[++u],y=n[++h]):l(g,_)?(x(g,_,a),g=e[--p],_=n[--v]):l(m,_)?(x(m,_,a),f.insertBefore(t,m.elm,f.nextSibling(g.elm)),m=e[++u],_=n[--v]):l(g,y)?(x(g,y,a),f.insertBefore(t,g.elm,m.elm),g=e[--p],y=n[++h]):(void 0===o&&(o=c(e,u,p)),i=o[y.key],s(i)?f.insertBefore(t,b(y,a),m.elm):(r=e[i],r.sel!==y.sel?f.insertBefore(t,b(y,a),m.elm):(x(r,y,a),e[i]=void 0,f.insertBefore(t,r.elm,m.elm))),y=n[++h]);(u<=p||h<=v)&&(u>p?(d=null==n[v+1]?null:n[v+1].elm,k(t,d,n,h,v,a)):w(t,e,u,p))}(p,g,v,n):i(v)?(i(t.text)&&f.setTextContent(p,""),k(p,null,v,0,v.length-1,n)):i(g)?w(p,g,0,g.length-1):i(t.text)&&f.setTextContent(p,""):t.text!==e.text&&(i(g)&&w(p,g,0,g.length-1),f.setTextContent(p,e.text)),null===(u=null==h?void 0:h.postpatch)||void 0===u||u.call(h,t,e)}}return function(t,e){let n,a,o;const s=[];for(n=0;n<m.pre.length;++n)m.pre[n]();for(function(t){return void 0!==t.sel}(t)||(t=g(t)),l(t,e)?x(t,e,s):(a=t.elm,o=f.parentNode(a),b(e,s),null!==o&&(f.insertBefore(o,e.elm,f.nextSibling(a)),w(o,[t],0,0))),n=0;n<s.length;++n)s[n].data.hook.insert(s[n]);for(n=0;n<m.post.length;++n)m.post[n]();return e}}function h(t,e,n){if(t.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==e)for(let t=0;t<e.length;++t){const n=e[t].data;void 0!==n&&h(n,e[t].children,e[t].sel)}}function p(t,e,s){let i,r,l,c={};if(void 0!==s?(null!==e&&(c=e),a(s)?i=s:o(s)?r=s:s&&s.sel&&(i=[s])):null!=e&&(a(e)?i=e:o(e)?r=e:e&&e.sel?i=[e]:c=e),void 0!==i)for(l=0;l<i.length;++l)o(i[l])&&(i[l]=n(void 0,void 0,void 0,i[l],void 0));return"s"!==t[0]||"v"!==t[1]||"g"!==t[2]||3!==t.length&&"."!==t[3]&&"#"!==t[3]||h(c,i,t),n(t,c,i,r,void 0)}function m(t,e){t.data.fn=e.data.fn,t.data.args=e.data.args,e.data=t.data,e.children=t.children,e.text=t.text,e.elm=t.elm}function f(t){const e=t.data;m(e.fn(...e.args),t)}function g(t,e){let n;const a=t.data,o=e.data,s=a.args,i=o.args;if(a.fn===o.fn&&s.length===i.length){for(n=0;n<i.length;++n)if(s[n]!==i[n])return void m(o.fn(...i),e);m(t,e)}else m(o.fn(...i),e)}function v(t,e){let n;const a=e.elm;let o=t.data.attrs,s=e.data.attrs;if((o||s)&&o!==s){for(n in o=o||{},s=s||{},s){const t=s[n];o[n]!==t&&(!0===t?a.setAttribute(n,""):!1===t?a.removeAttribute(n):120!==n.charCodeAt(0)?a.setAttribute(n,t):58===n.charCodeAt(3)?a.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,t):58===n.charCodeAt(5)?a.setAttributeNS("http://www.w3.org/1999/xlink",n,t):a.setAttribute(n,t))}for(n in o)n in s||a.removeAttribute(n)}}const b={create:v,update:v};function k(t,e){let n,a;const o=e.elm;let s=t.data.class,i=e.data.class;if((s||i)&&s!==i){for(a in s=s||{},i=i||{},s)s[a]&&!Object.prototype.hasOwnProperty.call(i,a)&&o.classList.remove(a);for(a in i)n=i[a],n!==s[a]&&o.classList[n?"add":"remove"](a)}}const y={create:k,update:k};const w=t=>{let e=t;return function(t){return(t=>void 0!==t)(t)&&(e=t),e}},x={Accept:"application/vnd.lichess.v5+json"},_={cache:"no-cache",credentials:"same-origin"},C={"X-Requested-With":"XMLHttpRequest"},T=(t,e={})=>fetch(t,Object.assign(Object.assign(Object.assign({},_),{headers:Object.assign(Object.assign({},x),C)}),e)).then((t=>{if(t.ok)return t.json();throw t.statusText})),j=(t,e={})=>I(t,e).then((t=>{if(t.ok)return t.text();throw t.statusText})),I=(t,e={})=>fetch(t,Object.assign(Object.assign(Object.assign({},_),{headers:Object.assign({},C)}),e)),L=t=>{const e=new FormData;for(const n of Object.keys(t))e.append(n,t[n]);return e},E=()=>lichess.reload(),A=t=>e=>T(`/simul/${e}/${t}`,{method:"post"}).catch(E);var M={ping:A("host-ping"),start:A("start"),abort:A("abort"),join:function(t,e){let n,a=0;return function(...o){const s=this,i=performance.now()-a;function r(){n=void 0,a=performance.now(),e.apply(s,o)}n&&clearTimeout(n),i>t?r():n=setTimeout(r,t-i)}}(4e3,((t,e)=>A(`join/${e}`)(t))),withdraw:A("withdraw"),accept:t=>A(`accept/${t}`),reject:t=>A(`reject/${t}`)};class N{constructor(t,e){this.opts=t,this.redraw=e,this.setupCreatedHost=()=>{lichess.storage.set("lichess.move_on","1");let t=!0;lichess.idleTimer(9e5,(()=>{t=!1}),(()=>{t=!0})),setInterval((()=>{this.data.isCreated&&t&&M.ping(this.data.id)}),1e4)},this.reload=t=>{this.data=Object.assign(Object.assign({},t),{team:this.data.team})},this.teamBlock=()=>!!this.data.team&&!this.data.team.isIn,this.createdByMe=()=>this.opts.userId===this.data.host.id,this.candidates=()=>this.data.applicants.filter((t=>!t.accepted)),this.accepted=()=>this.data.applicants.filter((t=>t.accepted)),this.acceptedContainsMe=()=>this.accepted().some((t=>t.player.id===this.opts.userId)),this.applicantsContainsMe=()=>this.candidates().some((t=>t.player.id===this.opts.userId)),this.containsMe=()=>this.opts.userId&&(this.applicantsContainsMe()||this.acceptedContainsMe()||this.pairingsContainMe()),this.pairingsContainMe=()=>this.data.pairings.some((t=>t.player.id===this.opts.userId)),this.data=t.data,this.trans=lichess.trans(t.i18n),this.socket=function(t,e){const n={reload(t){e.reload(t),e.redraw()},aborted:lichess.reload,hostGame(t){e.data.host.gameId=t,e.redraw()}};return{send:t,receive:(t,e)=>!!n[t]&&n[t](e)}}(t.socketSend,this),this.createdByMe()&&this.data.isCreated&&this.setupCreatedHost()}}function O(t,e){const n=t.substring(0,14);return p("a",{class:{"user-link":!0,ulpt:!0},attrs:{href:"/@/"+t}},e&&"BOT"!=e?[p("span.utitle",e),n]:[n])}function B(t,e){return{insert(n){n.elm.addEventListener(t,e)}}}const S={start:["hi/Hello","gl/Good luck","hf/Have fun!","u2/You too!"].map(H),end:["gg/Good game","wp/Well played","ty/Thank you","gtg/I've got to go","bye/Bye!"].map(H)};function H(t){const e=t.split("/");return{key:e[0],text:e[1]}}const q=t=>j(R(t)),R=t=>`/${t}/note`;function G(t){let e=t.text;const n=function(t,e,n=!1){let a,o=0;return function(...s){const i=this;a&&clearTimeout(a),a=void 0;const r=performance.now()-o;o=performance.now(),n&&r>e?t.apply(i,s):a=setTimeout((()=>{a=void 0,t.apply(i,s)}),e)}}((()=>{((t,e)=>{T(R(t),{method:"post",body:L({text:e})})})(t.id,e||"")}),1e3);return{id:t.id,trans:t.trans,text:()=>e,fetch(){q(t.id).then((n=>{e=n||"",t.redraw()}))},post(t){e=t,n()}}}function P(t){const e=t.text();return null==e?p("div.loading",{hook:{insert:t.fetch}}):p("textarea",{attrs:{placeholder:t.trans("typePrivateNotesHere")},hook:{insert(n){const a=$(n.elm);a.val(e).on("change keyup paste",(()=>t.post(a.val())))}}})}let z=!1;function V(t){let e,n=!1;const a=()=>{e=void 0,n=!1,t.redraw()};return{loading:()=>n,data:()=>e,reasons:t.reasons,permissions:()=>t.permissions,open:a=>{const o=a.querySelector("a.user-link"),s=a.querySelector("t").innerText,i=o.href.split("/")[4];t.permissions.timeout?(n=!0,(t=>T("/mod/chat-user/"+t))(i).then((a=>{e=Object.assign(Object.assign({},a),{text:s}),n=!1,t.redraw()}))):e={id:i.toLowerCase(),username:i,text:s},t.redraw()},close:a,timeout(n,o){e&&lichess.pubsub.emit("socket.send","timeout",{userId:e.id,reason:n.key,text:o}),a(),t.redraw()}}}const W=()=>p("i.mod",{attrs:{"data-icon":""}});function K(t,e){const n=t.data;n.domVersion=1;const a={instance:void 0,loaded:!1,enabled:w(!!n.palantir)},o=["discussion"];t.noteId&&o.push("note"),t.plugin&&o.push(t.plugin.tab.key);const s=lichess.storage.make("chat.tab"),i=s.get();let r;const l={tab:o.find((t=>t===i))||o[0],enabled:t.alwaysEnabled||!lichess.storage.get("nochat"),placeholderKey:"talkInChat",loading:!1,timeout:t.timeout,writeable:t.writeable};o.length>1&&"discussion"===l.tab&&lichess.storage.get("nochat")&&(l.tab=o[1]);const c=t=>!!(t=t.trim())&&(!("You too!"==t&&!n.lines.some((t=>t.u!=n.userId)))&&(t.length>140?(alert("Max length: 140 chars. "+t.length+" chars used."),!1):(lichess.pubsub.emit("socket.send","talk",t),!0))),d=lichess.trans(t.i18n);function u(){(t.permissions.timeout||t.permissions.local)&&(r=V({reasons:t.timeoutReasons||[{key:"other",name:"Inappropriate behavior"}],permissions:t.permissions,redraw:e}),t.loadCss("chat.mod"))}u();const h=t.noteId?G({id:t.noteId,text:t.noteText,trans:d,redraw:e}):void 0,p=function(t){let e=t.initialGroup,n=[];return{group:()=>e,said:()=>n,setGroup(a){a!==e&&(e=a,a||(n=[]),t.redraw())},post(a){e&&S[e]&&(n.includes(a.key)||t.post(a.text)&&n.push(a.key))}}}({initialGroup:t.preset,post:c,redraw:e}),m=[["socket.in.message",t=>{n.lines.push(t);const a=n.lines.length;a>200&&(n.lines.splice(0,a-200+50),n.domVersion++),e()}],["socket.in.chat_timeout",t=>{let a=!1;n.lines.forEach((e=>{e.u&&e.u.toLowerCase()==t&&(e.d=!0,a=!0)})),t==n.userId&&(l.timeout=a=!0),a&&(n.domVersion++,e())}],["socket.in.chat_reinstate",t=>{t==n.userId&&(l.timeout=!1,e())}],["chat.writeable",t=>{l.writeable=t,e()}],["chat.permissions",n=>{let a;for(a in n)t.permissions[a]=n[a];u(),e()}],["palantir.toggle",a.enabled]];m.forEach((([t,e])=>lichess.pubsub.on(t,e)));const f=()=>lichess.pubsub.emit("chat.enabled",l.enabled);return f(),{data:n,opts:t,vm:l,allTabs:o,setTab(t){l.tab=t,s.set(t),"discussion"===t&&lichess.requestIdleCallback((()=>$(".mchat__say").each((function(){this.focus()}))),500),e()},moderation:()=>r,note:h,preset:p,post:c,trans:d,plugin:t.plugin,setEnabled(t){l.enabled=t,f(),t?lichess.storage.remove("nochat"):lichess.storage.set("nochat","1"),e()},redraw:e,palantir:a,destroy:()=>{m.forEach((([t,e])=>lichess.pubsub.off(t,e)))}}}const F=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:(?:https?|ftp):\/\/|lichess\.org)[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,D=/\n/g,U=/(^|[^\w@#/])@([a-z0-9][a-z0-9_-]{0,28}[a-z0-9])/gi;function X(t){return`<a target="_blank" rel="nofollow noopener noreferrer" href="${t}">${t.replace(/https?:\/\//,"")}</a>`}function Y(t,e,n){return t.includes("&quot;")?t:`<a target="_blank" rel="noopener nofollow noreferrer" href="${t.startsWith("/")||t.includes("://")?t:"//"+t}"${n?` class="${n}"`:""}>${e||t}</a>`}function Z(t,e=!0){let n=(a=lichess.escapeHtml(t),o=X,a.replace(F,((t,e,n)=>e+o(n))));var a,o;return e&&(n=n.replace(D,"<br>")),n}function Q(t,e=!0){return n=t,a=t=>Z(t,e),{insert(t){t.elm.innerHTML=a(n),t.data.cachedA=n},postpatch(t,e){t.data.cachedA!==n&&(e.elm.innerHTML=a(n)),e.data.cachedA=n}};var n,a}const J=/\b\b(?:https?:\/\/)?(lichess\.org\/[-–—\w+&'@#\/%?=()~|!:,.;]+[\w+&@#\/%=~|])/gi,tt=/^[a-h][2-7]$/,et=/\b(\d+)\s*(\.+)\s*(?:[o0-]+[o0]|[NBRQKP\u2654\u2655\u2656\u2657\u2658\u2659]?[a-h]?[1-8]?[x@]?[a-z][1-8](?:=[NBRQK\u2654\u2655\u2656\u2657\u2658\u2659])?)\+?#?[!\?=]{0,5}/gi;function nt(t,e,n){if(e<1||e>200)return t;return'<a class="jump" data-ply="'+(2*e-(n.length>1?0:1))+'">'+t+"</a>"}function at(t,e,n){return n.match(tt)?t:function(t,e,n){return e+Y("/@/"+n,"@"+n)}(0,e,n)}function ot(t,e){const n=lichess.escapeHtml(t),a=n.replace(U,at).replace(J,Y);return e&&a===n?a.replace(et,nt):a}const st=()=>"1"==lichess.storage.get("chat-spam"),it=new RegExp(["xcamweb.com","(^|[^i])chess-bot","chess-cheat","coolteenbitch","letcafa.webcam","tinyurl.com/","wooga.info/","bit.ly/","wbt.link/","eb.by/","001.rs/","shr.name/","u.to/",".3-a.net",".ssl443.org",".ns02.us",".myftp.info",".flinkup.com",".serveusers.com","badoogirls.com","hide.su","wyon.de","sexdatingcz.club","qps.ru","tiny.cc/"].map((t=>t.replace(/\./g,"\\.").replace(/\//g,"\\/"))).join("|")),rt=t=>!!t.match(it),lt=/follow me|join my team/i,ct=t=>!!t.match(lt),dt=/lichess\.org\/team\//i,ut=/^\/[wW](?:hisper)?\s/;function ht(t){if(!t.vm.enabled)return[];const e=e=>{const n=e.elm;if(t.data.lines.length>5){(0===n.scrollTop||n.scrollTop>n.scrollHeight-n.clientHeight-100)&&(n.scrollTop=999999,setTimeout((t=>n.scrollTop=999999),300))}},n=!!t.moderation(),a=[p("ol.mchat__messages.chat-v-"+t.data.domVersion,{attrs:{role:"log","aria-live":"polite","aria-atomic":"false"},hook:{insert(a){const o=$(a.elm).on("click","a.jump",(t=>{lichess.pubsub.emit("jump",t.target.getAttribute("data-ply"))}));n?o.on("click",".mod",(e=>{var n;return null===(n=t.moderation())||void 0===n?void 0:n.open(e.target.parentNode)})):o.on("click",".flag",(e=>function(t,e){const n=e.querySelector("a.user-link"),a=e.querySelector("t").innerText;n&&confirm(`Report "${a}" to moderators?`)&&((t,e,n)=>{T("/report/flag",{method:"post",body:L({username:e,resource:t,text:n})})})(t.data.resourceId,n.href.split("/")[4],a)}(t,e.target.parentNode))),e(a)},postpatch:(t,n)=>e(n)}},gt(t).map((e=>function(t,e){const n=function(t,e){if(n=t,/(\n|(@|#|\.)\w{2,})/.test(n)){const n=function(t){return(e,n)=>{n.data.lichessChat!==e.data.lichessChat&&(n.elm.innerHTML=ot(n.data.lichessChat,t))}}(e);return p("t",{lichessChat:t,hook:{create:n,update:n}})}var n;return p("t",t)}(e.t,t.opts.parseMoves);if("lichess"===e.u)return p("li.system",n);if(e.c)return p("li",[p("span.color","["+e.c+"]"),n]);const a=(o="a",s=e.u,i=O,r=[e.u,e.title],void 0===r&&(r=i,i=s,s=void 0),p(o,{key:s,hook:{init:f,prepatch:g},fn:i,args:r}));var o,s,i,r;return p("li",t.moderation()?[e.u?W():null,a," ",n]:[t.data.userId&&e.u&&t.data.userId!=e.u?p("i.flag",{attrs:{"data-icon":"!",title:"Report"}}):null,a," ",n])}(t,e)))),pt(t)],o=function(t){const e=t.group();if(!e)return;const n=S[e],a=t.said();return n&&a.length<2?p("div.mchat__presets",n.map((e=>{const n=a.includes(e.key);return p("span",{class:{disabled:n},attrs:{title:e.text,disabled:n},hook:B("click",(()=>{!n&&t.post(e)}))},e.key)}))):void 0}(t.preset);return o&&a.push(o),a}function pt(t){if(!t.vm.writeable)return;if(t.data.loginRequired&&!t.data.userId||t.data.restricted)return p("input.mchat__say",{attrs:{placeholder:t.trans("loginToChat"),disabled:!0}});let e;return e=t.vm.timeout?t.trans("youHaveBeenTimedOut"):t.opts.blind?"Chat":t.trans.noarg(t.vm.placeholderKey),p("input.mchat__say",{attrs:{placeholder:e,autocomplete:"off",maxlength:140,disabled:t.vm.timeout||!t.vm.writeable,"aria-label":"Chat input"},hook:{insert(e){ft(t,e.elm)}}})}let mt;const ft=(t,e)=>{const n=lichess.tempStorage.make("chat.input"),a=n.get();a&&(e.value=a,e.focus(),!t.opts.public&&a.match(ut)&&e.classList.add("whisper")),e.addEventListener("keydown",(e=>{"Enter"===e.key&&setTimeout((()=>{const a=e.target,o=a.value,s=t.opts.public;""===o?$(".keyboard-move input").each((function(){this.focus()})):(t.opts.kobold||(t=>{if(st())return;const e=rt(t);e&&j(`/jslog/${window.location.href.substr(-12)}?n=spam`,{method:"post"}),(e||ct(t))&&lichess.storage.set("chat-spam","1")})(o),s&&(t=>!!t.match(dt))(o)?alert("Please don't advertise teams in the chat."):t.post(o),a.value="",n.remove(),s||a.classList.remove("whisper"))}))})),e.addEventListener("input",(e=>setTimeout((()=>{const a=e.target,o=a.value;a.removeAttribute("placeholder"),t.opts.public||a.classList.toggle("whisper",!!o.match(ut)),n.set(o)})))),window.Mousetrap.bind("c",(()=>e.focus()));const o=["touchstart","mousedown"];mt&&o.forEach((t=>document.body.removeEventListener(t,mt,{capture:!0}))),mt=t=>{t.shiftKey||2===t.buttons||2===t.button||e.blur()},e.onfocus=()=>o.forEach((t=>document.body.addEventListener(t,mt,{passive:!0,capture:!0}))),e.onblur=()=>o.forEach((t=>document.body.removeEventListener(t,mt,{capture:!0})))};function gt(t){const e=[];let n;return t.data.lines.forEach((a=>{var o,s,i;a.d||n&&(i=a,(s=n).d&&i.d&&s.u===i.u)||a.r&&(a.u||"").toLowerCase()!=t.data.userId||(o=a.t,(rt(o)||ct(o))&&!st())||e.push(a),n=a})),e}function vt(t){const e=t.moderation();return p("section.mchat"+(t.opts.alwaysEnabled?"":".mchat-optional"),{class:{"mchat-mod":!!e},hook:{destroy:t.destroy}},function(t){if(!t)return;if(t.loading())return[p("div.loading")];const e=t.data();if(!e)return;const n=t.permissions(),a=e.history?p("div.infos.block",[(o=e.games||0,!1===z&&(z=window.Intl&&Intl.NumberFormat?new Intl.NumberFormat:null),(null===z?""+o:z.format(o))+" games"),e.troll?"TROLL":void 0,e.engine?"ENGINE":void 0,e.booster?"BOOSTER":void 0].map((t=>t&&p("span",t))).concat([p("a",{attrs:{href:"/@/"+e.username+"?mod"}},"profile")]).concat(n.shadowban?[p("a",{attrs:{href:"/mod/"+e.username+"/communication"}},"coms")]:[])):void 0;var o;const s=n.timeout?p("div.timeout.block",[p("strong","Timeout 15 minutes for"),...t.reasons.map((n=>p("a.text",{attrs:{"data-icon":"p"},hook:B("click",(()=>t.timeout(n,e.text)))},n.name)))]):p("div.timeout.block",[p("strong","Moderation"),p("a.text",{attrs:{"data-icon":"p"},hook:B("click",(()=>t.timeout(t.reasons[0],e.text)))},"Timeout 15 minutes")]),i=e.history?p("div.history.block",[p("strong","Timeout history"),p("table",p("tbody.slist",{hook:{insert(){lichess.contentLoaded()}}},e.history.map((function(t){return p("tr",[p("td.reason",t.reason),p("td.mod",t.mod),p("td",p("time.timeago",{attrs:{datetime:t.date}}))])}))))]):void 0;return[p("div.top",{key:"mod-"+e.id},[p("span.text",{attrs:{"data-icon":""}},[O(e.username)]),p("a",{attrs:{"data-icon":"L"},hook:B("click",t.close)})]),p("div.mchat__content.moderation",[p("i.line-text.block",['"',e.text,'"']),a,s,i])]}(e)||function(t){const e=t.vm.tab;return[p("div.mchat__tabs.nb_"+t.allTabs.length,[...t.allTabs.map((n=>function(t,e,n){return p("div.mchat__tab."+e,{class:{"mchat__tab-active":e===n},hook:B("click",(()=>t.setTab(e)))},function(t,e){return"discussion"===e?[p("span",t.data.name),t.opts.alwaysEnabled?void 0:p("input",{attrs:{type:"checkbox",title:t.trans.noarg("toggleTheChat"),checked:t.vm.enabled},hook:B("change",(e=>{t.setEnabled(e.target.checked)}))})]:"note"===e?[p("span",t.trans.noarg("notes"))]:t.plugin&&e===t.plugin.tab.key?[p("span",t.plugin.tab.name)]:[]}(t,e))}(t,n,e))),bt(t)]),p("div.mchat__content."+e,"note"===e&&t.note?[P(t.note)]:t.plugin&&e===t.plugin.tab.key?[t.plugin.view()]:ht(t))]}(t))}function bt(t){const e=t.palantir;if(e.enabled())return e.instance?e.instance.render(p):p("div.mchat__tab.palantir.palantir-slot",{attrs:{"data-icon":"",title:"Voice chat"},hook:B("click",(()=>{e.loaded||(e.loaded=!0,lichess.loadScript("javascripts/vendor/peerjs.min.js").then((()=>{lichess.loadModule("palantir").then((()=>{e.instance=window.Palantir.palantir({uid:t.data.userId,redraw:t.redraw}),t.redraw()}))})))}))})}function kt(t){return{insert(e){t(e.elm)}}}function yt(t,e){return kt((n=>n.addEventListener(t,e)))}function wt(t){return p("a.ulpt.user-link.online",{attrs:{href:"/@/"+t.name},hook:{destroy(t){$.powerTip.destroy(t.elm)}}},[p("i.line"+(t.patron?".patron":"")),p("span.name",xt(t)),p("em",` ${t.rating}${t.provisional?"?":""}`)])}const xt=t=>t.title?[p("span.utitle",t.title)," "+t.name]:[t.name];function _t(t){return p("h1",[t.data.fullName,p("span.author",t.trans.vdom("by",wt(t.data.host)))])}function Ct(t,e,n){Ct.close();const a=$('<div id="modal-wrap"><span class="close" data-icon="L"></span></div>'),o=$(`<div id="modal-overlay" class="${e}">`).on("click",Ct.close);return a.appendTo(o),t.clone().removeClass("none").appendTo(a),Ct.onClose=n,a.find(".close").on("click",Ct.close),a.on("click",(t=>t.stopPropagation())),$("body").addClass("overlayed").prepend(o),a}Ct.close=()=>{$("body").removeClass("overlayed"),$("#modal-overlay").each((function(){Ct.onClose&&Ct.onClose(),$(this).remove()})),delete Ct.onClose},Ct.onClose=void 0;const Tt=(t,e)=>t.player.name>e.player.name?1:-1,$t=t=>t.candidates().length?p("a.button.text",{attrs:{"data-icon":"E"},hook:yt("click",(()=>{const e=t.candidates(),n=e[Math.floor(Math.random()*e.length)];M.accept(n.player.id)(t.data.id)}))},"Accept random candidate"):null,jt=(t,e)=>e.length>1?p("a.button.button-green.text",{attrs:{"data-icon":"G"},hook:yt("click",(()=>M.start(t.data.id)))},`Start (${e.length})`):p("a.button.button-red.text",{attrs:{"data-icon":"L"},hook:yt("click",(()=>{confirm("Delete this simul?")&&M.abort(t.data.id)}))},t.trans("cancel")),It=30,Lt=["1","2","3","4","5","6","7","8"];Array.prototype.concat(...["a","b","c","d","e","f","g","h"].map((t=>Lt.map((e=>t+e))))).map((t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49]));const Et=t=>"white"===t?"black":"white";function At(t){return p("div.results",[p("div",Ot(t,"nbPlaying",(t=>t.game.status<It))),p("div",Ot(t,"nbWins",(t=>t.game.winner===t.hostColor))),p("div",Ot(t,"nbDraws",(t=>t.game.status>=It&&!t.game.winner))),p("div",Ot(t,"nbLosses",(t=>t.game.winner===Et(t.hostColor))))])}const Mt=/^(\d+)\s(.+)$/,Nt=/^(.+)\s(\d+)$/,Ot=(t,e,n)=>(t=>{let e;return(e=t.match(Mt))?[p("div.number",e[1]),p("div.text",e[2])]:(e=t.match(Nt))?[p("div.number",e[2]),p("div.text",e[1])]:p("div.text",t)})(t.trans.plural(e,t.data.pairings.filter(n).length));function Bt(t){return p("div.game-list.now-playing.box__pad",t.data.pairings.map(Ht(t)))}const St=(t,e)=>p(`span.mini-game__clock.mini-game__clock--${t}`,{attrs:{"data-time":e,"data-managed":1}}),Ht=t=>e=>{const n=e.game,a=e.player;return p(`span.mini-game.mini-game-${n.id}.mini-game--init.is2d`,{class:{host:t.data.host.gameId===n.id},attrs:{"data-state":`${n.fen},${n.orient},${n.lastMove}`,"data-live":n.clock?n.id:""},hook:kt(lichess.powertip.manualUserIn)},[p("span.mini-game__player",[p("a.mini-game__user.ulpt",{attrs:{href:`/@/${a.name}`}},[p("span.name",a.title?[p("span.utitle",a.title)," ",a.name]:[a.name])," ",p("span.rating",a.rating)]),n.clock?St(Et(n.orient),n.clock[Et(n.orient)]):p("span.mini-game__result",n.winner?n.winner==n.orient?0:1:"½")]),p("a.cg-wrap",{attrs:{href:`/${n.id}/${n.orient}`}}),p("span.mini-game__player",[p("span"),n.clock?St(n.orient,n.clock[n.orient]):p("span.mini-game__result",n.winner?n.winner==n.orient?1:0:"½")])])};function qt(t){const e=t.data.isRunning?Gt:t.data.isFinished?Pt:function(t){return e=>{const n=e.candidates().sort(Tt),a=e.accepted().sort(Tt),o=e.createdByMe(),s=t=>{const n=e.data.variants.find((e=>t.variant==e.key));return n&&p("td.variant",{attrs:{"data-icon":n.icon}})};return[p("div.box__top",[_t(e),p("div.box__top__actions",e.opts.userId?o?[jt(e,a),$t(e)]:e.containsMe()?p("a.button",{hook:yt("click",(()=>M.withdraw(e.data.id)))},e.trans("withdraw")):p("a.button.text"+(e.teamBlock()?".disabled":""),{attrs:{disabled:e.teamBlock(),"data-icon":"G"},hook:e.teamBlock()?{}:yt("click",(()=>{1===e.data.variants.length?M.join(e.data.id,e.data.variants[0].key):(Ct($(".simul .continue-with")),$("#modal-wrap .continue-with a").on("click",(function(){Ct.close(),M.join(e.data.id,$(this).data("variant"))})))}))},e.teamBlock()&&e.data.team?e.trans("mustBeInTeam",e.data.team.name):e.trans("join")):p("a.button.text",{attrs:{"data-icon":"G",href:"/login?referrer="+window.location.pathname}},e.trans("signIn")))]),t(e),e.acceptedContainsMe()?p("p.instructions","You have been selected! Hold still, the simul is about to begin."):o&&e.data.applicants.length<6?p("p.instructions","Share this page URL to let people enter the simul!"):null,p("div.halves",{hook:{postpatch(t,e){lichess.powertip.manualUserIn(e.elm)}}},[p("div.half.candidates",p("table.slist.slist-pad",p("thead",p("tr",p("th",{attrs:{colspan:3}},[p("strong",n.length)," candidate players"]))),p("tbody",n.map((t=>p("tr",{key:t.player.id,class:{me:e.opts.userId===t.player.id}},[p("td",wt(t.player)),s(t),p("td.action",o?[p("a.button",{attrs:{"data-icon":"E",title:"Accept"},hook:yt("click",(()=>M.accept(t.player.id)(e.data.id)))})]:[])])))))),p("div.half.accepted",[p("table.slist.user_list",p("thead",[p("tr",p("th",{attrs:{colspan:3}},[p("strong",a.length)," accepted players"])),o&&n.length&&!a.length?[p("tr.help",p("th","Now you get to accept some players, then start the simul"))]:[]]),p("tbody",a.map((t=>p("tr",{key:t.player.id,class:{me:e.opts.userId===t.player.id}},[p("td",wt(t.player)),s(t),p("td.action",o?[p("a.button.button-red",{attrs:{"data-icon":"L"},hook:yt("click",(()=>M.reject(t.player.id)(e.data.id)))})]:[])])))))])]),e.data.quote?p("blockquote.pull-quote",[p("p",e.data.quote.text),p("footer",e.data.quote.author)]):null,p("div.continue-with.none",e.data.variants.map((function(t){return p("a.button",{attrs:{"data-variant":t.key}},t.name)})))]}}(Rt);return p("main.simul",{class:{"simul-created":t.data.isCreated}},[p("aside.simul__side",{hook:kt((e=>{$(e).replaceWith(t.opts.$side),t.opts.chat&&lichess.makeChat(t.opts.chat)}))}),p("div.simul__main.box",{hook:{postpatch(){lichess.miniGame.initAll()}}},e(t)),p("div.chat__members.none",{hook:kt(lichess.watchers)})])}const Rt=t=>p("div.simul-text",[p("p",{hook:Q(t.data.text)})]),Gt=t=>[_t(t),Rt(t),At(t),Bt(t)],Pt=t=>[p("div.box__top",[_t(t),p("div.box__top__actions",p("div.finished",t.trans("finished")))]),Rt(t),At(t),Bt(t)],zt=u([y,b]);return window.LichessChat=function(t,e){const n=u([y,b]),a=K(e,(function(){s=n(s,vt(a))})),o=vt(a);t.innerHTML="";let s=n(t,o);return a},t.start=function(t){const e=document.querySelector("main.simul");let n;function a(){n=zt(n,qt(o))}lichess.socket=new lichess.StrongSocket(`/simul/${t.data.id}/socket/v4`,t.socketVersion,{receive:(t,e)=>o.socket.receive(t,e)}),t.socketSend=lichess.socket.send,t.element=e,t.$side=$(".simul__side").clone();const o=new N(t,a),s=qt(o);e.innerHTML="",n=zt(e,s),a()},Object.defineProperty(t,"__esModule",{value:!0}),t}({});
