var LichessChallenge=function(){"use strict";const e={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,n){return document.createElementNS(e,t,n)},createTextNode:function(e){return document.createTextNode(e)},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,n){e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){e.appendChild(t)},parentNode:function(e){return e.parentNode},nextSibling:function(e){return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType}};function t(e,t,n,o,i){return{sel:e,data:t,children:n,text:o,elm:i,key:void 0===t?void 0:t.key}}const n=Array.isArray;function o(e){return"string"==typeof e||"number"==typeof e}function i(e){return void 0===e}function r(e){return void 0!==e}const l=t("",{},[],void 0,void 0);function a(e,t){var n,o;const i=e.key===t.key,r=(null===(n=e.data)||void 0===n?void 0:n.is)===(null===(o=t.data)||void 0===o?void 0:o.is);return e.sel===t.sel&&i&&r}function c(e,t,n){var o;const i={};for(let r=t;r<=n;++r){const t=null===(o=e[r])||void 0===o?void 0:o.key;void 0!==t&&(i[t]=r)}return i}const s=["create","update","remove","destroy","pre","post"];function d(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let e=0;e<t.length;++e){const n=t[e].data;void 0!==n&&d(n,t[e].children,t[e].sel)}}function u(e,i,r){let l,a,c,s={};if(void 0!==r?(null!==i&&(s=i),n(r)?l=r:o(r)?a=r:r&&r.sel&&(l=[r])):null!=i&&(n(i)?l=i:o(i)?a=i:i&&i.sel?l=[i]:s=i),void 0!==l)for(c=0;c<l.length;++c)o(l[c])&&(l[c]=t(void 0,void 0,void 0,l[c],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||d(s,l,e),t(e,s,l,a,void 0)}function f(e,t){let n;const o=t.elm;let i=e.data.attrs,r=t.data.attrs;if((i||r)&&i!==r){for(n in i=i||{},r=r||{},r){const e=r[n];i[n]!==e&&(!0===e?o.setAttribute(n,""):!1===e?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,e):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,e):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,e):o.setAttribute(n,e))}for(n in i)n in r||o.removeAttribute(n)}}function h(e,t){let n,o;const i=t.elm;let r=e.data.class,l=t.data.class;if((r||l)&&r!==l){for(o in r=r||{},l=l||{},r)r[o]&&!Object.prototype.hasOwnProperty.call(l,o)&&i.classList.remove(o);for(o in l)n=l[o],n!==r[o]&&i.classList[n?"add":"remove"](o)}}const p={Accept:"application/vnd.lichess.v5+json"},v={cache:"no-cache",credentials:"same-origin"},m={"X-Requested-With":"XMLHttpRequest"},g=(e,t={})=>b(e,t).then((e=>{if(e.ok)return e.text();throw e.statusText})),b=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},v),{headers:Object.assign({},m)}),t)),w=e=>{const t=new FormData;for(const n of Object.keys(e))t.append(n,e[n]);return t};let x=[],y=!1;function k(e){const t=lichess.storage.make("just-notified");if(document.hasFocus()||Date.now()-parseInt(t.get(),10)<1e3)return;t.set(""+Date.now()),$.isFunction(e)&&(e=e());const n=new Notification("lichess.org",{icon:lichess.assetUrl("logo/lichess-favicon-256.png",{noVersion:!0}),body:e});n.onclick=()=>window.focus(),x.push(n),y||(y=!0,window.addEventListener("focus",(()=>{x.forEach((e=>e.close())),x=[]})))}function C(e,t,n){let o=e=>e,i=!1,r={};function l(n){t=n,n.i18n&&(o=lichess.trans(n.i18n).noarg),n.reasons&&(r=n.reasons),e.setCount(t.in.filter((e=>!e.declined)).length),t.in.forEach((n=>{var o;lichess.once("c-"+n.id)&&(!lichess.quietMode&&t.in.length<=3&&(e.show(),lichess.sound.play("newChallenge")),!(parseInt(lichess.storage.get("push-subscribed")||"0",10)+864e5>=Date.now())&&n.challenger&&(o=function(e){const t=e.rating+(e.provisional?"?":"");return(e.title?e.title+" ":"")+e.name+" ("+t+")"}(n.challenger)+" challenges you!",!document.hasFocus()&&"Notification"in window&&"granted"===Notification.permission&&setTimeout(k,10+500*Math.random(),o)),e.pulse())}))}return l(t),{data:()=>t,trans:()=>o,reasons:()=>r,update:l,decline(e,n){t.in.forEach((t=>{t.id===e&&(t.declined=!0,g(`/challenge/${e}/decline`,{method:"post",body:w({reason:n})}).catch((()=>lichess.announce({msg:"Failed to send challenge decline"}))))}))},cancel(e){t.out.forEach((t=>{t.id===e&&(t.declined=!0,g(`/challenge/${e}/cancel`,{method:"post"}).catch((()=>lichess.announce({msg:"Failed to send challenge cancellation"}))))}))},redirecting:()=>i,onRedirect(){i=!0,requestAnimationFrame(n)}}}function N(e){return e.redirecting()?u("div#challenge-app.dropdown",u("div.initiating",u("div.spinner",[u("svg",{attrs:{viewBox:"0 0 40 40"}},[u("circle",{attrs:{cx:20,cy:20,r:18,fill:"none"}})])]))):u("div#challenge-app.links.dropdown.rendered",function(e){const t=e.data(),n=t.in.length+t.out.length;return n?[T(e,t,n)]:[F(),S()]}(e))}function O(e){lichess.powertip.manualUserIn(e.elm)}function T(e,t,n){return u("div.challenges",{class:{many:n>3},hook:{insert:O,postpatch:O}},t.in.map(j(e,"in")).concat(t.out.map(j(e,"out"))))}function j(e,t){return n=>u("div.challenge."+t+".c-"+n.id,{class:{declined:!!n.declined}},[u("div.content",[u("span.head",B("in"===t?n.challenger:n.destUser)),u("span.desc",[e.trans()(n.rated?"rated":"casual"),L(n.timeControl),n.variant.name].join(" • "))]),u("i",{attrs:{"data-icon":n.perf.icon}}),u("div.buttons",("in"===t?A:E)(e,n))])}function A(e,t){const n=e.trans();return[u("form",{attrs:{method:"post",action:`/challenge/${t.id}/accept`}},[u("button.button.accept",{attrs:{type:"submit","data-icon":"E",title:n("accept")},hook:M(e.onRedirect)})]),u("button.button.decline",{attrs:{type:"submit","data-icon":"L",title:n("decline")},hook:M((()=>e.decline(t.id,"generic")))}),u("select.decline-reason",{hook:{insert:n=>{const o=n.elm;o.addEventListener("change",(()=>e.decline(t.id,o.value)))}}},Object.entries(e.reasons()).map((([e,t])=>u("option",{attrs:{value:e}},"generic"==e?"":t))))]}function E(e,t){const n=e.trans();return[u("div.owner",[u("span.waiting",e.trans()("waiting")),u("a.view",{attrs:{"data-icon":"v",href:"/"+t.id,title:n("viewInFullSize")}})]),u("button.button.decline",{attrs:{"data-icon":"L",title:n("cancel")},hook:M((()=>e.cancel(t.id)))})]}function L(e){switch(e.type){case"unlimited":return"Unlimited";case"correspondence":return e.daysPerTurn+" days";case"clock":return e.show||"-"}}function B(e){if(!e)return u("span","Open challenge");const t=e.rating+(e.provisional?"?":"");return u("a.ulpt.user-link",{attrs:{href:`/@/${e.name}`},class:{online:!!e.online}},[u("i.line"+(e.patron?".patron":"")),u("name",[e.title&&u("span.utitle","BOT"==e.title?{attrs:{"data-bot":!0}}:{},e.title+" "),e.name+" ("+t+") "]),u("signal",void 0===e.lag?[]:[1,2,3,4].map((t=>u("i",{class:{off:e.lag<t}}))))])}function S(){return u("a.create",{attrs:{href:"/?any#friend","data-icon":"O",title:"Challenge someone"}})}function F(){return u("div.empty.text",{attrs:{"data-icon":""}},"No challenges.")}function M(e){return{insert:t=>{t.elm.addEventListener("click",e)}}}const q=function(d,u){let f,h;const p={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},v=void 0!==u?u:e;for(f=0;f<s.length;++f)for(p[s[f]]=[],h=0;h<d.length;++h){const e=d[h][s[f]];void 0!==e&&p[s[f]].push(e)}function m(e){const n=e.id?"#"+e.id:"",o=e.className?"."+e.className.split(" ").join("."):"";return t(v.tagName(e).toLowerCase()+n+o,{},[],void 0,e)}function g(e,t){return function(){if(0==--t){const t=v.parentNode(e);v.removeChild(t,e)}}}function b(e,t){var a,c;let s,d=e.data;if(void 0!==d){const t=null===(a=d.hook)||void 0===a?void 0:a.init;r(t)&&(t(e),d=e.data)}const u=e.children,f=e.sel;if("!"===f)i(e.text)&&(e.text=""),e.elm=v.createComment(e.text);else if(void 0!==f){const i=f.indexOf("#"),a=f.indexOf(".",i),h=i>0?i:f.length,m=a>0?a:f.length,g=-1!==i||-1!==a?f.slice(0,Math.min(h,m)):f,w=e.elm=r(d)&&r(s=d.ns)?v.createElementNS(s,g,d):v.createElement(g,d);for(h<m&&w.setAttribute("id",f.slice(h+1,m)),a>0&&w.setAttribute("class",f.slice(m+1).replace(/\./g," ")),s=0;s<p.create.length;++s)p.create[s](l,e);if(n(u))for(s=0;s<u.length;++s){const e=u[s];null!=e&&v.appendChild(w,b(e,t))}else o(e.text)&&v.appendChild(w,v.createTextNode(e.text));const x=e.data.hook;r(x)&&(null===(c=x.create)||void 0===c||c.call(x,l,e),x.insert&&t.push(e))}else e.elm=v.createTextNode(e.text);return e.elm}function w(e,t,n,o,i,r){for(;o<=i;++o){const i=n[o];null!=i&&v.insertBefore(e,b(i,r),t)}}function x(e){var t,n;const o=e.data;if(void 0!==o){null===(n=null===(t=null==o?void 0:o.hook)||void 0===t?void 0:t.destroy)||void 0===n||n.call(t,e);for(let t=0;t<p.destroy.length;++t)p.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const n=e.children[t];null!=n&&"string"!=typeof n&&x(n)}}}function y(e,t,n,o){for(var i,l;n<=o;++n){let o,a;const c=t[n];if(null!=c)if(r(c.sel)){x(c),o=p.remove.length+1,a=g(c.elm,o);for(let e=0;e<p.remove.length;++e)p.remove[e](c,a);const e=null===(l=null===(i=null==c?void 0:c.data)||void 0===i?void 0:i.hook)||void 0===l?void 0:l.remove;r(e)?e(c,a):a()}else v.removeChild(e,c.elm)}}function k(e,t,n){var o,l,s,d,u;const f=null===(o=t.data)||void 0===o?void 0:o.hook;null===(l=null==f?void 0:f.prepatch)||void 0===l||l.call(f,e,t);const h=t.elm=e.elm,m=e.children,g=t.children;if(e!==t){if(void 0!==t.data){for(let n=0;n<p.update.length;++n)p.update[n](e,t);null===(d=null===(s=t.data.hook)||void 0===s?void 0:s.update)||void 0===d||d.call(s,e,t)}i(t.text)?r(m)&&r(g)?m!==g&&function(e,t,n,o){let r,l,s,d,u=0,f=0,h=t.length-1,p=t[0],m=t[h],g=n.length-1,x=n[0],C=n[g];for(;u<=h&&f<=g;)null==p?p=t[++u]:null==m?m=t[--h]:null==x?x=n[++f]:null==C?C=n[--g]:a(p,x)?(k(p,x,o),p=t[++u],x=n[++f]):a(m,C)?(k(m,C,o),m=t[--h],C=n[--g]):a(p,C)?(k(p,C,o),v.insertBefore(e,p.elm,v.nextSibling(m.elm)),p=t[++u],C=n[--g]):a(m,x)?(k(m,x,o),v.insertBefore(e,m.elm,p.elm),m=t[--h],x=n[++f]):(void 0===r&&(r=c(t,u,h)),l=r[x.key],i(l)?v.insertBefore(e,b(x,o),p.elm):(s=t[l],s.sel!==x.sel?v.insertBefore(e,b(x,o),p.elm):(k(s,x,o),t[l]=void 0,v.insertBefore(e,s.elm,p.elm))),x=n[++f]);(u<=h||f<=g)&&(u>h?(d=null==n[g+1]?null:n[g+1].elm,w(e,d,n,f,g,o)):y(e,t,u,h))}(h,m,g,n):r(g)?(r(e.text)&&v.setTextContent(h,""),w(h,null,g,0,g.length-1,n)):r(m)?y(h,m,0,m.length-1):r(e.text)&&v.setTextContent(h,""):e.text!==t.text&&(r(m)&&y(h,m,0,m.length-1),v.setTextContent(h,t.text)),null===(u=null==f?void 0:f.postpatch)||void 0===u||u.call(f,e,t)}}return function(e,t){let n,o,i;const r=[];for(n=0;n<p.pre.length;++n)p.pre[n]();for(function(e){return void 0!==e.sel}(e)||(e=m(e)),a(e,t)?k(e,t,r):(o=e.elm,i=v.parentNode(o),b(t,r),null!==i&&(v.insertBefore(i,t.elm,v.nextSibling(o)),y(i,[e],0,0))),n=0;n<r.length;++n)r[n].data.hook.insert(r[n]);for(n=0;n<p.post.length;++n)p.post[n]();return t}}([{create:h,update:h},{create:f,update:f}]);return function(e,t){let n,o;function i(){n=q(n||e,o?N(o):u("div#challenge-app.links.dropdown.rendered",[u("div.empty.loading","-"),S()]))}function r(n){o?o.update(n):(o=C(t,n,i),e.innerHTML=""),i()}return t.data?r(t.data):((e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},v),{headers:Object.assign(Object.assign({},p),m)}),t)).then((e=>{if(e.ok)return e.json();throw e.statusText})))("/challenge").then(r,(e=>lichess.announce({msg:"Failed to load challenges"}))),{update:r}}}();
