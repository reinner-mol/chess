var LichessLobby=function(){"use strict";const e={Accept:"application/vnd.lichess.v5+json"},t={cache:"no-cache",credentials:"same-origin"},n={"X-Requested-With":"XMLHttpRequest"},o=(o,i={})=>fetch(o,Object.assign(Object.assign(Object.assign({},t),{headers:Object.assign(Object.assign({},e),n)}),i)).then((e=>{if(e.ok)return e.json();throw e.statusText})),i=(e,t={})=>s(e,t).then((e=>{if(e.ok)return e.text();throw e.statusText})),s=(e,o={})=>fetch(e,Object.assign(Object.assign(Object.assign({},t),{headers:Object.assign({},n)}),o)),r=e=>{const t=new FormData;for(const n of Object.keys(e))t.append(n,e[n]);return t};const a={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,n){return document.createElementNS(e,t,n)},createTextNode:function(e){return document.createTextNode(e)},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,n){e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){e.appendChild(t)},parentNode:function(e){return e.parentNode},nextSibling:function(e){return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType}};function c(e,t,n,o,i){return{sel:e,data:t,children:n,text:o,elm:i,key:void 0===t?void 0:t.key}}const l=Array.isArray;function d(e){return"string"==typeof e||"number"==typeof e}function u(e){return void 0===e}function h(e){return void 0!==e}const p=c("",{},[],void 0,void 0);function f(e,t){var n,o;const i=e.key===t.key,s=(null===(n=e.data)||void 0===n?void 0:n.is)===(null===(o=t.data)||void 0===o?void 0:o.is);return e.sel===t.sel&&i&&s}function g(e,t,n){var o;const i={};for(let s=t;s<=n;++s){const t=null===(o=e[s])||void 0===o?void 0:o.key;void 0!==t&&(i[t]=s)}return i}const m=["create","update","remove","destroy","pre","post"];function v(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let e=0;e<t.length;++e){const n=t[e].data;void 0!==n&&v(n,t[e].children,t[e].sel)}}function b(e,t,n){let o,i,s,r={};if(void 0!==n?(null!==t&&(r=t),l(n)?o=n:d(n)?i=n:n&&n.sel&&(o=[n])):null!=t&&(l(t)?o=t:d(t)?i=t:t&&t.sel?o=[t]:r=t),void 0!==o)for(s=0;s<o.length;++s)d(o[s])&&(o[s]=c(void 0,void 0,void 0,o[s],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||v(r,o,e),c(e,r,o,i,void 0)}function k(e,t){let n;const o=t.elm;let i=e.data.attrs,s=t.data.attrs;if((i||s)&&i!==s){for(n in i=i||{},s=s||{},s){const e=s[n];i[n]!==e&&(!0===e?o.setAttribute(n,""):!1===e?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,e):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,e):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,e):o.setAttribute(n,e))}for(n in i)n in s||o.removeAttribute(n)}}const w={create:k,update:k};function y(e,t){let n,o;const i=t.elm;let s=e.data.class,r=t.data.class;if((s||r)&&s!==r){for(o in s=s||{},r=r||{},s)s[o]&&!Object.prototype.hasOwnProperty.call(r,o)&&i.classList.remove(o);for(o in r)n=r[o],n!==s[o]&&i.classList[n?"add":"remove"](o)}}const C={create:y,update:y},T=["white","black"],x=["a","b","c","d","e","f","g","h"],M=["1","2","3","4","5","6","7","8"],S=[...M].reverse(),_=Array.prototype.concat(...x.map((e=>M.map((t=>e+t))))),P=e=>_[8*e[0]+e[1]],A=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],O=_.map(A);const I=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},L=e=>"white"===e?"black":"white",N=(e,t)=>{const n=e[0]-t[0],o=e[1]-t[1];return n*n+o*o},j=(e,t)=>e.role===t.role&&e.color===t.color,H=(e,t,n,o)=>[(t?e[0]:7-e[0])*n,(t?7-e[1]:e[1])*o],B=e=>{const t=e.width/8,n=e.height/8;return(e,o)=>H(e,o,t,n)},E=(e,t)=>H(e,t,100,100),R=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},F=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},D=(e,t)=>{e.style.visibility=t?"visible":"hidden"},K=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},q=e=>2===e.buttons||2===e.button,z=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function W(e,t,n){const o=A(e);return t||(o[0]=7-o[0],o[1]=7-o[1]),[n.left+n.width*o[0]/8+n.width/16,n.top+n.height*(7-o[1])/8+n.height/16]}function G(e,t){return Math.abs(e-t)}const V=(e,t,n,o)=>{const i=G(e,n),s=G(t,o);return 1===i&&2===s||2===i&&1===s},U=(e,t,n,o)=>G(e,n)===G(t,o),X=(e,t,n,o)=>e===n||t===o,Z=(e,t,n,o)=>U(e,t,n,o)||X(e,t,n,o);function Y(e,t,n){const o=e.get(t);if(!o)return[];const i=A(t),s=o.role,r="pawn"===s?(a=o.color,(e,t,n,o)=>G(e,n)<2&&("white"===a?o===t+1||t<=1&&o===t+2&&e===n:o===t-1||t>=6&&o===t-2&&e===n)):"knight"===s?V:"bishop"===s?U:"rook"===s?X:"queen"===s?Z:function(e,t,n){return(o,i,s,r)=>G(o,s)<2&&G(i,r)<2||n&&i===r&&i===("white"===e?0:7)&&(4===o&&(2===s&&t.includes(0)||6===s&&t.includes(7))||t.includes(s))}(o.color,function(e,t){const n="white"===t?"1":"8",o=[];for(const[i,s]of e)i[1]===n&&s.color===t&&"rook"===s.role&&o.push(A(i)[0]);return o}(e,o.color),n);var a;return O.filter((e=>(i[0]!==e[0]||i[1]!==e[1])&&r(i[0],i[1],e[0],e[1]))).map(P)}function J(e,...t){e&&setTimeout((()=>e(...t)),1)}function Q(e){e.premovable.current&&(e.premovable.current=void 0,J(e.premovable.events.unset))}function ee(e){const t=e.predroppable;t.current&&(t.current=void 0,J(t.events.unset))}function te(e,t,n){const o=e.pieces.get(t),i=e.pieces.get(n);if(t===n||!o)return!1;const s=i&&i.color!==o.color?i:void 0;return n===e.selected&&ce(e),J(e.events.move,t,n,s),function(e,t,n){if(!e.autoCastle)return!1;const o=e.pieces.get(t);if(!o||"king"!==o.role)return!1;const i=A(t),s=A(n);if(0!==i[1]&&7!==i[1]||i[1]!==s[1])return!1;4!==i[0]||e.pieces.has(n)||(6===s[0]?n=P([7,s[1]]):2===s[0]&&(n=P([0,s[1]])));const r=e.pieces.get(n);return!(!r||r.color!==o.color||"rook"!==r.role||(e.pieces.delete(t),e.pieces.delete(n),i[0]<s[0]?(e.pieces.set(P([6,s[1]]),o),e.pieces.set(P([5,s[1]]),r)):(e.pieces.set(P([2,s[1]]),o),e.pieces.set(P([3,s[1]]),r)),0))}(e,t,n)||(e.pieces.set(n,o),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,J(e.events.change),s||!0}function ne(e,t,n,o){if(e.pieces.has(n)){if(!o)return!1;e.pieces.delete(n)}return J(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,J(e.events.change),e.movable.dests=void 0,e.turnColor=L(e.turnColor),!0}function oe(e,t,n){const o=te(e,t,n);return o&&(e.movable.dests=void 0,e.turnColor=L(e.turnColor),e.animation.current=void 0),o}function ie(e,t,n){if(de(e,t,n)){const o=oe(e,t,n);if(o){const i=e.hold.stop();ce(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return!0!==o&&(s.captured=o),J(e.movable.events.after,t,n,s),!0}}else if(function(e,t,n){return t!==n&&ue(e,t)&&Y(e.pieces,t,e.premovable.castle).includes(n)}(e,t,n))return function(e,t,n,o){ee(e),e.premovable.current=[t,n],J(e.premovable.events.set,t,n,o)}(e,t,n,{ctrlKey:e.stats.ctrlKey}),ce(e),!0;return ce(e),!1}function se(e,t,n,o){const i=e.pieces.get(t);i&&(function(e,t,n){const o=e.pieces.get(t);return!(!o||t!==n&&e.pieces.has(n)||"both"!==e.movable.color&&(e.movable.color!==o.color||e.turnColor!==o.color))}(e,t,n)||o)?(e.pieces.delete(t),ne(e,i,n,o),J(e.movable.events.afterNewPiece,i.role,n,{premove:!1,predrop:!1})):i&&function(e,t,n){const o=e.pieces.get(t),i=e.pieces.get(n);return!!o&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==o.role||"1"!==n[1]&&"8"!==n[1])&&e.movable.color===o.color&&e.turnColor!==o.color}(e,t,n)?function(e,t,n){Q(e),e.predroppable.current={role:t,key:n},J(e.predroppable.events.set,t,n)}(e,i.role,n):(Q(e),ee(e)),e.pieces.delete(t),ce(e)}function re(e,t,n){if(J(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return ce(e),void e.hold.cancel();if((e.selectable.enabled||n)&&e.selected!==t&&ie(e,e.selected,t))return void(e.stats.dragged=!1)}(le(e,t)||ue(e,t))&&(ae(e,t),e.hold.start())}function ae(e,t){e.selected=t,ue(e,t)?e.premovable.dests=Y(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function ce(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function le(e,t){const n=e.pieces.get(t);return!!n&&("both"===e.movable.color||e.movable.color===n.color&&e.turnColor===n.color)}function de(e,t,n){var o,i;return t!==n&&le(e,t)&&(e.movable.free||!!(null===(i=null===(o=e.movable.dests)||void 0===o?void 0:o.get(t))||void 0===i?void 0:i.includes(n)))}function ue(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function he(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],o=t[1];let i=!1;if(de(e,n,o)){const t=oe(e,n,o);if(t){const s={premove:!0};!0!==t&&(s.captured=t),J(e.movable.events.after,n,o,s),i=!0}}return Q(e),i}function pe(e){Q(e),ee(e),ce(e)}function fe(e){e.movable.color=e.movable.dests=e.animation.current=void 0,pe(e)}function ge(e,t,n){let o=Math.floor(8*(e[0]-n.left)/n.width);t||(o=7-o);let i=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(i=7-i),o>=0&&o<8&&i>=0&&i<8?P([o,i]):void 0}function me(e){return"white"===e.orientation}const ve="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",be={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},ke={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function we(e){"start"===e&&(e=ve);const t=new Map;let n=7,o=0;for(const i of e)switch(i){case" ":return t;case"/":if(--n,n<0)return t;o=0;break;case"~":{const e=t.get(P([o,n]));e&&(e.promoted=!0);break}default:{const e=i.charCodeAt(0);if(e<57)o+=e-48;else{const e=i.toLowerCase();t.set(P([o,n]),{role:be[e],color:i===e?"black":"white"}),++o}}}return t}function ye(e,t){var n,o;if((null===(n=t.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(o=t.drawable)||void 0===o?void 0:o.autoShapes)&&(e.drawable.autoShapes=[]),Ce(e,t),t.fen&&(e.pieces=we(t.fen),e.drawable.shapes=[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[n,o]of e.pieces)"king"===o.role&&o.color===t&&(e.check=n)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&ae(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",n="e"+t,o=e.movable.dests.get(n),i=e.pieces.get(n);if(!o||!i||"king"!==i.role)return;e.movable.dests.set(n,o.filter((e=>!(e==="a"+t&&o.includes("c"+t)||e==="h"+t&&o.includes("g"+t)))))}}function Ce(e,t){for(const n in t)Te(e[n])&&Te(t[n])?Ce(e[n],t[n]):e[n]=t[n]}function Te(e){return"object"==typeof e}function xe(e,t){return t.animation.enabled?function(e,t){const n=new Map(t.pieces),o=e(t),i=function(e,t){const n=new Map,o=[],i=new Map,s=[],r=[],a=new Map;let c,l,d;for(const[t,n]of e)a.set(t,Se(t,n));for(const e of _)c=t.pieces.get(e),l=a.get(e),c?l?j(c,l.piece)||(s.push(l),r.push(Se(e,c))):r.push(Se(e,c)):l&&s.push(l);for(const e of r)l=_e(e,s.filter((t=>j(e.piece,t.piece)))),l&&(d=[l.pos[0]-e.pos[0],l.pos[1]-e.pos[1]],n.set(e.key,d.concat(d)),o.push(l.key));for(const e of s)o.includes(e.key)||i.set(e.key,e.piece);return{anims:n,fadings:i}}(n,t);if(i.anims.size||i.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},e||Pe(t,performance.now())}else t.dom.redraw();return o}(e,t):Me(e,t)}function Me(e,t){const n=e(t);return t.dom.redraw(),n}function Se(e,t){return{key:e,pos:A(e),piece:t}}function _e(e,t){return t.sort(((t,n)=>N(e.pos,t.pos)-N(e.pos,n.pos)))[0]}function Pe(e,t){const n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());const o=1-(t-n.start)*n.frequency;if(o<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=(i=o)<.5?4*i*i*i:(i-1)*(2*i-2)*(2*i-2)+1;for(const e of n.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>Pe(e,t)))}var i}const Ae=["green","red","blue","yellow"];function $e(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?ce(e):pe(e);const n=K(t),o=ge(n,me(e),e.dom.bounds());o&&(e.drawable.current={orig:o,pos:n,brush:je(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Oe(e))}function Oe(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const n=ge(t.pos,me(e),e.dom.bounds());n||(t.snapToValidMove=!1);const o=t.snapToValidMove?function(e,t,n,o){const i=A(e),s=O.filter((e=>Z(i[0],i[1],e[0],e[1])||V(i[0],i[1],e[0],e[1]))),r=s.map((e=>W(P(e),n,o))).map((e=>N(t,e))),[,a]=r.reduce(((e,t,n)=>e[0]<t?e:[t,n]),[r[0],0]);return P(s[a])}(t.orig,t.pos,me(e),e.dom.bounds()):n;o!==t.mouseSq&&(t.mouseSq=o,t.dest=o!==t.orig?o:void 0,e.dom.redrawNow()),Oe(e)}}))}function Ie(e,t){e.drawable.current&&(e.drawable.current.pos=K(t))}function Le(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const n=e=>e.orig===t.orig&&e.dest===t.dest,o=e.shapes.find(n);o&&(e.shapes=e.shapes.filter((e=>!n(e))));o&&o.brush===t.brush||e.shapes.push(t);He(e)}(e.drawable,t),Ne(e))}function Ne(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function je(e){var t;const n=(e.shiftKey||e.ctrlKey)&&q(e),o=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return Ae[(n?1:0)+(o?2:0)]}function He(e){e.onChange&&e.onChange(e.shapes)}function Be(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),o=K(t),i=ge(o,me(e),n);if(!i)return;const s=e.pieces.get(i),r=e.selected;var a;r||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),He(a.drawable)),!1===t.cancelable||t.touches&&e.movable.color&&!s&&!r&&!function(e,t){const n=me(e),o=e.dom.bounds(),i=Math.pow(o.width/8,2);for(const s in e.pieces){const e=W(s,n,o);if(N(e,t)<=i)return!0}return!1}(e,o)||t.preventDefault();const c=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&de(e,e.selected,i)?xe((e=>re(e,i)),e):re(e,i);const d=e.selected===i,u=qe(e,i);if(s&&u&&d&&function(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}(e,i)){e.draggable.current={orig:i,piece:s,origPos:o,pos:o,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:r,originTarget:t.target},u.cgDragging=!0,u.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${s.color} ${s.role}`,R(a,B(n)(A(i),me(e))),D(a,!0)),Ee(e)}else c&&Q(e),l&&ee(e);e.dom.redraw()}function Ee(e){requestAnimationFrame((()=>{var t;const n=e.draggable.current;if(!n)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(n.orig))&&(e.animation.current=void 0);const o=e.pieces.get(n.orig);if(o&&j(o,n.piece)){if(!n.started&&N(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const e=n.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),n.element=e}const t=e.dom.bounds();R(n.element,[n.pos[0]-t.left-t.width/16,n.pos[1]-t.top-t.height/16])}}else De(e);Ee(e)}))}function Re(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=K(t))}function Fe(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);Q(e),ee(e);const o=ge(K(t)||n.pos,me(e),e.dom.bounds());o&&n.started&&n.orig!==o?n.newPiece?se(e,n.orig,o,n.force):(e.stats.ctrlKey=t.ctrlKey,ie(e,n.orig,o)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!o&&(e.pieces.delete(n.orig),J(e.events.change)),(n.orig!==n.previouslySelected||n.orig!==o&&o)&&e.selectable.enabled||ce(e),Ke(e),e.draggable.current=void 0,e.dom.redraw()}function De(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,ce(e),Ke(e),e.dom.redraw())}function Ke(e){const t=e.dom.elements;t.ghost&&D(t.ghost,!1)}function qe(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function ze(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function We(e,t){function n(){!function(e){e.orientation=L(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&n(),(t.fen?xe:Me)((e=>ye(e,t)),e)},state:e,getFen:()=>{return t=e.pieces,S.map((e=>x.map((n=>{const o=t.get(n+e);if(o){const e=ke[o.role];return"white"===o.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:n,setPieces(t){xe((e=>function(e,t){for(const[n,o]of t)o?e.pieces.set(n,o):e.pieces.delete(n)}(e,t)),e)},selectSquare(t,n){t?xe((e=>re(e,t,n)),e):e.selected&&(ce(e),e.dom.redraw())},move(t,n){xe((e=>te(e,t,n)),e)},newPiece(t,n){xe((e=>ne(e,t,n)),e)},playPremove(){if(e.premovable.current){if(xe(he,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const n=function(e,t){const n=e.predroppable.current;let o=!1;if(!n)return!1;t(n)&&ne(e,{role:n.role,color:e.movable.color},n.key)&&(J(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),o=!0);return ee(e),o}(e,t);return e.dom.redraw(),n}return!1},cancelPremove(){Me(Q,e)},cancelPredrop(){Me(ee,e)},cancelMove(){Me((e=>{pe(e),De(e)}),e)},stop(){Me((e=>{fe(e),De(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{ze(e,2),setTimeout((()=>ze(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){Me((e=>e.drawable.autoShapes=t),e)},setShapes(t){Me((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>ge(t,me(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,n,o){!function(e,t,n,o){const i="a0";e.pieces.set(i,t),e.dom.redraw();const s=K(n);e.draggable.current={orig:i,piece:t,origPos:s,pos:s,started:!0,element:()=>qe(e,i),originTarget:n.target,newPiece:!0,force:!!o},Ee(e)}(e,t,n,o)},destroy(){fe(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Ge(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Ve(e,t,n){const o=e.drawable,i=o.current,s=i&&i.mouseSq?i:void 0,r=new Map,a=e.dom.bounds();for(const e of o.shapes.concat(o.autoShapes).concat(s?[s]:[]))e.dest&&r.set(e.dest,(r.get(e.dest)||0)+1);const c=o.shapes.concat(o.autoShapes).map((e=>({shape:e,current:!1,hash:Xe(e,r,!1,a)})));s&&c.push({shape:s,current:!0,hash:Xe(s,r,!0,a)});const l=c.map((e=>e.hash)).join(";");if(l===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=l;const d=t.querySelector("defs"),u=t.querySelector("g"),h=n.querySelector("g");!function(e,t,n){const o=new Map;let i;for(const n of t)n.shape.dest&&(i=e.brushes[n.shape.brush],n.shape.modifiers&&(i=nt(i,n.shape.modifiers)),o.set(i.key,i));const s=new Set;let r=n.firstChild;for(;r;)s.add(r.getAttribute("cgKey")),r=r.nextSibling;for(const[e,t]of o.entries())s.has(e)||n.appendChild(Qe(t))}(o,c,d),Ue(e,c.filter((e=>!e.shape.customSvg)),o.brushes,r,u),Ue(e,c.filter((e=>e.shape.customSvg)),o.brushes,r,h)}function Ue(e,t,n,o,i){const s=e.dom.bounds(),r=new Map,a=[];for(const e of t)r.set(e.hash,!1);let c,l=i.firstChild;for(;l;)c=l.getAttribute("cgHash"),r.has(c)?r.set(c,!0):a.push(l),l=l.nextSibling;for(const e of a)i.removeChild(e);for(const a of t)r.get(a.hash)||i.appendChild(Je(e,a,n,o,s))}function Xe({orig:e,dest:t,brush:n,piece:o,modifiers:i,customSvg:s},r,a,c){return[c.width,c.height,a,e,t,n,t&&(r.get(t)||0)>1,o&&Ze(o),i&&(l=i,""+(l.lineWidth||"")),s&&Ye(s)].filter((e=>e)).join(",");var l}function Ze(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function Ye(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return"custom-"+t.toString()}function Je(e,{shape:t,current:n,hash:o},i,s,r){let a;if(t.customSvg){const n=tt(A(t.orig),e.orientation);a=function(e,t,n){const{width:o,height:i}=n,s=o/8,r=i/8,a=t[0]*s,c=(7-t[1])*r,l=et(Ge("g"),{transform:`translate(${a},${c})`}),d=et(Ge("svg"),{width:s,height:r,viewBox:"0 0 100 100"});return l.appendChild(d),d.innerHTML=e,l}(t.customSvg,n,r)}else if(t.piece)a=function(e,t,n,o){const i=st(t,o),s=o.width/8*(n.scale||1),r=n.color[0]+("knight"===n.role?"n":n.role[0]).toUpperCase();return et(Ge("image"),{className:`${n.role} ${n.color}`,x:i[0]-s/2,y:i[1]-s/2,width:s,height:s,href:e+r+".svg"})}(e.drawable.pieces.baseUrl,tt(A(t.orig),e.orientation),t.piece,r);else{const o=tt(A(t.orig),e.orientation);if(t.dest){let c=i[t.brush];t.modifiers&&(c=nt(c,t.modifiers)),a=function(e,t,n,o,i,s){const r=function(e,t){return(t?20:10)/512*e.width}(s,i&&!o),a=st(t,s),c=st(n,s),l=c[0]-a[0],d=c[1]-a[1],u=Math.atan2(d,l),h=Math.cos(u)*r,p=Math.sin(u)*r;return et(Ge("line"),{stroke:e.color,"stroke-width":ot(e,o,s),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:it(e,o),x1:a[0],y1:a[1],x2:c[0]-h,y2:c[1]-p})}(c,o,tt(A(t.dest),e.orientation),n,(s.get(t.dest)||0)>1,r)}else a=function(e,t,n,o){const i=st(t,o),s=function(e){const t=e.width/512;return[3*t,4*t]}(o),r=(o.width+o.height)/32;return et(Ge("circle"),{stroke:e.color,"stroke-width":s[n?0:1],fill:"none",opacity:it(e,n),cx:i[0],cy:i[1],r:r-s[1]/2})}(i[t.brush],o,n,r)}return a.setAttribute("cgHash",o),a}function Qe(e){const t=et(Ge("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(et(Ge("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function et(e,t){for(const n in t)e.setAttribute(n,t[n]);return e}function tt(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function nt(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function ot(e,t,n){return(e.lineWidth||10)*(t?.85:1)/512*n.width}function it(e,t){return(e.opacity||1)*(t?.9:1)}function st(e,t){return[(e[0]+.5)*t.width/8,(7.5-e[1])*t.height/8]}function rt(e,t){const n=z("coords",t);let o;for(const t of e)o=z("coord"),o.textContent=t,n.appendChild(o);return n}function at(e,t){const n=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(n)}if(e.viewOnly)return;const o=function(e){return t=>{e.draggable.current?De(e):e.drawable.current?Ne(e):t.shiftKey||q(t)?e.drawable.enabled&&$e(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;Q(e),ee(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const o=K(t),i=o&&ge(o,me(e),e.dom.bounds());i&&se(e,"a0",i)}e.dom.redraw()}(e,t):Be(e,t))}}(e);n.addEventListener("touchstart",o,{passive:!1}),n.addEventListener("mousedown",o,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault()))}function ct(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function lt(e,t,n){return o=>{e.drawable.current?e.drawable.enabled&&n(e,o):e.viewOnly||t(e,o)}}function dt(e){const t=me(e),n=e.dom.relative?E:B(e.dom.bounds()),o=e.dom.relative?F:R,i=e.dom.elements.board,s=e.pieces,r=e.animation.current,a=r?r.plan.anims:new Map,c=r?r.plan.fadings:new Map,l=e.draggable.current,d=function(e){var t;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)mt(n,t,"last-move");e.check&&e.highlight.check&&mt(n,e.check,"check");if(e.selected&&(mt(n,e.selected,"selected"),e.movable.showDests)){const o=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(o)for(const t of o)mt(n,t,"move-dest"+(e.pieces.has(t)?" oc":""));const i=e.premovable.dests;if(i)for(const t of i)mt(n,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const o=e.premovable.current;if(o)for(const e of o)mt(n,e,"current-premove");else e.predroppable.current&&mt(n,e.predroppable.current.key,"current-premove");const i=e.exploding;if(i)for(const e of i.keys)mt(n,e,"exploding"+i.stage);return n}(e),u=new Set,h=new Set,p=new Map,f=new Map;let g,m,v,b,k,w,y,C,T,x;for(m=i.firstChild;m;){if(g=m.cgKey,ut(m))if(v=s.get(g),k=a.get(g),w=c.get(g),b=m.cgPiece,!m.cgDragging||l&&l.orig===g||(m.classList.remove("dragging"),o(m,n(A(g),t)),m.cgDragging=!1),!w&&m.cgFading&&(m.cgFading=!1,m.classList.remove("fading")),v){if(k&&m.cgAnimating&&b===gt(v)){const e=A(g);e[0]+=k[2],e[1]+=k[3],m.classList.add("anim"),o(m,n(e,t))}else m.cgAnimating&&(m.cgAnimating=!1,m.classList.remove("anim"),o(m,n(A(g),t)),e.addPieceZIndex&&(m.style.zIndex=ft(A(g),t)));b!==gt(v)||w&&m.cgFading?w&&b===gt(w)?(m.classList.add("fading"),m.cgFading=!0):vt(p,b,m):u.add(g)}else vt(p,b,m);else if(ht(m)){const e=m.className;d.get(g)===e?h.add(g):vt(f,e,m)}m=m.nextSibling}for(const[e,s]of d)if(!h.has(e)){T=f.get(s),x=T&&T.pop();const r=n(A(e),t);if(x)x.cgKey=e,o(x,r);else{const t=z("square",s);t.cgKey=e,o(t,r),i.insertBefore(t,i.firstChild)}}for(const[r,c]of s)if(k=a.get(r),!u.has(r))if(y=p.get(gt(c)),C=y&&y.pop(),C){C.cgKey=r,C.cgFading&&(C.classList.remove("fading"),C.cgFading=!1);const i=A(r);e.addPieceZIndex&&(C.style.zIndex=ft(i,t)),k&&(C.cgAnimating=!0,C.classList.add("anim"),i[0]+=k[2],i[1]+=k[3]),o(C,n(i,t))}else{const s=gt(c),a=z("piece",s),l=A(r);a.cgPiece=s,a.cgKey=r,k&&(a.cgAnimating=!0,l[0]+=k[2],l[1]+=k[3]),o(a,n(l,t)),e.addPieceZIndex&&(a.style.zIndex=ft(l,t)),i.appendChild(a)}for(const t of p.values())pt(e,t);for(const t of f.values())pt(e,t)}function ut(e){return"PIECE"===e.tagName}function ht(e){return"SQUARE"===e.tagName}function pt(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function ft(e,t){let n=2+8*e[1]+(7-e[0]);return t&&(n=67-n),n+""}function gt(e){return`${e.color} ${e.role}`}function mt(e,t,n){const o=e.get(t);o?e.set(t,`${o} ${n}`):e.set(t,n)}function vt(e,t,n){const o=e.get(t);o?o.push(n):e.set(t,[n])}function bt(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}const kt={chess960:"This is a Chess960 game!\n\nThe starting position of the pieces on the players' home ranks is randomized.",kingOfTheHill:"This is a King of the Hill game!\n\nThe game can be won by bringing the king to the center.",threeCheck:"This is a Three-check game!\n\nThe game can be won by checking the opponent three times.",antichess:"This is an Antichess game!\n\nIf you can take a piece, you must. The game can be won by losing all your pieces, or by being stalemated.",atomic:"This is an Atomic chess game!\n\nCapturing a piece causes an explosion, taking out your piece and surrounding non-pawns. Win by mating or exploding your opponent's king.",horde:"This is a Horde chess game!\nBlack must take all White pawns to win. White must checkmate the Black king.",racingKings:"This is a Racing Kings game!\n\nPlayers must race their kings to the eighth rank. Checks are not allowed.",crazyhouse:"This is a Crazyhouse game!\n\nEvery time a piece is captured, the capturing player gets a piece of the same type and of their color in their pocket."};function wt(e){return"lobby.variant."+e}function yt(e){return Object.keys(kt).every((function(t){const n=kt[t];if(e!==t||lichess.storage.get(wt(t)))return!0;{const e=confirm(n);return e&&lichess.storage.set(wt(t),"1"),e}}))}function Ct(e,t){return(e.rating||0)>(t.rating||0)?-1:1}function Tt(e,t){return e.t<t.t?-1:1}function xt(e,t){t.sort("time"===e.sort?Tt:Ct)}function Mt(e){e.action=e.sri===lichess.sri?"cancel":"join",e.variant=e.variant||"standard"}function St(e){e.data.hooks.forEach(Mt)}function _t(e,t){return e.rating>t.rating?-1:1}function Pt(e){e.data.seeks.forEach((function(t){t.action=e.data.me&&t.username===e.data.me.username?"cancelSeek":"joinSeek"})),function(e){e.data.seeks.sort(_t)}(e)}const At={key:"lobby.tab",fix:e=>e||"pools"},$t={key:"lobby.mode",fix:e=>e||"list"},Ot={key:"lobby.sort",fix:e=>e||"rating"};function It(e,t){const n=e.key+":"+(t||"-");return{set(t){const o=e.fix(t);return lichess.storage.set(n,""+o),o},get:()=>e.fix(lichess.storage.get(n))}}function Lt(e){return"function"==typeof e?e():e}function Nt(){var e={};return e.promise=new Promise((function(t,n){e.resolve=t,e.reject=n})),e}const jt=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},o=void 0,i=void 0,s=void 0,r=[];return function(){var c=Lt(t),l=(new Date).getTime(),d=!o||l-o>c;o=l;for(var u=arguments.length,h=Array(u),p=0;p<u;p++)h[p]=arguments[p];if(d&&n.leading)return n.accumulate?Promise.resolve(e.call(this,[h])).then((function(e){return e[0]})):Promise.resolve(e.call.apply(e,[this].concat(h)));if(i?clearTimeout(s):i=Nt(),r.push(h),s=setTimeout(a.bind(this),c),n.accumulate){var f=r.length-1;return i.promise.then((function(e){return e[f]}))}return i.promise};function a(){var t=i;clearTimeout(s),Promise.resolve(n.accumulate?e.call(this,r):e.apply(this,r[r.length-1])).then(t.resolve,t.reject),r=[],i=null}}((()=>o("/lobby/seeks")),2e3);function Ht(e){return"lobby-pool-range-"+e}class Bt{constructor(e,t){this.send=e,this.receive=(e,t)=>!!this.handlers[e]&&(this.handlers[e](t),!0),this.send=e,this.handlers={had(e){!function(e,t){Mt(t),e.data.hooks.push(t)}(t,e),"cancel"===e.action&&t.flushHooks(!0),t.redraw()},hrm(e){e.match(/.{8}/g).forEach((function(e){!function(e,t){e.data.hooks=e.data.hooks.filter((e=>e.id!==t)),e.stepHooks.forEach((e=>{e.id===t&&(e.disabled=!0)}))}(t,e)})),t.redraw()},hooks(e){!function(e,t){e.data.hooks=t,St(e)}(t,e),t.flushHooks(!0),t.redraw()},hli(e){!function(e,t){e.data.hooks=e.data.hooks.filter((e=>t.includes(e.id)))}(t,e.match(/.{8}/g)),t.redraw()},reload_seeks(){"seeks"===t.tab&&jt().then(t.setSeeks)}},lichess.idleTimer(18e4,(()=>e("idle",!0)),(()=>{e("idle",!1),t.awake()}))}realTimeIn(){this.send("hookIn")}realTimeOut(){this.send("hookOut")}poolIn(e){this.send("poolIn",e,{},!0)}poolOut(e){this.send("poolOut",e.id)}}const Et=e=>Array.from(new FormData(e).entries()).filter((([e,t])=>!e.includes("_range"))).reduce(((e,[t,n])=>Object.assign(Object.assign({},e),{[t]:n})),{}),Rt=e=>({get:()=>JSON.parse(e.get()||"null"),set:t=>e.set(JSON.stringify(t))});class Ft{constructor(e,t){this.root=t,this.open=!1,this.toggle=()=>{this.open=!this.open},this.set=e=>{var t;this.data=e&&{form:e,filter:(t=e,Object.keys(t).reduce(((e,n)=>{const o=n.indexOf("["),i=o>0?n.slice(0,o):n;return o>0?Object.assign(Object.assign({},e),{[i]:[...e[i]||[],t[n]]}):Object.assign(Object.assign({},e),{[i]:t[n]})}),{}))}},this.save=e=>{const t=Et(e);this.store.set(t),this.set(t),this.root.onSetFilter()},this.filter=e=>{if(!this.data)return{visible:e,hidden:0};const t=this.data.filter,n=t.ratingRange&&t.ratingRange.split("-").map((e=>parseInt(e,10))),o=[],i=[];let s,r=0;return e.forEach((e=>{var a,c,l,d;if(s=e.variant,"cancel"===e.action)i.push(e);else if(!(null===(a=t.variant)||void 0===a?void 0:a.includes(s))||!(null===(c=t.speed)||void 0===c?void 0:c.includes((e.s||1).toString()))||1==(null===(l=t.mode)||void 0===l?void 0:l.length)&&t.mode[0]!=(e.ra||0).toString()||1==(null===(d=t.increment)||void 0===d?void 0:d.length)&&t.increment[0]!=e.i.toString()||n&&(!e.rating||e.rating<n[0]||e.rating>n[1]))r++;else{const t=e.ra+s+e.t+e.rating;o.includes(t)||i.push(e),o.push(t)}})),{visible:i,hidden:r}},this.store=Rt(e),this.set(this.store.get())}}function Dt(e,t,n){Dt.close();const o=$('<div id="modal-wrap"><span class="close" data-icon="L"></span></div>'),i=$(`<div id="modal-overlay" class="${t}">`).on("click",Dt.close);return o.appendTo(i),e.clone().removeClass("none").appendTo(o),Dt.onClose=n,o.find(".close").on("click",Dt.close),o.on("click",(e=>e.stopPropagation())),$("body").addClass("overlayed").prepend(i),o}Dt.close=()=>{$("body").removeClass("overlayed"),$("#modal-overlay").each((function(){Dt.onClose&&Dt.onClose(),$(this).remove()})),delete Dt.onClose},Dt.onClose=void 0;class Kt{constructor(e,t){this.makeStorage=e,this.root=t,this.save=e=>this.stores[e.getAttribute("data-type")].set(Et(e)),this.sliderTimes=[0,1/4,.5,3/4,1,1.5,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,25,30,35,40,45,60,75,90,105,120,135,150,165,180],this.sliderTime=e=>e<this.sliderTimes.length?this.sliderTimes[e]:180,this.sliderIncrement=e=>{if(e<=20)return e;switch(e){case 21:return 25;case 22:return 30;case 23:return 35;case 24:return 40;case 25:return 45;case 26:return 60;case 27:return 90;case 28:return 120;case 29:return 150;default:return 180}},this.sliderDays=e=>{if(e<=3)return e;switch(e){case 4:return 5;case 5:return 7;case 6:return 10;default:return 14}},this.sliderInitVal=(e,t,n)=>{for(let o=0;o<n;o++)if(t(o)===e)return o},this.hookToPoolMember=(e,t)=>{const n=Array.from(new FormData(t).entries()),o={};for(const e in n)o[n[e][0]]=n[e][1];const i="random"==e&&1==o.variant&&1==o.mode&&1==o.timeMode,s=parseFloat(o.time)+"+"+parseInt(o.increment);return i&&this.root.pools.find((e=>e.id===s))?{id:s,range:o.ratingRange}:void 0},this.prepareForm=e=>{const t=this,n=e.find("form"),o=n.find("#sf_timeMode"),s=n.find(".mode_choice"),r=s.find("input"),a=r.eq(0),c=r.eq(1),l=n.find("#sf_variant"),d=n.find(".fen_position"),u=d.find("input"),h=!!u.val(),p=n.find(".time_choice [name=time]"),f=n.find(".increment_choice [name=increment]"),g=n.find(".days_choice [name=days]"),m=n.data("type"),v=e.find(".ratings > div"),b=n.data("random-color-variants").split(","),k=n.find(".color-submits__button"),w=()=>{const e=l.val(),t=o.val(),n=parseFloat(p.val()),i=parseFloat(f.val()),s="hook"===m&&"0"===t||"1"!=e&&("1"!=t||n<.5&&0==i||0==n&&i<2);let r=c.prop("checked");s&&r&&(a.prop("checked",!0),y(),r=!1),c.prop("disabled",!!s).siblings("label").toggleClass("disabled",s);const d=(e,t)=>e.prop("disabled",t).toggleClass("disabled",t);("1"!=t||n>0||i>0)&&("ai"!=m||"3"!=e||n>=1||"1"!=t)?(d(k,!1),r&&b.includes(e)&&d(k.filter(":not(.random)"),!0)):d(k,!0)},y=()=>this.save(n[0]),C=this.stores[m].get();C&&Object.keys(C).forEach((e=>{n.find(`[name="${e}"]`).each((function(){"timeMode"===e&&n.data("forceTimeMode")||("checkbox"==this.type?this.checked=!0:"radio"==this.type?this.checked=this.value==C[e]:"fen"==e&&this.value||(this.value=C[e]))}))}));const T=()=>{const t=o.val();let n="correspondence";switch(l.val()){case"1":case"3":if("1"==t){const e=60*parseFloat(p.val())+40*parseFloat(f.val());n=e<30?"ultraBullet":e<180?"bullet":e<480?"blitz":e<1500?"rapid":"classical"}break;case"10":n="crazyhouse";break;case"2":n="chess960";break;case"4":n="kingOfTheHill";break;case"5":n="threeCheck";break;case"6":n="antichess";break;case"7":n="atomic";break;case"8":n="horde";break;case"9":n="racingKings"}const i=v.hide().filter("."+n).show();e.find(".ratings input").val(i.find("strong").text()),y()};if("hook"==m){n.data("anon")&&o.val("1").children(".timeMode_2, .timeMode_0").prop("disabled",!0).attr("title",this.root.trans("youNeedAnAccountToDoThat"));const t=t=>{const s=n[0],r=parseInt(e.find(".ratings input").val())||1500;s.ratingRange&&(s.ratingRange.value=[r+parseInt(s.ratingRange_range_min.value),r+parseInt(s.ratingRange_range_max.value)].join("-")),y();const a=this.hookToPoolMember(t,s);return Dt.close(),a?this.root.enterPool(a):(this.root.setTab("1"===o.val()?"real_time":"seeks"),i(n.attr("action").replace(/sri-placeholder/,lichess.sri),{method:"post",body:(()=>{const e=new FormData(n[0]);return e.append("color",t),e})()})),this.root.redraw(),!1};k.on("click",(function(){return t($(this).val())})).prop("disabled",!1),n.on("submit",(()=>t("random")))}else n.one("submit",(()=>{k.hide(),n.find(".color-submits").append(lichess.spinnerHtml)}));this.root.opts.blindMode?(l[0].focus(),p.add(f).on("change",(()=>{w(),T()}))):(p.add(f).each((function(){const e=$(this),n=e.siblings("span"),o=e.siblings(".range"),i=e.parent().hasClass("time_choice"),s=e=>{return n.text(i?(t=e)==1/4?"¼":.5==t?"½":t==3/4?"¾":""+t:""+e);var t};s(parseFloat(e.val())),o.attr({min:"0",max:""+(i?38:30),value:""+t.sliderInitVal(parseFloat(e.val()),i?t.sliderTime:t.sliderIncrement,100)}),o.on("input",(()=>{const n=(r=parseInt(o.val()),(i?t.sliderTime:t.sliderIncrement)(r));var r;s(n),e.val(""+n),T(),w()}))})),g.each((function(){const e=$(this),n=e.siblings("span"),o=e.siblings(".range");n.text(e.val()),o.attr({min:"1",max:"7",value:""+t.sliderInitVal(parseInt(e.val()),t.sliderDays,20)}),o.on("input",(()=>{const i=t.sliderDays(parseInt(o.val()));n.text(""+i),e.val(""+i),y()}))})),n.find(".rating-range").each((function(){const e=$(this),n=e.find(".rating-range__min"),o=e.find(".rating-range__max"),i=t.makeStorage("lobby.ratingRange.min"),s=t.makeStorage("lobby.ratingRange.max"),r=t=>{const r=n.val(),a=o.val();i.set(r),s.set(a),e.find(".rating-min").text(`-${r.replace("-","")}`),e.find(".rating-max").text(`+${a}`),t&&y()};n.attr({min:"-500",max:"0",step:"50",value:i.get()||"-500"}).on("input",r),o.attr({min:"0",max:"500",step:"50",value:s.get()||"500"}).on("input",r),r()}))),o.on("change",(function(){const e=$(this).val();n.find(".time_choice, .increment_choice").toggle("1"==e),n.find(".days_choice").toggle("2"==e),w(),T()})).trigger("change");const x=function(e,t,n=!1){let o,i=0;return function(...s){const r=this;o&&clearTimeout(o),o=void 0;const a=performance.now()-i;i=performance.now(),n&&a>t?e.apply(r,s):o=setTimeout((()=>{o=void 0,e.apply(r,s)}),t)}}((()=>{u.removeClass("success failure");const e=u.val();if(e){const[t,n]=u.parent().data("validate-url").split("?");i(((e,t)=>{const n=new URLSearchParams;for(const e of Object.keys(t))void 0!==t[e]&&n.append(e,t[e]);const o=n.toString();return o?`${e}?${o}`:e})(t,{fen:e})+(n?`&${n}`:"")).then((t=>{u.addClass("success"),d.find(".preview").html(t),d.find("a.board_editor").each((function(){this.href=this.href.replace(/editor\/.+$/,"editor/"+e)})),k.removeClass("nope"),lichess.contentLoaded()}),(e=>{u.addClass("failure"),d.find(".preview").html(""),k.addClass("nope")}))}}),200);u.on("keyup",x),h&&l.val("3"),l.on("change",(function(){const e="3"==$(this).val();d.toggle(e),s.toggle(!e),e&&(a.trigger("click"),requestAnimationFrame((()=>document.body.dispatchEvent(new Event("chessground.resize"))))),T(),w()})).trigger("change"),r.on("change",y),n.find("div.level").each((function(){const e=$(this).find(".ai_info > div");$(this).find("label").on("mouseenter",(function(){e.hide().filter("."+$(this).attr("for")).show()})),$(this).find("#config_level").on("mouseleave",(function(){const t=$(this).find("input:checked").val();e.hide().filter(".sf_level_"+t).show()})).trigger("mouseout"),$(this).find("input").on("change",y)}))},this.stores={hook:Rt(e("lobby.setup.hook")),friend:Rt(e("lobby.setup.friend")),ai:Rt(e("lobby.setup.ai"))}}}class qt{constructor(e,t){var n;this.opts=e,this.redraw=t,this.stepHooks=[],this.stepping=!1,this.redirecting=!1,this.alreadyWatching=[],this.flushHooks=e=>{this.flushHooksTimeout&&clearTimeout(this.flushHooksTimeout),e?this.doFlushHooks():(this.stepping=!0,"real_time"===this.tab&&this.redraw(),setTimeout((()=>{this.stepping=!1,this.doFlushHooks()}),500)),this.flushHooksTimeout=this.flushHooksSchedule()},this.flushHooksSchedule=()=>setTimeout(this.flushHooks,8e3),this.setTab=e=>{e!==this.tab&&("seeks"===e?jt().then(this.setSeeks):"real_time"===e?this.socket.realTimeIn():"real_time"===this.tab&&(this.socket.realTimeOut(),this.data.hooks=[]),this.tab=this.stores.tab.set(e)),this.filter.open=!1},this.setMode=e=>{this.mode=this.stores.mode.set(e),this.filter.open=!1},this.setSort=e=>{this.sort=this.stores.sort.set(e)},this.onSetFilter=()=>{this.flushHooks(!0),"real_time"!==this.tab&&this.redraw()},this.clickHook=e=>{const t=function(e,t){return e.data.hooks.find((e=>e.id===t))}(this,e);!t||t.disabled||this.stepping||this.redirecting||("cancel"===t.action||yt(t.variant))&&this.socket.send(t.action,t.id)},this.clickSeek=e=>{const t=function(e,t){return e.data.seeks.find((e=>e.id===t))}(this,e);t&&!this.redirecting&&("cancelSeek"===t.action||yt(t.variant))&&this.socket.send(t.action,t.id)},this.setSeeks=e=>{this.data.seeks=e,Pt(this),this.redraw()},this.clickPool=e=>{var t;this.data.me?this.poolMember&&this.poolMember.id===e?this.leavePool():(this.enterPool({id:e}),this.redraw()):(t=this.pools.find((t=>t.id==e)),o("/setup/hook/"+lichess.sri,{method:"POST",body:r({variant:1,timeMode:1,time:t.lim,increment:t.inc,days:1,color:"random"})}),this.setTab("real_time"))},this.enterPool=e=>{!function(e,t){const n=Ht(e);t?lichess.storage.set(n,t):lichess.storage.remove(n)}(e.id,e.range),this.setTab("pools"),this.poolMember=e,this.poolIn()},this.leavePool=()=>{this.poolMember&&(this.socket.poolOut(this.poolMember),this.poolMember=void 0,this.redraw())},this.poolIn=()=>{this.poolMember&&(this.poolInStorage.fire(),this.socket.poolIn(this.poolMember))},this.gameActivity=e=>{this.data.nowPlaying.find((t=>t.gameId===e))&&o("/account/now-playing").then((e=>e.nowPlaying)).then((e=>{this.data.nowPlaying=e,this.startWatching(),this.redraw()}))},this.setRedirecting=()=>{this.redirecting=!0,setTimeout((()=>{this.redirecting=!1,this.redraw()}),4e3),this.redraw()},this.awake=()=>{switch(this.tab){case"real_time":this.data.hooks=[],this.socket.realTimeIn();break;case"seeks":jt().then(this.setSeeks)}},this.data=e.data,this.data.hooks=[],this.pools=e.pools,this.playban=e.playban,this.isBot=e.data.me&&e.data.me.isBot,this.filter=new Ft(lichess.storage.make("lobby.filter"),this),this.setup=new Kt(lichess.storage.make,this),St(this),Pt(this),this.socket=new Bt(e.socketSend,this),this.stores=(n=this.data.me?this.data.me.username.toLowerCase():null,{tab:It(At,n),mode:It($t,n),sort:It(Ot,n)}),this.tab=this.isBot?"now_playing":this.stores.tab.get(),this.mode=this.stores.mode.get(),this.sort=this.stores.sort.get(),this.trans=e.trans,this.poolInStorage=lichess.storage.make("lobby.pool-in"),this.poolInStorage.listen((e=>{this.leavePool(),t()})),this.flushHooksSchedule(),this.startWatching(),this.playban?this.playban.remainingSecond<86400&&setTimeout(lichess.reload,1e3*this.playban.remainingSeconds):(setInterval((()=>{this.poolMember?this.poolIn():"real_time"!==this.tab||this.data.hooks.length||this.socket.realTimeIn()}),1e4),this.joinPoolFromLocationHash()),lichess.pubsub.on("socket.open",(()=>{"real_time"===this.tab?(this.data.hooks=[],this.socket.realTimeIn()):"pools"===this.tab&&this.poolMember&&this.poolIn()})),window.addEventListener("beforeunload",(()=>{this.poolMember&&this.socket.poolOut(this.poolMember)}))}doFlushHooks(){this.stepHooks=this.data.hooks.slice(0),"real_time"===this.tab&&this.redraw()}startWatching(){const e=this.data.nowPlaying.map((e=>e.gameId)).filter((e=>!this.alreadyWatching.includes(e)));e.length&&(setTimeout((()=>this.socket.send("startWatching",e.join(" "))),2e3),e.forEach((e=>this.alreadyWatching.push(e))))}joinPoolFromLocationHash(){if(location.hash.startsWith("#pool/")){const t=/^#pool\/(\d+\+\d+)(?:\/(.+))?$/.exec(location.hash),n={id:t[1],blocking:t[2]},o=(e=n.id,lichess.storage.get(Ht(e)));o&&(n.range=o),t&&(this.setTab("pools"),this.data.me?this.enterPool(n):setTimeout((()=>this.clickPool(n.id)),1500),history.replaceState(null,"","/"))}var e}}function zt(e,t,n){return{insert(o){o.elm.addEventListener(e,(e=>{const o=t(e);return n&&n(),o}))}}}function Wt(e){return e.map((function(e){return b("td",[e])}))}function Gt(){return b("div.spinner",[b("svg",{attrs:{viewBox:"0 0 40 40"}},[b("circle",{attrs:{cx:20,cy:20,r:18,fill:"none"}})])])}const Vt={Blitz:")","Racing Kings":"",UltraBullet:"{",Bullet:"T",Classical:"+",Rapid:"#","Three-check":".",Antichess:"@",Horde:"_",Atomic:">",Crazyhouse:"",Chess960:"'",Correspondence:";","King of the Hill":"("};function Ut(e,t,n,o){return b("span",{class:{active:t===n,glowing:t!==n&&"pools"===t&&!!e.poolMember},hook:zt("mousedown",(n=>e.setTab(t)),e.redraw)},o)}function Xt(e){const t=e.data.nbNowPlaying,n=e.data.nowPlaying.filter((e=>e.isMyTurn)).length,o=e.tab;return[e.isBot?void 0:Ut(e,"pools",o,[e.trans.noarg("quickPairing")]),e.isBot?void 0:Ut(e,"real_time",o,[e.trans.noarg("lobby")]),e.isBot?void 0:Ut(e,"seeks",o,[e.trans.noarg("correspondence")]),"now_playing"===o||t||e.isBot?Ut(e,"now_playing",o,[e.trans.plural("nbGamesInPlay",t>=100?"100+":t),n>0?b("i.unread",n>=9?"9+":n):null]):null]}function Zt(e){return zt("click",(t=>{const n=t.target.getAttribute("data-id")||t.target.parentNode.getAttribute("data-id");"custom"===n?$(".config_hook").trigger("mousedown"):n&&e.clickPool(n)}),e.redraw)}function Yt(e){return function(t){return"standard"===t.variant===e}}function Jt(e){return"cancel"===e.action}function Qt(e){return!Jt(e)}function en(e,t){const n=t.find(Jt),o=n?13:14,i=t.slice(0,o),s=t=>function(e,t){const n=e.trans.noarg;return b("tr.hook."+t.action,{key:t.id,class:{disabled:t.disabled},attrs:{title:t.disabled?"":"join"===t.action?n("joinTheGame")+" | "+t.perf:n("cancel"),"data-id":t.id}},Wt([b("span.is.is2.color-icon."+(t.c||"random")),t.rating?b("span.ulink.ulpt",{attrs:{"data-href":"/@/"+t.u}},t.u):n("anonymous"),(t.rating?t.rating:"")+(t.prov?"?":""),t.clock,b("span",{attrs:{"data-icon":Vt[t.perf]}},n(t.ra?"rated":"casual"))]))}(e,t),r=i.filter(Qt).filter(Yt(!0));xt(e,r);const a=i.filter(Qt).filter(Yt(!1)).slice(0,Math.max(0,o-r.length-1));xt(e,a);const c=[...r.map(s),a.length?b("tr.variants",{key:"variants"},[b("td",{attrs:{colspan:5}},"— "+e.trans("variant")+" —")]):null,...a.map(s)];return n&&c.unshift(s(n)),b("table.hooks__list",[b("thead",b("tr",[b("th"),b("th",e.trans("player")),b("th",{class:{sortable:!0,sort:"rating"===e.sort},hook:zt("click",(t=>e.setSort("rating")),e.redraw)},[b("i.is"),e.trans("rating")]),b("th",{class:{sortable:!0,sort:"time"===e.sort},hook:zt("click",(t=>e.setSort("time")),e.redraw)},[b("i.is"),e.trans("time")]),b("th",e.trans("mode"))])),b("tbody",{class:{stepping:e.stepping},hook:zt("click",(t=>{let n=t.target;do{if(n=n.parentNode,"TR"===n.nodeName)return e.clickHook(n.getAttribute("data-id"))}while("TABLE"!==n.nodeName)}),e.redraw)},c)])}const tn=e=>e+"%",nn=e=>Math.log(e/150+1);function on(e){const t=Math.max(1e3,Math.min(2200,e||1500));let n;const o=.4;return n=1500==t?o:t>1500?o+nn(t-1500)/nn(1300)*2*o:o-nn(1500-t)/nn(500)*o,Math.round(94*n)}const sn=2e3,rn=e=>{const t=e=>Math.log((e-30)/200+1);return Math.round(t(Math.min(sn,e||sn))/t(sn)*100)};function an(e,t){const n=Math.max(0,on(t.rating)-2),o=Math.max(0,rn(t.t)-2);return b("span#"+[t.id,"plot.new",t.ra?"rated":"casual","cancel"===t.action?"cancel":""].join("."),{key:t.id,attrs:{"data-icon":Vt[t.perf],style:`bottom:${tn(n)};left:${tn(o)}`},hook:{insert(n){$(n.elm).powerTip({placement:t.rating>1800?"se":"ne",closeDelay:200,popupId:"hook",preRender(){$("#hook").html(function(e,t){const n=t.c||"random";let o='<div class="inner">';t.rating?(o+='<a class="opponent ulpt is color-icon '+n+'" href="/@/'+t.u+'">',o+=" "+t.u+" ("+t.rating+(t.prov?"?":"")+")",o+="</a>"):o+='<span class="opponent anon '+n+'">'+e.trans("anonymous")+"</span>";return o+='<div class="inner-clickable">',o+=`<div>${t.clock}</div>`,o+='<i data-icon="'+Vt[t.perf]+'"> '+e.trans(t.ra?"rated":"casual")+"</i>",o+="</div></div>",o}(e,t)).find(".inner-clickable").on("click",(()=>e.clickHook(t.id)))}}),setTimeout((function(){n.elm.classList.remove("new")}),20)},destroy(e){$.powerTip.destroy(e.elm)}}})}const cn=[1,2,3,5,7,10,15,20,30];function ln(){const e=[];return cn.forEach((t=>{const n=rn(60*t);e.push(b("span.x.label",{attrs:{style:"left:"+tn(n-1.5)}},""+t)),e.push(b("div.grid.vert",{attrs:{style:"width:"+tn(n)}}))})),e}const dn=[1e3,1200,1400,1500,1600,1800,2e3];function un(){const e=[];return dn.forEach((function(t){const n=on(t);e.push(b("span.y.label",{attrs:{style:"bottom:"+tn(n+1)}},""+t)),e.push(b("div.grid.horiz",{attrs:{style:"height:"+tn(n+.8)}}))})),e}const hn=e=>b("div.hook__filters",{hook:{insert(t){const n=t.elm;n.filterLoaded||i("/setup/filter").then((t=>{n.innerHTML=t,n.filterLoaded=!0,function(e,t){var n;const o=null===(n=e.filter.data)||void 0===n?void 0:n.form,i=$(t),s=i.find(".rating-range"),r=s.find('input[name="ratingRange"]'),a=s.find(".rating-range__min"),c=s.find(".rating-range__max");o?Object.keys(o).forEach((e=>{const t=i.find(`input[name="${e}"]`)[0];t&&("checkbox"==t.type?t.checked=!0:t.value=o[e])})):i.find("input").prop("checked",!0);const l=()=>e.filter.save(i.find("form")[0]);function d(e){a.attr("max",c.val()),c.attr("min",a.val());const t=a.val()+"-"+c.val();r.val(t),s.siblings(".range").text(t),e&&l()}i.find("input").on("change",l),i.find("form").on("reset",(t=>{t.preventDefault(),e.filter.set(null),e.filter.open=!1,e.redraw()})).on("submit",(t=>{t.preventDefault(),e.filter.open=!1,e.redraw()}));const u=r.val()?r.val().split("-"):[];a.attr({step:"50",value:u[0]||a.attr("min")}).on("input",d),c.attr({step:"50",value:u[1]||c.attr("max")}).on("input",d),d()}(e,n)}))}}});function pn(e){let t,n,o,i,s;switch(e.filter.open&&(t=hn(e)),e.mode){case"chart":s=e.filter.filter(e.data.hooks),o=s.hidden,n=t||function(e,t){return b("div.hooks__chart",[b("div.canvas",{hook:zt("click",(t=>{t.target.classList.contains("plot")&&e.clickHook(t.target.id)}),e.redraw)},t.map((t=>an(e,t)))),...un(),...ln()])}(e,s.visible),i=e.filter.open?null:function(e){return b("i.toggle",{key:"set-mode-list",attrs:{title:e.trans.noarg("list"),"data-icon":"?"},hook:zt("mousedown",(t=>e.setMode("list")),e.redraw)})}(e);break;default:s=e.filter.filter(e.stepHooks),o=s.hidden,n=t||en(e,s.visible),i=e.filter.open?null:function(e){return b("i.toggle",{key:"set-mode-chart",attrs:{title:e.trans.noarg("graph"),"data-icon":"9"},hook:zt("mousedown",(t=>e.setMode("chart")),e.redraw)})}(e)}return[function(e,t){const n=e.filter;return b("i.toggle.toggle-filter",{class:{gamesFiltered:t>0,active:n.open},hook:zt("mousedown",n.toggle,e.redraw),attrs:{"data-icon":n.open?"L":"%",title:e.trans.noarg("filterGames")}})}(e,o),i,n]}function fn(e){if(e.data.me&&e.data.seeks.length<8)return b("div.create",[b("a.button",{hook:zt("click",(()=>{$(".lobby__start .config_hook").each((function(){this.dataset.hrefAddon="?time=correspondence"})).trigger("mousedown").trigger("click")}))},e.trans("createAGame"))])}function gn(e){return[b("table.hooks__list",[b("thead",[b("tr",["","player","rating","time","mode"].map((t=>b("th",e.trans(t)))))]),b("tbody",{hook:zt("click",(t=>{let n=t.target;do{if(n=n.parentNode,"TR"===n.nodeName)return e.data.me?e.clickSeek(n.getAttribute("data-id")):void(confirm(e.trans("youNeedAnAccountToDoThat"))&&(location.href="/signup"))}while("TABLE"!==n.nodeName)}))},e.data.seeks.map((t=>function(e,t){const n="joinSeek"===t.action?"join":"cancel",o=e.trans.noarg;return b("tr.seek."+n,{key:t.id,attrs:{title:"joinSeek"===t.action?o("joinTheGame")+" - "+t.perf.name:o("cancel"),"data-id":t.id}},Wt([b("span.is.is2.color-icon."+(t.color||"random")),t.rating?b("span.ulpt",{attrs:{"data-href":"/@/"+t.username}},t.username):"Anonymous",t.rating+(t.provisional?"?":""),t.days?e.trans.plural("nbDays",t.days):"∞",b("span",[b("span.varicon",{attrs:{"data-icon":t.perf.icon}}),o(1===t.mode?"rated":"casual")])]))}(e,t))))]),fn(e)]}function mn(e){const t=Date.now()+1e3*e.secondsLeft;return b("time.timeago",{hook:{insert(e){e.elm.setAttribute("datetime",""+t)}}},lichess.timeago(t))}function vn(e){let t,n={};if(e.redirecting)t=Gt();else switch(e.tab){case"pools":t=function(e){const t=e.poolMember;return e.pools.map((e=>{const n=!!t&&t.id===e.id;return b("div",{class:{active:n,transp:!n&&!!t&&!n},attrs:{"data-id":e.id}},[b("div.clock",e.lim+"+"+e.inc),n&&t.range?(o=t.range,b("div.range",o.replace("-","–"))):b("div.perf",e.perf),n?Gt():null]);var o})).concat(b("div.custom",{class:{transp:!!t},attrs:{"data-id":"custom"}},e.trans.noarg("custom")))}(e),n={hook:Zt(e)};break;case"real_time":t=pn(e);break;case"seeks":t=gn(e);break;case"now_playing":t=function(e){return b("div.now-playing",e.data.nowPlaying.map((t=>b("a."+t.variant.key,{key:`${t.gameId}${t.lastMove}`,attrs:{href:"/"+t.fullId}},[b("span.mini-board.cg-wrap.is2d",{attrs:{"data-state":`${t.fen},${t.color},${t.lastMove}`},hook:{insert(e){lichess.miniBoard.init(e.elm)}}}),b("span.meta",[t.opponent.ai?e.trans("aiNameLevelAiLevel","Stockfish",t.opponent.ai):t.opponent.username,b("span.indicator",t.isMyTurn?t.secondsLeft&&t.hasMoved?mn(t):[e.trans.noarg("yourTurn")]:b("span"," "))])]))))}(e)}return b("div.lobby__app.lobby__app-"+e.tab,[b("div.tabs-horiz",Xt(e)),b("div.lobby__app__content.l"+(e.redirecting?"redir":e.tab),n,t)])}const bn=function(e,t){let n,o;const i={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},s=void 0!==t?t:a;for(n=0;n<m.length;++n)for(i[m[n]]=[],o=0;o<e.length;++o){const t=e[o][m[n]];void 0!==t&&i[m[n]].push(t)}function r(e){const t=e.id?"#"+e.id:"",n=e.className?"."+e.className.split(" ").join("."):"";return c(s.tagName(e).toLowerCase()+t+n,{},[],void 0,e)}function v(e,t){return function(){if(0==--t){const t=s.parentNode(e);s.removeChild(t,e)}}}function b(e,t){var n,o;let r,a=e.data;if(void 0!==a){const t=null===(n=a.hook)||void 0===n?void 0:n.init;h(t)&&(t(e),a=e.data)}const c=e.children,f=e.sel;if("!"===f)u(e.text)&&(e.text=""),e.elm=s.createComment(e.text);else if(void 0!==f){const n=f.indexOf("#"),u=f.indexOf(".",n),g=n>0?n:f.length,m=u>0?u:f.length,v=-1!==n||-1!==u?f.slice(0,Math.min(g,m)):f,k=e.elm=h(a)&&h(r=a.ns)?s.createElementNS(r,v,a):s.createElement(v,a);for(g<m&&k.setAttribute("id",f.slice(g+1,m)),u>0&&k.setAttribute("class",f.slice(m+1).replace(/\./g," ")),r=0;r<i.create.length;++r)i.create[r](p,e);if(l(c))for(r=0;r<c.length;++r){const e=c[r];null!=e&&s.appendChild(k,b(e,t))}else d(e.text)&&s.appendChild(k,s.createTextNode(e.text));const w=e.data.hook;h(w)&&(null===(o=w.create)||void 0===o||o.call(w,p,e),w.insert&&t.push(e))}else e.elm=s.createTextNode(e.text);return e.elm}function k(e,t,n,o,i,r){for(;o<=i;++o){const i=n[o];null!=i&&s.insertBefore(e,b(i,r),t)}}function w(e){var t,n;const o=e.data;if(void 0!==o){null===(n=null===(t=null==o?void 0:o.hook)||void 0===t?void 0:t.destroy)||void 0===n||n.call(t,e);for(let t=0;t<i.destroy.length;++t)i.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const n=e.children[t];null!=n&&"string"!=typeof n&&w(n)}}}function y(e,t,n,o){for(var r,a;n<=o;++n){let o,c;const l=t[n];if(null!=l)if(h(l.sel)){w(l),o=i.remove.length+1,c=v(l.elm,o);for(let e=0;e<i.remove.length;++e)i.remove[e](l,c);const e=null===(a=null===(r=null==l?void 0:l.data)||void 0===r?void 0:r.hook)||void 0===a?void 0:a.remove;h(e)?e(l,c):c()}else s.removeChild(e,l.elm)}}function C(e,t,n){var o,r,a,c,l;const d=null===(o=t.data)||void 0===o?void 0:o.hook;null===(r=null==d?void 0:d.prepatch)||void 0===r||r.call(d,e,t);const p=t.elm=e.elm,m=e.children,v=t.children;if(e!==t){if(void 0!==t.data){for(let n=0;n<i.update.length;++n)i.update[n](e,t);null===(c=null===(a=t.data.hook)||void 0===a?void 0:a.update)||void 0===c||c.call(a,e,t)}u(t.text)?h(m)&&h(v)?m!==v&&function(e,t,n,o){let i,r,a,c,l=0,d=0,h=t.length-1,p=t[0],m=t[h],v=n.length-1,w=n[0],T=n[v];for(;l<=h&&d<=v;)null==p?p=t[++l]:null==m?m=t[--h]:null==w?w=n[++d]:null==T?T=n[--v]:f(p,w)?(C(p,w,o),p=t[++l],w=n[++d]):f(m,T)?(C(m,T,o),m=t[--h],T=n[--v]):f(p,T)?(C(p,T,o),s.insertBefore(e,p.elm,s.nextSibling(m.elm)),p=t[++l],T=n[--v]):f(m,w)?(C(m,w,o),s.insertBefore(e,m.elm,p.elm),m=t[--h],w=n[++d]):(void 0===i&&(i=g(t,l,h)),r=i[w.key],u(r)?s.insertBefore(e,b(w,o),p.elm):(a=t[r],a.sel!==w.sel?s.insertBefore(e,b(w,o),p.elm):(C(a,w,o),t[r]=void 0,s.insertBefore(e,a.elm,p.elm))),w=n[++d]);(l<=h||d<=v)&&(l>h?(c=null==n[v+1]?null:n[v+1].elm,k(e,c,n,d,v,o)):y(e,t,l,h))}(p,m,v,n):h(v)?(h(e.text)&&s.setTextContent(p,""),k(p,null,v,0,v.length-1,n)):h(m)?y(p,m,0,m.length-1):h(e.text)&&s.setTextContent(p,""):e.text!==t.text&&(h(m)&&y(p,m,0,m.length-1),s.setTextContent(p,t.text)),null===(l=null==d?void 0:d.postpatch)||void 0===l||l.call(d,e,t)}}return function(e,t){let n,o,a;const c=[];for(n=0;n<i.pre.length;++n)i.pre[n]();for(function(e){return void 0!==e.sel}(e)||(e=r(e)),f(e,t)?C(e,t,c):(o=e.elm,a=s.parentNode(o),b(t,c),null!==a&&(s.insertBefore(a,t.elm,s.nextSibling(o)),y(a,[e],0,0))),n=0;n<c.length;++n)c[n].data.hook.insert(c[n]);for(n=0;n<i.post.length;++n)i.post[n]();return t}}([C,w]);window.Chessground=function(e,t){const n={pieces:we(ve),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:I()};function o(){const t="dom"in n?n.dom.unbind:void 0,o=n.viewOnly&&!n.drawable.visible,i=function(e,t,n){e.innerHTML="",e.classList.add("cg-wrap");for(const n of T)e.classList.toggle("orientation-"+n,t.orientation===n);e.classList.toggle("manipulable",!t.viewOnly);const o=z("cg-helper");e.appendChild(o);const i=z("cg-container");o.appendChild(i);const s=z("cg-board");let r,a,c;if(i.appendChild(s),t.drawable.visible&&!n&&(r=et(Ge("svg"),{class:"cg-shapes"}),r.appendChild(Ge("defs")),r.appendChild(Ge("g")),a=et(Ge("svg"),{class:"cg-custom-svgs"}),a.appendChild(Ge("g")),i.appendChild(r),i.appendChild(a)),t.coordinates){const e="black"===t.orientation?" black":"";i.appendChild(rt(M,"ranks"+e)),i.appendChild(rt(x,"files"+e))}return t.draggable.showGhost&&!n&&(c=z("piece","ghost"),D(c,!1),i.appendChild(c)),{board:s,container:i,ghost:c,svg:r,customSvg:a}}(e,n,o),s=function(e){let t;const n=()=>(void 0===t&&(t=e()),t);return n.clear=()=>{t=void 0},n}((()=>i.board.getBoundingClientRect())),r=e=>{dt(c),!e&&i.svg&&Ve(c,i.svg,i.customSvg)},a=()=>{s.clear(),function(e){if(e.dom.relative)return;const t=me(e),n=B(e.dom.bounds());let o=e.dom.elements.board.firstChild;for(;o;)(ut(o)&&!o.cgAnimating||ht(o))&&R(o,n(A(o.cgKey),t)),o=o.nextSibling}(c),i.svg&&Ve(c,i.svg,i.customSvg)},c=n;return c.dom={elements:i,bounds:s,redraw:bt(r),redrawNow:r,unbind:t,relative:o},c.drawable.prevSvgHash="",r(!1),at(c,a),t||(c.dom.unbind=function(e,t){const n=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||n.push(ct(document.body,"chessground.resize",t)),!e.viewOnly){const t=lt(e,Re,Ie),o=lt(e,Fe,Le);for(const e of["touchmove","mousemove"])n.push(ct(document,e,t));for(const e of["touchend","mouseup"])n.push(ct(document,e,o));const i=()=>e.dom.bounds.clear();n.push(ct(document,"scroll",i,{capture:!0,passive:!0})),n.push(ct(window,"resize",i,{passive:!0}))}return()=>n.forEach((e=>e()))}(c,a)),c.events.insert&&c.events.insert(i),c}return ye(n,t||{}),We(o(),o)};let kn=!1;function wn(e,t){const n=document.querySelector(e);let o=parseInt(n.getAttribute("data-count"));const i=(e,o,i)=>{var s;n.textContent=(s=Math.round((e*(t-1-i)+o*(i+1))/t),!1===kn&&(kn=window.Intl&&Intl.NumberFormat?new Intl.NumberFormat:null),null===kn?""+s:kn.format(s))};let s=[];return(e,r)=>{if(!n||!e&&0!==e)return;r&&(t=Math.abs(r)),s.forEach(clearTimeout),s=[];const a=Math.abs(lichess.socket.pingInterval()/t),c=o||e;o=e;for(let n=0;n<t;n++)s.push(setTimeout((()=>i(c,e,n)),Math.round(n*a)))}}return function(e){e.element=document.querySelector(".lobby__app"),e.pools=[{id:"1+0",lim:1,inc:0,perf:"Bullet"},{id:"2+1",lim:2,inc:1,perf:"Bullet"},{id:"3+0",lim:3,inc:0,perf:"Blitz"},{id:"3+2",lim:3,inc:2,perf:"Blitz"},{id:"5+0",lim:5,inc:0,perf:"Blitz"},{id:"5+3",lim:5,inc:3,perf:"Blitz"},{id:"10+0",lim:10,inc:0,perf:"Rapid"},{id:"10+5",lim:10,inc:5,perf:"Rapid"},{id:"15+10",lim:15,inc:10,perf:"Rapid"},{id:"30+0",lim:30,inc:0,perf:"Classical"},{id:"30+20",lim:30,inc:20,perf:"Classical"}];const o=wn("#nb_games_in_play > strong",8),s=wn("#nb_connected_players > strong",10);lichess.socket=new lichess.StrongSocket("/lobby/socket/v5",!1,{receive(e,t){r.socketReceive(e,t)},events:{n(e,t){s(t.d),setTimeout((()=>o(t.r)),lichess.socket.pingInterval()/2)},reload_timeline(){i("/timeline").then((e=>{$(".timeline").html(e),lichess.contentLoaded()}))},featured(e){$(".lobby__tv").html(e.html),lichess.contentLoaded()},redirect(e){r.leavePool(),r.setRedirecting(),lichess.redirect(e)},fen(e){r.gameActivity(e.id)}}}),lichess.StrongSocket.firstConnect.then((()=>{var e;const t=(e=>{const t=RegExp("[?&]"+e+"=([^&]*)").exec(location.search);return t&&decodeURIComponent(t[1].replace(/\+/g," "))})("hook_like");if(!t)return;const n=null===(e=r.setup.stores.hook.get())||void 0===e?void 0:e.ratingRange;i(`/setup/hook/${lichess.sri}/like/${t}?rr=${n||""}`,{method:"post"}),r.setTab("real_time"),history.replaceState(null,"","/")})),e.blindMode=$("body").hasClass("blind-mode"),e.trans=lichess.trans(e.i18n),e.socketSend=lichess.socket.send;const r=function(e){const t=new qt(e,(function(){o=bn(o,vn(t))})),n=vn(t);e.element.innerHTML="";let o=bn(e.element,n);return{socketReceive:t.socket.receive,setTab(e){t.setTab(e),t.redraw()},gameActivity:t.gameActivity,setRedirecting:t.setRedirecting,enterPool:t.enterPool,leavePool:t.leavePool,setup:t.setup,redraw:t.redraw}}(e),a=$(".lobby__start"),c=e.blindMode?"click":"mousedown";a.find("a:not(.disabled)").on(c,(function(){$(this).addClass("active").siblings().removeClass("active"),lichess.loadCssPath("lobby.setup"),r.leavePool();let e=this.href;this.dataset.hrefAddon&&(e+=this.dataset.hrefAddon,delete this.dataset.hrefAddon),fetch(e,Object.assign(Object.assign({},t),{headers:n})).then((e=>e.text().then((t=>{e.ok?(r.setup.prepareForm(Dt($(t),"game-setup",(()=>a.find(".active").removeClass("active")))),lichess.contentLoaded()):(alert(t),lichess.reload())}))))})).on("click",(e=>e.preventDefault())),["#ai","#friend","#hook"].includes(location.hash)&&(a.find(".config_"+location.hash.replace("#","")).each((function(){this.dataset.hrefAddon=location.search})).trigger(c),"#hook"===location.hash&&(/time=realTime/.test(location.search)?r.setTab("real_time"):/time=correspondence/.test(location.search)&&r.setTab("seeks")),history.replaceState(null,"","/")),function(){const e=window.matchMedia("(prefers-color-scheme: dark)");if("not all"==e.media)return;const t=document.body.getAttribute("data-theme");if(e.matches==("dark"==t))return;let n;const o=()=>(n=n||lichess.loadModule("dasher").then((()=>window.LichessDasher(document.createElement("div"),{playing:!1}))),n);$(".bg-switch").addClass("active").on("click",(()=>o().then((e=>e.subs.background.set(document.body.classList.contains("dark")?"light":"dark")))))}()}}();
