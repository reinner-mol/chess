!function(){"use strict";const e=["white","black"],t=["a","b","c","d","e","f","g","h"],o=["1","2","3","4","5","6","7","8"],n=[...o].reverse(),r=Array.prototype.concat(...t.map((e=>o.map((t=>e+t))))),i=e=>r[8*e[0]+e[1]],s=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],a=r.map(s);const c=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},l=e=>"white"===e?"black":"white",d=(e,t)=>{const o=e[0]-t[0],n=e[1]-t[1];return o*o+n*n},u=(e,t)=>e.role===t.role&&e.color===t.color,p=(e,t,o,n)=>[(t?e[0]:7-e[0])*o,(t?7-e[1]:e[1])*n],f=e=>{const t=e.width/8,o=e.height/8;return(e,n)=>p(e,n,t,o)},g=(e,t)=>p(e,t,100,100),h=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},m=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},v=(e,t)=>{e.style.visibility=t?"visible":"hidden"},b=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},w=e=>2===e.buttons||2===e.button,y=(e,t)=>{const o=document.createElement(e);return t&&(o.className=t),o};function k(e,t,o){const n=s(e);return t||(n[0]=7-n[0],n[1]=7-n[1]),[o.left+o.width*n[0]/8+o.width/16,o.top+o.height*(7-n[1])/8+o.height/16]}function C(e,t){return Math.abs(e-t)}const M=(e,t,o,n)=>{const r=C(e,o),i=C(t,n);return 1===r&&2===i||2===r&&1===i},S=(e,t,o,n)=>C(e,o)===C(t,n),P=(e,t,o,n)=>e===o||t===n,x=(e,t,o,n)=>S(e,t,o,n)||P(e,t,o,n);function A(e,t,o){const n=e.get(t);if(!n)return[];const r=s(t),c=n.role,l="pawn"===c?(d=n.color,(e,t,o,n)=>C(e,o)<2&&("white"===d?n===t+1||t<=1&&n===t+2&&e===o:n===t-1||t>=6&&n===t-2&&e===o)):"knight"===c?M:"bishop"===c?S:"rook"===c?P:"queen"===c?x:function(e,t,o){return(n,r,i,s)=>C(n,i)<2&&C(r,s)<2||o&&r===s&&r===("white"===e?0:7)&&(4===n&&(2===i&&t.includes(0)||6===i&&t.includes(7))||t.includes(i))}(n.color,function(e,t){const o="white"===t?"1":"8",n=[];for(const[r,i]of e)r[1]===o&&i.color===t&&"rook"===i.role&&n.push(s(r)[0]);return n}(e,n.color),o);var d;return a.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&l(r[0],r[1],e[0],e[1]))).map(i)}function K(e,...t){e&&setTimeout((()=>e(...t)),1)}function q(e){e.premovable.current&&(e.premovable.current=void 0,K(e.premovable.events.unset))}function L(e){const t=e.predroppable;t.current&&(t.current=void 0,K(t.events.unset))}function N(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);if(t===o||!n)return!1;const a=r&&r.color!==n.color?r:void 0;return o===e.selected&&H(e),K(e.events.move,t,o,a),function(e,t,o){if(!e.autoCastle)return!1;const n=e.pieces.get(t);if(!n||"king"!==n.role)return!1;const r=s(t),a=s(o);if(0!==r[1]&&7!==r[1]||r[1]!==a[1])return!1;4!==r[0]||e.pieces.has(o)||(6===a[0]?o=i([7,a[1]]):2===a[0]&&(o=i([0,a[1]])));const c=e.pieces.get(o);return!(!c||c.color!==n.color||"rook"!==c.role||(e.pieces.delete(t),e.pieces.delete(o),r[0]<a[0]?(e.pieces.set(i([6,a[1]]),n),e.pieces.set(i([5,a[1]]),c)):(e.pieces.set(i([2,a[1]]),n),e.pieces.set(i([3,a[1]]),c)),0))}(e,t,o)||(e.pieces.set(o,n),e.pieces.delete(t)),e.lastMove=[t,o],e.check=void 0,K(e.events.change),a||!0}function T(e,t,o,n){if(e.pieces.has(o)){if(!n)return!1;e.pieces.delete(o)}return K(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,K(e.events.change),e.movable.dests=void 0,e.turnColor=l(e.turnColor),!0}function D(e,t,o){const n=N(e,t,o);return n&&(e.movable.dests=void 0,e.turnColor=l(e.turnColor),e.animation.current=void 0),n}function E(e,t,o){if(F(e,t,o)){const n=D(e,t,o);if(n){const r=e.hold.stop();H(e);const i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==n&&(i.captured=n),K(e.movable.events.after,t,o,i),!0}}else if(function(e,t,o){return t!==o&&B(e,t)&&A(e.pieces,t,e.premovable.castle).includes(o)}(e,t,o))return function(e,t,o,n){L(e),e.premovable.current=[t,o],K(e.premovable.events.set,t,o,n)}(e,t,o,{ctrlKey:e.stats.ctrlKey}),H(e),!0;return H(e),!1}function O(e,t,o,n){const r=e.pieces.get(t);r&&(function(e,t,o){const n=e.pieces.get(t);return!(!n||t!==o&&e.pieces.has(o)||"both"!==e.movable.color&&(e.movable.color!==n.color||e.turnColor!==n.color))}(e,t,o)||n)?(e.pieces.delete(t),T(e,r,o,n),K(e.movable.events.afterNewPiece,r.role,o,{premove:!1,predrop:!1})):r&&function(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);return!!n&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==n.role||"1"!==o[1]&&"8"!==o[1])&&e.movable.color===n.color&&e.turnColor!==n.color}(e,t,o)?function(e,t,o){q(e),e.predroppable.current={role:t,key:o},K(e.predroppable.events.set,t,o)}(e,r.role,o):(q(e),L(e)),e.pieces.delete(t),H(e)}function W(e,t,o){if(K(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return H(e),void e.hold.cancel();if((e.selectable.enabled||o)&&e.selected!==t&&E(e,e.selected,t))return void(e.stats.dragged=!1)}(I(e,t)||B(e,t))&&(z(e,t),e.hold.start())}function z(e,t){e.selected=t,B(e,t)?e.premovable.dests=A(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function H(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function I(e,t){const o=e.pieces.get(t);return!!o&&("both"===e.movable.color||e.movable.color===o.color&&e.turnColor===o.color)}function F(e,t,o){var n,r;return t!==o&&I(e,t)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(t))||void 0===r?void 0:r.includes(o)))}function B(e,t){const o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}function R(e){const t=e.premovable.current;if(!t)return!1;const o=t[0],n=t[1];let r=!1;if(F(e,o,n)){const t=D(e,o,n);if(t){const i={premove:!0};!0!==t&&(i.captured=t),K(e.movable.events.after,o,n,i),r=!0}}return q(e),r}function U(e){q(e),L(e),H(e)}function _(e){e.movable.color=e.movable.dests=e.animation.current=void 0,U(e)}function j(e,t,o){let n=Math.floor(8*(e[0]-o.left)/o.width);t||(n=7-n);let r=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(r=7-r),n>=0&&n<8&&r>=0&&r<8?i([n,r]):void 0}function V(e){return"white"===e.orientation}const G="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",X={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Z={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Y(e){"start"===e&&(e=G);const t=new Map;let o=7,n=0;for(const r of e)switch(r){case" ":return t;case"/":if(--o,o<0)return t;n=0;break;case"~":{const e=t.get(i([n,o]));e&&(e.promoted=!0);break}default:{const e=r.charCodeAt(0);if(e<57)n+=e-48;else{const e=r.toLowerCase();t.set(i([n,o]),{role:X[e],color:r===e?"black":"white"}),++n}}}return t}function Q(e,t){var o,n;if((null===(o=t.movable)||void 0===o?void 0:o.dests)&&(e.movable.dests=void 0),(null===(n=t.drawable)||void 0===n?void 0:n.autoShapes)&&(e.drawable.autoShapes=[]),J(e,t),t.fen&&(e.pieces=Y(t.fen),e.drawable.shapes=[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[o,n]of e.pieces)"king"===n.role&&n.color===t&&(e.check=o)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&z(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",o="e"+t,n=e.movable.dests.get(o),r=e.pieces.get(o);if(!n||!r||"king"!==r.role)return;e.movable.dests.set(o,n.filter((e=>!(e==="a"+t&&n.includes("c"+t)||e==="h"+t&&n.includes("g"+t)))))}}function J(e,t){for(const o in t)ee(e[o])&&ee(t[o])?J(e[o],t[o]):e[o]=t[o]}function ee(e){return"object"==typeof e}function te(e,t){return t.animation.enabled?function(e,t){const o=new Map(t.pieces),n=e(t),i=function(e,t){const o=new Map,n=[],i=new Map,s=[],a=[],c=new Map;let l,d,p;for(const[t,o]of e)c.set(t,ne(t,o));for(const e of r)l=t.pieces.get(e),d=c.get(e),l?d?u(l,d.piece)||(s.push(d),a.push(ne(e,l))):a.push(ne(e,l)):d&&s.push(d);for(const e of a)d=re(e,s.filter((t=>u(e.piece,t.piece)))),d&&(p=[d.pos[0]-e.pos[0],d.pos[1]-e.pos[1]],o.set(e.key,p.concat(p)),n.push(d.key));for(const e of s)n.includes(e.key)||i.set(e.key,e.piece);return{anims:o,fadings:i}}(o,t);if(i.anims.size||i.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},e||ie(t,performance.now())}else t.dom.redraw();return n}(e,t):oe(e,t)}function oe(e,t){const o=e(t);return t.dom.redraw(),o}function ne(e,t){return{key:e,pos:s(e),piece:t}}function re(e,t){return t.sort(((t,o)=>d(e.pos,t.pos)-d(e.pos,o.pos)))[0]}function ie(e,t){const o=e.animation.current;if(void 0===o)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(t-o.start)*o.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=(r=n)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of o.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>ie(e,t)))}var r}const se=["green","red","blue","yellow"];function ae(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?H(e):U(e);const o=b(t),n=j(o,V(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:o,brush:pe(t),snapToValidMove:e.drawable.defaultSnapToValidMove},ce(e))}function ce(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const o=j(t.pos,V(e),e.dom.bounds());o||(t.snapToValidMove=!1);const n=t.snapToValidMove?function(e,t,o,n){const r=s(e),c=a.filter((e=>x(r[0],r[1],e[0],e[1])||M(r[0],r[1],e[0],e[1]))),l=c.map((e=>k(i(e),o,n))).map((e=>d(t,e))),[,u]=l.reduce(((e,t,o)=>e[0]<t?e:[t,o]),[l[0],0]);return i(c[u])}(t.orig,t.pos,V(e),e.dom.bounds()):o;n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),ce(e)}}))}function le(e,t){e.drawable.current&&(e.drawable.current.pos=b(t))}function de(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const o=e=>e.orig===t.orig&&e.dest===t.dest,n=e.shapes.find(o);n&&(e.shapes=e.shapes.filter((e=>!o(e))));n&&n.brush===t.brush||e.shapes.push(t);fe(e)}(e.drawable,t),ue(e))}function ue(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function pe(e){var t;const o=(e.shiftKey||e.ctrlKey)&&w(e),n=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return se[(o?1:0)+(n?2:0)]}function fe(e){e.onChange&&e.onChange(e.shapes)}function ge(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const o=e.dom.bounds(),n=b(t),r=j(n,V(e),o);if(!r)return;const i=e.pieces.get(r),a=e.selected;var c;a||!e.drawable.enabled||!e.drawable.eraseOnClick&&i&&i.color===e.turnColor||(c=e).drawable.shapes.length&&(c.drawable.shapes=[],c.dom.redraw(),fe(c.drawable)),!1===t.cancelable||t.touches&&e.movable.color&&!i&&!a&&!function(e,t){const o=V(e),n=e.dom.bounds(),r=Math.pow(n.width/8,2);for(const i in e.pieces){const e=k(i,o,n);if(d(e,t)<=r)return!0}return!1}(e,n)||t.preventDefault();const l=!!e.premovable.current,u=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&F(e,e.selected,r)?te((e=>W(e,r)),e):W(e,r);const p=e.selected===r,g=ye(e,r);if(i&&g&&p&&function(e,t){const o=e.pieces.get(t);return!!o&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:i,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:g,previouslySelected:a,originTarget:t.target},g.cgDragging=!0,g.classList.add("dragging");const c=e.dom.elements.ghost;c&&(c.className=`ghost ${i.color} ${i.role}`,h(c,f(o)(s(r),V(e))),v(c,!0)),he(e)}else l&&q(e),u&&L(e);e.dom.redraw()}function he(e){requestAnimationFrame((()=>{var t;const o=e.draggable.current;if(!o)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(o.orig))&&(e.animation.current=void 0);const n=e.pieces.get(o.orig);if(n&&u(n,o.piece)){if(!o.started&&d(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if("function"==typeof o.element){const e=o.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),o.element=e}const t=e.dom.bounds();h(o.element,[o.pos[0]-t.left-t.width/16,o.pos[1]-t.top-t.height/16])}}else be(e);he(e)}))}function me(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=b(t))}function ve(e,t){const o=e.draggable.current;if(!o)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&o.originTarget!==t.target&&!o.newPiece)return void(e.draggable.current=void 0);q(e),L(e);const n=j(b(t)||o.pos,V(e),e.dom.bounds());n&&o.started&&o.orig!==n?o.newPiece?O(e,o.orig,n,o.force):(e.stats.ctrlKey=t.ctrlKey,E(e,o.orig,n)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!n&&(e.pieces.delete(o.orig),K(e.events.change)),(o.orig!==o.previouslySelected||o.orig!==n&&n)&&e.selectable.enabled||H(e),we(e),e.draggable.current=void 0,e.dom.redraw()}function be(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,H(e),we(e),e.dom.redraw())}function we(e){const t=e.dom.elements;t.ghost&&v(t.ghost,!1)}function ye(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&"PIECE"===o.tagName)return o;o=o.nextSibling}}function ke(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Ce(e,o){function r(){!function(e){e.orientation=l(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),o()}return{set(t){t.orientation&&t.orientation!==e.orientation&&r(),(t.fen?te:oe)((e=>Q(e,t)),e)},state:e,getFen:()=>{return o=e.pieces,n.map((e=>t.map((t=>{const n=o.get(t+e);if(n){const e=Z[n.role];return"white"===n.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var o},toggleOrientation:r,setPieces(t){te((e=>function(e,t){for(const[o,n]of t)n?e.pieces.set(o,n):e.pieces.delete(o)}(e,t)),e)},selectSquare(t,o){t?te((e=>W(e,t,o)),e):e.selected&&(H(e),e.dom.redraw())},move(t,o){te((e=>N(e,t,o)),e)},newPiece(t,o){te((e=>T(e,t,o)),e)},playPremove(){if(e.premovable.current){if(te(R,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const o=function(e,t){const o=e.predroppable.current;let n=!1;if(!o)return!1;t(o)&&T(e,{role:o.role,color:e.movable.color},o.key)&&(K(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),n=!0);return L(e),n}(e,t);return e.dom.redraw(),o}return!1},cancelPremove(){oe(q,e)},cancelPredrop(){oe(L,e)},cancelMove(){oe((e=>{U(e),be(e)}),e)},stop(){oe((e=>{_(e),be(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{ke(e,2),setTimeout((()=>ke(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){oe((e=>e.drawable.autoShapes=t),e)},setShapes(t){oe((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>j(t,V(e),e.dom.bounds()),redrawAll:o,dragNewPiece(t,o,n){!function(e,t,o,n){const r="a0";e.pieces.set(r,t),e.dom.redraw();const i=b(o);e.draggable.current={orig:r,piece:t,origPos:i,pos:i,started:!0,element:()=>ye(e,r),originTarget:o.target,newPiece:!0,force:!!n},he(e)}(e,t,o,n)},destroy(){_(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Me(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function Se(e,t,o){const n=e.drawable,r=n.current,i=r&&r.mouseSq?r:void 0,s=new Map,a=e.dom.bounds();for(const e of n.shapes.concat(n.autoShapes).concat(i?[i]:[]))e.dest&&s.set(e.dest,(s.get(e.dest)||0)+1);const c=n.shapes.concat(n.autoShapes).map((e=>({shape:e,current:!1,hash:xe(e,s,!1,a)})));i&&c.push({shape:i,current:!0,hash:xe(i,s,!0,a)});const l=c.map((e=>e.hash)).join(";");if(l===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=l;const d=t.querySelector("defs"),u=t.querySelector("g"),p=o.querySelector("g");!function(e,t,o){const n=new Map;let r;for(const o of t)o.shape.dest&&(r=e.brushes[o.shape.brush],o.shape.modifiers&&(r=$e(r,o.shape.modifiers)),n.set(r.key,r));const i=new Set;let s=o.firstChild;for(;s;)i.add(s.getAttribute("cgKey")),s=s.nextSibling;for(const[e,t]of n.entries())i.has(e)||o.appendChild(Le(t))}(n,c,d),Pe(e,c.filter((e=>!e.shape.customSvg)),n.brushes,s,u),Pe(e,c.filter((e=>e.shape.customSvg)),n.brushes,s,p)}function Pe(e,t,o,n,r){const i=e.dom.bounds(),s=new Map,a=[];for(const e of t)s.set(e.hash,!1);let c,l=r.firstChild;for(;l;)c=l.getAttribute("cgHash"),s.has(c)?s.set(c,!0):a.push(l),l=l.nextSibling;for(const e of a)r.removeChild(e);for(const a of t)s.get(a.hash)||r.appendChild(qe(e,a,o,n,i))}function xe({orig:e,dest:t,brush:o,piece:n,modifiers:r,customSvg:i},s,a,c){return[c.width,c.height,a,e,t,o,t&&(s.get(t)||0)>1,n&&Ae(n),r&&(l=r,""+(l.lineWidth||"")),i&&Ke(i)].filter((e=>e)).join(",");var l}function Ae(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function Ke(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return"custom-"+t.toString()}function qe(e,{shape:t,current:o,hash:n},r,i,a){let c;if(t.customSvg){const o=Te(s(t.orig),e.orientation);c=function(e,t,o){const{width:n,height:r}=o,i=n/8,s=r/8,a=t[0]*i,c=(7-t[1])*s,l=Ne(Me("g"),{transform:`translate(${a},${c})`}),d=Ne(Me("svg"),{width:i,height:s,viewBox:"0 0 100 100"});return l.appendChild(d),d.innerHTML=e,l}(t.customSvg,o,a)}else if(t.piece)c=function(e,t,o,n){const r=Oe(t,n),i=n.width/8*(o.scale||1),s=o.color[0]+("knight"===o.role?"n":o.role[0]).toUpperCase();return Ne(Me("image"),{className:`${o.role} ${o.color}`,x:r[0]-i/2,y:r[1]-i/2,width:i,height:i,href:e+s+".svg"})}(e.drawable.pieces.baseUrl,Te(s(t.orig),e.orientation),t.piece,a);else{const n=Te(s(t.orig),e.orientation);if(t.dest){let l=r[t.brush];t.modifiers&&(l=$e(l,t.modifiers)),c=function(e,t,o,n,r,i){const s=function(e,t){return(t?20:10)/512*e.width}(i,r&&!n),a=Oe(t,i),c=Oe(o,i),l=c[0]-a[0],d=c[1]-a[1],u=Math.atan2(d,l),p=Math.cos(u)*s,f=Math.sin(u)*s;return Ne(Me("line"),{stroke:e.color,"stroke-width":De(e,n,i),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:Ee(e,n),x1:a[0],y1:a[1],x2:c[0]-p,y2:c[1]-f})}(l,n,Te(s(t.dest),e.orientation),o,(i.get(t.dest)||0)>1,a)}else c=function(e,t,o,n){const r=Oe(t,n),i=function(e){const t=e.width/512;return[3*t,4*t]}(n),s=(n.width+n.height)/32;return Ne(Me("circle"),{stroke:e.color,"stroke-width":i[o?0:1],fill:"none",opacity:Ee(e,o),cx:r[0],cy:r[1],r:s-i[1]/2})}(r[t.brush],n,o,a)}return c.setAttribute("cgHash",n),c}function Le(e){const t=Ne(Me("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(Ne(Me("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Ne(e,t){for(const o in t)e.setAttribute(o,t[o]);return e}function Te(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function $e(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function De(e,t,o){return(e.lineWidth||10)*(t?.85:1)/512*o.width}function Ee(e,t){return(e.opacity||1)*(t?.9:1)}function Oe(e,t){return[(e[0]+.5)*t.width/8,(7.5-e[1])*t.height/8]}function We(e,t){const o=y("coords",t);let n;for(const t of e)n=y("coord"),n.textContent=t,o.appendChild(n);return o}function ze(e,t){const o=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(o)}if(e.viewOnly)return;const n=function(e){return t=>{e.draggable.current?be(e):e.drawable.current?ue(e):t.shiftKey||w(t)?e.drawable.enabled&&ae(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;q(e),L(e);const o=e.dropmode.piece;if(o){e.pieces.set("a0",o);const n=b(t),r=n&&j(n,V(e),e.dom.bounds());r&&O(e,"a0",r)}e.dom.redraw()}(e,t):ge(e,t))}}(e);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("mousedown",n,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function He(e,t,o,n){return e.addEventListener(t,o,n),()=>e.removeEventListener(t,o,n)}function Ie(e,t,o){return n=>{e.drawable.current?e.drawable.enabled&&o(e,n):e.viewOnly||t(e,n)}}function Fe(e){const t=V(e),o=e.dom.relative?g:f(e.dom.bounds()),n=e.dom.relative?m:h,r=e.dom.elements.board,i=e.pieces,a=e.animation.current,c=a?a.plan.anims:new Map,l=a?a.plan.fadings:new Map,d=e.draggable.current,u=function(e){var t;const o=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)Ve(o,t,"last-move");e.check&&e.highlight.check&&Ve(o,e.check,"check");if(e.selected&&(Ve(o,e.selected,"selected"),e.movable.showDests)){const n=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(n)for(const t of n)Ve(o,t,"move-dest"+(e.pieces.has(t)?" oc":""));const r=e.premovable.dests;if(r)for(const t of r)Ve(o,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const n=e.premovable.current;if(n)for(const e of n)Ve(o,e,"current-premove");else e.predroppable.current&&Ve(o,e.predroppable.current.key,"current-premove");const r=e.exploding;if(r)for(const e of r.keys)Ve(o,e,"exploding"+r.stage);return o}(e),p=new Set,v=new Set,b=new Map,w=new Map;let k,C,M,S,P,x,A,K,q,L;for(C=r.firstChild;C;){if(k=C.cgKey,Be(C))if(M=i.get(k),P=c.get(k),x=l.get(k),S=C.cgPiece,!C.cgDragging||d&&d.orig===k||(C.classList.remove("dragging"),n(C,o(s(k),t)),C.cgDragging=!1),!x&&C.cgFading&&(C.cgFading=!1,C.classList.remove("fading")),M){if(P&&C.cgAnimating&&S===je(M)){const e=s(k);e[0]+=P[2],e[1]+=P[3],C.classList.add("anim"),n(C,o(e,t))}else C.cgAnimating&&(C.cgAnimating=!1,C.classList.remove("anim"),n(C,o(s(k),t)),e.addPieceZIndex&&(C.style.zIndex=_e(s(k),t)));S!==je(M)||x&&C.cgFading?x&&S===je(x)?(C.classList.add("fading"),C.cgFading=!0):Ge(b,S,C):p.add(k)}else Ge(b,S,C);else if(Re(C)){const e=C.className;u.get(k)===e?v.add(k):Ge(w,e,C)}C=C.nextSibling}for(const[e,i]of u)if(!v.has(e)){q=w.get(i),L=q&&q.pop();const a=o(s(e),t);if(L)L.cgKey=e,n(L,a);else{const t=y("square",i);t.cgKey=e,n(t,a),r.insertBefore(t,r.firstChild)}}for(const[a,l]of i)if(P=c.get(a),!p.has(a))if(A=b.get(je(l)),K=A&&A.pop(),K){K.cgKey=a,K.cgFading&&(K.classList.remove("fading"),K.cgFading=!1);const r=s(a);e.addPieceZIndex&&(K.style.zIndex=_e(r,t)),P&&(K.cgAnimating=!0,K.classList.add("anim"),r[0]+=P[2],r[1]+=P[3]),n(K,o(r,t))}else{const i=je(l),c=y("piece",i),d=s(a);c.cgPiece=i,c.cgKey=a,P&&(c.cgAnimating=!0,d[0]+=P[2],d[1]+=P[3]),n(c,o(d,t)),e.addPieceZIndex&&(c.style.zIndex=_e(d,t)),r.appendChild(c)}for(const t of b.values())Ue(e,t);for(const t of w.values())Ue(e,t)}function Be(e){return"PIECE"===e.tagName}function Re(e){return"SQUARE"===e.tagName}function Ue(e,t){for(const o of t)e.dom.elements.board.removeChild(o)}function _e(e,t){let o=2+8*e[1]+(7-e[0]);return t&&(o=67-o),o+""}function je(e){return`${e.color} ${e.role}`}function Ve(e,t,o){const n=e.get(t);n?e.set(t,`${n} ${o}`):e.set(t,o)}function Ge(e,t,o){const n=e.get(t);n?n.push(o):e.set(t,[o])}function Xe(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}const Ze=e=>`lichess-${e}`,Ye=(e,t)=>e[Ze(t)],Qe=(e,t,o)=>e[Ze(t)]=o,Je=e=>e.indexOf(" b")>0?"black":"white",et=e=>{if(window.Chessground){const[t,o,n]=e.getAttribute("data-state").split(","),r={coordinates:!1,viewOnly:!0,resizable:!1,fen:t,orientation:o,lastMove:n&&("@"===n[1]?[n.slice(2)]:[n[0]+n[1],n[2]+n[3]]),drawable:{enabled:!1,visible:!1}},i=$(e).removeClass("mini-game--init"),s=i.find(".cg-wrap"),a=Je(t);Qe(s[0],"chessground",window.Chessground(s[0],r)),["white","black"].forEach((e=>i.find(".mini-game__clock--"+e).each((function(){$(this).clock({time:parseInt(this.getAttribute("data-time")),pause:e!=a})}))))}else setTimeout((()=>et(e)),200);return e.getAttribute("data-live")},tt=(e,t)=>{const o=$[e]=function(t,o){const n=this;n.element=$(o),o[e]=this,n.options=t,n._create()};o.prototype=t,$.fn[e]=function(t){const n=Array.prototype.slice.call(arguments,1);return"string"==typeof t?this.each((function(){const o=Ye(this,e);o&&$.isFunction(o[t])&&o[t].apply(o,n)})):this.each((function(){Ye(this,e)||Qe(this,e,new o(t,this))})),this}};function ot(){const e=document.querySelector("#featured-game");e.offsetHeight>window.innerHeight&&(e.style.maxWidth=window.innerHeight-2*e.querySelector(".mini-game__player").offsetHeight+"px")}window.Chessground=function(n,r){const i={pieces:Y(G),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:c()};function a(){const r="dom"in i?i.dom.unbind:void 0,a=i.viewOnly&&!i.drawable.visible,c=function(n,r,i){n.innerHTML="",n.classList.add("cg-wrap");for(const t of e)n.classList.toggle("orientation-"+t,r.orientation===t);n.classList.toggle("manipulable",!r.viewOnly);const s=y("cg-helper");n.appendChild(s);const a=y("cg-container");s.appendChild(a);const c=y("cg-board");let l,d,u;if(a.appendChild(c),r.drawable.visible&&!i&&(l=Ne(Me("svg"),{class:"cg-shapes"}),l.appendChild(Me("defs")),l.appendChild(Me("g")),d=Ne(Me("svg"),{class:"cg-custom-svgs"}),d.appendChild(Me("g")),a.appendChild(l),a.appendChild(d)),r.coordinates){const e="black"===r.orientation?" black":"";a.appendChild(We(o,"ranks"+e)),a.appendChild(We(t,"files"+e))}return r.draggable.showGhost&&!i&&(u=y("piece","ghost"),v(u,!1),a.appendChild(u)),{board:c,container:a,ghost:u,svg:l,customSvg:d}}(n,i,a),l=function(e){let t;const o=()=>(void 0===t&&(t=e()),t);return o.clear=()=>{t=void 0},o}((()=>c.board.getBoundingClientRect())),d=e=>{Fe(p),!e&&c.svg&&Se(p,c.svg,c.customSvg)},u=()=>{l.clear(),function(e){if(e.dom.relative)return;const t=V(e),o=f(e.dom.bounds());let n=e.dom.elements.board.firstChild;for(;n;)(Be(n)&&!n.cgAnimating||Re(n))&&h(n,o(s(n.cgKey),t)),n=n.nextSibling}(p),c.svg&&Se(p,c.svg,c.customSvg)},p=i;return p.dom={elements:c,bounds:l,redraw:Xe(d),redrawNow:d,unbind:r,relative:a},p.drawable.prevSvgHash="",d(!1),ze(p,u),r||(p.dom.unbind=function(e,t){const o=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||o.push(He(document.body,"chessground.resize",t)),!e.viewOnly){const t=Ie(e,me,le),n=Ie(e,ve,de);for(const e of["touchmove","mousemove"])o.push(He(document,e,t));for(const e of["touchend","mouseup"])o.push(He(document,e,n));const r=()=>e.dom.bounds.clear();o.push(He(document,"scroll",r,{capture:!0,passive:!0})),o.push(He(window,"resize",r,{passive:!0}))}return()=>o.forEach((e=>e()))}(p,u)),p.events.insert&&p.events.insert(c),p}return Q(i,r||{}),Ce(a(),a)},window.onload=()=>{tt("clock",{_create:function(){this.target=1e3*this.options.time+Date.now(),this.options.pause||(this.interval=setInterval(this.render.bind(this),1e3)),this.render()},set:function(e){this.options=e,this.target=1e3*this.options.time+Date.now(),this.render(),clearInterval(this.interval),e.pause||(this.interval=setInterval(this.render.bind(this),1e3))},render:function(){document.body.contains(this.element[0])?(this.element.text(this.formatMs(this.target-Date.now())),this.element.toggleClass("clock--run",!this.options.pause)):clearInterval(this.interval)},pad:e=>(e<10?"0":"")+e,formatMs:function(e){const t=new Date(Math.max(0,e+500)),o=t.getUTCHours(),n=t.getUTCMinutes(),r=t.getUTCSeconds();return o>0?o+":"+this.pad(n)+":"+this.pad(r):n+":"+this.pad(r)}});const e=()=>document.getElementsByClassName("mini-game").item(0),t=()=>et(e());t(),window.EventSource&&new EventSource(document.body.getAttribute("data-stream-url")).addEventListener("message",(o=>{const n=JSON.parse(o.data);"featured"==n.t?(document.getElementById("featured-game").innerHTML=n.d.html,t()):"fen"==n.t&&((e,t)=>{const o=$(e),n=t.lm,r=n&&("@"===n[1]?[n.slice(2)]:[n[0]+n[1],n[2]+n[3]]),i=Ye(e.querySelector(".cg-wrap"),"chessground");i&&i.set({fen:t.fen,lastMove:r});const s=Je(t.fen),a=(e,t)=>{isNaN(e)||o.find(".mini-game__clock--"+t).clock("set",{time:e,pause:t!=s})};a(t.wc,"white"),a(t.bc,"black")})(e(),n.d)}),!1),ot(),window.addEventListener("resize",ot)}}();
