var analyseEmbed=function(){"use strict";const e={cache:"no-cache",credentials:"same-origin"},t={"X-Requested-With":"XMLHttpRequest"},s=(s,n={})=>fetch(s,Object.assign(Object.assign(Object.assign({},e),{headers:Object.assign({},t)}),n));function n(e,t,s){const n=["mousemove","touchstart"];let i=!1,o=!0,a=performance.now();const c=()=>{o||s(),o=!0,a=performance.now(),r()},r=()=>{i&&(n.forEach((e=>document.removeEventListener(e,c))),i=!1)};setInterval((()=>{o&&performance.now()-a>e&&(t(),o=!1),i||(n.forEach((e=>document.addEventListener(e,c))),i=!0)}),1e4)}let i;try{const e=window.crypto.getRandomValues(new Uint8Array(9));i=btoa(String.fromCharCode(...e)).replace(/[/+]/g,"_")}catch(e){i=Math.random().toString(36).slice(2,12)}const o=i;let a=!1;const c=e=>{let t;if("string"==typeof e)t=e;else if(t=e.url,e.cookie){const t=document.domain.replace(/^.+(\.[^.]+\.[^.]+)$/,"$1"),s=[encodeURIComponent(e.cookie.name)+"="+e.cookie.value,"; max-age="+e.cookie.maxAge,"; path=/","; domain="+t].join("");document.cookie=s}const s="//"+location.host+"/"+t.replace(/^\//,"");a=s,location.href=s},r={expected:!1},l=()=>{a||(r.expected=!0,lichess.socket.disconnect(),location.hash?location.reload():location.assign(location.href))},h=e=>{const t={get:t=>e.getItem(t),set:(t,s)=>e.setItem(t,s),fire:(t,s)=>e.setItem(t,JSON.stringify({sri:o,nonce:Math.random(),value:s})),remove:t=>e.removeItem(t),make:s=>({get:()=>t.get(s),set:e=>t.set(s,e),fire:e=>t.fire(s,e),remove:()=>t.remove(s),listen:t=>window.addEventListener("storage",(n=>{if(n.key!==s||n.storageArea!==e||null===n.newValue)return;let i;try{i=JSON.parse(n.newValue)}catch(e){return}(null==i?void 0:i.sri)&&i.sri!==o&&t(i)}))}),makeBoolean:e=>({get:()=>"1"==t.get(e),set:s=>t.set(e,s?"1":"0"),toggle:()=>t.set(e,"1"==t.get(e)?"0":"1")})};return t},d=h(window.localStorage),u=h(window.sessionStorage);class m{constructor(e,t,s={}){this.url=e,this.pubsub=lichess.pubsub,this.ackable=new p(((e,t,s)=>this.send(e,t,s))),this.lastPingTime=performance.now(),this.pongCount=0,this.averageLag=0,this.tryOtherUrl=!1,this.autoReconnect=!0,this.nbConnects=0,this.storage=d.make("surl15"),this.sign=e=>{this._sign=e,this.ackable.sign(e)},this.connect=()=>{this.destroy(),this.autoReconnect=!0;const e=((e,t)=>{const s=new URLSearchParams;for(const e of Object.keys(t))void 0!==t[e]&&s.append(e,t[e]);const n=s.toString();return n?`${e}?${n}`:e})(this.options.protocol+"//"+this.baseUrl()+this.url,Object.assign(Object.assign({},this.settings.params),{v:!1===this.version?void 0:this.version}));this.debug("connection attempt to "+e);try{const t=this.ws=new WebSocket(e);t.onerror=e=>this.onError(e),t.onclose=()=>{this.pubsub.emit("socket.close"),this.autoReconnect&&(this.debug("Will autoreconnect in "+this.options.autoReconnectDelay),this.scheduleConnect(this.options.autoReconnectDelay))},t.onopen=()=>{this.debug("connected to "+e),this.onSuccess();const t=document.body.classList;t.remove("offline"),t.add("online"),t.toggle("reconnected",this.nbConnects>1),this.pingNow(),this.pubsub.emit("socket.open"),this.ackable.resend()},t.onmessage=e=>{if(0==e.data)return this.pong();const t=JSON.parse(e.data);"n"===t.t&&this.pong(),this.handle(t)}}catch(e){this.onError(e)}this.scheduleConnect(this.options.pingMaxLag)},this.send=(e,t,s={},n=!1)=>{const i={t:e};void 0!==t&&(s.withLag&&(t.l=Math.round(this.averageLag)),s.millis>=0&&(t.s=Math.round(.1*s.millis).toString(36)),i.d=t),s.ackable&&(i.d=i.d||{},this.ackable.register(e,i.d));const o=JSON.stringify(i);if("racerScore"!=e||s.sign==this._sign){if("move"==e&&s.sign!=this._sign){let e;try{e=(new Error).stack.split("\n").join(" / ").replace(/\s+/g," ")}catch(t){e=`${t.message} ${navigator.userAgent}`}e.includes("round.nvui")||setTimeout((()=>this.send("rep",{n:`soc: ${o} ${e}`})),1e4)}this.debug("send "+o);try{this.ws.send(o)}catch(t){n||setTimeout((()=>this.send(e,i.d,s,!0)),1e3)}}},this.scheduleConnect=e=>{this.options.idle&&(e=1e4+10*Math.random()*1e3),clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule),this.connectSchedule=setTimeout((()=>{document.body.classList.add("offline"),document.body.classList.remove("online"),this.tryOtherUrl=!0,this.connect()}),e)},this.schedulePing=e=>{clearTimeout(this.pingSchedule),this.pingSchedule=setTimeout(this.pingNow,e)},this.pingNow=()=>{clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule);const e=this.options.isAuth&&this.pongCount%8==2?JSON.stringify({t:"p",l:Math.round(.1*this.averageLag)}):"null";try{this.ws.send(e),this.lastPingTime=performance.now()}catch(e){this.debug(e,!0)}this.scheduleConnect(this.options.pingMaxLag)},this.computePingDelay=()=>this.options.pingDelay+(this.options.idle?1e3:0),this.pong=()=>{clearTimeout(this.connectSchedule),this.schedulePing(this.computePingDelay());const e=Math.min(performance.now()-this.lastPingTime,1e4);this.pongCount++;const t=this.pongCount>4?.1:1/this.pongCount;this.averageLag+=t*(e-this.averageLag),this.pubsub.emit("socket.lag",this.averageLag)},this.handle=e=>{if(e.v&&!1!==this.version){if(e.v<=this.version)return void this.debug("already has event "+e.v);if(e.v>this.version+1)return l();this.version=e.v}switch(e.t||!1){case!1:break;case"resync":l();break;case"ack":this.ackable.onServerAck(e.d);break;default:this.settings.receive&&this.settings.receive(e.t,e.d)||(this.pubsub.emit("socket.in."+e.t,e.d,e),this.settings.events[e.t]&&this.settings.events[e.t](e.d||null,e))}},this.debug=(e,t=!1)=>{(t||this.options.debug)&&console.debug(e)},this.destroy=()=>{clearTimeout(this.pingSchedule),clearTimeout(this.connectSchedule),this.disconnect(),this.ws=void 0},this.disconnect=()=>{const e=this.ws;e&&(this.debug("Disconnect"),this.autoReconnect=!1,e.onerror=e.onclose=e.onopen=e.onmessage=()=>{},e.close())},this.onError=e=>{this.options.debug=!0,this.debug("error: "+JSON.stringify(e)),this.tryOtherUrl=!0,clearTimeout(this.pingSchedule)},this.onSuccess=()=>{if(this.nbConnects++,1==this.nbConnects){let e;m.resolveFirstConnect(this.send),n(6e5,(()=>{this.options.idle=!0,e=setTimeout(this.destroy,72e5)}),(()=>{this.options.idle=!1,this.ws?clearTimeout(e):location.reload()}))}},this.baseUrl=()=>{const e=document.body.getAttribute("data-socket-domains").split(",");let t=this.storage.get();return t&&!this.tryOtherUrl||(t=e[Math.floor(Math.random()*e.length)],this.storage.set(t)),t},this.pingInterval=()=>this.computePingDelay()+this.averageLag,this.getVersion=()=>this.version,this.settings={receive:s.receive,events:s.events||{},params:Object.assign(Object.assign({},m.defaultParams),s.params||{})},this.options=Object.assign(Object.assign({},m.defaultOptions),s.options||{}),this.version=t,this.pubsub.on("socket.send",this.send),window.addEventListener("unload",this.destroy),this.connect()}}m.defaultOptions={idle:!1,pingMaxLag:9e3,pingDelay:2500,autoReconnectDelay:3500,protocol:"https:"===location.protocol?"wss:":"ws:",isAuth:document.body.hasAttribute("user")},m.defaultParams={sri:o},m.firstConnect=new Promise((e=>{m.resolveFirstConnect=e}));class p{constructor(e){this.send=e,this.currentId=1,this.messages=[],this.sign=e=>this._sign=e,this.resend=()=>{const e=performance.now()-2500;this.messages.forEach((t=>{t.at<e&&this.send(t.t,t.d,{sign:this._sign})}))},this.register=(e,t)=>{t.a=this.currentId++,this.messages.push({t:e,d:t,at:performance.now()})},this.onServerAck=e=>{this.messages=this.messages.filter((t=>t.d.a!==e))},setInterval(this.resend,1200)}}const g=(e,t)=>{window.requestIdleCallback?window.requestIdleCallback(e,t&&{timeout:t}):requestAnimationFrame(e)},b=e=>/[&<>"']/.test(e)?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&#39;").replace(/"/g,"&quot;"):e,f=(e,t={})=>{const s=(t=t||{}).sameDomain?"":document.body.getAttribute("data-asset-url"),n=t.version||document.body.getAttribute("data-asset-version");return s+"/assets"+(t.noVersion?"":"/_"+n)+"/"+e},v=new Map,w=e=>{if(!v.has(e)){v.set(e,!0);const t=document.createElement("link");t.rel="stylesheet",t.href=f(e),document.head.append(t)}},y=e=>w(`css/${e}.${$("body").data("theme")}.${$("body").data("dev")?"dev":"min"}.css`),S=e=>`compiled/${e}${$("body").data("dev")?"":".min"}.js`,k=new Map,_=(e,t={})=>{var s;return k.has(e)||k.set(e,(s=f(e,t),new Promise(((e,t)=>{const n=document.body.getAttribute("data-nonce"),i=document.createElement("script");n&&i.setAttribute("nonce",n),i.onload=e,i.onerror=t,i.src=s,document.head.append(i)})))),k.get(e)},C=e=>_(S(e)),O=()=>(y("complete"),C("userComplete").then((e=>window.UserComplete))),T=()=>(w("vendor/hopscotch/dist/css/hopscotch.min.css"),_("vendor/hopscotch/dist/js/hopscotch.min.js",{noVersion:!0})),A=e=>new Promise((t=>requestAnimationFrame((()=>{e.loadCss=y,t(window.LichessChat(document.querySelector(".mchat"),e))}))));function L(e,t){return"always"===t||!d.get(e)&&(d.set(e,"1"),!0)}const E='<div class="spinner"><svg viewBox="0 0 40 40"><circle cx=20 cy=20 r=18 fill="none"></circle></svg></div>',M=e=>{var t;return null===(t=document.querySelector(".crosstable"))||void 0===t?void 0:t.contains(e)};function j(e,t){return function(n){const i=($(n).data("href")||n.href).replace(/\?.+$/,"");t&&t(i),((e,t={})=>s(e,t).then((e=>{if(e.ok)return e.text();throw e.statusText})))(i+"/mini").then((t=>{const s=document.getElementById(e);s.innerHTML=t,lichess.contentLoaded(s)}))}}const x=(e,t)=>`<a class="btn-rack__btn" href="${e}" data-icon="${t}"></a>`,I=(e,t)=>{t=t||e.getAttribute("data-pt-pos")||(M(e)?"n":"s"),$(e).removeClass("ulpt").powerTip({preRender:j("powerTip",(t=>{const s=t.substr(3),n=$(e).data("name")||$(e).html();$("#powerTip").html('<div class="upt__info"><div class="upt__info__top"><span class="user-link offline">'+n+'</span></div></div><div class="upt__actions btn-rack">'+x("/@/"+s+"/tv","1")+x("/inbox/new?user="+s,"c")+x("/?user="+s+"#friend","U")+'<a class="btn-rack__btn relation-button" disabled></a></div>')})),placement:t})};function U(e){$(e).removeClass("glpt").powerTip({preRender:j("miniGame",(()=>E)),placement:M(e)?"n":"w",popupId:"miniGame"})}function P(e,t,s){"ontouchstart"in window||(s(e),$.powerTip.show(e,t))}function N(e,t,s){g((()=>Array.prototype.forEach.call(e.querySelectorAll(t),(e=>s(e)))),800)}const D={watchMouse(){document.body.addEventListener("mouseover",(e=>{const t=e.target,s=t.classList;s.contains("ulpt")?P(t,e,I):s.contains("glpt")&&P(t,e,U)}))},manualGameIn(e){N(e,".glpt",U)},manualGame:U,manualUser:I,manualUserIn(e){N(e,".ulpt",I)}},q=e=>`lichess-${e}`,R=(e,t)=>e[q(t)],V=(e,t,s)=>e[q(t)]=s,B=(e,t)=>{const s=$[e]=function(t,s){const n=this;n.element=$(s),s[e]=this,n.options=t,n._create()};s.prototype=t,$.fn[e]=function(t){const n=Array.prototype.slice.call(arguments,1);return"string"==typeof t?this.each((function(){const s=R(this,e);s&&$.isFunction(s[t])&&s[t].apply(s,n)})):this.each((function(){R(this,e)||V(this,e,new s(t,this))})),this}},H=[],z={on(e,t){H[e]=H[e]||[],H[e].push(t)},off(e,t){if(H[e])for(const s in H[e])if(H[e][s]===t){H[e].splice(s);break}},emit(e,...t){if(H[e])for(const s in H[e])H[e][s].apply(null,t)}};let F;const J=()=>{F&&clearTimeout(F),F=void 0,$("#announce").remove()},W=e=>{J(),e.msg&&($("body").append('<div id="announce" class="announce">'+b(e.msg)+(e.date?'<time class="timeago" datetime="'+e.date+'"></time>':"")+'<div class="actions"><a class="close">×</a></div></div>').find("#announce .close").on("click",J),F=setTimeout(J,e.date?new Date(e.date).getTime()-Date.now():5e3),e.date&&lichess.contentLoaded())};function G(e,t){if(t.length)if(e.includes("%s"))e=e.replace("%s",t[0]);else for(let s=0;s<t.length;s++)e=e.replace("%"+(s+1)+"$s",t[s]);return e}function X(e,t){const s=e.split(/(%(?:\d\$)?s)/g);if(t.length){const e=s.indexOf("%s");if(-1!==e)s[e]=t[0];else for(let e=0;1<t.length;e++){const n=s.indexOf("%"+(e+1)+"$s");-1!==n&&(s[n]=t[e])}}return s}function K(e){const t=(t,...s)=>{const n=e[t];return n?G(n,s):t};return t.plural=function(t,s){const n=`${t}:${lichess.quantity(s)}`,i=e[n]||e[t];return i?G(i,Array.prototype.slice.call(arguments,1)):t},t.noarg=t=>e[t]||t,t.vdom=(t,...s)=>{const n=e[t];return n?X(n,s):[t]},t.vdomPlural=(t,s,...n)=>{const i=`${t}:${lichess.quantity(s)}`,o=e[i]||e[t];return o?X(o,n):[t]},t}const Q=new class{constructor(){this.sounds=new Map,this.soundSet=$("body").data("sound-set"),this.speechStorage=d.makeBoolean("speech.enabled"),this.volumeStorage=d.make("sound-volume"),this.baseUrl=f("sound",{version:"_____1"}),this.loadOggOrMp3=(e,t)=>this.sounds.set(e,new window.Howl({src:["ogg","mp3"].map((e=>`${t}.${e}`))})),this.loadStandard=(e,t)=>{if(!this.enabled())return;const s=e[0].toUpperCase()+e.slice(1);this.loadOggOrMp3(e,`${this.baseUrl}/${t||this.soundSet}/${s}`)},this.setVolume=this.volumeStorage.set,this.getVolume=()=>{const e=parseFloat(this.volumeStorage.get()||"");return e>=0?e:.7},this.enabled=()=>"silent"!==this.soundSet,this.speech=e=>(void 0!==e&&this.speechStorage.set(e),this.speechStorage.get()),this.say=(e,t=!1,s=!1,n=!1)=>{if(t&&speechSynthesis.cancel(),!this.speechStorage.get()&&!s)return!1;const i=new SpeechSynthesisUtterance(e);return i.volume=this.getVolume(),i.lang=n?document.documentElement.lang:"en-US",speechSynthesis.speak(i),!0},this.sayOrPlay=(e,t)=>this.say(t)||this.play(e),this.publish=()=>z.emit("sound_set",this.soundSet),this.changeSet=e=>{this.soundSet=e,this.sounds.clear(),this.publish()},this.set=()=>this.soundSet,"music"==this.soundSet&&setTimeout(this.publish,500)}preloadBoardSounds(){"music"!==this.soundSet&&["move","capture","check","genericNotify"].forEach((e=>this.loadStandard(e)))}play(e,t){var s;if(!this.enabled())return;let n=this.soundSet;if("music"===n||this.speechStorage.get()){if(["move","capture","check"].includes(e))return;n="standard"}let i=this.sounds.get(e);i||(this.loadStandard(e,n),i=this.sounds.get(e));const o=()=>i.volume(this.getVolume()*(t||1)).play();"suspended"===(null===(s=window.Howler.ctx)||void 0===s?void 0:s.state)?window.Howler.ctx.resume().then(o):o()}},Y=e=>{const[t,s,n]=e.getAttribute("data-state").split(",");Z(e,t,s,n)},Z=(e,t,s,n)=>{window.Chessground?V(e,"chessground",window.Chessground(e,{orientation:s,coordinates:!1,viewOnly:!e.getAttribute("data-playable"),resizable:!1,fen:t,lastMove:n&&("@"===n[1]?[n.slice(2)]:[n[0]+n[1],n[2]+n[3]]),drawable:{enabled:!1,visible:!1}})):setTimeout((()=>Y(e)),500)};var ee=Object.freeze({__proto__:null,init:Y,initWith:Z,initAll:e=>Array.from((e||document).getElementsByClassName("mini-board--init")).forEach(Y)});const te=e=>e.indexOf(" b")>0?"black":"white",se=e=>{if(window.Chessground){const[t,s,n]=e.getAttribute("data-state").split(","),i={coordinates:!1,viewOnly:!0,resizable:!1,fen:t,orientation:s,lastMove:n&&("@"===n[1]?[n.slice(2)]:[n[0]+n[1],n[2]+n[3]]),drawable:{enabled:!1,visible:!1}},o=$(e).removeClass("mini-game--init"),a=o.find(".cg-wrap"),c=te(t);V(a[0],"chessground",window.Chessground(a[0],i)),["white","black"].forEach((e=>o.find(".mini-game__clock--"+e).each((function(){$(this).clock({time:parseInt(this.getAttribute("data-time")),pause:e!=c})}))))}else setTimeout((()=>se(e)),200);return e.getAttribute("data-live")};var ne=Object.freeze({__proto__:null,init:se,initAll:e=>{const t=Array.from((e||document).getElementsByClassName("mini-game--init")).map(se).filter((e=>e));t.length&&lichess.StrongSocket.firstConnect.then((e=>e("startWatching",t.join(" "))))},update:(e,t)=>{const s=$(e),n=t.lm,i=n&&("@"===n[1]?[n.slice(2)]:[n[0]+n[1],n[2]+n[3]]),o=R(e.querySelector(".cg-wrap"),"chessground");o&&o.set({fen:t.fen,lastMove:i});const a=te(t.fen),c=(e,t)=>{isNaN(e)||s.find(".mini-game__clock--"+t).clock("set",{time:e,pause:t!=a})};c(t.wc,"white"),c(t.bc,"black")},finish:(e,t)=>["white","black"].forEach((s=>{const n=$(e).find(".mini-game__clock--"+s).each((function(){$(this).clock("destroy")}));n.data("managed")||n.replaceWith(`<span class="mini-game__result">${t?t==s[0]?1:0:"½"}</span>`)}))});const ie=[60,3600,86400,604800,2628e3,31536e3],oe=[...ie];oe[2]*=2;const ae=e=>{return(e=>{let t=0;e<0&&(t=1,e=-e);const s=e;let n=0;for(;n<6&&e>=oe[n];n++);return n>0&&(e/=ie[n-1]),n*=2,(e=Math.floor(e))>(0===n?9:1)&&(n+=1),lichess.timeagoLocale(e,n,s)[t].replace("%s",e)})((Date.now()-(t=e,t instanceof Date?t:new Date(isNaN(t)?t:parseInt(t))).getTime())/1e3);var t};let ce;function re(e){const t=$(e);if(t.data("watched"))return;t.data("watched",1);const s=$('<div class="chat__members__inner">').appendTo(t),n=$('<div class="chat__members__number" data-icon="r" title="Spectators"></div>').appendTo(s),i=$("<div>").appendTo(s);lichess.pubsub.on("socket.in.crowd",(e=>o(e.watchers||e)));const o=e=>{if(ce=e,!e||!e.nb)return t.addClass("none");if(n.text(""+e.nb),e.users){const t=e.users.map((e=>e?`<a class="user-link ulpt" href="/@/${e.includes(" ")?e.split(" ")[1]:e}">${e}</a>`:"Anonymous"));1===e.anons?t.push("Anonymous"):e.anons&&t.push(`Anonymous (${e.anons})`),i.html(t.join(", "))}else i.html("");t.removeClass("none")};ce&&o(ce)}return function(){const e=window.lichess;e.StrongSocket=m,e.requestIdleCallback=g,e.sri=o,e.storage=d,e.tempStorage=u,e.once=L,e.powertip=D,e.widget=B,e.spinnerHtml=E,e.assetUrl=f,e.loadCss=w,e.loadCssPath=y,e.jsModule=S,e.loadScript=_,e.loadModule=C,e.hopscotch=T,e.userComplete=O,e.makeChat=A,e.idleTimer=n,e.pubsub=z,e.unload=r,e.redirect=c,e.reload=l,e.watchers=re,e.escapeHtml=b,e.announce=W,e.trans=K,e.sound=Q,e.miniBoard=ee,e.miniGame=ne,e.timeago=ae,e.contentLoaded=e=>z.emit("content-loaded",e)}(),function(e){document.body.classList.toggle("supports-max-content",!!window.chrome),window.LichessAnalyse.start(Object.assign(Object.assign({},e),{socketSend:()=>{}})),window.addEventListener("resize",(()=>document.body.dispatchEvent(new Event("chessground.resize")))),e.study.chapter.gamebook&&$(".main-board").append($(`<a href="/study/${e.study.id}/${e.study.chapter.id}" target="_blank" rel="noopener" class="button gamebook-embed">Start</a>`))}}();
