var LichessPuzzle=function(){"use strict";const e={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,n){return document.createElementNS(e,t,n)},createTextNode:function(e){return document.createTextNode(e)},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,n){e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){e.appendChild(t)},parentNode:function(e){return e.parentNode},nextSibling:function(e){return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType}};function t(e,t,n,o,r){return{sel:e,data:t,children:n,text:o,elm:r,key:void 0===t?void 0:t.key}}const n=Array.isArray;function o(e){return"string"==typeof e||"number"==typeof e}function r(e){return void 0===e}function s(e){return void 0!==e}const i=t("",{},[],void 0,void 0);function a(e,t){var n,o;const r=e.key===t.key,s=(null===(n=e.data)||void 0===n?void 0:n.is)===(null===(o=t.data)||void 0===o?void 0:o.is);return e.sel===t.sel&&r&&s}function c(e,t,n){var o;const r={};for(let s=t;s<=n;++s){const t=null===(o=e[s])||void 0===o?void 0:o.key;void 0!==t&&(r[t]=s)}return r}const l=["create","update","remove","destroy","pre","post"];function u(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let e=0;e<t.length;++e){const n=t[e].data;void 0!==n&&u(n,t[e].children,t[e].sel)}}function d(e,r,s){let i,a,c,l={};if(void 0!==s?(null!==r&&(l=r),n(s)?i=s:o(s)?a=s:s&&s.sel&&(i=[s])):null!=r&&(n(r)?i=r:o(r)?a=r:r&&r.sel?i=[r]:l=r),void 0!==i)for(c=0;c<i.length;++c)o(i[c])&&(i[c]=t(void 0,void 0,void 0,i[c],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||u(l,i,e),t(e,l,i,a,void 0)}function h(e,t){let n;const o=t.elm;let r=e.data.attrs,s=t.data.attrs;if((r||s)&&r!==s){for(n in r=r||{},s=s||{},s){const e=s[n];r[n]!==e&&(!0===e?o.setAttribute(n,""):!1===e?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,e):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,e):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,e):o.setAttribute(n,e))}for(n in r)n in s||o.removeAttribute(n)}}const p={create:h,update:h};function f(e,t){let n,o;const r=t.elm;let s=e.data.class,i=t.data.class;if((s||i)&&s!==i){for(o in s=s||{},i=i||{},s)s[o]&&!Object.prototype.hasOwnProperty.call(i,o)&&r.classList.remove(o);for(o in i)n=i[o],n!==s[o]&&r.classList[n?"add":"remove"](o)}}const m={create:f,update:f};function v(e){!window.LichessSpeech&&e?lichess.loadModule("speech"):window.LichessSpeech&&!e&&(window.LichessSpeech=void 0)}function g(e,t){var n;n=n=>n.step(e,t),window.LichessSpeech&&n(window.LichessSpeech)}const b=e=>void 0!==e,k=e=>{let t=e;return function(e){return b(e)&&(t=e),t}},w={Accept:"application/vnd.lichess.v5+json"},y={cache:"no-cache",credentials:"same-origin"},z={"X-Requested-With":"XMLHttpRequest"},S=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},y),{headers:Object.assign(Object.assign({},w),z)}),t)).then((e=>{if(e.ok)return e.json();throw e.statusText})),C=(e,t={})=>E(e,t).then((e=>{if(e.ok)return e.text();throw e.statusText})),E=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},y),{headers:Object.assign({},z)}),t)),x=e=>{const t=new FormData;for(const n of Object.keys(e))t.append(n,e[n]);return t};function M(e,t){let n,o=0;return function(...r){const s=this,i=performance.now()-o;function a(){n=void 0,o=performance.now(),t.apply(s,r)}n&&clearTimeout(n),i>e?a():n=setTimeout(a,e-i)}}function _(e,t,n){return S(`/training/${e}/vote/${t}`,{method:"POST",body:b(n)?x({vote:n}):void 0})}const P=M(1e3,(e=>C("/pref/zen",{method:"post",body:x({zen:e?1:0})})));function q(e){const t={sync:void 0,promise:e.then((e=>(t.sync=e,e)))};return t}const O=["a","b","c","d","e","f","g","h"],A=["1","2","3","4","5","6","7","8"],N=["white","black"],D=["pawn","knight","bishop","rook","queen","king"],R=["a","h"];function T(e){return"role"in e}function I(e){return void 0!==e}function L(e){return"white"===e?"black":"white"}function B(e){return e>>3}function j(e){return 7&e}function F(e){switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}}function K(e){switch(e){case"P":case"p":return"pawn";case"N":case"n":return"knight";case"B":case"b":return"bishop";case"R":case"r":return"rook";case"Q":case"q":return"queen";case"K":case"k":return"king";default:return}}function W(e){if(2!==e.length)return;const t=e.charCodeAt(0)-"a".charCodeAt(0),n=e.charCodeAt(1)-"1".charCodeAt(0);return t<0||t>=8||n<0||n>=8?void 0:t+8*n}function V(e){return O[j(e)]+A[B(e)]}function U(e){if("@"===e[1]&&4===e.length){const t=K(e[0]),n=W(e.slice(2));if(t&&I(n))return{role:t,to:n}}else if(4===e.length||5===e.length){const t=W(e.slice(0,2)),n=W(e.slice(2,4));let o;if(5===e.length&&(o=K(e[4]),!o))return;if(I(t)&&I(n))return{from:t,to:n,promotion:o}}}function H(e){return T(e)?`${F(e.role).toUpperCase()}@${V(e.to)}`:V(e.from)+V(e.to)+(e.promotion?F(e.promotion):"")}function G(e,t){return"white"===e?"a"===t?2:6:"a"===t?58:62}function X(e){return T(e)?String.fromCharCode(35+e.to,139+["queen","rook","bishop","knight","pawn"].indexOf(e.role)):String.fromCharCode(35+e.from,e.promotion?99+8*["queen","rook","bishop","knight","king"].indexOf(e.promotion)+j(e.to):35+e.to)}function Q(e){switch(e){case"standard":case"chess960":case"fromPosition":return"chess";case"threeCheck":return"3check";case"kingOfTheHill":return"kingofthehill";case"racingKings":return"racingkings";default:return e}}function Y(){const e={};return e.promise=new Promise(((t,n)=>{e.resolve=t,e.reject=n})),e}const J=new RegExp(""+/^info depth (\d+) seldepth \d+ multipv (\d+) /.source+/score (cp|mate) ([-\d]+) /.source+/(?:(upper|lower)bound )?nodes (\d+) nps \S+ /.source+/(?:hashfull \d+ )?(?:tbhits \d+ )?time (\S+) /.source+/pv (.+)/.source);class Z{constructor(e,t){this.send=e,this.opts=t,this.engineNameDeferred=Y(),this.engineName=q(this.engineNameDeferred.promise),this.expectedPvs=1,this.threads=1,this.hashSize=16}init(){this.send("uci"),this.setOption("UCI_AnalyseMode","true"),this.setOption("Analysis Contempt","Off"),this.setOption("UCI_Chess960","true"),"antichess"===this.opts.variant?this.setOption("UCI_Variant","giveaway"):this.setOption("UCI_Variant",Q(this.opts.variant))}setOption(e,t){this.send(`setoption name ${e} value ${t}`)}received(e){if(e.startsWith("id name "))this.engineNameDeferred.resolve(e.substring("id name ".length));else if(e.startsWith("bestmove "))return this.work&&this.currentEval&&this.work.emit(this.currentEval),this.work=void 0,void this.swapWork();if(!this.work||this.work.stopRequested)return;const t=e.match(J);if(!t)return;const n=parseInt(t[1]),o=parseInt(t[2]),r="mate"===t[3],s=parseInt(t[4]),i=t[5],a=parseInt(t[6]),c=parseInt(t[7]),l=t[8].split(" ");if(r&&!s)return;if(this.expectedPvs<o&&(this.expectedPvs=o),n<6)return;const u=this.work.threatMode?0:1,d=this.work.ply%2===u?-s:s;if(i&&1===o)return;const h={moves:l,cp:r?void 0:d,mate:r?d:void 0,depth:n};1===o?this.currentEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:n,knps:a/c,nodes:a,cp:r?void 0:d,mate:r?d:void 0,pvs:[h],millis:c}:this.currentEval&&(this.currentEval.pvs.push(h),this.currentEval.depth=Math.min(this.currentEval.depth,n)),o===this.expectedPvs&&this.currentEval&&this.work.emit(this.currentEval)}swapWork(){if(this.stop(),!this.work&&(this.work=this.nextWork,this.nextWork=void 0,this.work)){this.currentEval=void 0,this.expectedPvs=1;const e=this.opts.threads?this.opts.threads():1;this.threads!=e&&(this.threads=e,this.setOption("Threads",e));const t=this.opts.hashSize?this.opts.hashSize():16;this.hashSize!=t&&(this.hashSize=t,this.setOption("Hash",t)),this.setOption("MultiPV",this.work.multiPv),this.send(["position","fen",this.work.initialFen,"moves"].concat(this.work.moves).join(" ")),this.work.maxDepth>=99?this.send("go depth 99"):this.send("go movetime 90000 depth "+this.work.maxDepth)}}start(e){this.nextWork=e,this.swapWork()}stop(){this.work&&!this.work.stopRequested&&(this.work.stopRequested=!0,this.send("stop"))}isComputing(){return!!this.work&&!this.work.stopRequested}}class ee{constructor(e,t){this.protocolOpts=e,this.opts=t,this.isComputing=()=>!!this.protocol.sync&&this.protocol.sync.isComputing(),this.engineName=()=>{var e;return null===(e=this.protocol.sync)||void 0===e?void 0:e.engineName.sync},this.protocol=q(this.boot())}stop(){return this.protocol.promise.then((e=>e.stop()))}start(e){return this.protocol.promise.then((t=>t.start(e)))}}class te extends ee{boot(){this.worker=new Worker(lichess.assetUrl(this.opts.url,{sameDomain:!0}));const e=new Z(this.send.bind(this),this.protocolOpts);return this.worker.addEventListener("message",(t=>{e.received(t.data)}),!0),e.init(),Promise.resolve(e)}destroy(){this.worker.terminate()}send(e){this.worker.postMessage(e)}}class ne extends ee{boot(){var e,t;const n=this.opts.version,o=this.opts.downloadProgress,r=this.opts.cache,s=this.opts.baseUrl+"stockfish.wasm";return(e=ne.protocols)[t=this.opts.module]||(e[t]=lichess.loadScript(this.opts.baseUrl+"stockfish.js",{version:n}).then((e=>o&&new Promise((async(e,t)=>{if(r){const[t,o]=await r.get(s,n);if(t)return void e(o)}const i=new XMLHttpRequest;i.open("GET",lichess.assetUrl(s,{version:n}),!0),i.responseType="arraybuffer",i.onerror=e=>t(e),i.onprogress=e=>o(e.loaded),i.onload=t=>{o(0),e(i.response)},i.send()})))).then((async e=>(r&&e&&await r.set(s,n,e),window[this.opts.module]({wasmBinary:e,locateFile:e=>lichess.assetUrl(this.opts.baseUrl+e,{version:n,sameDomain:e.endsWith(".worker.js")}),wasmMemory:this.opts.wasmMemory})))).then((e=>{ne.sf[this.opts.module]=e;const t=new Z(this.send.bind(this),this.protocolOpts);return e.addMessageListener(t.received.bind(t)),t.init(),t}))),ne.protocols[this.opts.module]}destroy(){var e;null===(e=this.protocol.sync)||void 0===e||e.stop()}send(e){var t;null===(t=ne.sf[this.opts.module])||void 0===t||t.postMessage(e)}}ne.protocols={},ne.sf={};const oe=lichess.storage;function re(e,t){const n="analyse."+e,o=!0===t||!1===t;let r;return function(e){return b(e)&&e!=r?(r=e+"",oe.set(n,e)):b(r)||(r=oe.get(n),null===r&&(r=t+"")),o?"true"===r:r}}const se=(e,t)=>n=>{if(b(n))return oe.set(e,JSON.stringify(n)),n;const o=JSON.parse(oe.get(e));return null!==o?o:t()};function ie(e){return 2/(1+Math.exp(-.004*e))-1}function ae(e){return void 0!==e.mate?(n=e.mate,ie(100*(21-Math.min(10,Math.abs(n)))*(n>0?1:-1))):(t=e.cp,ie(Math.min(Math.max(-1e3,t),1e3)));var t,n}function ce(e,t){return function(e,t){return"white"===e?t:-t}(e,ae(t))}function le(e,t,n){return(ce(e,t)-ce(e,n))/2}function ue(e){return((e=Math.max(Math.min(Math.round(e/10)/10,99),-99))>0?"+":"")+e.toFixed(1)}function de(e){return new Promise(((t,n)=>{e.oncomplete=e.onsuccess=()=>t(e.result),e.onabort=e.onerror=()=>n(e.error)}))}function he(e,t){const n=indexedDB.open(e);n.onupgradeneeded=()=>n.result.createObjectStore(t);const o=de(n);return(e,n)=>o.then((o=>n(o.transaction(t,e).objectStore(t))))}let pe;function fe(){return pe||(pe=he("keyval-store","keyval")),pe}function me(e,t=fe()){return t("readonly",(t=>de(t.get(e))))}function ve(e,t,n=fe()){return n("readwrite",(n=>(n.put(t,e),de(n.transaction))))}class ge{constructor(e){this.store=he(`${e}--db`,`${e}--store`)}async get(e,t){if(await me(`${e}--version`,this.store)!==t)return[!1,void 0];return[!0,await me(`${e}--data`,this.store)]}async set(e,t,n){await me(`${e}--version`,this.store)!==t&&(await ve(`${e}--version`,t,this.store),await ve(`${e}--data`,n,this.store))}}function be(e,t){return new WebAssembly.Memory({shared:!0,initial:e,maximum:t})}function ke(){const e=lichess.tempStorage.get("ceval.enabled-after"),t=lichess.storage.get("ceval.disable");return!t||e===t}function we(e){var t;const n=t=>e.storageKeyPrefix?`${e.storageKeyPrefix}.${t}`:t,o=re("ceval.enable-nnue",!(null===(t=navigator.connection)||void 0===t?void 0:t.saveData)),r=e.standardMaterial&&["standard","fromPosition","chess960"].includes(e.variant.key);let s="asmjs",i=!1,a=!1;const c=Uint8Array.from([0,97,115,109,1,0,0,0]);if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.validate&&WebAssembly.validate(c)){s="wasm";const e=function(e,t){if("object"!=typeof Atomics)return;if("function"!=typeof SharedArrayBuffer)return;const n=be(e,t);if(n.buffer instanceof SharedArrayBuffer){try{window.postMessage(n,"*")}catch(e){return}return n}}(8,16);if(e){s="hce";const t=Uint8Array.from([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,7,8,1,4,116,101,115,116,0,0,10,15,1,13,0,65,0,253,17,65,0,253,17,253,186,1,11]);a=WebAssembly.validate(t),a&&r&&o()&&(s="nnue");try{e.grow(8),i=!0}catch(e){}}}const l=r?2:1,u=Math.min(Math.max((navigator.hardwareConcurrency||1)-1,1),i?32:l),d=re(n("ceval.threads"),Math.min(Math.ceil((navigator.hardwareConcurrency||1)/4),u)),h=Math.min(1024*(navigator.deviceMemory||.25)/8,i?1024:16),p=re(n("ceval.hash-size"),16),f=re(n("ceval.max-depth"),18),m=re(n("ceval.multipv"),e.multiPvDefault||1),v=re("ceval.infinite",!1);let g=null;const b=k(!0),w=k(e.possible&&b()&&ke()),y=k(0);let z=!1,S=!1;const C=k(null),E=k(null),x=k(!1),_={variant:e.variant.key,threads:("hce"==s||"nnue"==s)&&(()=>Math.min(parseInt(d()),u)),hashSize:("hce"==s||"nnue"==s)&&(()=>Math.min(parseInt(p()),h))};let P;const q=(()=>{const e=[];return t=>{if((e=>e.knps&&e.depth>=16&&void 0!==e.cp&&Math.abs(e.cp)<500&&e.fen.split(/\s/)[0].split(/[nbrqkp]/i).length-1>=10)(t)&&(e.push(t.knps),e.length>9)){const t=function(e){e.sort(((e,t)=>e-t));const t=Math.floor(e.length/2);return e.length%2?e[t]:(e[t-1]+e[t])/2}(e)||0;let n=18;t>100&&(n=19),t>150&&(n=20),t>250&&(n=21),t>500&&(n=22),t>1e3&&(n=23),t>2e3&&(n=24),t>3500&&(n=25),t>5e3&&(n=26),t>7e3&&(n=27),n+=2*Number("nnue"===s),f(n),e.length>40&&e.shift()}}})();let O=null;const A=M(200,((t,n)=>{D(t.pvs,n.ply%2==(n.threatMode?1:0)?"white":"black"),q(t),g=t,e.emit(t,n),t.fen!==O&&ke()&&(O=t.fen,lichess.storage.fire("ceval.fen",t.fen))})),N=()=>x()||v()?99:parseInt(f()),D=(e,t)=>e.sort((function(e,n){return ce(t,n)-ce(t,e)})),R=(t,n,o,a)=>{if(!w()||!e.possible||!ke())return;x(a);const c=N(),l=n[n.length-1],u=o?l.threat:l.ceval;if(u&&u.depth>=c)return void(S={path:t,steps:n,threatMode:o});const d={initialFen:n[0].fen,moves:[],currentFen:l.fen,path:t,ply:l.ply,maxDepth:c,multiPv:parseInt(m()),threatMode:o,emit(e){w()&&A(e,d)},stopRequested:!1};if(o){const e=l.ply%2==1?"w":"b",t=l.fen.replace(/ (w|b) /," "+e+" ");d.currentFen=t,d.initialFen=t}else for(let t=1;t<n.length;t++){const o=n[t];h=e.variant.key,(p=o.san).startsWith("O-O")||"crazyhouse"!==h&&(p.includes("x")||p.toLowerCase()===p||"threeCheck"===h&&p.includes("+"))?(d.moves=[],d.initialFen=o.fen):d.moves.push(o.uci)}var h,p;lichess.storage.fire("ceval.disable"),lichess.tempStorage.set("ceval.enabled-after",lichess.storage.get("ceval.disable")),P||(P="nnue"==s?new ne(_,{baseUrl:"vendor/stockfish-nnue.wasm/",module:"Stockfish",downloadProgress:M(200,(t=>{y(t),e.redraw()})),version:"85a969",wasmMemory:be(2048,i?32768:2048),cache:new ge("ceval-wasm-cache")}):"hce"==s?new ne(_,{baseUrl:r?"vendor/stockfish.wasm/":"vendor/stockfish-mv.wasm/",module:r?"Stockfish":"StockfishMv",wasmMemory:be(1024,i?32768:1088)}):new te(_,{url:"wasm"==s?"vendor/stockfish.js/stockfish.wasm.js":"vendor/stockfish.js/stockfish.js"})),P.start(d),z={path:t,steps:n,threatMode:o}};function T(){w()&&z&&(null==P||P.stop(),S=z,z=!1)}return{technology:s,start:R,stop:T,allowed:b,possible:e.possible,enabled:w,downloadProgress:y,multiPv:m,threads:"hce"==s||"nnue"==s?d:void 0,hashSize:"hce"==s||"nnue"==s?p:void 0,maxThreads:u,maxHashSize:h,infinite:v,supportsNnue:a,enableNnue:o,hovering:C,setHovering(t,n){C(n?{fen:t,uci:n}:null),e.setAutoShapes()},pvBoard:E,setPvBoard(t){E(t),e.redraw()},toggle(){if(e.possible&&b())if(T(),w()||document.hidden)lichess.tempStorage.set("ceval.enabled-after",""),w(!1);else{const e=lichess.storage.get("ceval.disable");e&&lichess.tempStorage.set("ceval.enabled-after",e),w(!0)}},curDepth:()=>g?g.depth:0,effectiveMaxDepth:N,variant:e.variant,isDeeper:x,goDeeper:function(){const e=z||S;e&&(T(),R(e.path,e.steps,e.threatMode,!0))},canGoDeeper:()=>!x()&&!v()&&!(null==P?void 0:P.isComputing()),isComputing:()=>!!z&&!!(null==P?void 0:P.isComputing()),engineName:()=>null==P?void 0:P.engineName(),destroy:()=>null==P?void 0:P.destroy(),redraw:e.redraw}}function ye(e){return e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24}function ze(e){return(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16}function Se(e){return ze(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4)}class Ce{constructor(e,t){this.lo=e,this.hi=t,this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new Ce(0,1<<e-32):new Ce(1<<e,0)}static fromRank(e){return new Ce(255,0).shl64(8*e)}static fromFile(e){return new Ce(16843009<<e,16843009<<e)}static empty(){return new Ce(0,0)}static full(){return new Ce(4294967295,4294967295)}static corners(){return new Ce(129,2164260864)}static center(){return new Ce(402653184,24)}static backranks(){return new Ce(255,4278190080)}static backrank(e){return"white"===e?new Ce(255,0):new Ce(0,4278190080)}static lightSquares(){return new Ce(1437226410,1437226410)}static darkSquares(){return new Ce(2857740885,2857740885)}complement(){return new Ce(~this.lo,~this.hi)}xor(e){return new Ce(this.lo^e.lo,this.hi^e.hi)}union(e){return new Ce(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new Ce(this.lo&e.lo,this.hi&e.hi)}diff(e){return new Ce(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?Ce.empty():e>=32?new Ce(this.hi>>>e-32,0):e>0?new Ce(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?Ce.empty():e>=32?new Ce(0,this.lo<<e-32):e>0?new Ce(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new Ce(ze(this.hi),ze(this.lo))}rbit64(){return new Ce(Se(this.hi),Se(this.lo))}minus64(e){const t=this.lo-e.lo,n=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new Ce(t,this.hi-(e.hi+n))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return ye(this.lo)+ye(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return 0!=(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new Ce(this.lo,this.hi|1<<e-32):new Ce(this.lo|1<<e,this.hi)}without(e){return e>=32?new Ce(this.lo,this.hi&~(1<<e-32)):new Ce(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new Ce(this.lo,this.hi^1<<e-32):new Ce(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new Ce(this.lo&this.lo-1,this.hi):new Ce(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||0!=(this.lo&this.lo-1)||0!=(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}isSingleSquare(){return this.nonEmpty()&&!this.moreThanOne()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield t}}}function Ee(e,t){let n=Ce.empty();for(const o of t){const t=e+o;0<=t&&t<64&&Math.abs(j(e)-j(t))<=2&&(n=n.with(t))}return n}function xe(e){const t=[];for(let n=0;n<64;n++)t[n]=e(n);return t}const Me=xe((e=>Ee(e,[-9,-8,-7,-1,1,7,8,9]))),_e=xe((e=>Ee(e,[-17,-15,-10,-6,6,10,15,17]))),Pe={white:xe((e=>Ee(e,[7,9]))),black:xe((e=>Ee(e,[-7,-9])))};function qe(e){return Me[e]}function Oe(e){return _e[e]}function Ae(e,t){return Pe[e][t]}const Ne=xe((e=>Ce.fromFile(j(e)).without(e))),De=xe((e=>Ce.fromRank(B(e)).without(e))),Re=xe((e=>{const t=new Ce(134480385,2151686160),n=8*(B(e)-j(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)})),Te=xe((e=>{const t=new Ce(270549120,16909320),n=8*(B(e)+j(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}));function $e(e,t,n){let o=n.intersect(t),r=o.bswap64();return o=o.minus64(e),r=r.minus64(e.bswap64()),o.xor(r.bswap64()).intersect(t)}function Ie(e,t){const n=Ce.fromSquare(e);return $e(n,Re[e],t).xor($e(n,Te[e],t))}function Le(e,t){return function(e,t){return $e(Ce.fromSquare(e),Ne[e],t)}(e,t).xor(function(e,t){const n=De[e];let o=t.intersect(n),r=o.rbit64();return o=o.minus64(Ce.fromSquare(e)),r=r.minus64(Ce.fromSquare(63-e)),o.xor(r.rbit64()).intersect(n)}(e,t))}function Be(e,t){return Ie(e,t).xor(Le(e,t))}function je(e,t,n){switch(e.role){case"pawn":return Ae(e.color,t);case"knight":return Oe(t);case"bishop":return Ie(t,n);case"rook":return Le(t,n);case"queen":return Be(t,n);case"king":return qe(t)}}function Fe(e,t){const n=Ce.fromSquare(t);return De[e].intersects(n)?De[e].with(e):Te[e].intersects(n)?Te[e].with(e):Re[e].intersects(n)?Re[e].with(e):Ne[e].intersects(n)?Ne[e].with(e):Ce.empty()}function Ke(e,t){return Fe(e,t).intersect(Ce.full().shl64(e).xor(Ce.full().shl64(t))).withoutFirst()}function We(e,t){var n;const o=function(e,t){let n="";if(T(t))"pawn"!==t.role&&(n=F(t.role).toUpperCase()),n+="@"+V(t.to);else{const o=e.board.getRole(t.from);if(!o)return"--";if("king"!==o||!e.board[e.turn].has(t.to)&&2!==Math.abs(t.to-t.from)){const r=e.board.occupied.has(t.to)||"pawn"===o&&j(t.from)!==j(t.to);if("pawn"!==o){let r;if(n=F(o).toUpperCase(),r="king"===o?qe(t.to).intersect(e.board.king):"queen"===o?Be(t.to,e.board.occupied).intersect(e.board.queen):"rook"===o?Le(t.to,e.board.occupied).intersect(e.board.rook):"bishop"===o?Ie(t.to,e.board.occupied).intersect(e.board.bishop):Oe(t.to).intersect(e.board.knight),r=r.intersect(e.board[e.turn]).without(t.from),r.nonEmpty()){const o=e.ctx();for(const n of r)e.dests(n,o).has(t.to)||(r=r.without(n));if(r.nonEmpty()){let e=!1,o=r.intersects(Ce.fromRank(B(t.from)));r.intersects(Ce.fromFile(j(t.from)))?e=!0:o=!0,o&&(n+=O[j(t.from)]),e&&(n+=A[B(t.from)])}}}else r&&(n=O[j(t.from)]);r&&(n+="x"),n+=V(t.to),t.promotion&&(n+="="+F(t.promotion).toUpperCase())}else n=t.to>t.from?"O-O":"O-O-O"}return n}(e,t);return e.play(t),(null===(n=e.outcome())||void 0===n?void 0:n.winner)?o+"#":e.isCheck()?o+"+":o}function Ve(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var Ue,He=function(){function e(){}var t=e.prototype;return t.unwrap=function(e,t){var n=this._chain((function(t){return Ue.ok(e?e(t):t)}),(function(e){return t?Ue.ok(t(e)):Ue.err(e)}));if(n.isErr)throw n.error;return n.value},t.map=function(e,t){return this._chain((function(t){return Ue.ok(e(t))}),(function(e){return Ue.err(t?t(e):e)}))},t.chain=function(e,t){return this._chain(e,t||function(e){return Ue.err(e)})},e}(),Ge=function(e){function t(t){var n;return(n=e.call(this)||this).value=t,n.isOk=!0,n.isErr=!1,n}return Ve(t,e),t.prototype._chain=function(e,t){return e(this.value)},t}(He),Xe=function(e){function t(t){var n;return(n=e.call(this)||this).error=t,n.isOk=!1,n.isErr=!0,n}return Ve(t,e),t.prototype._chain=function(e,t){return t(this.error)},t}(He);!function(e){e.ok=function(e){return new Ge(e)},e.err=function(e){return new Xe(e||new Error)},e.all=function(t){if(Array.isArray(t)){for(var n=[],o=0;o<t.length;o++){var r=t[o];if(r.isErr)return r;n.push(r.value)}return e.ok(n)}for(var s={},i=Object.keys(t),a=0;a<i.length;a++){var c=t[i[a]];if(c.isErr)return c;s[i[a]]=c.value}return e.ok(s)}}(Ue||(Ue={}));class Qe{constructor(){}static default(){const e=new Qe;return e.reset(),e}static racingKings(){const e=new Qe;return e.occupied=new Ce(65535,0),e.promoted=Ce.empty(),e.white=new Ce(61680,0),e.black=new Ce(3855,0),e.pawn=Ce.empty(),e.knight=new Ce(6168,0),e.bishop=new Ce(9252,0),e.rook=new Ce(16962,0),e.queen=new Ce(129,0),e.king=new Ce(33024,0),e}static horde(){const e=new Qe;return e.occupied=new Ce(4294967295,4294901862),e.promoted=Ce.empty(),e.white=new Ce(4294967295,102),e.black=new Ce(0,4294901760),e.pawn=new Ce(4294967295,16711782),e.knight=new Ce(0,1107296256),e.bishop=new Ce(0,603979776),e.rook=new Ce(0,2164260864),e.queen=new Ce(0,134217728),e.king=new Ce(0,268435456),e}reset(){this.occupied=new Ce(65535,4294901760),this.promoted=Ce.empty(),this.white=new Ce(65535,0),this.black=new Ce(0,4294901760),this.pawn=new Ce(65280,16711680),this.knight=new Ce(66,1107296256),this.bishop=new Ce(36,603979776),this.rook=new Ce(129,2164260864),this.queen=new Ce(8,134217728),this.king=new Ce(16,268435456)}static empty(){const e=new Qe;return e.clear(),e}clear(){this.occupied=Ce.empty(),this.promoted=Ce.empty();for(const e of N)this[e]=Ce.empty();for(const e of D)this[e]=Ce.empty()}clone(){const e=new Qe;e.occupied=this.occupied,e.promoted=this.promoted;for(const t of N)e[t]=this[t];for(const t of D)e[t]=this[t];return e}equalsIgnorePromoted(e){return!!this.white.equals(e.white)&&D.every((t=>this[t].equals(e[t])))}equals(e){return this.equalsIgnorePromoted(e)&&this.promoted.equals(e.promoted)}getColor(e){return this.white.has(e)?"white":this.black.has(e)?"black":void 0}getRole(e){for(const t of D)if(this[t].has(e))return t}get(e){const t=this.getColor(e);if(!t)return;return{color:t,role:this.getRole(e),promoted:this.promoted.has(e)}}take(e){const t=this.get(e);return t&&(this.occupied=this.occupied.without(e),this[t.color]=this[t.color].without(e),this[t.role]=this[t.role].without(e),t.promoted&&(this.promoted=this.promoted.without(e))),t}set(e,t){const n=this.take(e);return this.occupied=this.occupied.with(e),this[t.color]=this[t.color].with(e),this[t.role]=this[t.role].with(e),t.promoted&&(this.promoted=this.promoted.with(e)),n}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,t){return this[e].intersect(this[t])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.king.intersect(this[e]).diff(this.promoted).singleSquare()}}class Ye{constructor(){}static empty(){const e=new Ye;for(const t of D)e[t]=0;return e}static fromBoard(e,t){const n=new Ye;for(const o of D)n[o]=e.pieces(t,o).size();return n}clone(){const e=new Ye;for(const t of D)e[t]=this[t];return e}equals(e){return D.every((t=>this[t]===e[t]))}add(e){const t=new Ye;for(const n of D)t[n]=this[n]+e[n];return t}nonEmpty(){return D.some((e=>this[e]>0))}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}count(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class Je{constructor(e,t){this.white=e,this.black=t}static empty(){return new Je(Ye.empty(),Ye.empty())}static fromBoard(e){return new Je(Ye.fromBoard(e,"white"),Ye.fromBoard(e,"black"))}clone(){return new Je(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new Je(this.white.add(e.white),this.black.add(e.black))}count(){return this.white.count()+this.black.count()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class Ze{constructor(e,t){this.white=e,this.black=t}static default(){return new Ze(3,3)}clone(){return new Ze(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}var et,tt;!function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"}(et||(et={}));class nt extends Error{}function ot(e){return/^\d{1,4}$/.test(e)?parseInt(e,10):void 0}function rt(e){const t=K(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}}function st(e){const t=Qe.empty();let n=7,o=0;for(let r=0;r<e.length;r++){const s=e[r];if("/"===s&&8===o)o=0,n--;else{const i=parseInt(s,10);if(i>0)o+=i;else{if(o>=8||n<0)return Ue.err(new nt(et.Board));const i=o+8*n,a=rt(s);if(!a)return Ue.err(new nt(et.Board));"~"===e[r+1]&&(a.promoted=!0,r++),t.set(i,a),o++}}}return 0!==n||8!==o?Ue.err(new nt(et.Board)):Ue.ok(t)}function it(e){if(e.length>64)return Ue.err(new nt(et.Pockets));const t=Je.empty();for(const n of e){const e=rt(n);if(!e)return Ue.err(new nt(et.Pockets));t[e.color][e.role]++}return Ue.ok(t)}function at(e){const t=e.split("+");if(3===t.length&&""===t[0]){const e=ot(t[1]),n=ot(t[2]);return!I(e)||e>3||!I(n)||n>3?Ue.err(new nt(et.RemainingChecks)):Ue.ok(new Ze(3-e,3-n))}if(2===t.length){const e=ot(t[0]),n=ot(t[1]);return!I(e)||e>3||!I(n)||n>3?Ue.err(new nt(et.RemainingChecks)):Ue.ok(new Ze(e,n))}return Ue.err(new nt(et.RemainingChecks))}function ct(e){const t=e.split(" "),n=t.shift();let o,r,s=Ue.ok(void 0);if(n.endsWith("]")){const e=n.indexOf("[");if(-1===e)return Ue.err(new nt(et.Fen));o=st(n.substr(0,e)),s=it(n.substr(e+1,n.length-1-e-1))}else{const e=function(e,t,n){let o=e.indexOf(t);for(;n-- >0&&-1!==o;)o=e.indexOf(t,o+t.length);return o}(n,"/",7);-1===e?o=st(n):(o=st(n.substr(0,e)),s=it(n.substr(e+1)))}const i=t.shift();if(I(i)&&"w"!==i){if("b"!==i)return Ue.err(new nt(et.Turn));r="black"}else r="white";return o.chain((e=>{const n=t.shift(),o=I(n)?function(e,t){let n=Ce.empty();if("-"===t)return Ue.ok(n);if(!/^[KQABCDEFGH]{0,2}[kqabcdefgh]{0,2}$/.test(t))return Ue.err(new nt(et.Castling));for(const o of t){const t=o.toLowerCase(),r=o===t?"black":"white",s=Ce.backrank(r).intersect(e[r]);let i;i="q"===t?s:"k"===t?s.reversed():Ce.fromSquare(t.charCodeAt(0)-"a".charCodeAt(0)).intersect(s);for(const t of i){if(e.king.has(t)&&!e.promoted.has(t))break;if(e.rook.has(t)){n=n.with(t);break}}}return Ue.ok(n)}(e,n):Ue.ok(Ce.empty()),i=t.shift();let a;if(I(i)&&"-"!==i&&(a=W(i),!I(a)))return Ue.err(new nt(et.EpSquare));let c,l=t.shift();I(l)&&l.includes("+")&&(c=at(l),l=t.shift());const u=I(l)?ot(l):0;if(!I(u))return Ue.err(new nt(et.Halfmoves));const d=t.shift(),h=I(d)?ot(d):1;if(!I(h))return Ue.err(new nt(et.Fullmoves));const p=t.shift();let f=Ue.ok(void 0);if(I(p)){if(I(c))return Ue.err(new nt(et.RemainingChecks));f=at(p)}else I(c)&&(f=c);return t.length>0?Ue.err(new nt(et.Fen)):s.chain((t=>o.chain((n=>f.map((o=>({board:e,pockets:t,turn:r,unmovedRooks:n,remainingChecks:o,epSquare:a,halfmoves:u,fullmoves:Math.max(1,h)})))))))}))}function lt(e,t){let n=F(e.role);return"white"===e.color&&(n=n.toUpperCase()),(null==t?void 0:t.promoted)&&e.promoted&&(n+="~"),n}function ut(e,t){let n="",o=0;for(let r=7;r>=0;r--)for(let s=0;s<8;s++){const i=s+8*r,a=e.get(i);a?(o>0&&(n+=o,o=0),n+=lt(a,t)):o++,7===s&&(o>0&&(n+=o,o=0),0!==r&&(n+="/"))}return n}function dt(e){return D.map((t=>F(t).repeat(e[t]))).join("")}function ht(e,t,n){const o=null==n?void 0:n.shredder;let r="";for(const n of N){const s=Ce.backrank(n),i=e.kingOf(n);if(!I(i)||!s.has(i))continue;const a=e.pieces(n,"rook").intersect(s);for(const e of t.intersect(a).reversed())if(!o&&e===a.first()&&e<i)r+="white"===n?"Q":"q";else if(!o&&e===a.last()&&i<e)r+="white"===n?"K":"k";else{const t=O[j(e)];r+="white"===n?t.toUpperCase():t}}return r||"-"}function pt(e,t){return[ut(e.board,t)+(e.pockets?`[${o=e.pockets,dt(o.white).toUpperCase()+dt(o.black)}]`:""),e.turn[0],ht(e.board,e.unmovedRooks,t),I(e.epSquare)?V(e.epSquare):"-",...e.remainingChecks?[(n=e.remainingChecks,`${n.white}+${n.black}`)]:[],...(null==t?void 0:t.epd)?[]:[Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))]].join(" ");var n,o}!function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"}(tt||(tt={}));class ft extends Error{}function mt(e,t){return"white"===e?"a"===t?3:5:"a"===t?59:61}class vt{constructor(){}static default(){const e=new vt;return e.unmovedRooks=Ce.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new Ce(14,0),h:new Ce(96,0)},black:{a:new Ce(0,234881024),h:new Ce(0,1610612736)}},e}static empty(){const e=new vt;return e.unmovedRooks=Ce.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:Ce.empty(),h:Ce.empty()},black:{a:Ce.empty(),h:Ce.empty()}},e}clone(){const e=new vt;return e.unmovedRooks=this.unmovedRooks,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,t,n,o){const r=G(e,t),s=mt(e,t);this.unmovedRooks=this.unmovedRooks.with(o),this.rook[e][t]=o,this.path[e][t]=Ke(o,s).with(s).union(Ke(n,r).with(r)).without(n).without(o)}static fromSetup(e){const t=vt.empty(),n=e.unmovedRooks.intersect(e.board.rook);for(const o of N){const r=Ce.backrank(o),s=e.board.kingOf(o);if(!I(s)||!r.has(s))continue;const i=n.intersect(e.board[o]).intersect(r),a=i.first();I(a)&&a<s&&t.add(o,"a",s,a);const c=i.last();I(c)&&s<c&&t.add(o,"h",s,c)}return t}discardRook(e){if(this.unmovedRooks.has(e)){this.unmovedRooks=this.unmovedRooks.without(e);for(const t of N)for(const n of R)this.rook[t][n]===e&&(this.rook[t][n]=void 0)}}discardSide(e){this.unmovedRooks=this.unmovedRooks.diff(Ce.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}class gt extends class{constructor(e){this.rules=e}kingAttackers(e,t,n){return function(e,t,n,o){return n[t].intersect(Le(e,o).intersect(n.rooksAndQueens()).union(Ie(e,o).intersect(n.bishopsAndQueens())).union(Oe(e).intersect(n.knight)).union(qe(e).intersect(n.king)).union(Ae(L(t),e).intersect(n.pawn)))}(e,t,this.board,n)}dropDests(e){return Ce.empty()}playCaptureAt(e,t){this.halfmoves=0,"rook"===t.role&&this.castles.discardRook(e),this.pockets&&this.pockets[L(t.color)][t.role]++}ctx(){const e=this.isVariantEnd(),t=this.board.kingOf(this.turn);if(!I(t))return{king:t,blockers:Ce.empty(),checkers:Ce.empty(),variantEnd:e,mustCapture:!1};const n=Le(t,Ce.empty()).intersect(this.board.rooksAndQueens()).union(Ie(t,Ce.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[L(this.turn)]);let o=Ce.empty();for(const e of n){const n=Ke(t,e).intersect(this.board.occupied);n.moreThanOne()||(o=o.union(n))}return{king:t,blockers:o,checkers:this.kingAttackers(t,L(this.turn),this.board.occupied),variantEnd:e,mustCapture:!1}}clone(){var e,t;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=null===(e=this.pockets)||void 0===e?void 0:e.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}equalsIgnoreMoves(e){var t,n;return this.rules===e.rules&&(this.pockets?this.board.equals(e.board):this.board.equalsIgnorePromoted(e.board))&&(e.pockets&&(null===(t=this.pockets)||void 0===t?void 0:t.equals(e.pockets))||!this.pockets&&!e.pockets)&&this.turn===e.turn&&this.castles.unmovedRooks.equals(e.castles.unmovedRooks)&&this.legalEpSquare()===e.legalEpSquare()&&(e.remainingChecks&&(null===(n=this.remainingChecks)||void 0===n?void 0:n.equals(e.remainingChecks))||!this.remainingChecks&&!e.remainingChecks)}toSetup(){var e,t;return{board:this.board.clone(),pockets:null===(e=this.pockets)||void 0===e?void 0:e.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:this.legalEpSquare(),remainingChecks:null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return N.every((e=>this.hasInsufficientMaterial(e)))}hasDests(e){e=e||this.ctx();for(const t of this.board[this.turn])if(this.dests(t,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,t){if(T(e))return!(!this.pockets||this.pockets[this.turn][e.role]<=0)&&(("pawn"!==e.role||!Ce.backranks().has(e.to))&&this.dropDests(t).has(e.to));{if("pawn"===e.promotion)return!1;if("king"===e.promotion&&"antichess"!==this.rules)return!1;if(!!e.promotion!==(this.board.pawn.has(e.from)&&Ce.backranks().has(e.to)))return!1;const n=this.dests(e.from,t);return n.has(e.to)||n.has(this.normalizeMove(e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return I(e)&&this.kingAttackers(e,L(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return!!(e?e.variantEnd:this.isVariantEnd())||(this.isInsufficientMaterial()||!this.hasDests(e))}isCheckmate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const t=this.variantOutcome(e);return t||(e=e||this.ctx(),this.isCheckmate(e)?{winner:L(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const t=new Map;if(e.variantEnd)return t;for(const n of this.board[this.turn])t.set(n,this.dests(n,e));return t}castlingSide(e){if(T(e))return;const t=e.to-e.from;return(2===Math.abs(t)||this.board[this.turn].has(e.to))&&this.board.king.has(e.from)?t>0?"h":"a":void 0}normalizeMove(e){const t=this.castlingSide(e);if(!t)return e;const n=this.castles.rook[this.turn][t];return{from:e.from,to:I(n)?n:e.to}}play(e){const t=this.turn,n=this.epSquare,o=this.castlingSide(e);if(this.epSquare=void 0,this.halfmoves+=1,"black"===t&&(this.fullmoves+=1),this.turn=L(t),T(e))this.board.set(e.to,{role:e.role,color:t}),this.pockets&&this.pockets[t][e.role]--,"pawn"===e.role&&(this.halfmoves=0);else{const r=this.board.take(e.from);if(!r)return;let s;if("pawn"===r.role){this.halfmoves=0,e.to===n&&(s=this.board.take(e.to+("white"===t?-8:8)));const o=e.from-e.to;16===Math.abs(o)&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(r.role=e.promotion,r.promoted=!0)}else if("rook"===r.role)this.castles.discardRook(e.from);else if("king"===r.role){if(o){const e=this.castles.rook[t][o];if(I(e)){const n=this.board.take(e);this.board.set(G(t,o),r),n&&this.board.set(mt(t,o),n)}}if(this.castles.discardSide(t),o)return}const i=this.board.set(e.to,r)||s;i&&this.playCaptureAt(e.to,i)}}legalEpSquare(e){if(!I(this.epSquare))return;e=e||this.ctx();const t=this.board.pieces(this.turn,"pawn").intersect(Ae(L(this.turn),this.epSquare));for(const n of t)if(this.dests(n,e).has(this.epSquare))return this.epSquare}}{constructor(e){super(e||"chess")}static default(){const e=new this;return e.board=Qe.default(),e.pockets=void 0,e.turn="white",e.castles=vt.default(),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){const t=new this;return t.board=e.board.clone(),t.pockets=void 0,t.turn=e.turn,t.castles=vt.fromSetup(e),t.epSquare=t.validEpSquare(e.epSquare),t.remainingChecks=void 0,t.halfmoves=e.halfmoves,t.fullmoves=e.fullmoves,t.validate().map((e=>t))}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Ue.err(new ft(tt.Empty));if(2!==this.board.king.size())return Ue.err(new ft(tt.Kings));if(!I(this.board.kingOf(this.turn)))return Ue.err(new ft(tt.Kings));const e=this.board.kingOf(L(this.turn));return I(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?Ue.err(new ft(tt.OppositeCheck)):Ce.backranks().intersects(this.board.pawn)?Ue.err(new ft(tt.PawnsOnBackrank)):this.validateCheckers():Ue.err(new ft(tt.Kings))}validateCheckers(){const e=this.board.kingOf(this.turn);if(I(e)){const t=this.kingAttackers(e,L(this.turn),this.board.occupied);if(t.size()>2||2===t.size()&&Fe(t.first(),t.last()).has(e))return Ue.err(new ft(tt.ImpossibleCheck));if(I(this.epSquare))for(const n of t)if(Fe(n,this.epSquare).has(e))return Ue.err(new ft(tt.ImpossibleCheck))}return Ue.ok(void 0)}validEpSquare(e){if(!I(e))return;const t="white"===this.turn?5:2,n="white"===this.turn?8:-8;if(B(e)!==t)return;if(this.board.occupied.has(e+n))return;const o=e-n;return this.board.pawn.has(o)&&this.board[L(this.turn)].has(o)?e:void 0}castlingDest(e,t){if(!I(t.king)||t.checkers.nonEmpty())return Ce.empty();const n=this.castles.rook[this.turn][e];if(!I(n))return Ce.empty();if(this.castles.path[this.turn][e].intersects(this.board.occupied))return Ce.empty();const o=G(this.turn,e),r=Ke(t.king,o),s=this.board.occupied.without(t.king);for(const e of r)if(this.kingAttackers(e,L(this.turn),s).nonEmpty())return Ce.empty();const i=mt(this.turn,e),a=this.board.occupied.toggle(t.king).toggle(n).toggle(i);return this.kingAttackers(o,L(this.turn),a).nonEmpty()?Ce.empty():Ce.fromSquare(n)}canCaptureEp(e,t){if(!I(this.epSquare))return!1;if(!Ae(this.turn,e).has(this.epSquare))return!1;if(!I(t.king))return!0;const n=this.epSquare+("white"===this.turn?-8:8),o=this.board.occupied.toggle(e).toggle(this.epSquare).toggle(n);return!this.kingAttackers(t.king,L(this.turn),o).intersects(o)}pseudoDests(e,t){if(t.variantEnd)return Ce.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return Ce.empty();let o=je(n,e,this.board.occupied);if("pawn"===n.role){let t=this.board[L(this.turn)];I(this.epSquare)&&(t=t.with(this.epSquare)),o=o.intersect(t);const n="white"===this.turn?8:-8,r=e+n;if(0<=r&&r<64&&!this.board.occupied.has(r)){o=o.with(r);const t=r+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(o=o.with(t))}return o}return o=o.diff(this.board[this.turn]),e===t.king?o.union(this.castlingDest("a",t)).union(this.castlingDest("h",t)):o}dests(e,t){if((t=t||this.ctx()).variantEnd)return Ce.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return Ce.empty();let o,r;if("pawn"===n.role){o=Ae(this.turn,e).intersect(this.board[L(this.turn)]);const n="white"===this.turn?8:-8,s=e+n;if(0<=s&&s<64&&!this.board.occupied.has(s)){o=o.with(s);const t=s+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(o=o.with(t))}if(I(this.epSquare)&&this.canCaptureEp(e,t)){const e=this.epSquare-n;(t.checkers.isEmpty()||t.checkers.singleSquare()===e)&&(r=Ce.fromSquare(this.epSquare))}}else o="bishop"===n.role?Ie(e,this.board.occupied):"knight"===n.role?Oe(e):"rook"===n.role?Le(e,this.board.occupied):"queen"===n.role?Be(e,this.board.occupied):qe(e);if(o=o.diff(this.board[this.turn]),I(t.king)){if("king"===n.role){const n=this.board.occupied.without(e);for(const e of o)this.kingAttackers(e,L(this.turn),n).nonEmpty()&&(o=o.without(e));return o.union(this.castlingDest("a",t)).union(this.castlingDest("h",t))}if(t.checkers.nonEmpty()){const e=t.checkers.singleSquare();if(!I(e))return Ce.empty();o=o.intersect(Ke(e,t.king).with(e))}t.blockers.has(e)&&(o=o.intersect(Fe(e,t.king)))}return r&&(o=o.union(r)),o}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){if(this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty())return!1;if(this.board[e].intersects(this.board.knight))return this.board[e].size()<=2&&this.board[L(e)].diff(this.board.king).diff(this.board.queen).isEmpty();if(this.board[e].intersects(this.board.bishop)){return(!this.board.bishop.intersects(Ce.darkSquares())||!this.board.bishop.intersects(Ce.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty()}return!0}}class bt extends gt{constructor(){super("crazyhouse")}static default(){const e=super.default();return e.pockets=Je.empty(),e}static fromSetup(e){return super.fromSetup(e).map((t=>(t.pockets=e.pockets?e.pockets.clone():Je.empty(),t)))}validate(){return super.validate().chain((e=>this.pockets&&(this.pockets.white.king>0||this.pockets.black.king>0)?Ue.err(new ft(tt.Kings)):(this.pockets?this.pockets.count():0)+this.board.occupied.size()>64?Ue.err(new ft(tt.Variant)):Ue.ok(void 0)))}clone(){return super.clone()}hasInsufficientMaterial(e){return this.pockets?this.board.occupied.size()+this.pockets.count()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.white.pawn<=0&&this.pockets.black.pawn<=0&&this.pockets.white.rook<=0&&this.pockets.black.rook<=0&&this.pockets.white.queen<=0&&this.pockets.black.queen<=0:super.hasInsufficientMaterial(e)}dropDests(e){var t,n;const o=this.board.occupied.complement().intersect((null===(t=this.pockets)||void 0===t?void 0:t[this.turn].hasNonPawns())?Ce.full():(null===(n=this.pockets)||void 0===n?void 0:n[this.turn].hasPawns())?Ce.backranks().complement():Ce.empty());if(I((e=e||this.ctx()).king)&&e.checkers.nonEmpty()){const t=e.checkers.singleSquare();return I(t)?o.intersect(Ke(t,e.king)):Ce.empty()}return o}}class kt extends gt{constructor(){super("atomic")}static default(){return super.default()}static fromSetup(e){return super.fromSetup(e)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Ue.err(new ft(tt.Empty));if(this.board.king.size()>2)return Ue.err(new ft(tt.Kings));const e=this.board.kingOf(L(this.turn));return I(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?Ue.err(new ft(tt.OppositeCheck)):Ce.backranks().intersects(this.board.pawn)?Ue.err(new ft(tt.PawnsOnBackrank)):Ue.ok(void 0):Ue.err(new ft(tt.Kings))}kingAttackers(e,t,n){return qe(e).intersects(this.board.pieces(t,"king"))?Ce.empty():super.kingAttackers(e,t,n)}playCaptureAt(e,t){super.playCaptureAt(e,t),this.board.take(e);for(const t of qe(e).intersect(this.board.occupied).diff(this.board.pawn)){const e=this.board.take(t);e&&"rook"===e.role&&this.castles.discardRook(t),e&&"king"===e.role&&this.castles.discardSide(e.color)}}hasInsufficientMaterial(e){if(this.board.pieces(L(e),"king").isEmpty())return!1;if(this.board[e].diff(this.board.king).isEmpty())return!0;if(this.board[L(e)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(Ce.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(Ce.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(Ce.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(Ce.darkSquares())}return!1}return!this.board.queen.nonEmpty()&&!this.board.pawn.nonEmpty()&&(!!this.board.knight.union(this.board.bishop).union(this.board.rook).isSingleSquare()||!!this.board.occupied.equals(this.board.knight.union(this.board.king))&&this.board.knight.size()<=2)}dests(e,t){t=t||this.ctx();let n=Ce.empty();for(const o of this.pseudoDests(e,t)){const t=this.clone();t.play({from:e,to:o});const r=t.board.kingOf(this.turn);!I(r)||I(t.board.kingOf(t.turn))&&!t.kingAttackers(r,t.turn,t.board.occupied).isEmpty()||(n=n.with(o))}return n}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(e){for(const e of N)if(this.board.pieces(e,"king").isEmpty())return{winner:L(e)}}}class wt extends gt{constructor(){super("antichess")}static default(){const e=super.default();return e.castles=vt.empty(),e}static fromSetup(e){return super.fromSetup(e).map((e=>(e.castles=vt.empty(),e)))}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?Ue.err(new ft(tt.Empty)):Ce.backranks().intersects(this.board.pawn)?Ue.err(new ft(tt.PawnsOnBackrank)):Ue.ok(void 0)}kingAttackers(e,t,n){return Ce.empty()}ctx(){const e=super.ctx(),t=this.board[L(this.turn)];for(const n of this.board[this.turn])if(this.pseudoDests(n,e).intersects(t)){e.mustCapture=!0;break}return e}dests(e,t){t=t||this.ctx();const n=this.pseudoDests(e,t);return t.mustCapture?n.intersect(this.board[L(this.turn)]):n}hasInsufficientMaterial(e){if(this.board.occupied.equals(this.board.bishop)){const t=this.board[e].intersects(Ce.lightSquares()),n=this.board[e].intersects(Ce.darkSquares()),o=this.board[L(e)].isDisjoint(Ce.lightSquares()),r=this.board[L(e)].isDisjoint(Ce.darkSquares());return t&&o||n&&r}return!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(e){if((e=e||this.ctx()).variantEnd||this.isStalemate(e))return{winner:this.turn}}}class yt extends gt{constructor(){super("kingofthehill")}static default(){return super.default()}static fromSetup(e){return super.fromSetup(e)}clone(){return super.clone()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.king.intersects(Ce.center())}variantOutcome(e){for(const e of N)if(this.board.pieces(e,"king").intersects(Ce.center()))return{winner:e}}}class zt extends gt{constructor(){super("3check")}static default(){const e=super.default();return e.remainingChecks=Ze.default(),e}static fromSetup(e){return super.fromSetup(e).map((t=>(t.remainingChecks=e.remainingChecks?e.remainingChecks.clone():Ze.default(),t)))}clone(){return super.clone()}hasInsufficientMaterial(e){return this.board.pieces(e,"king").equals(this.board[e])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(e){if(this.remainingChecks)for(const e of N)if(this.remainingChecks[e]<=0)return{winner:e}}}class St extends gt{constructor(){super("racingkings")}static default(){const e=new this;return e.board=Qe.racingKings(),e.pockets=void 0,e.turn="white",e.castles=vt.empty(),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){return super.fromSetup(e).map((e=>(e.castles=vt.empty(),e)))}validate(){return this.isCheck()?Ue.err(new ft(tt.ImpossibleCheck)):this.board.pawn.nonEmpty()?Ue.err(new ft(tt.Variant)):super.validate()}clone(){return super.clone()}dests(e,t){if(e===(t=t||this.ctx()).king)return super.dests(e,t);let n=Ce.empty();for(const o of super.dests(e,t)){const t={from:e,to:o},r=this.clone();r.play(t),r.isCheck()||(n=n.with(o))}return n}hasInsufficientMaterial(e){return!1}isVariantEnd(){const e=Ce.fromRank(7),t=this.board.king.intersect(e);if(t.isEmpty())return!1;if("white"===this.turn||t.intersects(this.board.black))return!0;const n=this.board.kingOf("black");if(I(n)){const t=this.board.occupied.without(n);for(const o of qe(n).intersect(e).diff(this.board.black))if(this.kingAttackers(o,"white",t).isEmpty())return!1}return!0}variantOutcome(e){if(e?!e.variantEnd:!this.isVariantEnd())return;const t=Ce.fromRank(7),n=this.board.pieces("black","king").intersects(t),o=this.board.pieces("white","king").intersects(t);return n&&!o?{winner:"black"}:o&&!n?{winner:"white"}:{winner:void 0}}}class Ct extends gt{constructor(){super("horde")}static default(){const e=new this;return e.board=Qe.horde(),e.pockets=void 0,e.turn="white",e.castles=vt.default(),e.castles.discardSide("white"),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){return super.fromSetup(e)}validate(){if(this.board.occupied.isEmpty())return Ue.err(new ft(tt.Empty));if(!this.board.king.isSingleSquare())return Ue.err(new ft(tt.Kings));if(!this.board.king.diff(this.board.promoted).isSingleSquare())return Ue.err(new ft(tt.Kings));const e=this.board.kingOf(L(this.turn));if(I(e)&&this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty())return Ue.err(new ft(tt.OppositeCheck));for(const e of N)if(this.board.pieces(e,"pawn").intersects(Ce.backrank(L(e))))return Ue.err(new ft(tt.PawnsOnBackrank));return this.validateCheckers()}clone(){return super.clone()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(e){return this.board.white.isEmpty()?{winner:"black"}:this.board.black.isEmpty()?{winner:"white"}:void 0}}let Et=0;const xt=[...Array(8).keys()].map((e=>d(3===e?"tick.zero":"tick",{attrs:{style:`height: ${12.5*(e+1)}%`}})));function Mt(e,t){const n=e.getCeval(),o=e.trans;if(!t.client){const r=n.downloadProgress()/1024/1024;return[t.server&&e.nextNodeBest()?o.noarg("usingServerAnalysis"):o.noarg("loadingEngine")+(r>=1?` (${r.toFixed(1)} MiB)`:"")]}const r=t.client.cloud?[o("depthX",t.client.depth||0),d("span.cloud",{attrs:{title:o.noarg("cloudAnalysis")}},"Cloud")]:[o("depthX",(t.client.depth||0)+"/"+t.client.maxDepth)];return n.canGoDeeper()?r.push(d("a.deeper",{attrs:{title:o.noarg("goDeeper"),"data-icon":"O"},hook:{insert:e=>e.elm.addEventListener("click",(()=>{n.goDeeper(),n.redraw()}))}})):!t.client.cloud&&t.client.knps&&r.push(", "+Math.round(t.client.knps)+" knodes/s"),r}function _t(e,t){if(!t)return e.trans.noarg("loadingEngine");let n=e.trans("depthX",(t.depth||0)+"/"+t.maxDepth);return t.knps&&(n+=", "+Math.round(t.knps)+" knodes/s"),n}function Pt(e){return e.disableThreatMode&&e.disableThreatMode()?null:d("a.show-threat",{class:{active:e.threatMode(),hidden:!!e.getNode().check},attrs:{"data-icon":"7",title:e.trans.noarg("showThreat")+" (x)"},hook:{insert:t=>t.elm.addEventListener("click",e.toggleThreatMode)}})}function qt(e){return[d("span",{attrs:{title:e.engineName()||""}},"nnue"==e.technology?"Stockfish 13+":"hce"==e.technology?"Stockfish 11+":"Stockfish 10+"),"nnue"==e.technology?d("span.technology.good",{attrs:{title:"Multi-threaded WebAssembly with SIMD (efficiently updatable neural network, strongest)"}},"NNUE"):"hce"==e.technology?d("span.technology.good",{attrs:{title:"Multi-threaded WebAssembly (classical hand crafted evaluation)"}},"HCE"):"wasm"==e.technology?d("span.technology",{attrs:{title:"Single-threaded WebAssembly fallback (slow)"}},"WASM"):d("span.technology",{attrs:{title:"Single-threaded JavaScript fallback (very slow)"}},"ASMJS")]}function Ot(e){const t=e.server,n=e.client;return t?n&&(n.nodes>4e6||void 0!==n.mate&&(void 0===t.mate||Math.abs(n.mate)<Math.abs(t.mate)))?n:t:n}function At(e){if(e.ongoing||!e.showEvalGauge())return;const t=Ot(e.currentEvals());let n;return t?(n=ce("white",t),Et=n):n=Et,d("div.eval-gauge",{class:{empty:null===n,reverse:"black"===e.getOrientation()}},[d("div.black",{attrs:{style:`height: ${100-50*(n+1)}%`}}),...xt])}function Nt(e){const t=e.getCeval(),n=e.trans;if(!t.allowed()||!t.possible||!e.showComputer())return;const o=t.enabled(),r=e.currentEvals(),s=e.threatMode(),i=s&&e.getNode().threat,a=i||Ot(r);let c,l;a&&void 0!==a.cp?(c=ue(a.cp),l=r.client?Math.min(100,Math.round(100*r.client.depth/(r.client.maxDepth||t.effectiveMaxDepth()))):0):a&&b(a.mate)?(c="#"+a.mate,l=100):e.outcome()?(c="-",l=0):(c=d(o?"i.ddloader":"i"),l=0),s&&(l=i?Math.min(100,Math.round(100*i.depth/i.maxDepth)):0);const u=o?d("div.bar",d("span",{class:{threat:s},attrs:{style:`width: ${l}%`},hook:{postpatch:(e,t)=>{if(e.data.percent>l||!!e.data.threatMode!=s){const e=t.elm,n=e.parentNode;n.removeChild(e),n.appendChild(e)}t.data.percent=l,t.data.threatMode=s}}})):null,h=o?[d("pearl",[c]),d("div.engine",[...s?[n.noarg("showThreat")]:qt(t),d("span.info",e.outcome()?[n.noarg("gameOver")]:s?[_t(e,i)]:Mt(e,r))])]:[c?d("pearl",[c]):null,d("help",[...qt(t),d("br"),n.noarg("inLocalBrowser")])],p=e.mandatoryCeval&&e.mandatoryCeval()?null:d("div.switch",{attrs:{title:n.noarg("toggleLocalEvaluation")+" (l)"}},[d("input#analyse-toggle-ceval.cmn-toggle.cmn-toggle--subtle",{attrs:{type:"checkbox",checked:o},hook:{insert:t=>t.elm.addEventListener("change",e.toggleCeval)}}),d("label",{attrs:{for:"analyse-toggle-ceval"}})]);return d("div.ceval"+(o?".enabled":""),{class:{computing:l<100&&t.isComputing()}},[u,...h,Pt(e),p])}function Dt(e){return e.getAttribute("data-fen")}function Rt(e){return $(e.target).closest("div.pv").attr("data-uci")||void 0}function Tt(e,t){lichess.requestIdleCallback((()=>t.setHovering(Dt(e),$(e).find("div.pv:hover").attr("data-uci")||void 0)),500)}function $t(e){const t=e.getCeval();if(!t.allowed()||!t.possible||!t.enabled())return;const n=parseInt(t.multiPv()),o=e.getNode(),r=ct(o.fen).unwrap();let s,i,a,c=!1;e.threatMode()&&o.threat?(s=o.threat.pvs,c=!0):s=o.ceval?o.ceval.pvs:[],c&&(r.turn=L(r.turn),"white"==r.turn&&(r.fullmoves+=1));const l=function(e,t){switch(e){case"chess":return gt.fromSetup(t);case"antichess":return wt.fromSetup(t);case"atomic":return kt.fromSetup(t);case"horde":return Ct.fromSetup(t);case"racingkings":return St.fromSetup(t);case"kingofthehill":return yt.fromSetup(t);case"3check":return zt.fromSetup(t);case"crazyhouse":return bt.fromSetup(t)}}(Q(t.variant.key),r);return d("div.pv_box",{attrs:{"data-fen":o.fen},hook:{insert:n=>{const o=n.elm;o.addEventListener("mouseover",(t=>{const n=e.getCeval();n.setHovering(Dt(o),Rt(t));const r=t.target.dataset.board;if(r){a=Number(t.target.dataset.moveIndex),i=function(e){const t=[];return $(e.target).closest("div.pv").children().filter("span.pv-san").each((function(){t.push($(this).attr("data-board"))})),t}(t);const[e,o]=r.split("|");n.setPvBoard({fen:e,uci:o})}})),o.addEventListener("wheel",(t=>{if(t.preventDefault(),null!=a&&null!=i){t.deltaY<0&&a>0?a-=1:t.deltaY>0&&a<i.length-1&&(a+=1);const n=i[a];if(n){const[t,o]=n.split("|");e.getCeval().setPvBoard({fen:t,uci:o})}}})),o.addEventListener("mouseout",(()=>e.getCeval().setHovering(Dt(o))));for(const t of["touchstart","mousedown"])o.addEventListener(t,(t=>{const n=Rt(t);n&&(e.playUci(n),t.preventDefault())}));o.addEventListener("mouseleave",(()=>{e.getCeval().setPvBoard(null),a=null})),Tt(o,t)},postpatch:(e,n)=>Tt(n.elm,t)}},[...[...Array(n).keys()].map((e=>function(e,t,n,o){const r={},s=[It()];n&&(e||(r.attrs={"data-uci":n.moves[0]}),t>1&&s.push(d("strong",b(n.mate)?"#"+n.mate:ue(n.cp))),o&&s.push(...function(e,t){const n=[];let o=ut(e.board);for(let r=0;r<t.length;r++){let s;"white"===e.turn?s=`${e.fullmoves}.`:0===r&&(s=`${e.fullmoves}...`),s&&n.push(d("span",{key:s},s));const i=t[r],a=We(e,U(i)),c=ut(e.board);if("--"===a)break;o+="|"+i,n.push(d("span.pv-san",{key:o,attrs:{"data-move-index":r,"data-board":`${c}|${i}`}},a))}return n}(o.clone(),n.moves.slice(0,16))));return d("div.pv.pv--nowrap",r,s)}(c,n,s[e],l.isOk?l.value:void 0))),Lt(e)])}function It(){return d("span.pv-wrap-toggle",{hook:{insert:e=>{const t=e.elm;for(const e of["touchstart","mousedown"])t.addEventListener(e,(e=>{e.stopPropagation(),e.preventDefault(),$(t).closest(".pv").toggleClass("pv--nowrap")}))}}})}function Lt(e){const t=e.getCeval().pvBoard();if(!t)return;const{fen:n,uci:o}=t,r={fen:n,lastMove:"@"===o[1]?[o.slice(2)]:[o.slice(0,2),o.slice(2,4)],orientation:e.getOrientation(),coordinates:!1,viewOnly:!0,resizable:!1,drawable:{enabled:!1,visible:!1}},s=d("div.cg-wrap.is2d",{hook:{insert:e=>e.elm._cg=window.Chessground(e.elm,r),update:e=>e.elm._cg.set(r),destroy:e=>e.elm._cg.destroy()}});return d("div.pv-board",d("div.pv-board-square",s))}lichess.storage.make("ceval.disable").listen((()=>{const e=document.getElementById("analyse-toggle-ceval");(null==e?void 0:e.checked)&&e.click()}));const Bt=["white","black"],jt=["a","b","c","d","e","f","g","h"],Ft=["1","2","3","4","5","6","7","8"],Kt=[...Ft].reverse(),Wt=Array.prototype.concat(...jt.map((e=>Ft.map((t=>e+t))))),Vt=e=>Wt[8*e[0]+e[1]],Ut=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],Ht=Wt.map(Ut);const Gt=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},Xt=e=>"white"===e?"black":"white",Qt=(e,t)=>{const n=e[0]-t[0],o=e[1]-t[1];return n*n+o*o},Yt=(e,t)=>e.role===t.role&&e.color===t.color,Jt=(e,t,n,o)=>[(t?e[0]:7-e[0])*n,(t?7-e[1]:e[1])*o],Zt=e=>{const t=e.width/8,n=e.height/8;return(e,o)=>Jt(e,o,t,n)},en=(e,t)=>Jt(e,t,100,100),tn=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},nn=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},on=(e,t)=>{e.style.visibility=t?"visible":"hidden"},rn=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},sn=e=>2===e.buttons||2===e.button,an=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function cn(e,t,n){const o=Ut(e);return t||(o[0]=7-o[0],o[1]=7-o[1]),[n.left+n.width*o[0]/8+n.width/16,n.top+n.height*(7-o[1])/8+n.height/16]}function ln(e,t,n){return[{orig:e.slice(0,2),dest:e.slice(2,4),brush:t,modifiers:n}]}function un(e){return e.length/2}function dn(e){return e.slice(0,2)}function hn(e){return e.slice(2)}function pn(e){return e.slice(0,-2)}function fn(e,t){return e.startsWith(t)}function mn(e){let t="";for(const n in e)t+=e[n].id;return t}function vn(e,t){const n=e.children[0];return n?t(n):void 0}function gn(e,t){const n=[e];let o,r=e;for(;o=t(r);)n.push(o),r=o;return n}function bn(e){return e.children[0]}function kn(e,t){return e.children.find((e=>e.id===t))}function wn(e,t){e.children=e.children.filter((function(e){return e.id!==t}))}function yn(e,t){e.eval=t.eval,t.glyphs&&(e.glyphs=t.glyphs),t.comments&&t.comments.forEach((function(t){e.comments?e.comments.some((function(e){return e.text===t.text}))||e.comments.push(t):e.comments=[t]})),t.children.forEach((function(t){const n=kn(e,t.id);n?yn(n,t):e.children.push(t)}))}function zn(e){return gn(e,bn)}function Sn(e){function t(){return function(e,t){const n=function(e){return t(e)?e:vn(e,n)};return n(e)}(e,(e=>!e.children.length))}function n(t){return o(e,t)}function o(e,t){if(""===t)return e;const n=kn(e,dn(t));return n?o(n,hn(t)):e}function r(t){return s(e,t)}function s(e,t){if(""===t)return e;const n=kn(e,dn(t));return n?s(n,hn(t)):void 0}function i(e,t){const n=dn(t),o=kn(e,n);return o?n+i(o,hn(t)):""}function a(e,t){if(""===t)return!0;const n=dn(t),o=e.children[0];return!(!o||o.id!==n)&&a(o,hn(t))}function c(e,t){if(""===t)return e;const n=dn(t),o=e.children[0];return o&&o.id===n?c(o,hn(t)):e}function l(t){return gn(e,(function(e){const n=dn(t);if(""!==n)return t=hn(t),kn(e,n)}))}function u(e,t){const n=r(e);if(n)return t(n),n}function d(e,t){const n=t+e.id,o=r(n);return o?(["dests","drops","clock"].forEach((t=>{b(e[t])&&!b(o[t])&&(o[t]=e[t])})),n):u(t,(function(t){t.children.push(e)}))?n:void 0}function h(e,t){return u(t,(function(t){const n=(t.comments||[]).filter((function(t){return t.id!==e}));t.comments=n.length?n:void 0}))}function p(e){return n(pn(e))}return{root:e,lastPly(){var n;return(null===(n=t())||void 0===n?void 0:n.ply)||e.ply},nodeAtPath:n,getNodeList:l,longestValidPath:t=>i(e,t),updateAt:u,addNode:d,addNodes:function e(t,n){const o=t[0];if(!o)return n;const r=d(o,n);return r?e(t.slice(1),r):void 0},addDests:(e,t)=>u(t,(function(t){t.dests=e})),setShapes:(e,t)=>u(t,(function(t){t.shapes=e})),setCommentAt:function(e,t){return e.text?u(t,(function(t){t.comments=t.comments||[];const n=t.comments.find((function(t){return t.id===e.id}));n?n.text=e.text:t.comments.push(e)})):h(e.id,t)},deleteCommentAt:h,setGlyphsAt:function(e,t){return u(t,(function(t){t.glyphs=e}))},setClockAt:(e,t)=>u(t,(function(t){t.clock=e})),pathIsMainline:function(t){return a(e,t)},pathIsForcedVariation:function(e){return!!l(e).find((e=>e.forceVariation))},lastMainlineNode:t=>c(e,t),pathExists:function(e){return!!r(e)},deleteNodeAt:function(e){wn(p(e),function(e){return e.slice(-2)}(e))},promoteAt:function(e,t){const n=l(e);for(let e=n.length-2;e>=0;e--){const o=n[e+1],r=n[e];if(r.children[0].id!==o.id){if(wn(r,o.id),r.children.unshift(o),!t)break}else if(o.forceVariation&&(o.forceVariation=!1,!t))break}},forceVariationAt:(e,t)=>u(e,(function(e){e.forceVariation=t})),getCurrentNodesAfterPly:function(e,t,n){const o=[];for(const r in e){const s=e[r];if(s.ply<=n&&t[r].id!==s.id)break;s.ply>n&&o.push(s)}return o},merge(t){yn(e,t)},removeCeval(){!function(e,t){!function e(n){t(n),n.children.forEach(e)}(e)}(e,(function(e){delete e.ceval,delete e.threat}))},removeComputerVariations(){zn(e).forEach((function(e){e.children=e.children.filter((function(e){return!e.comp}))}))},parentNode:p,getParentClock:function(e,t){if(!("parentClock"in e)){const n=t&&p(t);e.parentClock=n?"clock"in n?n.clock:void 0:e.clock}return e.parentClock}}}function Cn(e){const t=e.vm.node.children[0];t&&e.userJump(e.vm.path+t.id)}function En(e){e.userJump(pn(e.vm.path))}function xn(e){const t=!fn(e.vm.path,e.vm.initialPath);e.userJump(t?e.vm.initialPath:mn(e.vm.mainline))}function Mn(e){const t=e.vm.path!==e.vm.initialPath&&fn(e.vm.path,e.vm.initialPath);e.userJump(t?e.vm.initialPath:"")}function _n(e,t,n){return Pn((o=>o.addEventListener(e,(e=>{const o=t(e);return n&&n(),o}))))}function Pn(e){return{insert:t=>e(t.elm)}}const qn=e=>({"data-icon":e});function On(e,t,n){let o=!1;function r(e){o&&(!function(e,t,n){const o=e.state.pieces.get(t);o&&"pawn"==o.role&&e.setPieces(new Map([[t,{color:o.color,role:n,promoted:!0}]]))}(t(),o.dest,e),o.callback(o.orig,o.dest,e)),o=!1}function s(){o&&(o=!1,t().set(e.cgConfig),n())}return{start:function(e,r,s){const i=t(),a=i.state.pieces.get(r);return!(!a||"pawn"!=a.role||!("8"==r[1]&&"black"==i.state.turnColor||"1"==r[1]&&"white"==i.state.turnColor))&&(o={orig:e,dest:r,callback:s},n(),!0)},cancel:s,view(){if(!o)return;return function(e,t,n,i){if(!o)return;let a=12.5*(7-Ut(e)[0]);return"white"===i&&(a=87.5-a),d("div#promotion-choice."+(n===i?"top":"bottom"),{hook:Pn((e=>{e.addEventListener("click",s),e.oncontextmenu=()=>!1}))},t.map((function(e,t){return d("square",{attrs:{style:"top: "+12.5*(n===i?t:7-t)+"%;left: "+a+"%"},hook:_n("click",(t=>{t.stopPropagation(),r(e)}))},[d("piece."+e+"."+n)])})))}(o.dest,["queen","knight","rook","bishop"],Xt(t().state.turnColor),t().state.orientation)}}}const An={e1a1:"e1c1",e1h1:"e1g1",e8a8:"e8c8",e8h8:"e8g8"};class Nn{constructor(e,t,n){this.theme=e,this.userId=t,this.streak=n,this.maxSize=100,this.maxAge=36e5,this.default=()=>({theme:this.theme,rounds:[],at:Date.now()}),this.store=this.streak?k(this.default()):se(`puzzle.session.${this.userId||"anon"}`,this.default),this.clear=()=>this.update((e=>Object.assign(Object.assign({},e),{rounds:[]}))),this.get=()=>{const e=this.store();return e.theme==this.theme&&e.at>Date.now()-this.maxAge?e:this.default()},this.update=e=>this.store(e(this.get())),this.complete=(e,t)=>this.update((n=>{const o=n.rounds.findIndex((t=>t.id==e));return-1==o?(n.rounds.push({id:e,result:t}),n.rounds.length>this.maxSize&&n.rounds.shift()):n.rounds[o].result=t,n.at=Date.now(),n})),this.setRatingDiff=(e,t)=>this.update((n=>(n.rounds.forEach((n=>{n.id==e&&(n.ratingDiff=t)})),n))),this.isNew=()=>this.store().rounds.length<2}}class Dn{constructor(e){var t;this.fail=!1,this.onComplete=(e,t)=>{e?this.nextId()?(this.data.index++,t&&(this.data.current={puzzle:t.puzzle,game:t.game}),this.store(this.data)):(this.store(null),lichess.reload()):(this.fail=!0,this.store(null))},this.nextId=()=>this.data.ids[this.data.index+1],this.skip=()=>{this.data.skip=!1,this.store(this.data)},this.store=se(`puzzle.streak.${(null===(t=e.user)||void 0===t?void 0:t.id)||"anon"}`,(()=>null)),this.data=this.store()||{ids:e.streak.split(" "),index:0,skip:!0,current:{puzzle:e.puzzle,game:e.game}}}}function Rn(e){const t=gt.default(),n={ply:0,id:"",fen:"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",children:[]};let o=n;return e.forEach(((e,n)=>{const r=function(e,t){const n=e.ctx();let o;if("O-O"===t||"O-O+"===t||"O-O#"===t?o="h":"O-O-O"!==t&&"O-O-O+"!==t&&"O-O-O#"!==t||(o="a"),o){const t=e.castles.rook[e.turn][o];if(!I(n.king)||!I(t)||!e.dests(n.king,n).has(t))return;return{from:n.king,to:t}}const r=t.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!r){const o=t.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!o)return;const r={role:K(o[1])||"pawn",to:W(o[2])};return e.isLegal(r,n)?r:void 0}const s=K(r[1])||"pawn",i=W(r[4]),a=K(r[5]);if(!!a!==("pawn"===s&&Ce.backranks().has(i)))return;if("king"===a&&"antichess"!==e.rules)return;let c=e.board.pieces(e.turn,s);r[2]&&(c=c.intersect(Ce.fromFile(r[2].charCodeAt(0)-"a".charCodeAt(0)))),r[3]&&(c=c.intersect(Ce.fromRank(r[3].charCodeAt(0)-"1".charCodeAt(0))));const l="pawn"===s?Ce.fromFile(j(i)):Ce.empty();let u;c=c.intersect(l.union(je({color:L(e.turn),role:s},i,e.board.occupied)));for(const t of c)if(e.dests(t,n).has(i)){if(I(u))return;u=t}return I(u)?{from:u,to:i,promotion:a}:void 0}(t,e);t.play(r);const s=$n(t,r,n+1,e);o.children.push(s),o=s})),n}function Tn(e,t,n,o){const r=e.nodeAtPath(t),s=gt.fromSetup(ct(r.fen).unwrap()).unwrap(),i=r.ply,a=n.map(((e,t)=>{const n=U(e),r=function(e,t){return We(e.clone(),t)}(s,n);s.play(n);const a=$n(s,n,i+t+1,r);return"white"==o==(a.ply%2==1)&&(a.puzzle="good"),a}));e.addNodes(a,t)}const $n=(e,t,n,o)=>({ply:n,san:o,fen:pt(e.toSetup()),id:X(t),uci:H(t),check:e.isCheck()?V(e.toSetup().board.kingOf(e.turn)):void 0,children:[]});function In(e,t){var n;const o={next:Y()};let r,s,i;const a=!!e.data.streak,c=re("puzzle.autoNext"+(a?".streak":""),a),l=k(void 0),u=k(!1),d=e.data.streak?new Dn(e.data):void 0,h=lichess.storage.make("puzzle.streak.fail");d&&(e.data=Object.assign(Object.assign({},e.data),d.data.current),h.listen((e=>B(d))));const p=new Nn(e.data.theme.key,null===(n=e.data.user)||void 0===n?void 0:n.id,a);o.showComputer=()=>"view"===o.mode,o.showAutoShapes=()=>!0;const f=e=>M(100,(()=>lichess.sound.play(e))),m=(e,t,n)=>(setTimeout((()=>lichess.sound.loadOggOrMp3(e,`${lichess.sound.baseUrl}/${e}`)),n||1e3),()=>lichess.sound.play(e,t)),w={move:f("move"),capture:f("capture"),check:f("check"),good:m("lisp/PuzzleStormGood",.7,500),end:m("lisp/PuzzleStormEnd",1,1e3)};let y=!1;function z(e){var t;o.path=e,o.nodeList=s.getNodeList(e),o.node=(t=o.nodeList)[t.length-1],o.mainline=zn(s.root)}function C(e){const t=l();return t&&e(t)}function E(e){r=e,s=Sn(Rn(r.game.pgn.split(" ")));const n=mn(zn(s.root));o.mode="play",o.next=Y(),o.round=void 0,o.justPlayed=void 0,o.resultSent=!1,o.lastFeedback="init",o.initialPath=n,o.initialNode=s.nodeAtPath(n),o.pov=o.initialNode.ply%2==1?"black":"white",z(pn(n)),setTimeout((()=>{se(n),t()}),500),o.canViewSolution=!1,setTimeout((()=>{o.canViewSolution=!0,t()}),4e3),C((e=>{e.setAutoShapes([]),e.setShapes([]),A(e)})),function(){i&&i.destroy();i=we({redraw:t,storageKeyPrefix:"puzzle",multiPvDefault:3,variant:{short:"Std",name:"Standard",key:"standard"},standardMaterial:!0,possible:!0,emit:function(e,n){s.updateAt(n.path,(function(r){n.threatMode?(!r.threat||r.threat.depth<=e.depth||r.threat.maxDepth<e.maxDepth)&&(r.threat=e):(!r.ceval||r.ceval.depth<=e.depth||r.ceval.maxDepth<e.maxDepth)&&(r.ceval=e),n.path===o.path&&(G(),t())}))},setAutoShapes:G})}()}function q(){const e=ct(o.node.fen).unwrap();return gt.fromSetup(e).unwrap()}function O(){const e=o.node,t=e.ply%2==0?"white":"black",n=function(e,t){const n=new Map,o=e.ctx();for(const[r,s]of e.allDests(o))if(s.nonEmpty()){const e=Array.from(s,V);(null==t?void 0:t.chess960)||r!==o.king||4!==j(r)||(s.has(0)?e.push("c1"):s.has(56)&&e.push("c8"),s.has(7)?e.push("g1"):s.has(63)&&e.push("g8")),n.set(V(r),e)}return n}(q()),r=o.node.children[0],s="view"===o.mode||t===o.pov&&(!r||"fail"==r.puzzle)?{color:n.size>0?t:void 0,dests:n}:{color:void 0,dests:new Map},i={fen:e.fen,orientation:y?L(o.pov):o.pov,turnColor:t,movable:s,premovable:{enabled:!1},check:!!e.check,lastMove:(a=e.uci,b(a)?[a.substr(0,2),a.substr(2,2)]:void 0)};var a;return e.ply>=o.initialNode.ply&&("view"===o.mode||t===o.pov||r||(i.movable.color=o.pov,i.premovable.enabled=!0)),o.cgConfig=i,i}function A(e){e.set(O())}function N(e){R(U(e))}function D(e,t,n){R({from:W(e),to:W(t),promotion:n})}function R(e){T(o.path,q(),e)}function T(n,i,a){a=i.normalizeMove(a);const l=We(i,a),u=i.isCheck()?i.board.kingOf(i.turn):void 0;!function(n,i){se(s.addNode(n,i)),C((e=>e.playPremove()));const a=function(e,t){if("view"===e.mode)return;if(!fn(e.path,e.initialPath))return;if((e.node.ply%2==1?"white":"black")!==e.pov)return;const n=e.nodeList.slice(un(e.initialPath)+1).map((e=>({uci:e.uci,castle:e.san.startsWith("O-O"),checkmate:e.san.endsWith("#")})));for(const r in n){if(n[r].checkmate)return e.node.puzzle="win";const s=n[r].uci,i=t.solution[r];if(!(s==i||n[r].castle&&(o=s,o in An)&&An[s]==i))return e.node.puzzle="fail"}var o;const r=t.solution[n.length];return r?(e.node.puzzle="good",{move:U(r),fen:e.node.fen,path:e.path}):e.node.puzzle="win"}(o,r.puzzle);a&&function(n){if("fail"===n)o.lastFeedback="fail",setTimeout((()=>{C((e=>e.cancelPremove())),ie(pn(o.path)),t()}),100),"play"===o.mode&&(d?(B(d),h.fire()):(o.canViewSolution=!0,o.mode="try",F(!1)));else if("win"==n){if(d&&w.good(),o.lastFeedback="win","view"!=o.mode){const e="play"==o.mode?F(!0):Promise.resolve();o.mode="view",C(A),e.then((e=>c()?K():Q()))}}else n&&(o.lastFeedback="good",setTimeout((()=>{const e=gt.fromSetup(ct(n.fen).unwrap()).unwrap();T(n.path,e,n.move)}),e.pref.animation.duration*(c()?1:1.5)))}(a);I(i),t(),g(n,!1)}({ply:2*(i.fullmoves-1)+("white"==i.turn?0:1),fen:pt(i.toSetup()),id:X(a),uci:H(a),san:l,check:b(u)?V(u):void 0,children:[]},n)}function I(e,t){const n=s.nodeAtPath(e);n.children.sort(((e,t)=>{const n=e.puzzle;return"fail"==n?1:"good"==n||"win"==n?-1:0})),t&&n.children.forEach((t=>I(e+t.id,!0)))}function B(e){o.mode="view",e.onComplete(!1),setTimeout(ae,500),w.end()}function F(e){return o.resultSent?Promise.resolve():(o.resultSent=!0,p.complete(r.puzzle.id,e),function(e,t,n,o,r){return S(`/training/complete/${t}/${e}`,{method:"POST",body:x(Object.assign(Object.assign({win:n},o?{replayDays:o.days}:{}),r?{streakId:r.nextId(),streakScore:r.data.index}:{}))})}(r.puzzle.id,r.theme.key,e,r.replay,d).then((n=>{var s;if((null==n?void 0:n.replayComplete)&&r.replay)return lichess.redirect(`/training/dashboard/${r.replay.days}`);(null==n?void 0:n.next.user)&&r.user&&(r.user.rating=n.next.user.rating,r.user.provisional=n.next.user.provisional,o.round=n.round,(null===(s=n.round)||void 0===s?void 0:s.ratingDiff)&&p.setRatingDiff(r.puzzle.id,n.round.ratingDiff)),e&&lichess.sound.say("Success!"),o.next.resolve(n.next),d&&e&&d.onComplete(!0,n.next),t()})))}function K(){if(i.stop(),o.next.promise.then(E).then(t),!d&&!r.replay){const e=`/training/${r.theme.key}`;location.pathname!=e&&history.replaceState(null,"",e)}}function G(){C((e=>{e.setAutoShapes(function(e){const t=e.vm.node,n=e.ceval.hovering(),o=e.ground.state.movable.color;let r=[];if(n&&n.fen===t.fen&&(r=r.concat(ln(n.uci,"paleBlue"))),e.vm.showAutoShapes()&&e.vm.showComputer()&&(t.eval&&(r=r.concat(ln(t.eval.best,"paleGreen"))),!n)){let n=e.nextNodeBest;!n&&e.ceval.enabled()&&t.ceval&&(n=t.ceval.pvs[0].moves[0]),n&&(r=r.concat(ln(n,"paleBlue"))),e.ceval.enabled()&&t.ceval&&t.ceval.pvs&&t.ceval.pvs[1]&&!(e.threatMode&&t.threat&&t.threat.pvs[2])&&t.ceval.pvs.forEach((function(e){if(e.moves[0]===n)return;const s=le(o,t.ceval.pvs[0],e);s>.2||isNaN(s)||s<0||(r=r.concat(ln(e.moves[0],"paleGrey",{lineWidth:Math.round(12-50*s)})))}))}return e.ceval.enabled()&&e.threatMode&&t.threat&&(t.threat.pvs[1]?(r=r.concat(ln(t.threat.pvs[0].moves[0],"paleRed")),t.threat.pvs.slice(1).forEach((function(e){const n=le(Xt(o),e,t.threat.pvs[0]);n>.2||isNaN(n)||n<0||(r=r.concat(ln(e.moves[0],"paleRed",{lineWidth:Math.round(11-45*n)})))}))):r=r.concat(ln(t.threat.pvs[0].moves[0],"red"))),r}({vm:o,ceval:i,ground:e,threatMode:u(),nextNodeBest:Z()}))}))}function Q(){i.enabled()&&"view"===o.mode&&!oe()&&J()}const J=M(800,(function(){i.start(o.path,o.nodeList,u())})),Z=()=>vn(o.node,(e=>{var t;return null===(t=e.eval)||void 0===t?void 0:t.best})),ee=()=>i;function te(){i.toggle(),G(),Q(),i.enabled()||u(!1),o.autoScrollRequested=!0,t()}function ne(){o.node.check||(i.enabled()||i.toggle(),i.enabled()&&(u(!u()),G(),Q(),t()))}function oe(){return q().outcome()}function se(e){const t=e!==o.path,n=t&&e.length===o.path.length+2;z(e),C(A),t&&(n&&(o.node.uci?o.justPlayed&&!o.node.uci.includes(o.justPlayed)||(o.node.san.includes("x")?w.capture():w.move()):w.move(),/\+|#/.test(o.node.san)&&w.check()),u(!1),i.stop(),Q()),ue.cancel(),o.justPlayed=void 0,o.autoScrollRequested=!0,lichess.pubsub.emit("ply",o.node.ply)}function ie(e){var t;"fail"==(null===(t=s.nodeAtPath(e))||void 0===t?void 0:t.puzzle)&&"view"!=o.mode||(C((e=>e.selectSquare(null))),se(e),g(o.node,!0))}function ae(){F(!1),o.mode="view",Tn(s,o.initialPath,r.puzzle.solution,o.pov),I(o.initialPath,!0);const e=o.node.children[0];if(e&&"good"===e.puzzle)ie(o.path+e.id);else{const e=function(e,t){let n="";for(const o in e){if(!t(e[o]))break;n+=e[o].id}return n}(o.mainline,(e=>"good"!=e.puzzle));e&&ie(e+s.nodeAtPath(e).children[0].id)}o.autoScrollRequested=!0,o.voteDisabled=!0,t(),Q(),setTimeout((()=>{o.voteDisabled=!1,t()}),500)}const ce=()=>{y=!y,C((e=>e.toggleOrientation())),t()};E(e.data);const ue=On(o,l,t);function de(){const e=Z()||o.node.ceval&&o.node.ceval.pvs[0].moves[0];e&&N(e)}var he;return he={vm:o,userJump:ie,getCeval:ee,toggleCeval:te,toggleThreatMode:ne,redraw:t,playBestMove:de,flip:ce,flipped:()=>y},window.Mousetrap.bind(["left","k"],(()=>{En(he),he.redraw()})).bind(["right","j"],(()=>{Cn(he),he.redraw()})).bind(["up","0"],(()=>{Mn(he),he.redraw()})).bind(["down","$"],(()=>{xn(he),he.redraw()})).bind("l",he.toggleCeval).bind("x",he.toggleThreatMode).bind("space",(()=>{"view"===he.vm.mode&&(he.getCeval().enabled()?he.playBestMove():he.toggleCeval())})).bind("z",(()=>lichess.pubsub.emit("zen"))).bind("f",he.flip),document.addEventListener("visibilitychange",(()=>lichess.requestIdleCallback((()=>se(o.path)),500))),lichess.pubsub.on("speech.enabled",v),v(lichess.sound.speech()),lichess.pubsub.on("zen",(()=>{const e=!$("body").hasClass("zen");$("body").toggleClass("zen",e),window.dispatchEvent(new Event("resize")),P(e)})),$("body").addClass("playing"),$("#zentog").on("click",(()=>lichess.pubsub.emit("zen"))),{vm:o,getData:()=>r,getTree:()=>s,ground:l,makeCgOpts:O,userJump:ie,viewSolution:ae,nextPuzzle:K,vote:e=>{o.voteDisabled||(!function(e,t){S(`/training/${e}/vote`,{method:"POST",body:x({vote:t})})}(r.puzzle.id,e),K())},voteTheme:(e,n)=>{o.round&&(o.round.themes=o.round.themes||{},n===o.round.themes[e]?(delete o.round.themes[e],_(r.puzzle.id,e,void 0)):(n||r.puzzle.themes.includes(e)?o.round.themes[e]=n:delete o.round.themes[e],_(r.puzzle.id,e,n)),t())},getCeval:ee,pref:e.pref,difficulty:e.difficulty,trans:lichess.trans(e.i18n),autoNext:c,autoNexting:()=>"win"==o.lastFeedback&&c(),outcome:oe,toggleCeval:te,toggleThreatMode:ne,threatMode:u,currentEvals:()=>({client:o.node.ceval}),nextNodeBest:Z,userMove:function(e,t){o.justPlayed=e,ue.start(e,t,D)||D(e,t)},playUci:N,showEvalGauge:()=>o.showComputer()&&i.enabled(),getOrientation:()=>C((e=>e.state.orientation)),getNode:()=>o.node,showComputer:o.showComputer,promotion:ue,redraw:t,ongoing:!1,playBestMove:de,session:p,allThemes:e.themes&&{dynamic:e.themes.dynamic.split(" "),static:new Set(e.themes.static.split(" "))},streak:d,skip:()=>{if(!d||!d.data.skip||"play"!=o.mode)return;d.skip(),ie(mn(o.mainline));const e=un(o.path)-un(o.initialPath);N(r.puzzle.solution[e]),de()},flip:ce,flipped:()=>y}}let Ln=!1;const Bn=e=>(!1===Ln&&(Ln=window.Intl&&Intl.NumberFormat?new Intl.NumberFormat:null),null===Ln?""+e:Ln.format(e));function jn(e){const t=e.getData();return d("div.puzzle__side__metas",[Fn(e,t.puzzle),Kn(e,t.game,t.puzzle)])}function Fn(e,t){return d("div.infos.puzzle",{attrs:qn("-")},[d("div",[e.streak?null:d("p",e.trans.vdom("puzzleId",d("a",{attrs:Object.assign({href:`/training/${t.id}`},e.streak?{target:"_blank"}:{})},"#"+t.id))),d("p",e.trans.vdom("ratingX",e.streak||"play"!==e.vm.mode?d("strong",t.rating):d("span.hidden",e.trans.noarg("hidden")))),d("p",e.trans.vdom("playedXTimes",d("strong",Bn(t.plays))))])])}function Kn(e,t,n){const o=`${t.clock}  ${t.perf.name}`;return d("div.infos",{attrs:qn(t.perf.icon)},[d("div",[d("p",e.trans.vdom("fromGameLink","play"==e.vm.mode?d("span",o):d("a",{attrs:{href:`/${t.id}/${e.vm.pov}#${n.initialPly}`}},o))),d("div.players",t.players.map((e=>d("div.player.color-icon.is.text."+e.color,"anon"!=e.userId?d("a.user-link.ulpt",{attrs:{href:"/@/"+e.userId}},e.title&&"BOT"!=e.title?[d("span.utitle",e.title)," "+e.name]:e.name):e.name))))])])}const Wn=e=>{var t;const n=e.getData();if(!n.user)return d("div.puzzle__side__user",[d("p",e.trans.noarg("toGetPersonalizedPuzzles")),d("a.button",{attrs:{href:"/signup"}},e.trans.noarg("signUp"))]);const o=null===(t=e.vm.round)||void 0===t?void 0:t.ratingDiff;return d("div.puzzle__side__user",[d("div.puzzle__side__user__rating",e.trans.vdom("yourPuzzleRatingX",d("strong",[n.user.rating-(o||0),...o&&o>0?[" ",d("good.rp","+"+o)]:[],...o&&o<0?[" ",d("bad.rp",""+-o)]:[]])))])},Vn=e=>{return d("div.puzzle__side__user",(t=e.streak,n=e.trans.noarg,d("div.puzzle__side__streak",0==t.data.index?d("div.puzzle__side__streak__info",[d("h1.text",{attrs:qn("}")},"Puzzle Streak"),d("p",n("streakDescription"))]):d("div.puzzle__side__streak__score.text",{attrs:qn("}")},t.data.index))));var t,n},Un=[["easiest",-600],["easier",-300],["normal",0],["harder",300],["hardest",600]];function Hn(e){const t=e.getData().replay;if(!t)return;const n=t.i+("play"==e.vm.mode?0:1);return d("div.puzzle__side__replay",[d("a",{attrs:{href:`/training/dashboard/${t.days}`}},[" ",`Replaying ${e.trans.noarg(e.getData().theme.key)} puzzles`]),d("div.puzzle__side__replay__bar",{attrs:{style:`--p:${t.of?Math.round(100*n/t.of):1}%`,"data-text":`${n} / ${t.of}`}})])}function Gn(e){const t="puzzle-toggle-autonext";return d("div.puzzle__side__config",[d("div.puzzle__side__config__jump",[d("div.switch",[d(`input#${t}.cmn-toggle.cmn-toggle--subtle`,{attrs:{type:"checkbox",checked:e.autoNext()},hook:{insert:t=>t.elm.addEventListener("change",(()=>e.autoNext(!e.autoNext())))}}),d("label",{attrs:{for:t}})]),d("label",{attrs:{for:t}},e.trans.noarg("jumpToNextPuzzleImmediately"))]),e.getData().replay||e.streak||!e.difficulty?null:d("form.puzzle__side__config__difficulty",{attrs:{action:`/training/difficulty/${e.getData().theme.key}`,method:"post"}},[d("label",{attrs:{for:"puzzle-difficulty"}},e.trans.noarg("difficultyLevel")),d("select#puzzle-difficulty.puzzle__difficulty__selector",{attrs:{name:"difficulty"},hook:Pn((e=>e.addEventListener("change",(()=>e.parentNode.submit()))))},Un.map((([t,n])=>d("option",{attrs:{value:t,selected:t==e.difficulty,title:!!n&&e.trans.plural(n<0?"nbPointsBelowYourPuzzleRating":"nbPointsAboveYourPuzzleRating",Math.abs(n))}},[e.trans.noarg(t),n?` (${n>0?"+":""}${n})`:""]))))]),d("div.puzzle__side__config__toggles",[d("a.puzzle__side__config__zen.button.button-empty",{hook:_n("click",(()=>lichess.pubsub.emit("zen"))),attrs:{title:"Keyboard: z"}},e.trans.noarg("zenMode")),d("a.puzzle__side__config__flip.button",{class:{active:e.flipped(),"button-empty":!e.flipped()},hook:_n("click",e.flip),attrs:{title:"Keyboard: f"}},e.trans.noarg("flipBoard"))])])}const Xn="https://lichess.org/study/viiWlKjv";function Qn(e){const t=e.getData().theme;return e.streak||e.getData().replay?null:d("div.puzzle__side__theme",[d("a",{attrs:{href:"/training/themes"}},d("h2",[" ",t.name])),d("p",[t.desc,t.chapter&&d("a.puzzle__side__theme__chapter.text",{attrs:{href:`${Xn}/${t.chapter}`,target:"_blank"}},[" ",e.trans.noarg("example")])]),"view"!=e.vm.mode||e.autoNexting()?null:Jn(e)])}const Yn=new Set(["master","masterVsMaster","superGM"]),Jn=e=>{var t;const n=e.getData(),o=e.trans.noarg,r=(null===(t=e.vm.round)||void 0===t?void 0:t.themes)||{},s=n.puzzle.themes.filter((e=>!Yn.has(e))).concat(Object.keys(r).filter((e=>r[e]&&!n.puzzle.themes.includes(e)))).sort(),i="/training/daily"==location.pathname?null:e.allThemes,a=i?i.dynamic.filter((e=>!r[e])):null;return a&&a.sort(((e,t)=>o(e)<o(t)?-1:1)),d("div.puzzle__themes",[d("div.puzzle__themes_list",{hook:_n("click",(t=>{const n=t.target,o=n.getAttribute("data-theme");o&&e.voteTheme(o,n.classList.contains("vote-up"))}))},s.map((e=>d("div.puzzle__themes__list__entry",{class:{strike:!1===r[e]}},[d("a",{attrs:{href:`/training/${e}`,title:o(`${e}Description`)}},o(e)),i?d("div.puzzle__themes__votes",i.static.has(e)?[d("div.puzzle__themes__lock",d("i",{attrs:qn("a")}))]:[d("span.puzzle__themes__vote.vote-up",{class:{active:r[e]},attrs:{"data-theme":e}}),d("span.puzzle__themes__vote.vote-down",{class:{active:!1===r[e]},attrs:{"data-theme":e}})]):null])))),...a?[d(`select.puzzle__themes__selector.cache-bust-${a.length}`,{hook:Object.assign(Object.assign({},_n("change",(t=>{const n=t.target.value;n&&e.voteTheme(n,!0)}))),{postpatch(e,t){t.elm.value=""}})},[d("option",{attrs:{value:"",selected:!0}},o("addAnotherTheme")),...a.map((e=>d("option",{attrs:{value:e,title:o(`${e}Description`)}},o(e))))]),d("a.puzzle__themes__study.text",{attrs:{"data-icon":"",href:Xn,target:"_blank"}},"About puzzle themes")]:[]])},Zn=()=>{const e={blue:"#DEE3E6 #788a94",blue2:"#97b2c7 #546f82",blue3:"#d9e0e6 #315991",canvas:"#d7daeb #547388",wood:"#d8a45b #9b4d0f",wood2:"#a38b5d #6c5017",wood3:"#d0ceca #755839",wood4:"#caaf7d #7b5330",maple:"#e8ceab #bc7944",maple2:"#E2C89F #996633",leather:"#d1d1c9 #c28e16",green:"#FFFFDD #6d8753",brown:"#F0D9B5 #946f51",pink:"#E8E9B7 #ED7272",marble:"#93ab91 #4f644e","blue-marble":"#EAE6DD #7C7F87","green-plastic":"#f2f9bb #59935d",grey:"#b8b8b8 #7d7d7d",metal:"#c9c9c9 #727272",olive:"#b8b19f #6d6655",newspaper:"#fff #8d8d8d",purple:"#9f90b0 #7d4a8d","purple-diag":"#E5DAF0 #957AB0",ic:"#ececec #c1c18e",horsey:"#F0D9B5 #946f51"};for(const t of document.body.className.split(" "))if(t in e){const n=document.documentElement.style,o=e[t].split(" ");n.setProperty("--cg-coord-color-white",o[0]),n.setProperty("--cg-coord-color-black",o[1]),n.setProperty("--cg-coord-shadow","none")}};function eo(e,t,n,o){if(0===t)return;const r=document.createElement("cg-resize");e.container.appendChild(r);const s=e=>{e.preventDefault();const t="touchstart"===e.type?"touchmove":"mousemove",n="touchstart"===e.type?"touchend":"mouseup",o=to(e),r=parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"));let s=r;const i=function(e,t,n=!1){let o,r=0;return function(...s){const i=this;o&&clearTimeout(o),o=void 0;const a=performance.now()-r;r=performance.now(),n&&a>t?e.apply(i,s):o=setTimeout((()=>{o=void 0,e.apply(i,s)}),t)}}((()=>C(`/pref/zoom?v=${100+s}`,{method:"post"})),700),a=e=>{const t=to(e),n=t[0]-o[0]+t[1]-o[1];s=Math.round(Math.min(100,Math.max(0,r+n/10))),document.body.setAttribute("style","--zoom:"+s),window.dispatchEvent(new Event("resize")),i()};document.body.classList.add("resizing"),document.addEventListener(t,a),document.addEventListener(n,(()=>{document.removeEventListener(t,a),document.body.classList.remove("resizing")}),{once:!0})};if(r.addEventListener("touchstart",s,{passive:!1}),r.addEventListener("mousedown",s,{passive:!1}),1===t){const e=e=>r.classList.toggle("none",o?!o(e):e>=2);e(n),lichess.pubsub.on("ply",e)}}function to(e){var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0}function no(e,t){return Math.abs(e-t)}const oo=(e,t,n,o)=>{const r=no(e,n),s=no(t,o);return 1===r&&2===s||2===r&&1===s},ro=(e,t,n,o)=>no(e,n)===no(t,o),so=(e,t,n,o)=>e===n||t===o,io=(e,t,n,o)=>ro(e,t,n,o)||so(e,t,n,o);function ao(e,t,n){const o=e.get(t);if(!o)return[];const r=Ut(t),s=o.role,i="pawn"===s?(a=o.color,(e,t,n,o)=>no(e,n)<2&&("white"===a?o===t+1||t<=1&&o===t+2&&e===n:o===t-1||t>=6&&o===t-2&&e===n)):"knight"===s?oo:"bishop"===s?ro:"rook"===s?so:"queen"===s?io:function(e,t,n){return(o,r,s,i)=>no(o,s)<2&&no(r,i)<2||n&&r===i&&r===("white"===e?0:7)&&(4===o&&(2===s&&t.includes(0)||6===s&&t.includes(7))||t.includes(s))}(o.color,function(e,t){const n="white"===t?"1":"8",o=[];for(const[r,s]of e)r[1]===n&&s.color===t&&"rook"===s.role&&o.push(Ut(r)[0]);return o}(e,o.color),n);var a;return Ht.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&i(r[0],r[1],e[0],e[1]))).map(Vt)}function co(e,...t){e&&setTimeout((()=>e(...t)),1)}function lo(e){e.premovable.current&&(e.premovable.current=void 0,co(e.premovable.events.unset))}function uo(e){const t=e.predroppable;t.current&&(t.current=void 0,co(t.events.unset))}function ho(e,t,n){const o=e.pieces.get(t),r=e.pieces.get(n);if(t===n||!o)return!1;const s=r&&r.color!==o.color?r:void 0;return n===e.selected&&ko(e),co(e.events.move,t,n,s),function(e,t,n){if(!e.autoCastle)return!1;const o=e.pieces.get(t);if(!o||"king"!==o.role)return!1;const r=Ut(t),s=Ut(n);if(0!==r[1]&&7!==r[1]||r[1]!==s[1])return!1;4!==r[0]||e.pieces.has(n)||(6===s[0]?n=Vt([7,s[1]]):2===s[0]&&(n=Vt([0,s[1]])));const i=e.pieces.get(n);return!(!i||i.color!==o.color||"rook"!==i.role||(e.pieces.delete(t),e.pieces.delete(n),r[0]<s[0]?(e.pieces.set(Vt([6,s[1]]),o),e.pieces.set(Vt([5,s[1]]),i)):(e.pieces.set(Vt([2,s[1]]),o),e.pieces.set(Vt([3,s[1]]),i)),0))}(e,t,n)||(e.pieces.set(n,o),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,co(e.events.change),s||!0}function po(e,t,n,o){if(e.pieces.has(n)){if(!o)return!1;e.pieces.delete(n)}return co(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,co(e.events.change),e.movable.dests=void 0,e.turnColor=Xt(e.turnColor),!0}function fo(e,t,n){const o=ho(e,t,n);return o&&(e.movable.dests=void 0,e.turnColor=Xt(e.turnColor),e.animation.current=void 0),o}function mo(e,t,n){if(yo(e,t,n)){const o=fo(e,t,n);if(o){const r=e.hold.stop();ko(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==o&&(s.captured=o),co(e.movable.events.after,t,n,s),!0}}else if(function(e,t,n){return t!==n&&zo(e,t)&&ao(e.pieces,t,e.premovable.castle).includes(n)}(e,t,n))return function(e,t,n,o){uo(e),e.premovable.current=[t,n],co(e.premovable.events.set,t,n,o)}(e,t,n,{ctrlKey:e.stats.ctrlKey}),ko(e),!0;return ko(e),!1}function vo(e,t,n,o){const r=e.pieces.get(t);r&&(function(e,t,n){const o=e.pieces.get(t);return!(!o||t!==n&&e.pieces.has(n)||"both"!==e.movable.color&&(e.movable.color!==o.color||e.turnColor!==o.color))}(e,t,n)||o)?(e.pieces.delete(t),po(e,r,n,o),co(e.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&function(e,t,n){const o=e.pieces.get(t),r=e.pieces.get(n);return!!o&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==o.role||"1"!==n[1]&&"8"!==n[1])&&e.movable.color===o.color&&e.turnColor!==o.color}(e,t,n)?function(e,t,n){lo(e),e.predroppable.current={role:t,key:n},co(e.predroppable.events.set,t,n)}(e,r.role,n):(lo(e),uo(e)),e.pieces.delete(t),ko(e)}function go(e,t,n){if(co(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return ko(e),void e.hold.cancel();if((e.selectable.enabled||n)&&e.selected!==t&&mo(e,e.selected,t))return void(e.stats.dragged=!1)}(wo(e,t)||zo(e,t))&&(bo(e,t),e.hold.start())}function bo(e,t){e.selected=t,zo(e,t)?e.premovable.dests=ao(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function ko(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function wo(e,t){const n=e.pieces.get(t);return!!n&&("both"===e.movable.color||e.movable.color===n.color&&e.turnColor===n.color)}function yo(e,t,n){var o,r;return t!==n&&wo(e,t)&&(e.movable.free||!!(null===(r=null===(o=e.movable.dests)||void 0===o?void 0:o.get(t))||void 0===r?void 0:r.includes(n)))}function zo(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function So(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],o=t[1];let r=!1;if(yo(e,n,o)){const t=fo(e,n,o);if(t){const s={premove:!0};!0!==t&&(s.captured=t),co(e.movable.events.after,n,o,s),r=!0}}return lo(e),r}function Co(e){lo(e),uo(e),ko(e)}function Eo(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Co(e)}function xo(e,t,n){let o=Math.floor(8*(e[0]-n.left)/n.width);t||(o=7-o);let r=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(r=7-r),o>=0&&o<8&&r>=0&&r<8?Vt([o,r]):void 0}function Mo(e){return"white"===e.orientation}const _o="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Po={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},qo={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Oo(e){"start"===e&&(e=_o);const t=new Map;let n=7,o=0;for(const r of e)switch(r){case" ":return t;case"/":if(--n,n<0)return t;o=0;break;case"~":{const e=t.get(Vt([o,n]));e&&(e.promoted=!0);break}default:{const e=r.charCodeAt(0);if(e<57)o+=e-48;else{const e=r.toLowerCase();t.set(Vt([o,n]),{role:Po[e],color:r===e?"black":"white"}),++o}}}return t}function Ao(e,t){var n,o;if((null===(n=t.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(o=t.drawable)||void 0===o?void 0:o.autoShapes)&&(e.drawable.autoShapes=[]),No(e,t),t.fen&&(e.pieces=Oo(t.fen),e.drawable.shapes=[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[n,o]of e.pieces)"king"===o.role&&o.color===t&&(e.check=n)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&bo(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",n="e"+t,o=e.movable.dests.get(n),r=e.pieces.get(n);if(!o||!r||"king"!==r.role)return;e.movable.dests.set(n,o.filter((e=>!(e==="a"+t&&o.includes("c"+t)||e==="h"+t&&o.includes("g"+t)))))}}function No(e,t){for(const n in t)Do(e[n])&&Do(t[n])?No(e[n],t[n]):e[n]=t[n]}function Do(e){return"object"==typeof e}function Ro(e,t){return t.animation.enabled?function(e,t){const n=new Map(t.pieces),o=e(t),r=function(e,t){const n=new Map,o=[],r=new Map,s=[],i=[],a=new Map;let c,l,u;for(const[t,n]of e)a.set(t,$o(t,n));for(const e of Wt)c=t.pieces.get(e),l=a.get(e),c?l?Yt(c,l.piece)||(s.push(l),i.push($o(e,c))):i.push($o(e,c)):l&&s.push(l);for(const e of i)l=Io(e,s.filter((t=>Yt(e.piece,t.piece)))),l&&(u=[l.pos[0]-e.pos[0],l.pos[1]-e.pos[1]],n.set(e.key,u.concat(u)),o.push(l.key));for(const e of s)o.includes(e.key)||r.set(e.key,e.piece);return{anims:n,fadings:r}}(n,t);if(r.anims.size||r.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},e||Lo(t,performance.now())}else t.dom.redraw();return o}(e,t):To(e,t)}function To(e,t){const n=e(t);return t.dom.redraw(),n}function $o(e,t){return{key:e,pos:Ut(e),piece:t}}function Io(e,t){return t.sort(((t,n)=>Qt(e.pos,t.pos)-Qt(e.pos,n.pos)))[0]}function Lo(e,t){const n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());const o=1-(t-n.start)*n.frequency;if(o<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=function(e){return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1}(o);for(const e of n.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>Lo(e,t)))}}const Bo=["green","red","blue","yellow"];function jo(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?ko(e):Co(e);const n=rn(t),o=xo(n,Mo(e),e.dom.bounds());o&&(e.drawable.current={orig:o,pos:n,brush:Uo(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Fo(e))}function Fo(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const n=xo(t.pos,Mo(e),e.dom.bounds());n||(t.snapToValidMove=!1);const o=t.snapToValidMove?function(e,t,n,o){const r=Ut(e),s=Ht.filter((e=>io(r[0],r[1],e[0],e[1])||oo(r[0],r[1],e[0],e[1]))),i=s.map((e=>cn(Vt(e),n,o))).map((e=>Qt(t,e))),[,a]=i.reduce(((e,t,n)=>e[0]<t?e:[t,n]),[i[0],0]);return Vt(s[a])}(t.orig,t.pos,Mo(e),e.dom.bounds()):n;o!==t.mouseSq&&(t.mouseSq=o,t.dest=o!==t.orig?o:void 0,e.dom.redrawNow()),Fo(e)}}))}function Ko(e,t){e.drawable.current&&(e.drawable.current.pos=rn(t))}function Wo(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const n=e=>e.orig===t.orig&&e.dest===t.dest,o=e.shapes.find(n);o&&(e.shapes=e.shapes.filter((e=>!n(e))));o&&o.brush===t.brush||e.shapes.push(t);Ho(e)}(e.drawable,t),Vo(e))}function Vo(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Uo(e){var t;const n=(e.shiftKey||e.ctrlKey)&&sn(e),o=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return Bo[(n?1:0)+(o?2:0)]}function Ho(e){e.onChange&&e.onChange(e.shapes)}function Go(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),o=rn(t),r=xo(o,Mo(e),n);if(!r)return;const s=e.pieces.get(r),i=e.selected;var a;i||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),Ho(a.drawable)),!1===t.cancelable||t.touches&&e.movable.color&&!s&&!i&&!function(e,t){const n=Mo(e),o=e.dom.bounds(),r=Math.pow(o.width/8,2);for(const s in e.pieces){const e=cn(s,n,o);if(Qt(e,t)<=r)return!0}return!1}(e,o)||t.preventDefault();const c=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&yo(e,e.selected,r)?Ro((e=>go(e,r)),e):go(e,r);const u=e.selected===r,d=er(e,r);if(s&&d&&u&&function(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:s,origPos:o,pos:o,started:e.draggable.autoDistance&&e.stats.dragged,element:d,previouslySelected:i,originTarget:t.target},d.cgDragging=!0,d.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${s.color} ${s.role}`,tn(a,Zt(n)(Ut(r),Mo(e))),on(a,!0)),Xo(e)}else c&&lo(e),l&&uo(e);e.dom.redraw()}function Xo(e){requestAnimationFrame((()=>{var t;const n=e.draggable.current;if(!n)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(n.orig))&&(e.animation.current=void 0);const o=e.pieces.get(n.orig);if(o&&Yt(o,n.piece)){if(!n.started&&Qt(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const e=n.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),n.element=e}const t=e.dom.bounds();tn(n.element,[n.pos[0]-t.left-t.width/16,n.pos[1]-t.top-t.height/16])}}else Jo(e);Xo(e)}))}function Qo(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=rn(t))}function Yo(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);lo(e),uo(e);const o=xo(rn(t)||n.pos,Mo(e),e.dom.bounds());o&&n.started&&n.orig!==o?n.newPiece?vo(e,n.orig,o,n.force):(e.stats.ctrlKey=t.ctrlKey,mo(e,n.orig,o)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!o&&(e.pieces.delete(n.orig),co(e.events.change)),(n.orig!==n.previouslySelected||n.orig!==o&&o)&&e.selectable.enabled||ko(e),Zo(e),e.draggable.current=void 0,e.dom.redraw()}function Jo(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,ko(e),Zo(e),e.dom.redraw())}function Zo(e){const t=e.dom.elements;t.ghost&&on(t.ghost,!1)}function er(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function tr(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function nr(e,t){function n(){!function(e){e.orientation=Xt(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&n(),(t.fen?Ro:To)((e=>Ao(e,t)),e)},state:e,getFen:()=>{return t=e.pieces,Kt.map((e=>jt.map((n=>{const o=t.get(n+e);if(o){const e=qo[o.role];return"white"===o.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:n,setPieces(t){Ro((e=>function(e,t){for(const[n,o]of t)o?e.pieces.set(n,o):e.pieces.delete(n)}(e,t)),e)},selectSquare(t,n){t?Ro((e=>go(e,t,n)),e):e.selected&&(ko(e),e.dom.redraw())},move(t,n){Ro((e=>ho(e,t,n)),e)},newPiece(t,n){Ro((e=>po(e,t,n)),e)},playPremove(){if(e.premovable.current){if(Ro(So,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const n=function(e,t){const n=e.predroppable.current;let o=!1;if(!n)return!1;t(n)&&po(e,{role:n.role,color:e.movable.color},n.key)&&(co(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),o=!0);return uo(e),o}(e,t);return e.dom.redraw(),n}return!1},cancelPremove(){To(lo,e)},cancelPredrop(){To(uo,e)},cancelMove(){To((e=>{Co(e),Jo(e)}),e)},stop(){To((e=>{Eo(e),Jo(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{tr(e,2),setTimeout((()=>tr(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){To((e=>e.drawable.autoShapes=t),e)},setShapes(t){To((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>xo(t,Mo(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,n,o){!function(e,t,n,o){const r="a0";e.pieces.set(r,t),e.dom.redraw();const s=rn(n);e.draggable.current={orig:r,piece:t,origPos:s,pos:s,started:!0,element:()=>er(e,r),originTarget:n.target,newPiece:!0,force:!!o},Xo(e)}(e,t,n,o)},destroy(){Eo(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function or(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function rr(e,t,n){const o=e.drawable,r=o.current,s=r&&r.mouseSq?r:void 0,i=new Map,a=e.dom.bounds();for(const e of o.shapes.concat(o.autoShapes).concat(s?[s]:[]))e.dest&&i.set(e.dest,(i.get(e.dest)||0)+1);const c=o.shapes.concat(o.autoShapes).map((e=>({shape:e,current:!1,hash:ir(e,i,!1,a)})));s&&c.push({shape:s,current:!0,hash:ir(s,i,!0,a)});const l=c.map((e=>e.hash)).join(";");if(l===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=l;const u=t.querySelector("defs"),d=t.querySelector("g"),h=n.querySelector("g");!function(e,t,n){const o=new Map;let r;for(const n of t)n.shape.dest&&(r=e.brushes[n.shape.brush],n.shape.modifiers&&(r=pr(r,n.shape.modifiers)),o.set(r.key,r));const s=new Set;let i=n.firstChild;for(;i;)s.add(i.getAttribute("cgKey")),i=i.nextSibling;for(const[e,t]of o.entries())s.has(e)||n.appendChild(ur(t))}(o,c,u),sr(e,c.filter((e=>!e.shape.customSvg)),o.brushes,i,d),sr(e,c.filter((e=>e.shape.customSvg)),o.brushes,i,h)}function sr(e,t,n,o,r){const s=e.dom.bounds(),i=new Map,a=[];for(const e of t)i.set(e.hash,!1);let c,l=r.firstChild;for(;l;)c=l.getAttribute("cgHash"),i.has(c)?i.set(c,!0):a.push(l),l=l.nextSibling;for(const e of a)r.removeChild(e);for(const a of t)i.get(a.hash)||r.appendChild(lr(e,a,n,o,s))}function ir({orig:e,dest:t,brush:n,piece:o,modifiers:r,customSvg:s},i,a,c){return[c.width,c.height,a,e,t,n,t&&(i.get(t)||0)>1,o&&ar(o),r&&(l=r,""+(l.lineWidth||"")),s&&cr(s)].filter((e=>e)).join(",");var l}function ar(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function cr(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return"custom-"+t.toString()}function lr(e,{shape:t,current:n,hash:o},r,s,i){let a;if(t.customSvg){const n=hr(Ut(t.orig),e.orientation);a=function(e,t,n){const{width:o,height:r}=n,s=o/8,i=r/8,a=t[0]*s,c=(7-t[1])*i,l=dr(or("g"),{transform:`translate(${a},${c})`}),u=dr(or("svg"),{width:s,height:i,viewBox:"0 0 100 100"});return l.appendChild(u),u.innerHTML=e,l}(t.customSvg,n,i)}else if(t.piece)a=function(e,t,n,o){const r=vr(t,o),s=o.width/8*(n.scale||1),i=n.color[0]+("knight"===n.role?"n":n.role[0]).toUpperCase();return dr(or("image"),{className:`${n.role} ${n.color}`,x:r[0]-s/2,y:r[1]-s/2,width:s,height:s,href:e+i+".svg"})}(e.drawable.pieces.baseUrl,hr(Ut(t.orig),e.orientation),t.piece,i);else{const o=hr(Ut(t.orig),e.orientation);if(t.dest){let c=r[t.brush];t.modifiers&&(c=pr(c,t.modifiers)),a=function(e,t,n,o,r,s){const i=function(e,t){return(t?20:10)/512*e.width}(s,r&&!o),a=vr(t,s),c=vr(n,s),l=c[0]-a[0],u=c[1]-a[1],d=Math.atan2(u,l),h=Math.cos(d)*i,p=Math.sin(d)*i;return dr(or("line"),{stroke:e.color,"stroke-width":fr(e,o,s),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:mr(e,o),x1:a[0],y1:a[1],x2:c[0]-h,y2:c[1]-p})}(c,o,hr(Ut(t.dest),e.orientation),n,(s.get(t.dest)||0)>1,i)}else a=function(e,t,n,o){const r=vr(t,o),s=function(e){const t=e.width/512;return[3*t,4*t]}(o),i=(o.width+o.height)/32;return dr(or("circle"),{stroke:e.color,"stroke-width":s[n?0:1],fill:"none",opacity:mr(e,n),cx:r[0],cy:r[1],r:i-s[1]/2})}(r[t.brush],o,n,i)}return a.setAttribute("cgHash",o),a}function ur(e){const t=dr(or("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(dr(or("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function dr(e,t){for(const n in t)e.setAttribute(n,t[n]);return e}function hr(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function pr(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function fr(e,t,n){return(e.lineWidth||10)*(t?.85:1)/512*n.width}function mr(e,t){return(e.opacity||1)*(t?.9:1)}function vr(e,t){return[(e[0]+.5)*t.width/8,(7.5-e[1])*t.height/8]}function gr(e,t){const n=an("coords",t);let o;for(const t of e)o=an("coord"),o.textContent=t,n.appendChild(o);return n}function br(e,t){const n=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(n)}if(e.viewOnly)return;const o=function(e){return t=>{e.draggable.current?Jo(e):e.drawable.current?Vo(e):t.shiftKey||sn(t)?e.drawable.enabled&&jo(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;lo(e),uo(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const o=rn(t),r=o&&xo(o,Mo(e),e.dom.bounds());r&&vo(e,"a0",r)}e.dom.redraw()}(e,t):Go(e,t))}}(e);n.addEventListener("touchstart",o,{passive:!1}),n.addEventListener("mousedown",o,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault()))}function kr(e,t,n,o){return e.addEventListener(t,n,o),()=>e.removeEventListener(t,n,o)}function wr(e,t,n){return o=>{e.drawable.current?e.drawable.enabled&&n(e,o):e.viewOnly||t(e,o)}}function yr(e){const t=Mo(e),n=e.dom.relative?en:Zt(e.dom.bounds()),o=e.dom.relative?nn:tn,r=e.dom.elements.board,s=e.pieces,i=e.animation.current,a=i?i.plan.anims:new Map,c=i?i.plan.fadings:new Map,l=e.draggable.current,u=function(e){var t;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)Mr(n,t,"last-move");e.check&&e.highlight.check&&Mr(n,e.check,"check");if(e.selected&&(Mr(n,e.selected,"selected"),e.movable.showDests)){const o=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(o)for(const t of o)Mr(n,t,"move-dest"+(e.pieces.has(t)?" oc":""));const r=e.premovable.dests;if(r)for(const t of r)Mr(n,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const o=e.premovable.current;if(o)for(const e of o)Mr(n,e,"current-premove");else e.predroppable.current&&Mr(n,e.predroppable.current.key,"current-premove");const r=e.exploding;if(r)for(const e of r.keys)Mr(n,e,"exploding"+r.stage);return n}(e),d=new Set,h=new Set,p=new Map,f=new Map;let m,v,g,b,k,w,y,z,S,C;for(v=r.firstChild;v;){if(m=v.cgKey,zr(v))if(g=s.get(m),k=a.get(m),w=c.get(m),b=v.cgPiece,!v.cgDragging||l&&l.orig===m||(v.classList.remove("dragging"),o(v,n(Ut(m),t)),v.cgDragging=!1),!w&&v.cgFading&&(v.cgFading=!1,v.classList.remove("fading")),g){if(k&&v.cgAnimating&&b===xr(g)){const e=Ut(m);e[0]+=k[2],e[1]+=k[3],v.classList.add("anim"),o(v,n(e,t))}else v.cgAnimating&&(v.cgAnimating=!1,v.classList.remove("anim"),o(v,n(Ut(m),t)),e.addPieceZIndex&&(v.style.zIndex=Er(Ut(m),t)));b!==xr(g)||w&&v.cgFading?w&&b===xr(w)?(v.classList.add("fading"),v.cgFading=!0):_r(p,b,v):d.add(m)}else _r(p,b,v);else if(Sr(v)){const e=v.className;u.get(m)===e?h.add(m):_r(f,e,v)}v=v.nextSibling}for(const[e,s]of u)if(!h.has(e)){S=f.get(s),C=S&&S.pop();const i=n(Ut(e),t);if(C)C.cgKey=e,o(C,i);else{const t=an("square",s);t.cgKey=e,o(t,i),r.insertBefore(t,r.firstChild)}}for(const[i,c]of s)if(k=a.get(i),!d.has(i))if(y=p.get(xr(c)),z=y&&y.pop(),z){z.cgKey=i,z.cgFading&&(z.classList.remove("fading"),z.cgFading=!1);const r=Ut(i);e.addPieceZIndex&&(z.style.zIndex=Er(r,t)),k&&(z.cgAnimating=!0,z.classList.add("anim"),r[0]+=k[2],r[1]+=k[3]),o(z,n(r,t))}else{const s=xr(c),a=an("piece",s),l=Ut(i);a.cgPiece=s,a.cgKey=i,k&&(a.cgAnimating=!0,l[0]+=k[2],l[1]+=k[3]),o(a,n(l,t)),e.addPieceZIndex&&(a.style.zIndex=Er(l,t)),r.appendChild(a)}for(const t of p.values())Cr(e,t);for(const t of f.values())Cr(e,t)}function zr(e){return"PIECE"===e.tagName}function Sr(e){return"SQUARE"===e.tagName}function Cr(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function Er(e,t){let n=2+8*e[1]+(7-e[0]);return t&&(n=67-n),n+""}function xr(e){return`${e.color} ${e.role}`}function Mr(e,t,n){const o=e.get(t);o?e.set(t,`${o} ${n}`):e.set(t,n)}function _r(e,t,n){const o=e.get(t);o?o.push(n):e.set(t,[n])}function Pr(e,t){const n={pieces:Oo(_o),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:Gt()};function o(){const t="dom"in n?n.dom.unbind:void 0,o=n.viewOnly&&!n.drawable.visible,r=function(e,t,n){e.innerHTML="",e.classList.add("cg-wrap");for(const n of Bt)e.classList.toggle("orientation-"+n,t.orientation===n);e.classList.toggle("manipulable",!t.viewOnly);const o=an("cg-helper");e.appendChild(o);const r=an("cg-container");o.appendChild(r);const s=an("cg-board");let i,a,c;if(r.appendChild(s),t.drawable.visible&&!n&&(i=dr(or("svg"),{class:"cg-shapes"}),i.appendChild(or("defs")),i.appendChild(or("g")),a=dr(or("svg"),{class:"cg-custom-svgs"}),a.appendChild(or("g")),r.appendChild(i),r.appendChild(a)),t.coordinates){const e="black"===t.orientation?" black":"";r.appendChild(gr(Ft,"ranks"+e)),r.appendChild(gr(jt,"files"+e))}return t.draggable.showGhost&&!n&&(c=an("piece","ghost"),on(c,!1),r.appendChild(c)),{board:s,container:r,ghost:c,svg:i,customSvg:a}}(e,n,o),s=function(e){let t;const n=()=>(void 0===t&&(t=e()),t);return n.clear=()=>{t=void 0},n}((()=>r.board.getBoundingClientRect())),i=e=>{yr(c),!e&&r.svg&&rr(c,r.svg,r.customSvg)},a=()=>{s.clear(),function(e){if(e.dom.relative)return;const t=Mo(e),n=Zt(e.dom.bounds());let o=e.dom.elements.board.firstChild;for(;o;)(zr(o)&&!o.cgAnimating||Sr(o))&&tn(o,n(Ut(o.cgKey),t)),o=o.nextSibling}(c),r.svg&&rr(c,r.svg,r.customSvg)},c=n;return c.dom={elements:r,bounds:s,redraw:qr(i),redrawNow:i,unbind:t,relative:o},c.drawable.prevSvgHash="",i(!1),br(c,a),t||(c.dom.unbind=function(e,t){const n=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||n.push(kr(document.body,"chessground.resize",t)),!e.viewOnly){const t=wr(e,Qo,Ko),o=wr(e,Yo,Wo);for(const e of["touchmove","mousemove"])n.push(kr(document,e,t));for(const e of["touchend","mouseup"])n.push(kr(document,e,o));const r=()=>e.dom.bounds.clear();n.push(kr(document,"scroll",r,{capture:!0,passive:!0})),n.push(kr(window,"resize",r,{passive:!0}))}return()=>n.forEach((e=>e()))}(c,a)),c.events.insert&&c.events.insert(r),c}return Ao(n,t||{}),nr(o(),o)}function qr(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}function Or(e){return d("div.cg-wrap",{hook:{insert:t=>e.ground(Pr(t.elm,function(e){const t=e.makeCgOpts();return{fen:t.fen,orientation:t.orientation,turnColor:t.turnColor,check:t.check,lastMove:t.lastMove,coordinates:0!==e.pref.coords,addPieceZIndex:e.pref.is3d,movable:{free:!1,color:t.movable.color,dests:t.movable.dests,showDests:e.pref.destination,rookCastle:e.pref.rookCastle},draggable:{enabled:e.pref.moveEvent>0,showGhost:e.pref.highlight},selectable:{enabled:1!==e.pref.moveEvent},events:{move:e.userMove,insert(t){eo(t,2,e.vm.node.ply,(e=>!0)),1===e.pref.coords&&Zn()}},premovable:{enabled:t.premovable.enabled},drawable:{enabled:!0,defaultSnapToValidMove:"0"!=(lichess.storage.get("arrow.snap")||1)},highlight:{lastMove:e.pref.highlight,check:e.pref.highlight},animation:{enabled:!0,duration:e.pref.animation.duration},disableContextMenu:!0}}(e))),destroy:t=>e.ground().destroy()}})}const Ar=e=>{var t;return d("div.puzzle__vote",e.autoNexting()?[]:[e.session.isNew()&&(null===(t=e.getData().user)||void 0===t?void 0:t.provisional)?d("div.puzzle__vote__help",[d("p",e.trans.noarg("didYouLikeThisPuzzle")),d("p",e.trans.noarg("voteToLoadNextOne"))]):null,d("div.puzzle__vote__buttons",{class:{enabled:!e.vm.voteDisabled}},[d("div.vote.vote-up",{hook:_n("click",(()=>e.vote(!0)))}),d("div.vote.vote-down",{hook:_n("click",(()=>e.vote(!1)))})])])},Nr=e=>d("a.continue",{hook:_n("click",e.nextPuzzle)},[d("i",{attrs:qn("G")}),e.trans.noarg("continueTraining")]);function Dr(e){const t=e.getData(),n="win"==e.vm.lastFeedback;return d("div.puzzle__feedback.after",e.streak&&!n?(e=>{var t;return[d("div.complete",[d("span.game-over","GAME OVER"),d("span",e.trans.vdom("yourStreakX",d("strong",null===(t=e.streak)||void 0===t?void 0:t.data.index)))]),d("a.continue",{attrs:{href:"/streak"}},[d("i",{attrs:qn("G")}),e.trans("newStreak")])]})(e):[d("div.complete",e.trans.noarg(n?"puzzleSuccess":"puzzleComplete")),t.user?Ar(e):Nr(e),d("div.puzzle__more",[d("a",{attrs:{"data-icon":"",href:`/analysis/${e.vm.node.fen.replace(/ /g,"_")}?color=${e.vm.pov}#practice`,title:e.trans.noarg("playWithTheMachine"),target:"_blank"}}),t.user?d("a",{hook:_n("click",e.nextPuzzle)},e.trans.noarg(e.streak?"continueTheStreak":"continueTraining")):void 0])])}const Rr=e=>{var t;return e.streak?d("div.view_solution.skip",{class:{show:!!(null===(t=e.streak)||void 0===t?void 0:t.data.skip)}},[d("a.button.button-empty",{hook:_n("click",e.skip),attrs:{title:e.trans.noarg("streakSkipExplanation")}},e.trans.noarg("skip"))]):d("div.view_solution",{class:{show:e.vm.canViewSolution}},[d("a.button.button-empty",{hook:_n("click",e.viewSolution)},e.trans.noarg("viewTheSolution"))])};function Tr(e){if("view"===e.vm.mode)return Dr(e);switch(e.vm.lastFeedback){case"init":return(e=>d("div.puzzle__feedback.play",[d("div.player",[d("div.no-square",d("piece.king."+e.vm.pov)),d("div.instruction",[d("strong",e.trans.noarg("yourTurn")),d("em",e.trans.noarg("white"===e.vm.pov?"findTheBestMoveForWhite":"findTheBestMoveForBlack"))])]),Rr(e)]))(e);case"good":return(e=>d("div.puzzle__feedback.good",[d("div.player",[d("div.icon",""),d("div.instruction",[d("strong",e.trans.noarg("bestMove")),d("em",e.trans.noarg("keepGoing"))])]),Rr(e)]))(e);case"fail":return(e=>d("div.puzzle__feedback.fail",[d("div.player",[d("div.icon",""),d("div.instruction",[d("strong",e.trans.noarg("notTheMove")),d("em",e.trans.noarg("trySomethingElse"))])]),Rr(e)]))(e)}}const $r=M(150,((e,t)=>{const n=t.parentNode,o=t.querySelector(".active");n.scrollTop=o?o.offsetTop-n.offsetHeight/2+o.offsetHeight:""===e.vm.path?0:99999}));function Ir(e,t){return fn(e.ctrl.vm.path,t)}function Lr(e,t){return d("index",function(e){return Math.floor((e-1)/2)+1}(e)+(t?e%2==1?".":"...":""))}function Br(e,t,n){const o=t.children,r=o[0];if(!r)return[];if(n.isMainline){const t=r.ply%2==1;if(!o[1])return[t?Lr(r.ply,!1):null,...Vr(e,r,{parentPath:n.parentPath,isMainline:!0})];const s=Br(e,r,{parentPath:n.parentPath+r.id,isMainline:!0}),i={parentPath:n.parentPath,isMainline:!0};return[t?Lr(r.ply,!1):null,Fr(e,r,i),t?Ur():null,d("interrupt",jr(e,o.slice(1),{parentPath:n.parentPath,isMainline:!0})),...t&&s?[Lr(r.ply,!1),Ur()]:[],...s]}return o[1]?[jr(e,o,n)]:Vr(e,r,n)}function jr(e,t,n){return d("lines",{class:{single:!!t[1]}},t.map((function(t){return d("line",Vr(e,t,{parentPath:n.parentPath,isMainline:!1,withIndex:!0}))})))}function Fr(e,t,n){return n.isMainline?function(e,t,n){const o=n.parentPath+t.id,r={active:o===e.ctrl.vm.path,current:o===e.ctrl.vm.initialPath,hist:t.ply<e.ctrl.vm.initialNode.ply};t.puzzle&&(r[t.puzzle]=!0);return d("move",{attrs:{p:o},class:r},function(e,t){const n=t.eval||t.ceval;return[t.san,n&&(b(n.cp)?Hr(ue(n.cp)):b(n.mate)?Hr("#"+n.mate):void 0),Wr(e,t)]}(e,t))}(e,t,n):function(e,t,n){const o=n.withIndex||t.ply%2==1,r=n.parentPath+t.id,s=r===e.ctrl.vm.path,i={active:s,parent:!s&&Ir(e,r)};t.puzzle&&(i[t.puzzle]=!0);return d("move",{attrs:{p:r},class:i},[o?Lr(t.ply,!0):null,t.san,Wr(e,t)])}(e,t,n)}function Kr(e){return d("glyph",{attrs:{title:e.name}},e.symbol)}function Wr(e,t){switch(t.puzzle){case"good":case"win":return Kr({name:e.ctrl.trans.noarg("bestMove"),symbol:""});case"fail":return Kr({name:e.ctrl.trans.noarg("puzzleFailed"),symbol:""});case"retry":return Kr({name:e.ctrl.trans.noarg("goodMove"),symbol:"?!"});default:return}}function Vr(e,t,n){return[Fr(e,t,n),...Br(e,t,{parentPath:n.parentPath+t.id,isMainline:n.isMainline})]}function Ur(){return d("move.empty","...")}function Hr(e){return d("eval",e)}function Gr(e){const t=e.getTree().root,n={ctrl:e,showComputer:!1};return d("div.tview2.tview2-column",{hook:{insert:t=>{const n=t.elm;""!==e.path&&$r(e,n),n.addEventListener("mousedown",(t=>{if(b(t.button)&&0!==t.button)return;const n=function(e){const t=e.target;return t.getAttribute("p")||t.parentNode.getAttribute("p")}(t);n&&e.userJump(n),e.redraw()}))},postpatch:(t,n)=>{e.vm.autoScrollNow?($r(e,n.elm),e.vm.autoScrollNow=!1,e.autoScrollRequested=!1):e.vm.autoScrollRequested&&(""!==e.vm.path&&$r(e,n.elm),e.vm.autoScrollRequested=!1)}}},[...t.ply%2==1?[Lr(t.ply,!1),Ur()]:[],...Br(n,t,{parentPath:"",isMainline:!0})])}function Xr(e){return d("div.puzzle__moves.areplay",[Gr(e)])}function Qr(e,t,n,o=!1){return d("button.fbt",{class:{disabled:n,glowing:o},attrs:{"data-act":t,"data-icon":e}})}function Yr(e){const t=e.vm.node,n=t.children[0],o="play"==e.vm.mode&&n&&"fail"!=n.puzzle;return d("div.puzzle__controls.analyse-controls",{hook:Pn((t=>{!function(e,t,n){for(const o of["touchstart","mousedown"])e.addEventListener(o,(e=>{t(e),e.preventDefault(),n&&n()}),{passive:!1})}(t,(t=>{const n=function(e){const t=e.target;return t.getAttribute("data-act")||t.parentNode.getAttribute("data-act")}(t);"prev"===n?En(e):"next"===n?Cn(e):"first"===n?Mn(e):"last"===n&&xn(e)}),e.redraw)}))},[d("div.jumps",[Qr("W","first",!t.ply),Qr("Y","prev",!t.ply),Qr("X","next",!n,o),Qr("V","last",!n,o)])])}let Jr=!1;function Zr(e){const t=e.vm.showComputer(),n=e.showEvalGauge();return Jr!==t&&(Jr||(e.vm.autoScrollNow=!0),Jr=t),d(`main.puzzle.puzzle-${e.getData().replay?"replay":"play"}${e.streak?".puzzle--streak":""}`,{class:{"gauge-on":n},hook:{postpatch(t,o){t.data.gaugeOn!==n&&(2===e.pref.coords&&($("body").toggleClass("coords-in",n).toggleClass("coords-out",!n),Zn()),document.body.dispatchEvent(new Event("chessground.resize"))),o.data.gaugeOn=n}}},[d("aside.puzzle__side",[Hn(e),jn(e),e.streak?Vn(e):Wn(e),Gn(e),Qn(e)]),d("div.puzzle__board.main-board"+(e.pref.blindfold?".blindfold":""),{hook:"ontouchstart"in window?void 0:_n("wheel",(t=>function(e,t){const n=t.target;if("PIECE"===n.tagName||"SQUARE"===n.tagName||"CG-BOARD"===n.tagName)return t.preventDefault(),t.deltaY>0?Cn(e):t.deltaY<0&&En(e),e.redraw(),!1}(e,t)))},[Or(e),e.promotion.view()]),At(e),d("div.puzzle__tools",[d("div.ceval-wrap",{class:{none:!t}},t?[Nt(e),$t(e)]:[]),Xr(e),Tr(e)]),Yr(e),es(e)])}function es(e){var t;const n=e.session.get().rounds,o=e.getData().puzzle.id;return d("div.puzzle__session",[...n.map((t=>{const n=t.ratingDiff?t.ratingDiff>0?"+"+t.ratingDiff:t.ratingDiff:null;return d(`a.result-${t.result}${n?"":".result-empty"}`,{key:t.id,class:{current:o==t.id},attrs:Object.assign({href:`/training/${e.session.theme}/${t.id}`},e.streak?{target:"_blank"}:{})},n)})),n.find((e=>e.id==o))?e.streak?null:d("a.session-new",{key:"new",attrs:{href:`/training/${e.session.theme}`}}):d("a.result-cursor.current",{key:o,attrs:e.streak?{}:{href:`/training/${e.session.theme}/${o}`}},null===(t=e.streak)||void 0===t?void 0:t.data.index)])}const ts=function(u,d){let h,p;const f={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},m=void 0!==d?d:e;for(h=0;h<l.length;++h)for(f[l[h]]=[],p=0;p<u.length;++p){const e=u[p][l[h]];void 0!==e&&f[l[h]].push(e)}function v(e){const n=e.id?"#"+e.id:"",o=e.className?"."+e.className.split(" ").join("."):"";return t(m.tagName(e).toLowerCase()+n+o,{},[],void 0,e)}function g(e,t){return function(){if(0==--t){const t=m.parentNode(e);m.removeChild(t,e)}}}function b(e,t){var a,c;let l,u=e.data;if(void 0!==u){const t=null===(a=u.hook)||void 0===a?void 0:a.init;s(t)&&(t(e),u=e.data)}const d=e.children,h=e.sel;if("!"===h)r(e.text)&&(e.text=""),e.elm=m.createComment(e.text);else if(void 0!==h){const r=h.indexOf("#"),a=h.indexOf(".",r),p=r>0?r:h.length,v=a>0?a:h.length,g=-1!==r||-1!==a?h.slice(0,Math.min(p,v)):h,k=e.elm=s(u)&&s(l=u.ns)?m.createElementNS(l,g,u):m.createElement(g,u);for(p<v&&k.setAttribute("id",h.slice(p+1,v)),a>0&&k.setAttribute("class",h.slice(v+1).replace(/\./g," ")),l=0;l<f.create.length;++l)f.create[l](i,e);if(n(d))for(l=0;l<d.length;++l){const e=d[l];null!=e&&m.appendChild(k,b(e,t))}else o(e.text)&&m.appendChild(k,m.createTextNode(e.text));const w=e.data.hook;s(w)&&(null===(c=w.create)||void 0===c||c.call(w,i,e),w.insert&&t.push(e))}else e.elm=m.createTextNode(e.text);return e.elm}function k(e,t,n,o,r,s){for(;o<=r;++o){const r=n[o];null!=r&&m.insertBefore(e,b(r,s),t)}}function w(e){var t,n;const o=e.data;if(void 0!==o){null===(n=null===(t=null==o?void 0:o.hook)||void 0===t?void 0:t.destroy)||void 0===n||n.call(t,e);for(let t=0;t<f.destroy.length;++t)f.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const n=e.children[t];null!=n&&"string"!=typeof n&&w(n)}}}function y(e,t,n,o){for(var r,i;n<=o;++n){let o,a;const c=t[n];if(null!=c)if(s(c.sel)){w(c),o=f.remove.length+1,a=g(c.elm,o);for(let e=0;e<f.remove.length;++e)f.remove[e](c,a);const e=null===(i=null===(r=null==c?void 0:c.data)||void 0===r?void 0:r.hook)||void 0===i?void 0:i.remove;s(e)?e(c,a):a()}else m.removeChild(e,c.elm)}}function z(e,t,n){var o,i,l,u,d;const h=null===(o=t.data)||void 0===o?void 0:o.hook;null===(i=null==h?void 0:h.prepatch)||void 0===i||i.call(h,e,t);const p=t.elm=e.elm,v=e.children,g=t.children;if(e!==t){if(void 0!==t.data){for(let n=0;n<f.update.length;++n)f.update[n](e,t);null===(u=null===(l=t.data.hook)||void 0===l?void 0:l.update)||void 0===u||u.call(l,e,t)}r(t.text)?s(v)&&s(g)?v!==g&&function(e,t,n,o){let s,i,l,u,d=0,h=0,p=t.length-1,f=t[0],v=t[p],g=n.length-1,w=n[0],S=n[g];for(;d<=p&&h<=g;)null==f?f=t[++d]:null==v?v=t[--p]:null==w?w=n[++h]:null==S?S=n[--g]:a(f,w)?(z(f,w,o),f=t[++d],w=n[++h]):a(v,S)?(z(v,S,o),v=t[--p],S=n[--g]):a(f,S)?(z(f,S,o),m.insertBefore(e,f.elm,m.nextSibling(v.elm)),f=t[++d],S=n[--g]):a(v,w)?(z(v,w,o),m.insertBefore(e,v.elm,f.elm),v=t[--p],w=n[++h]):(void 0===s&&(s=c(t,d,p)),i=s[w.key],r(i)?m.insertBefore(e,b(w,o),f.elm):(l=t[i],l.sel!==w.sel?m.insertBefore(e,b(w,o),f.elm):(z(l,w,o),t[i]=void 0,m.insertBefore(e,l.elm,f.elm))),w=n[++h]);(d<=p||h<=g)&&(d>p?(u=null==n[g+1]?null:n[g+1].elm,k(e,u,n,h,g,o)):y(e,t,d,p))}(p,v,g,n):s(g)?(s(e.text)&&m.setTextContent(p,""),k(p,null,g,0,g.length-1,n)):s(v)?y(p,v,0,v.length-1):s(e.text)&&m.setTextContent(p,""):e.text!==t.text&&(s(v)&&y(p,v,0,v.length-1),m.setTextContent(p,t.text)),null===(d=null==h?void 0:h.postpatch)||void 0===d||d.call(h,e,t)}}return function(e,t){let n,o,r;const s=[];for(n=0;n<f.pre.length;++n)f.pre[n]();for(function(e){return void 0!==e.sel}(e)||(e=v(e)),a(e,t)?z(e,t,s):(o=e.elm,r=m.parentNode(o),b(t,s),null!==r&&(m.insertBefore(r,t.elm,m.nextSibling(o)),y(r,[e],0,0))),n=0;n<s.length;++n)s[n].data.hook.insert(s[n]);for(n=0;n<f.post.length;++n)f.post[n]();return t}}([m,p]);return window.Chessground=Pr,function(e){const t=document.querySelector("main.puzzle"),n=In(e,(function(){r=ts(r,Zr(n))})),o=Zr(n);t.innerHTML="";let r=ts(t,o);!function(){if("ontouchstart"in window)return;let e,t;const n=n=>{e=n.pageX,t=n.pageY};let o={};$("#topnav.hover").each((function(){const r=$(this).removeClass("hover"),s=()=>r.toggleClass("hover"),i=()=>{Math.sqrt((o.pX-e)*(o.pX-e)+(o.pY-t)*(o.pY-t))<8?(r.off(o.event,n),delete o.timeoutId,o.isActive=!0,s()):(o.pX=e,o.pY=t,o.timeoutId=setTimeout(i,200))},a=function(e){o.timeoutId&&(o.timeoutId=clearTimeout(o.timeoutId));const t=o.event="mousemove";if("mouseover"==e.type){if(o.isActive||e.buttons)return;o.pX=e.pageX,o.pY=e.pageY,r.off(t,n).on(t,n),o.timeoutId=setTimeout(i,200)}else{if(!o.isActive)return;r.off(t,n),o={},s()}};r.on("mouseover",a).on("mouseleave",a)}))}()}}();
