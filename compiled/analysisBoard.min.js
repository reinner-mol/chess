var LichessAnalyse=function(t){"use strict";const e={createElement:function(t,e){return document.createElement(t,e)},createElementNS:function(t,e,n){return document.createElementNS(t,e,n)},createTextNode:function(t){return document.createTextNode(t)},createComment:function(t){return document.createComment(t)},insertBefore:function(t,e,n){t.insertBefore(e,n)},removeChild:function(t,e){t.removeChild(e)},appendChild:function(t,e){t.appendChild(e)},parentNode:function(t){return t.parentNode},nextSibling:function(t){return t.nextSibling},tagName:function(t){return t.tagName},setTextContent:function(t,e){t.textContent=e},getTextContent:function(t){return t.textContent},isElement:function(t){return 1===t.nodeType},isText:function(t){return 3===t.nodeType},isComment:function(t){return 8===t.nodeType}};function n(t,e,n,o,r){return{sel:t,data:e,children:n,text:o,elm:r,key:void 0===e?void 0:e.key}}const o=Array.isArray;function r(t){return"string"==typeof t||"number"==typeof t}function s(t){return void 0===t}function i(t){return void 0!==t}const a=n("",{},[],void 0,void 0);function c(t,e){var n,o;const r=t.key===e.key,s=(null===(n=t.data)||void 0===n?void 0:n.is)===(null===(o=e.data)||void 0===o?void 0:o.is);return t.sel===e.sel&&r&&s}function l(t,e,n){var o;const r={};for(let s=e;s<=n;++s){const e=null===(o=t[s])||void 0===o?void 0:o.key;void 0!==e&&(r[e]=s)}return r}const d=["create","update","remove","destroy","pre","post"];function u(t,u){let h,p;const m={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},f=void 0!==u?u:e;for(h=0;h<d.length;++h)for(m[d[h]]=[],p=0;p<t.length;++p){const e=t[p][d[h]];void 0!==e&&m[d[h]].push(e)}function g(t){const e=t.id?"#"+t.id:"",o=t.className?"."+t.className.split(" ").join("."):"";return n(f.tagName(t).toLowerCase()+e+o,{},[],void 0,t)}function v(t,e){return function(){if(0==--e){const e=f.parentNode(t);f.removeChild(e,t)}}}function b(t,e){var n,c;let l,d=t.data;if(void 0!==d){const e=null===(n=d.hook)||void 0===n?void 0:n.init;i(e)&&(e(t),d=t.data)}const u=t.children,h=t.sel;if("!"===h)s(t.text)&&(t.text=""),t.elm=f.createComment(t.text);else if(void 0!==h){const n=h.indexOf("#"),s=h.indexOf(".",n),p=n>0?n:h.length,g=s>0?s:h.length,v=-1!==n||-1!==s?h.slice(0,Math.min(p,g)):h,y=t.elm=i(d)&&i(l=d.ns)?f.createElementNS(l,v,d):f.createElement(v,d);for(p<g&&y.setAttribute("id",h.slice(p+1,g)),s>0&&y.setAttribute("class",h.slice(g+1).replace(/\./g," ")),l=0;l<m.create.length;++l)m.create[l](a,t);if(o(u))for(l=0;l<u.length;++l){const t=u[l];null!=t&&f.appendChild(y,b(t,e))}else r(t.text)&&f.appendChild(y,f.createTextNode(t.text));const w=t.data.hook;i(w)&&(null===(c=w.create)||void 0===c||c.call(w,a,t),w.insert&&e.push(t))}else t.elm=f.createTextNode(t.text);return t.elm}function y(t,e,n,o,r,s){for(;o<=r;++o){const r=n[o];null!=r&&f.insertBefore(t,b(r,s),e)}}function w(t){var e,n;const o=t.data;if(void 0!==o){null===(n=null===(e=null==o?void 0:o.hook)||void 0===e?void 0:e.destroy)||void 0===n||n.call(e,t);for(let e=0;e<m.destroy.length;++e)m.destroy[e](t);if(void 0!==t.children)for(let e=0;e<t.children.length;++e){const n=t.children[e];null!=n&&"string"!=typeof n&&w(n)}}}function k(t,e,n,o){for(var r,s;n<=o;++n){let o,a;const c=e[n];if(null!=c)if(i(c.sel)){w(c),o=m.remove.length+1,a=v(c.elm,o);for(let t=0;t<m.remove.length;++t)m.remove[t](c,a);const t=null===(s=null===(r=null==c?void 0:c.data)||void 0===r?void 0:r.hook)||void 0===s?void 0:s.remove;i(t)?t(c,a):a()}else f.removeChild(t,c.elm)}}function C(t,e,n){var o,r,a,d,u;const h=null===(o=e.data)||void 0===o?void 0:o.hook;null===(r=null==h?void 0:h.prepatch)||void 0===r||r.call(h,t,e);const p=e.elm=t.elm,g=t.children,v=e.children;if(t!==e){if(void 0!==e.data){for(let n=0;n<m.update.length;++n)m.update[n](t,e);null===(d=null===(a=e.data.hook)||void 0===a?void 0:a.update)||void 0===d||d.call(a,t,e)}s(e.text)?i(g)&&i(v)?g!==v&&function(t,e,n,o){let r,i,a,d,u=0,h=0,p=e.length-1,m=e[0],g=e[p],v=n.length-1,w=n[0],x=n[v];for(;u<=p&&h<=v;)null==m?m=e[++u]:null==g?g=e[--p]:null==w?w=n[++h]:null==x?x=n[--v]:c(m,w)?(C(m,w,o),m=e[++u],w=n[++h]):c(g,x)?(C(g,x,o),g=e[--p],x=n[--v]):c(m,x)?(C(m,x,o),f.insertBefore(t,m.elm,f.nextSibling(g.elm)),m=e[++u],x=n[--v]):c(g,w)?(C(g,w,o),f.insertBefore(t,g.elm,m.elm),g=e[--p],w=n[++h]):(void 0===r&&(r=l(e,u,p)),i=r[w.key],s(i)?f.insertBefore(t,b(w,o),m.elm):(a=e[i],a.sel!==w.sel?f.insertBefore(t,b(w,o),m.elm):(C(a,w,o),e[i]=void 0,f.insertBefore(t,a.elm,m.elm))),w=n[++h]);(u<=p||h<=v)&&(u>p?(d=null==n[v+1]?null:n[v+1].elm,y(t,d,n,h,v,o)):k(t,e,u,p))}(p,g,v,n):i(v)?(i(t.text)&&f.setTextContent(p,""),y(p,null,v,0,v.length-1,n)):i(g)?k(p,g,0,g.length-1):i(t.text)&&f.setTextContent(p,""):t.text!==e.text&&(i(g)&&k(p,g,0,g.length-1),f.setTextContent(p,e.text)),null===(u=null==h?void 0:h.postpatch)||void 0===u||u.call(h,t,e)}}return function(t,e){let n,o,r;const s=[];for(n=0;n<m.pre.length;++n)m.pre[n]();for(function(t){return void 0!==t.sel}(t)||(t=g(t)),c(t,e)?C(t,e,s):(o=t.elm,r=f.parentNode(o),b(e,s),null!==r&&(f.insertBefore(r,e.elm,f.nextSibling(o)),k(r,[t],0,0))),n=0;n<s.length;++n)s[n].data.hook.insert(s[n]);for(n=0;n<m.post.length;++n)m.post[n]();return e}}function h(t,e,n){if(t.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==e)for(let t=0;t<e.length;++t){const n=e[t].data;void 0!==n&&h(n,e[t].children,e[t].sel)}}function p(t,e,s){let i,a,c,l={};if(void 0!==s?(null!==e&&(l=e),o(s)?i=s:r(s)?a=s:s&&s.sel&&(i=[s])):null!=e&&(o(e)?i=e:r(e)?a=e:e&&e.sel?i=[e]:l=e),void 0!==i)for(c=0;c<i.length;++c)r(i[c])&&(i[c]=n(void 0,void 0,void 0,i[c],void 0));return"s"!==t[0]||"v"!==t[1]||"g"!==t[2]||3!==t.length&&"."!==t[3]&&"#"!==t[3]||h(l,i,t),n(t,l,i,a,void 0)}function m(t,e){t.data.fn=e.data.fn,t.data.args=e.data.args,e.data=t.data,e.children=t.children,e.text=t.text,e.elm=t.elm}function f(t){const e=t.data;m(e.fn(...e.args),t)}function g(t,e){let n;const o=t.data,r=e.data,s=o.args,i=r.args;if(o.fn===r.fn&&s.length===i.length){for(n=0;n<i.length;++n)if(s[n]!==i[n])return void m(r.fn(...i),e);m(t,e)}else m(r.fn(...i),e)}const v=function(t,e,n,o){return void 0===o&&(o=n,n=e,e=void 0),p(t,{key:e,hook:{init:f,prepatch:g},fn:n,args:o})};function b(t,e){let n;const o=e.elm;let r=t.data.attrs,s=e.data.attrs;if((r||s)&&r!==s){for(n in r=r||{},s=s||{},s){const t=s[n];r[n]!==t&&(!0===t?o.setAttribute(n,""):!1===t?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,t):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,t):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,t):o.setAttribute(n,t))}for(n in r)n in s||o.removeAttribute(n)}}const y={create:b,update:b};function w(t,e){let n,o;const r=e.elm;let s=t.data.class,i=e.data.class;if((s||i)&&s!==i){for(o in s=s||{},i=i||{},s)s[o]&&!Object.prototype.hasOwnProperty.call(i,o)&&r.classList.remove(o);for(o in i)n=i[o],n!==s[o]&&r.classList[n?"add":"remove"](o)}}const k={create:w,update:w};function C(t,e){const n=t.substring(0,14);return p("a",{class:{"user-link":!0,ulpt:!0},attrs:{href:"/@/"+t}},e&&"BOT"!=e?[p("span.utitle",e),n]:[n])}function x(t,e){return{insert(n){n.elm.addEventListener(t,e)}}}const S={start:["hi/Hello","gl/Good luck","hf/Have fun!","u2/You too!"].map(M),end:["gg/Good game","wp/Well played","ty/Thank you","gtg/I've got to go","bye/Bye!"].map(M)};function M(t){const e=t.split("/");return{key:e[0],text:e[1]}}const P=t=>void 0!==t,E=t=>!t||0===t.length,A=t=>!E(t),T=t=>{let e=t;return function(t){return P(t)&&(e=t),e}},I={Accept:"application/vnd.lichess.v5+json"},_={cache:"no-cache",credentials:"same-origin"},O={"X-Requested-With":"XMLHttpRequest"},N=(t,e={})=>fetch(t,Object.assign(Object.assign(Object.assign({},_),{headers:Object.assign(Object.assign({},I),O)}),e)).then((t=>{if(t.ok)return t.json();throw t.statusText})),q=(t,e={})=>D(t,e).then((t=>{if(t.ok)return t.text();throw t.statusText})),D=(t,e={})=>fetch(t,Object.assign(Object.assign(Object.assign({},_),{headers:Object.assign({},O)}),e)),L=t=>{const e=new FormData;for(const n of Object.keys(t))e.append(n,t[n]);return e},R=(t,e)=>{const n=new URLSearchParams;for(const t of Object.keys(e))P(e[t])&&n.append(t,e[t]);const o=n.toString();return o?`${t}?${o}`:t},j=t=>q(F(t)),F=t=>`/${t}/note`;function B(t,e,n=!1){let o,r=0;return function(...s){const i=this;o&&clearTimeout(o),o=void 0;const a=performance.now()-r;r=performance.now(),n&&a>e?t.apply(i,s):o=setTimeout((()=>{o=void 0,t.apply(i,s)}),e)}}function G(t){let e=t.text;const n=B((()=>{((t,e)=>{N(F(t),{method:"post",body:L({text:e})})})(t.id,e||"")}),1e3);return{id:t.id,trans:t.trans,text:()=>e,fetch(){j(t.id).then((n=>{e=n||"",t.redraw()}))},post(t){e=t,n()}}}function z(t){const e=t.text();return null==e?p("div.loading",{hook:{insert:t.fetch}}):p("textarea",{attrs:{placeholder:t.trans("typePrivateNotesHere")},hook:{insert(n){const o=$(n.elm);o.val(e).on("change keyup paste",(()=>t.post(o.val())))}}})}let V=!1;const W=t=>(!1===V&&(V=window.Intl&&Intl.NumberFormat?new Intl.NumberFormat:null),null===V?""+t:V.format(t));function H(t){let e,n=!1;const o=()=>{e=void 0,n=!1,t.redraw()};return{loading:()=>n,data:()=>e,reasons:t.reasons,permissions:()=>t.permissions,open:o=>{const r=o.querySelector("a.user-link"),s=o.querySelector("t").innerText,i=r.href.split("/")[4];t.permissions.timeout?(n=!0,(t=>N("/mod/chat-user/"+t))(i).then((o=>{e=Object.assign(Object.assign({},o),{text:s}),n=!1,t.redraw()}))):e={id:i.toLowerCase(),username:i,text:s},t.redraw()},close:o,timeout(n,r){e&&lichess.pubsub.emit("socket.send","timeout",{userId:e.id,reason:n.key,text:r}),o(),t.redraw()}}}const U=()=>p("i.mod",{attrs:{"data-icon":""}});function K(t,e){const n=t.data;n.domVersion=1;const o={instance:void 0,loaded:!1,enabled:T(!!n.palantir)},r=["discussion"];t.noteId&&r.push("note"),t.plugin&&r.push(t.plugin.tab.key);const s=lichess.storage.make("chat.tab"),i=s.get();let a;const c={tab:r.find((t=>t===i))||r[0],enabled:t.alwaysEnabled||!lichess.storage.get("nochat"),placeholderKey:"talkInChat",loading:!1,timeout:t.timeout,writeable:t.writeable};r.length>1&&"discussion"===c.tab&&lichess.storage.get("nochat")&&(c.tab=r[1]);const l=t=>!!(t=t.trim())&&(!("You too!"==t&&!n.lines.some((t=>t.u!=n.userId)))&&(t.length>140?(alert("Max length: 140 chars. "+t.length+" chars used."),!1):(lichess.pubsub.emit("socket.send","talk",t),!0))),d=lichess.trans(t.i18n);function u(){(t.permissions.timeout||t.permissions.local)&&(a=H({reasons:t.timeoutReasons||[{key:"other",name:"Inappropriate behavior"}],permissions:t.permissions,redraw:e}),t.loadCss("chat.mod"))}u();const h=t.noteId?G({id:t.noteId,text:t.noteText,trans:d,redraw:e}):void 0,p=function(t){let e=t.initialGroup,n=[];return{group:()=>e,said:()=>n,setGroup(o){o!==e&&(e=o,o||(n=[]),t.redraw())},post(o){e&&S[e]&&(n.includes(o.key)||t.post(o.text)&&n.push(o.key))}}}({initialGroup:t.preset,post:l,redraw:e}),m=[["socket.in.message",t=>{n.lines.push(t);const o=n.lines.length;o>200&&(n.lines.splice(0,o-200+50),n.domVersion++),e()}],["socket.in.chat_timeout",t=>{let o=!1;n.lines.forEach((e=>{e.u&&e.u.toLowerCase()==t&&(e.d=!0,o=!0)})),t==n.userId&&(c.timeout=o=!0),o&&(n.domVersion++,e())}],["socket.in.chat_reinstate",t=>{t==n.userId&&(c.timeout=!1,e())}],["chat.writeable",t=>{c.writeable=t,e()}],["chat.permissions",n=>{let o;for(o in n)t.permissions[o]=n[o];u(),e()}],["palantir.toggle",o.enabled]];m.forEach((([t,e])=>lichess.pubsub.on(t,e)));const f=()=>lichess.pubsub.emit("chat.enabled",c.enabled);return f(),{data:n,opts:t,vm:c,allTabs:r,setTab(t){c.tab=t,s.set(t),"discussion"===t&&lichess.requestIdleCallback((()=>$(".mchat__say").each((function(){this.focus()}))),500),e()},moderation:()=>a,note:h,preset:p,post:l,trans:d,plugin:t.plugin,setEnabled(t){c.enabled=t,f(),t?lichess.storage.remove("nochat"):lichess.storage.set("nochat","1"),e()},redraw:e,palantir:o,destroy:()=>{m.forEach((([t,e])=>lichess.pubsub.off(t,e)))}}}const J=/(^|[\s\n]|<[A-Za-z]*\/?>)((?:(?:https?|ftp):\/\/|lichess\.org)[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~()_|])/gi,X=/\n/g,Y=/(^|[^\w@#/])@([a-z0-9][a-z0-9_-]{0,28}[a-z0-9])/gi;function Q(t){return`<a target="_blank" rel="nofollow noopener noreferrer" href="${t}">${t.replace(/https?:\/\//,"")}</a>`}function Z(t,e){return{insert(n){n.elm.innerHTML=e(t),n.data.cachedA=t},postpatch(n,o){n.data.cachedA!==t&&(o.elm.innerHTML=e(t)),o.data.cachedA=t}}}function tt(t,e,n){return t.includes("&quot;")?t:`<a target="_blank" rel="noopener nofollow noreferrer" href="${t.startsWith("/")||t.includes("://")?t:"//"+t}"${n?` class="${n}"`:""}>${e||t}</a>`}function et(t,e=!0){let n=(o=lichess.escapeHtml(t),r=Q,o.replace(J,((t,e,n)=>e+r(n))));var o,r;return e&&(n=n.replace(X,"<br>")),n}function nt(t,e=!0){return Z(t,(t=>et(t,e)))}const ot=/\b\b(?:https?:\/\/)?(lichess\.org\/[-–—\w+&'@#\/%?=()~|!:,.;]+[\w+&@#\/%=~|])/gi,rt=/^[a-h][2-7]$/,st=/\b(\d+)\s*(\.+)\s*(?:[o0-]+[o0]|[NBRQKP\u2654\u2655\u2656\u2657\u2658\u2659]?[a-h]?[1-8]?[x@]?[a-z][1-8](?:=[NBRQK\u2654\u2655\u2656\u2657\u2658\u2659])?)\+?#?[!\?=]{0,5}/gi;function it(t,e,n){if(e<1||e>200)return t;return'<a class="jump" data-ply="'+(2*e-(n.length>1?0:1))+'">'+t+"</a>"}function at(t,e,n){return n.match(rt)?t:function(t,e,n){return e+tt("/@/"+n,"@"+n)}(0,e,n)}function ct(t,e){const n=lichess.escapeHtml(t),o=n.replace(Y,at).replace(ot,tt);return e&&o===n?o.replace(st,it):o}const lt=()=>"1"==lichess.storage.get("chat-spam"),dt=new RegExp(["xcamweb.com","(^|[^i])chess-bot","chess-cheat","coolteenbitch","letcafa.webcam","tinyurl.com/","wooga.info/","bit.ly/","wbt.link/","eb.by/","001.rs/","shr.name/","u.to/",".3-a.net",".ssl443.org",".ns02.us",".myftp.info",".flinkup.com",".serveusers.com","badoogirls.com","hide.su","wyon.de","sexdatingcz.club","qps.ru","tiny.cc/"].map((t=>t.replace(/\./g,"\\.").replace(/\//g,"\\/"))).join("|")),ut=t=>!!t.match(dt),ht=/follow me|join my team/i,pt=t=>!!t.match(ht),mt=/lichess\.org\/team\//i,ft=/^\/[wW](?:hisper)?\s/;function gt(t){if(!t.vm.enabled)return[];const e=e=>{const n=e.elm;if(t.data.lines.length>5){(0===n.scrollTop||n.scrollTop>n.scrollHeight-n.clientHeight-100)&&(n.scrollTop=999999,setTimeout((t=>n.scrollTop=999999),300))}},n=!!t.moderation(),o=[p("ol.mchat__messages.chat-v-"+t.data.domVersion,{attrs:{role:"log","aria-live":"polite","aria-atomic":"false"},hook:{insert(o){const r=$(o.elm).on("click","a.jump",(t=>{lichess.pubsub.emit("jump",t.target.getAttribute("data-ply"))}));n?r.on("click",".mod",(e=>{var n;return null===(n=t.moderation())||void 0===n?void 0:n.open(e.target.parentNode)})):r.on("click",".flag",(e=>function(t,e){const n=e.querySelector("a.user-link"),o=e.querySelector("t").innerText;n&&confirm(`Report "${o}" to moderators?`)&&((t,e,n)=>{N("/report/flag",{method:"post",body:L({username:e,resource:t,text:n})})})(t.data.resourceId,n.href.split("/")[4],o)}(t,e.target.parentNode))),e(o)},postpatch:(t,n)=>e(n)}},wt(t).map((e=>function(t,e){const n=function(t,e){if(n=t,/(\n|(@|#|\.)\w{2,})/.test(n)){const n=function(t){return(e,n)=>{n.data.lichessChat!==e.data.lichessChat&&(n.elm.innerHTML=ct(n.data.lichessChat,t))}}(e);return p("t",{lichessChat:t,hook:{create:n,update:n}})}var n;return p("t",t)}(e.t,t.opts.parseMoves);if("lichess"===e.u)return p("li.system",n);if(e.c)return p("li",[p("span.color","["+e.c+"]"),n]);const o=v("a",e.u,C,[e.u,e.title]);return p("li",t.moderation()?[e.u?U():null,o," ",n]:[t.data.userId&&e.u&&t.data.userId!=e.u?p("i.flag",{attrs:{"data-icon":"!",title:"Report"}}):null,o," ",n])}(t,e)))),vt(t)],r=function(t){const e=t.group();if(!e)return;const n=S[e],o=t.said();return n&&o.length<2?p("div.mchat__presets",n.map((e=>{const n=o.includes(e.key);return p("span",{class:{disabled:n},attrs:{title:e.text,disabled:n},hook:x("click",(()=>{!n&&t.post(e)}))},e.key)}))):void 0}(t.preset);return r&&o.push(r),o}function vt(t){if(!t.vm.writeable)return;if(t.data.loginRequired&&!t.data.userId||t.data.restricted)return p("input.mchat__say",{attrs:{placeholder:t.trans("loginToChat"),disabled:!0}});let e;return e=t.vm.timeout?t.trans("youHaveBeenTimedOut"):t.opts.blind?"Chat":t.trans.noarg(t.vm.placeholderKey),p("input.mchat__say",{attrs:{placeholder:e,autocomplete:"off",maxlength:140,disabled:t.vm.timeout||!t.vm.writeable,"aria-label":"Chat input"},hook:{insert(e){yt(t,e.elm)}}})}let bt;const yt=(t,e)=>{const n=lichess.tempStorage.make("chat.input"),o=n.get();o&&(e.value=o,e.focus(),!t.opts.public&&o.match(ft)&&e.classList.add("whisper")),e.addEventListener("keydown",(e=>{"Enter"===e.key&&setTimeout((()=>{const o=e.target,r=o.value,s=t.opts.public;""===r?$(".keyboard-move input").each((function(){this.focus()})):(t.opts.kobold||(t=>{if(lt())return;const e=ut(t);e&&q(`/jslog/${window.location.href.substr(-12)}?n=spam`,{method:"post"}),(e||pt(t))&&lichess.storage.set("chat-spam","1")})(r),s&&(t=>!!t.match(mt))(r)?alert("Please don't advertise teams in the chat."):t.post(r),o.value="",n.remove(),s||o.classList.remove("whisper"))}))})),e.addEventListener("input",(e=>setTimeout((()=>{const o=e.target,r=o.value;o.removeAttribute("placeholder"),t.opts.public||o.classList.toggle("whisper",!!r.match(ft)),n.set(r)})))),window.Mousetrap.bind("c",(()=>e.focus()));const r=["touchstart","mousedown"];bt&&r.forEach((t=>document.body.removeEventListener(t,bt,{capture:!0}))),bt=t=>{t.shiftKey||2===t.buttons||2===t.button||e.blur()},e.onfocus=()=>r.forEach((t=>document.body.addEventListener(t,bt,{passive:!0,capture:!0}))),e.onblur=()=>r.forEach((t=>document.body.removeEventListener(t,bt,{capture:!0})))};function wt(t){const e=[];let n;return t.data.lines.forEach((o=>{var r,s,i;o.d||n&&(i=o,(s=n).d&&i.d&&s.u===i.u)||o.r&&(o.u||"").toLowerCase()!=t.data.userId||(r=o.t,(ut(r)||pt(r))&&!lt())||e.push(o),n=o})),e}function kt(t){const e=t.moderation();return p("section.mchat"+(t.opts.alwaysEnabled?"":".mchat-optional"),{class:{"mchat-mod":!!e},hook:{destroy:t.destroy}},function(t){if(!t)return;if(t.loading())return[p("div.loading")];const e=t.data();if(!e)return;const n=t.permissions(),o=e.history?p("div.infos.block",[W(e.games||0)+" games",e.troll?"TROLL":void 0,e.engine?"ENGINE":void 0,e.booster?"BOOSTER":void 0].map((t=>t&&p("span",t))).concat([p("a",{attrs:{href:"/@/"+e.username+"?mod"}},"profile")]).concat(n.shadowban?[p("a",{attrs:{href:"/mod/"+e.username+"/communication"}},"coms")]:[])):void 0,r=n.timeout?p("div.timeout.block",[p("strong","Timeout 15 minutes for"),...t.reasons.map((n=>p("a.text",{attrs:{"data-icon":"p"},hook:x("click",(()=>t.timeout(n,e.text)))},n.name)))]):p("div.timeout.block",[p("strong","Moderation"),p("a.text",{attrs:{"data-icon":"p"},hook:x("click",(()=>t.timeout(t.reasons[0],e.text)))},"Timeout 15 minutes")]),s=e.history?p("div.history.block",[p("strong","Timeout history"),p("table",p("tbody.slist",{hook:{insert(){lichess.contentLoaded()}}},e.history.map((function(t){return p("tr",[p("td.reason",t.reason),p("td.mod",t.mod),p("td",p("time.timeago",{attrs:{datetime:t.date}}))])}))))]):void 0;return[p("div.top",{key:"mod-"+e.id},[p("span.text",{attrs:{"data-icon":""}},[C(e.username)]),p("a",{attrs:{"data-icon":"L"},hook:x("click",t.close)})]),p("div.mchat__content.moderation",[p("i.line-text.block",['"',e.text,'"']),o,r,s])]}(e)||function(t){const e=t.vm.tab;return[p("div.mchat__tabs.nb_"+t.allTabs.length,[...t.allTabs.map((n=>function(t,e,n){return p("div.mchat__tab."+e,{class:{"mchat__tab-active":e===n},hook:x("click",(()=>t.setTab(e)))},function(t,e){return"discussion"===e?[p("span",t.data.name),t.opts.alwaysEnabled?void 0:p("input",{attrs:{type:"checkbox",title:t.trans.noarg("toggleTheChat"),checked:t.vm.enabled},hook:x("change",(e=>{t.setEnabled(e.target.checked)}))})]:"note"===e?[p("span",t.trans.noarg("notes"))]:t.plugin&&e===t.plugin.tab.key?[p("span",t.plugin.tab.name)]:[]}(t,e))}(t,n,e))),Ct(t)]),p("div.mchat__content."+e,"note"===e&&t.note?[z(t.note)]:t.plugin&&e===t.plugin.tab.key?[t.plugin.view()]:gt(t))]}(t))}function Ct(t){const e=t.palantir;if(e.enabled())return e.instance?e.instance.render(p):p("div.mchat__tab.palantir.palantir-slot",{attrs:{"data-icon":"",title:"Voice chat"},hook:x("click",(()=>{e.loaded||(e.loaded=!0,lichess.loadScript("javascripts/vendor/peerjs.min.js").then((()=>{lichess.loadModule("palantir").then((()=>{e.instance=window.Palantir.palantir({uid:t.data.userId,redraw:t.redraw}),t.redraw()}))})))}))})}const xt={a:"a1",b:"b1",c:"c1",d:"d1",e:"e1",f:"f1",g:"g1",h:"h1",i:"a2",j:"b2",k:"c2",l:"d2",m:"e2",n:"f2",o:"g2",p:"h2",q:"a3",r:"b3",s:"c3",t:"d3",u:"e3",v:"f3",w:"g3",x:"h3",y:"a4",z:"b4",A:"c4",B:"d4",C:"e4",D:"f4",E:"g4",F:"h4",G:"a5",H:"b5",I:"c5",J:"d5",K:"e5",L:"f5",M:"g5",N:"h5",O:"a6",P:"b6",Q:"c6",R:"d6",S:"e6",T:"f6",U:"g6",V:"h6",W:"a7",X:"b7",Y:"c7",Z:"d7",0:"e7",1:"f7",2:"g7",3:"h7",4:"a8",5:"b8",6:"c8",7:"d8",8:"e8",9:"f8","!":"g8","?":"h8"};function St(t){return"P"===t[0]?t.slice(1):t}function Mt(t){return null==t?null:t.match(/.{2}/g)||[]}const Pt={e1a1:"e1c1",e1h1:"e1g1",e8a8:"e8c8",e8h8:"e8g8"},Et=25,At=30;const Tt=t=>t.game.status.id<Et&&!It(t),It=t=>"import"===t.game.source,_t=t=>It(t)||function(t){return t.game.status.id>=At}(t)||function(t){return t.game.status.id===Et}(t)&&(t=>(t=>t.game.turns-(t.game.startedAtTurn||0))(t)>1)(t);function Ot(t,e){return t.player.color===e?t.player:t.opponent.color===e?t.opponent:null}function $t(t){return t.slice(0,2)}function Nt(t){return t.slice(2)}function qt(t){return t.slice(0,-2)}function Dt(t,e){return t.startsWith(e)}function Lt(t){let e="";for(const n in t)e+=t[n].id;return e}function Rt(t,e){const n=t.children[0];return n?e(n):void 0}function jt(t,e){const n=function(t){return e(t)?t:Rt(t,n)};return n(t)}function Ft(t,e){const n=[t];let o,r=t;for(;o=e(r);)n.push(o),r=o;return n}function Bt(t){return t.children[0]}function Gt(t,e){return t.children.find((t=>t.id===e))}function zt(t){return t[t.length-1]}function Vt(t,e){let n="";for(const o in t){if(!e(t[o]))break;n+=t[o].id}return n}function Wt(t,e){t.children=t.children.filter((function(t){return t.id!==e}))}function Ht(t){const e={nodes:1,comments:(t.comments||[]).length};return t.children.forEach((function(t){const n=Ht(t);e.nodes+=n.nodes,e.comments+=n.comments})),e}function Ut(t,e){t.eval=e.eval,e.glyphs&&(t.glyphs=e.glyphs),e.comments&&e.comments.forEach((function(e){t.comments?t.comments.some((function(t){return t.text===e.text}))||t.comments.push(e):t.comments=[e]})),e.children.forEach((function(e){const n=Gt(t,e.id);n?Ut(n,e):t.children.push(e)}))}function Kt(t,e){return e<=0||!!t.children[1]||t.children[0]&&Kt(t.children[0],e-1)}function Jt(t){return Ft(t,Bt)}function Xt(t,e){!function t(n){e(n),n.children.forEach(t)}(t)}function Yt(t){function e(e){return n(t,e)}function n(t,e){if(""===e)return t;const o=Gt(t,$t(e));return o?n(o,Nt(e)):t}function o(e){return r(t,e)}function r(t,e){if(""===e)return t;const n=Gt(t,$t(e));return n?r(n,Nt(e)):void 0}function s(t,e){const n=$t(e),o=Gt(t,n);return o?n+s(o,Nt(e)):""}function i(t,e){if(""===e)return!0;const n=$t(e),o=t.children[0];return!(!o||o.id!==n)&&i(o,Nt(e))}function a(t,e){if(""===e)return t;const n=$t(e),o=t.children[0];return o&&o.id===n?a(o,Nt(e)):t}function c(e){return Ft(t,(function(t){const n=$t(e);if(""!==n)return e=Nt(e),Gt(t,n)}))}function l(t,e){const n=o(t);if(n)return e(n),n}function d(t,e){const n=e+t.id,r=o(n);return r?(["dests","drops","clock"].forEach((e=>{P(t[e])&&!P(r[e])&&(r[e]=t[e])})),n):l(e,(function(e){e.children.push(t)}))?n:void 0}function u(t,e){return l(e,(function(e){const n=(e.comments||[]).filter((function(e){return e.id!==t}));e.comments=n.length?n:void 0}))}function h(t){return e(qt(t))}return{root:t,lastPly(){var e;return(null===(e=jt(t,(t=>!t.children.length)))||void 0===e?void 0:e.ply)||t.ply},nodeAtPath:e,getNodeList:c,longestValidPath:e=>s(t,e),updateAt:l,addNode:d,addNodes:function t(e,n){const o=e[0];if(!o)return n;const r=d(o,n);return r?t(e.slice(1),r):void 0},addDests:(t,e)=>l(e,(function(e){e.dests=t})),setShapes:(t,e)=>l(e,(function(e){e.shapes=t})),setCommentAt:function(t,e){return t.text?l(e,(function(e){e.comments=e.comments||[];const n=e.comments.find((function(e){return e.id===t.id}));n?n.text=t.text:e.comments.push(t)})):u(t.id,e)},deleteCommentAt:u,setGlyphsAt:function(t,e){return l(e,(function(e){e.glyphs=t}))},setClockAt:(t,e)=>l(e,(function(e){e.clock=t})),pathIsMainline:function(e){return i(t,e)},pathIsForcedVariation:function(t){return!!c(t).find((t=>t.forceVariation))},lastMainlineNode:e=>a(t,e),pathExists:function(t){return!!o(t)},deleteNodeAt:function(t){Wt(h(t),function(t){return t.slice(-2)}(t))},promoteAt:function(t,e){const n=c(t);for(let t=n.length-2;t>=0;t--){const o=n[t+1],r=n[t];if(r.children[0].id!==o.id){if(Wt(r,o.id),r.children.unshift(o),!e)break}else if(o.forceVariation&&(o.forceVariation=!1,!e))break}},forceVariationAt:(t,e)=>l(t,(function(t){t.forceVariation=e})),getCurrentNodesAfterPly:function(t,e,n){const o=[];for(const r in t){const s=t[r];if(s.ply<=n&&e[r].id!==s.id)break;s.ply>n&&o.push(s)}return o},merge(e){Ut(t,e)},removeCeval(){Xt(t,(function(t){delete t.ceval,delete t.threat}))},removeComputerVariations(){Jt(t).forEach((function(t){t.children=t.children.filter((function(t){return!t.comp}))}))},parentNode:h,getParentClock:function(t,e){if(!("parentClock"in t)){const n=e&&h(e);t.parentClock=n?"clock"in n?n.clock:void 0:t.clock}return t.parentClock}}}function Qt(t){return t.node.children.length>0}function Zt(t){const e=t.node.children[0];e&&t.userJumpIfCan(t.path+e.id)}function te(t){t.userJumpIfCan(qt(t.path))}function ee(t){t.userJumpIfCan(Lt(t.mainline))}function ne(t){t.userJump("")}function oe(t){const e=t.node.children[1];e&&t.userJump(t.path+e.id)}function re(t){if(t.onMainline)return;let e,n="";t.nodeList.slice(1,-1).forEach((function(t){n+=t.id,t.children[1]&&(e=n)})),e&&t.userJump(e)}var se=Object.freeze({__proto__:null,canGoForward:Qt,next:Zt,prev:te,last:ee,first:ne,enterVariation:oe,exitVariation:re});const ie="button.button.button-red.button-empty";function ae(t,e,n){return le((o=>function(t,e,n,o){t.addEventListener(e,(t=>{const e=n(t);return!1===e&&t.preventDefault(),o&&o(),e}))}(o,t,e,n)))}function ce(t,e){return ae("submit",(e=>(e.preventDefault(),t(e))),e)}function le(t){return{insert:e=>t(e.elm)}}function de(t){return function(){return t}}function ue(t){return{"data-icon":t}}function he(t){return p("i",{attrs:ue(t)})}function pe(t){return t.san?(e=t.ply,Math.floor((e-1)/2)+1+(t.ply%2==1?".":"...")+" "+St(t.san)):"Initial position";var e}function me(t,e){return e+" "+(1===e?t:t+"s")}function fe(t){const e=t.split(" ");return(1===e.length?e[0]:e[1]).toLowerCase()}function ge(){return p("div.spinner",[p("svg",{attrs:{viewBox:"0 0 40 40"}},[p("circle",{attrs:{cx:20,cy:20,r:18,fill:"none"}})])])}function ve(){return`${window.location.protocol}//${window.location.host}`}function be(t,e,n){return p("option",{attrs:{value:t,selected:t===e}},n)}function ye(t,e){t&&e&&(t.scrollTop=e.offsetTop-t.offsetHeight/2+e.offsetHeight/2)}function we(t){return p("div#modal-overlay",Object.assign({},t.noClickAway?{}:{hook:ae("mousedown",t.onClose)}),[p("div#modal-wrap.study__modal."+t.class,{hook:le((e=>{e.addEventListener("mousedown",(t=>t.stopPropagation())),t.onInsert&&t.onInsert(e)}))},[p("span.close",{attrs:{"data-icon":"L"},hook:ae("click",t.onClose)}),p("div",t.content)])])}function ke(t){return p("div.form-actions.single",p("button.button",{attrs:{type:"submit"}},t))}const Ce=t=>{const e=window.Mousetrap;if(e&&(e.bind(["left","k"],(()=>{te(t),t.redraw()})).bind(["shift+left","shift+k"],(()=>{re(t),t.redraw()})).bind(["right","j"],(()=>{t.fork.proceed()||Zt(t),t.redraw()})).bind(["shift+right","shift+j"],(()=>{oe(t),t.redraw()})).bind(["up","0"],(()=>{t.fork.prev()||ne(t),t.redraw()})).bind(["down","$"],(()=>{t.fork.next()||ee(t),t.redraw()})).bind("shift+c",(()=>{t.showComments=!t.showComments,t.autoScroll(),t.redraw()})).bind("shift+i",(()=>{t.treeView.toggle(),t.redraw()})).bind("z",(()=>{t.toggleComputer(),t.redraw()})),!t.embed&&(e.bind("space",(()=>{const e=t.gamebookPlay();if(e)e.onSpace();else{if(t.studyPractice)return;t.ceval.enabled()?t.playBestMove():t.toggleCeval()}})),!t.studyPractice&&(e.bind("f",t.flip).bind("?",(()=>{t.keyboardHelp=!t.keyboardHelp,t.redraw()})).bind("l",t.toggleCeval).bind("a",(()=>{t.toggleAutoShapes(!t.showAutoShapes()),t.redraw()})).bind("x",t.toggleThreatMode).bind("e",(()=>{t.toggleExplorer(),t.redraw()})),t.study)))){const n=(t,n)=>{e.bind(t,(()=>{$(n).each((function(){this.dispatchEvent(new Event("mousedown"))}))}))};n("d",".study__buttons .comments"),n("g",".study__buttons .glyphs"),e.bind("p",t.study.goToPrevChapter),e.bind("n",t.study.goToNextChapter)}};function xe(t){return we({class:"keyboard-help",onInsert(e){lichess.loadCssPath("analyse.keyboard"),q(R("/analysis/help",{study:!!t.study})).then((t=>{e.querySelector(".scrollable").innerHTML=t}))},onClose(){t.keyboardHelp=!1,t.redraw()},content:[p("div.scrollable",ge())]})}const Se=["white","black"],Me=["a","b","c","d","e","f","g","h"],Pe=["1","2","3","4","5","6","7","8"],Ee=[...Pe].reverse(),Ae=Array.prototype.concat(...Me.map((t=>Pe.map((e=>t+e))))),Te=t=>Ae[8*t[0]+t[1]],Ie=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],_e=Ae.map(Ie);const Oe=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},$e=t=>"white"===t?"black":"white",Ne=(t,e)=>{const n=t[0]-e[0],o=t[1]-e[1];return n*n+o*o},qe=(t,e)=>t.role===e.role&&t.color===e.color,De=(t,e,n,o)=>[(e?t[0]:7-t[0])*n,(e?7-t[1]:t[1])*o],Le=t=>{const e=t.width/8,n=t.height/8;return(t,o)=>De(t,o,e,n)},Re=(t,e)=>De(t,e,100,100),je=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},Fe=(t,e)=>{t.style.transform=`translate(${e[0]}%,${e[1]}%)`},Be=(t,e)=>{t.style.visibility=e?"visible":"hidden"},Ge=t=>{var e;return t.clientX||0===t.clientX?[t.clientX,t.clientY]:(null===(e=t.targetTouches)||void 0===e?void 0:e[0])?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:void 0},ze=t=>2===t.buttons||2===t.button,Ve=(t,e)=>{const n=document.createElement(t);return e&&(n.className=e),n};function We(t,e,n){const o=Ie(t);return e||(o[0]=7-o[0],o[1]=7-o[1]),[n.left+n.width*o[0]/8+n.width/16,n.top+n.height*(7-o[1])/8+n.height/16]}function He(t,e){return Math.abs(t-e)}const Ue=(t,e,n,o)=>{const r=He(t,n),s=He(e,o);return 1===r&&2===s||2===r&&1===s},Ke=(t,e,n,o)=>He(t,n)===He(e,o),Je=(t,e,n,o)=>t===n||e===o,Xe=(t,e,n,o)=>Ke(t,e,n,o)||Je(t,e,n,o);function Ye(t,e,n){const o=t.get(e);if(!o)return[];const r=Ie(e),s=o.role,i="pawn"===s?(a=o.color,(t,e,n,o)=>He(t,n)<2&&("white"===a?o===e+1||e<=1&&o===e+2&&t===n:o===e-1||e>=6&&o===e-2&&t===n)):"knight"===s?Ue:"bishop"===s?Ke:"rook"===s?Je:"queen"===s?Xe:function(t,e,n){return(o,r,s,i)=>He(o,s)<2&&He(r,i)<2||n&&r===i&&r===("white"===t?0:7)&&(4===o&&(2===s&&e.includes(0)||6===s&&e.includes(7))||e.includes(s))}(o.color,function(t,e){const n="white"===e?"1":"8",o=[];for(const[r,s]of t)r[1]===n&&s.color===e&&"rook"===s.role&&o.push(Ie(r)[0]);return o}(t,o.color),n);var a;return _e.filter((t=>(r[0]!==t[0]||r[1]!==t[1])&&i(r[0],r[1],t[0],t[1]))).map(Te)}function Qe(t,...e){t&&setTimeout((()=>t(...e)),1)}function Ze(t){t.premovable.current&&(t.premovable.current=void 0,Qe(t.premovable.events.unset))}function tn(t){const e=t.predroppable;e.current&&(e.current=void 0,Qe(e.events.unset))}function en(t,e,n){const o=t.pieces.get(e),r=t.pieces.get(n);if(e===n||!o)return!1;const s=r&&r.color!==o.color?r:void 0;return n===t.selected&&ln(t),Qe(t.events.move,e,n,s),function(t,e,n){if(!t.autoCastle)return!1;const o=t.pieces.get(e);if(!o||"king"!==o.role)return!1;const r=Ie(e),s=Ie(n);if(0!==r[1]&&7!==r[1]||r[1]!==s[1])return!1;4!==r[0]||t.pieces.has(n)||(6===s[0]?n=Te([7,s[1]]):2===s[0]&&(n=Te([0,s[1]])));const i=t.pieces.get(n);return!(!i||i.color!==o.color||"rook"!==i.role||(t.pieces.delete(e),t.pieces.delete(n),r[0]<s[0]?(t.pieces.set(Te([6,s[1]]),o),t.pieces.set(Te([5,s[1]]),i)):(t.pieces.set(Te([2,s[1]]),o),t.pieces.set(Te([3,s[1]]),i)),0))}(t,e,n)||(t.pieces.set(n,o),t.pieces.delete(e)),t.lastMove=[e,n],t.check=void 0,Qe(t.events.change),s||!0}function nn(t,e,n,o){if(t.pieces.has(n)){if(!o)return!1;t.pieces.delete(n)}return Qe(t.events.dropNewPiece,e,n),t.pieces.set(n,e),t.lastMove=[n],t.check=void 0,Qe(t.events.change),t.movable.dests=void 0,t.turnColor=$e(t.turnColor),!0}function on(t,e,n){const o=en(t,e,n);return o&&(t.movable.dests=void 0,t.turnColor=$e(t.turnColor),t.animation.current=void 0),o}function rn(t,e,n){if(un(t,e,n)){const o=on(t,e,n);if(o){const r=t.hold.stop();ln(t);const s={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:r};return!0!==o&&(s.captured=o),Qe(t.movable.events.after,e,n,s),!0}}else if(function(t,e,n){return e!==n&&hn(t,e)&&Ye(t.pieces,e,t.premovable.castle).includes(n)}(t,e,n))return function(t,e,n,o){tn(t),t.premovable.current=[e,n],Qe(t.premovable.events.set,e,n,o)}(t,e,n,{ctrlKey:t.stats.ctrlKey}),ln(t),!0;return ln(t),!1}function sn(t,e,n,o){const r=t.pieces.get(e);r&&(function(t,e,n){const o=t.pieces.get(e);return!(!o||e!==n&&t.pieces.has(n)||"both"!==t.movable.color&&(t.movable.color!==o.color||t.turnColor!==o.color))}(t,e,n)||o)?(t.pieces.delete(e),nn(t,r,n,o),Qe(t.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&function(t,e,n){const o=t.pieces.get(e),r=t.pieces.get(n);return!!o&&(!r||r.color!==t.movable.color)&&t.predroppable.enabled&&("pawn"!==o.role||"1"!==n[1]&&"8"!==n[1])&&t.movable.color===o.color&&t.turnColor!==o.color}(t,e,n)?function(t,e,n){Ze(t),t.predroppable.current={role:e,key:n},Qe(t.predroppable.events.set,e,n)}(t,r.role,n):(Ze(t),tn(t)),t.pieces.delete(e),ln(t)}function an(t,e,n){if(Qe(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled)return ln(t),void t.hold.cancel();if((t.selectable.enabled||n)&&t.selected!==e&&rn(t,t.selected,e))return void(t.stats.dragged=!1)}(dn(t,e)||hn(t,e))&&(cn(t,e),t.hold.start())}function cn(t,e){t.selected=e,hn(t,e)?t.premovable.dests=Ye(t.pieces,e,t.premovable.castle):t.premovable.dests=void 0}function ln(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function dn(t,e){const n=t.pieces.get(e);return!!n&&("both"===t.movable.color||t.movable.color===n.color&&t.turnColor===n.color)}function un(t,e,n){var o,r;return e!==n&&dn(t,e)&&(t.movable.free||!!(null===(r=null===(o=t.movable.dests)||void 0===o?void 0:o.get(e))||void 0===r?void 0:r.includes(n)))}function hn(t,e){const n=t.pieces.get(e);return!!n&&t.premovable.enabled&&t.movable.color===n.color&&t.turnColor!==n.color}function pn(t){const e=t.premovable.current;if(!e)return!1;const n=e[0],o=e[1];let r=!1;if(un(t,n,o)){const e=on(t,n,o);if(e){const s={premove:!0};!0!==e&&(s.captured=e),Qe(t.movable.events.after,n,o,s),r=!0}}return Ze(t),r}function mn(t){Ze(t),tn(t),ln(t)}function fn(t){t.movable.color=t.movable.dests=t.animation.current=void 0,mn(t)}function gn(t,e,n){let o=Math.floor(8*(t[0]-n.left)/n.width);e||(o=7-o);let r=7-Math.floor(8*(t[1]-n.top)/n.height);return e||(r=7-r),o>=0&&o<8&&r>=0&&r<8?Te([o,r]):void 0}function vn(t){return"white"===t.orientation}const bn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",yn={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},wn={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function kn(t){"start"===t&&(t=bn);const e=new Map;let n=7,o=0;for(const r of t)switch(r){case" ":return e;case"/":if(--n,n<0)return e;o=0;break;case"~":{const t=e.get(Te([o,n]));t&&(t.promoted=!0);break}default:{const t=r.charCodeAt(0);if(t<57)o+=t-48;else{const t=r.toLowerCase();e.set(Te([o,n]),{role:yn[t],color:r===t?"black":"white"}),++o}}}return e}function Cn(t,e){var n,o;if((null===(n=e.movable)||void 0===n?void 0:n.dests)&&(t.movable.dests=void 0),(null===(o=e.drawable)||void 0===o?void 0:o.autoShapes)&&(t.drawable.autoShapes=[]),xn(t,e),e.fen&&(t.pieces=kn(e.fen),t.drawable.shapes=[]),"check"in e&&function(t,e){if(t.check=void 0,!0===e&&(e=t.turnColor),e)for(const[n,o]of t.pieces)"king"===o.role&&o.color===e&&(t.check=n)}(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&cn(t,t.selected),(!t.animation.duration||t.animation.duration<100)&&(t.animation.enabled=!1),!t.movable.rookCastle&&t.movable.dests){const e="white"===t.movable.color?"1":"8",n="e"+e,o=t.movable.dests.get(n),r=t.pieces.get(n);if(!o||!r||"king"!==r.role)return;t.movable.dests.set(n,o.filter((t=>!(t==="a"+e&&o.includes("c"+e)||t==="h"+e&&o.includes("g"+e)))))}}function xn(t,e){for(const n in e)Sn(t[n])&&Sn(e[n])?xn(t[n],e[n]):t[n]=e[n]}function Sn(t){return"object"==typeof t}function Mn(t,e){return e.animation.enabled?function(t,e){const n=new Map(e.pieces),o=t(e),r=function(t,e){const n=new Map,o=[],r=new Map,s=[],i=[],a=new Map;let c,l,d;for(const[e,n]of t)a.set(e,En(e,n));for(const t of Ae)c=e.pieces.get(t),l=a.get(t),c?l?qe(c,l.piece)||(s.push(l),i.push(En(t,c))):i.push(En(t,c)):l&&s.push(l);for(const t of i)l=An(t,s.filter((e=>qe(t.piece,e.piece)))),l&&(d=[l.pos[0]-t.pos[0],l.pos[1]-t.pos[1]],n.set(t.key,d.concat(d)),o.push(l.key));for(const t of s)o.includes(t.key)||r.set(t.key,t.piece);return{anims:n,fadings:r}}(n,e);if(r.anims.size||r.fadings.size){const t=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:r},t||Tn(e,performance.now())}else e.dom.redraw();return o}(t,e):Pn(t,e)}function Pn(t,e){const n=t(e);return e.dom.redraw(),n}function En(t,e){return{key:t,pos:Ie(t),piece:e}}function An(t,e){return e.sort(((e,n)=>Ne(t.pos,e.pos)-Ne(t.pos,n.pos)))[0]}function Tn(t,e){const n=t.animation.current;if(void 0===n)return void(t.dom.destroyed||t.dom.redrawNow());const o=1-(e-n.start)*n.frequency;if(o<=0)t.animation.current=void 0,t.dom.redrawNow();else{const e=function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1}(o);for(const t of n.plan.anims.values())t[2]=t[0]*e,t[3]=t[1]*e;t.dom.redrawNow(!0),requestAnimationFrame(((e=performance.now())=>Tn(t,e)))}}const In=["green","red","blue","yellow"];function _n(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?ln(t):mn(t);const n=Ge(e),o=gn(n,vn(t),t.dom.bounds());o&&(t.drawable.current={orig:o,pos:n,brush:Dn(e),snapToValidMove:t.drawable.defaultSnapToValidMove},On(t))}function On(t){requestAnimationFrame((()=>{const e=t.drawable.current;if(e){const n=gn(e.pos,vn(t),t.dom.bounds());n||(e.snapToValidMove=!1);const o=e.snapToValidMove?function(t,e,n,o){const r=Ie(t),s=_e.filter((t=>Xe(r[0],r[1],t[0],t[1])||Ue(r[0],r[1],t[0],t[1]))),i=s.map((t=>We(Te(t),n,o))).map((t=>Ne(e,t))),[,a]=i.reduce(((t,e,n)=>t[0]<e?t:[e,n]),[i[0],0]);return Te(s[a])}(e.orig,e.pos,vn(t),t.dom.bounds()):n;o!==e.mouseSq&&(e.mouseSq=o,e.dest=o!==e.orig?o:void 0,t.dom.redrawNow()),On(t)}}))}function $n(t,e){t.drawable.current&&(t.drawable.current.pos=Ge(e))}function Nn(t){const e=t.drawable.current;e&&(e.mouseSq&&function(t,e){const n=t=>t.orig===e.orig&&t.dest===e.dest,o=t.shapes.find(n);o&&(t.shapes=t.shapes.filter((t=>!n(t))));o&&o.brush===e.brush||t.shapes.push(e);Ln(t)}(t.drawable,e),qn(t))}function qn(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function Dn(t){var e;const n=(t.shiftKey||t.ctrlKey)&&ze(t),o=t.altKey||t.metaKey||(null===(e=t.getModifierState)||void 0===e?void 0:e.call(t,"AltGraph"));return In[(n?1:0)+(o?2:0)]}function Ln(t){t.onChange&&t.onChange(t.shapes)}function Rn(t,e){if(!e.isTrusted||void 0!==e.button&&0!==e.button)return;if(e.touches&&e.touches.length>1)return;const n=t.dom.bounds(),o=Ge(e),r=gn(o,vn(t),n);if(!r)return;const s=t.pieces.get(r),i=t.selected;var a;i||!t.drawable.enabled||!t.drawable.eraseOnClick&&s&&s.color===t.turnColor||(a=t).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),Ln(a.drawable)),!1===e.cancelable||e.touches&&t.movable.color&&!s&&!i&&!function(t,e){const n=vn(t),o=t.dom.bounds(),r=Math.pow(o.width/8,2);for(const s in t.pieces){const t=We(s,n,o);if(Ne(t,e)<=r)return!0}return!1}(t,o)||e.preventDefault();const c=!!t.premovable.current,l=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&un(t,t.selected,r)?Mn((t=>an(t,r)),t):an(t,r);const d=t.selected===r,u=Wn(t,r);if(s&&u&&d&&function(t,e){const n=t.pieces.get(e);return!!n&&t.draggable.enabled&&("both"===t.movable.color||t.movable.color===n.color&&(t.turnColor===n.color||t.premovable.enabled))}(t,r)){t.draggable.current={orig:r,piece:s,origPos:o,pos:o,started:t.draggable.autoDistance&&t.stats.dragged,element:u,previouslySelected:i,originTarget:e.target},u.cgDragging=!0,u.classList.add("dragging");const a=t.dom.elements.ghost;a&&(a.className=`ghost ${s.color} ${s.role}`,je(a,Le(n)(Ie(r),vn(t))),Be(a,!0)),Fn(t)}else c&&Ze(t),l&&tn(t);t.dom.redraw()}function jn(t,e,n,o){const r="a0";t.pieces.set(r,e),t.dom.redraw();const s=Ge(n);t.draggable.current={orig:r,piece:e,origPos:s,pos:s,started:!0,element:()=>Wn(t,r),originTarget:n.target,newPiece:!0,force:!!o},Fn(t)}function Fn(t){requestAnimationFrame((()=>{var e;const n=t.draggable.current;if(!n)return;(null===(e=t.animation.current)||void 0===e?void 0:e.plan.anims.has(n.orig))&&(t.animation.current=void 0);const o=t.pieces.get(n.orig);if(o&&qe(o,n.piece)){if(!n.started&&Ne(n.pos,n.origPos)>=Math.pow(t.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const t=n.element();if(!t)return;t.cgDragging=!0,t.classList.add("dragging"),n.element=t}const e=t.dom.bounds();je(n.element,[n.pos[0]-e.left-e.width/16,n.pos[1]-e.top-e.height/16])}}else zn(t);Fn(t)}))}function Bn(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=Ge(e))}function Gn(t,e){const n=t.draggable.current;if(!n)return;if("touchend"===e.type&&!1!==e.cancelable&&e.preventDefault(),"touchend"===e.type&&n.originTarget!==e.target&&!n.newPiece)return void(t.draggable.current=void 0);Ze(t),tn(t);const o=gn(Ge(e)||n.pos,vn(t),t.dom.bounds());o&&n.started&&n.orig!==o?n.newPiece?sn(t,n.orig,o,n.force):(t.stats.ctrlKey=e.ctrlKey,rn(t,n.orig,o)&&(t.stats.dragged=!0)):n.newPiece?t.pieces.delete(n.orig):t.draggable.deleteOnDropOff&&!o&&(t.pieces.delete(n.orig),Qe(t.events.change)),(n.orig!==n.previouslySelected||n.orig!==o&&o)&&t.selectable.enabled||ln(t),Vn(t),t.draggable.current=void 0,t.dom.redraw()}function zn(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,ln(t),Vn(t),t.dom.redraw())}function Vn(t){const e=t.dom.elements;e.ghost&&Be(e.ghost,!1)}function Wn(t,e){let n=t.dom.elements.board.firstChild;for(;n;){if(n.cgKey===e&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function Hn(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function Un(t,e){function n(){!function(t){t.orientation=$e(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}(t),e()}return{set(e){e.orientation&&e.orientation!==t.orientation&&n(),(e.fen?Mn:Pn)((t=>Cn(t,e)),t)},state:t,getFen:()=>{return e=t.pieces,Ee.map((t=>Me.map((n=>{const o=e.get(n+t);if(o){const t=wn[o.role];return"white"===o.color?t.toUpperCase():t}return"1"})).join(""))).join("/").replace(/1{2,}/g,(t=>t.length.toString()));var e},toggleOrientation:n,setPieces(e){Mn((t=>function(t,e){for(const[n,o]of e)o?t.pieces.set(n,o):t.pieces.delete(n)}(t,e)),t)},selectSquare(e,n){e?Mn((t=>an(t,e,n)),t):t.selected&&(ln(t),t.dom.redraw())},move(e,n){Mn((t=>en(t,e,n)),t)},newPiece(e,n){Mn((t=>nn(t,e,n)),t)},playPremove(){if(t.premovable.current){if(Mn(pn,t))return!0;t.dom.redraw()}return!1},playPredrop(e){if(t.predroppable.current){const n=function(t,e){const n=t.predroppable.current;let o=!1;if(!n)return!1;e(n)&&nn(t,{role:n.role,color:t.movable.color},n.key)&&(Qe(t.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),o=!0);return tn(t),o}(t,e);return t.dom.redraw(),n}return!1},cancelPremove(){Pn(Ze,t)},cancelPredrop(){Pn(tn,t)},cancelMove(){Pn((t=>{mn(t),zn(t)}),t)},stop(){Pn((t=>{fn(t),zn(t)}),t)},explode(e){!function(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout((()=>{Hn(t,2),setTimeout((()=>Hn(t,void 0)),120)}),120)}(t,e)},setAutoShapes(e){Pn((t=>t.drawable.autoShapes=e),t)},setShapes(e){Pn((t=>t.drawable.shapes=e),t)},getKeyAtDomPos:e=>gn(e,vn(t),t.dom.bounds()),redrawAll:e,dragNewPiece(e,n,o){jn(t,e,n,o)},destroy(){fn(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function Kn(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function Jn(t,e,n){const o=t.drawable,r=o.current,s=r&&r.mouseSq?r:void 0,i=new Map,a=t.dom.bounds();for(const t of o.shapes.concat(o.autoShapes).concat(s?[s]:[]))t.dest&&i.set(t.dest,(i.get(t.dest)||0)+1);const c=o.shapes.concat(o.autoShapes).map((t=>({shape:t,current:!1,hash:Yn(t,i,!1,a)})));s&&c.push({shape:s,current:!0,hash:Yn(s,i,!0,a)});const l=c.map((t=>t.hash)).join(";");if(l===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=l;const d=e.querySelector("defs"),u=e.querySelector("g"),h=n.querySelector("g");!function(t,e,n){const o=new Map;let r;for(const n of e)n.shape.dest&&(r=t.brushes[n.shape.brush],n.shape.modifiers&&(r=ro(r,n.shape.modifiers)),o.set(r.key,r));const s=new Set;let i=n.firstChild;for(;i;)s.add(i.getAttribute("cgKey")),i=i.nextSibling;for(const[t,e]of o.entries())s.has(t)||n.appendChild(eo(e))}(o,c,d),Xn(t,c.filter((t=>!t.shape.customSvg)),o.brushes,i,u),Xn(t,c.filter((t=>t.shape.customSvg)),o.brushes,i,h)}function Xn(t,e,n,o,r){const s=t.dom.bounds(),i=new Map,a=[];for(const t of e)i.set(t.hash,!1);let c,l=r.firstChild;for(;l;)c=l.getAttribute("cgHash"),i.has(c)?i.set(c,!0):a.push(l),l=l.nextSibling;for(const t of a)r.removeChild(t);for(const a of e)i.get(a.hash)||r.appendChild(to(t,a,n,o,s))}function Yn({orig:t,dest:e,brush:n,piece:o,modifiers:r,customSvg:s},i,a,c){return[c.width,c.height,a,t,e,n,e&&(i.get(e)||0)>1,o&&Qn(o),r&&(l=r,""+(l.lineWidth||"")),s&&Zn(s)].filter((t=>t)).join(",");var l}function Qn(t){return[t.color,t.role,t.scale].filter((t=>t)).join(",")}function Zn(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n)>>>0;return"custom-"+e.toString()}function to(t,{shape:e,current:n,hash:o},r,s,i){let a;if(e.customSvg){const n=oo(Ie(e.orig),t.orientation);a=function(t,e,n){const{width:o,height:r}=n,s=o/8,i=r/8,a=e[0]*s,c=(7-e[1])*i,l=no(Kn("g"),{transform:`translate(${a},${c})`}),d=no(Kn("svg"),{width:s,height:i,viewBox:"0 0 100 100"});return l.appendChild(d),d.innerHTML=t,l}(e.customSvg,n,i)}else if(e.piece)a=function(t,e,n,o){const r=ao(e,o),s=o.width/8*(n.scale||1),i=n.color[0]+("knight"===n.role?"n":n.role[0]).toUpperCase();return no(Kn("image"),{className:`${n.role} ${n.color}`,x:r[0]-s/2,y:r[1]-s/2,width:s,height:s,href:t+i+".svg"})}(t.drawable.pieces.baseUrl,oo(Ie(e.orig),t.orientation),e.piece,i);else{const o=oo(Ie(e.orig),t.orientation);if(e.dest){let c=r[e.brush];e.modifiers&&(c=ro(c,e.modifiers)),a=function(t,e,n,o,r,s){const i=function(t,e){return(e?20:10)/512*t.width}(s,r&&!o),a=ao(e,s),c=ao(n,s),l=c[0]-a[0],d=c[1]-a[1],u=Math.atan2(d,l),h=Math.cos(u)*i,p=Math.sin(u)*i;return no(Kn("line"),{stroke:t.color,"stroke-width":so(t,o,s),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+t.key+")",opacity:io(t,o),x1:a[0],y1:a[1],x2:c[0]-h,y2:c[1]-p})}(c,o,oo(Ie(e.dest),t.orientation),n,(s.get(e.dest)||0)>1,i)}else a=function(t,e,n,o){const r=ao(e,o),s=function(t){const e=t.width/512;return[3*e,4*e]}(o),i=(o.width+o.height)/32;return no(Kn("circle"),{stroke:t.color,"stroke-width":s[n?0:1],fill:"none",opacity:io(t,n),cx:r[0],cy:r[1],r:i-s[1]/2})}(r[e.brush],o,n,i)}return a.setAttribute("cgHash",o),a}function eo(t){const e=no(Kn("marker"),{id:"arrowhead-"+t.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return e.appendChild(no(Kn("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function no(t,e){for(const n in e)t.setAttribute(n,e[n]);return t}function oo(t,e){return"white"===e?t:[7-t[0],7-t[1]]}function ro(t,e){return{color:t.color,opacity:Math.round(10*t.opacity)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter((t=>t)).join("")}}function so(t,e,n){return(t.lineWidth||10)*(e?.85:1)/512*n.width}function io(t,e){return(t.opacity||1)*(e?.9:1)}function ao(t,e){return[(t[0]+.5)*e.width/8,(7.5-t[1])*e.height/8]}function co(t,e){const n=Ve("coords",e);let o;for(const e of t)o=Ve("coord"),o.textContent=e,n.appendChild(o);return n}function lo(t,e){const n=t.dom.elements.board;if(!t.dom.relative&&t.resizable&&"ResizeObserver"in window){new window.ResizeObserver(e).observe(n)}if(t.viewOnly)return;const o=function(t){return e=>{t.draggable.current?zn(t):t.drawable.current?qn(t):e.shiftKey||ze(e)?t.drawable.enabled&&_n(t,e):t.viewOnly||(t.dropmode.active?function(t,e){if(!t.dropmode.active)return;Ze(t),tn(t);const n=t.dropmode.piece;if(n){t.pieces.set("a0",n);const o=Ge(e),r=o&&gn(o,vn(t),t.dom.bounds());r&&sn(t,"a0",r)}t.dom.redraw()}(t,e):Rn(t,e))}}(t);n.addEventListener("touchstart",o,{passive:!1}),n.addEventListener("mousedown",o,{passive:!1}),(t.disableContextMenu||t.drawable.enabled)&&n.addEventListener("contextmenu",(t=>t.preventDefault()))}function uo(t,e,n,o){return t.addEventListener(e,n,o),()=>t.removeEventListener(e,n,o)}function ho(t,e,n){return o=>{t.drawable.current?t.drawable.enabled&&n(t,o):t.viewOnly||e(t,o)}}function po(t){const e=vn(t),n=t.dom.relative?Re:Le(t.dom.bounds()),o=t.dom.relative?Fe:je,r=t.dom.elements.board,s=t.pieces,i=t.animation.current,a=i?i.plan.anims:new Map,c=i?i.plan.fadings:new Map,l=t.draggable.current,d=function(t){var e;const n=new Map;if(t.lastMove&&t.highlight.lastMove)for(const e of t.lastMove)yo(n,e,"last-move");t.check&&t.highlight.check&&yo(n,t.check,"check");if(t.selected&&(yo(n,t.selected,"selected"),t.movable.showDests)){const o=null===(e=t.movable.dests)||void 0===e?void 0:e.get(t.selected);if(o)for(const e of o)yo(n,e,"move-dest"+(t.pieces.has(e)?" oc":""));const r=t.premovable.dests;if(r)for(const e of r)yo(n,e,"premove-dest"+(t.pieces.has(e)?" oc":""))}const o=t.premovable.current;if(o)for(const t of o)yo(n,t,"current-premove");else t.predroppable.current&&yo(n,t.predroppable.current.key,"current-premove");const r=t.exploding;if(r)for(const t of r.keys)yo(n,t,"exploding"+r.stage);return n}(t),u=new Set,h=new Set,p=new Map,m=new Map;let f,g,v,b,y,w,k,C,x,S;for(g=r.firstChild;g;){if(f=g.cgKey,mo(g))if(v=s.get(f),y=a.get(f),w=c.get(f),b=g.cgPiece,!g.cgDragging||l&&l.orig===f||(g.classList.remove("dragging"),o(g,n(Ie(f),e)),g.cgDragging=!1),!w&&g.cgFading&&(g.cgFading=!1,g.classList.remove("fading")),v){if(y&&g.cgAnimating&&b===bo(v)){const t=Ie(f);t[0]+=y[2],t[1]+=y[3],g.classList.add("anim"),o(g,n(t,e))}else g.cgAnimating&&(g.cgAnimating=!1,g.classList.remove("anim"),o(g,n(Ie(f),e)),t.addPieceZIndex&&(g.style.zIndex=vo(Ie(f),e)));b!==bo(v)||w&&g.cgFading?w&&b===bo(w)?(g.classList.add("fading"),g.cgFading=!0):wo(p,b,g):u.add(f)}else wo(p,b,g);else if(fo(g)){const t=g.className;d.get(f)===t?h.add(f):wo(m,t,g)}g=g.nextSibling}for(const[t,s]of d)if(!h.has(t)){x=m.get(s),S=x&&x.pop();const i=n(Ie(t),e);if(S)S.cgKey=t,o(S,i);else{const e=Ve("square",s);e.cgKey=t,o(e,i),r.insertBefore(e,r.firstChild)}}for(const[i,c]of s)if(y=a.get(i),!u.has(i))if(k=p.get(bo(c)),C=k&&k.pop(),C){C.cgKey=i,C.cgFading&&(C.classList.remove("fading"),C.cgFading=!1);const r=Ie(i);t.addPieceZIndex&&(C.style.zIndex=vo(r,e)),y&&(C.cgAnimating=!0,C.classList.add("anim"),r[0]+=y[2],r[1]+=y[3]),o(C,n(r,e))}else{const s=bo(c),a=Ve("piece",s),l=Ie(i);a.cgPiece=s,a.cgKey=i,y&&(a.cgAnimating=!0,l[0]+=y[2],l[1]+=y[3]),o(a,n(l,e)),t.addPieceZIndex&&(a.style.zIndex=vo(l,e)),r.appendChild(a)}for(const e of p.values())go(t,e);for(const e of m.values())go(t,e)}function mo(t){return"PIECE"===t.tagName}function fo(t){return"SQUARE"===t.tagName}function go(t,e){for(const n of e)t.dom.elements.board.removeChild(n)}function vo(t,e){let n=2+8*t[1]+(7-t[0]);return e&&(n=67-n),n+""}function bo(t){return`${t.color} ${t.role}`}function yo(t,e,n){const o=t.get(e);o?t.set(e,`${o} ${n}`):t.set(e,n)}function wo(t,e,n){const o=t.get(e);o?o.push(n):t.set(e,[n])}function ko(t,e){const n={pieces:kn(bn),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:Oe()};function o(){const e="dom"in n?n.dom.unbind:void 0,o=n.viewOnly&&!n.drawable.visible,r=function(t,e,n){t.innerHTML="",t.classList.add("cg-wrap");for(const n of Se)t.classList.toggle("orientation-"+n,e.orientation===n);t.classList.toggle("manipulable",!e.viewOnly);const o=Ve("cg-helper");t.appendChild(o);const r=Ve("cg-container");o.appendChild(r);const s=Ve("cg-board");let i,a,c;if(r.appendChild(s),e.drawable.visible&&!n&&(i=no(Kn("svg"),{class:"cg-shapes"}),i.appendChild(Kn("defs")),i.appendChild(Kn("g")),a=no(Kn("svg"),{class:"cg-custom-svgs"}),a.appendChild(Kn("g")),r.appendChild(i),r.appendChild(a)),e.coordinates){const t="black"===e.orientation?" black":"";r.appendChild(co(Pe,"ranks"+t)),r.appendChild(co(Me,"files"+t))}return e.draggable.showGhost&&!n&&(c=Ve("piece","ghost"),Be(c,!1),r.appendChild(c)),{board:s,container:r,ghost:c,svg:i,customSvg:a}}(t,n,o),s=function(t){let e;const n=()=>(void 0===e&&(e=t()),e);return n.clear=()=>{e=void 0},n}((()=>r.board.getBoundingClientRect())),i=t=>{po(c),!t&&r.svg&&Jn(c,r.svg,r.customSvg)},a=()=>{s.clear(),function(t){if(t.dom.relative)return;const e=vn(t),n=Le(t.dom.bounds());let o=t.dom.elements.board.firstChild;for(;o;)(mo(o)&&!o.cgAnimating||fo(o))&&je(o,n(Ie(o.cgKey),e)),o=o.nextSibling}(c),r.svg&&Jn(c,r.svg,r.customSvg)},c=n;return c.dom={elements:r,bounds:s,redraw:Co(i),redrawNow:i,unbind:e,relative:o},c.drawable.prevSvgHash="",i(!1),lo(c,a),e||(c.dom.unbind=function(t,e){const n=[];if(t.dom.relative||!t.resizable||"ResizeObserver"in window||n.push(uo(document.body,"chessground.resize",e)),!t.viewOnly){const e=ho(t,Bn,$n),o=ho(t,Gn,Nn);for(const t of["touchmove","mousemove"])n.push(uo(document,t,e));for(const t of["touchend","mouseup"])n.push(uo(document,t,o));const r=()=>t.dom.bounds.clear();n.push(uo(document,"scroll",r,{capture:!0,passive:!0})),n.push(uo(window,"resize",r,{passive:!0}))}return()=>n.forEach((t=>t()))}(c,a)),c.events.insert&&c.events.insert(r),c}return Cn(n,e||{}),Un(o(),o)}function Co(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame((()=>{t(),e=!1})))}}const xo=()=>{const t={blue:"#DEE3E6 #788a94",blue2:"#97b2c7 #546f82",blue3:"#d9e0e6 #315991",canvas:"#d7daeb #547388",wood:"#d8a45b #9b4d0f",wood2:"#a38b5d #6c5017",wood3:"#d0ceca #755839",wood4:"#caaf7d #7b5330",maple:"#e8ceab #bc7944",maple2:"#E2C89F #996633",leather:"#d1d1c9 #c28e16",green:"#FFFFDD #6d8753",brown:"#F0D9B5 #946f51",pink:"#E8E9B7 #ED7272",marble:"#93ab91 #4f644e","blue-marble":"#EAE6DD #7C7F87","green-plastic":"#f2f9bb #59935d",grey:"#b8b8b8 #7d7d7d",metal:"#c9c9c9 #727272",olive:"#b8b19f #6d6655",newspaper:"#fff #8d8d8d",purple:"#9f90b0 #7d4a8d","purple-diag":"#E5DAF0 #957AB0",ic:"#ececec #c1c18e",horsey:"#F0D9B5 #946f51"};for(const e of document.body.className.split(" "))if(e in t){const n=document.documentElement.style,o=t[e].split(" ");n.setProperty("--cg-coord-color-white",o[0]),n.setProperty("--cg-coord-color-black",o[1]),n.setProperty("--cg-coord-shadow","none")}};function So(t){var e;return t.clientX||0===t.clientX?[t.clientX,t.clientY]:(null===(e=t.targetTouches)||void 0===e?void 0:e[0])?[t.targetTouches[0].clientX,t.targetTouches[0].clientY]:void 0}function Mo(t){return p("div.cg-wrap.cgv"+t.cgVersion.js,{hook:{insert:e=>{t.chessground=ko(e.elm,function(t){const e=t.data.pref,n=t.makeCgOpts(),o={turnColor:n.turnColor,fen:n.fen,check:n.check,lastMove:n.lastMove,orientation:t.bottomColor(),coordinates:0!==e.coords&&!t.embed,addPieceZIndex:e.is3d,viewOnly:!!t.embed,movable:{free:!1,color:n.movable.color,dests:n.movable.dests,showDests:e.destination,rookCastle:e.rookCastle},events:{move:t.userMove,dropNewPiece:t.userNewPiece,insert(e){t.embed||function(t,e,n,o){if(0===e)return;const r=document.createElement("cg-resize");t.container.appendChild(r);const s=t=>{t.preventDefault();const e="touchstart"===t.type?"touchmove":"mousemove",n="touchstart"===t.type?"touchend":"mouseup",o=So(t),r=parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"));let s=r;const i=B((()=>q(`/pref/zoom?v=${100+s}`,{method:"post"})),700),a=t=>{const e=So(t),n=e[0]-o[0]+e[1]-o[1];s=Math.round(Math.min(100,Math.max(0,r+n/10))),document.body.setAttribute("style","--zoom:"+s),window.dispatchEvent(new Event("resize")),i()};document.body.classList.add("resizing"),document.addEventListener(e,a),document.addEventListener(n,(()=>{document.removeEventListener(e,a),document.body.classList.remove("resizing")}),{once:!0})};if(r.addEventListener("touchstart",s,{passive:!1}),r.addEventListener("mousedown",s,{passive:!1}),1===e){const t=t=>r.classList.toggle("none",o?!o(t):t>=2);t(n),lichess.pubsub.on("ply",t)}}(e,2,t.node.ply),t.embed||1!=t.data.pref.coords||xo()}},premovable:{enabled:n.premovable.enabled,showDests:e.destination,events:{set:t.onPremoveSet}},drawable:{enabled:!t.embed,eraseOnClick:!t.opts.study||!!t.opts.practice,defaultSnapToValidMove:"0"!=(lichess.storage.get("arrow.snap")||1)},highlight:{lastMove:e.highlight,check:e.highlight},animation:{duration:e.animationDuration},disableContextMenu:!0};return t.study&&t.study.mutateCgConfig(o),o}(t)),t.setAutoShapes(),t.node.shapes&&t.chessground.setShapes(t.node.shapes),t.cgVersion.dom=t.cgVersion.js},destroy:e=>t.chessground.destroy()}})}let Po;function Eo(t,e){Po&&(!function(t,e,n){const o=t.state.pieces.get(e);o&&"pawn"==o.role&&t.setPieces(new Map([[e,{color:o.color,role:n,promoted:!0}]]))}(t.chessground,Po.dest,e),Po.callback&&Po.callback(Po.orig,Po.dest,Po.capture,e)),Po=void 0}function Ao(t){Po&&(Po=void 0,t.chessground.set(t.cgConfig),t.redraw())}const To=["queen","knight","rook","bishop"];function Io(t){if(Po)return function(t,e,n,o,r){if(!Po)return;let s=12.5*(7-Ie(e)[0]);return"white"===r&&(s=87.5-s),p("div#promotion-choice."+(o===r?"top":"bottom"),{hook:le((e=>{e.addEventListener("click",(e=>Ao(t))),e.oncontextmenu=()=>!1}))},n.map((function(e,n){return p("square",{attrs:{style:`top:${12.5*(o===r?n:7-n)}%;left:${s}%`},hook:ae("click",(n=>{n.stopPropagation(),Eo(t,e)}))},[p(`piece.${e}.${o}`)])})))}(t,Po.dest,"antichess"===t.data.game.variant.key?To.concat("king"):To,"8"===Po.dest[1]?"white":"black",t.chessground.state.orientation)}function _o(t){!window.LichessSpeech&&t?lichess.loadModule("speech"):window.LichessSpeech&&!t&&(window.LichessSpeech=void 0)}function Oo(t){var e;e=e=>e.step(t,!0),window.LichessSpeech&&e(window.LichessSpeech)}const $o=lichess.storage;function No(t,e){const n="analyse."+t,o=!0===e||!1===e;let r;return function(t){return P(t)&&t!=r?(r=t+"",$o.set(n,t)):P(r)||(r=$o.get(n),null===r&&(r=e+"")),o?"true"===r:r}}const qo=(t,e)=>n=>{if(P(n))return $o.set(t,JSON.stringify(n)),n;const o=JSON.parse($o.get(t));return null!==o?o:e()},Do=["bullet","blitz","rapid","classical"],Lo=[1600,1800,2e3,2200,2500];function Ro(t){const e=new URL("lichess"===t.db?"/lichess":"/master",t.endpoint),n=e.searchParams;if(n.set("fen",t.rootFen),n.set("play",t.play.join(",")),"lichess"===t.db){if(n.set("variant",t.variant||"standard"),t.speeds)for(const e of t.speeds)n.append("speeds[]",e);if(t.ratings)for(const e of t.ratings)n.append("ratings[]",e.toString())}return t.withGames||(n.set("topGames","0"),n.set("recentGames","0")),N(e.href,{cache:"default",headers:{},credentials:"omit"}).then((e=>(e.isOpening=!0,e.fen=t.fen,e)))}function jo(t,e,n){return N(R(`${t}/${"fromPosition"===e||"chess960"===e?"standard":e}`,{fen:n}),{cache:"default",headers:{},credentials:"omit"}).then((t=>(t.tablebase=!0,t.fen=n,t)))}const Fo=["a","b","c","d","e","f","g","h"],Bo=["1","2","3","4","5","6","7","8"],Go=["white","black"],zo=["pawn","knight","bishop","rook","queen","king"],Vo=["a","h"];function Wo(t){return"role"in t}function Ho(t){return void 0!==t}function Uo(t){return"white"===t?"black":"white"}function Ko(t){return t>>3}function Jo(t){return 7&t}function Xo(t){switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}}function Yo(t){switch(t){case"P":case"p":return"pawn";case"N":case"n":return"knight";case"B":case"b":return"bishop";case"R":case"r":return"rook";case"Q":case"q":return"queen";case"K":case"k":return"king";default:return}}function Qo(t){if(2!==t.length)return;const e=t.charCodeAt(0)-"a".charCodeAt(0),n=t.charCodeAt(1)-"1".charCodeAt(0);return e<0||e>=8||n<0||n>=8?void 0:e+8*n}function Zo(t){return Fo[Jo(t)]+Bo[Ko(t)]}function tr(t){if("@"===t[1]&&4===t.length){const e=Yo(t[0]),n=Qo(t.slice(2));if(e&&Ho(n))return{role:e,to:n}}else if(4===t.length||5===t.length){const e=Qo(t.slice(0,2)),n=Qo(t.slice(2,4));let o;if(5===t.length&&(o=Yo(t[4]),!o))return;if(Ho(e)&&Ho(n))return{from:e,to:n,promotion:o}}}function er(t,e){return"white"===t?"a"===e?2:6:"a"===e?58:62}function nr(t){return"w"===t.split(" ")[1]?"white":"black"}function or(t,e){const n=nr(t);return e.checkmate||e.variant_loss||e.wdl<0?n:e.variant_win||e.wdl>0?Uo(n):void 0}function rr(t){return t.split(/\s/)[0].split(/[nbrqkp]/i).length-1}function sr(t){switch(t){case"standard":case"fromPosition":case"chess960":return 7;case"atomic":case"antichess":return 6;default:return 0}}function ir(t,e){return rr(e)<=sr(t)}function ar(t,e){return rr(e)-1<=sr(t)}function cr(t,e,n){const o=T(n),r=t.embed?T(!1):No("explorer.enabled",!1),s=T(!0),i=T(!1),a=T(null),c=T(0),l=T(null);"#explorer"!==location.hash&&"#opening"!==location.hash||t.embed||r(!0);let d={};const u=t.data,h=t.synthetic||_t(u)||!!u.opponent.ai,p="fromPosition"===u.game.variant.key?"standard":u.game.variant.key,m=function(t,e,n,o){const r="fromPosition"===t.variant.key?"standard":t.variant.key,s=["lichess"];"standard"===r&&s.unshift("masters");const i={open:T(!1),db:{available:s,selected:s.length>1?No("explorer.db."+r,s[0]):function(){return s[0]}},rating:{available:Lo,selected:qo("explorer.rating",(()=>Lo))},speed:{available:Do,selected:qo("explorer.speed",(()=>Do))}},a=function(t,e){t().includes(e)?t().length>1&&t(t().filter((t=>t!==e))):t(t().concat([e]))};return{trans:n,redraw:o,data:i,toggleOpen(){i.open(!i.open()),i.open()||e()},toggleDb(t){i.db.selected(t)},toggleRating(t){a(i.rating.selected,t)},toggleSpeed(t){a(i.speed.selected,t)},fullHouse:()=>"masters"===i.db.selected()||i.rating.selected().length===i.rating.available.length&&i.speed.selected().length===i.speed.available.length}}(u.game,(function(){t.redraw(),d={},v()}),t.trans,t.redraw),f=B((()=>{const n=t.node.fen;(h&&ar(p,n)?jo(e.tablebaseEndpoint,p,n):Ro({endpoint:e.endpoint,db:m.data.db.selected(),variant:p,rootFen:t.nodeList[0].fen,play:t.nodeList.slice(1).map((t=>t.uci)),fen:n,speeds:m.data.speed.selected(),ratings:m.data.rating.selected(),withGames:h})).then((e=>{d[n]=e,c(e.moves.length?0:c()+1),s(!1),i(!1),t.redraw()}),(()=>{s(!1),i(!0),t.redraw()}))}),250,!0),g={isOpening:!0,moves:[],fen:""};function v(){if(!r())return;l(null);const e=t.node;e.ply>50&&!ar(p,e.fen)&&(d[e.fen]=g);const n=d[e.fen];n?(c(n.moves.length?0:c()+1),s(!1),i(!1)):(s(!0),f())}return{allowed:o,enabled:r,setNode:v,loading:s,failing:i,hovering:a,movesAway:c,config:m,withGames:h,gameMenu:l,current:()=>d[t.node.fen],toggle(){c(0),r(!r()),v(),t.autoScroll()},disable(){r()&&(r(!1),l(null),t.autoScroll())},setHovering(e,n){a(n?{fen:e,uci:n}:null),t.setAutoShapes()},fetchMasterOpening:(()=>{const t={};return n=>{const o=t[n];return o?Promise.resolve(o):Ro({endpoint:e.endpoint,db:"masters",rootFen:n,play:[],fen:n}).then((e=>(t[n]=e,e)))}})(),fetchTablebaseHit:t=>jo(e.tablebaseEndpoint,p,t).then((e=>{const n=e.moves[0];if(n&&null==n.dtz)throw"unknown tablebase position";return{fen:t,best:n&&n.uci,winner:e.checkmate?$e(nr(t)):e.stalemate?void 0:or(t,n)}}))}}function lr(t,e){let n,o=0;return function(...r){const s=this,i=performance.now()-o;function a(){n=void 0,o=performance.now(),e.apply(s,r)}n&&clearTimeout(n),i>t?a():n=setTimeout(a,t-i)}}function dr(t){const e=T(t.initDict),n=T(null),o={};let r={},s=[];function i(){return t.myId===t.ownerId||t.admin&&c()}function a(){return t.myId?e()[t.myId]:void 0}function c(){const t=a();return!!t&&"w"===t.role}const l=function(t,e,n,o,r){const s=T(!1),i=T([]);return{open:s,members:e,spectators:i,toggle(){s(!s())},invite(e){t("invite",fe(e)),n()},redraw:o,trans:r}}(t.send,e,(()=>t.tab("members")),t.redraw,t.trans);function d(e){"members"===t.tab()&&(o[e]?o[e]():o[e]=function(t){let e;const n=()=>{e&&clearTimeout(e),e=setTimeout(t,100)};return n(),n}((()=>{delete o[e],t.redraw()})),t.redraw())}function u(){r={};const n=e();s.forEach((function(t){n[t]&&(r[t]=!0)})),"members"===t.tab()&&t.redraw()}return lichess.pubsub.on("socket.in.crowd",(t=>{const e=t.users||[];l.spectators(e),s=e.map(fe),u()})),{dict:e,confing:n,myId:t.myId,inviteForm:l,update(o){i()&&n(Object.keys(o).find((t=>!e()[t]))||null);const r=a()&&!c(),s=a()&&c();e(o),r&&c()?(lichess.once("study-tour")&&t.startTour(),t.onBecomingContributor(),t.notif.set({text:t.trans.noarg("youAreNowAContributor"),duration:3e3})):s&&!c()&&t.notif.set({text:t.trans.noarg("youAreNowASpectator"),duration:3e3}),u()},setActive:d,isActive:t=>!!o[t],owner:function(){return e()[t.ownerId]},myMember:a,isOwner:i,canContribute:c,max:30,setRole(e,o){d(e),t.send("setRole",{userId:e,role:o}),n(null)},kick(e){t.send("kick",e),n(null)},leave(){t.send("leave")},ordered(){const t=e();return Object.keys(t).map((e=>t[e])).sort(((t,e)=>"r"===t.role&&"w"===e.role?1:"w"===t.role&&"r"===e.role?-1:0))},size:()=>Object.keys(e()).length,isOnline:t=>r[t],hasOnlineContributor(){const t=e();for(const e in t)if(r[e]&&"w"===t[e].role)return!0;return!1}}}function ur(t){const e=t.members,n=e.isOwner();function o(t){const e=t.user;return p("span.user-link.ulpt",{attrs:{"data-href":"/@/"+e.name}},(e.title?e.title+" ":"")+e.name)}function r(n){const o="w"===n.role;return p("span.status",{class:{contrib:o,active:e.isActive(n.user.id),online:e.isOnline(n.user.id)},attrs:{title:t.trans.noarg(o?"contributor":"spectator")}},[he(o?"r":"v")])}function s(t,o){return n&&(o.user.id!==e.myId||t.data.admin)?p("i.act",{attrs:ue("%"),hook:ae("click",(t=>{e.confing(e.confing()==o.user.id?null:o.user.id),console.log(e.confing(),o.user.id)}),t.redraw)}):n||o.user.id!==e.myId?void 0:p("i.act.leave",{attrs:{"data-icon":"F",title:t.trans.noarg("leaveTheStudy")},hook:ae("click",e.leave,t.redraw)})}function i(n){const o="member-role";return p("m-config",{key:n.user.id+"-config",hook:le((t=>ye($(t).parent(".members")[0],t)))},[p("div.role",[p("div.switch",[p("input.cmn-toggle",{attrs:{id:o,type:"checkbox",checked:"w"===n.role},hook:ae("change",(t=>{e.setRole(n.user.id,t.target.checked?"w":"r")}),t.redraw)}),p("label",{attrs:{for:o}})]),p("label",{attrs:{for:o}},t.trans.noarg("contributor"))]),p("div.kick",p("a.button.button-red.button-empty.text",{attrs:ue("L"),hook:ae("click",(t=>e.kick(n.user.id)),t.redraw)},t.trans.noarg("kick")))])}const a=e.ordered();return p("div.study__members",{hook:le((()=>lichess.pubsub.emit("chat.resize")))},[...a.map((n=>{const a=e.confing()===n.user.id;return[p("div",{key:n.user.id,class:{editing:!!a}},[p("div.left",[r(n),o(n)]),s(t,n)]),a?i(n):null]})).reduce(((t,e)=>t.concat(e)),[]),n&&a.length<e.max?p("div.add",{key:"add",hook:ae("click",e.inviteForm.toggle,t.redraw)},[p("div.left",[p("span.status",he("O")),p("div.user-link",t.trans.noarg("addMembers"))])]):null,!e.canContribute()&&t.data.admin?p("form.admin",{key:":admin",attrs:{method:"post",action:`/study/${t.data.id}/admin`}},[p("button.button.button-red.button-thin",{attrs:{type:"submit"}},"Enter as admin")]):null])}const hr=[["normal","normalAnalysis"],["practice","practiceWithComputer"],["conceal","hideNextMoves"],["gamebook","interactiveLesson"]],pr=(t,e)=>{var n;return null===(n=t.target.querySelector("#chapter-"+e))||void 0===n?void 0:n.value};function mr(t,e,n,o){const r={variants:[],open:!1,initial:T(!1),tab:No("study.form.tab","init"),editor:null,editorFen:T(null),isDefaultName:!0};function s(){r.variants.length||N("/variant",{cache:"default"}).then((function(t){r.variants=t,o.redraw()}))}function i(){r.open=!0,s(),r.initial(!1)}function a(){r.open=!1}return{vm:r,open:i,root:o,openInitial(){i(),r.initial(!0)},close:a,toggle(){r.open?a():i()},submit(e){const s=o.study,i=Object.assign(Object.assign({},e),{sticky:s.vm.mode.sticky,initial:r.initial()});var c,l;i.pgn?(c=s.data.id,l=i,N(`/study/${c}/import-pgn?sri=${lichess.sri}`,{method:"POST",body:L(l)})):t("addChapter",i),a(),n()},chapters:e,startTour:()=>function(t){lichess.loadScript("javascripts/study/tour-chapter.js").then((()=>{window.lichess.studyTourChapter({setTab:t})}))}((t=>{r.tab(t),o.redraw()})),multiPgnMax:20,redraw:o.redraw}}function fr(t){return"orientation"in t}function gr(t,e){const n=e.practice?"practice":P(e.conceal)?"conceal":e.gamebook?"gamebook":"normal";return[p("div.form-split",[p("div.form-group.form-half",[p("label.form-label",{attrs:{for:"chapter-orientation"}},t.trans.noarg("orientation")),p("select#chapter-orientation.form-control",["white","black"].map((function(n){return be(n,e.orientation,t.trans.noarg(n))})))]),p("div.form-group.form-half",[p("label.form-label",{attrs:{for:"chapter-mode"}},t.trans.noarg("analysisMode")),p("select#chapter-mode.form-control",hr.map((e=>be(e[0],n,t.trans.noarg(e[1])))))])]),p("div.form-group",[p("label.form-label",{attrs:{for:"chapter-description"}},t.trans.noarg("pinnedChapterComment")),p("select#chapter-description.form-control",[["",t.trans.noarg("noPinnedComment")],["1",t.trans.noarg("rightUnderTheBoard")]].map((t=>be(t[0],e.description?"1":"",t[1]))))]),ke(t.trans.noarg("saveChapter"))]}function vr(t,e,n,o,r){const s=T(t),i=mr(e,s,n,r),a=function(t,e,n,o){const r=T(null);function s(t){r({id:t.id,name:t.name}),e(t.id).then((t=>{r(t),o()}))}function i(t){const e=r();return!!e&&e.id===t}return{open:s,toggle(t){i(t.id)?r(null):s(t)},current:r,submit(e){const n=r();n&&(t("editChapter",Object.assign({id:n.id},e)),r(null)),o()},delete(e){t("deleteChapter",e),r(null)},clearAnnotations(e){t("clearAnnotations",e),r(null)},isEditing:i,trans:n,redraw:o}}(e,o,r.trans,r.redraw);return{newForm:i,editForm:a,list:s,get:t=>s().find((e=>e.id===t)),size:()=>s().length,sort(t){e("sortChapters",t)},firstChapterId:()=>s()[0].id,toggleNewForm(){i.vm.open||s().length<64?i.toggle():alert("You have reached the limit of 64 chapters per study. Please create a new study.")},localPaths:{}}}function br(t){const e=yr(t.tags,"result");return e&&"*"!==e}function yr(t,e){const n=t.find((t=>t[0].toLowerCase()===e));return n&&n[1]}function wr(t){const e=t.members.canContribute(),n=t.currentChapter();function o(o){const r=t.chapters.list().length,s=o.data.li,i=o.elm;if(s.count!==r?n.id!==t.chapters.firstChapterId()&&ye(i,i.querySelector(".active")):t.vm.loading&&s.loadingId!==t.vm.nextChapterId&&(s.loadingId=t.vm.nextChapterId,ye(i,i.querySelector(".loading"))),s.count=r,e&&r>1&&!s.sortable){const e=function(){s.sortable=window.Sortable.create(i,{draggable:".draggable",handle:"ontouchstart"in window?"span":void 0,onSort(){t.chapters.sort(s.sortable.toArray())}})};window.Sortable?e():lichess.loadScript("javascripts/vendor/Sortable.min.js").then(e)}}return p("div.study__chapters",{hook:{insert(e){e.elm.addEventListener("click",(e=>{const n=e.target,o=n.parentNode.getAttribute("data-id")||n.getAttribute("data-id");if(o)if("act"===n.className){const e=t.chapters.get(o);e&&t.chapters.editForm.toggle(e)}else t.setChapter(o)})),e.data.li={},o(e),lichess.pubsub.emit("chat.resize")},postpatch(t,e){e.data.li=t.data.li,o(e)},destroy:t=>{const e=t.data.li.sortable;e&&e.destroy()}}},t.chapters.list().map(((o,r)=>{var s;const i=t.chapters.editForm.isEditing(o.id),a=t.vm.loading&&o.id===t.vm.nextChapterId,c=!t.vm.loading&&n&&!(null===(s=t.relay)||void 0===s?void 0:s.tourShow.active)&&n.id===o.id;return p("div",{key:o.id,attrs:{"data-id":o.id},class:{active:c,editing:i,loading:a,draggable:e}},[p("span",a?p("span.ddloader"):[""+(r+1)]),p("h3",o.name),o.ongoing?p("ongoing",{attrs:Object.assign(Object.assign({},ue("J")),{title:"Ongoing"})}):null,!o.ongoing&&o.res?p("res",o.res):null,e?p("i.act",{attrs:ue("%")}):null])})).concat(t.members.canContribute()?[p("div.add",{hook:ae("click",t.chapters.toggleNewForm,t.redraw)},[p("span",he("O")),p("h3",t.trans.noarg("addNewChapter"))])]:[]))}function kr(t){return xr(t)?!t.ceval.mate&&Math.abs(t.ceval.cp)<150:null}function Cr(t,e,n){if(!xr(t))return null;const o=t.ceval.mate>0?99999:t.ceval.mate<0?-99999:t.ceval.cp;return"white"===n?o>=e:o<=e}function xr(t){return t.ceval&&t.ceval.depth>=16}function Sr(t,e,n){const o=t.node;if(!o.uci)return null;const r=t.outcome();if(r&&r.winner&&r.winner!==t.bottomColor())return!1;if(r&&r.winner&&r.winner===t.bottomColor())return!0;if((s=t.practice.comment())&&("mistake"===s.verdict||"blunder"===s.verdict))return!1;var s;switch(e.result){case"drawIn":case"equalIn":if(o.threefold)return!0;if(!1===kr(o))return!1;if(n>e.moves)return!1;if(r&&!r.winner)return!0;if(n>=e.moves)return kr(o);break;case"evalIn":if(n>=e.moves)return Cr(o,e.cp,t.bottomColor());break;case"mateIn":{if(n>e.moves)return!1;const r=function(t,e){if(!xr(t))return null;if(!t.ceval.mate)return!1;const n=t.ceval.mate*("white"===e?1:-1);return n>0&&n}(o,t.bottomColor());if(null===r)return null;if(!r||r+n>e.moves)return!1;break}case"promotion":return o.uci[4]?Cr(o,e.cp,t.bottomColor()):null}return null}function Mr(t,e,n){const o=T(t.data.practiceGoal),r=T(0),s=T(null),i=T(""),a=No("practice-auto-next",!0);function c(){t.showAutoShapes=de(!0),t.showGauge=de(!0),t.showComputer=de(!0),o(t.data.practiceGoal),r(0),s(null);const a=e.chapter;history.replaceState(null,a.name,n.url+"/"+a.id),i("/analysis/standard/"+t.node.fen.replace(/ /g,"_")+"?color="+t.bottomColor())}function l(){return t.study}function d(){const e=l().gamebookPlay();if(e)return void("end"===e.state.feedback&&u());if(!l().data.chapter.practice)return h();if(null!==s())return;r(function(){let e=t.node.ply-t.tree.root.ply;return t.bottomColor()!==t.data.player.color&&e--,Math.ceil(e/2)}());const n=s(Sr(t,o(),r()));n?u():!1===n&&(t.node.fail=!0,lichess.sound.play("practiceFailure"))}function u(){h(),lichess.sound.play("practiceSuccess"),e.chapter.practice&&a()&&setTimeout(l().goToNextChapter,1e3)}function h(){const t=l().currentChapter().id,e=n.completion[t];(void 0===e||r()<e)&&(n.completion[t]=r(),((t,e)=>{N(`/practice/complete/${t}/${e}`,{method:"POST"})})(t,r()))}return lichess.sound.loadOggOrMp3("practiceSuccess",`${lichess.sound.baseUrl}/other/energy3`),lichess.sound.loadOggOrMp3("practiceFailure",`${lichess.sound.baseUrl}/other/failure2`),c(),{onLoad:c,onJump(){!1!==s()||t.nodeList.find((t=>!!t.fail))||s(null),d()},onCeval:d,data:n,goal:o,success:s,nbMoves:r,reset(){t.tree.root.children=[],t.userJump(""),t.practice.reset(),c(),t.practice.resume()},isWhite:t.bottomIsWhite,analysisUrl:i,autoNext:a}}function Pr(t){return"object"==typeof t}function Er(t){return t?"string"==typeof t?t:t.name:"Unknown"}function Ar(t,e){if(!t.node.comments)return;const n=t.node,o=t.study,r=o.currentChapter(),s=n.comments;return s.length?p("div",s.map((s=>{const i=s.by,a=Pr(i)&&i.id===t.opts.userId;if(!e&&a)return;const c=a||o.members.isOwner();return p("div.study__comment."+s.id,[c&&o.vm.mode.write?p("a.edit",{attrs:{"data-icon":"q",title:"Delete"},hook:ae("click",(e=>{confirm("Delete "+Er(i)+"'s comment?")&&o.commentForm.delete(r.id,t.path,s.id)}),t.redraw)}):null,a&&o.vm.mode.write?p("a.edit",{attrs:{"data-icon":"m",title:"Edit"},hook:ae("click",(e=>{o.commentForm.start(r.id,t.path,n)}),t.redraw)}):null,(l=i,l?"string"==typeof l?l:p("span.user-link.ulpt",{attrs:{"data-href":"/@/"+l.id}},l.name):"Unknown"),...n.san?[" on ",p("span.node",pe(n))]:[],": ",p("div.text",{hook:nt(s.text)})]);var l}))):void 0}function Tr(t,e){return p("div.study__comments",[Ar(t,!0),p("div.study__message",e)])}function Ir(t,e){return function(n){return p("a",{hook:ae("click",(e=>(t.toggleGlyph(n.id),!1)),t.redraw),attrs:{"data-symbol":n.symbol},class:{active:!!e.glyphs&&!!e.glyphs.find((t=>t.id===n.id))}},[n.name])}}function _r(t){const e=T(null);const n=lr(500,(e=>{t.study.makeChange("toggleGlyph",t.study.withPosition({id:e}))}));return{root:t,all:e,loadGlyphs:function(){e()||N(`/study/glyphs/${document.documentElement.lang}.json`,{cache:"default"}).then((n=>{e(n),t.redraw()}))},toggleGlyph:n,redraw:t.redraw}}function Or(t){return p("div.study__glyphs",[p("div.study__message",t)])}function $r(t){return[p("label.form-label",{attrs:{for:"study-"+t.key}},t.name),p(`select#study-${t.key}.form-control`,t.choices.map((function(e){return p("option",{attrs:{value:e[0],selected:t.selected===e[0]}},e[1])})))]}function Nr(t){return p("div.study__topics",[...t.topics.getTopics().map((t=>p("a.topic",{attrs:{href:`/study/topic/${encodeURIComponent(t)}/hot`}},t))),t.members.canContribute()?p("a.manage",{hook:ae("click",(()=>t.topics.open(!0)),t.redraw)},["Manage topics"]):null])}let qr;function Dr(t,e){return we({class:"study-topics",onClose(){t.open(!1),t.redraw()},content:[p("h2","Study topics"),p("form",{hook:ce((e=>{const n=null==qr?void 0:qr.value;n&&t.save(n.map((t=>t.value)))}),t.redraw)},[p("textarea",{hook:le((t=>function(t,e){lichess.loadCssPath("tagify"),lichess.loadScript("vendor/tagify/tagify.min.js").then((()=>{let n;qr=new window.Tagify(t,{pattern:/.{2,}/,maxTags:30}),qr.on("input",(t=>{const o=t.detail.value.trim();o.length<2||(qr.settings.whitelist.length=0,n&&n.abort(),n=new AbortController,qr.loading(!0).dropdown.hide.call(qr),N(R("/study/topic/autocomplete",{term:o,user:e}),{signal:n.signal}).then((t=>{qr.settings.whitelist.splice(0,t.length,...t),qr.loading(!1).dropdown.show.call(qr,o)})))})),$(".tagify__input").each((function(){this.focus()}))}))}(t,e)))},t.getTopics().join(", ").replace(/[<>]/g,"")),p("button.button",{type:"submit"},t.trans.noarg("apply"))])]})}function Lr(t){const e=t.get();return e?p("div.notif."+e.class,e.text):void 0}function Rr(t){const e={sync:void 0,promise:t.then((t=>(e.sync=t,t)))};return e}function jr(t){switch(t){case"standard":case"chess960":case"fromPosition":return"chess";case"threeCheck":return"3check";case"kingOfTheHill":return"kingofthehill";case"racingKings":return"racingkings";default:return t}}const Fr=new RegExp(""+/^info depth (\d+) seldepth \d+ multipv (\d+) /.source+/score (cp|mate) ([-\d]+) /.source+/(?:(upper|lower)bound )?nodes (\d+) nps \S+ /.source+/(?:hashfull \d+ )?(?:tbhits \d+ )?time (\S+) /.source+/pv (.+)/.source);class Br{constructor(t,e){this.send=t,this.opts=e,this.engineNameDeferred=function(){const t={};return t.promise=new Promise(((e,n)=>{t.resolve=e,t.reject=n})),t}(),this.engineName=Rr(this.engineNameDeferred.promise),this.expectedPvs=1,this.threads=1,this.hashSize=16}init(){this.send("uci"),this.setOption("UCI_AnalyseMode","true"),this.setOption("Analysis Contempt","Off"),this.setOption("UCI_Chess960","true"),"antichess"===this.opts.variant?this.setOption("UCI_Variant","giveaway"):this.setOption("UCI_Variant",jr(this.opts.variant))}setOption(t,e){this.send(`setoption name ${t} value ${e}`)}received(t){if(t.startsWith("id name "))this.engineNameDeferred.resolve(t.substring("id name ".length));else if(t.startsWith("bestmove "))return this.work&&this.currentEval&&this.work.emit(this.currentEval),this.work=void 0,void this.swapWork();if(!this.work||this.work.stopRequested)return;const e=t.match(Fr);if(!e)return;const n=parseInt(e[1]),o=parseInt(e[2]),r="mate"===e[3],s=parseInt(e[4]),i=e[5],a=parseInt(e[6]),c=parseInt(e[7]),l=e[8].split(" ");if(r&&!s)return;if(this.expectedPvs<o&&(this.expectedPvs=o),n<6)return;const d=this.work.threatMode?0:1,u=this.work.ply%2===d?-s:s;if(i&&1===o)return;const h={moves:l,cp:r?void 0:u,mate:r?u:void 0,depth:n};1===o?this.currentEval={fen:this.work.currentFen,maxDepth:this.work.maxDepth,depth:n,knps:a/c,nodes:a,cp:r?void 0:u,mate:r?u:void 0,pvs:[h],millis:c}:this.currentEval&&(this.currentEval.pvs.push(h),this.currentEval.depth=Math.min(this.currentEval.depth,n)),o===this.expectedPvs&&this.currentEval&&this.work.emit(this.currentEval)}swapWork(){if(this.stop(),!this.work&&(this.work=this.nextWork,this.nextWork=void 0,this.work)){this.currentEval=void 0,this.expectedPvs=1;const t=this.opts.threads?this.opts.threads():1;this.threads!=t&&(this.threads=t,this.setOption("Threads",t));const e=this.opts.hashSize?this.opts.hashSize():16;this.hashSize!=e&&(this.hashSize=e,this.setOption("Hash",e)),this.setOption("MultiPV",this.work.multiPv),this.send(["position","fen",this.work.initialFen,"moves"].concat(this.work.moves).join(" ")),this.work.maxDepth>=99?this.send("go depth 99"):this.send("go movetime 90000 depth "+this.work.maxDepth)}}start(t){this.nextWork=t,this.swapWork()}stop(){this.work&&!this.work.stopRequested&&(this.work.stopRequested=!0,this.send("stop"))}isComputing(){return!!this.work&&!this.work.stopRequested}}class Gr{constructor(t,e){this.protocolOpts=t,this.opts=e,this.isComputing=()=>!!this.protocol.sync&&this.protocol.sync.isComputing(),this.engineName=()=>{var t;return null===(t=this.protocol.sync)||void 0===t?void 0:t.engineName.sync},this.protocol=Rr(this.boot())}stop(){return this.protocol.promise.then((t=>t.stop()))}start(t){return this.protocol.promise.then((e=>e.start(t)))}}class zr extends Gr{boot(){this.worker=new Worker(lichess.assetUrl(this.opts.url,{sameDomain:!0}));const t=new Br(this.send.bind(this),this.protocolOpts);return this.worker.addEventListener("message",(e=>{t.received(e.data)}),!0),t.init(),Promise.resolve(t)}destroy(){this.worker.terminate()}send(t){this.worker.postMessage(t)}}class Vr extends Gr{boot(){var t,e;const n=this.opts.version,o=this.opts.downloadProgress,r=this.opts.cache,s=this.opts.baseUrl+"stockfish.wasm";return(t=Vr.protocols)[e=this.opts.module]||(t[e]=lichess.loadScript(this.opts.baseUrl+"stockfish.js",{version:n}).then((t=>o&&new Promise((async(t,e)=>{if(r){const[e,o]=await r.get(s,n);if(e)return void t(o)}const i=new XMLHttpRequest;i.open("GET",lichess.assetUrl(s,{version:n}),!0),i.responseType="arraybuffer",i.onerror=t=>e(t),i.onprogress=t=>o(t.loaded),i.onload=e=>{o(0),t(i.response)},i.send()})))).then((async t=>(r&&t&&await r.set(s,n,t),window[this.opts.module]({wasmBinary:t,locateFile:t=>lichess.assetUrl(this.opts.baseUrl+t,{version:n,sameDomain:t.endsWith(".worker.js")}),wasmMemory:this.opts.wasmMemory})))).then((t=>{Vr.sf[this.opts.module]=t;const e=new Br(this.send.bind(this),this.protocolOpts);return t.addMessageListener(e.received.bind(e)),e.init(),e}))),Vr.protocols[this.opts.module]}destroy(){var t;null===(t=this.protocol.sync)||void 0===t||t.stop()}send(t){var e;null===(e=Vr.sf[this.opts.module])||void 0===e||e.postMessage(t)}}function Wr(t){return 2/(1+Math.exp(-.004*t))-1}function Hr(t){return void 0!==t.mate?(n=t.mate,Wr(100*(21-Math.min(10,Math.abs(n)))*(n>0?1:-1))):(e=t.cp,Wr(Math.min(Math.max(-1e3,e),1e3)));var e,n}function Ur(t,e){return function(t,e){return"white"===t?e:-e}(t,Hr(e))}function Kr(t,e,n){return(Ur(t,e)-Ur(t,n))/2}function Jr(t,e){return!e||t.depth>e.depth||t.depth===e.depth&&t.nodes>e.nodes}function Xr(t){return((t=Math.max(Math.min(Math.round(t/10)/10,99),-99))>0?"+":"")+t.toFixed(1)}function Yr(t,e){return!!e.startsWith("O-O")||"crazyhouse"!==t&&(!!e.includes("x")||(e.toLowerCase()===e||"threeCheck"===t&&e.includes("+")))}function Qr(t){return new Promise(((e,n)=>{t.oncomplete=t.onsuccess=()=>e(t.result),t.onabort=t.onerror=()=>n(t.error)}))}function Zr(t,e){const n=indexedDB.open(t);n.onupgradeneeded=()=>n.result.createObjectStore(e);const o=Qr(n);return(t,n)=>o.then((o=>n(o.transaction(e,t).objectStore(e))))}let ts;function es(){return ts||(ts=Zr("keyval-store","keyval")),ts}function ns(t,e=es()){return e("readonly",(e=>Qr(e.get(t))))}function os(t,e,n=es()){return n("readwrite",(n=>(n.put(e,t),Qr(n.transaction))))}Vr.protocols={},Vr.sf={};class rs{constructor(t){this.store=Zr(`${t}--db`,`${t}--store`)}async get(t,e){if(await ns(`${t}--version`,this.store)!==e)return[!1,void 0];return[!0,await ns(`${t}--data`,this.store)]}async set(t,e,n){await ns(`${t}--version`,this.store)!==e&&(await os(`${t}--version`,e,this.store),await os(`${t}--data`,n,this.store))}}function ss(t,e){return new WebAssembly.Memory({shared:!0,initial:t,maximum:e})}function is(){const t=lichess.tempStorage.get("ceval.enabled-after"),e=lichess.storage.get("ceval.disable");return!e||t===e}function as(t){var e;const n=e=>t.storageKeyPrefix?`${t.storageKeyPrefix}.${e}`:e,o=No("ceval.enable-nnue",!(null===(e=navigator.connection)||void 0===e?void 0:e.saveData)),r=t.standardMaterial&&["standard","fromPosition","chess960"].includes(t.variant.key);let s="asmjs",i=!1,a=!1;const c=Uint8Array.from([0,97,115,109,1,0,0,0]);if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.validate&&WebAssembly.validate(c)){s="wasm";const t=function(t,e){if("object"!=typeof Atomics)return;if("function"!=typeof SharedArrayBuffer)return;const n=ss(t,e);if(n.buffer instanceof SharedArrayBuffer){try{window.postMessage(n,"*")}catch(t){return}return n}}(8,16);if(t){s="hce";const e=Uint8Array.from([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,7,8,1,4,116,101,115,116,0,0,10,15,1,13,0,65,0,253,17,65,0,253,17,253,186,1,11]);a=WebAssembly.validate(e),a&&r&&o()&&(s="nnue");try{t.grow(8),i=!0}catch(t){}}}const l=r?2:1,d=Math.min(Math.max((navigator.hardwareConcurrency||1)-1,1),i?32:l),u=No(n("ceval.threads"),Math.min(Math.ceil((navigator.hardwareConcurrency||1)/4),d)),h=Math.min(1024*(navigator.deviceMemory||.25)/8,i?1024:16),p=No(n("ceval.hash-size"),16),m=No(n("ceval.max-depth"),18),f=No(n("ceval.multipv"),t.multiPvDefault||1),g=No("ceval.infinite",!1);let v=null;const b=T(!0),y=T(t.possible&&b()&&is()),w=T(0);let k=!1,C=!1;const x=T(null),S=T(null),M=T(!1),P={variant:t.variant.key,threads:("hce"==s||"nnue"==s)&&(()=>Math.min(parseInt(u()),d)),hashSize:("hce"==s||"nnue"==s)&&(()=>Math.min(parseInt(p()),h))};let E;const A=(()=>{const t=[];return e=>{if((t=>t.knps&&t.depth>=16&&void 0!==t.cp&&Math.abs(t.cp)<500&&t.fen.split(/\s/)[0].split(/[nbrqkp]/i).length-1>=10)(e)&&(t.push(e.knps),t.length>9)){const e=function(t){t.sort(((t,e)=>t-e));const e=Math.floor(t.length/2);return t.length%2?t[e]:(t[e-1]+t[e])/2}(t)||0;let n=18;e>100&&(n=19),e>150&&(n=20),e>250&&(n=21),e>500&&(n=22),e>1e3&&(n=23),e>2e3&&(n=24),e>3500&&(n=25),e>5e3&&(n=26),e>7e3&&(n=27),n+=2*Number("nnue"===s),m(n),t.length>40&&t.shift()}}})();let I=null;const _=lr(200,((e,n)=>{$(e.pvs,n.ply%2==(n.threatMode?1:0)?"white":"black"),A(e),v=e,t.emit(e,n),e.fen!==I&&is()&&(I=e.fen,lichess.storage.fire("ceval.fen",e.fen))})),O=()=>M()||g()?99:parseInt(m()),$=(t,e)=>t.sort((function(t,n){return Ur(e,n)-Ur(e,t)})),N=(e,n,o,a)=>{if(!y()||!t.possible||!is())return;M(a);const c=O(),l=n[n.length-1],d=o?l.threat:l.ceval;if(d&&d.depth>=c)return void(C={path:e,steps:n,threatMode:o});const u={initialFen:n[0].fen,moves:[],currentFen:l.fen,path:e,ply:l.ply,maxDepth:c,multiPv:parseInt(f()),threatMode:o,emit(t){y()&&_(t,u)},stopRequested:!1};if(o){const t=l.ply%2==1?"w":"b",e=l.fen.replace(/ (w|b) /," "+t+" ");u.currentFen=e,u.initialFen=e}else for(let e=1;e<n.length;e++){const o=n[e];Yr(t.variant.key,o.san)?(u.moves=[],u.initialFen=o.fen):u.moves.push(o.uci)}lichess.storage.fire("ceval.disable"),lichess.tempStorage.set("ceval.enabled-after",lichess.storage.get("ceval.disable")),E||(E="nnue"==s?new Vr(P,{baseUrl:"vendor/stockfish-nnue.wasm/",module:"Stockfish",downloadProgress:lr(200,(e=>{w(e),t.redraw()})),version:"85a969",wasmMemory:ss(2048,i?32768:2048),cache:new rs("ceval-wasm-cache")}):"hce"==s?new Vr(P,{baseUrl:r?"vendor/stockfish.wasm/":"vendor/stockfish-mv.wasm/",module:r?"Stockfish":"StockfishMv",wasmMemory:ss(1024,i?32768:1088)}):new zr(P,{url:"wasm"==s?"vendor/stockfish.js/stockfish.wasm.js":"vendor/stockfish.js/stockfish.js"})),E.start(u),k={path:e,steps:n,threatMode:o}};function q(){y()&&k&&(null==E||E.stop(),C=k,k=!1)}return{technology:s,start:N,stop:q,allowed:b,possible:t.possible,enabled:y,downloadProgress:w,multiPv:f,threads:"hce"==s||"nnue"==s?u:void 0,hashSize:"hce"==s||"nnue"==s?p:void 0,maxThreads:d,maxHashSize:h,infinite:g,supportsNnue:a,enableNnue:o,hovering:x,setHovering(e,n){x(n?{fen:e,uci:n}:null),t.setAutoShapes()},pvBoard:S,setPvBoard(e){S(e),t.redraw()},toggle(){if(t.possible&&b())if(q(),y()||document.hidden)lichess.tempStorage.set("ceval.enabled-after",""),y(!1);else{const t=lichess.storage.get("ceval.disable");t&&lichess.tempStorage.set("ceval.enabled-after",t),y(!0)}},curDepth:()=>v?v.depth:0,effectiveMaxDepth:O,variant:t.variant,isDeeper:M,goDeeper:function(){const t=k||C;t&&(q(),N(t.path,t.steps,t.threatMode,!0))},canGoDeeper:()=>!M()&&!g()&&!(null==E?void 0:E.isComputing()),isComputing:()=>!!k&&!!(null==E?void 0:E.isComputing()),engineName:()=>null==E?void 0:E.engineName(),destroy:()=>null==E?void 0:E.destroy(),redraw:t.redraw}}function cs(t){return t=(858993459&(t-=t>>>1&1431655765))+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24}function ls(t){return(t=t>>>8&16711935|(16711935&t)<<8)>>>16&65535|(65535&t)<<16}function ds(t){return ls(t=(t=(t=t>>>1&1431655765|(1431655765&t)<<1)>>>2&858993459|(858993459&t)<<2)>>>4&252645135|(252645135&t)<<4)}class us{constructor(t,e){this.lo=t,this.hi=e,this.lo=0|t,this.hi=0|e}static fromSquare(t){return t>=32?new us(0,1<<t-32):new us(1<<t,0)}static fromRank(t){return new us(255,0).shl64(8*t)}static fromFile(t){return new us(16843009<<t,16843009<<t)}static empty(){return new us(0,0)}static full(){return new us(4294967295,4294967295)}static corners(){return new us(129,2164260864)}static center(){return new us(402653184,24)}static backranks(){return new us(255,4278190080)}static backrank(t){return"white"===t?new us(255,0):new us(0,4278190080)}static lightSquares(){return new us(1437226410,1437226410)}static darkSquares(){return new us(2857740885,2857740885)}complement(){return new us(~this.lo,~this.hi)}xor(t){return new us(this.lo^t.lo,this.hi^t.hi)}union(t){return new us(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new us(this.lo&t.lo,this.hi&t.hi)}diff(t){return new us(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?us.empty():t>=32?new us(this.hi>>>t-32,0):t>0?new us(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?us.empty():t>=32?new us(0,this.lo<<t-32):t>0?new us(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new us(ls(this.hi),ls(this.lo))}rbit64(){return new us(ds(this.hi),ds(this.lo))}minus64(t){const e=this.lo-t.lo,n=(e&t.lo&1)+(t.lo>>>1)+(e>>>1)>>>31;return new us(e,this.hi-(t.hi+n))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return cs(this.lo)+cs(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(t){return 0!=(t>=32?this.hi&1<<t-32:this.lo&1<<t)}set(t,e){return e?this.with(t):this.without(t)}with(t){return t>=32?new us(this.lo,this.hi|1<<t-32):new us(this.lo|1<<t,this.hi)}without(t){return t>=32?new us(this.lo,this.hi&~(1<<t-32)):new us(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new us(this.lo,this.hi^1<<t-32):new us(this.lo^1<<t,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new us(this.lo&this.lo-1,this.hi):new us(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||0!=(this.lo&this.lo-1)||0!=(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}isSingleSquare(){return this.nonEmpty()&&!this.moreThanOne()}*[Symbol.iterator](){let t=this.lo,e=this.hi;for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield e}for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield 32+t}}*reversed(){let t=this.lo,e=this.hi;for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield 32+t}for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield e}}}function hs(t,e){let n=us.empty();for(const o of e){const e=t+o;0<=e&&e<64&&Math.abs(Jo(t)-Jo(e))<=2&&(n=n.with(e))}return n}function ps(t){const e=[];for(let n=0;n<64;n++)e[n]=t(n);return e}const ms=ps((t=>hs(t,[-9,-8,-7,-1,1,7,8,9]))),fs=ps((t=>hs(t,[-17,-15,-10,-6,6,10,15,17]))),gs={white:ps((t=>hs(t,[7,9]))),black:ps((t=>hs(t,[-7,-9])))};function vs(t){return ms[t]}function bs(t){return fs[t]}function ys(t,e){return gs[t][e]}const ws=ps((t=>us.fromFile(Jo(t)).without(t))),ks=ps((t=>us.fromRank(Ko(t)).without(t))),Cs=ps((t=>{const e=new us(134480385,2151686160),n=8*(Ko(t)-Jo(t));return(n>=0?e.shl64(n):e.shr64(-n)).without(t)})),xs=ps((t=>{const e=new us(270549120,16909320),n=8*(Ko(t)+Jo(t)-7);return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}));function Ss(t,e,n){let o=n.intersect(e),r=o.bswap64();return o=o.minus64(t),r=r.minus64(t.bswap64()),o.xor(r.bswap64()).intersect(e)}function Ms(t,e){const n=us.fromSquare(t);return Ss(n,Cs[t],e).xor(Ss(n,xs[t],e))}function Ps(t,e){return function(t,e){return Ss(us.fromSquare(t),ws[t],e)}(t,e).xor(function(t,e){const n=ks[t];let o=e.intersect(n),r=o.rbit64();return o=o.minus64(us.fromSquare(t)),r=r.minus64(us.fromSquare(63-t)),o.xor(r.rbit64()).intersect(n)}(t,e))}function Es(t,e){return Ms(t,e).xor(Ps(t,e))}function As(t,e){const n=us.fromSquare(e);return ks[t].intersects(n)?ks[t].with(t):xs[t].intersects(n)?xs[t].with(t):Cs[t].intersects(n)?Cs[t].with(t):ws[t].intersects(n)?ws[t].with(t):us.empty()}function Ts(t,e){return As(t,e).intersect(us.full().shl64(t).xor(us.full().shl64(e))).withoutFirst()}function Is(t,e){var n;const o=function(t,e){let n="";if(Wo(e))"pawn"!==e.role&&(n=Xo(e.role).toUpperCase()),n+="@"+Zo(e.to);else{const o=t.board.getRole(e.from);if(!o)return"--";if("king"!==o||!t.board[t.turn].has(e.to)&&2!==Math.abs(e.to-e.from)){const r=t.board.occupied.has(e.to)||"pawn"===o&&Jo(e.from)!==Jo(e.to);if("pawn"!==o){let r;if(n=Xo(o).toUpperCase(),r="king"===o?vs(e.to).intersect(t.board.king):"queen"===o?Es(e.to,t.board.occupied).intersect(t.board.queen):"rook"===o?Ps(e.to,t.board.occupied).intersect(t.board.rook):"bishop"===o?Ms(e.to,t.board.occupied).intersect(t.board.bishop):bs(e.to).intersect(t.board.knight),r=r.intersect(t.board[t.turn]).without(e.from),r.nonEmpty()){const o=t.ctx();for(const n of r)t.dests(n,o).has(e.to)||(r=r.without(n));if(r.nonEmpty()){let t=!1,o=r.intersects(us.fromRank(Ko(e.from)));r.intersects(us.fromFile(Jo(e.from)))?t=!0:o=!0,o&&(n+=Fo[Jo(e.from)]),t&&(n+=Bo[Ko(e.from)])}}}else r&&(n=Fo[Jo(e.from)]);r&&(n+="x"),n+=Zo(e.to),e.promotion&&(n+="="+Xo(e.promotion).toUpperCase())}else n=e.to>e.from?"O-O":"O-O-O"}return n}(t,e);return t.play(e),(null===(n=t.outcome())||void 0===n?void 0:n.winner)?o+"#":t.isCheck()?o+"+":o}function _s(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,t.__proto__=e}var Os,$s,Ns,qs=function(){function t(){}var e=t.prototype;return e.unwrap=function(t,e){var n=this._chain((function(e){return Os.ok(t?t(e):e)}),(function(t){return e?Os.ok(e(t)):Os.err(t)}));if(n.isErr)throw n.error;return n.value},e.map=function(t,e){return this._chain((function(e){return Os.ok(t(e))}),(function(t){return Os.err(e?e(t):t)}))},e.chain=function(t,e){return this._chain(t,e||function(t){return Os.err(t)})},t}(),Ds=function(t){function e(e){var n;return(n=t.call(this)||this).value=e,n.isOk=!0,n.isErr=!1,n}return _s(e,t),e.prototype._chain=function(t,e){return t(this.value)},e}(qs),Ls=function(t){function e(e){var n;return(n=t.call(this)||this).error=e,n.isOk=!1,n.isErr=!0,n}return _s(e,t),e.prototype._chain=function(t,e){return e(this.error)},e}(qs);!function(t){t.ok=function(t){return new Ds(t)},t.err=function(t){return new Ls(t||new Error)},t.all=function(e){if(Array.isArray(e)){for(var n=[],o=0;o<e.length;o++){var r=e[o];if(r.isErr)return r;n.push(r.value)}return t.ok(n)}for(var s={},i=Object.keys(e),a=0;a<i.length;a++){var c=e[i[a]];if(c.isErr)return c;s[i[a]]=c.value}return t.ok(s)}}(Os||(Os={}));class Rs{constructor(){}static default(){const t=new Rs;return t.reset(),t}static racingKings(){const t=new Rs;return t.occupied=new us(65535,0),t.promoted=us.empty(),t.white=new us(61680,0),t.black=new us(3855,0),t.pawn=us.empty(),t.knight=new us(6168,0),t.bishop=new us(9252,0),t.rook=new us(16962,0),t.queen=new us(129,0),t.king=new us(33024,0),t}static horde(){const t=new Rs;return t.occupied=new us(4294967295,4294901862),t.promoted=us.empty(),t.white=new us(4294967295,102),t.black=new us(0,4294901760),t.pawn=new us(4294967295,16711782),t.knight=new us(0,1107296256),t.bishop=new us(0,603979776),t.rook=new us(0,2164260864),t.queen=new us(0,134217728),t.king=new us(0,268435456),t}reset(){this.occupied=new us(65535,4294901760),this.promoted=us.empty(),this.white=new us(65535,0),this.black=new us(0,4294901760),this.pawn=new us(65280,16711680),this.knight=new us(66,1107296256),this.bishop=new us(36,603979776),this.rook=new us(129,2164260864),this.queen=new us(8,134217728),this.king=new us(16,268435456)}static empty(){const t=new Rs;return t.clear(),t}clear(){this.occupied=us.empty(),this.promoted=us.empty();for(const t of Go)this[t]=us.empty();for(const t of zo)this[t]=us.empty()}clone(){const t=new Rs;t.occupied=this.occupied,t.promoted=this.promoted;for(const e of Go)t[e]=this[e];for(const e of zo)t[e]=this[e];return t}equalsIgnorePromoted(t){return!!this.white.equals(t.white)&&zo.every((e=>this[e].equals(t[e])))}equals(t){return this.equalsIgnorePromoted(t)&&this.promoted.equals(t.promoted)}getColor(t){return this.white.has(t)?"white":this.black.has(t)?"black":void 0}getRole(t){for(const e of zo)if(this[e].has(t))return e}get(t){const e=this.getColor(t);if(!e)return;return{color:e,role:this.getRole(t),promoted:this.promoted.has(t)}}take(t){const e=this.get(t);return e&&(this.occupied=this.occupied.without(t),this[e.color]=this[e.color].without(t),this[e.role]=this[e.role].without(t),e.promoted&&(this.promoted=this.promoted.without(t))),e}set(t,e){const n=this.take(t);return this.occupied=this.occupied.with(t),this[e.color]=this[e.color].with(t),this[e.role]=this[e.role].with(t),e.promoted&&(this.promoted=this.promoted.with(t)),n}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,e){return this[t].intersect(this[e])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.king.intersect(this[t]).diff(this.promoted).singleSquare()}}class js{constructor(){}static empty(){const t=new js;for(const e of zo)t[e]=0;return t}static fromBoard(t,e){const n=new js;for(const o of zo)n[o]=t.pieces(e,o).size();return n}clone(){const t=new js;for(const e of zo)t[e]=this[e];return t}equals(t){return zo.every((e=>this[e]===t[e]))}add(t){const e=new js;for(const n of zo)e[n]=this[n]+t[n];return e}nonEmpty(){return zo.some((t=>this[t]>0))}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}count(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class Fs{constructor(t,e){this.white=t,this.black=e}static empty(){return new Fs(js.empty(),js.empty())}static fromBoard(t){return new Fs(js.fromBoard(t,"white"),js.fromBoard(t,"black"))}clone(){return new Fs(this.white.clone(),this.black.clone())}equals(t){return this.white.equals(t.white)&&this.black.equals(t.black)}add(t){return new Fs(this.white.add(t.white),this.black.add(t.black))}count(){return this.white.count()+this.black.count()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class Bs{constructor(t,e){this.white=t,this.black=e}static default(){return new Bs(3,3)}clone(){return new Bs(this.white,this.black)}equals(t){return this.white===t.white&&this.black===t.black}}!function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"}($s||($s={}));class Gs extends Error{}function zs(t){return/^\d{1,4}$/.test(t)?parseInt(t,10):void 0}function Vs(t){const e=Yo(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}}function Ws(t){const e=Rs.empty();let n=7,o=0;for(let r=0;r<t.length;r++){const s=t[r];if("/"===s&&8===o)o=0,n--;else{const i=parseInt(s,10);if(i>0)o+=i;else{if(o>=8||n<0)return Os.err(new Gs($s.Board));const i=o+8*n,a=Vs(s);if(!a)return Os.err(new Gs($s.Board));"~"===t[r+1]&&(a.promoted=!0,r++),e.set(i,a),o++}}}return 0!==n||8!==o?Os.err(new Gs($s.Board)):Os.ok(e)}function Hs(t){if(t.length>64)return Os.err(new Gs($s.Pockets));const e=Fs.empty();for(const n of t){const t=Vs(n);if(!t)return Os.err(new Gs($s.Pockets));e[t.color][t.role]++}return Os.ok(e)}function Us(t){const e=t.split("+");if(3===e.length&&""===e[0]){const t=zs(e[1]),n=zs(e[2]);return!Ho(t)||t>3||!Ho(n)||n>3?Os.err(new Gs($s.RemainingChecks)):Os.ok(new Bs(3-t,3-n))}if(2===e.length){const t=zs(e[0]),n=zs(e[1]);return!Ho(t)||t>3||!Ho(n)||n>3?Os.err(new Gs($s.RemainingChecks)):Os.ok(new Bs(t,n))}return Os.err(new Gs($s.RemainingChecks))}function Ks(t){const e=t.split(" "),n=e.shift();let o,r,s=Os.ok(void 0);if(n.endsWith("]")){const t=n.indexOf("[");if(-1===t)return Os.err(new Gs($s.Fen));o=Ws(n.substr(0,t)),s=Hs(n.substr(t+1,n.length-1-t-1))}else{const t=function(t,e,n){let o=t.indexOf(e);for(;n-- >0&&-1!==o;)o=t.indexOf(e,o+e.length);return o}(n,"/",7);-1===t?o=Ws(n):(o=Ws(n.substr(0,t)),s=Hs(n.substr(t+1)))}const i=e.shift();if(Ho(i)&&"w"!==i){if("b"!==i)return Os.err(new Gs($s.Turn));r="black"}else r="white";return o.chain((t=>{const n=e.shift(),o=Ho(n)?function(t,e){let n=us.empty();if("-"===e)return Os.ok(n);if(!/^[KQABCDEFGH]{0,2}[kqabcdefgh]{0,2}$/.test(e))return Os.err(new Gs($s.Castling));for(const o of e){const e=o.toLowerCase(),r=o===e?"black":"white",s=us.backrank(r).intersect(t[r]);let i;i="q"===e?s:"k"===e?s.reversed():us.fromSquare(e.charCodeAt(0)-"a".charCodeAt(0)).intersect(s);for(const e of i){if(t.king.has(e)&&!t.promoted.has(e))break;if(t.rook.has(e)){n=n.with(e);break}}}return Os.ok(n)}(t,n):Os.ok(us.empty()),i=e.shift();let a;if(Ho(i)&&"-"!==i&&(a=Qo(i),!Ho(a)))return Os.err(new Gs($s.EpSquare));let c,l=e.shift();Ho(l)&&l.includes("+")&&(c=Us(l),l=e.shift());const d=Ho(l)?zs(l):0;if(!Ho(d))return Os.err(new Gs($s.Halfmoves));const u=e.shift(),h=Ho(u)?zs(u):1;if(!Ho(h))return Os.err(new Gs($s.Fullmoves));const p=e.shift();let m=Os.ok(void 0);if(Ho(p)){if(Ho(c))return Os.err(new Gs($s.RemainingChecks));m=Us(p)}else Ho(c)&&(m=c);return e.length>0?Os.err(new Gs($s.Fen)):s.chain((e=>o.chain((n=>m.map((o=>({board:t,pockets:e,turn:r,unmovedRooks:n,remainingChecks:o,epSquare:a,halfmoves:d,fullmoves:Math.max(1,h)})))))))}))}function Js(t,e){let n=Xo(t.role);return"white"===t.color&&(n=n.toUpperCase()),(null==e?void 0:e.promoted)&&t.promoted&&(n+="~"),n}function Xs(t,e){let n="",o=0;for(let r=7;r>=0;r--)for(let s=0;s<8;s++){const i=s+8*r,a=t.get(i);a?(o>0&&(n+=o,o=0),n+=Js(a,e)):o++,7===s&&(o>0&&(n+=o,o=0),0!==r&&(n+="/"))}return n}!function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"}(Ns||(Ns={}));class Ys extends Error{}function Qs(t,e){return"white"===t?"a"===e?3:5:"a"===e?59:61}class Zs{constructor(){}static default(){const t=new Zs;return t.unmovedRooks=us.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new us(14,0),h:new us(96,0)},black:{a:new us(0,234881024),h:new us(0,1610612736)}},t}static empty(){const t=new Zs;return t.unmovedRooks=us.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:us.empty(),h:us.empty()},black:{a:us.empty(),h:us.empty()}},t}clone(){const t=new Zs;return t.unmovedRooks=this.unmovedRooks,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,e,n,o){const r=er(t,e),s=Qs(t,e);this.unmovedRooks=this.unmovedRooks.with(o),this.rook[t][e]=o,this.path[t][e]=Ts(o,s).with(s).union(Ts(n,r).with(r)).without(n).without(o)}static fromSetup(t){const e=Zs.empty(),n=t.unmovedRooks.intersect(t.board.rook);for(const o of Go){const r=us.backrank(o),s=t.board.kingOf(o);if(!Ho(s)||!r.has(s))continue;const i=n.intersect(t.board[o]).intersect(r),a=i.first();Ho(a)&&a<s&&e.add(o,"a",s,a);const c=i.last();Ho(c)&&s<c&&e.add(o,"h",s,c)}return e}discardRook(t){if(this.unmovedRooks.has(t)){this.unmovedRooks=this.unmovedRooks.without(t);for(const e of Go)for(const n of Vo)this.rook[e][n]===t&&(this.rook[e][n]=void 0)}}discardSide(t){this.unmovedRooks=this.unmovedRooks.diff(us.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class ti extends class{constructor(t){this.rules=t}kingAttackers(t,e,n){return function(t,e,n,o){return n[e].intersect(Ps(t,o).intersect(n.rooksAndQueens()).union(Ms(t,o).intersect(n.bishopsAndQueens())).union(bs(t).intersect(n.knight)).union(vs(t).intersect(n.king)).union(ys(Uo(e),t).intersect(n.pawn)))}(t,e,this.board,n)}dropDests(t){return us.empty()}playCaptureAt(t,e){this.halfmoves=0,"rook"===e.role&&this.castles.discardRook(t),this.pockets&&this.pockets[Uo(e.color)][e.role]++}ctx(){const t=this.isVariantEnd(),e=this.board.kingOf(this.turn);if(!Ho(e))return{king:e,blockers:us.empty(),checkers:us.empty(),variantEnd:t,mustCapture:!1};const n=Ps(e,us.empty()).intersect(this.board.rooksAndQueens()).union(Ms(e,us.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[Uo(this.turn)]);let o=us.empty();for(const t of n){const n=Ts(e,t).intersect(this.board.occupied);n.moreThanOne()||(o=o.union(n))}return{king:e,blockers:o,checkers:this.kingAttackers(e,Uo(this.turn),this.board.occupied),variantEnd:t,mustCapture:!1}}clone(){var t,e;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=null===(t=this.pockets)||void 0===t?void 0:t.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=null===(e=this.remainingChecks)||void 0===e?void 0:e.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}equalsIgnoreMoves(t){var e,n;return this.rules===t.rules&&(this.pockets?this.board.equals(t.board):this.board.equalsIgnorePromoted(t.board))&&(t.pockets&&(null===(e=this.pockets)||void 0===e?void 0:e.equals(t.pockets))||!this.pockets&&!t.pockets)&&this.turn===t.turn&&this.castles.unmovedRooks.equals(t.castles.unmovedRooks)&&this.legalEpSquare()===t.legalEpSquare()&&(t.remainingChecks&&(null===(n=this.remainingChecks)||void 0===n?void 0:n.equals(t.remainingChecks))||!this.remainingChecks&&!t.remainingChecks)}toSetup(){var t,e;return{board:this.board.clone(),pockets:null===(t=this.pockets)||void 0===t?void 0:t.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:this.legalEpSquare(),remainingChecks:null===(e=this.remainingChecks)||void 0===e?void 0:e.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return Go.every((t=>this.hasInsufficientMaterial(t)))}hasDests(t){t=t||this.ctx();for(const e of this.board[this.turn])if(this.dests(e,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,e){if(Wo(t))return!(!this.pockets||this.pockets[this.turn][t.role]<=0)&&(("pawn"!==t.role||!us.backranks().has(t.to))&&this.dropDests(e).has(t.to));{if("pawn"===t.promotion)return!1;if("king"===t.promotion&&"antichess"!==this.rules)return!1;if(!!t.promotion!==(this.board.pawn.has(t.from)&&us.backranks().has(t.to)))return!1;const n=this.dests(t.from,e);return n.has(t.to)||n.has(this.normalizeMove(t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return Ho(t)&&this.kingAttackers(t,Uo(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return!!(t?t.variantEnd:this.isVariantEnd())||(this.isInsufficientMaterial()||!this.hasDests(t))}isCheckmate(t){return!(t=t||this.ctx()).variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return!(t=t||this.ctx()).variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const e=this.variantOutcome(t);return e||(t=t||this.ctx(),this.isCheckmate(t)?{winner:Uo(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const e=new Map;if(t.variantEnd)return e;for(const n of this.board[this.turn])e.set(n,this.dests(n,t));return e}castlingSide(t){if(Wo(t))return;const e=t.to-t.from;return(2===Math.abs(e)||this.board[this.turn].has(t.to))&&this.board.king.has(t.from)?e>0?"h":"a":void 0}normalizeMove(t){const e=this.castlingSide(t);if(!e)return t;const n=this.castles.rook[this.turn][e];return{from:t.from,to:Ho(n)?n:t.to}}play(t){const e=this.turn,n=this.epSquare,o=this.castlingSide(t);if(this.epSquare=void 0,this.halfmoves+=1,"black"===e&&(this.fullmoves+=1),this.turn=Uo(e),Wo(t))this.board.set(t.to,{role:t.role,color:e}),this.pockets&&this.pockets[e][t.role]--,"pawn"===t.role&&(this.halfmoves=0);else{const r=this.board.take(t.from);if(!r)return;let s;if("pawn"===r.role){this.halfmoves=0,t.to===n&&(s=this.board.take(t.to+("white"===e?-8:8)));const o=t.from-t.to;16===Math.abs(o)&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(r.role=t.promotion,r.promoted=!0)}else if("rook"===r.role)this.castles.discardRook(t.from);else if("king"===r.role){if(o){const t=this.castles.rook[e][o];if(Ho(t)){const n=this.board.take(t);this.board.set(er(e,o),r),n&&this.board.set(Qs(e,o),n)}}if(this.castles.discardSide(e),o)return}const i=this.board.set(t.to,r)||s;i&&this.playCaptureAt(t.to,i)}}legalEpSquare(t){if(!Ho(this.epSquare))return;t=t||this.ctx();const e=this.board.pieces(this.turn,"pawn").intersect(ys(Uo(this.turn),this.epSquare));for(const n of e)if(this.dests(n,t).has(this.epSquare))return this.epSquare}}{constructor(t){super(t||"chess")}static default(){const t=new this;return t.board=Rs.default(),t.pockets=void 0,t.turn="white",t.castles=Zs.default(),t.epSquare=void 0,t.remainingChecks=void 0,t.halfmoves=0,t.fullmoves=1,t}static fromSetup(t){const e=new this;return e.board=t.board.clone(),e.pockets=void 0,e.turn=t.turn,e.castles=Zs.fromSetup(t),e.epSquare=e.validEpSquare(t.epSquare),e.remainingChecks=void 0,e.halfmoves=t.halfmoves,e.fullmoves=t.fullmoves,e.validate().map((t=>e))}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Os.err(new Ys(Ns.Empty));if(2!==this.board.king.size())return Os.err(new Ys(Ns.Kings));if(!Ho(this.board.kingOf(this.turn)))return Os.err(new Ys(Ns.Kings));const t=this.board.kingOf(Uo(this.turn));return Ho(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?Os.err(new Ys(Ns.OppositeCheck)):us.backranks().intersects(this.board.pawn)?Os.err(new Ys(Ns.PawnsOnBackrank)):this.validateCheckers():Os.err(new Ys(Ns.Kings))}validateCheckers(){const t=this.board.kingOf(this.turn);if(Ho(t)){const e=this.kingAttackers(t,Uo(this.turn),this.board.occupied);if(e.size()>2||2===e.size()&&As(e.first(),e.last()).has(t))return Os.err(new Ys(Ns.ImpossibleCheck));if(Ho(this.epSquare))for(const n of e)if(As(n,this.epSquare).has(t))return Os.err(new Ys(Ns.ImpossibleCheck))}return Os.ok(void 0)}validEpSquare(t){if(!Ho(t))return;const e="white"===this.turn?5:2,n="white"===this.turn?8:-8;if(Ko(t)!==e)return;if(this.board.occupied.has(t+n))return;const o=t-n;return this.board.pawn.has(o)&&this.board[Uo(this.turn)].has(o)?t:void 0}castlingDest(t,e){if(!Ho(e.king)||e.checkers.nonEmpty())return us.empty();const n=this.castles.rook[this.turn][t];if(!Ho(n))return us.empty();if(this.castles.path[this.turn][t].intersects(this.board.occupied))return us.empty();const o=er(this.turn,t),r=Ts(e.king,o),s=this.board.occupied.without(e.king);for(const t of r)if(this.kingAttackers(t,Uo(this.turn),s).nonEmpty())return us.empty();const i=Qs(this.turn,t),a=this.board.occupied.toggle(e.king).toggle(n).toggle(i);return this.kingAttackers(o,Uo(this.turn),a).nonEmpty()?us.empty():us.fromSquare(n)}canCaptureEp(t,e){if(!Ho(this.epSquare))return!1;if(!ys(this.turn,t).has(this.epSquare))return!1;if(!Ho(e.king))return!0;const n=this.epSquare+("white"===this.turn?-8:8),o=this.board.occupied.toggle(t).toggle(this.epSquare).toggle(n);return!this.kingAttackers(e.king,Uo(this.turn),o).intersects(o)}pseudoDests(t,e){if(e.variantEnd)return us.empty();const n=this.board.get(t);if(!n||n.color!==this.turn)return us.empty();let o=function(t,e,n){switch(t.role){case"pawn":return ys(t.color,e);case"knight":return bs(e);case"bishop":return Ms(e,n);case"rook":return Ps(e,n);case"queen":return Es(e,n);case"king":return vs(e)}}(n,t,this.board.occupied);if("pawn"===n.role){let e=this.board[Uo(this.turn)];Ho(this.epSquare)&&(e=e.with(this.epSquare)),o=o.intersect(e);const n="white"===this.turn?8:-8,r=t+n;if(0<=r&&r<64&&!this.board.occupied.has(r)){o=o.with(r);const e=r+n;("white"===this.turn?t<16:t>=48)&&!this.board.occupied.has(e)&&(o=o.with(e))}return o}return o=o.diff(this.board[this.turn]),t===e.king?o.union(this.castlingDest("a",e)).union(this.castlingDest("h",e)):o}dests(t,e){if((e=e||this.ctx()).variantEnd)return us.empty();const n=this.board.get(t);if(!n||n.color!==this.turn)return us.empty();let o,r;if("pawn"===n.role){o=ys(this.turn,t).intersect(this.board[Uo(this.turn)]);const n="white"===this.turn?8:-8,s=t+n;if(0<=s&&s<64&&!this.board.occupied.has(s)){o=o.with(s);const e=s+n;("white"===this.turn?t<16:t>=48)&&!this.board.occupied.has(e)&&(o=o.with(e))}if(Ho(this.epSquare)&&this.canCaptureEp(t,e)){const t=this.epSquare-n;(e.checkers.isEmpty()||e.checkers.singleSquare()===t)&&(r=us.fromSquare(this.epSquare))}}else o="bishop"===n.role?Ms(t,this.board.occupied):"knight"===n.role?bs(t):"rook"===n.role?Ps(t,this.board.occupied):"queen"===n.role?Es(t,this.board.occupied):vs(t);if(o=o.diff(this.board[this.turn]),Ho(e.king)){if("king"===n.role){const n=this.board.occupied.without(t);for(const t of o)this.kingAttackers(t,Uo(this.turn),n).nonEmpty()&&(o=o.without(t));return o.union(this.castlingDest("a",e)).union(this.castlingDest("h",e))}if(e.checkers.nonEmpty()){const t=e.checkers.singleSquare();if(!Ho(t))return us.empty();o=o.intersect(Ts(t,e.king).with(t))}e.blockers.has(t)&&(o=o.intersect(As(t,e.king)))}return r&&(o=o.union(r)),o}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){if(this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty())return!1;if(this.board[t].intersects(this.board.knight))return this.board[t].size()<=2&&this.board[Uo(t)].diff(this.board.king).diff(this.board.queen).isEmpty();if(this.board[t].intersects(this.board.bishop)){return(!this.board.bishop.intersects(us.darkSquares())||!this.board.bishop.intersects(us.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty()}return!0}}class ei extends ti{constructor(){super("crazyhouse")}static default(){const t=super.default();return t.pockets=Fs.empty(),t}static fromSetup(t){return super.fromSetup(t).map((e=>(e.pockets=t.pockets?t.pockets.clone():Fs.empty(),e)))}validate(){return super.validate().chain((t=>this.pockets&&(this.pockets.white.king>0||this.pockets.black.king>0)?Os.err(new Ys(Ns.Kings)):(this.pockets?this.pockets.count():0)+this.board.occupied.size()>64?Os.err(new Ys(Ns.Variant)):Os.ok(void 0)))}clone(){return super.clone()}hasInsufficientMaterial(t){return this.pockets?this.board.occupied.size()+this.pockets.count()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.white.pawn<=0&&this.pockets.black.pawn<=0&&this.pockets.white.rook<=0&&this.pockets.black.rook<=0&&this.pockets.white.queen<=0&&this.pockets.black.queen<=0:super.hasInsufficientMaterial(t)}dropDests(t){var e,n;const o=this.board.occupied.complement().intersect((null===(e=this.pockets)||void 0===e?void 0:e[this.turn].hasNonPawns())?us.full():(null===(n=this.pockets)||void 0===n?void 0:n[this.turn].hasPawns())?us.backranks().complement():us.empty());if(Ho((t=t||this.ctx()).king)&&t.checkers.nonEmpty()){const e=t.checkers.singleSquare();return Ho(e)?o.intersect(Ts(e,t.king)):us.empty()}return o}}class ni extends ti{constructor(){super("atomic")}static default(){return super.default()}static fromSetup(t){return super.fromSetup(t)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return Os.err(new Ys(Ns.Empty));if(this.board.king.size()>2)return Os.err(new Ys(Ns.Kings));const t=this.board.kingOf(Uo(this.turn));return Ho(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?Os.err(new Ys(Ns.OppositeCheck)):us.backranks().intersects(this.board.pawn)?Os.err(new Ys(Ns.PawnsOnBackrank)):Os.ok(void 0):Os.err(new Ys(Ns.Kings))}kingAttackers(t,e,n){return vs(t).intersects(this.board.pieces(e,"king"))?us.empty():super.kingAttackers(t,e,n)}playCaptureAt(t,e){super.playCaptureAt(t,e),this.board.take(t);for(const e of vs(t).intersect(this.board.occupied).diff(this.board.pawn)){const t=this.board.take(e);t&&"rook"===t.role&&this.castles.discardRook(e),t&&"king"===t.role&&this.castles.discardSide(t.color)}}hasInsufficientMaterial(t){if(this.board.pieces(Uo(t),"king").isEmpty())return!1;if(this.board[t].diff(this.board.king).isEmpty())return!0;if(this.board[Uo(t)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(us.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(us.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(us.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(us.darkSquares())}return!1}return!this.board.queen.nonEmpty()&&!this.board.pawn.nonEmpty()&&(!!this.board.knight.union(this.board.bishop).union(this.board.rook).isSingleSquare()||!!this.board.occupied.equals(this.board.knight.union(this.board.king))&&this.board.knight.size()<=2)}dests(t,e){e=e||this.ctx();let n=us.empty();for(const o of this.pseudoDests(t,e)){const e=this.clone();e.play({from:t,to:o});const r=e.board.kingOf(this.turn);!Ho(r)||Ho(e.board.kingOf(e.turn))&&!e.kingAttackers(r,e.turn,e.board.occupied).isEmpty()||(n=n.with(o))}return n}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(t){for(const t of Go)if(this.board.pieces(t,"king").isEmpty())return{winner:Uo(t)}}}class oi extends ti{constructor(){super("antichess")}static default(){const t=super.default();return t.castles=Zs.empty(),t}static fromSetup(t){return super.fromSetup(t).map((t=>(t.castles=Zs.empty(),t)))}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?Os.err(new Ys(Ns.Empty)):us.backranks().intersects(this.board.pawn)?Os.err(new Ys(Ns.PawnsOnBackrank)):Os.ok(void 0)}kingAttackers(t,e,n){return us.empty()}ctx(){const t=super.ctx(),e=this.board[Uo(this.turn)];for(const n of this.board[this.turn])if(this.pseudoDests(n,t).intersects(e)){t.mustCapture=!0;break}return t}dests(t,e){e=e||this.ctx();const n=this.pseudoDests(t,e);return e.mustCapture?n.intersect(this.board[Uo(this.turn)]):n}hasInsufficientMaterial(t){if(this.board.occupied.equals(this.board.bishop)){const e=this.board[t].intersects(us.lightSquares()),n=this.board[t].intersects(us.darkSquares()),o=this.board[Uo(t)].isDisjoint(us.lightSquares()),r=this.board[Uo(t)].isDisjoint(us.darkSquares());return e&&o||n&&r}return!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(t){if((t=t||this.ctx()).variantEnd||this.isStalemate(t))return{winner:this.turn}}}class ri extends ti{constructor(){super("kingofthehill")}static default(){return super.default()}static fromSetup(t){return super.fromSetup(t)}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.king.intersects(us.center())}variantOutcome(t){for(const t of Go)if(this.board.pieces(t,"king").intersects(us.center()))return{winner:t}}}class si extends ti{constructor(){super("3check")}static default(){const t=super.default();return t.remainingChecks=Bs.default(),t}static fromSetup(t){return super.fromSetup(t).map((e=>(e.remainingChecks=t.remainingChecks?t.remainingChecks.clone():Bs.default(),e)))}clone(){return super.clone()}hasInsufficientMaterial(t){return this.board.pieces(t,"king").equals(this.board[t])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(t){if(this.remainingChecks)for(const t of Go)if(this.remainingChecks[t]<=0)return{winner:t}}}class ii extends ti{constructor(){super("racingkings")}static default(){const t=new this;return t.board=Rs.racingKings(),t.pockets=void 0,t.turn="white",t.castles=Zs.empty(),t.epSquare=void 0,t.remainingChecks=void 0,t.halfmoves=0,t.fullmoves=1,t}static fromSetup(t){return super.fromSetup(t).map((t=>(t.castles=Zs.empty(),t)))}validate(){return this.isCheck()?Os.err(new Ys(Ns.ImpossibleCheck)):this.board.pawn.nonEmpty()?Os.err(new Ys(Ns.Variant)):super.validate()}clone(){return super.clone()}dests(t,e){if(t===(e=e||this.ctx()).king)return super.dests(t,e);let n=us.empty();for(const o of super.dests(t,e)){const e={from:t,to:o},r=this.clone();r.play(e),r.isCheck()||(n=n.with(o))}return n}hasInsufficientMaterial(t){return!1}isVariantEnd(){const t=us.fromRank(7),e=this.board.king.intersect(t);if(e.isEmpty())return!1;if("white"===this.turn||e.intersects(this.board.black))return!0;const n=this.board.kingOf("black");if(Ho(n)){const e=this.board.occupied.without(n);for(const o of vs(n).intersect(t).diff(this.board.black))if(this.kingAttackers(o,"white",e).isEmpty())return!1}return!0}variantOutcome(t){if(t?!t.variantEnd:!this.isVariantEnd())return;const e=us.fromRank(7),n=this.board.pieces("black","king").intersects(e),o=this.board.pieces("white","king").intersects(e);return n&&!o?{winner:"black"}:o&&!n?{winner:"white"}:{winner:void 0}}}class ai extends ti{constructor(){super("horde")}static default(){const t=new this;return t.board=Rs.horde(),t.pockets=void 0,t.turn="white",t.castles=Zs.default(),t.castles.discardSide("white"),t.epSquare=void 0,t.remainingChecks=void 0,t.halfmoves=0,t.fullmoves=1,t}static fromSetup(t){return super.fromSetup(t)}validate(){if(this.board.occupied.isEmpty())return Os.err(new Ys(Ns.Empty));if(!this.board.king.isSingleSquare())return Os.err(new Ys(Ns.Kings));if(!this.board.king.diff(this.board.promoted).isSingleSquare())return Os.err(new Ys(Ns.Kings));const t=this.board.kingOf(Uo(this.turn));if(Ho(t)&&this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty())return Os.err(new Ys(Ns.OppositeCheck));for(const t of Go)if(this.board.pieces(t,"pawn").intersects(us.backrank(Uo(t))))return Os.err(new Ys(Ns.PawnsOnBackrank));return this.validateCheckers()}clone(){return super.clone()}hasInsufficientMaterial(t){return!1}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(t){return this.board.white.isEmpty()?{winner:"black"}:this.board.black.isEmpty()?{winner:"white"}:void 0}}function ci(t,e){switch(t){case"chess":return ti.fromSetup(e);case"antichess":return oi.fromSetup(e);case"atomic":return ni.fromSetup(e);case"horde":return ai.fromSetup(e);case"racingkings":return ii.fromSetup(e);case"kingofthehill":return ri.fromSetup(e);case"3check":return si.fromSetup(e);case"crazyhouse":return ei.fromSetup(e)}}let li=0;const di=[...Array(8).keys()].map((t=>p(3===t?"tick.zero":"tick",{attrs:{style:`height: ${12.5*(t+1)}%`}})));function ui(t,e){const n=t.getCeval(),o=t.trans;if(!e.client){const r=n.downloadProgress()/1024/1024;return[e.server&&t.nextNodeBest()?o.noarg("usingServerAnalysis"):o.noarg("loadingEngine")+(r>=1?` (${r.toFixed(1)} MiB)`:"")]}const r=e.client.cloud?[o("depthX",e.client.depth||0),p("span.cloud",{attrs:{title:o.noarg("cloudAnalysis")}},"Cloud")]:[o("depthX",(e.client.depth||0)+"/"+e.client.maxDepth)];return n.canGoDeeper()?r.push(p("a.deeper",{attrs:{title:o.noarg("goDeeper"),"data-icon":"O"},hook:{insert:t=>t.elm.addEventListener("click",(()=>{n.goDeeper(),n.redraw()}))}})):!e.client.cloud&&e.client.knps&&r.push(", "+Math.round(e.client.knps)+" knodes/s"),r}function hi(t,e){if(!e)return t.trans.noarg("loadingEngine");let n=t.trans("depthX",(e.depth||0)+"/"+e.maxDepth);return e.knps&&(n+=", "+Math.round(e.knps)+" knodes/s"),n}function pi(t){return t.disableThreatMode&&t.disableThreatMode()?null:p("a.show-threat",{class:{active:t.threatMode(),hidden:!!t.getNode().check},attrs:{"data-icon":"7",title:t.trans.noarg("showThreat")+" (x)"},hook:{insert:e=>e.elm.addEventListener("click",t.toggleThreatMode)}})}function mi(t){return[p("span",{attrs:{title:t.engineName()||""}},"nnue"==t.technology?"Stockfish 13+":"hce"==t.technology?"Stockfish 11+":"Stockfish 10+"),"nnue"==t.technology?p("span.technology.good",{attrs:{title:"Multi-threaded WebAssembly with SIMD (efficiently updatable neural network, strongest)"}},"NNUE"):"hce"==t.technology?p("span.technology.good",{attrs:{title:"Multi-threaded WebAssembly (classical hand crafted evaluation)"}},"HCE"):"wasm"==t.technology?p("span.technology",{attrs:{title:"Single-threaded WebAssembly fallback (slow)"}},"WASM"):p("span.technology",{attrs:{title:"Single-threaded JavaScript fallback (very slow)"}},"ASMJS")]}function fi(t){const e=t.server,n=t.client;return e?n&&(n.nodes>4e6||void 0!==n.mate&&(void 0===e.mate||Math.abs(n.mate)<Math.abs(e.mate)))?n:e:n}function gi(t){if(t.ongoing||!t.showEvalGauge())return;const e=fi(t.currentEvals());let n;return e?(n=Ur("white",e),li=n):n=li,p("div.eval-gauge",{class:{empty:null===n,reverse:"black"===t.getOrientation()}},[p("div.black",{attrs:{style:`height: ${100-50*(n+1)}%`}}),...di])}function vi(t){const e=t.getCeval(),n=t.trans;if(!e.allowed()||!e.possible||!t.showComputer())return;const o=e.enabled(),r=t.currentEvals(),s=t.threatMode(),i=s&&t.getNode().threat,a=i||fi(r);let c,l;a&&void 0!==a.cp?(c=Xr(a.cp),l=r.client?Math.min(100,Math.round(100*r.client.depth/(r.client.maxDepth||e.effectiveMaxDepth()))):0):a&&P(a.mate)?(c="#"+a.mate,l=100):t.outcome()?(c="-",l=0):(c=p(o?"i.ddloader":"i"),l=0),s&&(l=i?Math.min(100,Math.round(100*i.depth/i.maxDepth)):0);const d=o?p("div.bar",p("span",{class:{threat:s},attrs:{style:`width: ${l}%`},hook:{postpatch:(t,e)=>{if(t.data.percent>l||!!t.data.threatMode!=s){const t=e.elm,n=t.parentNode;n.removeChild(t),n.appendChild(t)}e.data.percent=l,e.data.threatMode=s}}})):null,u=o?[p("pearl",[c]),p("div.engine",[...s?[n.noarg("showThreat")]:mi(e),p("span.info",t.outcome()?[n.noarg("gameOver")]:s?[hi(t,i)]:ui(t,r))])]:[c?p("pearl",[c]):null,p("help",[...mi(e),p("br"),n.noarg("inLocalBrowser")])],h=t.mandatoryCeval&&t.mandatoryCeval()?null:p("div.switch",{attrs:{title:n.noarg("toggleLocalEvaluation")+" (l)"}},[p("input#analyse-toggle-ceval.cmn-toggle.cmn-toggle--subtle",{attrs:{type:"checkbox",checked:o},hook:{insert:e=>e.elm.addEventListener("change",t.toggleCeval)}}),p("label",{attrs:{for:"analyse-toggle-ceval"}})]);return p("div.ceval"+(o?".enabled":""),{class:{computing:l<100&&e.isComputing()}},[d,...u,pi(t),h])}function bi(t){return t.getAttribute("data-fen")}function yi(t){return $(t.target).closest("div.pv").attr("data-uci")||void 0}function wi(t,e){lichess.requestIdleCallback((()=>e.setHovering(bi(t),$(t).find("div.pv:hover").attr("data-uci")||void 0)),500)}function ki(t){const e=t.getCeval();if(!e.allowed()||!e.possible||!e.enabled())return;const n=parseInt(e.multiPv()),o=t.getNode(),r=Ks(o.fen).unwrap();let s,i,a,c=!1;t.threatMode()&&o.threat?(s=o.threat.pvs,c=!0):s=o.ceval?o.ceval.pvs:[],c&&(r.turn=Uo(r.turn),"white"==r.turn&&(r.fullmoves+=1));const l=ci(jr(e.variant.key),r);return p("div.pv_box",{attrs:{"data-fen":o.fen},hook:{insert:n=>{const o=n.elm;o.addEventListener("mouseover",(e=>{const n=t.getCeval();n.setHovering(bi(o),yi(e));const r=e.target.dataset.board;if(r){a=Number(e.target.dataset.moveIndex),i=function(t){const e=[];return $(t.target).closest("div.pv").children().filter("span.pv-san").each((function(){e.push($(this).attr("data-board"))})),e}(e);const[t,o]=r.split("|");n.setPvBoard({fen:t,uci:o})}})),o.addEventListener("wheel",(e=>{if(e.preventDefault(),null!=a&&null!=i){e.deltaY<0&&a>0?a-=1:e.deltaY>0&&a<i.length-1&&(a+=1);const n=i[a];if(n){const[e,o]=n.split("|");t.getCeval().setPvBoard({fen:e,uci:o})}}})),o.addEventListener("mouseout",(()=>t.getCeval().setHovering(bi(o))));for(const e of["touchstart","mousedown"])o.addEventListener(e,(e=>{const n=yi(e);n&&(t.playUci(n),e.preventDefault())}));o.addEventListener("mouseleave",(()=>{t.getCeval().setPvBoard(null),a=null})),wi(o,e)},postpatch:(t,n)=>wi(n.elm,e)}},[...[...Array(n).keys()].map((t=>function(t,e,n,o){const r={},s=[Ci()];n&&(t||(r.attrs={"data-uci":n.moves[0]}),e>1&&s.push(p("strong",P(n.mate)?"#"+n.mate:Xr(n.cp))),o&&s.push(...function(t,e){const n=[];let o=Xs(t.board);for(let r=0;r<e.length;r++){let s;"white"===t.turn?s=`${t.fullmoves}.`:0===r&&(s=`${t.fullmoves}...`),s&&n.push(p("span",{key:s},s));const i=e[r],a=Is(t,tr(i)),c=Xs(t.board);if("--"===a)break;o+="|"+i,n.push(p("span.pv-san",{key:o,attrs:{"data-move-index":r,"data-board":`${c}|${i}`}},a))}return n}(o.clone(),n.moves.slice(0,16))));return p("div.pv.pv--nowrap",r,s)}(c,n,s[t],l.isOk?l.value:void 0))),xi(t)])}function Ci(){return p("span.pv-wrap-toggle",{hook:{insert:t=>{const e=t.elm;for(const t of["touchstart","mousedown"])e.addEventListener(t,(t=>{t.stopPropagation(),t.preventDefault(),$(e).closest(".pv").toggleClass("pv--nowrap")}))}}})}function xi(t){const e=t.getCeval().pvBoard();if(!e)return;const{fen:n,uci:o}=e,r={fen:n,lastMove:"@"===o[1]?[o.slice(2)]:[o.slice(0,2),o.slice(2,4)],orientation:t.getOrientation(),coordinates:!1,viewOnly:!0,resizable:!1,drawable:{enabled:!1,visible:!1}},s=p("div.cg-wrap.is2d",{hook:{insert:t=>t.elm._cg=window.Chessground(t.elm,r),update:t=>t.elm._cg.set(r),destroy:t=>t.elm._cg.destroy()}});return p("div.pv-board",p("div.pv-board-square",s))}lichess.storage.make("ceval.disable").listen((()=>{const t=document.getElementById("analyse-toggle-ceval");(null==t?void 0:t.checked)&&t.click()}));const Si=t=>p("glyph",{attrs:{title:t.name}},t.symbol),Mi=t=>p("eval",t.replace("-","−"));function Pi(t,e){return(t=>Math.floor((t-1)/2)+1)(t)+(e?t%2==1?".":"...":"")}function Ei(t,e){return p("index",Pi(t,e))}function Ai(t,e){const n=fi({client:e.ceval,server:e.eval}),o=[p("san",St(e.san))];return e.glyphs&&t.showGlyphs&&e.glyphs.forEach((t=>o.push(Si(t)))),e.shapes&&o.push(p("shapes")),n&&t.showEval&&(P(n.cp)?o.push(Mi(Xr(n.cp))):P(n.mate)&&o.push(Mi("#"+n.mate))),o}function Ti(t,e){if(e.san)return[Ei(e.ply,t.withDots),...Ai(t,e)]}function Ii(t){const e=Ti({withDots:!0,showEval:!1},t.currentNode());return p("div.ply-wrap",p("label.ply",[p("input",{attrs:{type:"checkbox"},hook:ae("change",(e=>{t.withPly(e.target.checked)}),t.redraw)}),...e?t.trans.vdom("startAtX",p("strong",e)):[t.trans.noarg("startAtInitialPosition")]]))}function _i(t,e){return p("input",{key:t,attrs:{spellcheck:!1,value:t},hook:le((t=>{t.onblur=function(){e(t.value,t)},t.onkeydown=function(e){"Enter"===e.key&&t.blur()}}))})}function Oi(t){return p("span",t)}let $i;function Ni(t){return p("div",function(t,e,n,o){let r=[];if("standard"!==t.setup.variant.key&&r.push(["Variant",Oi(t.setup.variant.name)]),r=r.concat(t.tags.map((t=>[t[0],e?_i(t[1],e(t[0])):Oi(t[1])]))),e){const s=t.tags.map((t=>t[0]));r.push([p("select",{hook:{insert:t=>{const e=t.elm;$i=e.value,e.addEventListener("change",(t=>{$i=e.value,$(e).parents("tr").find("input").each((function(){this.focus()}))}))},postpatch:(t,e)=>{$i=e.elm.value}}},[p("option",o.noarg("newTag")),...n.map((t=>{if(!s.includes(t))return be(t,"",t)}))]),_i("",((t,n)=>{$i&&(e($i)(t),n.value="")}))])}return p("table.study__tags.slist",p("tbody",r.map((function(t){return p("tr",{key:""+t[0]},[p("th",[t[0]]),p("td",[t[1]])])}))))}(t.tags.getChapter(),t.vm.mode.write&&t.tags.submit,t.tags.types,t.trans))}function qi(t){const e=t.tags.getChapter(),n=e.tags.map((t=>t[1])).join(","),o=e.id+t.data.name+e.name+t.data.likes+n+t.vm.mode.write;return v("div."+e.id,Ni,[t,o])}function Di(t){const e=t.root.data.analysis;return t.root.showComputer()?e?p("div.study__server-eval.ready."+e.id,{hook:le((e=>{t.lastPly(!1),lichess.requestIdleCallback((()=>lichess.loadScript("javascripts/chart/acpl.js").then((()=>{lichess.advantageChart(t.root.data,t.root.trans,e),t.chartEl(e)}))),800)}))},[p("div.study__message",ge())]):t.requested()?p("div.study__server-eval.requested.padded",ge()):function(t){const e=t.root;return p("div.study__message",e.mainline.length<5?p("p",e.trans.noarg("theChapterIsTooShortToBeAnalysed")):e.study.members.canContribute()?[p("p",[e.trans.noarg("getAFullComputerAnalysis"),p("br"),e.trans.noarg("makeSureTheChapterIsComplete")]),p("a.button.text",{attrs:{"data-icon":"",disabled:e.mainline.length<5},hook:ae("click",t.request,e.redraw)},e.trans.noarg("requestAComputerAnalysis"))]:[e.trans.noarg("onlyContributorsCanRequestAnalysis")])}(t):p("div.study__server-eval.disabled.padded","You disabled computer analysis.")}function Li(t,e,n){return{orig:t,piece:{color:n,role:e,scale:.8},brush:"green"}}function Ri(t,e,n,o){const r=tr(e),s=Zo(r.to);if(Wo(r))return[{orig:s,brush:n},Li(s,r.role,t)];const i=[{orig:Zo(r.from),dest:s,brush:n,modifiers:o}];return r.promotion&&i.push(Li(s,r.promotion,t)),i}const ji={"?!":'\n<defs>\n  <filter id="shadow">\n    <feDropShadow dx="4" dy="7" stdDeviation="5" flood-opacity="0.5" />\n  </filter>\n</defs>\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#56b4e9;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path style="fill:#ffffff;stroke-width:0.81934" d="m 37.734375,21.947266 c -3.714341,0 -7.128696,0.463992 -10.242187,1.392578 -3.113493,0.928585 -6.009037,2.130656 -8.685547,3.605468 l 4.34375,8.765626 c 2.348774,-1.201699 4.643283,-2.157093 6.882812,-2.867188 2.239529,-0.710095 4.504676,-1.064453 6.798828,-1.064453 2.294152,0 4.069851,0.463993 5.326172,1.392578 1.310944,0.873963 1.966797,2.185668 1.966797,3.933594 0,1.747925 -0.546219,3.276946 -1.638672,4.58789 -1.037831,1.256322 -2.786121,2.757934 -5.24414,4.50586 -2.785757,2.021038 -4.751362,3.961188 -5.898438,5.818359 -1.147076,1.857171 -1.720703,4.149726 -1.720703,6.88086 v 2.951171 h 10.568359 v -2.376953 c 0,-1.147076 0.137043,-2.10247 0.410156,-2.867187 0.327737,-0.764718 0.928772,-1.557613 1.802735,-2.376953 0.873963,-0.81934 2.103443,-1.802143 3.6875,-2.949219 2.130284,-1.584057 3.905982,-3.058262 5.326172,-4.423828 1.420189,-1.42019 2.485218,-2.951164 3.195312,-4.589844 0.710095,-1.63868 1.064453,-3.576877 1.064453,-5.816406 0,-4.205946 -1.583838,-7.675117 -4.751953,-10.40625 -3.113492,-2.731134 -7.510649,-4.095703 -13.191406,-4.095703 z m 24.744141,0.818359 2.048828,39.083984 h 9.75 L 76.324219,22.765625 Z M 35.357422,68.730469 c -1.966416,0 -3.63248,0.51881 -4.998047,1.55664 -1.365567,0.983208 -2.046875,2.731498 -2.046875,5.244141 0,2.403397 0.681308,4.151687 2.046875,5.244141 1.365567,1.03783 3.031631,1.55664 4.998047,1.55664 1.911793,0 3.550449,-0.51881 4.916016,-1.55664 1.365566,-1.092454 2.048828,-2.840744 2.048828,-5.244141 0,-2.512643 -0.683262,-4.260933 -2.048828,-5.244141 -1.365567,-1.03783 -3.004223,-1.55664 -4.916016,-1.55664 z m 34.003906,0 c -1.966416,0 -3.63248,0.51881 -4.998047,1.55664 -1.365566,0.983208 -2.048828,2.731498 -2.048828,5.244141 0,2.403397 0.683262,4.151687 2.048828,5.244141 1.365567,1.03783 3.031631,1.55664 4.998047,1.55664 1.911793,0 3.550449,-0.51881 4.916016,-1.55664 1.365566,-1.092454 2.046875,-2.840744 2.046875,-5.244141 0,-2.512643 -0.681309,-4.260933 -2.046875,-5.244141 -1.365567,-1.03783 -3.004223,-1.55664 -4.916016,-1.55664 z" />\n</g>\n',"?":'\n<defs>\n  <filter id="shadow">\n    <feDropShadow dx="4" dy="7" stdDeviation="5" flood-opacity="0.5" />\n  </filter>\n</defs>\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#e69f00;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path style="fill:#ffffff;stroke-width:0.932208" d="m 40.435856,60.851495 q 0,-4.661041 1.957637,-7.830548 1.957637,-3.169507 6.711897,-6.618677 4.194937,-2.983065 5.966132,-5.127144 1.864416,-2.237299 1.864416,-5.220365 0,-2.983065 -2.237299,-4.474598 -2.144079,-1.584754 -6.059353,-1.584754 -3.915273,0 -7.737326,1.21187 -3.822053,1.211871 -7.830548,3.262729 L 28.13071,24.495382 q 4.567819,-2.516962 9.881405,-4.101716 5.313586,-1.584753 11.6526,-1.584753 9.694964,0 15.008549,4.66104 5.406807,4.66104 5.406807,11.839042 0,3.822053 -1.21187,6.618677 -1.211871,2.796624 -3.635612,5.220365 -2.423741,2.33052 -6.059352,5.033923 -2.703403,1.957637 -4.194936,3.355949 -1.491533,1.398312 -2.050858,2.703403 -0.466104,1.305091 -0.466104,3.262728 v 2.703403 H 40.435856 Z m -1.491533,18.923822 q 0,-4.288156 2.33052,-5.966131 2.33052,-1.771195 5.686469,-1.771195 3.262728,0 5.593248,1.771195 2.33052,1.677975 2.33052,5.966131 0,4.101716 -2.33052,5.966132 -2.33052,1.771195 -5.593248,1.771195 -3.355949,0 -5.686469,-1.771195 -2.33052,-1.864416 -2.33052,-5.966132 z" />\n</g>\n',"??":'\n<defs>\n  <filter id="shadow">\n    <feDropShadow dx="4" dy="7" stdDeviation="5" flood-opacity="0.5" />\n  </filter>\n</defs>\n<g transform="translate(77 -18) scale(0.4)">\n  <circle style="fill:#df5353;filter:url(#shadow)" cx="50" cy="50" r="50" />\n  <path style="fill:#ffffff;stroke-width:0.810558" d="m 31.799294,22.220598 c -3.67453,-10e-7 -7.050841,0.460303 -10.130961,1.378935 -3.08012,0.918633 -5.945403,2.106934 -8.593226,3.565938 l 4.297618,8.67363 c 2.3236,-1.188818 4.592722,-2.135794 6.808247,-2.838277 2.215525,-0.702483 4.45828,-1.053299 6.727842,-1.053299 2.269562,0 4.025646,0.460305 5.268502,1.378937 1.296893,0.864596 1.945788,2.160375 1.945788,3.889565 0,1.72919 -0.541416,3.241939 -1.62216,4.538831 -1.026707,1.242856 -2.756423,2.729237 -5.188097,4.458428 -2.755898,1.999376 -4.700572,3.917682 -5.835354,5.754947 -1.13478,1.837266 -1.702564,4.106388 -1.702564,6.808248 v 2.918681 h 10.4566 v -2.34982 c 0,-1.134781 0.135856,-2.081756 0.406042,-2.838277 0.324222,-0.756521 0.918373,-1.539262 1.782969,-2.349819 0.864595,-0.810559 2.079262,-1.783901 3.646342,-2.918683 2.10745,-1.567078 3.863533,-3.025082 5.268501,-4.376012 1.404967,-1.404967 2.459422,-2.919725 3.161905,-4.540841 0.702483,-1.621116 1.053298,-3.539423 1.053298,-5.754948 0,-4.160865 -1.567492,-7.591921 -4.70165,-10.29378 -3.080121,-2.70186 -7.429774,-4.052384 -13.049642,-4.052384 z m 38.66449,0 c -3.67453,-10e-7 -7.05285,0.460303 -10.132971,1.378935 -3.08012,0.918633 -5.943393,2.106934 -8.591215,3.565938 l 4.295608,8.67363 c 2.323599,-1.188818 4.592721,-2.135794 6.808246,-2.838277 2.215526,-0.702483 4.458281,-1.053299 6.727842,-1.053299 2.269563,0 4.025647,0.460305 5.268502,1.378937 1.296893,0.864596 1.945788,2.160375 1.945788,3.889565 0,1.72919 -0.539406,3.241939 -1.62015,4.538831 -1.026707,1.242856 -2.756423,2.729237 -5.188097,4.458428 -2.755897,1.999376 -4.700572,3.917682 -5.835353,5.754947 -1.134782,1.837266 -1.702564,4.106388 -1.702564,6.808248 v 2.918681 h 10.456599 v -2.34982 c 0,-1.134781 0.133846,-2.081756 0.404032,-2.838277 0.324223,-0.756521 0.918374,-1.539262 1.782969,-2.349819 0.864596,-0.810559 2.081273,-1.783901 3.648352,-2.918683 2.107451,-1.567078 3.863534,-3.025082 5.268502,-4.376012 1.404966,-1.404967 2.45942,-2.919725 3.161904,-4.540841 0.702483,-1.621116 1.053299,-3.539423 1.053299,-5.754948 0,-4.160865 -1.567493,-7.591921 -4.701651,-10.29378 -3.08012,-2.70186 -7.429774,-4.052384 -13.049642,-4.052384 z M 29.449473,68.50341 c -1.945339,0 -3.593943,0.513038 -4.944873,1.539744 -1.350931,0.97267 -2.026192,2.702386 -2.026192,5.188098 0,2.377636 0.675261,4.107352 2.026192,5.188097 1.35093,1.026707 2.999534,1.539745 4.944873,1.539745 1.891302,0 3.51153,-0.513038 4.86246,-1.539745 1.35093,-1.080745 2.026192,-2.810461 2.026192,-5.188097 0,-2.485712 -0.675262,-4.215428 -2.026192,-5.188098 -1.35093,-1.026706 -2.971158,-1.539744 -4.86246,-1.539744 z m 38.662481,0 c -1.945339,0 -3.591933,0.513038 -4.942864,1.539744 -1.35093,0.97267 -2.026192,2.702386 -2.026192,5.188098 0,2.377636 0.675262,4.107352 2.026192,5.188097 1.350931,1.026707 2.997525,1.539745 4.942864,1.539745 1.891302,0 3.513539,-0.513038 4.864469,-1.539745 1.350931,-1.080745 2.026192,-2.810461 2.026192,-5.188097 0,-2.485712 -0.675261,-4.215428 -2.026192,-5.188098 -1.35093,-1.026706 -2.973167,-1.539744 -4.864469,-1.539744 z" />\n</g>\n'};class Fi{constructor(t,e,n,o){this.root=t,this.chapterId=e,this.trans=n,this.redraw=o,this.makeState=()=>{const t=this.root.node,e=(t.comments||[])[0],n={init:""===this.root.path,comment:e?e.text:void 0,showHint:!1},o=qt(this.root.path),r=this.root.tree.nodeAtPath(o);(this.root.onMainline||this.root.tree.pathIsMainline(o))&&(this.root.onMainline&&!t.children[0]?n.feedback="end":this.isMyMove()?(n.feedback="play",n.hint=(t.gamebook||{}).hint):this.root.onMainline?n.feedback="good":(n.feedback="bad",n.comment||(n.comment=r.children[0].gamebook.deviation)),this.state=n,n.comment||("good"===n.feedback?setTimeout(this.next,this.root.path?1e3:300):"bad"===n.feedback&&setTimeout(this.retry,800)))},this.isMyMove=()=>this.root.turnColor()===this.root.data.orientation,this.retry=()=>{let t=this.root.path;for(;t&&!this.root.tree.pathIsMainline(t);)t=qt(t);this.root.userJump(t),this.redraw()},this.next=()=>{if(!this.isMyMove()){const t=this.root.node.children[0];t&&this.root.userJump(this.root.path+t.id)}this.redraw()},this.onSpace=()=>{switch(this.state.feedback){case"bad":this.retry();break;case"end":this.root.study.goToNextChapter();break;default:this.next()}},this.onPremoveSet=()=>{this.next()},this.hint=()=>{this.state.hint&&(this.state.showHint=!this.state.showHint)},this.solution=()=>{this.root.chessground.setShapes(Ri(this.root.turnColor(),this.root.node.children[0].uci,"green"))},this.canJumpTo=t=>Dt(this.root.path,t),this.onJump=()=>{this.makeState(),setTimeout((()=>this.root.withCg((t=>t.playPremove()))),100)},this.onShapeChange=t=>{const e=this.root.node;e.gamebook&&e.gamebook.shapes&&!t.length&&(e.shapes=e.gamebook.shapes.slice(0),this.root.jump(this.root.path))},Xt(t.tree.root,(t=>{t.gamebook=t.gamebook||{},t.shapes&&(t.gamebook.shapes=t.shapes.slice(0))})),this.makeState()}}class Bi{constructor(t,e,n){this.text=t,this.doSave=e,this.redraw=n,this.edit=!1}save(t){this.text=t,this.doSave(t),this.redraw()}set(t){this.text=t||void 0}}function Gi(t){return(t?"Chapter":"Study")+" pinned comment"}function zi(t,e){const n=e?t.chapterDesc:t.studyDesc,o=t.members.canContribute()&&!t.gamebookPlay();if(n.edit)return function(t,e,n){return p("div.study-desc-form",[p("div.title",[Gi(n),p("button.button.button-empty.button-red",{attrs:{"data-icon":"L",title:"Close"},hook:ae("click",(()=>t.edit=!1),t.redraw)})]),p("form.form3",[p("div.form-group",[p("textarea#form-control.desc-text."+e,{hook:le((e=>{e.value="-"===t.text?"":t.text||"",e.onkeyup=e.onpaste=()=>{t.save(e.value.trim())},e.focus()}))})])])])}(n,e?t.data.chapter.id:t.data.id,e);const r="-"===n.text;return!n.text||r&&!o?void 0:p(`div.study-desc${e?".chapter-desc":""}${r?".empty":""}`,[o&&!r?p("div.contrib",[p("span",Gi(e)),r?null:p("a",{attrs:{"data-icon":"m",title:"Edit"},hook:ae("click",(t=>{n.edit=!0}),n.redraw)}),p("a",{attrs:{"data-icon":"q",title:"Delete"},hook:ae("click",(()=>{confirm("Delete permanent description?")&&n.save("")}))})]):null,r?p("a.text.button",{hook:ae("click",(t=>{n.edit=!0}),n.redraw)},Gi(e)):p("div.text",{hook:nt(n.text)})])}class Vi{constructor(t,e,n,o,r,s){this.id=t,this.data=e,this.send=n,this.redraw=o,this.members=r,this.log=[],this.cooldown=!1,this.setSync=t=>{this.send("relaySync",t),this.redraw()},this.loading=()=>{var t;return!this.cooldown&&(null===(t=this.data.sync)||void 0===t?void 0:t.ongoing)},this.applyChapterRelay=(t,e)=>{this.clockInterval&&clearInterval(this.clockInterval),e&&(t.relay=this.convertDate(e),br(t)||(this.clockInterval=setInterval(this.redraw,1e3)))},this.roundById=t=>this.data.rounds.find((e=>e.id==t)),this.currentRound=()=>this.roundById(this.id),this.tourPath=()=>`/broadcast/${this.data.tour.slug}/${this.data.tour.id}`,this.roundPath=t=>{const e=t||this.currentRound();return e&&`/broadcast/${this.data.tour.slug}/${e.slug}/${e.id}`},this.convertDate=t=>(void 0===t.secondsSinceLastMove||t.lastMoveAt||(t.lastMoveAt=Date.now()-1e3*t.secondsSinceLastMove),t),this.socketHandlers={relayData:t=>{var e;t.sync&&(t.sync.log=(null===(e=this.data.sync)||void 0===e?void 0:e.log)||[]),this.data=t,this.redraw()},relaySync:t=>{var e;this.data.sync=Object.assign(Object.assign({},t),{log:(null===(e=this.data.sync)||void 0===e?void 0:e.log)||t.log}),this.redraw()},relayLog:t=>{this.data.sync&&(this.data.sync.log.push(t),this.data.sync.log=this.data.sync.log.slice(-20),this.cooldown=!0,setTimeout((()=>{this.cooldown=!1,this.redraw()}),4500),this.redraw(),t.error&&console.warn(`relay synchronisation error: ${t.error}`))}},this.socketHandler=(t,e)=>{const n=this.socketHandlers[t];return!(!n||e.id!==this.id)&&(n(e),!0)},this.applyChapterRelay(s,s.relay),this.tourShow={active:(location.pathname.match(/\//g)||[]).length<5,disable:()=>{this.tourShow.active=!1}}}}class Wi{constructor(t,e,n){this.studyId=t,this.redraw=e,this.trans=n,this.loading=!1,this.page=1,this.playing=!1,this.addNode=(t,e)=>{const n=this.pager&&this.pager.currentPageResults.find((e=>e.id==t.chapterId));n&&n.playing&&(n.fen=e.fen,n.lastMove=e.uci,this.redraw())},this.reload=t=>{this.pager&&!t&&(this.loading=!0,this.redraw()),((t,e,n)=>N(`/study/${t}/multi-board?page=${e}&playing=${n}`))(this.studyId,this.page,this.playing).then((t=>{this.pager=t,t.nbPages<this.page&&(t.nbPages?this.setPage(t.nbPages):this.page=1),this.loading=!1,this.redraw()}))},this.reloadEventually=B(this.reload,1e3),this.setPage=t=>{this.page!=t&&(this.page=t,this.reload())},this.nextPage=()=>this.setPage(this.page+1),this.prevPage=()=>this.setPage(this.page-1),this.lastPage=()=>{this.pager&&this.setPage(this.pager.nbPages)},this.setPlaying=t=>{this.playing=t,this.reload()}}}function Hi(t,e){const n=e.chapters.list().map((t=>t.id)).join("");return p("div.study__multiboard",{class:{loading:t.loading,nopager:!t.pager},hook:{insert(e){t.reload(!0),e.data.chapterIds=n},postpatch(e,o){e.data.chapterIds!==n&&t.reloadEventually(),o.data.chapterIds=n}}},t.pager?function(t,e){const n=e.multiBoard;return[p("div.top",[Ki(t,n),Ui(n)]),p("div.now-playing",t.currentPageResults.map(Xi(e)))]}(t.pager,e):[ge()])}function Ui(t){return p("label.playing",[p("input",{attrs:{type:"checkbox"},hook:ae("change",(e=>{t.setPlaying(e.target.checked)}))}),t.trans.noarg("playing")])}function Ki(t,e){const n=e.page,o=Math.min(t.nbResults,(n-1)*t.maxPerPage+1),r=Math.min(t.nbResults,n*t.maxPerPage);return p("div.pager",[Ji(e.trans.noarg("first"),"W",(()=>e.setPage(1)),n>1,e),Ji(e.trans.noarg("previous"),"Y",e.prevPage,n>1,e),p("span.page",`${o}-${r} / ${t.nbResults}`),Ji(e.trans.noarg("next"),"X",e.nextPage,n<t.nbPages,e),Ji(e.trans.noarg("last"),"V",e.lastPage,n<t.nbPages,e)])}function Ji(t,e,n,o,r){return p("button.fbt",{attrs:{"data-icon":e,disabled:!o,title:t},hook:ae("mousedown",n,r.redraw)})}function Xi(t){return e=>{var n;const o=e.players?[Yi(e.players[$e(e.orientation)]),Qi(e),Yi(e.players[e.orientation])]:[p("div.name",e.name),Qi(e)];return p("a."+e.id,{attrs:{title:e.name},class:{active:!t.multiBoard.loading&&t.vm.chapterId==e.id&&!(null===(n=t.relay)||void 0===n?void 0:n.tourShow.active)},hook:ae("mousedown",(n=>t.setChapter(e.id)))},o)}}function Yi(t){return p("span.player",[t.title?`${t.title} ${t.name}`:t.name,t.rating&&p("span",""+t.rating)])}function Qi(t){return p("span.mini-board.cg-wrap.is2d",{attrs:{"data-state":`${t.fen},${t.orientation},${t.lastMove}`},hook:{insert(e){lichess.miniBoard.init(e.elm),e.data.fen=t.fen},postpatch(e,n){if(e.data.fen!==t.fen){const e=t.lastMove;(o=n.elm,r="chessground",o[(t=>`lichess-${t}`)(r)]).set({fen:t.fen,lastMove:[e[0]+e[1],e[2]+e[3]]})}var o,r;n.data.fen=t.fen}}})}function Zi(t,e,n,o,r){const s=e.socket.send,i=e.redraw,a=(()=>{const n=t.chapter.id!==t.position.chapterId,s=t.features.sticky&&!e.initialPath&&!n&&!o;return{loading:!1,tab:T(r||t.chapters.length>1?"chapters":"members"),toolTab:T("tags"),chapterId:s?t.position.chapterId:t.chapter.id,mode:{sticky:s,write:!0},behind:0,updatedAt:Date.now()-1e3*t.secondsSinceUpdate,gamebookOverride:void 0}})(),c=function(t){let e,n;return{set(o){clearTimeout(n),e=o,n=setTimeout((function(){e=void 0,t()}),o.duration)},get:()=>e}}(i),l=()=>function(t){var e;(null===(e=t.study)||void 0===e?void 0:e.data.chapter.gamebook)||lichess.loadScript("javascripts/study/tour.js").then((()=>{window.lichess.studyTour({userId:t.opts.userId,isContrib:t.study.members.canContribute(),isOwner:t.study.members.isOwner(),setTab:e=>{t.study.vm.tab(e),t.redraw()}})}))}(e),d=dr({initDict:t.members,myId:o?void 0:e.opts.userId,ownerId:t.ownerId,send:s,tab:a.tab,startTour:l,notif:c,onBecomingContributor(){a.mode.write=!0},admin:t.admin,redraw:i,trans:e.trans}),u=vr(t.chapters,s,(()=>a.tab("chapters")),(e=>((t,e)=>N(`/study/${t}/${e}/meta`))(t.id,e)),e),h=()=>u.get(a.chapterId),p=()=>e.opts.userId===t.chapter.ownerId,m=new Wi(t.id,i,e.trans),f=r?new Vi(t.id,r,s,i,d,t.chapter):void 0,g=function(t,e,n,o,r){const s=Date.now();function i(){const t=e();return"scratch"===t.from&&!!t.isNew&&Date.now()-s<9e3}const a=T(!1);return{open:a,openIfNew(){i()&&a(!0)},save(e,n){t(e,n),a(!1)},getData:e,isNew:i,trans:n,redraw:o,relay:r}}(((n,o)=>{s("editStudy",n),!o||"standard"!==t.chapter.setup.variant.key||1!==e.mainline.length||t.chapter.setup.fromFen||f||u.newForm.openInitial()}),(()=>t),e.trans,i,f);function v(){return a.mode.write&&!A()}function b(...t){return v()?(s(...t),!0):a.mode.sticky=!1}const y=function(t){const e=T(null),n=T(!1),o=T(!1),r=lr(500,(n=>{const o=e();o&&t.study.makeChange("setComment",{ch:o.chapterId,path:o.path,text:n})}));return{root:t,current:e,focus:n,opening:o,submit:function(t){e()&&r(t)},start:function(n,r,s){o(!0),e({chapterId:n,path:r,node:s}),t.userJump(r)},onSetPath(o,r,s,i){setTimeout((()=>{const a=e();!a||r===a.path&&o===a.chapterId&&a.node===s||n()&&!i||(a.chapterId=o,a.path=r,a.node=s,t.redraw())}),100)},redraw:t.redraw,delete(e,n,o){t.study.makeChange("deleteComment",{ch:e,path:n,id:o})}}}(e),w=_r(e),k=function(t,e,n){const o=lr(500,(function(n,o){t.study.makeChange("setTag",{chapterId:e().id,name:n,value:o.substr(0,140)})}));return{submit:t=>e=>o(t,e),getChapter:e,types:n}}(e,(()=>t.chapter),n),C=new Bi(t.description,B((e=>{t.description=e,s("descStudy",e)}),500),i),x=new Bi(t.chapter.description,B((e=>{t.chapter.description=e,s("descChapter",{id:a.chapterId,desc:e})}),500),i),S=function(t,e){const n=T(!1),o=T(!1),r=T(null);function s(t){t.getSelectedPoints().forEach((t=>t.select(!1)))}return lichess.pubsub.on("analysis.change",((e,n,i)=>{if(!lichess.advantageChart||o()===i)return;const a=o(void 0===i?o():i),c=r(),l=c&&c.highcharts;if(l)if(!1===a)s(l);else{const e=l.series[0].data[a-1-t.tree.root.ply];P(e)?e.select():s(l)}else o(!1)})),{root:t,reset(){n(!1),o(!1)},chapterId:e,onMergeAnalysisData(){lichess.advantageChart&&lichess.advantageChart.update(t.data)},request(){t.socket.send("requestAnalysis",e()),n(!0)},requested:n,lastPly:o,chartEl:r}}(e,(()=>a.chapterId)),M=function(t,e,n,o){const r=T(!1);return{open:r,getTopics:e,save(e){t(e),r(!1)},trans:n,redraw:o}}((t=>s("setTopics",t)),(()=>t.topics||[]),e.trans,i);function E(t){return Object.assign(Object.assign({},t),{ch:a.chapterId})}function A(){return t.chapter.gamebook&&"analyse"!==a.gamebookOverride&&("play"===a.gamebookOverride||!d.canContribute())}function I(){if(e.embed)return;const n=d.canContribute();a.mode.write=a.mode.write&&n,lichess.pubsub.emit("chat.writeable",t.features.chat),lichess.pubsub.emit("chat.permissions",{local:n}),lichess.pubsub.emit("palantir.toggle",t.features.chat&&!!d.myMember());const o=!(A()||!t.chapter.features.computer&&!t.chapter.practice);o||e.getCeval().enabled(!1),e.getCeval().allowed(o),t.chapter.features.explorer||e.explorer.disable(),e.explorer.allowed(t.chapter.features.explorer)}function _(n){const o=n.study,r=e.path,s=t.chapter.id===o.chapter.id;a.mode.sticky=a.mode.sticky&&o.features.sticky||!t.features.sticky&&o.features.sticky,a.mode.sticky&&(a.behind=0),t.position=o.position,t.name=o.name,t.visibility=o.visibility,t.features=o.features,t.settings=o.settings,t.chapter=o.chapter,t.likes=o.likes,t.liked=o.liked,t.description=o.description,x.set(t.chapter.description),C.set(t.description),document.title=t.name,d.dict(o.members),u.list(o.chapters),e.flipped=!1;const c=!a.mode.write&&s;let l;e.reloadData(n.analysis,c),a.gamebookOverride=void 0,I(),a.loading=!1,j(),f&&f.applyChapterRelay(t.chapter,o.chapter.relay),a.mode.sticky?(a.chapterId=t.position.chapterId,l=a.justSetChapterId===a.chapterId&&u.localPaths[a.chapterId]||t.position.path):l=s?r:t.chapter.relay?t.chapter.relay.path:u.localPaths[a.chapterId]||"",e.userJump(e.tree.longestValidPath(l)),a.justSetChapterId=void 0,!t.chapter.practice&&e.practice&&e.togglePractice(),t.chapter.practice&&e.restartPractice(),L&&L.onLoad(),S.reset(),y.onSetPath(t.chapter.id,e.path,e.node,!1),i(),e.startCeval()}a.mode.sticky&&!A()?e.userJump(t.position.path):t.chapter.relay&&!e.initialPath&&e.userJump(t.chapter.relay.path),I();const O=lr(700,(()=>(a.loading=!0,((t,e,n)=>{let o="/"+t+"/"+e;return n&&(o+="/"+n),N(o)})(L?"practice/load":"study",t.id,a.mode.sticky?void 0:a.chapterId).then(_,lichess.reload)))),$=lr(300,(e=>{a.mode.sticky&&e!==t.position.path&&b("setPath",E({path:e}))}));d.canContribute()&&g.openIfNew();const q=()=>e.node,D=function(t,e,n,o,r,s){const i=T(!1);return{studyId:t.id,chapter:e,isPrivate:()=>"private"===t.visibility,currentNode:n,withPly:i,relay:o,cloneable:t.features.cloneable,redraw:r,trans:s}}(t,h,q,f,i,e.trans),L=o&&Mr(e,t,o);let R;function j(){if(!A())return R=void 0;R&&R.chapterId===a.chapterId||(R=new Fi(e,a.chapterId,e.trans,i),a.mode.sticky=!1)}function F(t){return t.p.chapterId!==a.chapterId&&(a.mode.sticky&&t.s&&O(),!0)}function G(t){t&&d.setActive(t.u),a.updatedAt=Date.now()}function z(t){return Object.assign(Object.assign({},t),{ch:a.chapterId,path:e.path})}j();const V=B((()=>s("like",{liked:t.liked})),1e3);function W(t,e){const n=t===a.chapterId&&!e;(null==f?void 0:f.tourShow.active)&&(f.tourShow.disable(),n&&i()),n||(a.mode.sticky&&b("setChapter",t)||(a.mode.sticky=!1,a.behind||(a.behind=1),a.chapterId=t,O()),a.loading=!0,a.nextChapterId=t,a.justSetChapterId=t,i())}const[H,U]=[-1,1].map((t=>()=>{const e=u.list(),n=e.findIndex((t=>t.id===a.chapterId));return n<0?void 0:e[n+t]})),K={path(n){const o=n.p,r=n.w;return G(r),a.mode.sticky?o.chapterId===t.position.chapterId&&e.tree.pathExists(o.path)?(t.position.path=o.path,void(r&&r.s===lichess.sri||(e.userJump(o.path),i()))):O():(a.behind++,i())},addNode(n){const o=n.p,r=n.n,s=n.w,c=n.s;if(G(s),("multiBoard"==a.toolTab()||f&&f.tourShow.active)&&m.addNode(n.p,n.n),c&&!a.mode.sticky&&a.behind++,F(n))return void(c&&!a.mode.sticky&&i());if(c&&s&&s.s===lichess.sri)return void(t.position.path=o.path+r.id);f&&f.applyChapterRelay(t.chapter,n.relay);const l=e.tree.addNode(r,o.path);if(!l)return O();e.tree.addDests(n.d,l),c&&(t.position.path=l),(c&&a.mode.sticky||o.path===e.path&&o.path===Lt(e.mainline))&&e.jump(l),i()},deleteNode(t){const n=t.p,o=t.w;if(G(o),!(F(t)||o&&o.s===lichess.sri)){if(!e.tree.pathExists(t.p.path))return O();e.tree.deleteNodeAt(n.path),a.mode.sticky&&e.jump(e.path),i()}},promote(t){const n=t.p,o=t.w;if(G(o),!(F(t)||o&&o.s===lichess.sri)){if(!e.tree.pathExists(t.p.path))return O();e.tree.promoteAt(n.path,t.toMainline),a.mode.sticky&&e.jump(e.path),i()}},reload:O,changeChapter(e){G(e.w),a.mode.sticky||a.behind++,t.position=e.p,a.mode.sticky?O():i()},updateChapter(t){G(t.w),O()},descChapter(e){G(e.w),e.w&&e.w.s===lichess.sri||(t.chapter.id===e.chapterId&&(t.chapter.description=e.desc,x.set(e.desc)),i())},descStudy(e){G(e.w),e.w&&e.w.s===lichess.sri||(t.description=e.desc,C.set(e.desc),i())},setTopics(e){G(e.w),t.topics=e.topics,i()},addChapter(e){G(e.w),e.s&&!a.mode.sticky&&a.behind++,e.s?t.position=e.p:e.w&&e.w.s===lichess.sri&&(a.mode.write=!0,a.chapterId=e.p.chapterId),O()},members(t){d.update(t),I(),i()},chapters(t){u.list(t),h()||(a.chapterId=t[0].id,a.mode.sticky||O()),i()},shapes(t){const n=t.p,o=t.w;G(o),t.p.chapterId===a.chapterId&&(o&&o.s===lichess.sri||(e.tree.setShapes(t.s,e.path),e.path===n.path&&e.withCg((e=>e.setShapes(t.s))),i()))},validationError(t){alert(t.error)},setComment(t){const n=t.p;G(t.w),F(t)||(e.tree.setCommentAt(t.c,n.path),i())},setTags(e){G(e.w),e.chapterId===a.chapterId&&(t.chapter.tags=e.tags,i())},deleteComment(t){const n=t.p;G(t.w),F(t)||(e.tree.deleteCommentAt(t.id,n.path),i())},glyphs(t){const n=t.p;G(t.w),F(t)||(e.tree.setGlyphsAt(t.g,n.path),i())},clock(t){const n=t.p;G(t.w),F(t)||(e.tree.setClockAt(t.c,n.path),i())},forceVariation(t){const n=t.p;G(t.w),F(t)||(e.tree.forceVariationAt(n.path,t.force),i())},conceal(e){F(e)||(t.chapter.conceal=e.ply,i())},liking(e){t.likes=e.l.likes,e.w&&e.w.s===lichess.sri&&(t.liked=e.l.me),i()},error(t){alert(t)}};return{data:t,form:g,members:d,chapters:u,notif:c,commentForm:y,glyphForm:w,serverEval:S,share:D,tags:k,studyDesc:C,chapterDesc:x,topics:M,vm:a,relay:f,multiBoard:m,isUpdatedRecently:()=>Date.now()-a.updatedAt<3e5,toggleLike(){t.liked=!t.liked,i(),V()},position:()=>t.position,currentChapter:h,isChapterOwner:p,canJumpTo:n=>R?R.canJumpTo(n):void 0===t.chapter.conceal||p()||Dt(e.path,n)||e.tree.lastMainlineNode(n).ply<=t.chapter.conceal,onJump(){R?R.onJump():u.localPaths[a.chapterId]=e.path,L&&L.onJump()},withPosition:z,setPath(t,e,n){$(t),y.onSetPath(a.chapterId,t,e,n)},deleteNode(t){b("deleteNode",E({path:t,jumpTo:e.path}))},promote(t,e){b("promote",E({toMainline:e,path:t}))},forceVariation(t,e){b("forceVariation",E({force:e,path:t}))},setChapter:W,toggleSticky(){a.mode.sticky=!a.mode.sticky&&t.features.sticky,O()},toggleWrite(){a.mode.write=!a.mode.write&&d.canContribute(),O()},isWriting:v,makeChange:b,startTour:l,userJump:e.userJump,currentNode:q,practice:L,gamebookPlay:()=>R,prevChapter:H,nextChapter:U,goToPrevChapter(){const t=H();t&&W(t.id)},goToNextChapter(){const t=U();t&&W(t.id)},setGamebookOverride(t){a.gamebookOverride=t,j(),I(),e.userJump(e.path),t||O()},mutateCgConfig:function(t){t.drawable.onChange=t=>{a.mode.write&&(e.tree.setShapes(t,e.path),b("shapes",E({path:e.path,shapes:t}))),R&&R.onShapeChange(t)}},explorerGame(t,e){b("explorerGame",z({gameId:t,insert:e}))},onPremoveSet(){R&&R.onPremoveSet()},redraw:i,trans:e.trans,socketHandler:(t,e)=>{const n=K[t];return n?(n(e),!0):!!f&&f.socketHandler(t,e)}}}class ta{constructor(t){this.ctrl=t}move(){return Qt(this.ctrl)?(Zt(this.ctrl),this.ctrl.redraw(),!0):(this.stop(),this.ctrl.redraw(),!1)}evalToCp(t){return t.eval?t.eval.mate?t.eval.mate>0?990:-990:t.eval.cp:t.ply%2?990:-990}nextDelay(){if("string"!=typeof this.delay||this.ctrl.onMainline){if("realtime"===this.delay){if(this.ctrl.node.ply<2)return 1e3;const t=this.ctrl.data.game.moveCentis;if(!t)return 1500;return 10*t[this.ctrl.node.ply-this.ctrl.tree.root.ply]+130||2e3}if("cpl"===this.delay){const t=30;if(this.ctrl.node.ply>=this.ctrl.mainline.length-1)return 0;const e=this.evalToCp(this.ctrl.node),n=this.evalToCp(this.ctrl.node.children[0]);return Math.max(500,Math.min(1e4,Math.abs(e-n)*t))}return this.delay}return 1500}schedule(){this.timeout=setTimeout((()=>{this.move()&&this.schedule()}),this.nextDelay())}start(t){this.delay=t,this.stop(),this.schedule()}stop(){this.timeout&&(clearTimeout(this.timeout),this.timeout=void 0)}toggle(t){this.active(t)?this.stop():(this.active()||this.move()||this.ctrl.jump(""),this.start(t))}active(t){return!(t&&t!==this.delay||!this.timeout)}}function ea(t,e,n){ea.close();const o=$('<div id="modal-wrap"><span class="close" data-icon="L"></span></div>'),r=$(`<div id="modal-overlay" class="${e}">`).on("click",ea.close);return o.appendTo(r),t.clone().removeClass("none").appendTo(o),ea.onClose=n,o.find(".close").on("click",ea.close),o.on("click",(t=>t.stopPropagation())),$("body").addClass("overlayed").prepend(r),o}function na(t,e,n){const o="abset-"+t.id;return p("div.setting."+o,t.title?{attrs:{title:e.noarg(t.title)}}:{},[p("label",{attrs:{for:o}},e.noarg(t.name)),p("div.switch",[p("input#"+o+".cmn-toggle",{attrs:{type:"checkbox",checked:t.checked},hook:ae("change",(e=>t.change(e.target.checked)),n)}),p("label",{attrs:{for:o}})])])}function oa(t,e,n){return(n?"/embed/":"/")+(t.game?t.game.id:t)+(e?"/"+e:"")}function ra(t,e){return oa(t)+"/continue/"+e}function sa(t){return`${Math.floor((t.ply+1)/2)}${t.ply%2==1?". ":"... "}`}function ia(t,e){if(0===t.children.length)return"";let n="";const o=t.children[0];(e||o.ply%2==1)&&(n+=sa(o)),n+=St(o.san);for(let e=1;e<t.children.length;e++){const o=t.children[e];n+=` (${sa(o)}${St(o.san)}`;const r=ia(o,!1);r&&(n+=" "+r),n+=")"}const r=ia(o,t.children.length>1);return r&&(n+=" "+r),n}function aa(t){const e=t.data.game;let n=ia(t.tree.root,!0);const o=[];return"standard"!==e.variant.key&&o.push(["Variant",e.variant.name]),e.initialFen&&"rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1"!==e.initialFen&&o.push(["FEN",e.initialFen]),o.length&&(n=o.map((function(t){return"["+t[0]+' "'+t[1]+'"]'})).join("\n")+"\n\n"+n),n}function ca(t){if(!t[0])return[];if(t[0].san||(t=t.slice(1)),!t[0])return[];const e=[];return t[0].ply%2==0&&e.push(p("index",Math.floor((t[0].ply+1)/2)+"...")),t.forEach((t=>{0!==t.ply&&(t.ply%2==1&&e.push(p("index",(t.ply+1)/2+".")),e.push(p("san",St(t.san))))})),e}ea.close=()=>{$("body").removeClass("overlayed"),$("#modal-overlay").each((function(){ea.onClose&&ea.onClose(),$(this).remove()})),delete ea.onClose},ea.onClose=void 0;const la=[{name:"fast",delay:1e3},{name:"slow",delay:5e3}],da={name:"realtimeReplay",delay:"realtime"},ua={name:"byCPL",delay:"cpl"};function ha(t,e){const n=t.data.game;if("import"===n.source&&n.importedBy&&n.importedBy===e)return p("form.delete",{attrs:{method:"post",action:"/"+n.id+"/delete"},hook:ae("submit",(e=>confirm(t.trans.noarg("deleteThisImportedGame"))))},[p("button.button.text.thin",{attrs:{type:"submit","data-icon":"q"}},t.trans.noarg("delete"))])}function pa(t){const e=t.data;return p("div.autoplay",[...la,..."correspondence"===e.game.speed||E(e.game.moveCentis)?[]:[da],...e.analysis?[ua]:[]].map((e=>p("a.button.button-empty",{hook:ae("click",(()=>t.togglePlay(e.delay)),t.redraw)},t.trans.noarg(e.name)))))}function ma(t,e){return{insert:n=>{const o=n.elm;o.value=""+t(),o.addEventListener("input",(t=>e(parseInt(o.value)))),o.addEventListener("mouseout",(t=>o.blur()))}}}function fa(t,e){return p("input",{attrs:{type:"hidden",name:t,value:e}})}function ga(t){return t.study&&t.embed&&!t.ongoing?p("a.button.button-empty",{attrs:{href:"/study/"+t.study.data.id+"#"+t.study.currentChapter().id,target:"_blank",rel:"noopener","data-icon":"4"}},t.trans.noarg("openStudy")):t.study||t.ongoing||t.embed?void 0:p("form",{attrs:{method:"post",action:"/study/as"},hook:ae("submit",(e=>{const n=e.target.querySelector("input[name=pgn]");n&&(n.value=aa(t))}))},[t.synthetic?fa("pgn",""):fa("gameId",t.data.game.id),fa("orientation",t.chessground.state.orientation),fa("variant",t.data.game.variant.key),fa("fen",t.tree.root.fen),p("button.button.button-empty",{attrs:{type:"submit","data-icon":"4"}},t.trans.noarg("toStudy"))])}class va{constructor(){this.open=!1,this.toggle=()=>{this.open=!this.open}}}function ba(t){const e=t.data,n=t.trans.noarg,o=!t.ongoing&&!t.embed&&"standard"===e.game.variant.key,r=t.getCeval(),s=t.mandatoryCeval(),i=[p("div.action-menu__tools",[p("a.button.button-empty",{hook:ae("click",t.flip),attrs:ue("B")},n("flipBoard")),t.ongoing?null:p("a.button.button-empty",{attrs:Object.assign({href:e.userAnalysis?"/editor?fen="+t.node.fen:"/"+e.game.id+"/edit?fen="+t.node.fen,"data-icon":"m"},t.embed?{target:"_blank",rel:"noopener nofollow"}:{rel:"nofollow"})},n("boardEditor")),o?p("a.button.button-empty",{hook:ae("click",(t=>ea($(".continue-with.g_"+e.game.id)))),attrs:ue("U")},n("continueFromHere")):null,ga(t)])],a=r&&r.possible&&r.allowed()?[p("h2",n("computerAnalysis"))].concat([ya({name:"enable",title:(s?"Required by practice mode":"Stockfish")+" (Hotkey: z)",id:"all",checked:t.showComputer(),disabled:s,change:t.toggleComputer},t)]).concat(t.showComputer()?[ya({name:"bestMoveArrow",title:"Hotkey: a",id:"shapes",checked:t.showAutoShapes(),change:t.toggleAutoShapes},t),ya({name:"evaluationGauge",id:"gauge",checked:t.showGauge(),change:t.toggleGauge},t),ya({name:"Annotations on board",title:"Display analysis symbols on the board",id:"move-annotation",checked:t.showMoveAnnotation(),change:t.toggleMoveAnnotation},t),ya({name:"infiniteAnalysis",title:"removesTheDepthLimit",id:"infinite",checked:r.infinite(),change:t.cevalSetInfinite},t),r.supportsNnue?ya({name:"Use NNUE",title:"Downloads 10 MB neural network evaluation file (page reload required after change)",id:"enable-nnue",checked:r.enableNnue(),change:r.enableNnue},t):void 0,(c="analyse-multipv",p("div.setting",[p("label",{attrs:{for:c}},n("multipleLines")),p("input#"+c,{attrs:{type:"range",min:0,max:5,step:1},hook:ma((()=>parseInt(r.multiPv())),t.cevalSetMultiPv)}),p("div.range_value",r.multiPv()+" / 5")])),r.threads?(e=>p("div.setting",[p("label",{attrs:{for:e}},n("cpus")),p("input#"+e,{attrs:{type:"range",min:1,max:r.maxThreads,step:1},hook:ma((()=>parseInt(r.threads())),t.cevalSetThreads)}),p("div.range_value",`${r.threads()} / ${r.maxThreads}`)]))("analyse-threads"):void 0,r.hashSize?(e=>{return p("div.setting",[p("label",{attrs:{for:e}},n("memory")),p("input#"+e,{attrs:{type:"range",min:4,max:Math.floor(Math.log2(r.maxHashSize)),step:1},hook:ma((()=>Math.floor(Math.log2(parseInt(r.hashSize())))),(e=>t.cevalSetHashSize(Math.pow(2,e))))}),p("div.range_value",(o=parseInt(r.hashSize()),o<1e3?o+"MB":Math.round(o/1024)+"GB"))]);var o})("analyse-memory"):void 0]:[]):[];var c;const l=[ya({name:n("inlineNotation"),title:"Shift+I",id:"inline",checked:t.treeView.inline(),change(e){t.treeView.set(e),t.actionMenu.toggle()}},t)];return p("div.action-menu",i.concat(l).concat(a).concat(t.mainline.length>4?[p("h2",n("replayMode")),pa(t)]:[]).concat([ha(t,t.opts.userId),o?p("div.continue-with.none.g_"+e.game.id,[p("a.button",{attrs:{href:e.userAnalysis?"/?fen="+t.encodeNodeFen()+"#ai":ra(e,"ai")+"?fen="+t.node.fen,rel:"nofollow"}},n("playWithTheMachine")),p("a.button",{attrs:{href:e.userAnalysis?"/?fen="+t.encodeNodeFen()+"#friend":ra(e,"friend")+"?fen="+t.node.fen,rel:"nofollow"}},n("playWithAFriend"))]):null]))}function ya(t,e){return na(t,e.trans,e.redraw)}function wa(t){const e={};return t&&(e[t]=!0),p("move.empty",{class:e},"...")}function ka(t,e,n){const o=e.children,r=o[0];if(!r)return;const s=n.noConceal?null:n.conceal||t.concealOf(!0)(n.parentPath+r.id,r);if("hide"!==s){if(n.isMainline){const e=r.ply%2==1,i=Ma(t,r,s,!0).filter(oc);if(!o[1]&&E(i)&&!r.forceVariation)return(e?[Ei(r.ply,!1)]:[]).concat(Sa(t,r,{parentPath:n.parentPath,isMainline:!0,conceal:s})||[]);const a=r.forceVariation?void 0:ka(t,r,{parentPath:n.parentPath+r.id,isMainline:!0,conceal:s}),c={parentPath:n.parentPath,isMainline:!r.forceVariation,conceal:s};return(e?[Ei(r.ply,!1)]:[]).concat(r.forceVariation?[]:[xa(t,r,c),e?wa(c.conceal):null]).concat([p("interrupt",i.concat(Ca(t,r.forceVariation?o:o.slice(1),{parentPath:n.parentPath,isMainline:c.isMainline,conceal:s,noConceal:!s})))]).concat(e&&a?[Ei(r.ply,!1),wa(c.conceal)]:[]).concat(a||[])}return o[1]?function(t,e,n){if(!e[1]||e[2])return;if(Kt(e[1],6))return;return Sa(t,e[0],{parentPath:n.parentPath,isMainline:!1,noConceal:n.noConceal,inline:e[1]})}(t,o,n)||[Ca(t,o,n)]:Sa(t,r,n)}}function Ca(t,e,n){return p("lines",{class:{single:!e[1]}},e.map((e=>tc(t,e)||p("line",Sa(t,e,{parentPath:n.parentPath,isMainline:!1,withIndex:!0,noConceal:n.noConceal,truncate:e.comp&&!Dt(t.ctrl.path,n.parentPath+e.id)?3:void 0})))))}function xa(t,e,n){return n.isMainline?function(t,e,n){const o=n.parentPath+e.id,r=Ja(t,e,o);n.conceal&&(r[n.conceal]=!0);return p("move",{attrs:{p:o},class:r},Ai(t,e))}(t,e,n):function(t,e,n){const o=n.withIndex||e.ply%2==1,r=n.parentPath+e.id,s=[o?Ei(e.ply,!0):null,St(e.san)],i=Ja(t,e,r);n.conceal&&(i[n.conceal]=!0);e.glyphs&&e.glyphs.forEach((t=>s.push(Si(t))));return p("move",{attrs:{p:r},class:i},s)}(t,e,n)}function Sa(t,e,n){const o=n.parentPath+e.id;return 0===n.truncate?[p("move",{attrs:{p:o}},[p("index","[...]")])]:[xa(t,e,n)].concat(Ya(t,e)).concat(n.inline?function(t,e,n){return p("inline",Sa(t,e,{withIndex:!0,parentPath:n.parentPath,isMainline:!1,noConceal:n.noConceal,truncate:n.truncate}))}(t,n.inline,n):null).concat(ka(t,e,{parentPath:o,isMainline:n.isMainline,noConceal:n.noConceal,truncate:n.truncate?n.truncate-1:void 0})||[])}function Ma(t,e,n,o){if(!t.ctrl.showComments||E(e.comments))return[];const r=o?e.ply%2==0?".black ":".white ":"";return e.comments.map((o=>{if("lichess"===o.by&&!t.showComputer)return;let s="comment"+r;o.text.startsWith("Inaccuracy.")?s+=".inaccuracy":o.text.startsWith("Mistake.")?s+=".mistake":o.text.startsWith("Blunder.")&&(s+=".blunder"),n&&(s+="."+n);const i=e.comments[1]?`<span class="by">${Er(o.by)}</span>`:"";return p(s,{hook:Z(Qa(o.text,400,t),(t=>i+et(t)))})}))}const Pa=function(){return function(){return null}};function Ea(t){return p("select.selector",{hook:ae("change",(t=>{location.href="/practice/"+t.target.value}))},[p("option",{attrs:{disabled:!0,selected:!0}},"Practice list"),...t.structure.map((t=>p("optgroup",{attrs:{label:t.name}},t.studies.map((e=>be(t.id+"/"+e.slug+"/"+e.id,"",e.name))))))])}function Aa(t,e){const n=t.goal();switch(n.result){case"mate":return"Checkmate the opponent";case"mateIn":return"Checkmate the opponent in "+me("move",e);case"drawIn":return"Hold the draw for "+me("more move",e);case"equalIn":return"Equalize in "+me("move",e);case"evalIn":return t.isWhite()===n.cp>=0?"Get a winning position in "+me("move",e):"Defend for "+me("move",e);case"promotion":return"Safely promote your pawn";default:return}}function Ta(t){const e=t.currentChapter(),n=t.practice.data;return p("div.practice__side",[p("div.practice__side__title",[p("i."+n.study.id),p("div.text",[p("h1",n.study.name),p("em",n.study.desc)])]),p("div.practice__side__chapters",{hook:ae("click",(e=>{e.preventDefault();const n=e.target,o=n.parentNode.getAttribute("data-id")||n.getAttribute("data-id");return o&&t.setChapter(o,!0),!1}))},t.chapters.list().map((function(o){const r=t.vm.loading&&o.id===t.vm.nextChapterId,s=!t.vm.loading&&e&&e.id===o.id,i=n.completion[o.id]>=0?"done":"ongoing";return[p("a.ps__chapter",{key:o.id,attrs:{href:n.url+"/"+o.id,"data-id":o.id},class:{active:s,loading:r}},[p("span.status."+i,{attrs:{"data-icon":(r||s)&&"ongoing"===i?"G":"E"}}),p("h3",o.name)])]})).reduce(((t,e)=>t.concat(e)),[])),p("div.finally",[p("a.back",{attrs:{"data-icon":"I",href:"/practice",title:"More practice"}}),v("select.selector",Ea,[n])])])}function Ia(t){const e=t.study,n=e.gamebookPlay();if(!n)return;const o="play"===n.state.feedback;return p("div.gamebook-buttons",[t.path?p("a.fbt.text.back",{attrs:ue("I"),hook:ae("click",(()=>t.userJump("")),n.redraw)},"Back"):null,o?p("a.fbt.text.solution",{attrs:ue("G"),hook:ae("click",n.solution,n.redraw)},"View the solution"):void 0,_a(e)])}function _a(t){if(t.data.chapter.gamebook){const e=t.vm.gamebookOverride;if(t.members.canContribute())return p("a.fbt.text.preview",{class:{active:"play"===e},attrs:ue("v"),hook:ae("click",(()=>{t.setGamebookOverride("play"===e?void 0:"play")}),t.redraw)},"Preview");{const n="analyse"===e,o=t.gamebookPlay();if(n||o&&"end"===o.state.feedback)return p("a.fbt.text.preview",{class:{active:n},attrs:ue("A"),hook:ae("click",(()=>{t.setGamebookOverride(n?void 0:"analyse")}),t.redraw)},"Analyse")}}}function Oa(t){return p("span."+t.tab,{attrs:{title:t.hint},class:{active:t.tab===t.ctrl.vm.toolTab()},hook:ae("mousedown",(()=>{t.onClick&&t.onClick(),t.ctrl.vm.toolTab(t.tab)}),t.ctrl.redraw)},[t.count?p("count.data-count",{attrs:{"data-count":t.count}}):null,t.icon])}function $a(t){const e=t.study,n=e.members.canContribute(),o=e.data.features.sticky&&(n||e.vm.behind&&e.isUpdatedRecently()),r=t.trans.noarg;return p("div.study__buttons",[p("div.left-buttons.tabs-horiz",[o?p("a.mode.sync",{attrs:{title:r("allSyncMembersRemainOnTheSamePosition")},class:{on:e.vm.mode.sticky},hook:ae("click",e.toggleSticky)},[e.vm.behind?p("span.behind",""+e.vm.behind):p("i.is"),"SYNC"]):null,e.members.canContribute()?p("a.mode.write",{attrs:{title:r("shareChanges")},class:{on:e.vm.mode.write},hook:ae("click",e.toggleWrite)},[p("i.is"),"REC"]):null,Oa({ctrl:e,tab:"tags",hint:r("pgnTags"),icon:he("o")}),Oa({ctrl:e,tab:"comments",hint:r("commentThisPosition"),icon:he("c"),onClick(){e.commentForm.start(e.vm.chapterId,t.path,t.node)},count:(t.node.comments||[]).length}),n?Oa({ctrl:e,tab:"glyphs",hint:r("annotateWithGlyphs"),icon:p("i.glyph-icon"),count:(t.node.glyphs||[]).length}):null,Oa({ctrl:e,tab:"serverEval",hint:r("computerAnalysis"),icon:he(""),count:t.data.analysis&&"✓"}),Oa({ctrl:e,tab:"multiBoard",hint:"Multiboard",icon:he("")}),Oa({ctrl:e,tab:"share",hint:r("shareAndExport"),icon:he("$")}),e.relay?null:p("span.help",{attrs:{title:"Need help? Get the tour!","data-icon":""},hook:ae("click",e.startTour)})]),p("div.right",[_a(e)])])}function Na(t){var e;const n=t.data,o=null===(e=t.relay)||void 0===e?void 0:e.data.tour.credit,r=`${n.name}: ${t.currentChapter().name}`;return p("div.study__metadata",[p("h2",[p("span.name",{attrs:{title:r}},[r,o?p("span.credit",{hook:nt(o,!1)}):void 0]),p("span.liking.text",{class:{liked:n.liked},attrs:{"data-icon":n.liked?"":"",title:t.trans.noarg("like")},hook:ae("click",t.toggleLike)},""+n.likes)]),Nr(t),qi(t)])}function qa(t){var e;const n=t.vm.tab(),o=null===(e=t.relay)||void 0===e?void 0:e.tourShow,r=(e,r)=>p("span."+e,{class:{active:!(null==o?void 0:o.active)&&n===e},hook:ae("mousedown",(()=>{null==o||o.disable(),t.vm.tab(e)}),t.redraw)},r),s=o&&p("span.relay-tour.text",{class:{active:o.active},hook:ae("mousedown",(()=>{o.active=!0}),t.redraw),attrs:{"data-icon":""}},"Broadcast"),i=p("div.tabs-horiz",[s,r("chapters",t.trans.plural(t.relay?"nbGames":"nbChapters",t.chapters.size())),!s||t.members.canContribute()||t.data.admin?r("members",t.trans.plural("nbMembers",t.members.size())):null,t.members.isOwner()?p("span.more",{hook:ae("click",(()=>t.form.open(!t.form.open())),t.redraw)},[he("[")]):null]),a=(null==o?void 0:o.active)?function(t){const e=t.members.canContribute(),n=t.relay;return p("div.study__relay__rounds",n.data.rounds.map((o=>p("div",{key:o.id,class:{active:t.data.id==o.id}},[p("a.link",{attrs:{href:n.roundPath(o)}},o.name),o.ongoing?p("ongoing",{attrs:Object.assign(Object.assign({},ue("J")),{title:"Ongoing"})}):o.finished?p("finished",{attrs:Object.assign(Object.assign({},ue("E")),{title:"Finished"})}):null,e?p("a.act",{attrs:Object.assign(Object.assign({},ue("%")),{href:`/broadcast/round/${o.id}/edit`})}):null]))).concat(e?[p("div.add",p("a.text",{attrs:{href:`/broadcast/${n.data.tour.id}/new`,"data-icon":"O"}},t.trans.noarg("addRound")))]:[]))}(t):("members"===n?ur:wr)(t);return p("div.study__side",[i,a])}function Da(t){return t.chapters.newForm.vm.open?function(t){const e=t.root.trans,n=t.vm.tab(),o=function(e,o,r){return p("span."+e,{class:{active:n===e},attrs:{title:r},hook:ae("click",(()=>t.vm.tab(e)),t.root.redraw)},o)},r="game"===n||"pgn"===n,s=t.root.study.data.chapter,i=s.practice?"practice":P(s.conceal)?"conceal":s.gamebook?"gamebook":"normal",a=e.noarg;return we({class:"chapter-new",onClose(){t.close(),t.redraw()},noClickAway:!0,content:["edit"===n?null:p("h2",[a("newChapter"),p("i.help",{attrs:{"data-icon":""},hook:ae("click",t.startTour)})]),p("form.form3",{hook:ce((e=>{t.submit({name:pr(e,"name"),game:pr(e,"game"),variant:pr(e,"variant"),pgn:pr(e,"pgn"),orientation:pr(e,"orientation"),mode:pr(e,"mode"),fen:pr(e,"fen")||("edit"===t.vm.tab()?t.vm.editorFen():null),isDefaultName:t.vm.isDefaultName})}),t.redraw)},[p("div.form-group",[p("label.form-label",{attrs:{for:"chapter-name"}},a("name")),p("input#chapter-name.form-control",{attrs:{minlength:2,maxlength:80},hook:le((n=>{n.value||(n.value=e("chapterX",t.vm.initial()?1:t.chapters().length+1),n.onchange=function(){t.vm.isDefaultName=!1},n.select(),n.focus())}))})]),p("div.tabs-horiz",[o("init",a("empty"),a("startFromInitialPosition")),o("edit",a("editor"),a("startFromCustomPosition")),o("game","URL",a("loadAGameByUrl")),o("fen","FEN",a("loadAPositionFromFen")),o("pgn","PGN",a("loadAGameFromPgn"))]),"edit"===n?p("div.board-editor-wrap",{hook:{insert(e){Promise.all([lichess.loadModule("editor"),N(R("/editor.json",{fen:t.root.node.fen}))]).then((([n,o])=>{o.embed=!0,o.options={inlineCastling:!0,orientation:s.setup.orientation,onChange:t.vm.editorFen},t.vm.editor=window.LichessEditor(e.elm,o),t.vm.editorFen(t.vm.editor.getFen())}))},destroy:e=>{t.vm.editor=null}}},[ge()]):null,"game"===n?p("div.form-group",[p("label.form-label",{attrs:{for:"chapter-game"}},e("loadAGameFromXOrY","lichess.org","chessgames.com")),p("textarea#chapter-game.form-control",{attrs:{placeholder:a("urlOfTheGame")}})]):null,"fen"===n?p("div.form-group",[p("input#chapter-fen.form-control",{attrs:{value:t.root.node.fen,placeholder:a("loadAPositionFromFen")}})]):null,"pgn"===n?p("div.form-groupabel",[p("textarea#chapter-pgn.form-control",{attrs:{placeholder:e.plural("pasteYourPgnTextHereUpToNbGames",t.multiPgnMax)}}),window.FileReader?p("input#chapter-pgn-file.form-control",{attrs:{type:"file",accept:".pgn"},hook:ae("change",(t=>{const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=function(){document.getElementById("chapter-pgn").value=n.result},n.readAsText(e)}))}):null]):null,p("div.form-split",[p("div.form-group.form-half",[p("label.form-label",{attrs:{for:"chapter-variant"}},a("Variant")),p("select#chapter-variant.form-control",{attrs:{disabled:r}},r?[p("option",a("automatic"))]:t.vm.variants.map((t=>be(t.key,s.setup.variant.key,t.name))))]),p("div.form-group.form-half",[p("label.form-label",{attrs:{for:"chapter-orientation"}},a("orientation")),p("select#chapter-orientation.form-control",{hook:ae("change",(e=>{t.vm.editor&&t.vm.editor.setOrientation(e.target.value)}))},[..."pgn"===n?["automatic"]:[],"white","black"].map((t=>be(t,s.setup.orientation,a(t)))))])]),p("div.form-group",[p("label.form-label",{attrs:{for:"chapter-mode"}},a("analysisMode")),p("select#chapter-mode.form-control",hr.map((t=>be(t[0],i,a(t[1])))))]),ke(a("createChapter"))])]})}(t.chapters.newForm):t.chapters.editForm.current()?function(t){const e=t.current();return e?we({class:"edit-"+e.id,onClose(){t.current(null),t.redraw()},content:[p("h2",t.trans.noarg("editChapter")),p("form.form3",{hook:ce((e=>{t.submit({name:pr(e,"name"),mode:pr(e,"mode"),orientation:pr(e,"orientation"),description:pr(e,"description")})}))},[p("div.form-group",[p("label.form-label",{attrs:{for:"chapter-name"}},t.trans.noarg("name")),p("input#chapter-name.form-control",{attrs:{minlength:2,maxlength:80},hook:le((t=>{t.value||(t.value=e.name,t.select(),t.focus())}))})]),...fr(e)?gr(t,e):[ge()]]),p("div.destructive",[p(ie,{hook:ae("click",(n=>{confirm(t.trans.noarg("clearAllCommentsInThisChapter"))&&t.clearAnnotations(e.id)}))},t.trans.noarg("clearAnnotations")),p(ie,{hook:ae("click",(n=>{confirm(t.trans.noarg("deleteThisChapter"))&&t.delete(e.id)}))},t.trans.noarg("deleteChapter"))])]}):void 0}(t.chapters.editForm):t.members.inviteForm.open()?function(t){const e=t.spectators().filter((e=>!t.members()[fe(e)])).sort();return we({class:"study__invite",onClose(){t.open(!1),t.redraw()},content:[p("h2",t.trans.noarg("inviteToTheStudy")),p("p.info",{attrs:{"data-icon":""}},t.trans.noarg("pleaseOnlyInvitePeopleYouKnow")),p("div.input-wrapper",[p("input",{attrs:{placeholder:t.trans.noarg("searchByUsername")},hook:le((e=>lichess.userComplete().then((n=>{n({input:e,tag:"span",onSelect(n){e.value="",t.invite(n.name),t.redraw()}}),e.focus()}))))})]),e.length?p("div.users",e.map((function(e){return p("span.button.button-metal",{key:e,hook:ae("click",(n=>t.invite(e)))},e)}))):void 0]})}(t.members.inviteForm):t.topics.open()?Dr(t.topics,t.members.myId):t.form.open()?function(t){const e=t.getData(),n=t.isNew(),o=function(t,o){const r=t.elm;o||r.value||(r.value=e.name,n&&r.select(),r.focus())},r=[["nobody",t.trans.noarg("nobody")],["owner",t.trans.noarg("onlyMe")],["contributor",t.trans.noarg("contributors")],["member",t.trans.noarg("members")],["everyone",t.trans.noarg("everyone")]];return we({class:"study-edit",onClose(){t.open(!1),t.redraw()},content:[p("h2",t.trans.noarg(t.relay?"configureLiveBroadcast":n?"createStudy":"editStudy")),p("form.form3",{hook:ce((e=>{const o=t=>{const n=e.target.querySelector("#study-"+t);if(n)return n.value;throw`Missing form input: ${t}`};t.save({name:o("name"),visibility:o("visibility"),computer:o("computer"),explorer:o("explorer"),cloneable:o("cloneable"),chat:o("chat"),sticky:o("sticky"),description:o("description")},n)}),t.redraw)},[p("div.form-group"+(t.relay?".none":""),[p("label.form-label",{attrs:{for:"study-name"}},t.trans.noarg("name")),p("input#study-name.form-control",{attrs:{minlength:3,maxlength:100},hook:{insert:t=>o(t,!1),postpatch:(t,e)=>o(e,!0)}})]),p("div.form-split",[p("div.form-group.form-half",$r({key:"visibility",name:t.trans.noarg("visibility"),choices:[["public",t.trans.noarg("public")],["unlisted",t.trans.noarg("unlisted")],["private",t.trans.noarg("inviteOnly")]],selected:e.visibility})),p("div.form-group.form-half",$r({key:"cloneable",name:t.trans.noarg("allowCloning"),choices:r,selected:e.settings.cloneable}))]),p("div.form-split",[p("div.form-group.form-half",$r({key:"computer",name:t.trans.noarg("computerAnalysis"),choices:r.map((e=>[e[0],t.trans.noarg(e[1])])),selected:e.settings.computer})),p("div.form-group.form-half",$r({key:"explorer",name:t.trans.noarg("openingExplorer"),choices:r,selected:e.settings.explorer}))]),p("div.form-split",[p("div.form-group.form-half",$r({key:"chat",name:t.trans.noarg("chat"),choices:r,selected:e.settings.chat})),p("div.form-group.form-half",$r({key:"sticky",name:t.trans.noarg("enableSync"),choices:[["true",t.trans.noarg("yesKeepEveryoneOnTheSamePosition")],["false",t.trans.noarg("noLetPeopleBrowseFreely")]],selected:""+e.settings.sticky}))]),p("div.form-group.form-half",$r({key:"description",name:t.trans.noarg("pinnedStudyComment"),choices:[["false",t.trans.noarg("noPinnedComment")],["true",t.trans.noarg("rightUnderTheBoard")]],selected:""+e.settings.description})),p("div.form-actions"+(t.relay?"":".single"),[...t.relay?[p("a.text",{attrs:{"data-icon":"",href:`/broadcast/${t.relay.data.tour.id}/edit`}},"Tournament settings"),p("a.text",{attrs:{"data-icon":"",href:`/broadcast/round/${e.id}/edit`}},"Round settings")]:[],p("button.button",{attrs:{type:"submit"}},t.trans.noarg(n?"start":"save"))])]),p("div.destructive",[n?null:p("form",{attrs:{action:"/study/"+e.id+"/clear-chat",method:"post"},hook:ae("submit",(e=>confirm(t.trans.noarg("deleteTheStudyChatHistory"))))},[p(ie,t.trans.noarg("clearChat"))]),p("form",{attrs:{action:"/study/"+e.id+"/delete",method:"post"},hook:ae("submit",(e=>n||confirm(t.trans.noarg("deleteTheEntireStudy"))))},[p(ie,t.trans.noarg(n?"cancel":"deleteStudy"))])])]})}(t.form):void 0}function La(t){if(t.embed)return[];if(t.studyPractice)return function(t){if(t.vm.loading)return[p("div.feedback",ge())];const e=t.practice,n=t.gamebookPlay(),o=t.data.chapter.description;if(n)return o?[p("div.feedback.ongoing",[p("div.comment",{hook:nt(o)})])]:[];if(!t.data.chapter.practice)return[zi(t,!0)];switch(e.success()){case!0:return[p("a.feedback.win",t.nextChapter()?{hook:ae("click",t.goToNextChapter)}:{attrs:{href:"/practice"}},[p("span","Success!"),t.nextChapter()?"Go to next exercise":"Back to practice menu"])];case!1:return[p("a.feedback.fail",{hook:ae("click",e.reset,t.redraw)},[p("span",[Aa(e,e.goal().moves)]),p("strong","Click to retry")])];default:return[p("div.feedback.ongoing",[p("div.goal",[Aa(e,e.goal().moves-e.nbMoves())]),o?p("div.comment",{hook:nt(o)}):null]),na({name:"Load next exercise immediately",id:"autoNext",checked:e.autoNext(),change:e.autoNext},t.trans,t.redraw)]}}(t.study);const e=t.study,n=e.vm.toolTab();if(e.gamebookPlay())return[Ia(t),zi(e,!0),zi(e,!1),Na(e)];let o;switch(n){case"tags":o=Na(e);break;case"comments":o=e.vm.mode.write?function(t){const e=t.study,n=e.commentForm,o=n.current();if(!o)return Tr(t,"Select a move to comment");function r(t){const e=t.elm,r=(o.node.comments||[]).find((function(t){return Pr(t.by)&&t.by.id&&t.by.id===n.root.opts.userId}));e.value=r?r.text:"",(n.opening()||n.focus())&&requestAnimationFrame((()=>e.focus())),n.opening(!1)}return p("div.study__comments",[Ar(t,!e.members.canContribute()),p("form.form3",[n.focus()&&n.root.path!==o.path?p("p",["Commenting position after ",p("a",{hook:ae("mousedown",(()=>n.root.userJump(o.path)),n.redraw)},pe(o.node))]):null,p("div.form-group",[p("textarea#comment-text.form-control",{hook:{insert(t){r(t);const e=t.elm;e.onkeyup=e.onpaste=function(){setTimeout((()=>n.submit(e.value)),50)},e.onfocus=function(){n.focus(!0),n.redraw()},e.onblur=function(){n.focus(!1)},t.data.path=o.chapterId+o.path},postpatch(t,e){const n=o.chapterId+o.path;t.data.path!==n&&r(e),e.data.path=n}}})])])])}(t):Tr(t,e.members.canContribute()?"Press REC to comment moves":"Only the study members can comment on moves");break;case"glyphs":o=t.path?e.vm.mode.write?function(t){const e=t.all(),n=t.root.node;return p("div.study__glyphs"+(e?"":".empty"),{hook:{insert:t.loadGlyphs}},e?[p("div.move",e.move.map(Ir(t,n))),p("div.position",e.position.map(Ir(t,n))),p("div.observation",e.observation.map(Ir(t,n)))]:[p("div.study__message",ge())])}(e.glyphForm):Or("Press REC to annotate moves"):Or("Select a move to annotate");break;case"serverEval":o=Di(e.serverEval);break;case"share":o=function(t){const e=t.studyId,n=t.chapter(),o=t.isPrivate(),r=e=>t.withPly()?`${e}#${t.currentNode().ply}`:e;return p("div.study__share",[p("div.downloads",[t.cloneable?p("a.button.text",{attrs:{"data-icon":"4",href:`/study/${e}/clone`}},t.trans.noarg("cloneStudy")):null,p("a.button.text",{attrs:{"data-icon":"x",href:`/study/${e}.pgn`,download:!0}},t.trans.noarg(t.relay?"downloadAllGames":"studyPgn")),p("a.button.text",{attrs:{"data-icon":"x",href:`/study/${e}/${n.id}.pgn`,download:!0}},t.trans.noarg(t.relay?"downloadGame":"chapterPgn")),p("a.button.text",{attrs:{"data-icon":"x",href:`/study/${e}/${n.id}.gif`,download:!0}},"GIF")]),p("form.form3",[...(t.relay?[["broadcastUrl",`${t.relay.tourPath()}`],["currentRoundUrl",`${t.relay.roundPath()}`],["currentGameUrl",`${t.relay.roundPath()}/${n.id}`]]:[["studyUrl",`/study/${e}`],["currentChapterUrl",r(`/study/${e}/${n.id}`),!0]]).map((([e,n,r])=>p("div.form-group",[p("label.form-label",t.trans.noarg(e)),p("input.form-control.autoselect",{attrs:{readonly:!0,value:`${ve()}${n}`}}),...r?[Ii(t),o?null:p("p.form-help.text",{attrs:{"data-icon":""}},t.trans.noarg("youCanPasteThisInTheForumToEmbed"))]:[]]))),p("div.form-group",[p("label.form-label",t.trans.noarg("embedInYourWebsite")),p("input.form-control.autoselect",{attrs:{readonly:!0,disabled:o,value:o?t.trans.noarg("onlyPublicStudiesCanBeEmbedded"):`<iframe width=600 height=371 src="${ve()}${r(`/study/embed/${e}/${n.id}`)}" frameborder=0></iframe>`}})].concat(o?[]:[Ii(t),p("a.form-help.text",{attrs:{href:"/developers#embed-study",target:"_blank",rel:"noopener","data-icon":""}},t.trans.noarg("readMoreAboutEmbedding"))])),p("div.form-group",[p("label.form-label","FEN"),p("input.form-control.autoselect",{attrs:{readonly:!0,value:t.currentNode().fen}})])])])}(e.share);break;case"multiBoard":o=Hi(e.multiBoard,e)}return[Lr(e.notif),zi(e,!0),zi(e,!1),$a(t),o]}function Ra(t,e){const n=t.offsetWidth+4,o=t.offsetHeight+4,r=window.innerWidth,s=window.innerHeight;t.style.left=r-e.x<n?r-n+"px":t.style.left=e.x+"px",t.style.top=s-e.y<o?s-o+"px":t.style.top=e.y+"px"}function ja(t,e,n){return p("a",{attrs:{"data-icon":t},hook:ae("click",n)},e)}function Fa(t,e){const n=t.root,o=n.tree.nodeAtPath(t.path),r=n.tree.pathIsMainline(t.path)&&!n.tree.pathIsForcedVariation(t.path),s=n.trans.noarg;return p("div#analyse-cm.visible",{hook:{insert:t=>{t.elm.addEventListener("contextmenu",(t=>(t.preventDefault(),!1))),Ra(t.elm,e)},postpatch:(t,n)=>Ra(n.elm,e)}},[p("p.title",pe(o)),r?null:ja("S",s("promoteVariation"),(()=>n.promote(t.path,!1))),r?null:ja("E",s("makeMainLine"),(()=>n.promote(t.path,!0))),ja("q",s("deleteFromHere"),(()=>n.deleteNode(t.path)))].concat(n.study?function(t,e,n){return t.vm.mode.write?[p("a",{attrs:ue("c"),hook:ae("click",(()=>{t.vm.toolTab("comments"),t.commentForm.start(t.currentChapter().id,e,n)}))},t.trans.noarg("commentThisMove")),p("a.glyph-icon",{hook:ae("click",(()=>{t.vm.toolTab("glyphs"),t.userJump(e)}))},t.trans.noarg("annotateWithGlyphs"))]:[]}(n.study,t.path,o):[]).concat([r?ja("F",s("forceVariation"),(()=>n.forceVariation(t.path,!0))):null]))}function Ba(t,e){let n=function(t){let e=t;return"touches"in t&&t.touches.length>0&&(e=t.touches[0]),e.pageX||e.pageY?{x:e.pageX,y:e.pageY}:e.clientX||e.clientY?{x:e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,y:e.clientY+document.body.scrollTop+document.documentElement.scrollTop}:null}(t);if(null===n){if(e.root.contextMenuPath)return;n={x:0,y:0}}const o=$("#analyse-cm")[0]||$('<div id="analyse-cm">').appendTo($("body"))[0];e.root.contextMenuPath=e.path,document.addEventListener("click",(function t(n){2!==n.button&&(e.root.contextMenuPath=void 0,document.removeEventListener("click",t,!1),$("#analyse-cm").removeClass("visible"),e.root.redraw())}),!1),o.innerHTML="",Il(o,Fa(e,n))}function Ga(t,e,n){const o=e.children,r=o[0];if(r)return n.isMainline?o[1]||r.forceVariation?za(t,o,n)||[...r.forceVariation?[]:[Ha(t,r,{parentPath:n.parentPath,isMainline:!0,withIndex:n.withIndex}),...Ya(t,r)],p("interrupt",Va(t,r.forceVariation?o:o.slice(1),{parentPath:n.parentPath,isMainline:!0})),...r.forceVariation?[]:Ga(t,r,{parentPath:n.parentPath+r.id,isMainline:!0,withIndex:!0})||[]]:Wa(t,r,{parentPath:n.parentPath,isMainline:!0,withIndex:n.withIndex}):o[1]?za(t,o,n)||[Va(t,o,n)]:Wa(t,r,n)}function za(t,e,n){if(e[1]&&!e[2]&&!e[0].forceVariation&&!Kt(e[1],6))return Wa(t,e[0],{parentPath:n.parentPath,isMainline:n.isMainline,inline:e[1]})}function Va(t,e,n){return p("lines",e.map((e=>tc(t,e)||p("line",Wa(t,e,{parentPath:n.parentPath,isMainline:!1,withIndex:!0,truncate:e.comp&&!Dt(t.ctrl.path,n.parentPath+e.id)?3:void 0})))))}function Wa(t,e,n){const o=n.parentPath+e.id,r=Ya(t,e);return 0===n.truncate?[p("move",{attrs:{p:o}},"[...]")]:[Ha(t,e,n)].concat(r).concat(n.inline?function(t,e,n){return p("inline",Wa(t,e,{withIndex:!0,parentPath:n.parentPath,isMainline:!1}))}(t,n.inline,n):null).concat(Ga(t,e,{parentPath:o,isMainline:n.isMainline,truncate:n.truncate?n.truncate-1:void 0,withIndex:!!r[0]})||[])}function Ha(t,e,n){const o=n.parentPath+e.id,r=[n.withIndex||1&e.ply?Ei(e.ply,!0):null,St(e.san)];return e.glyphs&&t.showGlyphs&&e.glyphs.forEach((t=>r.push(Si(t)))),p("move",{attrs:{p:o},class:Ja(t,e,o)},r)}let Ua="init";function Ka(t,e){return!t.treeView.inline()&&("string"==typeof Ua&&("init"==Ua&&(window.addEventListener("resize",(()=>{Ua="rec"})),navigator.userAgent.indexOf("Edge/")>-1&&requestAnimationFrame((()=>{Ua="rec"}))),Ua=!!getComputedStyle(document.body).getPropertyValue("--col1")),!Ua)||e?function(t,e){const n=t.tree.root,o={ctrl:t,truncateComments:!t.embed,concealOf:e||Pa,showComputer:t.showComputer()&&!t.retro,showGlyphs:!!t.study||t.showComputer(),showEval:t.showComputer(),currentPath:Xa(t)},r=Ma(o,n,!1,!1);return p("div.tview2.tview2-column",{hook:Za(t)},[E(r)?null:p("interrupt",r),1&n.ply?Ei(n.ply,!1):null,1&n.ply?wa():null].concat(ka(o,n,{parentPath:"",isMainline:!0})||[]))}(t,e):function(t){const e={ctrl:t,truncateComments:!1,showComputer:t.showComputer()&&!t.retro,showGlyphs:!!t.study||t.showComputer(),showEval:!!t.study||t.showComputer(),currentPath:Xa(t)};return p("div.tview2.tview2-inline",{hook:Za(t)},[...Ya(e,t.tree.root),...Ga(e,t.tree.root,{parentPath:"",isMainline:!0})||[]])}(t)}function Ja(t,e,n){const o=t.showGlyphs&&e.glyphs?e.glyphs.map((t=>t.id)):[];return{active:n===t.ctrl.path,"context-menu":n===t.ctrl.contextMenuPath,current:n===t.currentPath,nongame:!t.currentPath&&!!t.ctrl.gamePath&&Dt(n,t.ctrl.gamePath)&&n!==t.ctrl.gamePath,inaccuracy:o.includes(6),mistake:o.includes(2),blunder:o.includes(4)}}function Xa(t){let e;return!t.synthetic&&Tt(t.data)&&t.initialPath||t.retro&&(e=t.retro.current())&&e.prev.path||t.study&&t.study.data.chapter.relay&&t.study.data.chapter.relay.path}function Ya(t,e){return!t.ctrl.showComments||E(e.comments)?[]:e.comments.map((n=>{if("lichess"===n.by&&!t.showComputer)return;const o=e.comments[1]?`<span class="by">${Er(n.by)}</span>`:"";return p("comment",{hook:Z(Qa(n.text,300,t),(t=>o+et(t)))})})).filter(oc)}function Qa(t,e,n){return n.truncateComments&&t.length>e?t.slice(0,e-10)+" [...]":t}function Za(t){return{insert:e=>{const n=e.elm;""!==t.path&&nc(t,n);const o=e=>{const n=ec(e);return null!==n&&Ba(e,{path:n,root:t}),t.redraw(),!1};n.oncontextmenu=o,function(t,e,n){let o;t.addEventListener("touchstart",(t=>{o=setTimeout((()=>{e(t),n&&n()}),610)})),t.addEventListener("touchmove",(()=>{clearTimeout(o)})),t.addEventListener("touchcancel",(()=>{clearTimeout(o)})),t.addEventListener("touchend",(()=>{clearTimeout(o)}))}(n,o,t.redraw),n.addEventListener("mousedown",(e=>{if(P(e.button)&&0!==e.button)return;const n=ec(e);n&&t.userJump(n),t.redraw()}))},postpatch:(e,n)=>{t.autoScrollRequested&&(nc(t,n.elm),t.autoScrollRequested=!1)}}}function tc(t,e){return e.comp&&t.ctrl.retro&&t.ctrl.retro.hideComputerLine(e)?p("line",t.ctrl.trans.noarg("learnFromThisMistake")):void 0}function ec(t){return t.target.getAttribute("p")||t.target.parentNode.getAttribute("p")}const nc=lr(200,((t,e)=>{const n=e.parentNode;if(!n)return;const o=e.querySelector(".active");n.scrollTop=o?o.offsetTop-n.offsetHeight/2+o.offsetHeight:t.path?99999:0})),oc=t=>!!t;function rc(t){const e={fen:t.fen,nodes:1e3*t.knodes,depth:t.depth,pvs:t.pvs.map((t=>{const e={moves:t.moves.split(" ")};return P(t.cp)?e.cp=t.cp:e.mate=t.mate,e})),cloud:!0};return P(e.pvs[0].cp)?e.cp=e.pvs[0].cp:e.mate=e.pvs[0].mate,e.cloud=!0,e}function sc(t){const e={},n=T(!1);return lichess.pubsub.on("socket.in.crowd",(t=>n(t.nb>2))),{onCeval:lr(500,(function(){const n=t.getNode(),o=n.ceval;o&&!o.cloud&&n.fen in e&&function(t){return t.nodes>5e5&&(t.depth>=20||t.nodes>3e6)}(o)&&t.canPut()&&t.send("evalPut",function(t,e){const n={fen:e.fen,knodes:Math.round(e.nodes/1e3),depth:e.depth,pvs:e.pvs.map((t=>({cp:t.cp,mate:t.mate,moves:t.moves.slice(0,10).join(" ")})))};return"standard"!==t&&(n.variant=t),n}(t.variant,o))})),fetch(o,r){const s=t.getNode();if(s.ceval&&s.ceval.cloud||!t.canGet())return;const i=e[s.fen];if(i)return t.receive(rc(i),o);if(s.fen in e)return;e[s.fen]=void 0;const a={fen:s.fen,path:o};"standard"!==t.variant&&(a.variant=t.variant),r>1&&(a.mpv=r),n()&&(a.up=!0),t.send("evalGet",a)},onCloudEval(n){e[n.fen]=n,t.receive(rc(n),n.path)}}}function ic(t,e,n){const o=`/${e.game.id}${e.player.id}/forecasts`;let r=t.steps||[];const s=T(!1);function i(t){return t.map((t=>t.ply+":"+t.uci)).join(",")}function a(t,e){return t.length>=e.length&&i(t).startsWith(i(e))}function c(t){return r.filter((e=>a(e,[t])))}function l(e){return t.onMyTurn?(e.length%2!=1?e.slice(0,-1):e).slice(0,30):(e.length%2!=0?e.slice(0,-1):e).slice(0,30)}function d(){r=r.filter((function(t,e){return 0===r.filter((function(n,o){return e!==o&&a(n,t)})).length})),r=r.filter((function(e,n){return 0===r.filter((function(o,r){return n<r&&function(e,n){for(let o=0,r=Math.min(e.length,n.length);o<r;o++)if(e[o].uci!==n[o].uci)return t.onMyTurn?0!==o&&o%2==0:o%2==1;return!0}(o,e)})).length}))}function u(){s(!0),n(),history.replaceState(null,"","#last"),lichess.reload()}function h(e){if(!function(e){return e.length>=(t.onMyTurn?1:2)}(e=l(e)))return!1;return!r.filter((t=>a(t,e))).length}function p(){t.onMyTurn||(s(!0),n(),N(o,{method:"POST",body:JSON.stringify(r),headers:{"Content-Type":"application/json"}}).then((t=>{t.reload?u():(s(!1),r=t.steps||[]),n()})))}return d(),{addNodes(t){h(t=l(t))&&(r.push(t),d(),p())},isCandidate:h,removeIndex(t){r=r.filter(((e,n)=>n!==t)),p()},list:()=>r,truncate:l,loading:s,onMyTurn:!!t.onMyTurn,findStartingWithNode:c,playAndSave:function(e){t.onMyTurn&&(s(!0),n(),N(`${o}/${e.uci}`,{method:"POST",body:JSON.stringify(c(e).filter(A).map((t=>t.slice(1)))),headers:{"Content-Type":"application/json"}}).then((t=>{t.reload?u():(s(!1),r=t.steps||[]),n()})))},reloadToLastPly:u}}function ac(t,e){if(t.embed||t.retro)return;const n=t.fork.state();if(!n.displayed)return;const o=e&&t.onMainline;return p("div.analyse__fork",{hook:le((e=>{e.addEventListener("click",(e=>{const n=e.target,o=parseInt(n.parentNode.getAttribute("data-it")||n.getAttribute("data-it")||"");t.fork.proceed(o),t.redraw()}))}))},n.node.children.map(((r,s)=>{if(!(o&&e(!0)(t.path+r.id,r)))return p("move",{class:{selected:s===n.selected},attrs:{"data-it":s}},Ti({withDots:!0,showEval:t.showComputer(),showGlyphs:t.showComputer()},r))})))}function cc(t){return!!t.children.find((function(t){return!!t.comp}))}function lc(t){return t.split(" ").slice(0,4).join(" ")}function dc(t,e){const n=t.data.game.variant.key,o=T(!0),r=T(null),s=T(null),i=T(null),a=T(!1);function c(e,n=0){if(e.tbhit||t.outcome(e))return!0;const o=e.ceval;return!!o&&(o.depth+n>=15||o.depth>=13&&o.millis>3e3)}function l(t){return t&&(t.winner?{mate:"white"===t.winner?10:-10}:{cp:0})}function d(t){return t.tbhit&&t.tbhit.best||t.ceval&&t.ceval.pvs[0].moves[0]}function u(e,n,o){let r,s;const i=t.outcome(n);if(i&&i.winner)r="goodMove";else{const o=l(n.tbhit)||(n.threefold||i&&!i.winner?{cp:0}:n.ceval),a=l(e.tbhit)||e.ceval,c=-Kr(t.bottomColor(),o,a);s=d(e),(s===n.uci||n.san.startsWith("O-O")&&s===Pt[n.uci])&&(s=void 0),r=s?c<.025?"goodMove":c<.06?"inaccuracy":c<.14?"mistake":"blunder":"goodMove"}return{prev:e,node:n,path:o,verdict:r,best:s?{uci:s,san:t.position(e).unwrap((t=>function(t,e){return Is(t.clone(),e)}(t,tr(s))),(t=>"--"))}:void 0}}function h(){return t.turnColor()===t.bottomColor()}function p(){const s=t.node;if(!o())return r(null),t.redraw();if(!ir(n,s.fen)||P(s.tbhit))if(t.showComputer()||t.toggleComputer(),t.ceval.enabled()||t.toggleCeval(),t.threatMode()&&t.toggleThreatMode(),h()){const e=i();e&&(e.uci=d(s)||e.uci,t.setAutoShapes())}else{if(r(null),s.san&&c(s)){const e=t.tree.parentNode(t.path);if(c(e,1))r(u(e,s,t.path));else{const e=t.tree.parentNode(qt(t.path));c(e,1)&&r(u(e,s,t.path))}}!a()&&function(t){const n=t.ceval;return!!n&&(n.depth>=Math.min(n.maxDepth||99,e())||n.depth>=15&&(n.cloud||n.millis>5e3))}(s)?(t.playUci(d(s)),a(!0)):t.redraw()}}function m(){ir(n,t.node.fen)?t.explorer.fetchTablebaseHit(t.node.fen).then((e=>{e&&t.node.fen===e.fen&&(t.node.tbhit=e),p()}),(()=>{P(t.node.tbhit)||(t.node.tbhit=null),p()})):p()}function f(){o(!0),m()}return lichess.requestIdleCallback(m,800),{onCeval:p,onJump(){a(!1),i(null),function(t,e){if(P(e.threefold))return;const n=lc(e.fen);let o,r=0;for(o in t)lc(t[o].fen)===n&&r++;e.threefold=r>2}(t.nodeList,t.node),m()},isMyTurn:h,comment:r,running:o,hovering:s,hinting:i,resume:f,playableDepth:e,reset(){r(null),i(null)},preUserJump(t,e){t!==e&&(o(!1),r(null))},postUserJump(t,e){t!==e&&h()&&f()},onUserMove(){o(!0)},playCommentBest(){const e=r();e&&(t.jump(qt(e.path)),e.best&&t.playUci(e.best.uci))},commentShape(e){const n=r();e&&n&&n.best?s({uci:n.best.uci}):s(null),t.setAutoShapes()},hint(){const e=t.node.ceval?t.node.ceval.pvs[0].moves[0]:null,n=i();!e||n&&"move"===n.mode?i(null):i({mode:n?"move":"piece",uci:e}),t.setAutoShapes()},currentNode:()=>t.node,bottomColor:t.bottomColor,redraw:t.redraw}}function uc(t,e){const n=t.data.game;let o=[];const r=[];let s=[];const i=T(null),a=T("find"),c=t.redraw;function l(t){return s.includes(t)}function d(){const n="white"==e?1:0;return o=function(t,e){const n=[];for(let o=1;o<t.length;o++){const r=t[o],s=t[o-1];e(r)&&r.eval&&s.eval&&Math.abs(Kr("white",s.eval,r.eval))>.1&&cc(s)&&n.push(r)}return n}(t.mainline,(t=>t.ply%2===n&&!r.includes(t.ply))),o.find((t=>!l(t.ply)))}function u(){a("find");const e=d();if(!e)return i(null),c();const o={node:e,path:t.mainlinePathToPly(e.ply)},s=qt(o.path),l={node:t.tree.nodeAtPath(s),path:s},h=l.node.children.find((t=>!!t.comp));i({fault:o,prev:l,solution:{node:h,path:s+h.id},openingUcis:[]}),"standard"===n.variant.key&&n.division&&(!n.division.middle||o.node.ply<n.division.middle)&&t.explorer.fetchMasterOpening(l.node.fen).then((t=>{const e=i(),n=[];t.moves.forEach((t=>{t.white+t.draws+t.black>1&&n.push(t.uci)})),n.includes(o.node.uci)?(r.push(o.node.ply),setTimeout(u,100)):(e.openingUcis=n,i(e))})),t.userJump(l.path),c()}function h(){const n=t.node,o=i();if(o&&"eval"===a()&&o.fault.node.ply===n.ply&&function(t){return!!t.ceval&&(t.ceval.depth>=18||t.ceval.depth>=14&&t.ceval.millis>7e3)}(n)){Kr(e,n.ceval,o.prev.node.eval)>-.035?p():m()}}function p(){f(),a("win"),c()}function m(){a("fail");const e={node:t.node,path:t.path};t.userJump(i().prev.path),!t.tree.pathIsMainline(e.path)&&E(e.node.children)&&t.tree.deleteNodeAt(e.path),c()}function f(){s.push(i().fault.node.ply)}function g(){const t=a();return"find"===t||"fail"===t}return u(),{current:i,color:e,isPlySolved:l,onJump:function(){const e=t.node,n=a(),o=i();if(o){if("eval"===n&&o.fault.node.ply!==e.ply)return a("find"),void t.setAutoShapes();g()&&o.fault.node.ply===e.ply&&(o.openingUcis.includes(e.uci)||e.comp?p():e.eval?m():(a("eval"),t.ceval.enabled()||t.toggleCeval(),h())),t.setAutoShapes()}},jumpToNext:u,skip:function(){f(),u()},viewSolution:function(){a("view"),t.userJump(i().solution.path),f()},hideComputerLine:function(t){return t.ply%2==0!=("white"===e)&&!l(t.ply)},showBadNode:function(){const e=i();if(e&&g()&&e.prev.path===t.path)return e.fault.node},onCeval:h,onMergeAnalysisData:function(){g()&&!i()&&u()},feedback:a,isSolving:g,completion:()=>[s.length,o.length],reset(){s=[],u()},flip(){"racingKings"!==t.data.game.variant.key?t.flip():(t.retro=uc(t,$e(e)),c())},close:t.toggleRetro,trans:t.trans,noarg:t.trans.noarg,node:()=>t.node,redraw:c}}class hc{constructor(t,e){this.opts=t,this.redraw=e,this.autoScrollRequested=!1,this.redirecting=!1,this.onMainline=!0,this.flipped=!1,this.showComments=!0,this.showAutoShapes=No("show-auto-shapes",!0),this.showGauge=No("show-gauge",!0),this.showComputer=No("show-computer",!0),this.showMoveAnnotation=No("show-move-annotation",!0),this.keyboardHelp="#keyboard"===location.hash,this.threatMode=T(!1),this.cgVersion={js:1,dom:1},this.setPath=t=>{this.path=t,this.nodeList=this.tree.getNodeList(t),this.node=zt(this.nodeList),this.mainline=Jt(this.tree.root),this.onMainline=this.tree.pathIsMainline(t),this.fenInput=void 0,this.pgnInput=void 0},this.flip=()=>{this.flipped=!this.flipped,this.chessground.set({orientation:this.bottomColor()}),this.retro&&"racingKings"!==this.data.game.variant.key&&(this.retro=uc(this,this.bottomColor())),this.practice&&this.restartPractice(),this.redraw()},this.bottomIsWhite=()=>"white"===this.bottomColor(),this.getDests=lr(800,(()=>{this.embed||P(this.node.dests)||this.socket.sendAnaDests({variant:this.data.game.variant.key,fen:this.node.fen,path:this.path})})),this.throttleSound=t=>lr(100,(()=>lichess.sound.play(t))),this.sound={move:this.throttleSound("move"),capture:this.throttleSound("capture"),check:this.throttleSound("check")},this.onChange=lr(300,(()=>{lichess.pubsub.emit("analysis.change",this.node.fen,this.path,!!this.onMainline&&this.node.ply)})),this.updateHref=B((()=>{this.opts.study||window.history.replaceState(null,"","#"+this.node.ply)}),750),this.playedLastMoveMyself=()=>!!this.justPlayed&&!!this.node.uci&&this.node.uci.startsWith(this.justPlayed),this.userJump=t=>{if(this.autoplay.stop(),this.withCg((t=>t.selectSquare(null))),this.practice){const e=this.path;this.practice.preUserJump(e,t),this.jump(t),this.practice.postUserJump(e,this.path)}else this.jump(t)},this.jumpToMain=t=>{this.userJump(this.mainlinePathToPly(t))},this.jumpToIndex=t=>{this.jumpToMain(t+1+this.tree.root.ply)},this.userNewPiece=(t,e)=>{if(function(t,e,n,o){if(n.color!==t.state.movable.color)return!1;if("pawn"===n.role&&("1"===o[1]||"8"===o[1]))return!1;const r=Mt(e);return null===r||r.includes(o)}(this.chessground,this.node.drops,t,e)){this.justPlayed=Xo(t.role).toUpperCase()+"@"+e,this.justDropped=t.role,this.justCaptured=void 0,this.sound.move();const n={role:t.role,pos:e,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};this.socket.sendAnaDrop(n),this.preparePremoving(),this.redraw()}else this.jump(this.path)},this.userMove=(t,e,n)=>{this.justPlayed=t,this.justDropped=void 0;const o=this.chessground.state.pieces.get(e),r=n||o&&"pawn"==o.role&&t[0]!=e[0];this.sound[r?"capture":"move"](),function(t,e,n,o,r){const s=t.chessground.state,i=s.pieces.get(n);return!(!i||"pawn"!=i.role||!("8"==n[1]&&"black"==s.turnColor||"1"==n[1]&&"white"==s.turnColor)||(Po={orig:e,dest:n,capture:o,callback:r},t.redraw(),0))}(this,t,e,n,this.sendMove)||this.sendMove(t,e,n)},this.sendMove=(t,e,n,o)=>{const r={orig:t,dest:e,variant:this.data.game.variant.key,fen:this.node.fen,path:this.path};n&&(this.justCaptured=n),o&&(r.promotion=o),this.practice&&this.practice.onUserMove(),this.socket.sendAnaMove(r),this.preparePremoving(),this.redraw()},this.onPremoveSet=()=>{this.study&&this.study.onPremoveSet()},this.setAutoShapes=()=>{this.withCg((t=>t.setAutoShapes(function(t){const e=t.node.fen.includes(" w ")?"white":"black",n=$e(e);if(t.practice){const n=t.practice.hovering();if(n)return Ri(e,n.uci,"green");const o=t.practice.hinting();return o?"move"===o.mode?Ri(e,o.uci,"paleBlue"):[{orig:"@"===o.uci[1]?o.uci.slice(2,4):o.uci.slice(0,2),brush:"paleBlue"}]:[]}const o=t.getCeval(),r=t.explorer.hovering()||o.hovering(),{eval:s={},fen:i,ceval:a,threat:c}=t.node;let l,d=[];if(t.retro&&(l=t.retro.showBadNode()))return Ri(e,l.uci,"paleRed",{lineWidth:8});if(r&&r.fen===i&&(d=d.concat(Ri(e,r.uci,"paleBlue"))),t.showAutoShapes()&&t.showComputer()&&(s.best&&(d=d.concat(Ri(n,s.best,"paleGreen"))),!r&&parseInt(o.multiPv()))){let n=t.nextNodeBest();!n&&o.enabled()&&a&&(n=a.pvs[0].moves[0]),n&&(d=d.concat(Ri(e,n,"paleBlue"))),o.enabled()&&a&&a.pvs[1]&&!(t.threatMode()&&c&&c.pvs.length>2)&&a.pvs.forEach((function(t){if(t.moves[0]===n)return;const o=Kr(e,a.pvs[0],t);o>=0&&o<.2&&(d=d.concat(Ri(e,t.moves[0],"paleGrey",{lineWidth:Math.round(12-50*o)})))}))}if(o.enabled()&&t.threatMode()&&c){const[t,...e]=c.pvs;d=d.concat(Ri(n,t.moves[0],e.length>0?"paleRed":"red")),e.forEach((function(e){const o=Kr(n,e,t);o>=0&&o<.2&&(d=d.concat(Ri(n,e.moves[0],"paleRed",{lineWidth:Math.round(11-45*o)})))}))}if(t.showMoveAnnotation()&&t.showComputer()){const{uci:e,glyphs:n,san:o}=t.node;if(e&&o&&n&&n.length>0){const t=n[0],r=ji[t.symbol];if(r){const t=tr(e),n=o.startsWith("O-O")?0===Ko(t.to)?"O-O-O"===o?"c1":"g1":"O-O-O"===o?"c8":"g8":Zo(t.to);d=d.concat({orig:n,customSvg:r})}}}return d}(this))))},this.onNewCeval=(t,e,n)=>{this.tree.updateAt(e,(o=>{(o.fen===t.fen||n)&&(n?(!o.threat||Jr(t,o.threat)||o.threat.maxDepth<t.maxDepth)&&(o.threat=t):Jr(t,o.ceval)?o.ceval=t:o.ceval&&t.maxDepth>o.ceval.maxDepth&&(o.ceval.maxDepth=t.maxDepth),e===this.path&&(this.setAutoShapes(),n||(this.retro&&this.retro.onCeval(),this.practice&&this.practice.onCeval(),this.studyPractice&&this.studyPractice.onCeval(),this.evalCache.onCeval(),t.cloud&&t.depth>=this.ceval.effectiveMaxDepth()&&this.ceval.stop()),this.redraw()))}))},this.startCeval=lr(800,(()=>{this.ceval.enabled()&&(this.canUseCeval()?(this.ceval.start(this.path,this.nodeList,this.threatMode(),!1),this.evalCache.fetch(this.path,parseInt(this.ceval.multiPv()))):this.ceval.stop())})),this.toggleCeval=()=>{this.showComputer()&&(this.ceval.toggle(),this.setAutoShapes(),this.startCeval(),this.ceval.enabled()||(this.threatMode(!1),this.practice&&this.togglePractice()),this.redraw())},this.toggleThreatMode=()=>{this.node.check||(this.ceval.enabled()||this.ceval.toggle(),this.ceval.enabled()&&(this.threatMode(!this.threatMode()),this.threatMode()&&this.practice&&this.togglePractice(),this.setAutoShapes(),this.startCeval(),this.redraw()))},this.disableThreatMode=()=>!!this.practice,this.mandatoryCeval=()=>!!this.studyPractice,this.cevalSetMultiPv=t=>{this.ceval.multiPv(t),this.tree.removeCeval(),this.cevalReset()},this.cevalSetThreads=t=>{this.ceval.threads&&(this.ceval.threads(t),this.cevalReset())},this.cevalSetHashSize=t=>{this.ceval.hashSize&&(this.ceval.hashSize(t),this.cevalReset())},this.cevalSetInfinite=t=>{this.ceval.infinite(t),this.cevalReset()},this.hasFullComputerAnalysis=()=>Object.keys(this.mainline[0].eval||{}).length>0,this.toggleAutoShapes=t=>{this.showAutoShapes(t),this.resetAutoShapes()},this.toggleGauge=()=>{this.showGauge(!this.showGauge())},this.toggleMoveAnnotation=t=>{this.showMoveAnnotation(t),this.resetAutoShapes()},this.toggleComputer=()=>{this.ceval.enabled()&&this.toggleCeval();const t=!this.showComputer();this.showComputer(t),!t&&this.practice&&this.togglePractice(),this.onToggleComputer(),lichess.pubsub.emit("analysis.comp.toggle",t)},this.toggleRetro=()=>{this.retro?this.retro=void 0:(this.retro=uc(this,this.bottomColor()),this.practice&&this.togglePractice(),this.explorer.enabled()&&this.toggleExplorer()),this.setAutoShapes()},this.toggleExplorer=()=>{this.practice&&this.togglePractice(),(this.explorer.enabled()||this.explorer.allowed())&&this.explorer.toggle()},this.togglePractice=()=>{this.practice||!this.ceval.possible?this.practice=void 0:(this.retro&&this.toggleRetro(),this.explorer.enabled()&&this.toggleExplorer(),this.practice=dc(this,(()=>this.studyPractice&&null===this.studyPractice.success()?20:18))),this.setAutoShapes()},this.gamebookPlay=()=>this.study&&this.study.gamebookPlay(),this.isGamebook=()=>!(!this.study||!this.study.data.chapter.gamebook),this.data=t.data,this.element=t.element,this.embed=t.embed,this.trans=t.trans,this.treeView=function(t="column"){const e=No("treeView",t);function n(){return"inline"===e()}function o(t){e(t?"inline":"column")}return{get:e,set:o,toggle(){o(!n())},inline:n}}(t.embed?"inline":"column"),this.data.forecast&&(this.forecast=ic(this.data.forecast,this.data,e)),lichess.AnalyseNVUI&&(this.nvui=lichess.AnalyseNVUI(e)),this.instanciateEvalCache(),this.initialize(this.data,!1),this.instanciateCeval(),this.initialPath="";{const t=window.location,e="#last"===t.hash?this.tree.lastPly():parseInt(t.hash.substr(1));if(e){window.history.replaceState(null,"",t.pathname+t.search);const n=Jt(this.tree.root);this.initialPath=Vt(n,(t=>t.ply<=e))}}this.setPath(this.initialPath),this.showGround(),this.onToggleComputer(),this.startCeval(),this.explorer.setNode(),this.study=t.study?Zi(t.study,this,(t.tagTypes||"").split(","),t.practice,t.relay):void 0,this.studyPractice=this.study?this.study.practice:void 0,"#practice"===location.hash||this.study&&this.study.data.chapter.practice?this.togglePractice():"#menu"===location.hash&&lichess.requestIdleCallback(this.actionMenu.toggle,500),Ce(this),lichess.pubsub.on("jump",(t=>{this.jumpToMain(parseInt(t)),this.redraw()})),lichess.pubsub.on("sound_set",(t=>{this.music||"music"!==t||lichess.loadScript("javascripts/music/replay.js").then((()=>{this.music=window.lichessReplayMusic()})),this.music&&"music"!==t&&(this.music=null)})),lichess.pubsub.on("analysis.change.trigger",this.onChange),lichess.pubsub.on("analysis.chart.click",(t=>{this.jumpToIndex(t),this.redraw()})),lichess.pubsub.on("speech.enabled",_o),_o(lichess.sound.speech())}initialize(t,e){this.data=t,this.synthetic="synthetic"===t.game.id,this.ongoing=!this.synthetic&&Tt(t);const n=e&&this.tree.root;this.tree=Yt(function(t){const e=t[0],n=t.length;let o=e;e.id="";for(let e=1;e<n;e++){const n=t[e];o.children?o.children.unshift(n):o.children=[n],o=n}return o.children=o.children||[],e}(this.data.treeParts)),n&&this.tree.merge(n),this.actionMenu=new va,this.autoplay=new ta(this),this.socket?this.socket.clearCache():this.socket=function(t,e){let n,o,r={};function s(){r="standard"===e.data.game.variant.key&&e.tree.root.fen.split(" ",1)[0]===bn?{"":{path:"",dests:"iqy muC gvx ltB bqs pxF jrz nvD ksA owE"}}:{}}function i(){if(e.study)return e.study.vm.chapterId}function a(t,n=!1){const o=i();o&&(t.ch=o,n&&(e.study.isWriting()?e.study.vm.mode.sticky||(t.sticky=!1):t.write=!1))}s(),e.synthetic||setTimeout((function(){t("startWatching",e.data.game.id)}),1e3);const c={node(t){clearTimeout(n),t.ch==i()?e.addNode(t.node,t.path):console.log("socket handler node got wrong chapter id",t)},stepFailure(){clearTimeout(n),e.reset()},dests(t){clearTimeout(o),t.ch&&t.ch!==i()?console.log("socket handler node got wrong chapter id",t):(r[t.path]=t,e.addDests(t.dests,t.path))},destsFailure(t){console.log(t),clearTimeout(o)},fen(t){e.forecast&&t.id===e.data.game.id&&0!==zt(e.mainline).fen.indexOf(t.fen)&&e.forecast.reloadToLastPly()},analysisProgress(t){e.mergeAnalysisData(t)},evalHit(t){e.evalCache.onCloudEval(t)}};function l(t){"standard"===t.variant&&delete t.variant}return{receive(t,n){const o=c[t];return o?(o(n),!0):!!e.study&&e.study.socketHandler(t,n)},sendAnaMove:function e(o){clearTimeout(n),l(o),a(o,!0),t("anaMove",o),n=setTimeout((()=>e(o)),3e3)},sendAnaDrop:function e(o){clearTimeout(n),l(o),a(o,!0),t("anaDrop",o),n=setTimeout((()=>e(o)),3e3)},sendAnaDests:function e(n){clearTimeout(o),r[n.path]?setTimeout((function(){c.dests(r[n.path])}),300):(l(n),a(n),t("anaDests",n),o=setTimeout((function(){console.log(n,"resendAnaDests"),e(n)}),3e3))},clearCache:s,send:t}}(this.opts.socketSend,this),this.explorer=cr(this,this.opts.explorer,this.explorer?this.explorer.allowed():!this.embed),this.gamePath=this.synthetic||this.ongoing?void 0:Lt(Jt(this.tree.root)),this.fork=function(t){let e,n=0;function o(){return t.node.children.length>1}return{state(){const r=t.node;return e&&e.id===r.id||(e=r,n=0),{node:r,selected:n,displayed:o()}},next(){if(o())return n=Math.min(t.node.children.length-1,n+1),!0},prev(){if(o())return n=Math.max(0,n-1),!0},proceed(e){if(o())return e=P(e)?e:n,t.userJumpIfCan(t.path+t.node.children[e].id),!0}}}(this),lichess.sound.preloadBoardSounds()}topColor(){return Uo(this.bottomColor())}bottomColor(){return"racingKings"===this.data.game.variant.key?this.flipped?"black":"white":this.flipped?Uo(this.data.orientation):this.data.orientation}getOrientation(){return this.bottomColor()}getNode(){return this.node}turnColor(){return this.node.ply%2==0?"white":"black"}togglePlay(t){this.autoplay.toggle(t),this.actionMenu.open=!1}uciToLastMove(t){if(t)return"@"===t[1]?[t.substr(2,2),t.substr(2,2)]:[t.substr(0,2),t.substr(2,2)]}showGround(){this.onChange(),P(this.node.dests)||this.getDests(),this.withCg((t=>{t.set(this.makeCgOpts()),this.setAutoShapes(),this.node.shapes&&t.setShapes(this.node.shapes)}))}makeCgOpts(){const t=this.node,e=this.turnColor(),n=function(t){if(void 0===t)return null;const e=new Map;if(t)for(const n of t.split(" "))e.set(xt[n[0]],n.slice(1).split("").map((t=>xt[t])));return e}(this.node.dests),o=Mt(this.node.drops),r=this.gamebookPlay()?e:this.practice?this.bottomColor():!this.embed&&(n&&n.size>0||null===o||o.length)?e:void 0,s={fen:t.fen,turnColor:e,movable:this.embed?{color:void 0,dests:new Map}:{color:r,dests:r===e&&n||new Map},check:!!t.check,lastMove:this.uciToLastMove(t.uci)};return n||t.check||(s.turnColor=Uo(e),s.movable.color=e),s.premovable={enabled:s.movable.color&&s.turnColor!==s.movable.color},this.cgConfig=s,s}autoScroll(){this.autoScrollRequested=!0}jump(t){const e=t!==this.path,n=e&&t.length==this.path.length+2;if(this.setPath(t),this.showGround(),e){const e=this.playedLastMoveMyself();this.study&&this.study.setPath(t,this.node,e),n&&(this.node.uci?e||(this.node.san.includes("x")?this.sound.capture():this.sound.move()):this.sound.move(),/\+|#/.test(this.node.san)&&this.sound.check()),this.threatMode(!1),this.ceval.stop(),this.startCeval(),Oo(this.node)}this.justPlayed=this.justDropped=this.justCaptured=void 0,this.explorer.setNode(),this.updateHref(),this.autoScroll(),Ao(this),e&&(this.retro&&this.retro.onJump(),this.practice&&this.practice.onJump(),this.study&&this.study.onJump()),this.music&&this.music.jump(this.node),lichess.pubsub.emit("ply",this.node.ply)}canJumpTo(t){return!this.study||this.study.canJumpTo(t)}userJumpIfCan(t){this.canJumpTo(t)&&this.userJump(t)}mainlinePathToPly(t){return Vt(this.mainline,(e=>e.ply<=t))}jumpToGlyphSymbol(t,e){const n=function(t,e,n,o){const r=n.length;if(!r)return;const s=o-n[0].ply;for(let o=1;o<r;o++){const i=n[(s+o)%r];if(i.ply%2==("white"===t?1:0)&&i.glyphs&&i.glyphs.find((function(t){return t.symbol===e})))return i}}(t,e,this.mainline,this.node.ply);n&&this.jumpToMain(n.ply),this.redraw()}reloadData(t,e){this.initialize(t,e),this.redirecting=!1,this.setPath(""),this.instanciateCeval(),this.instanciateEvalCache(),this.cgVersion.js++}changePgn(t){this.redirecting=!0,N("/analysis/pgn",{method:"post",body:L({pgn:t})}).then((t=>{this.reloadData(t,!1),this.userJump(this.mainlinePathToPly(this.tree.lastPly())),this.redraw()}),(t=>{console.log(t),this.redirecting=!1,this.redraw()}))}changeFen(t){this.redirecting=!0,window.location.href="/analysis/"+this.data.game.variant.key+"/"+encodeURIComponent(t).replace(/%20/g,"_").replace(/%2F/g,"/")}preparePremoving(){this.chessground.set({turnColor:this.chessground.state.movable.color,movable:{color:Uo(this.chessground.state.movable.color)},premovable:{enabled:!0}})}addNode(t,e){const n=this.tree.addNode(t,e);if(!n)return console.log("Can't addNode",t,e),this.redraw();this.jump(n),this.redraw(),this.chessground.playPremove()}addDests(t,e){this.tree.addDests(t,e),e===this.path&&(this.showGround(),this.outcome()&&this.ceval.stop()),this.withCg((t=>t.playPremove()))}deleteNode(t){const e=this.tree.nodeAtPath(t);if(!e)return;const n=Ht(e);(n.nodes>=10||n.comments>0)&&!confirm("Delete "+me("move",n.nodes)+(n.comments?" and "+me("comment",n.comments):"")+"?")||(this.tree.deleteNodeAt(t),Dt(this.path,t)?this.userJump(qt(t)):this.jump(this.path),this.study&&this.study.deleteNode(t))}promote(t,e){this.tree.promoteAt(t,e),this.jump(t),this.study&&this.study.promote(t,e)}forceVariation(t,e){this.tree.forceVariationAt(t,e),this.jump(t),this.study&&this.study.forceVariation(t,e)}reset(){this.showGround(),this.redraw()}encodeNodeFen(){return this.node.fen.replace(/\s/g,"_")}currentEvals(){return{server:this.node.eval,client:this.node.ceval}}nextNodeBest(){return Rt(this.node,(t=>t.eval?t.eval.best:void 0))}instanciateCeval(){this.ceval&&this.ceval.destroy();const t={variant:this.data.game.variant,standardMaterial:!this.data.game.initialFen||Ks(this.data.game.initialFen).unwrap((t=>Go.every((e=>{const n=t.board,o=n[e],r=Math.max(n.queen.intersect(o).size()-1,0)+Math.max(n.rook.intersect(o).size()-2,0)+Math.max(n.knight.intersect(o).size()-2,0)+Math.max(n.bishop.intersect(o).intersect(us.lightSquares()).size()-1,0)+Math.max(n.bishop.intersect(o).intersect(us.darkSquares()).size()-1,0);return n.pawn.intersect(o).size()+r<=8}))),(t=>!1)),possible:!this.embed&&(this.synthetic||!Tt(this.data)),emit:(t,e)=>{this.onNewCeval(t,e.path,e.threatMode)},setAutoShapes:this.setAutoShapes,redraw:this.redraw};this.opts.study&&this.opts.practice&&(t.storageKeyPrefix="practice",t.multiPvDefault=1),this.ceval=as(t)}getCeval(){return this.ceval}outcome(t){return this.position(t||this.node).unwrap((t=>t.outcome()),(t=>{}))}position(t){const e=Ks(t.fen).unwrap();return ci(jr(this.data.game.variant.key),e)}canUseCeval(){return!this.node.threefold&&!this.outcome()}cevalReset(){this.ceval.stop(),this.ceval.enabled()||this.ceval.toggle(),this.startCeval(),this.redraw()}showEvalGauge(){return this.hasAnyComputerAnalysis()&&this.showGauge()&&!this.outcome()&&this.showComputer()}hasAnyComputerAnalysis(){return!!this.data.analysis||this.ceval.enabled()}resetAutoShapes(){this.showAutoShapes()||this.showMoveAnnotation()?this.setAutoShapes():this.chessground&&this.chessground.setAutoShapes([])}onToggleComputer(){this.showComputer()?this.resetAutoShapes():(this.tree.removeComputerVariations(),this.ceval.enabled()&&this.toggleCeval(),this.chessground&&this.chessground.setAutoShapes([]))}mergeAnalysisData(t){this.study&&this.study.data.chapter.id!==t.ch||(this.tree.merge(t.tree),this.showComputer()||this.tree.removeComputerVariations(),this.data.analysis=t.analysis,t.analysis&&(t.analysis.partial=!!jt(t.tree,(t=>!t.eval&&!!t.children.length))),t.division&&(this.data.game.division=t.division),this.retro&&this.retro.onMergeAnalysisData(),this.study&&this.study.serverEval.onMergeAnalysisData(),lichess.pubsub.emit("analysis.server.progress",this.data),this.redraw())}playUci(t){const e=tr(t),n=Zo(e.to);if("from"in e){const t=this.chessground.state.pieces.get(Zo(e.from)),o=this.chessground.state.pieces.get(n);this.sendMove(Zo(e.from),n,o&&t&&o.color!==t.color?o:void 0,e.promotion)}else this.chessground.newPiece({color:this.chessground.state.movable.color,role:e.role},n)}explorerMove(t){this.playUci(t),this.explorer.loading(!0)}playBestMove(){const t=this.nextNodeBest()||this.node.ceval&&this.node.ceval.pvs[0].moves[0];t&&this.playUci(t)}canEvalGet(){if(this.node.ply>=15&&!this.opts.study)return!1;const t=new Set;for(let e=this.nodeList.length-1;e>=0;e--){const n=this.nodeList[e],o=n.fen.split(" ").slice(0,4).join(" ");if(t.has(o))return!1;if(n.san&&Yr(this.data.game.variant.key,n.san))return!0;t.add(o)}return!0}instanciateEvalCache(){this.evalCache=sc({variant:this.data.game.variant.key,canGet:()=>this.canEvalGet(),canPut:()=>!!(this.data.evalPut&&this.canEvalGet()&&(this.opts.study||!this.node.ceval.mate&&Math.abs(this.node.ceval.cp)<99)),getNode:()=>this.node,send:this.opts.socketSend,receive:this.onNewCeval})}restartPractice(){this.practice=void 0,this.togglePractice()}withCg(t){if(this.chessground&&this.cgVersion.js===this.cgVersion.dom)return t(this.chessground)}}function pc(t){const e=t.trans.noarg,n=t.data;switch(n.game.status.name){case"started":return e("playingRightNow");case"aborted":return e("gameAborted");case"mate":return e("checkmate");case"resign":return e("white"==n.game.winner?"blackResigned":"whiteResigned");case"stalemate":return e("stalemate");case"timeout":switch(n.game.winner){case"white":return e("blackLeftTheGame");case"black":return e("whiteLeftTheGame")}return e("draw");case"draw":return e("draw");case"outoftime":return`${n.game.turns%2==0?e("whiteTimeOut"):e("blackTimeOut")}${n.game.winner?"":` • ${e("draw")}`}`;case"noStart":return("white"==n.game.winner?"Black":"White")+" didn't move";case"cheat":return e("cheatDetected");case"variantEnd":switch(n.game.variant.key){case"kingOfTheHill":return e("kingInTheCenter");case"threeCheck":return e("threeChecks")}return e("variantEnding");case"unknownFinish":return"Finished";default:return n.game.status.name}}function mc(t){if(t.embed)return;const e=t.node,n=e.clock;if(!n&&0!==n)return;const o=t.bottomIsWhite(),r=t.tree.getParentClock(e,t.path),s=e.ply%2==0,i=[r,n];s||i.reverse();const a=t.study,c=a&&a.data.chapter.relay;if(c&&c.lastMoveAt&&c.path===t.path&&""!==t.path&&!br(a.data.chapter)){const t=(Date.now()-c.lastMoveAt)/10,e=s?0:1;i[e]&&(i[e]=Math.max(0,i[e]-t))}const l=!t.study||!t.study.relay;return[fc(i[0],s,o?"bottom":"top",l),fc(i[1],!s,o?"top":"bottom",l)]}function fc(t,e,n,o){return p("div.analyse__clock."+n,{class:{active:e}},function(t,e){if(!t&&0!==t)return["-"];const n=new Date(10*t),o=n.getUTCMilliseconds(),r=":",s=gc(n.getUTCMinutes())+r+gc(n.getUTCSeconds());return!e||t>=36e4?[Math.floor(t/36e4)+r+s]:t>=6e3?[s]:[s,p("tenths","."+Math.floor(o/100).toString())]}(t,o))}function gc(t){return(t<10?"0":"")+t}function vc(t,e,n){const o=n[0];if(!o)return;const r=e.findStartingWithNode(o);if(!r.length)return;const s=r.filter((function(t){return t.length>1}));return p("button.on-my-turn.button.text",{attrs:ue("E"),hook:ae("click",(t=>e.playAndSave(o)))},[p("span",[p("strong",t.trans("playX",St(n[0].san))),s.length?p("span",t.trans.plural("andSaveNbPremoveLines",s.length)):p("span",t.trans.noarg("noConditionalPremoves"))])])}function bc(t,e){const n=t.tree.getCurrentNodesAfterPly(t.nodeList,t.mainline,t.data.game.turns);return e.truncate(n.map((t=>({ply:t.ply,fen:t.fen,uci:t.uci,san:t.san,check:t.check}))))}function yc(t,e){const n=bc(t,e),o=e.isCandidate(n);return p("div.forecast",{class:{loading:e.loading()}},[e.loading()?p("div.overlay",ge()):null,p("div.box",[p("div.top",t.trans.noarg("conditionalPremoves")),p("div.list",e.list().map((function(n,o){return p("div.entry.text",{attrs:ue("G")},[p("a.del",{hook:ae("click",(t=>{e.removeIndex(o),t.stopPropagation()}),t.redraw)},"x"),p("sans",ca(n))])}))),p("button.add.text",{class:{enabled:o},attrs:ue(o?"O":""),hook:ae("click",(n=>e.addNodes(bc(t,e))),t.redraw)},[p("span",o?[p("span",t.trans.noarg("addCurrentVariation")),p("sans",ca(n))]:t.trans.noarg("playVariationToCreateConditionalPremoves"))])]),e.onMyTurn?vc(t,e,n):null])}const wc=["mousedown","touchstart"],kc=["pawn","knight","bishop","rook","queen"];function Cc(t,e,n){if(!t.node.crazy)return;const o=t.node.crazy.pockets["white"===e?0:1],r=t.justDropped,s=t.justCaptured;s&&(s.role=s.promoted?"pawn":s.role);const i=e===t.turnColor(),a=!t.embed&&i;return p(`div.pocket.is2d.pocket-${n}.pos-${t.bottomColor()}`,{class:{usable:a},hook:le((n=>{t.embed||wc.forEach((o=>{n.addEventListener(o,(n=>function(t,e,n){if(void 0!==n.button&&0!==n.button)return;if(t.chessground.state.movable.color!==e)return;const o=n.target,r=o.getAttribute("data-role"),s=o.getAttribute("data-nb");r&&e&&"0"!==s&&(n.stopPropagation(),n.preventDefault(),jn(t.chessground.state,{color:e,role:r},n))}(t,e,n)))}))}))},kc.map((t=>{let n=o[t]||0;return i&&(r===t&&n--,s&&s.role===t&&n++),p("div.pocket-c1",p("div.pocket-c2",p("piece."+t+"."+e,{attrs:{"data-role":t,"data-color":e,"data-nb":n}})))})))}function xc(t){return null!==t.dtz}function Sc(t){const e=t.white+t.draws+t.black;return p("div.bar",["white","draws","black"].map((function(n){const o=100*t[n]/e;return 0===o?null:p("span."+n,{attrs:{style:"width: "+Math.round(1e3*t[n]/e)/10+"%"}},o>12?Math.round(o)+(o>20?"%":""):"")})))}function Mc(t,e){return{attrs:{"data-fen":e},hook:{insert(e){const n=e.elm;n.addEventListener("mouseover",(e=>{t.explorer.setHovering($(n).attr("data-fen"),$(e.target).parents("tr").attr("data-uci"))})),n.addEventListener("mouseout",(e=>{t.explorer.setHovering($(n).attr("data-fen"),null)})),n.addEventListener("mousedown",(e=>{const n=$(e.target).parents("tr").attr("data-uci");n&&t.explorerMove(n)}))},postpatch(e){setTimeout((()=>{const n=e.elm;t.explorer.setHovering($(n).attr("data-fen"),$(n).find("tr:hover").attr("data-uci"))}),100)}}}}function Pc(t){return"white"===t?p("result.white","1-0"):"black"===t?p("result.black","0-1"):p("result.draws","½-½")}function Ec(t,e,n){if(!t.explorer.withGames||!n.length)return null;const o=t.explorer.gameMenu();return p("table.games",[p("thead",[p("tr",[p("th.title",{attrs:{colspan:4}},e)])]),p("tbody",{hook:ae("click",(e=>{const n=$(e.target).parents("tr");if(!n.length)return;const o=n.data("id");t.study&&t.study.members.canContribute()?(t.explorer.gameMenu(o),t.redraw()):Ac(t,o)}))},n.map((e=>o===e.id?function(t,e){function n(n){t.study.explorerGame(e.id,n),t.explorer.gameMenu(null),t.redraw()}return p("tr",{key:e.id+"-m"},[p("td.game_menu",{attrs:{colspan:4}},[p("div.game_title",`${e.white.name} - ${e.black.name}, ${Pc(e.winner).text}, ${e.year}`),p("div.menu",[p("a.text",{attrs:ue("v"),hook:ae("click",(n=>Ac(t,e.id)))},"View"),...t.study?[p("a.text",{attrs:ue("c"),hook:ae("click",(t=>n(!1)),t.redraw)},"Cite"),p("a.text",{attrs:ue("O"),hook:ae("click",(t=>n(!0)),t.redraw)},"Insert")]:[],p("a.text",{attrs:ue("L"),hook:ae("click",(e=>t.explorer.gameMenu(null)),t.redraw)},"Close")])])])}(t,e):p("tr",{key:e.id,attrs:{"data-id":e.id}},[p("td",[e.white,e.black].map((t=>p("span",""+t.rating)))),p("td",[e.white,e.black].map((t=>p("span",t.name)))),p("td",Pc(e.winner)),p("td",[e.year])]))))])}function Ac(t,e){let n="/"+e+"/"+t.chessground.state.orientation+(t.node.ply>0?"?fen="+t.node.fen:"");"masters"===t.explorer.config.data.db.selected()&&(n="/import/master"+n),window.open(n,"_blank","noopener")}function Tc(t,e,n){if(n.dtm)return p("result."+or(e,n),{attrs:{title:t.trans.plural("mateInXHalfMoves",Math.abs(n.dtm))+" (Depth To Mate)"}},"DTM "+Math.abs(n.dtm))}function Ic(t,e,n){const o=t.trans.noarg;return n.checkmate?p("result."+or(e,n),o("checkmate")):n.variant_win?p("result."+or(e,n),o("variantLoss")):n.variant_loss?p("result."+or(e,n),o("variantWin")):n.stalemate?p("result.draws",o("stalemate")):n.insufficient_material?p("result.draws",o("insufficientMaterial")):null===n.dtz?null:0===n.dtz?p("result.draws",o("draw")):n.zeroing?n.san.includes("x")?p("result."+or(e,n),o("capture")):p("result."+or(e,n),o("pawnMove")):p("result."+or(e,n),{attrs:{title:t.trans.plural("nextCaptureOrPawnMoveInXHalfMoves",Math.abs(n.dtz))}},"DTZ "+Math.abs(n.dtz))}function _c(t){return p("button.button.button-empty.text",{attrs:ue("L"),hook:ae("click",t.toggleExplorer,t.redraw)},t.trans.noarg("close"))}function Oc(t,e){return p("div.data.empty",[p("div.title",p("span",{attrs:e?{title:e&&`${e.eco} ${e.name}`}:{}},e?[p("strong",e.eco)," ",e.name]:[Dc(t,t.data.game.variant)])),p("div.message",[p("strong",t.trans.noarg("noGameFound")),t.explorer.config.fullHouse()?null:p("p.explanation",t.trans.noarg("maybeIncludeMoreGamesFromThePreferencesMenu")),_c(t)])])}function $c(t,e){return p("div.data.empty",[p("div.title",t.trans.noarg("gameOver")),p("div.message",[p("i",{attrs:ue("")}),p("h3",e),_c(t)])])}let Nc;function qc(t){const e=t.trans.noarg,n=t.explorer.current();if(n&&n.isOpening){const o=function(t,e){if(!e.moves.length)return null;const n=t.trans.noarg;return p("table.moves",[p("thead",[p("tr",[p("th.title",n("move")),p("th.title",n("games")),p("th.title",n("whiteDrawBlack"))])]),p("tbody",Mc(t,e.fen),e.moves.map((e=>p("tr",{key:e.uci,attrs:{"data-uci":e.uci,title:t.trans("averageRatingX",e.averageRating)}},[p("td","P"===e.san[0]?e.san.slice(1):e.san),p("td",W(e.white+e.draws+e.black)),p("td",Sc(e))]))))])}(t,n),r=Ec(t,e("recentGames"),n.recentGames||[]),s=Ec(t,e("topGames"),n.topGames||[]);Nc=o||r||s?p("div.data",[n&&n.opening&&p("div.title",p("span",{attrs:n.opening?{title:n.opening&&`${n.opening.eco} ${n.opening.name}`}:{}},[p("strong",n.opening.eco)," ",n.opening.name])),o,s,r]):Oc(t,n.opening)}else if(n&&function(t){return!!t.tablebase}(n)){const o=parseInt(n.fen.split(" ")[4],10)+1,r=1===o,s=n.moves,i=t=>t.checkmate||t.variant_loss,a=t=>t.checkmate||t.variant_win||t.variant_loss||t.zeroing?0:t.dtz,c=(e,o)=>function(t,e,n,o){return o.length?[p("div.title",n),p("table.tablebase",[p("tbody",Mc(t,e),o.map((n=>p("tr",{key:n.uci,attrs:{"data-uci":n.uci}},[p("td",n.san),p("td",[Ic(t,e,n),Tc(t,e,n)])]))))])]:[]}(t,n.fen,e,o);Nc=s.length?p("div.data",[...c(e("winning"),s.filter((t=>i(t)||-2===t.wdl&&xc(t)&&(r||a(t)-o>-100)))),...c(e("unknown"),s.filter((t=>!(i(t)||t.variant_win||t.insufficient_material||t.stalemate||null!==t.wdl||null!==t.dtz)))),...c("Winning or 50 moves by prior mistake",s.filter((t=>-2===t.wdl&&xc(t)&&!r&&a(t)-o==-100))),...c(e("winPreventedBy50MoveRule"),s.filter((t=>xc(t)&&(-1===t.wdl||-2===t.wdl&&!r&&a(t)-o<-100)))),...c(e("drawn"),s.filter((t=>!i(t)&&!t.variant_win&&(t.insufficient_material||t.stalemate||0===t.wdl)))),...c(e("lossSavedBy50MoveRule"),s.filter((t=>xc(t)&&(1===t.wdl||2===t.wdl&&!r&&a(t)+o>100)))),...c("Losing or 50 moves by prior mistake",s.filter((t=>2===t.wdl&&xc(t)&&!r&&a(t)+o===100))),...c(e("losing"),s.filter((t=>t.variant_win||2===t.wdl&&xc(t)&&(r||a(t)+o<100))))]):n.checkmate?$c(t,e("checkmate")):n.stalemate?$c(t,e("stalemate")):n.variant_win||n.variant_loss?$c(t,e("variantEnding")):Oc(t)}return Nc}function Dc(t,e){return"standard"===e.key||"fromPosition"===e.key?t.trans.noarg("openingExplorer"):t.trans("xOpeningExplorer",e.name)}function Lc(t){return p("div.config",[p("div.title",Dc(t,t.data.game.variant))].concat(function(t){const e=t.data;return[p("section.db",[p("label",t.trans.noarg("database")),p("div.choices",e.db.available.map((function(n){return p("span",{class:{selected:e.db.selected()===n},hook:ae("click",(e=>t.toggleDb(n)),t.redraw)},n)})))]),"masters"===e.db.selected()?p("div.masters.message",[p("i",{attrs:ue("C")}),p("p",t.trans("masterDbExplanation",2200,"1952","2019"))]):p("div",[p("section.rating",[p("label",t.trans.noarg("averageElo")),p("div.choices",e.rating.available.map((function(n){return p("span",{class:{selected:e.rating.selected().includes(n)},hook:ae("click",(e=>t.toggleRating(n)),t.redraw)},n.toString())})))]),p("section.speed",[p("label",t.trans.noarg("timeControl")),p("div.choices",e.speed.available.map((function(n){return p("span",{class:{selected:e.speed.selected().includes(n)},hook:ae("click",(e=>t.toggleSpeed(n)),t.redraw)},n)})))])]),p("section.save",p("button.button.button-green.text",{attrs:ue("E"),hook:ae("click",t.toggleOpen)},t.trans.noarg("allSet")))]}(t.explorer.config)))}let Rc="";function jc(t){const e=t.explorer;if(!e.enabled())return;const n=e.current(),o=e.config.data.open(),r=!o&&(e.loading()||!n&&!e.failing()),s=o?Lc(t):e.failing()?function(t){return p("div.data.empty",[p("div.title",Dc(t,t.data.game.variant)),p("div.failing.message",[p("h3","Oops, sorry!"),p("p.explanation","The explorer is temporarily out of service. Try again soon!"),_c(t)])])}(t):qc(t);return p("section.explorer-box.sub-box",{class:{loading:r,config:o,reduced:!o&&(e.failing()||e.movesAway()>2)},hook:{insert:t=>t.elm.scrollTop=0,postpatch(t,e){n&&Rc!==n.fen&&(e.elm.scrollTop=0,Rc=n.fen)}}},[p("div.overlay"),s,!s||e.failing()?null:p("span.toconf",{attrs:ue(o?"L":"%"),hook:ae("click",(()=>t.explorer.config.toggleOpen()),t.redraw)})])}function Fc(t){return p("div.choices",[p("a",{hook:ae("click",t.viewSolution,t.redraw)},t.noarg("viewTheSolution")),p("a",{hook:ae("click",t.skip)},t.noarg("skipThisMove"))])}function Bc(t){return p("a.half.continue",{hook:ae("click",t.jumpToNext)},[p("i",{attrs:ue("G")}),t.noarg("next")])}function Gc(t){return p("div.progress",p("div",{attrs:{style:`width: ${t.ceval?100*Math.max(0,t.ceval.depth-8)/10+"%":0}`}}))}const zc={find:t=>[p("div.player",[p("div.no-square",p("piece.king."+t.color)),p("div.instruction",[p("strong",t.trans.vdom("xWasPlayed",p("move",Ti({withDots:!0,showGlyphs:!0,showEval:!1},t.current().fault.node)))),p("em",t.noarg("white"===t.color?"findBetterMoveForWhite":"findBetterMoveForBlack")),Fc(t)])])],offTrack:t=>[p("div.player",[p("div.icon.off","!"),p("div.instruction",[p("strong",t.noarg("youBrowsedAway")),p("div.choices.off",[p("a",{hook:ae("click",t.jumpToNext)},t.noarg("resumeLearning"))])])])],fail:t=>[p("div.player",[p("div.icon","✗"),p("div.instruction",[p("strong",t.noarg("youCanDoBetter")),p("em",t.noarg("white"===t.color?"tryAnotherMoveForWhite":"tryAnotherMoveForBlack")),Fc(t)])])],win:t=>[p("div.half.top",p("div.player",[p("div.icon","✓"),p("div.instruction",p("strong",t.noarg("goodMove")))])),Bc(t)],view:t=>[p("div.half.top",p("div.player",[p("div.icon","✓"),p("div.instruction",[p("strong",t.noarg("solution")),p("em",t.trans.vdom("bestWasX",p("strong",Ti({withDots:!0,showEval:!1},t.current().solution.node))))])])),Bc(t)],eval:t=>[p("div.half.top",p("div.player.center",[p("div.instruction",[p("strong",t.noarg("evaluatingYourMove")),Gc(t.node())])]))],end(t,e){if(!e())return[p("div.half.top",p("div.player",[p("div.icon",ge()),p("div.instruction",t.noarg("waitingForAnalysis"))]))];const n=!t.completion()[1];return[p("div.player",[p("div.no-square",p("piece.king."+t.color)),p("div.instruction",[p("em",n?t.noarg("white"===t.color?"noMistakesFoundForWhite":"noMistakesFoundForBlack"):t.noarg("white"===t.color?"doneReviewingWhiteMistakes":"doneReviewingBlackMistakes")),p("div.choices.end",[n?null:p("a",{hook:ae("click",t.reset)},t.noarg("doItAgain")),p("a",{hook:ae("click",(()=>t.flip()))},t.noarg("white"===t.color?"reviewBlackMistakes":"reviewWhiteMistakes"))])])])]}};function Vc(t,e){const n=t.retro,o=n.current();return n.isSolving()&&o&&t.path!==o.prev.path?zc.offTrack(n):"find"===e?o?zc.find(n):zc.end(n,t.hasFullComputerAnalysis):zc[e](n)}function Wc(t){const e=t.retro;if(!e)return;const n=e.feedback(),o=e.completion();return p("div.retro-box.training-box.sub-box",[p("div.title",[p("span",e.noarg("learnFromYourMistakes")),p("span",Math.min(o[0]+1,o[1])+" / "+o[1])]),p("div.feedback."+n,Vc(t,n))])}function Hc(t,e,n){return t.best?e.trans.vdom("goodMove"===t.verdict?"anotherWasX":"bestWasX",p("move",{hook:{insert:t=>{const e=t.elm;e.addEventListener("click",n.playCommentBest),e.addEventListener("mouseover",(()=>n.commentShape(!0))),e.addEventListener("mouseout",(()=>n.commentShape(!1)))},destroy:()=>n.commentShape(!1)}},t.best.san)):[]}function Uc(t,e){return p("div.player.off",[p("div.icon.off","!"),p("div.instruction",[p("strong",t.trans.noarg("youBrowsedAway")),p("div.choices",[p("a",{hook:ae("click",e.resume,e.redraw)},t.trans.noarg("resumePractice"))])])])}function Kc(t,e){const n=e.winner||t.turnColor();return p("div.player",[n?p("div.no-square",p("piece.king."+n)):p("div.icon.off","!"),p("div.instruction",[p("strong",t.trans.noarg(e.winner?"checkmate":"draw")),e.winner?p("em",p("color",t.trans.noarg("white"===e.winner?"whiteWinsGame":"blackWinsGame"))):p("em",t.trans.noarg("theGameIsADraw"))])])}function Jc(t,e){return p("div.progress",p("div",{attrs:{style:`width: ${t.ceval?100*Math.max(0,t.ceval.depth-8)/(e-8)+"%":0}`}}))}function Xc(t,e){const n=e.hinting();return p("div.player.running",[p("div.no-square",p("piece.king."+t.turnColor())),p("div.instruction",(e.isMyTurn()?[p("strong",t.trans.noarg("yourTurn"))]:[p("strong",t.trans.noarg("computerThinking")),Jc(e.currentNode(),e.playableDepth())]).concat(p("div.choices",[e.isMyTurn()?p("a",{hook:ae("click",(()=>t.practice.hint()),e.redraw)},t.trans.noarg(n?"piece"===n.mode?"seeBestMove":"hideBestMove":"getAHint")):""])))])}function Yc(t){const e=t.practice;if(!e)return;const n=e.comment(),o=e.running(),r=e.currentNode().threefold?{winner:void 0}:t.outcome();return p("div.practice-box.training-box.sub-box."+(n?n.verdict:"no-verdict"),[p("div.title",t.trans.noarg("practiceWithComputer")),p("div.feedback",o?r?Kc(t,r):Xc(t,e):Uc(t,e)),o?p("div.comment",n?[p("span.verdict",t.trans.noarg(n.verdict))," "].concat(Hc(n,t,e)):[e.isMyTurn()||r?"":p("span.wait",t.trans.noarg("evaluatingYourMove"))]):o?p("div.comment"):null])}function Qc(t){const e="deviation";return p("div.deviation",[p("div.legend.todo",{class:{done:el(t.node,e).length>2}},[he("c"),p("p","When any other wrong move is played:")]),p("textarea",{attrs:{placeholder:"Explain why all other moves are wrong"},hook:nl(t,e)})])}function Zc(t){return p("div.hint",[p("div.legend",[he(""),p("p","Optional, on-demand hint for the player:")]),p("textarea",{attrs:{placeholder:"Give the player a tip so they can find the right move"},hook:nl(t,"hint")})])}const tl=lr(500,((t,e)=>{t.socket.send("setGamebook",{path:t.path,ch:t.study.vm.chapterId,gamebook:e}),t.redraw()}));function el(t,e){return t.gamebook&&t.gamebook[e]||""}function nl(t,e){const n=el(t.node,e);return{insert(o){const r=o.elm;r.value=n,r.onkeyup=r.onpaste=()=>{const n=t.node;n.gamebook=n.gamebook||{},n.gamebook[e]=r.value.trim(),tl(t,n.gamebook)},o.data.path=t.path},postpatch(e,o){e.data.path!==t.path&&(o.elm.value=n),o.data.path=t.path}}}const ol={play:"What would you play in this position?",end:"Congratulations! You completed this lesson.",bad:void 0,good:void 0};function rl(t){const e=t.state,n=()=>({hook:ae("click",t.hint,t.redraw)});return e.showHint?p("div",n(),[p("div.hint",{hook:nt(e.hint)})]):e.hint?p("a.hint",n(),"Get a hint"):void 0}function sl(t,e){const n=e.feedback,o=t.root.turnColor();return"bad"===n?p("div.feedback.act.bad"+(e.comment?".com":""),{hook:ae("click",t.retry)},[he("P"),p("span","Retry")]):"good"===n&&e.comment?p("div.feedback.act.good.com",{hook:ae("click",t.next)},[p("span.text",{attrs:ue("G")},"Next"),p("kbd","<space>")]):"end"===n?function(t){const e=t.root.study;return p("div.feedback.end",[e.nextChapter()?p("a.next.text",{attrs:ue("G"),hook:ae("click",e.goToNextChapter)},"Next chapter"):void 0,p("a.retry",{attrs:ue("P"),hook:ae("click",(()=>t.root.userJump("")),t.redraw)},"Play again"),p("a.analyse",{attrs:ue("A"),hook:ae("click",(()=>e.setGamebookOverride("analyse")),t.redraw)},"Analyse")])}(t):p("div.feedback.info."+n+(e.init?".init":""),p("div","play"===n?[p("div.no-square",p("piece.king."+o)),p("div.instruction",[p("strong",t.trans.noarg("yourTurn")),p("em",t.trans.noarg("white"===o?"findTheBestMoveForWhite":"findTheBestMoveForBlack"))])]:["Good move!"]))}function il(t,e){const n=Ot(t.data,e);return n.user?p("a.user-link.ulpt",{attrs:{href:"/@/"+n.user.username}},[n.user.username," ",(o=n.ratingDiff,0===o?p("span","±0"):o&&o>0?p("good","+"+o):o&&o<0?p("bad","−"+-o):void 0)]):p("span",n.name||n.ai&&"Stockfish level "+n.ai||t.study&&yr(t.study.data.chapter.tags,e)||"Anonymous");var o}const al=[{kind:"inaccuracy",i18n:"nbInaccuracies",symbol:"?!"},{kind:"mistake",i18n:"nbMistakes",symbol:"?"},{kind:"blunder",i18n:"nbBlunders",symbol:"??"}];function cl(t,e){const n=t.data,o=n.analysis[e].acpl;return p("div.advice-summary__side",[p("div.advice-summary__player",[p(`i.is.color-icon.${e}`),il(t,e)]),...al.map((o=>{const r=n.analysis[e][o.kind];return p("div.advice-summary__mistake"+(r?".symbol":""),{attrs:r?{"data-color":e,"data-symbol":o.symbol}:{}},t.trans.vdomPlural(o.i18n,r,p("strong",r)))})),p("div.advice-summary__acpl",[p("strong",""+(P(o)?o:"?")),p("span",t.trans.noarg("averageCentipawnLoss"))])])}function ll(t){return p("div.advice-summary",{hook:{insert:e=>{$(e.elm).on("click","div.symbol",(function(){t.jumpToGlyphSymbol($(this).data("color"),$(this).data("symbol"))}))}}},[cl(t,"white"),t.study?null:p("a.button.text",{class:{active:!!t.retro},attrs:ue("G"),hook:ae("click",t.toggleRetro,t.redraw)},t.trans.noarg("learnFromYourMistakes")),cl(t,"black")])}function dl(t){if(t.studyPractice||t.embed)return;if(!t.data.analysis||!t.showComputer()||t.study&&"serverEval"!==t.study.vm.toolTab())return p("div.analyse__acpl");let e=""+(t.data.analysis.partial?Math.random():"")+!!t.retro;return t.study&&(e+=t.study.data.chapter.id),p("div.analyse__acpl",v("div.advice-summary",ll,[t,e]))}function ul(t){var e,n;return t.members.canContribute()?p("div.relay-admin",{hook:le((t=>lichess.loadCssPath("analyse.relay-admin")))},[p("h2",[p("span.text",{attrs:ue("")},"Broadcast manager"),p("a",{attrs:{href:`/broadcast/round/${t.id}/edit`,"data-icon":"%"}})]),(null===(e=t.data.sync)||void 0===e?void 0:e.url)||(null===(n=t.data.sync)||void 0===n?void 0:n.ids)?(t.data.sync.ongoing?ml:fl)(t):null,pl(t)]):void 0}function hl(t){return[t.moves?p("strong",""+t.moves):t.moves," new move"+(t.moves>1?"s":"")]}function pl(t){var e,n;const o=function(){gl||(gl=window.Intl&&Intl.DateTimeFormat?new Intl.DateTimeFormat(document.documentElement.lang,{month:"short",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}).format:function(t){return t.toLocaleString()});return gl}(),r=null===(e=t.data.sync)||void 0===e?void 0:e.url,s=((null===(n=t.data.sync)||void 0===n?void 0:n.log)||[]).slice(0).reverse().map((t=>{const e=t.error&&p("a",r?{attrs:{href:r,target:"_blank",rel:"noopener nofollow"}}:{},t.error);return p("div"+(e?".err":""),{key:t.at,attrs:ue(e?"j":"E")},[p("div",[...e?[e]:hl(t),p("time",o(new Date(t.at)))])])}));return t.loading()&&s.unshift(p("div.load",[p("i.ddloader"),"Polling source..."])),p("div.log",s)}function ml(t){var e,n;const o=null===(e=t.data.sync)||void 0===e?void 0:e.url,r=null===(n=t.data.sync)||void 0===n?void 0:n.ids;return p("div.state.on.clickable",{hook:ae("click",(e=>t.setSync(!1))),attrs:ue("B")},[p("div",o?["Connected to source",p("br"),o.replace(/https?:\/\//,"")]:r?["Connected to",p("br"),r.length," game(s)"]:[])])}function fl(t){return p("div.state.off.clickable",{hook:ae("click",(e=>t.setSync(!0))),attrs:ue("G")},[p("div.fat","Click to connect")])}let gl;function vl(t){const e=t.study;if(!e||t.embed)return;const n=e.data.chapter.tags,o={white:yr(n,"white"),black:yr(n,"black")};if(!o.white&&!o.black&&!jt(t.tree.root,(t=>!!t.clock)))return;const r=mc(t),s=!br(e.data.chapter)&&t.turnColor();return["white","black"].map((e=>function(t,e,n,o,r,s){const i=yr(t,`${o}title`),a=yr(t,`${o}elo`),c=function(t,e){switch(yr(t,"result")){case"1-0":return e?"1":"0";case"0-1":return e?"0":"1";case"1/2-1/2":return"1/2";default:return}}(t,"white"===o);return p("div.study__player.study__player-"+(s?"top":"bot"),{class:{ticking:r}},[p("div.left",[c&&p("span.result",c),p("span.info",[i&&p("span.utitle","BOT"==i?{attrs:{"data-bot":!0}}:{},i+" "),p("span.name",n[o]),a&&p("span.elo",a)])]),e&&e["white"===o?0:1]])}(n,r,o,e,s===e,t.bottomColor()!==e)))}function bl(t,e){$(t).replaceWith(e.opts.$underboard),$("#adv-chart").attr("id","acpl-chart");const n=e.data,o=$(".analyse__underboard__panels > div"),r=$(".analyse__underboard__menu"),s=$("#movetimes-chart"),i=document.querySelector(".analyse__underboard__fen"),a=t=>{t.getSelectedPoints().forEach((function(t){t.select(!1)}))};let c;function l(){return`<div id="acpl-chart-loader"><span>Stockfish 13+<br>server analysis</span>${lichess.spinnerHtml}</div>`}function d(){if(lichess.advantageChart||lichess.AnalyseNVUI)return;const t=!n.treeParts[0].eval||!Object.keys(n.treeParts[0].eval).length,r=o.filter(".computer-analysis");$("#acpl-chart").length?t&&!$("#acpl-chart-loader").length&&r.append(l()):r.html('<div id="acpl-chart"></div>'+(t?l():"")),lichess.loadScript("javascripts/chart/acpl.js").then((function(){lichess.advantageChart(n,e.trans,$("#acpl-chart")[0])}))}lichess.AnalyseNVUI||(lichess.pubsub.on("analysis.comp.toggle",(t=>{setTimeout((function(){(t?r.find('[data-panel="computer-analysis"]'):r.find("span:eq(1)")).trigger("mousedown")}),50)})),lichess.pubsub.on("analysis.change",((t,e,o)=>{const r=$("#acpl-chart");if(t&&t!==c&&(i.value=t,c=t),r.length){const t=r[0].highcharts;if(t){if(o!=t.lastPly)if(!1===o)a(t);else{const e=t.series[0].data[o-1-n.game.startedAtTurn];P(e)?e.select():a(t)}t.lastPly=o}}if(s.length){const t=s[0].highcharts;if(t){if(o!=t.lastPly)if(!1===o)a(t);else{const e=o%2!=0?0:1,r=Math.floor((o-1-n.game.startedAtTurn)/2),s=t.series[e].data[r];P(s)?s.select():a(t)}t.lastPly=o}}})),lichess.pubsub.on("analysis.server.progress",(t=>{lichess.advantageChart?lichess.advantageChart.update&&lichess.advantageChart.update(t):d(),t.analysis&&!t.analysis.partial&&$("#acpl-chart-loader").remove()})));const u=lichess.storage.make("analysis.panel"),h=function(t){r.children(".active").removeClass("active"),r.find(`[data-panel="${t}"]`).addClass("active"),o.removeClass("active").filter("."+t).addClass("active"),"move-times"!=t&&!e.opts.hunter||lichess.movetimeChart||lichess.loadScript("javascripts/chart/movetime.js").then((()=>lichess.movetimeChart(n,e.trans))),("computer-analysis"==t||e.opts.hunter)&&$("#acpl-chart").length&&setTimeout(d,200)};r.on("mousedown","span",(function(){const t=$(this).data("panel");u.set(t),h(t)}));const p=u.get();if(p&&r.children(`[data-panel="${p}"]`).filter((function(){const t=window.getComputedStyle(this).display;return!!t&&"none"!=t})).length)h(p);else{const t=r.children('[data-panel="ctable"]');(t.length?t:r.children(":first-child")).trigger("mousedown")}n.analysis||o.find("form.future-game-analysis").on("submit",(function(){return $(this).hasClass("must-login")?(confirm(e.trans("youNeedAnAccountToDoThat"))&&(location.href="/signup"),!1):((t=>{const e=t.getAttribute("action");return e?q(e,{method:t.method,body:new FormData(t)}):Promise.reject(`Form has no action: ${t}`)})(this).then(d,lichess.reload),!1)})),o.on("click",".pgn",(function(){const t=window.getSelection(),e=document.createRange();e.selectNodeContents(this),t.removeAllRanges(),t.addRange(e)})),o.on("click",".embed-howto",(function(){const t='<iframe src="'+`${ve()}/embed/${n.game.id}${location.hash}`+'?theme=auto&bg=auto"\nwidth=600 height=397 frameborder=0></iframe>';ea($('<strong style="font-size:1.5em">'+$(this).html()+"</strong><br /><br /><pre>"+lichess.escapeHtml(t)+"</pre><br />"+t+'<br /><br /><a class="text" data-icon="" href="/developers#embed-game">Read more about embedding games</a>'))}))}const yl=(t,e=100)=>{let n;const o=lr(e,(()=>requestAnimationFrame((()=>{t(),n&&clearTimeout(n),n=setTimeout(o,500)}))));o()};let wl=!1;let kl=!1;function Cl(t){if(window.chrome)return;const e=()=>function(t){const e=t.querySelector(".mchat"),n=t.querySelector(".analyse__board .cg-wrap"),o=t.querySelector(".analyse__side");if(e&&n&&o){const t=n.offsetHeight-o.offsetHeight;t&&(e.style.height=`calc(${t}px - 2vmin)`)}}(t);var n;yl(e),n=e,wl||(wl=!0,document.body.addEventListener("chessground.resize",n)),kl||(lichess.pubsub.on("chat.resize",e),kl=!0)}function xl(t,e){return p("div.analyse__moves.areplay",[t.embed&&t.study?p("div.chapter-name",t.study.currentChapter().name):null,Ka(t,e)].concat(function(t){let e;if(t.data.game.status.id>=30)switch(t.data.game.winner){case"white":e="1-0";break;case"black":e="0-1";break;default:e="½-½"}const n=[];if(e){n.push(p("div.result",e));const o=Ot(t.data,t.data.game.winner);n.push(p("div.status",[pc(t),o?", "+t.trans("white"==o.color?"whiteIsVictorious":"blackIsVictorious"):null]))}return n}(t)))}function Sl(t){if(!t.ongoing&&t.data.userAnalysis)return t.redirecting?ge():p("div.copyables",[p("div.pair",[p("label.name","FEN"),p("input.copyable.autoselect.analyse__underboard__fen",{attrs:{spellCheck:!1},hook:{insert:e=>{const n=e.elm;n.value=P(t.fenInput)?t.fenInput:t.node.fen,n.addEventListener("change",(e=>{n.value!==t.node.fen&&n.reportValidity()&&t.changeFen(n.value.trim())})),n.addEventListener("input",(e=>{t.fenInput=n.value,n.setCustomValidity(Ks(n.value.trim()).isOk?"":"Invalid FEN")}))},postpatch:(e,n)=>{const o=n.elm;P(t.fenInput)?o.value!=t.fenInput&&(o.value=t.fenInput):(o.value=t.node.fen,o.setCustomValidity(""))}}})]),p("div.pgn",[p("div.pair",[p("label.name","PGN"),p("textarea.copyable.autoselect",{attrs:{spellCheck:!1},hook:Object.assign(Object.assign({},le((e=>{e.value=P(t.pgnInput)?t.pgnInput:aa(t),e.addEventListener("input",(e=>t.pgnInput=e.target.value))}))),{postpatch:(e,n)=>{n.elm.value=P(t.pgnInput)?t.pgnInput:aa(t)}})}),p("button.button.button-thin.action.text",{attrs:ue("G"),hook:ae("click",(e=>{const n=$(".copyables .pgn textarea").val();n!==aa(t)&&t.changePgn(n)}),t.redraw)},t.trans.noarg("importPgn"))])])])}function Ml(t,e,n){return p("button.fbt",{class:{disabled:!n},attrs:{"data-act":e,"data-icon":t}})}function Pl(t){const e=""!==t.path,n=!!t.node.children[0],o=t.actionMenu.open,r=t.trans.noarg;return p("div.analyse__controls.analyse-controls",{hook:le((e=>{!function(t,e,n){for(const o of["touchstart","mousedown"])t.addEventListener(o,(t=>{e(t),t.preventDefault(),n&&n()}))}(e,(e=>{const n=function(t){const e=t.target;return e.getAttribute("data-act")||e.parentNode.getAttribute("data-act")}(e);"prev"===n||"next"===n?function(t,e,n){const o=function(){se[e](t),t.redraw(),r=Math.max(100,r-r/15),s=setTimeout(o,r)};let r=350,s=setTimeout(o,500);se[e](t);const i="touchstart"==n.type?"touchend":"mouseup";document.addEventListener(i,(()=>clearTimeout(s)),{once:!0})}(t,n,e):"first"===n?ne(t):"last"===n?ee(t):"explorer"===n?t.toggleExplorer():"practice"===n?t.togglePractice():"menu"===n&&t.actionMenu.toggle()}),t.redraw)}))},[t.embed?null:p("div.features",t.studyPractice?[p("a.fbt",{attrs:{title:r("analysis"),target:"_blank",rel:"noopener",href:t.studyPractice.analysisUrl(),"data-icon":"A"}})]:[p("button.fbt",{attrs:{title:r("openingExplorerAndTablebase"),"data-act":"explorer","data-icon":"]"},class:{hidden:o||!t.explorer.allowed()||!!t.retro,active:t.explorer.enabled()}}),t.ceval.possible&&t.ceval.allowed()&&!t.isGamebook()?p("button.fbt",{attrs:{title:r("practiceWithComputer"),"data-act":"practice","data-icon":""},class:{hidden:o||!!t.retro,active:!!t.practice}}):null]),p("div.jumps",[Ml("W","first",e),Ml("Y","prev",e),Ml("X","next",n),Ml("V","last",n)]),t.studyPractice?p("div.noop"):p("button.fbt",{class:{active:o},attrs:{title:r("menu"),"data-act":"menu","data-icon":"["}})])}function El(t,e){2===t.data.pref.coords&&($("body").toggleClass("coords-in",e).toggleClass("coords-out",!e),xo())}function Al(t,e){return e+(t&&t.data.chapter?"."+t.data.chapter.id:"")}function Tl(t){if(t.nvui)return t.nvui.render(t);const e=function(t){const e=t.study&&void 0!==t.study.data.chapter.conceal?{owner:t.study.isChapterOwner(),ply:t.study.data.chapter.conceal}:null;if(e)return n=>(o,r)=>!e||n&&e.ply>=r.ply||Dt(t.path,o)?null:e.owner?"conceal":"hide"}(t),n=t.study,o=!(t.retro&&t.retro.isSolving()||t.practice),r=t.actionMenu.open,s=t.gamebookPlay(),i=s&&function(t){const e=t.state,n=e.comment||ol[e.feedback];return p("div.gamebook",{hook:{insert:t=>lichess.loadCssPath("analyse.gamebook.play")}},[n?p("div.comment",{class:{hinted:e.showHint}},[p("div.content",{hook:nt(n)}),rl(t)]):void 0,p("div.floor",[sl(t,e),p("img.mascot",{attrs:{width:120,height:120,src:lichess.assetUrl("images/mascot/octopus.svg")}})])])}(s),a=function(t){return!!t.study&&t.study.data.chapter.gamebook&&!t.gamebookPlay()&&"analyse"!==t.study.vm.gamebookOverride}(t)?function(t){const e=t.study,n=t.turnColor()===t.data.orientation,o=!!(t.node.comments||[]).find((t=>t.text.length>2)),r=t.tree.parentNode(t.path).children.length>1;let s;const i=ae("click",(()=>{e.commentForm.start(e.vm.chapterId,t.path,t.node),e.vm.toolTab("comments"),lichess.requestIdleCallback((()=>$("#comment-text").each((function(){this.focus()}))),500)}),t.redraw);return s=t.path?t.onMainline?n?[p("div.legend.todo.clickable",{hook:i,class:{done:o}},[he("c"),p("p","Explain the opponent move, and help the player find the next move, with a comment.")]),Zc(t)]:[p("div.legend.clickable",{hook:i},[he("c"),p("p","You may reflect on the player's correct move, with a comment; or leave empty to jump immediately to the next move.")]),r?null:p("div.legend.clickable",{hook:ae("click",(()=>te(t)),t.redraw)},[he("G"),p("p","Add variation moves to explain why specific other moves are wrong.")]),Qc(t)]:[p("div.legend.todo.clickable",{hook:i,class:{done:o}},[he("c"),p("p","Explain why this move is wrong in a comment")]),p("div.legend",[p("p","Or promote it as the mainline if it is the right move.")])]:n?[p("div.legend.todo.clickable",{hook:i,class:{done:o}},[he("c"),p("p","Help the player find the initial move, with a comment.")]),Zc(t)]:[p("div.legend.clickable",{hook:i},[he("c"),p("p","Introduce the gamebook with a comment")]),p("div.legend.todo",{class:{done:!!t.node.children[0]}},[he("G"),p("p","Put the opponent's first move on the board.")])],p("div.gamebook-edit",{hook:{insert:t=>lichess.loadCssPath("analyse.gamebook.edit")}},s)}(t):void 0,c=vl(t),l=!c&&mc(t),d=t.showEvalGauge(),u=!!d||!!c,h=function(t){const e=t.study,n=null==e?void 0:e.relay;if(e&&(null==n?void 0:n.tourShow.active)){const o=null==n?void 0:n.currentRound();return p("div.relay-tour",[p("div.relay-tour__text",[p("h1",n.data.tour.name),p("div.relay-tour__round",[p("strong",o.name)," ",o.ongoing?t.trans.noarg("playingRightNow"):o.startsAt?p("time.timeago",{hook:{insert(t){t.elm.setAttribute("datetime",""+o.startsAt)}}},lichess.timeago(o.startsAt)):null]),n.data.tour.markup?p("div",{hook:Z(n.data.tour.markup,(()=>n.data.tour.markup))}):p("div",n.data.tour.description)]),Hi(e.multiBoard,e)])}}(t);return p("main.analyse.variant-"+t.data.game.variant.key,{hook:{insert:e=>{El(t,u),!!c!=$("body").hasClass("header-margin")&&requestAnimationFrame((()=>{$("body").toggleClass("header-margin",!!c),t.redraw()})),Cl(e.elm)},update(e,n){El(t,u)},postpatch(t,e){t.data.gaugeOn!==d&&document.body.dispatchEvent(new Event("chessground.resize")),e.data.gaugeOn=d}},class:{"comp-off":!t.showComputer(),"gauge-on":d,"has-players":!!c,"has-clocks":!!l,"has-relay-tour":!!h,"analyse-hunter":t.opts.hunter}},[t.keyboardHelp?xe(t):null,n?Da(n):null,h||p(Al(n,"div.analyse__board.main-board"),{hook:"ontouchstart"in window||t.gamebookPlay()?void 0:ae("wheel",(e=>function(t,e){const n=e.target;if("PIECE"===n.tagName||"SQUARE"===n.tagName||"CG-BOARD"===n.tagName)return e.preventDefault(),e.deltaY>0?Zt(t):e.deltaY<0&&te(t),t.redraw(),!1}(t,e)))},[...l||[],c?c[t.bottomIsWhite()?1:0]:null,Mo(t),c?c[t.bottomIsWhite()?0:1]:null,Io(t)]),d&&!h?gi(t):null,r||h?null:Cc(t,t.topColor(),"top"),i||(h?null:p(Al(n,"div.analyse__tools"),[...r?[ba(t)]:[vi(t),o?ki(t):null,xl(t,e),a||ac(t,e),Wc(t)||Yc(t)||jc(t)]])),r||h?null:Cc(t,t.bottomColor(),"bottom"),i||h?null:Pl(t),t.embed||h?null:p("div.analyse__underboard",{hook:t.synthetic||Tt(t.data)?void 0:le((e=>bl(e,t)))},n?La(t):[Sl(t)]),h?null:dl(t),t.embed?null:t.studyPractice?Ta(n):p("aside.analyse__side",{hook:le((e=>{t.opts.$side&&t.opts.$side.length&&$(e).replaceWith(t.opts.$side),$(e).append($(".context-streamers").clone().removeClass("none"))}))},t.studyPractice?[Ta(n)]:n?[qa(n)]:[t.forecast?yc(t,t.forecast):null,!t.synthetic&&Tt(t.data)?p("div.back-to-game",p("a.button.button-empty.text",{attrs:{href:oa(t.data,t.data.player.color),"data-icon":"i"}},t.trans.noarg("backToGame"))):null]),n&&n.relay&&ul(n.relay),t.opts.chat&&p("section.mchat",{hook:le((e=>{var n;const o=t.opts.chat;null===(n=o.instance)||void 0===n||n.then((t=>t.destroy())),o.parseMoves=!0,o.instance=lichess.makeChat(o)}))}),t.embed?null:p("div.chat__members.none",{hook:le(lichess.watchers)})])}const Il=u([k,y]);function _l(t){t.element=document.querySelector("main.analyse"),t.trans=lichess.trans(t.i18n);const e=lichess.analysis=new hc(t,(function(){o=Il(o,Tl(e))})),n=Tl(e);t.element.innerHTML="";let o=Il(t.element,n);return function(){if("ontouchstart"in window)return;let t,e;const n=n=>{t=n.pageX,e=n.pageY};let o={};$("#topnav.hover").each((function(){const r=$(this).removeClass("hover"),s=()=>r.toggleClass("hover"),i=()=>{Math.sqrt((o.pX-t)*(o.pX-t)+(o.pY-e)*(o.pY-e))<8?(r.off(o.event,n),delete o.timeoutId,o.isActive=!0,s()):(o.pX=t,o.pY=e,o.timeoutId=setTimeout(i,200))},a=function(t){o.timeoutId&&(o.timeoutId=clearTimeout(o.timeoutId));const e=o.event="mousemove";if("mouseover"==t.type){if(o.isActive||t.buttons)return;o.pX=t.pageX,o.pY=t.pageY,r.off(e,n).on(e,n),o.timeoutId=setTimeout(i,200)}else{if(!o.isActive)return;r.off(e,n),o={},s()}};r.on("mouseover",a).on("mouseleave",a)}))}(),{socketReceive:e.socket.receive,path:()=>e.path,setChapter(t){e.study&&e.study.setChapter(t)}}}return window.Chessground=ko,window.LichessChat=function(t,e){const n=u([k,y]),o=K(e,(function(){s=n(s,kt(o))})),r=kt(o);t.innerHTML="";let s=n(t,r);return o},t.boot=function(t){lichess.socket=new lichess.StrongSocket(t.data.url.socket,t.data.player.version,{params:{userTv:t.data.userTv&&t.data.userTv.id},receive(t,n){e.socketReceive(t,n)}}),t.$side=$(".analyse__side").clone(),t.$underboard=$(".analyse__underboard").clone(),t.socketSend=lichess.socket.send;const e=_l(t)},t.patch=Il,t.start=_l,Object.defineProperty(t,"__esModule",{value:!0}),t}({});
