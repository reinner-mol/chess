var LichessRound=function(e){"use strict";const t={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,o){return document.createElementNS(e,t,o)},createTextNode:function(e){return document.createTextNode(e)},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,o){e.insertBefore(t,o)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){e.appendChild(t)},parentNode:function(e){return e.parentNode},nextSibling:function(e){return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType}};function o(e,t,o,n,s){return{sel:e,data:t,children:o,text:n,elm:s,key:void 0===t?void 0:t.key}}const n=Array.isArray;function s(e){return"string"==typeof e||"number"==typeof e}function r(e){return void 0===e}function i(e){return void 0!==e}const a=o("",{},[],void 0,void 0);function c(e,t){var o,n;const s=e.key===t.key,r=(null===(o=e.data)||void 0===o?void 0:o.is)===(null===(n=t.data)||void 0===n?void 0:n.is);return e.sel===t.sel&&s&&r}function l(e,t,o){var n;const s={};for(let r=t;r<=o;++r){const t=null===(n=e[r])||void 0===n?void 0:n.key;void 0!==t&&(s[t]=r)}return s}const d=["create","update","remove","destroy","pre","post"];function u(e,u){let h,p;const m={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},f=void 0!==u?u:t;for(h=0;h<d.length;++h)for(m[d[h]]=[],p=0;p<e.length;++p){const t=e[p][d[h]];void 0!==t&&m[d[h]].push(t)}function g(e){const t=e.id?"#"+e.id:"",n=e.className?"."+e.className.split(" ").join("."):"";return o(f.tagName(e).toLowerCase()+t+n,{},[],void 0,e)}function v(e,t){return function(){if(0==--t){const t=f.parentNode(e);f.removeChild(t,e)}}}function b(e,t){var o,c;let l,d=e.data;if(void 0!==d){const t=null===(o=d.hook)||void 0===o?void 0:o.init;i(t)&&(t(e),d=e.data)}const u=e.children,h=e.sel;if("!"===h)r(e.text)&&(e.text=""),e.elm=f.createComment(e.text);else if(void 0!==h){const o=h.indexOf("#"),r=h.indexOf(".",o),p=o>0?o:h.length,g=r>0?r:h.length,v=-1!==o||-1!==r?h.slice(0,Math.min(p,g)):h,w=e.elm=i(d)&&i(l=d.ns)?f.createElementNS(l,v,d):f.createElement(v,d);for(p<g&&w.setAttribute("id",h.slice(p+1,g)),r>0&&w.setAttribute("class",h.slice(g+1).replace(/\./g," ")),l=0;l<m.create.length;++l)m.create[l](a,e);if(n(u))for(l=0;l<u.length;++l){const e=u[l];null!=e&&f.appendChild(w,b(e,t))}else s(e.text)&&f.appendChild(w,f.createTextNode(e.text));const k=e.data.hook;i(k)&&(null===(c=k.create)||void 0===c||c.call(k,a,e),k.insert&&t.push(e))}else e.elm=f.createTextNode(e.text);return e.elm}function w(e,t,o,n,s,r){for(;n<=s;++n){const s=o[n];null!=s&&f.insertBefore(e,b(s,r),t)}}function k(e){var t,o;const n=e.data;if(void 0!==n){null===(o=null===(t=null==n?void 0:n.hook)||void 0===t?void 0:t.destroy)||void 0===o||o.call(t,e);for(let t=0;t<m.destroy.length;++t)m.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const o=e.children[t];null!=o&&"string"!=typeof o&&k(o)}}}function y(e,t,o,n){for(var s,r;o<=n;++o){let n,a;const c=t[o];if(null!=c)if(i(c.sel)){k(c),n=m.remove.length+1,a=v(c.elm,n);for(let e=0;e<m.remove.length;++e)m.remove[e](c,a);const e=null===(r=null===(s=null==c?void 0:c.data)||void 0===s?void 0:s.hook)||void 0===r?void 0:r.remove;i(e)?e(c,a):a()}else f.removeChild(e,c.elm)}}function C(e,t,o){var n,s,a,d,u;const h=null===(n=t.data)||void 0===n?void 0:n.hook;null===(s=null==h?void 0:h.prepatch)||void 0===s||s.call(h,e,t);const p=t.elm=e.elm,g=e.children,v=t.children;if(e!==t){if(void 0!==t.data){for(let o=0;o<m.update.length;++o)m.update[o](e,t);null===(d=null===(a=t.data.hook)||void 0===a?void 0:a.update)||void 0===d||d.call(a,e,t)}r(t.text)?i(g)&&i(v)?g!==v&&function(e,t,o,n){let s,i,a,d,u=0,h=0,p=t.length-1,m=t[0],g=t[p],v=o.length-1,k=o[0],T=o[v];for(;u<=p&&h<=v;)null==m?m=t[++u]:null==g?g=t[--p]:null==k?k=o[++h]:null==T?T=o[--v]:c(m,k)?(C(m,k,n),m=t[++u],k=o[++h]):c(g,T)?(C(g,T,n),g=t[--p],T=o[--v]):c(m,T)?(C(m,T,n),f.insertBefore(e,m.elm,f.nextSibling(g.elm)),m=t[++u],T=o[--v]):c(g,k)?(C(g,k,n),f.insertBefore(e,g.elm,m.elm),g=t[--p],k=o[++h]):(void 0===s&&(s=l(t,u,p)),i=s[k.key],r(i)?f.insertBefore(e,b(k,n),m.elm):(a=t[i],a.sel!==k.sel?f.insertBefore(e,b(k,n),m.elm):(C(a,k,n),t[i]=void 0,f.insertBefore(e,a.elm,m.elm))),k=o[++h]);(u<=p||h<=v)&&(u>p?(d=null==o[v+1]?null:o[v+1].elm,w(e,d,o,h,v,n)):y(e,t,u,p))}(p,g,v,o):i(v)?(i(e.text)&&f.setTextContent(p,""),w(p,null,v,0,v.length-1,o)):i(g)?y(p,g,0,g.length-1):i(e.text)&&f.setTextContent(p,""):e.text!==t.text&&(i(g)&&y(p,g,0,g.length-1),f.setTextContent(p,t.text)),null===(u=null==h?void 0:h.postpatch)||void 0===u||u.call(h,e,t)}}return function(e,t){let o,n,s;const r=[];for(o=0;o<m.pre.length;++o)m.pre[o]();for(function(e){return void 0!==e.sel}(e)||(e=g(e)),c(e,t)?C(e,t,r):(n=e.elm,s=f.parentNode(n),b(t,r),null!==s&&(f.insertBefore(s,t.elm,f.nextSibling(n)),y(s,[e],0,0))),o=0;o<r.length;++o)r[o].data.hook.insert(r[o]);for(o=0;o<m.post.length;++o)m.post[o]();return t}}function h(e,t,o){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==o&&void 0!==t)for(let e=0;e<t.length;++e){const o=t[e].data;void 0!==o&&h(o,t[e].children,t[e].sel)}}function p(e,t,r){let i,a,c,l={};if(void 0!==r?(null!==t&&(l=t),n(r)?i=r:s(r)?a=r:r&&r.sel&&(i=[r])):null!=t&&(n(t)?i=t:s(t)?a=t:t&&t.sel?i=[t]:l=t),void 0!==i)for(c=0;c<i.length;++c)s(i[c])&&(i[c]=o(void 0,void 0,void 0,i[c],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||h(l,i,e),o(e,l,i,a,void 0)}function m(e,t){e.data.fn=t.data.fn,e.data.args=t.data.args,t.data=e.data,t.children=e.children,t.text=e.text,t.elm=e.elm}function f(e){const t=e.data;m(t.fn(...t.args),e)}function g(e,t){let o;const n=e.data,s=t.data,r=n.args,i=s.args;if(n.fn===s.fn&&r.length===i.length){for(o=0;o<i.length;++o)if(r[o]!==i[o])return void m(s.fn(...i),t);m(e,t)}else m(s.fn(...i),t)}function v(e,t){let o;const n=t.elm;let s=e.data.attrs,r=t.data.attrs;if((s||r)&&s!==r){for(o in s=s||{},r=r||{},r){const e=r[o];s[o]!==e&&(!0===e?n.setAttribute(o,""):!1===e?n.removeAttribute(o):120!==o.charCodeAt(0)?n.setAttribute(o,e):58===o.charCodeAt(3)?n.setAttributeNS("http://www.w3.org/XML/1998/namespace",o,e):58===o.charCodeAt(5)?n.setAttributeNS("http://www.w3.org/1999/xlink",o,e):n.setAttribute(o,e))}for(o in s)o in r||n.removeAttribute(o)}}const b={create:v,update:v};function w(e,t){let o,n;const s=t.elm;let r=e.data.class,i=t.data.class;if((r||i)&&r!==i){for(n in r=r||{},i=i||{},r)r[n]&&!Object.prototype.hasOwnProperty.call(i,n)&&s.classList.remove(n);for(n in i)o=i[n],o!==r[n]&&s.classList[o?"add":"remove"](n)}}const k={create:w,update:w},y=e=>void 0!==e,C=e=>{let t=e;return function(e){return y(e)&&(t=e),t}},T={Accept:"application/vnd.lichess.v5+json"},M={cache:"no-cache",credentials:"same-origin"},x={"X-Requested-With":"XMLHttpRequest"},S=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},M),{headers:Object.assign(Object.assign({},T),x)}),t)).then((e=>{if(e.ok)return e.json();throw e.statusText})),P=(e,t={})=>L(e,t).then((e=>{if(e.ok)return e.text();throw e.statusText})),L=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},M),{headers:Object.assign({},x)}),t)),D=e=>{const t=new FormData;for(const o of Object.keys(e))t.append(o,e[o]);return t},E=["white","black"],O=["a","b","c","d","e","f","g","h"],A=["1","2","3","4","5","6","7","8"],N=[...A].reverse(),j=Array.prototype.concat(...O.map((e=>A.map((t=>e+t))))),B=e=>j[8*e[0]+e[1]],I=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],R=j.map(I);const _=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},z=e=>"white"===e?"black":"white",q=(e,t)=>{const o=e[0]-t[0],n=e[1]-t[1];return o*o+n*n},F=(e,t)=>e.role===t.role&&e.color===t.color,H=(e,t,o,n)=>[(t?e[0]:7-e[0])*o,(t?7-e[1]:e[1])*n],G=e=>{const t=e.width/8,o=e.height/8;return(e,n)=>H(e,n,t,o)},K=(e,t)=>H(e,t,100,100),U=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},W=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},Y=(e,t)=>{e.style.visibility=t?"visible":"hidden"},V=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},X=e=>2===e.buttons||2===e.button,J=(e,t)=>{const o=document.createElement(e);return t&&(o.className=t),o};function Q(e,t,o){const n=I(e);return t||(n[0]=7-n[0],n[1]=7-n[1]),[o.left+o.width*n[0]/8+o.width/16,o.top+o.height*(7-n[1])/8+o.height/16]}const Z={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:0},ee=e=>({attrs:{"data-icon":e}}),te=e=>{if(e)return"@"===e[1]?[e.slice(2,4)]:[e.slice(0,2),e.slice(2,4)]},oe=e=>({insert(t){e(t.elm)}}),ne=(e,t,o,n=!0)=>oe((s=>{s.addEventListener(e,(e=>{t(e),o&&o()}),{passive:n})}));function se(e){const t=new Map;if(!e)return t;if("string"==typeof e)for(const o of e.split(" "))t.set(o.slice(0,2),o.slice(2).match(/.{2}/g));else for(const o in e)t.set(o,e[o].match(/.{2}/g));return t}const re={white:0,black:0};function ie(e,t){const o=e.substring(0,14);return p("a",{class:{"user-link":!0,ulpt:!0},attrs:{href:"/@/"+e}},t&&"BOT"!=t?[p("span.utitle",t),o]:[o])}function ae(e,t){return{insert(o){o.elm.addEventListener(e,t)}}}const ce={start:["hi/Hello","gl/Good luck","hf/Have fun!","u2/You too!"].map(le),end:["gg/Good game","wp/Well played","ty/Thank you","gtg/I've got to go","bye/Bye!"].map(le)};function le(e){const t=e.split("/");return{key:t[0],text:t[1]}}const de=e=>P(ue(e)),ue=e=>`/${e}/note`;function he(e,t,o=!1){let n,s=0;return function(...r){const i=this;n&&clearTimeout(n),n=void 0;const a=performance.now()-s;s=performance.now(),o&&a>t?e.apply(i,r):n=setTimeout((()=>{n=void 0,e.apply(i,r)}),t)}}function pe(e){let t=e.text;const o=he((()=>{((e,t)=>{S(ue(e),{method:"post",body:D({text:t})})})(e.id,t||"")}),1e3);return{id:e.id,trans:e.trans,text:()=>t,fetch(){de(e.id).then((o=>{t=o||"",e.redraw()}))},post(e){t=e,o()}}}function me(e){const t=e.text();return null==t?p("div.loading",{hook:{insert:e.fetch}}):p("textarea",{attrs:{placeholder:e.trans("typePrivateNotesHere")},hook:{insert(o){const n=$(o.elm);n.val(t).on("change keyup paste",(()=>e.post(n.val())))}}})}let fe=!1;function ge(e){let t,o=!1;const n=()=>{t=void 0,o=!1,e.redraw()};return{loading:()=>o,data:()=>t,reasons:e.reasons,permissions:()=>e.permissions,open:n=>{const s=n.querySelector("a.user-link"),r=n.querySelector("t").innerText,i=s.href.split("/")[4];e.permissions.timeout?(o=!0,(e=>S("/mod/chat-user/"+e))(i).then((n=>{t=Object.assign(Object.assign({},n),{text:r}),o=!1,e.redraw()}))):t={id:i.toLowerCase(),username:i,text:r},e.redraw()},close:n,timeout(o,s){t&&lichess.pubsub.emit("socket.send","timeout",{userId:t.id,reason:o.key,text:s}),n(),e.redraw()}}}const ve=()=>p("i.mod",{attrs:{"data-icon":""}});function be(e,t){const o=e.data;o.domVersion=1;const n={instance:void 0,loaded:!1,enabled:C(!!o.palantir)},s=["discussion"];e.noteId&&s.push("note"),e.plugin&&s.push(e.plugin.tab.key);const r=lichess.storage.make("chat.tab"),i=r.get();let a;const c={tab:s.find((e=>e===i))||s[0],enabled:e.alwaysEnabled||!lichess.storage.get("nochat"),placeholderKey:"talkInChat",loading:!1,timeout:e.timeout,writeable:e.writeable};s.length>1&&"discussion"===c.tab&&lichess.storage.get("nochat")&&(c.tab=s[1]);const l=e=>!!(e=e.trim())&&(!("You too!"==e&&!o.lines.some((e=>e.u!=o.userId)))&&(e.length>140?(alert("Max length: 140 chars. "+e.length+" chars used."),!1):(lichess.pubsub.emit("socket.send","talk",e),!0))),d=lichess.trans(e.i18n);function u(){(e.permissions.timeout||e.permissions.local)&&(a=ge({reasons:e.timeoutReasons||[{key:"other",name:"Inappropriate behavior"}],permissions:e.permissions,redraw:t}),e.loadCss("chat.mod"))}u();const h=e.noteId?pe({id:e.noteId,text:e.noteText,trans:d,redraw:t}):void 0,p=function(e){let t=e.initialGroup,o=[];return{group:()=>t,said:()=>o,setGroup(n){n!==t&&(t=n,n||(o=[]),e.redraw())},post(n){t&&ce[t]&&(o.includes(n.key)||e.post(n.text)&&o.push(n.key))}}}({initialGroup:e.preset,post:l,redraw:t}),m=[["socket.in.message",e=>{o.lines.push(e);const n=o.lines.length;n>200&&(o.lines.splice(0,n-200+50),o.domVersion++),t()}],["socket.in.chat_timeout",e=>{let n=!1;o.lines.forEach((t=>{t.u&&t.u.toLowerCase()==e&&(t.d=!0,n=!0)})),e==o.userId&&(c.timeout=n=!0),n&&(o.domVersion++,t())}],["socket.in.chat_reinstate",e=>{e==o.userId&&(c.timeout=!1,t())}],["chat.writeable",e=>{c.writeable=e,t()}],["chat.permissions",o=>{let n;for(n in o)e.permissions[n]=o[n];u(),t()}],["palantir.toggle",n.enabled]];m.forEach((([e,t])=>lichess.pubsub.on(e,t)));const f=()=>lichess.pubsub.emit("chat.enabled",c.enabled);return f(),{data:o,opts:e,vm:c,allTabs:s,setTab(e){c.tab=e,r.set(e),"discussion"===e&&lichess.requestIdleCallback((()=>$(".mchat__say").each((function(){this.focus()}))),500),t()},moderation:()=>a,note:h,preset:p,post:l,trans:d,plugin:e.plugin,setEnabled(e){c.enabled=e,f(),e?lichess.storage.remove("nochat"):lichess.storage.set("nochat","1"),t()},redraw:t,palantir:n,destroy:()=>{m.forEach((([e,t])=>lichess.pubsub.off(e,t)))}}}const we=/(^|[^\w@#/])@([a-z0-9][a-z0-9_-]{0,28}[a-z0-9])/gi;function ke(e,t,o){return e.includes("&quot;")?e:`<a target="_blank" rel="noopener nofollow noreferrer" href="${e.startsWith("/")||e.includes("://")?e:"//"+e}"${o?` class="${o}"`:""}>${t||e}</a>`}const ye=/\b\b(?:https?:\/\/)?(lichess\.org\/[-–—\w+&'@#\/%?=()~|!:,.;]+[\w+&@#\/%=~|])/gi,Ce=/^[a-h][2-7]$/,Te=/\b(\d+)\s*(\.+)\s*(?:[o0-]+[o0]|[NBRQKP\u2654\u2655\u2656\u2657\u2658\u2659]?[a-h]?[1-8]?[x@]?[a-z][1-8](?:=[NBRQK\u2654\u2655\u2656\u2657\u2658\u2659])?)\+?#?[!\?=]{0,5}/gi;function Me(e,t,o){if(t<1||t>200)return e;return'<a class="jump" data-ply="'+(2*t-(o.length>1?0:1))+'">'+e+"</a>"}function xe(e,t,o){return o.match(Ce)?e:function(e,t,o){return t+ke("/@/"+o,"@"+o)}(0,t,o)}function Se(e,t){const o=lichess.escapeHtml(e),n=o.replace(we,xe).replace(ye,ke);return t&&n===o?n.replace(Te,Me):n}const Pe=()=>"1"==lichess.storage.get("chat-spam"),Le=new RegExp(["xcamweb.com","(^|[^i])chess-bot","chess-cheat","coolteenbitch","letcafa.webcam","tinyurl.com/","wooga.info/","bit.ly/","wbt.link/","eb.by/","001.rs/","shr.name/","u.to/",".3-a.net",".ssl443.org",".ns02.us",".myftp.info",".flinkup.com",".serveusers.com","badoogirls.com","hide.su","wyon.de","sexdatingcz.club","qps.ru","tiny.cc/"].map((e=>e.replace(/\./g,"\\.").replace(/\//g,"\\/"))).join("|")),De=e=>!!e.match(Le),Ee=/follow me|join my team/i,Oe=e=>!!e.match(Ee),Ae=/lichess\.org\/team\//i,$e=/^\/[wW](?:hisper)?\s/;function Ne(e){if(!e.vm.enabled)return[];const t=t=>{const o=t.elm;if(e.data.lines.length>5){(0===o.scrollTop||o.scrollTop>o.scrollHeight-o.clientHeight-100)&&(o.scrollTop=999999,setTimeout((e=>o.scrollTop=999999),300))}},o=!!e.moderation(),n=[p("ol.mchat__messages.chat-v-"+e.data.domVersion,{attrs:{role:"log","aria-live":"polite","aria-atomic":"false"},hook:{insert(n){const s=$(n.elm).on("click","a.jump",(e=>{lichess.pubsub.emit("jump",e.target.getAttribute("data-ply"))}));o?s.on("click",".mod",(t=>{var o;return null===(o=e.moderation())||void 0===o?void 0:o.open(t.target.parentNode)})):s.on("click",".flag",(t=>function(e,t){const o=t.querySelector("a.user-link"),n=t.querySelector("t").innerText;o&&confirm(`Report "${n}" to moderators?`)&&((e,t,o)=>{S("/report/flag",{method:"post",body:D({username:t,resource:e,text:o})})})(e.data.resourceId,o.href.split("/")[4],n)}(e,t.target.parentNode))),t(n)},postpatch:(e,o)=>t(o)}},Re(e).map((t=>function(e,t){const o=function(e,t){if(o=e,/(\n|(@|#|\.)\w{2,})/.test(o)){const o=function(e){return(t,o)=>{o.data.lichessChat!==t.data.lichessChat&&(o.elm.innerHTML=Se(o.data.lichessChat,e))}}(t);return p("t",{lichessChat:e,hook:{create:o,update:o}})}var o;return p("t",e)}(t.t,e.opts.parseMoves);if("lichess"===t.u)return p("li.system",o);if(t.c)return p("li",[p("span.color","["+t.c+"]"),o]);const n=(s="a",r=t.u,i=ie,a=[t.u,t.title],void 0===a&&(a=i,i=r,r=void 0),p(s,{key:r,hook:{init:f,prepatch:g},fn:i,args:a}));var s,r,i,a;return p("li",e.moderation()?[t.u?ve():null,n," ",o]:[e.data.userId&&t.u&&e.data.userId!=t.u?p("i.flag",{attrs:{"data-icon":"!",title:"Report"}}):null,n," ",o])}(e,t)))),je(e)],s=function(e){const t=e.group();if(!t)return;const o=ce[t],n=e.said();return o&&n.length<2?p("div.mchat__presets",o.map((t=>{const o=n.includes(t.key);return p("span",{class:{disabled:o},attrs:{title:t.text,disabled:o},hook:ae("click",(()=>{!o&&e.post(t)}))},t.key)}))):void 0}(e.preset);return s&&n.push(s),n}function je(e){if(!e.vm.writeable)return;if(e.data.loginRequired&&!e.data.userId||e.data.restricted)return p("input.mchat__say",{attrs:{placeholder:e.trans("loginToChat"),disabled:!0}});let t;return t=e.vm.timeout?e.trans("youHaveBeenTimedOut"):e.opts.blind?"Chat":e.trans.noarg(e.vm.placeholderKey),p("input.mchat__say",{attrs:{placeholder:t,autocomplete:"off",maxlength:140,disabled:e.vm.timeout||!e.vm.writeable,"aria-label":"Chat input"},hook:{insert(t){Ie(e,t.elm)}}})}let Be;const Ie=(e,t)=>{const o=lichess.tempStorage.make("chat.input"),n=o.get();n&&(t.value=n,t.focus(),!e.opts.public&&n.match($e)&&t.classList.add("whisper")),t.addEventListener("keydown",(t=>{"Enter"===t.key&&setTimeout((()=>{const n=t.target,s=n.value,r=e.opts.public;""===s?$(".keyboard-move input").each((function(){this.focus()})):(e.opts.kobold||(e=>{if(Pe())return;const t=De(e);t&&P(`/jslog/${window.location.href.substr(-12)}?n=spam`,{method:"post"}),(t||Oe(e))&&lichess.storage.set("chat-spam","1")})(s),r&&(e=>!!e.match(Ae))(s)?alert("Please don't advertise teams in the chat."):e.post(s),n.value="",o.remove(),r||n.classList.remove("whisper"))}))})),t.addEventListener("input",(t=>setTimeout((()=>{const n=t.target,s=n.value;n.removeAttribute("placeholder"),e.opts.public||n.classList.toggle("whisper",!!s.match($e)),o.set(s)})))),window.Mousetrap.bind("c",(()=>t.focus()));const s=["touchstart","mousedown"];Be&&s.forEach((e=>document.body.removeEventListener(e,Be,{capture:!0}))),Be=e=>{e.shiftKey||2===e.buttons||2===e.button||t.blur()},t.onfocus=()=>s.forEach((e=>document.body.addEventListener(e,Be,{passive:!0,capture:!0}))),t.onblur=()=>s.forEach((e=>document.body.removeEventListener(e,Be,{capture:!0})))};function Re(e){const t=[];let o;return e.data.lines.forEach((n=>{var s,r,i;n.d||o&&(i=n,(r=o).d&&i.d&&r.u===i.u)||n.r&&(n.u||"").toLowerCase()!=e.data.userId||(s=n.t,(De(s)||Oe(s))&&!Pe())||t.push(n),o=n})),t}function _e(e){const t=e.moderation();return p("section.mchat"+(e.opts.alwaysEnabled?"":".mchat-optional"),{class:{"mchat-mod":!!t},hook:{destroy:e.destroy}},function(e){if(!e)return;if(e.loading())return[p("div.loading")];const t=e.data();if(!t)return;const o=e.permissions(),n=t.history?p("div.infos.block",[(s=t.games||0,!1===fe&&(fe=window.Intl&&Intl.NumberFormat?new Intl.NumberFormat:null),(null===fe?""+s:fe.format(s))+" games"),t.troll?"TROLL":void 0,t.engine?"ENGINE":void 0,t.booster?"BOOSTER":void 0].map((e=>e&&p("span",e))).concat([p("a",{attrs:{href:"/@/"+t.username+"?mod"}},"profile")]).concat(o.shadowban?[p("a",{attrs:{href:"/mod/"+t.username+"/communication"}},"coms")]:[])):void 0;var s;const r=o.timeout?p("div.timeout.block",[p("strong","Timeout 15 minutes for"),...e.reasons.map((o=>p("a.text",{attrs:{"data-icon":"p"},hook:ae("click",(()=>e.timeout(o,t.text)))},o.name)))]):p("div.timeout.block",[p("strong","Moderation"),p("a.text",{attrs:{"data-icon":"p"},hook:ae("click",(()=>e.timeout(e.reasons[0],t.text)))},"Timeout 15 minutes")]),i=t.history?p("div.history.block",[p("strong","Timeout history"),p("table",p("tbody.slist",{hook:{insert(){lichess.contentLoaded()}}},t.history.map((function(e){return p("tr",[p("td.reason",e.reason),p("td.mod",e.mod),p("td",p("time.timeago",{attrs:{datetime:e.date}}))])}))))]):void 0;return[p("div.top",{key:"mod-"+t.id},[p("span.text",{attrs:{"data-icon":""}},[ie(t.username)]),p("a",{attrs:{"data-icon":"L"},hook:ae("click",e.close)})]),p("div.mchat__content.moderation",[p("i.line-text.block",['"',t.text,'"']),n,r,i])]}(t)||function(e){const t=e.vm.tab;return[p("div.mchat__tabs.nb_"+e.allTabs.length,[...e.allTabs.map((o=>function(e,t,o){return p("div.mchat__tab."+t,{class:{"mchat__tab-active":t===o},hook:ae("click",(()=>e.setTab(t)))},function(e,t){return"discussion"===t?[p("span",e.data.name),e.opts.alwaysEnabled?void 0:p("input",{attrs:{type:"checkbox",title:e.trans.noarg("toggleTheChat"),checked:e.vm.enabled},hook:ae("change",(t=>{e.setEnabled(t.target.checked)}))})]:"note"===t?[p("span",e.trans.noarg("notes"))]:e.plugin&&t===e.plugin.tab.key?[p("span",e.plugin.tab.name)]:[]}(e,t))}(e,o,t))),ze(e)]),p("div.mchat__content."+t,"note"===t&&e.note?[me(e.note)]:e.plugin&&t===e.plugin.tab.key?[e.plugin.view()]:Ne(e))]}(e))}function ze(e){const t=e.palantir;if(t.enabled())return t.instance?t.instance.render(p):p("div.mchat__tab.palantir.palantir-slot",{attrs:{"data-icon":"",title:"Voice chat"},hook:ae("click",(()=>{t.loaded||(t.loaded=!0,lichess.loadScript("javascripts/vendor/peerjs.min.js").then((()=>{lichess.loadModule("palantir").then((()=>{t.instance=window.Palantir.palantir({uid:e.data.userId,redraw:e.redraw}),e.redraw()}))})))}))})}const qe=e=>e.steps[0].ply,Fe=e=>He(e).ply,He=e=>e.steps[e.steps.length-1],Ge=(e,t)=>e.steps[t-qe(e)],Ke=e=>{e.clock&&(e.clock.showTenths=e.pref.clockTenths,e.clock.showBar=e.pref.clockBar),e.correspondence&&(e.correspondence.showBar=e.pref.clockBar),["horde","crazyhouse"].includes(e.game.variant.key)&&(e.pref.showCaptured=!1),e.expiration&&(e.expiration.movedAt=Date.now()-e.expiration.idleMillis)},Ue=20,We=25,Ye=30;function Ve(e){return e.game.status.id>=Ye}function Xe(e){return e.game.status.id===We}function Je(e){return function(e){return e.game.status.id>=Ue}(e)&&!Ve(e)&&!Xe(e)}const Qe=e=>e.game.status.id<We&&!it(e),Ze=e=>Qe(e)&&!e.player.spectator,et=e=>Ze(e)&&e.game.player==e.player.color,tt=e=>e.game.turns-(e.game.startedAtTurn||0),ot=e=>tt(e)>1,nt=e=>Qe(e)&&!ot(e)&&!(e=>!!e.tournament||!!e.simul||!!e.swiss)(e),st=e=>Qe(e)&&e.takebackable&&ot(e)&&!e.player.proposingTakeback&&!e.opponent.proposingTakeback,rt=e=>Qe(e)&&!nt(e),it=e=>"import"===e.game.source;function at(e,t){return e.player.color===t?e.player:e.opponent.color===t?e.opponent:null}const ct=e=>!(!e.player.ai&&!e.opponent.ai),lt=(e,t,o)=>{const n=at(e,t);o=o||!!n.ai,n.onGame=o,o&&dt(e,t,!1)},dt=(e,t,o)=>{const n=at(e,t);n.gone=!n.ai&&o,!1===n.gone&&n.user&&(n.user.online=!0)};function ut(e,t){return Math.abs(e-t)}const ht=(e,t,o,n)=>{const s=ut(e,o),r=ut(t,n);return 1===s&&2===r||2===s&&1===r},pt=(e,t,o,n)=>ut(e,o)===ut(t,n),mt=(e,t,o,n)=>e===o||t===n,ft=(e,t,o,n)=>pt(e,t,o,n)||mt(e,t,o,n);function gt(e,t,o){const n=e.get(t);if(!n)return[];const s=I(t),r=n.role,i="pawn"===r?(a=n.color,(e,t,o,n)=>ut(e,o)<2&&("white"===a?n===t+1||t<=1&&n===t+2&&e===o:n===t-1||t>=6&&n===t-2&&e===o)):"knight"===r?ht:"bishop"===r?pt:"rook"===r?mt:"queen"===r?ft:function(e,t,o){return(n,s,r,i)=>ut(n,r)<2&&ut(s,i)<2||o&&s===i&&s===("white"===e?0:7)&&(4===n&&(2===r&&t.includes(0)||6===r&&t.includes(7))||t.includes(r))}(n.color,function(e,t){const o="white"===t?"1":"8",n=[];for(const[s,r]of e)s[1]===o&&r.color===t&&"rook"===r.role&&n.push(I(s)[0]);return n}(e,n.color),o);var a;return R.filter((e=>(s[0]!==e[0]||s[1]!==e[1])&&i(s[0],s[1],e[0],e[1]))).map(B)}function vt(e,...t){e&&setTimeout((()=>e(...t)),1)}function bt(e){e.premovable.current&&(e.premovable.current=void 0,vt(e.premovable.events.unset))}function wt(e){const t=e.predroppable;t.current&&(t.current=void 0,vt(t.events.unset))}function kt(e,t,o){const n=e.pieces.get(t),s=e.pieces.get(o);if(t===o||!n)return!1;const r=s&&s.color!==n.color?s:void 0;return o===e.selected&&Pt(e),vt(e.events.move,t,o,r),function(e,t,o){if(!e.autoCastle)return!1;const n=e.pieces.get(t);if(!n||"king"!==n.role)return!1;const s=I(t),r=I(o);if(0!==s[1]&&7!==s[1]||s[1]!==r[1])return!1;4!==s[0]||e.pieces.has(o)||(6===r[0]?o=B([7,r[1]]):2===r[0]&&(o=B([0,r[1]])));const i=e.pieces.get(o);return!(!i||i.color!==n.color||"rook"!==i.role||(e.pieces.delete(t),e.pieces.delete(o),s[0]<r[0]?(e.pieces.set(B([6,r[1]]),n),e.pieces.set(B([5,r[1]]),i)):(e.pieces.set(B([2,r[1]]),n),e.pieces.set(B([3,r[1]]),i)),0))}(e,t,o)||(e.pieces.set(o,n),e.pieces.delete(t)),e.lastMove=[t,o],e.check=void 0,vt(e.events.change),r||!0}function yt(e,t,o,n){if(e.pieces.has(o)){if(!n)return!1;e.pieces.delete(o)}return vt(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,vt(e.events.change),e.movable.dests=void 0,e.turnColor=z(e.turnColor),!0}function Ct(e,t,o){const n=kt(e,t,o);return n&&(e.movable.dests=void 0,e.turnColor=z(e.turnColor),e.animation.current=void 0),n}function Tt(e,t,o){if(Dt(e,t,o)){const n=Ct(e,t,o);if(n){const s=e.hold.stop();Pt(e);const r={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:s};return!0!==n&&(r.captured=n),vt(e.movable.events.after,t,o,r),!0}}else if(function(e,t,o){return t!==o&&Et(e,t)&&gt(e.pieces,t,e.premovable.castle).includes(o)}(e,t,o))return function(e,t,o,n){wt(e),e.premovable.current=[t,o],vt(e.premovable.events.set,t,o,n)}(e,t,o,{ctrlKey:e.stats.ctrlKey}),Pt(e),!0;return Pt(e),!1}function Mt(e,t,o,n){const s=e.pieces.get(t);s&&(function(e,t,o){const n=e.pieces.get(t);return!(!n||t!==o&&e.pieces.has(o)||"both"!==e.movable.color&&(e.movable.color!==n.color||e.turnColor!==n.color))}(e,t,o)||n)?(e.pieces.delete(t),yt(e,s,o,n),vt(e.movable.events.afterNewPiece,s.role,o,{premove:!1,predrop:!1})):s&&function(e,t,o){const n=e.pieces.get(t),s=e.pieces.get(o);return!!n&&(!s||s.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==n.role||"1"!==o[1]&&"8"!==o[1])&&e.movable.color===n.color&&e.turnColor!==n.color}(e,t,o)?function(e,t,o){bt(e),e.predroppable.current={role:t,key:o},vt(e.predroppable.events.set,t,o)}(e,s.role,o):(bt(e),wt(e)),e.pieces.delete(t),Pt(e)}function xt(e,t,o){if(vt(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return Pt(e),void e.hold.cancel();if((e.selectable.enabled||o)&&e.selected!==t&&Tt(e,e.selected,t))return void(e.stats.dragged=!1)}(Lt(e,t)||Et(e,t))&&(St(e,t),e.hold.start())}function St(e,t){e.selected=t,Et(e,t)?e.premovable.dests=gt(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function Pt(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Lt(e,t){const o=e.pieces.get(t);return!!o&&("both"===e.movable.color||e.movable.color===o.color&&e.turnColor===o.color)}function Dt(e,t,o){var n,s;return t!==o&&Lt(e,t)&&(e.movable.free||!!(null===(s=null===(n=e.movable.dests)||void 0===n?void 0:n.get(t))||void 0===s?void 0:s.includes(o)))}function Et(e,t){const o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}function Ot(e){const t=e.premovable.current;if(!t)return!1;const o=t[0],n=t[1];let s=!1;if(Dt(e,o,n)){const t=Ct(e,o,n);if(t){const r={premove:!0};!0!==t&&(r.captured=t),vt(e.movable.events.after,o,n,r),s=!0}}return bt(e),s}function At(e){bt(e),wt(e),Pt(e)}function $t(e){e.movable.color=e.movable.dests=e.animation.current=void 0,At(e)}function Nt(e,t,o){let n=Math.floor(8*(e[0]-o.left)/o.width);t||(n=7-n);let s=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(s=7-s),n>=0&&n<8&&s>=0&&s<8?B([n,s]):void 0}function jt(e){return"white"===e.orientation}const Bt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",It={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Rt={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function _t(e){"start"===e&&(e=Bt);const t=new Map;let o=7,n=0;for(const s of e)switch(s){case" ":return t;case"/":if(--o,o<0)return t;n=0;break;case"~":{const e=t.get(B([n,o]));e&&(e.promoted=!0);break}default:{const e=s.charCodeAt(0);if(e<57)n+=e-48;else{const e=s.toLowerCase();t.set(B([n,o]),{role:It[e],color:s===e?"black":"white"}),++n}}}return t}function zt(e,t){var o,n;if((null===(o=t.movable)||void 0===o?void 0:o.dests)&&(e.movable.dests=void 0),(null===(n=t.drawable)||void 0===n?void 0:n.autoShapes)&&(e.drawable.autoShapes=[]),qt(e,t),t.fen&&(e.pieces=_t(t.fen),e.drawable.shapes=[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[o,n]of e.pieces)"king"===n.role&&n.color===t&&(e.check=o)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&St(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",o="e"+t,n=e.movable.dests.get(o),s=e.pieces.get(o);if(!n||!s||"king"!==s.role)return;e.movable.dests.set(o,n.filter((e=>!(e==="a"+t&&n.includes("c"+t)||e==="h"+t&&n.includes("g"+t)))))}}function qt(e,t){for(const o in t)Ft(e[o])&&Ft(t[o])?qt(e[o],t[o]):e[o]=t[o]}function Ft(e){return"object"==typeof e}function Ht(e,t){return t.animation.enabled?function(e,t){const o=new Map(t.pieces),n=e(t),s=function(e,t){const o=new Map,n=[],s=new Map,r=[],i=[],a=new Map;let c,l,d;for(const[t,o]of e)a.set(t,Kt(t,o));for(const e of j)c=t.pieces.get(e),l=a.get(e),c?l?F(c,l.piece)||(r.push(l),i.push(Kt(e,c))):i.push(Kt(e,c)):l&&r.push(l);for(const e of i)l=Ut(e,r.filter((t=>F(e.piece,t.piece)))),l&&(d=[l.pos[0]-e.pos[0],l.pos[1]-e.pos[1]],o.set(e.key,d.concat(d)),n.push(l.key));for(const e of r)n.includes(e.key)||s.set(e.key,e.piece);return{anims:o,fadings:s}}(o,t);if(s.anims.size||s.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:s},e||Wt(t,performance.now())}else t.dom.redraw();return n}(e,t):Gt(e,t)}function Gt(e,t){const o=e(t);return t.dom.redraw(),o}function Kt(e,t){return{key:e,pos:I(e),piece:t}}function Ut(e,t){return t.sort(((t,o)=>q(e.pos,t.pos)-q(e.pos,o.pos)))[0]}function Wt(e,t){const o=e.animation.current;if(void 0===o)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(t-o.start)*o.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=(s=n)<.5?4*s*s*s:(s-1)*(2*s-2)*(2*s-2)+1;for(const e of o.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>Wt(e,t)))}var s}const Yt=["green","red","blue","yellow"];function Vt(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?Pt(e):At(e);const o=V(t),n=Nt(o,jt(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:o,brush:eo(t),snapToValidMove:e.drawable.defaultSnapToValidMove},Xt(e))}function Xt(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const o=Nt(t.pos,jt(e),e.dom.bounds());o||(t.snapToValidMove=!1);const n=t.snapToValidMove?function(e,t,o,n){const s=I(e),r=R.filter((e=>ft(s[0],s[1],e[0],e[1])||ht(s[0],s[1],e[0],e[1]))),i=r.map((e=>Q(B(e),o,n))).map((e=>q(t,e))),[,a]=i.reduce(((e,t,o)=>e[0]<t?e:[t,o]),[i[0],0]);return B(r[a])}(t.orig,t.pos,jt(e),e.dom.bounds()):o;n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),Xt(e)}}))}function Jt(e,t){e.drawable.current&&(e.drawable.current.pos=V(t))}function Qt(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const o=e=>e.orig===t.orig&&e.dest===t.dest,n=e.shapes.find(o);n&&(e.shapes=e.shapes.filter((e=>!o(e))));n&&n.brush===t.brush||e.shapes.push(t);to(e)}(e.drawable,t),Zt(e))}function Zt(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function eo(e){var t;const o=(e.shiftKey||e.ctrlKey)&&X(e),n=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return Yt[(o?1:0)+(n?2:0)]}function to(e){e.onChange&&e.onChange(e.shapes)}function oo(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const o=e.dom.bounds(),n=V(t),s=Nt(n,jt(e),o);if(!s)return;const r=e.pieces.get(s),i=e.selected;var a;i||!e.drawable.enabled||!e.drawable.eraseOnClick&&r&&r.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),to(a.drawable)),!1===t.cancelable||t.touches&&e.movable.color&&!r&&!i&&!function(e,t){const o=jt(e),n=e.dom.bounds(),s=Math.pow(n.width/8,2);for(const r in e.pieces){const e=Q(r,o,n);if(q(e,t)<=s)return!0}return!1}(e,n)||t.preventDefault();const c=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Dt(e,e.selected,s)?Ht((e=>xt(e,s)),e):xt(e,s);const d=e.selected===s,u=lo(e,s);if(r&&u&&d&&function(e,t){const o=e.pieces.get(t);return!!o&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}(e,s)){e.draggable.current={orig:s,piece:r,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:i,originTarget:t.target},u.cgDragging=!0,u.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${r.color} ${r.role}`,U(a,G(o)(I(s),jt(e))),Y(a,!0)),so(e)}else c&&bt(e),l&&wt(e);e.dom.redraw()}function no(e,t,o,n){const s="a0";e.pieces.set(s,t),e.dom.redraw();const r=V(o);e.draggable.current={orig:s,piece:t,origPos:r,pos:r,started:!0,element:()=>lo(e,s),originTarget:o.target,newPiece:!0,force:!!n},so(e)}function so(e){requestAnimationFrame((()=>{var t;const o=e.draggable.current;if(!o)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(o.orig))&&(e.animation.current=void 0);const n=e.pieces.get(o.orig);if(n&&F(n,o.piece)){if(!o.started&&q(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if("function"==typeof o.element){const e=o.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),o.element=e}const t=e.dom.bounds();U(o.element,[o.pos[0]-t.left-t.width/16,o.pos[1]-t.top-t.height/16])}}else ao(e);so(e)}))}function ro(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=V(t))}function io(e,t){const o=e.draggable.current;if(!o)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&o.originTarget!==t.target&&!o.newPiece)return void(e.draggable.current=void 0);bt(e),wt(e);const n=Nt(V(t)||o.pos,jt(e),e.dom.bounds());n&&o.started&&o.orig!==n?o.newPiece?Mt(e,o.orig,n,o.force):(e.stats.ctrlKey=t.ctrlKey,Tt(e,o.orig,n)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!n&&(e.pieces.delete(o.orig),vt(e.events.change)),(o.orig!==o.previouslySelected||o.orig!==n&&n)&&e.selectable.enabled||Pt(e),co(e),e.draggable.current=void 0,e.dom.redraw()}function ao(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,Pt(e),co(e),e.dom.redraw())}function co(e){const t=e.dom.elements;t.ghost&&Y(t.ghost,!1)}function lo(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&"PIECE"===o.tagName)return o;o=o.nextSibling}}function uo(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function ho(e,t){function o(){!function(e){e.orientation=z(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&o(),(t.fen?Ht:Gt)((e=>zt(e,t)),e)},state:e,getFen:()=>{return t=e.pieces,N.map((e=>O.map((o=>{const n=t.get(o+e);if(n){const e=Rt[n.role];return"white"===n.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:o,setPieces(t){Ht((e=>function(e,t){for(const[o,n]of t)n?e.pieces.set(o,n):e.pieces.delete(o)}(e,t)),e)},selectSquare(t,o){t?Ht((e=>xt(e,t,o)),e):e.selected&&(Pt(e),e.dom.redraw())},move(t,o){Ht((e=>kt(e,t,o)),e)},newPiece(t,o){Ht((e=>yt(e,t,o)),e)},playPremove(){if(e.premovable.current){if(Ht(Ot,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const o=function(e,t){const o=e.predroppable.current;let n=!1;if(!o)return!1;t(o)&&yt(e,{role:o.role,color:e.movable.color},o.key)&&(vt(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),n=!0);return wt(e),n}(e,t);return e.dom.redraw(),o}return!1},cancelPremove(){Gt(bt,e)},cancelPredrop(){Gt(wt,e)},cancelMove(){Gt((e=>{At(e),ao(e)}),e)},stop(){Gt((e=>{$t(e),ao(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{uo(e,2),setTimeout((()=>uo(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){Gt((e=>e.drawable.autoShapes=t),e)},setShapes(t){Gt((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>Nt(t,jt(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,o,n){no(e,t,o,n)},destroy(){$t(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function po(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function mo(e,t,o){const n=e.drawable,s=n.current,r=s&&s.mouseSq?s:void 0,i=new Map,a=e.dom.bounds();for(const e of n.shapes.concat(n.autoShapes).concat(r?[r]:[]))e.dest&&i.set(e.dest,(i.get(e.dest)||0)+1);const c=n.shapes.concat(n.autoShapes).map((e=>({shape:e,current:!1,hash:go(e,i,!1,a)})));r&&c.push({shape:r,current:!0,hash:go(r,i,!0,a)});const l=c.map((e=>e.hash)).join(";");if(l===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=l;const d=t.querySelector("defs"),u=t.querySelector("g"),h=o.querySelector("g");!function(e,t,o){const n=new Map;let s;for(const o of t)o.shape.dest&&(s=e.brushes[o.shape.brush],o.shape.modifiers&&(s=To(s,o.shape.modifiers)),n.set(s.key,s));const r=new Set;let i=o.firstChild;for(;i;)r.add(i.getAttribute("cgKey")),i=i.nextSibling;for(const[e,t]of n.entries())r.has(e)||o.appendChild(ko(t))}(n,c,d),fo(e,c.filter((e=>!e.shape.customSvg)),n.brushes,i,u),fo(e,c.filter((e=>e.shape.customSvg)),n.brushes,i,h)}function fo(e,t,o,n,s){const r=e.dom.bounds(),i=new Map,a=[];for(const e of t)i.set(e.hash,!1);let c,l=s.firstChild;for(;l;)c=l.getAttribute("cgHash"),i.has(c)?i.set(c,!0):a.push(l),l=l.nextSibling;for(const e of a)s.removeChild(e);for(const a of t)i.get(a.hash)||s.appendChild(wo(e,a,o,n,r))}function go({orig:e,dest:t,brush:o,piece:n,modifiers:s,customSvg:r},i,a,c){return[c.width,c.height,a,e,t,o,t&&(i.get(t)||0)>1,n&&vo(n),s&&(l=s,""+(l.lineWidth||"")),r&&bo(r)].filter((e=>e)).join(",");var l}function vo(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function bo(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return"custom-"+t.toString()}function wo(e,{shape:t,current:o,hash:n},s,r,i){let a;if(t.customSvg){const o=Co(I(t.orig),e.orientation);a=function(e,t,o){const{width:n,height:s}=o,r=n/8,i=s/8,a=t[0]*r,c=(7-t[1])*i,l=yo(po("g"),{transform:`translate(${a},${c})`}),d=yo(po("svg"),{width:r,height:i,viewBox:"0 0 100 100"});return l.appendChild(d),d.innerHTML=e,l}(t.customSvg,o,i)}else if(t.piece)a=function(e,t,o,n){const s=So(t,n),r=n.width/8*(o.scale||1),i=o.color[0]+("knight"===o.role?"n":o.role[0]).toUpperCase();return yo(po("image"),{className:`${o.role} ${o.color}`,x:s[0]-r/2,y:s[1]-r/2,width:r,height:r,href:e+i+".svg"})}(e.drawable.pieces.baseUrl,Co(I(t.orig),e.orientation),t.piece,i);else{const n=Co(I(t.orig),e.orientation);if(t.dest){let c=s[t.brush];t.modifiers&&(c=To(c,t.modifiers)),a=function(e,t,o,n,s,r){const i=function(e,t){return(t?20:10)/512*e.width}(r,s&&!n),a=So(t,r),c=So(o,r),l=c[0]-a[0],d=c[1]-a[1],u=Math.atan2(d,l),h=Math.cos(u)*i,p=Math.sin(u)*i;return yo(po("line"),{stroke:e.color,"stroke-width":Mo(e,n,r),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:xo(e,n),x1:a[0],y1:a[1],x2:c[0]-h,y2:c[1]-p})}(c,n,Co(I(t.dest),e.orientation),o,(r.get(t.dest)||0)>1,i)}else a=function(e,t,o,n){const s=So(t,n),r=function(e){const t=e.width/512;return[3*t,4*t]}(n),i=(n.width+n.height)/32;return yo(po("circle"),{stroke:e.color,"stroke-width":r[o?0:1],fill:"none",opacity:xo(e,o),cx:s[0],cy:s[1],r:i-r[1]/2})}(s[t.brush],n,o,i)}return a.setAttribute("cgHash",n),a}function ko(e){const t=yo(po("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(yo(po("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function yo(e,t){for(const o in t)e.setAttribute(o,t[o]);return e}function Co(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function To(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function Mo(e,t,o){return(e.lineWidth||10)*(t?.85:1)/512*o.width}function xo(e,t){return(e.opacity||1)*(t?.9:1)}function So(e,t){return[(e[0]+.5)*t.width/8,(7.5-e[1])*t.height/8]}function Po(e,t){const o=J("coords",t);let n;for(const t of e)n=J("coord"),n.textContent=t,o.appendChild(n);return o}function Lo(e,t){const o=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(o)}if(e.viewOnly)return;const n=function(e){return t=>{e.draggable.current?ao(e):e.drawable.current?Zt(e):t.shiftKey||X(t)?e.drawable.enabled&&Vt(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;bt(e),wt(e);const o=e.dropmode.piece;if(o){e.pieces.set("a0",o);const n=V(t),s=n&&Nt(n,jt(e),e.dom.bounds());s&&Mt(e,"a0",s)}e.dom.redraw()}(e,t):oo(e,t))}}(e);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("mousedown",n,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function Do(e,t,o,n){return e.addEventListener(t,o,n),()=>e.removeEventListener(t,o,n)}function Eo(e,t,o){return n=>{e.drawable.current?e.drawable.enabled&&o(e,n):e.viewOnly||t(e,n)}}function Oo(e){const t=jt(e),o=e.dom.relative?K:G(e.dom.bounds()),n=e.dom.relative?W:U,s=e.dom.elements.board,r=e.pieces,i=e.animation.current,a=i?i.plan.anims:new Map,c=i?i.plan.fadings:new Map,l=e.draggable.current,d=function(e){var t;const o=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)Io(o,t,"last-move");e.check&&e.highlight.check&&Io(o,e.check,"check");if(e.selected&&(Io(o,e.selected,"selected"),e.movable.showDests)){const n=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(n)for(const t of n)Io(o,t,"move-dest"+(e.pieces.has(t)?" oc":""));const s=e.premovable.dests;if(s)for(const t of s)Io(o,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const n=e.premovable.current;if(n)for(const e of n)Io(o,e,"current-premove");else e.predroppable.current&&Io(o,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const e of s.keys)Io(o,e,"exploding"+s.stage);return o}(e),u=new Set,h=new Set,p=new Map,m=new Map;let f,g,v,b,w,k,y,C,T,M;for(g=s.firstChild;g;){if(f=g.cgKey,Ao(g))if(v=r.get(f),w=a.get(f),k=c.get(f),b=g.cgPiece,!g.cgDragging||l&&l.orig===f||(g.classList.remove("dragging"),n(g,o(I(f),t)),g.cgDragging=!1),!k&&g.cgFading&&(g.cgFading=!1,g.classList.remove("fading")),v){if(w&&g.cgAnimating&&b===Bo(v)){const e=I(f);e[0]+=w[2],e[1]+=w[3],g.classList.add("anim"),n(g,o(e,t))}else g.cgAnimating&&(g.cgAnimating=!1,g.classList.remove("anim"),n(g,o(I(f),t)),e.addPieceZIndex&&(g.style.zIndex=jo(I(f),t)));b!==Bo(v)||k&&g.cgFading?k&&b===Bo(k)?(g.classList.add("fading"),g.cgFading=!0):Ro(p,b,g):u.add(f)}else Ro(p,b,g);else if($o(g)){const e=g.className;d.get(f)===e?h.add(f):Ro(m,e,g)}g=g.nextSibling}for(const[e,r]of d)if(!h.has(e)){T=m.get(r),M=T&&T.pop();const i=o(I(e),t);if(M)M.cgKey=e,n(M,i);else{const t=J("square",r);t.cgKey=e,n(t,i),s.insertBefore(t,s.firstChild)}}for(const[i,c]of r)if(w=a.get(i),!u.has(i))if(y=p.get(Bo(c)),C=y&&y.pop(),C){C.cgKey=i,C.cgFading&&(C.classList.remove("fading"),C.cgFading=!1);const s=I(i);e.addPieceZIndex&&(C.style.zIndex=jo(s,t)),w&&(C.cgAnimating=!0,C.classList.add("anim"),s[0]+=w[2],s[1]+=w[3]),n(C,o(s,t))}else{const r=Bo(c),a=J("piece",r),l=I(i);a.cgPiece=r,a.cgKey=i,w&&(a.cgAnimating=!0,l[0]+=w[2],l[1]+=w[3]),n(a,o(l,t)),e.addPieceZIndex&&(a.style.zIndex=jo(l,t)),s.appendChild(a)}for(const t of p.values())No(e,t);for(const t of m.values())No(e,t)}function Ao(e){return"PIECE"===e.tagName}function $o(e){return"SQUARE"===e.tagName}function No(e,t){for(const o of t)e.dom.elements.board.removeChild(o)}function jo(e,t){let o=2+8*e[1]+(7-e[0]);return t&&(o=67-o),o+""}function Bo(e){return`${e.color} ${e.role}`}function Io(e,t,o){const n=e.get(t);n?e.set(t,`${n} ${o}`):e.set(t,o)}function Ro(e,t,o){const n=e.get(t);n?n.push(o):e.set(t,[o])}function _o(e,t){const o={pieces:_t(Bt),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:_()};function n(){const t="dom"in o?o.dom.unbind:void 0,n=o.viewOnly&&!o.drawable.visible,s=function(e,t,o){e.innerHTML="",e.classList.add("cg-wrap");for(const o of E)e.classList.toggle("orientation-"+o,t.orientation===o);e.classList.toggle("manipulable",!t.viewOnly);const n=J("cg-helper");e.appendChild(n);const s=J("cg-container");n.appendChild(s);const r=J("cg-board");let i,a,c;if(s.appendChild(r),t.drawable.visible&&!o&&(i=yo(po("svg"),{class:"cg-shapes"}),i.appendChild(po("defs")),i.appendChild(po("g")),a=yo(po("svg"),{class:"cg-custom-svgs"}),a.appendChild(po("g")),s.appendChild(i),s.appendChild(a)),t.coordinates){const e="black"===t.orientation?" black":"";s.appendChild(Po(A,"ranks"+e)),s.appendChild(Po(O,"files"+e))}return t.draggable.showGhost&&!o&&(c=J("piece","ghost"),Y(c,!1),s.appendChild(c)),{board:r,container:s,ghost:c,svg:i,customSvg:a}}(e,o,n),r=function(e){let t;const o=()=>(void 0===t&&(t=e()),t);return o.clear=()=>{t=void 0},o}((()=>s.board.getBoundingClientRect())),i=e=>{Oo(c),!e&&s.svg&&mo(c,s.svg,s.customSvg)},a=()=>{r.clear(),function(e){if(e.dom.relative)return;const t=jt(e),o=G(e.dom.bounds());let n=e.dom.elements.board.firstChild;for(;n;)(Ao(n)&&!n.cgAnimating||$o(n))&&U(n,o(I(n.cgKey),t)),n=n.nextSibling}(c),s.svg&&mo(c,s.svg,s.customSvg)},c=o;return c.dom={elements:s,bounds:r,redraw:zo(i),redrawNow:i,unbind:t,relative:n},c.drawable.prevSvgHash="",i(!1),Lo(c,a),t||(c.dom.unbind=function(e,t){const o=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||o.push(Do(document.body,"chessground.resize",t)),!e.viewOnly){const t=Eo(e,ro,Jt),n=Eo(e,io,Qt);for(const e of["touchmove","mousemove"])o.push(Do(document,e,t));for(const e of["touchend","mouseup"])o.push(Do(document,e,n));const s=()=>e.dom.bounds.clear();o.push(Do(document,"scroll",s,{capture:!0,passive:!0})),o.push(Do(window,"resize",s,{passive:!0}))}return()=>o.forEach((e=>e()))}(c,a)),c.events.insert&&c.events.insert(s),c}return zt(o,t||{}),ho(n(),n)}function zo(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}function qo(e){var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0}function Fo(e){const t=e.data,o=e.makeCgHooks(),n=Ge(t,e.ply),s=e.isPlaying();return{fen:n.fen,orientation:Go(t,e.flip),turnColor:n.ply%2==0?"white":"black",lastMove:te(n.uci),check:!!n.check,coordinates:0!==t.pref.coords,addPieceZIndex:e.data.pref.is3d,highlight:{lastMove:t.pref.highlight,check:t.pref.highlight},events:{move:o.onMove,dropNewPiece:o.onNewPiece,insert(o){!function(e,t,o,n){if(0===t)return;const s=document.createElement("cg-resize");e.container.appendChild(s);const r=e=>{e.preventDefault();const t="touchstart"===e.type?"touchmove":"mousemove",o="touchstart"===e.type?"touchend":"mouseup",n=qo(e),s=parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"));let r=s;const i=he((()=>P(`/pref/zoom?v=${100+r}`,{method:"post"})),700),a=e=>{const t=qo(e),o=t[0]-n[0]+t[1]-n[1];r=Math.round(Math.min(100,Math.max(0,s+o/10))),document.body.setAttribute("style","--zoom:"+r),window.dispatchEvent(new Event("resize")),i()};document.body.classList.add("resizing"),document.addEventListener(t,a),document.addEventListener(o,(()=>{document.removeEventListener(t,a),document.body.classList.remove("resizing")}),{once:!0})};if(s.addEventListener("touchstart",r,{passive:!1}),s.addEventListener("mousedown",r,{passive:!1}),1===t){const e=e=>s.classList.toggle("none",n?!n(e):e>=2);e(o),lichess.pubsub.on("ply",e)}}(o,e.data.pref.resizeHandle,e.ply),1===t.pref.coords&&(()=>{const e={blue:"#DEE3E6 #788a94",blue2:"#97b2c7 #546f82",blue3:"#d9e0e6 #315991",canvas:"#d7daeb #547388",wood:"#d8a45b #9b4d0f",wood2:"#a38b5d #6c5017",wood3:"#d0ceca #755839",wood4:"#caaf7d #7b5330",maple:"#e8ceab #bc7944",maple2:"#E2C89F #996633",leather:"#d1d1c9 #c28e16",green:"#FFFFDD #6d8753",brown:"#F0D9B5 #946f51",pink:"#E8E9B7 #ED7272",marble:"#93ab91 #4f644e","blue-marble":"#EAE6DD #7C7F87","green-plastic":"#f2f9bb #59935d",grey:"#b8b8b8 #7d7d7d",metal:"#c9c9c9 #727272",olive:"#b8b19f #6d6655",newspaper:"#fff #8d8d8d",purple:"#9f90b0 #7d4a8d","purple-diag":"#E5DAF0 #957AB0",ic:"#ececec #c1c18e",horsey:"#F0D9B5 #946f51"};for(const t of document.body.className.split(" "))if(t in e){const o=document.documentElement.style,n=e[t].split(" ");o.setProperty("--cg-coord-color-white",n[0]),o.setProperty("--cg-coord-color-black",n[1]),o.setProperty("--cg-coord-shadow","none")}})()}},movable:{free:!1,color:s?t.player.color:void 0,dests:s?se(t.possibleMoves):new Map,showDests:t.pref.destination,rookCastle:t.pref.rookCastle,events:{after:o.onUserMove,afterNewPiece:o.onUserNewPiece}},animation:{enabled:!0,duration:t.pref.animationDuration},premovable:{enabled:t.pref.enablePremove,showDests:t.pref.destination,castle:"antichess"!==t.game.variant.key,events:{set:o.onPremove,unset:o.onCancelPremove}},predroppable:{enabled:t.pref.enablePremove&&"crazyhouse"===t.game.variant.key,events:{set:o.onPredrop,unset(){o.onPredrop(void 0)}}},draggable:{enabled:0!==t.pref.moveEvent,showGhost:t.pref.highlight},selectable:{enabled:1!==t.pref.moveEvent},drawable:{enabled:!0,defaultSnapToValidMove:"0"!=(lichess.storage.get("arrow.snap")||1)},disableContextMenu:!0}}function Ho(e,t,o){const n=e.state.pieces.get(t);n&&"pawn"===n.role&&e.setPieces(new Map([[t,{color:n.color,role:o,promoted:!0}]]))}function Go(e,t){return"racingKings"===e.game.variant.key?t?"black":"white":t?e.opponent.color:e.player.color}function Ko(e){return p("div.cg-wrap",{hook:oe((t=>e.setChessground(_o(t,Fo(e)))))})}let Uo=[],Wo=!1;function Yo(e){const t=lichess.storage.make("just-notified");if(document.hasFocus()||Date.now()-parseInt(t.get(),10)<1e3)return;t.set(""+Date.now()),$.isFunction(e)&&(e=e());const o=new Notification("lichess.org",{icon:lichess.assetUrl("logo/lichess-favicon-256.png",{noVersion:!0}),body:e});o.onclick=()=>window.focus(),Uo.push(o),Wo||(Wo=!0,window.addEventListener("focus",(()=>{Uo.forEach((e=>e.close())),Uo=[]})))}function Vo(e){!document.hasFocus()&&"Notification"in window&&"granted"===Notification.permission&&setTimeout(Yo,10+500*Math.random(),e)}function Xo(e,t){let o,n=0;return function(...s){const r=this,i=performance.now()-n;function a(){o=void 0,n=performance.now(),t.apply(r,s)}o&&clearTimeout(o),i>e?a():o=setTimeout(a,e-i)}}function Jo(e,t,o){Jo.close();const n=$('<div id="modal-wrap"><span class="close" data-icon="L"></span></div>'),s=$(`<div id="modal-overlay" class="${t}">`).on("click",Jo.close);return n.appendTo(s),e.clone().removeClass("none").appendTo(n),Jo.onClose=o,n.find(".close").on("click",Jo.close),n.on("click",(e=>e.stopPropagation())),$("body").addClass("overlayed").prepend(s),n}Jo.close=()=>{$("body").removeClass("overlayed"),$("#modal-overlay").each((function(){Jo.onClose&&Jo.onClose(),$(this).remove()})),delete Jo.onClose},Jo.onClose=void 0;const Qo=e=>S(e.data.url.round),Zo=Xo(1e3,(e=>P("/pref/zen",{method:"post",body:D({zen:e?1:0})}))),en=e=>Xo(100,(()=>lichess.sound.play(e))),tn=en("move"),on=en("capture"),nn=en("check"),sn=en("explosion");function rn(e,t,o){let n,s=0;return function(...r){const i=this,a=performance.now()-s;function c(){n=void 0,s=performance.now(),e*=t,o.apply(i,r)}n&&clearTimeout(n),a>e?c():n=setTimeout(c,e-a)}}const an=document.title;let cn=0;const ln=["/assets/logo/lichess-favicon-32.png","/assets/logo/lichess-favicon-32-invert.png"].map(((e,t)=>()=>{cn!==t&&(document.getElementById("favicon").href=e,cn=t)}));let dn,un,hn;function pn(){dn&&clearTimeout(dn),dn=void 0,ln[0]()}function mn(e,t){e.data.player.spectator||(t||(Xe(e.data)||Ve(e.data)?t=e.noarg("gameOver"):et(e.data)?(t=e.noarg("yourTurn"),document.hasFocus()||dn||(dn=setTimeout((function e(){document.hasFocus()||(ln[1-cn](),dn=setTimeout(e,1e3))}),200))):(t=e.noarg("waitingForOpponent"),pn())),document.title=`${t} - ${an}`)}function fn(e,t,o,n,s){return Ho(e.chessground,o,n),e.sendMove(t,o,n,s),!0}function gn(e,t,o,n={}){var s;const r=e.data,i=e.chessground.state.pieces.get(o),a=e.chessground.state.pieces.get(t);return!(!(i&&"pawn"===i.role&&!a||a&&"pawn"===a.role)||!("8"===o[1]&&"white"===r.player.color||"1"===o[1]&&"black"===r.player.color))&&(hn&&n&&n.premove?fn(e,t,o,hn,n):n.ctrlKey||un||!(3===r.pref.autoQueen||2===r.pref.autoQueen&&a||(null===(s=e.keyboardMove)||void 0===s?void 0:s.justSelected()))?(un={move:[t,o],pre:!!a,meta:n},e.redraw(),!0):(a?vn(e,o,"queen"):fn(e,t,o,"queen",n),!0))}function vn(e,t,o){hn=o,e.chessground.setAutoShapes([{orig:t,piece:{color:e.data.player.color,role:o,opacity:.8},brush:""}])}function bn(e){hn&&(e.chessground.setAutoShapes([]),hn=void 0,e.redraw())}function wn(e){bn(e),e.chessground.cancelPremove(),un&&Qo(e).then(e.reload,lichess.reload),un=void 0}function kn(e,t,o,n,s){let r=12.5*(7-I(t)[0]);"white"===s&&(r=87.5-r);return p("div#promotion-choice."+(n===s?"top":"bottom"),{hook:oe((t=>{t.addEventListener("click",(()=>wn(e))),t.addEventListener("contextmenu",(e=>(e.preventDefault(),!1)))}))},o.map(((t,o)=>p("square",{attrs:{style:`top:${12.5*(n===s?o:7-o)}%;left:${r}%`},hook:ne("click",(o=>{o.stopPropagation(),function(e,t){if(un){const o=un;un=void 0,o.pre?vn(e,o.move[1],t):fn(e,o.move[0],o.move[1],t,o.meta),e.redraw()}}(e,t)}))},[p(`piece.${t}.${n}`)]))))}const yn=["queen","knight","rook","bishop"];function Cn(e){if(un)return kn(e,un.move[1],"antichess"===e.data.game.variant.key?yn.concat("king"):yn,e.data.player.color,e.chessground.state.orientation)}let Tn=0,Mn=0;function xn(){return Tn>=Mn}function Sn(e){const t=e.trans.noarg,o=e.data;switch(o.game.status.name){case"started":return t("playingRightNow");case"aborted":return t("gameAborted");case"mate":return t("checkmate");case"resign":return t("white"==o.game.winner?"blackResigned":"whiteResigned");case"stalemate":return t("stalemate");case"timeout":switch(o.game.winner){case"white":return t("blackLeftTheGame");case"black":return t("whiteLeftTheGame")}return t("draw");case"draw":return t("draw");case"outoftime":return`${o.game.turns%2==0?t("whiteTimeOut"):t("blackTimeOut")}${o.game.winner?"":` • ${t("draw")}`}`;case"noStart":return("white"==o.game.winner?"Black":"White")+" didn't move";case"cheat":return t("cheatDetected");case"variantEnd":switch(o.game.variant.key){case"kingOfTheHill":return t("kingInTheCenter");case"threeCheck":return t("threeChecks")}return t("variantEnding");case"unknownFinish":return"Finished";default:return o.game.status.name}}const Pn=e=>t=>{!window.LichessSpeech&&t?lichess.loadModule("speech").then((()=>Ln(e))):window.LichessSpeech&&!t&&(window.LichessSpeech=void 0)},Ln=e=>{if("started"===e.data.game.status.name)window.LichessSpeech.step(e.stepAt(e.ply),!1);else{const t=Sn(e);lichess.sound.say(t,!1,!1,!0);const o=e.data.game.winner;o&&lichess.sound.say(e.noarg(o+"IsVictorious"),!1,!1,!0)}},Dn=e=>window.LichessSpeech&&e(window.LichessSpeech);function En(e,t,o){return(o?"/embed/":"/")+(e.game?e.game.id:e)+(t?"/"+t:"")}function On(e){const t=e.data,o=En(t,"racingKings"===(n=t).game.variant.key?"white":n.player.color)+"#"+e.ply;var n;return(e=>it(e)||Ve(e)||Xe(e)&&ot(e))(t)?p("a.fbt",{attrs:{href:o},hook:ne("click",(e=>{location.pathname===o.split("#")[0]&&location.reload()}))},e.noarg("analysis")):null}function An(e,t,o,n,s,r){const i=()=>!t||t(e.data);return p("button.fbt."+s,{attrs:{disabled:!i(),title:e.noarg(n)},hook:ne("click",(t=>{i()&&(r?r():e.socket.sendLoading(s))}))},[p("span","offerDraw"==n?["½"]:e.nvui?[e.noarg(n)]:ee(o))])}function $n(e){const t=e.opponentGone();return!0===t?p("div.suggestion",[p("p",{hook:Vn},e.noarg("opponentLeftChoices")),p("button.button",{hook:ne("click",(()=>e.socket.sendLoading("resign-force")))},e.noarg("forceResignation")),p("button.button",{hook:ne("click",(()=>e.socket.sendLoading("draw-force")))},e.noarg("forceDraw"))]):t?p("div.suggestion",[p("p",e.trans.vdomPlural("opponentLeftCounter",t,p("strong",""+t)))]):null}const Nn=(e,t)=>p("button.fbt.no",{attrs:{title:e.noarg("cancel"),"data-icon":"L"},hook:ne("click",(()=>t(!1)))}),jn=e=>p("div.act-confirm",[p("button.fbt.yes",{attrs:{title:e.noarg("resign"),"data-icon":"b"},hook:ne("click",(()=>e.resign(!0)))}),Nn(e,e.resign)]),Bn=e=>p("div.act-confirm",[p("button.fbt.yes.draw-yes",{attrs:{title:e.noarg("offerDraw")},hook:ne("click",(()=>e.offerDraw(!0)))},p("span","½")),Nn(e,e.offerDraw)]);function In(e){return e.data.game.threefold?p("div.suggestion",[p("p",{hook:Vn},e.noarg("threefoldRepetition")),p("button.button",{hook:ne("click",(()=>e.socket.sendLoading("draw-claim")))},e.noarg("claimADraw"))]):null}function Rn(e){return e.data.player.offeringDraw?p("div.pending",[p("p",e.noarg("drawOfferSent"))]):null}function _n(e){return e.data.opponent.offeringDraw?p("div.negotiation.draw",[Fn(e,(()=>e.socket.sendLoading("draw-no"))),p("p",e.noarg("yourOpponentOffersADraw")),qn(e,"draw-yes",(()=>e.socket.sendLoading("draw-yes")))]):null}function zn(e){return e.data.player.proposingTakeback?p("div.pending",[p("p",e.noarg("takebackPropositionSent")),p("button.button",{hook:ne("click",(()=>e.socket.sendLoading("takeback-no")))},e.noarg("cancel"))]):null}function qn(e,t,o,n="accept"){const s=e.noarg(n);return e.nvui?p("button."+t,{hook:ne("click",o)},s):p("a.accept",{attrs:{"data-icon":"E",title:s},hook:ne("click",o)})}function Fn(e,t,o="decline"){const n=e.noarg(o);return e.nvui?p("button",{hook:ne("click",t)},n):p("a.decline",{attrs:{"data-icon":"L",title:n},hook:ne("click",t)})}function Hn(e){return e.data.opponent.proposingTakeback?p("div.negotiation.takeback",[Fn(e,(()=>e.socket.sendLoading("takeback-no"))),p("p",e.noarg("yourOpponentProposesATakeback")),qn(e,"takeback-yes",e.takebackYes)]):null}function Gn(e){var t;const o=e.data;return(null===(t=o.tournament)||void 0===t?void 0:t.running)?p("div.follow-up",[p("a.text.fbt.strong.glowing",{attrs:{"data-icon":"G",href:"/tournament/"+o.tournament.id},hook:ne("click",e.setRedirecting)},e.noarg("backToTournament")),p("form",{attrs:{method:"post",action:"/tournament/"+o.tournament.id+"/withdraw"}},[p("button.text.fbt.weak",ee("Z"),"Pause")]),On(e)]):void 0}function Kn(e){var t;const o=e.data;return(null===(t=o.swiss)||void 0===t?void 0:t.running)?p("div.follow-up",[p("a.text.fbt.strong.glowing",{attrs:{"data-icon":"G",href:"/swiss/"+o.swiss.id},hook:ne("click",e.setRedirecting)},e.noarg("backToTournament")),On(e)]):void 0}function Un(e){return t=e.data,Ze(t)&&t.moretimeable&&(t.clock||t.correspondence&&t.correspondence[t.opponent.color]<t.correspondence.increment-3600)?p("a.moretime",{attrs:{title:e.data.clock?e.trans("giveNbSeconds",e.data.clock.moretime):e.noarg("giveMoreTime"),"data-icon":"O"},hook:ne("click",e.socket.moreTime)}):null;var t}function Wn(e){const t=e.data,o=!t.game.rematch&&(Ve(t)||Xe(t))&&!t.tournament&&!t.simul&&!t.swiss&&!t.game.boosted,n=(Ve(t)||Xe(t))&&("lobby"===t.game.source||"pool"===t.game.source),s=e.challengeRematched?[p("div.suggestion.text",{hook:Vn},e.noarg("rematchOfferSent"))]:o||t.game.rematch?function(e){const t=e.data,o=!!t.player.offeringRematch,n=!!t.opponent.offeringRematch,s=e.noarg;return[n?p("button.rematch-decline",{attrs:{"data-icon":"L",title:s("decline")},hook:ne("click",(()=>e.socket.send("rematch-no")))},e.nvui?s("decline"):""):null,p("button.fbt.rematch.white",{class:{me:o,glowing:n,disabled:!o&&!(t.opponent.onGame||!t.clock&&t.player.user&&t.opponent.user)},attrs:{title:n?s("yourOpponentWantsToPlayANewGameWithYou"):o?s("rematchOfferSent"):""},hook:ne("click",(t=>{const o=e.data;o.game.rematch?location.href=En(o.game.rematch,o.opponent.color):o.player.offeringRematch?(o.player.offeringRematch=!1,e.socket.send("rematch-no")):o.opponent.onGame?(o.player.offeringRematch=!0,e.socket.send("rematch-yes")):t.currentTarget.classList.contains("disabled")||e.challengeRematch()}),e.redraw)},[o?p("div.spinner",{"aria-label":"loading"},[p("svg",{attrs:{viewBox:"0 0 40 40"}},[p("circle",{attrs:{cx:20,cy:20,r:18,fill:"none"}})])]):p("span",s("rematch"))])]}(e):[];return p("div.follow-up",[...s,t.tournament?p("a.fbt",{attrs:{href:"/tournament/"+t.tournament.id}},e.noarg("viewTournament")):null,t.swiss?p("a.fbt",{attrs:{href:"/swiss/"+t.swiss.id}},e.noarg("viewTournament")):null,n?p("a.fbt",{attrs:{href:"pool"===t.game.source?(r=t.clock,i=t.opponent.user,"/#pool/"+r.initial/60+"+"+r.increment+(i?"/"+i.id:"")):"/?hook_like="+t.game.id}},e.noarg("newOpponent")):null,On(e)]);var r,i}function Yn(e){const t=e.data,o=[t.game.rematch?p("a.fbt.text",{attrs:{href:`/${t.game.rematch}/${t.opponent.color}`}},e.noarg("viewRematch")):null,t.tournament?p("a.fbt",{attrs:{href:"/tournament/"+t.tournament.id}},e.noarg("viewTournament")):null,t.swiss?p("a.fbt",{attrs:{href:"/swiss/"+t.swiss.id}},e.noarg("viewTournament")):null,On(e)];return o.find((e=>!!e))?p("div.follow-up",o):null}const Vn=oe((e=>lichess.pubsub.emit("round.suggestion",e.textContent)));const Xn=e=>(e<10?"0":"")+e,Jn="<sep>:</sep>";function Qn(e,t,o,n){const s=new Date(e);if(n)return(e>=36e5?Math.floor(e/36e5)+"H:":"")+s.getUTCMinutes()+"M:"+s.getUTCSeconds()+"S";const r=s.getUTCMilliseconds(),i=o&&r<500?'<sep class="low">:</sep>':Jn,a=Xn(s.getUTCMinutes())+i+Xn(s.getUTCSeconds());if(e>=36e5){return Xn(Math.floor(e/36e5))+Jn+a}if(t){let t=Math.floor(r/100).toString();return!o&&e<1e3&&(t+="<huns>"+Math.floor(r/10)%10+"</huns>"),a+"<tenths><sep>.</sep>"+t+"</tenths>"}return a}function Zn(e,t){const o=e.clock,n=e=>{if(void 0!==e.animate){let n=o.elements[t].barAnim;void 0!==n&&n.effect&&n.effect.target===e||(n=e.animate([{transform:"scale(1)"},{transform:"scale(0, 1)"}],{duration:o.barTime,fill:"both"}),o.elements[t].barAnim=n);const s=o.millisOf(t);n.currentTime=o.barTime-s,t===o.times.activeColor?s>0&&n.play():n.pause()}else o.elements[t].bar=e,e.style.transform="scale("+o.timeRatio(o.millisOf(t))+",1)"};return p("div.bar",{class:{berserk:!!e.goneBerserk[t]},hook:{insert:e=>n(e.elm),postpatch:(e,t)=>n(t.elm)}})}function es(e,t){return!!e.goneBerserk[t]&&e.data.game.turns<=1&&Qe(e.data)}function ts(e,t,o){return es(e,t)?p("div.berserked."+o,ee("`")):null}function os(e){var t;if((t=e.data).tournament&&t.tournament.berserkable&&Ze(t)&&!ot(t)&&!e.goneBerserk[e.data.player.color])return p("button.fbt.go-berserk",{attrs:{title:"GO BERSERK! Half the time, no increment, bonus point","data-icon":"`"},hook:ne("click",e.goBerserk)})}function ns(e,t,o){var n,s;const r=e.data,i=(null===(n=r.tournament)||void 0===n?void 0:n.ranks)||(null===(s=r.swiss)||void 0===s?void 0:s.ranks);return i&&!es(e,t)?p("div.tour-rank."+o,{attrs:{title:"Current tournament rank"}},"#"+i[t]):null}class ss{constructor(e,t){this.opts=t,this.emergSound={play:()=>lichess.sound.play("lowTime"),delay:2e4,playable:{white:!0,black:!0}},this.elements={white:{},black:{}},this.timeRatio=e=>Math.min(1,e*this.timeRatioDivisor),this.setClock=(e,t,o,n=0)=>{const s=Qe(e)&&(tt(e)>1||e.clock.running),r=10*n;this.times={white:1e3*t,black:1e3*o,activeColor:s?e.game.player:void 0,lastUpdate:performance.now()+r},s&&this.scheduleTick(this.times[e.game.player],r)},this.addTime=(e,t)=>{this.times[e]+=10*t},this.stopClock=()=>{const e=this.times.activeColor;if(e){const t=this.elapsed();return this.times[e]=Math.max(0,this.times[e]-t),this.times.activeColor=void 0,t}},this.hardStopClock=()=>this.times.activeColor=void 0,this.scheduleTick=(e,t)=>{void 0!==this.tickCallback&&clearTimeout(this.tickCallback),this.tickCallback=setTimeout(this.tick,this.opts.nvui?1e3:e%(this.showTenths(e)?100:500)+1+t)},this.tick=()=>{this.tickCallback=void 0;const e=this.times.activeColor;if(void 0===e)return;const t=performance.now(),o=Math.max(0,this.times[e]-this.elapsed(t));this.scheduleTick(o,0),0===o?this.opts.onFlag():function(e,t,o){if(t.time&&(t.time.innerHTML=Qn(o,e.showTenths(o),!0,e.opts.nvui)),t.bar&&(t.bar.style.transform="scale("+e.timeRatio(o)+",1)"),t.clock){const n=t.clock.classList;o<e.emergMs?n.add("emerg"):n.contains("emerg")&&n.remove("emerg")}}(this,this.elements[e],o),this.opts.soundColor===e&&(this.emergSound.playable[e]?o<this.emergMs&&!(t<this.emergSound.next)&&(this.emergSound.play(),this.emergSound.next=t+this.emergSound.delay,this.emergSound.playable[e]=!1):o>1.5*this.emergMs&&(this.emergSound.playable[e]=!0))},this.elapsed=(e=performance.now())=>Math.max(0,e-this.times.lastUpdate),this.millisOf=e=>this.times.activeColor===e?Math.max(0,this.times[e]-this.elapsed()):this.times[e],this.isRunning=()=>void 0!==this.times.activeColor;const o=e.clock;if(0===o.showTenths)this.showTenths=()=>!1;else{const e=1===o.showTenths?1e4:36e5;this.showTenths=t=>t<e}this.showBar=o.showBar&&!this.opts.nvui,this.barTime=1e3*(Math.max(o.initial,2)+5*o.increment),this.timeRatioDivisor=1/this.barTime,this.emergMs=1e3*Math.min(60,Math.max(10,.125*o.initial)),this.setClock(e,o.white,o.black)}}class rs{constructor(e,t){this.ctrl=e,this.key=t,this.storage=lichess.storage.makeBoolean(this.key),this.toggle=()=>{this.storage.toggle(),this.next(!0)},this.get=this.storage.get,this.redirect=e=>{this.ctrl.setRedirecting(),window.location.href=e},this.next=e=>{const t=this.ctrl.data;var o;t.player.spectator||(o=t,ct(o)||!o.simul&&!(e=>"correspondence"===e.game.speed)(o))||et(t)||!this.get()||(e?this.redirect("/round-next/"+t.game.id):t.simul?t.simul.hostId===this.ctrl.opts.userId&&t.simul.nbPlaying>1&&this.redirect("/round-next/"+t.game.id):(e=>S(`/whats-next/${e.data.game.id}${e.data.player.id}`))(this.ctrl).then((e=>{e.next&&this.redirect("/"+e.next)})))}}}class is{constructor(e){this.socket=e,this.current=void 0,this.register=()=>{this.current=setTimeout(this.expire,1e4)},this.clear=()=>{this.current&&clearTimeout(this.current)},this.expire=()=>{P("/statlog?e=roundTransientExpire",{method:"post"}),this.socket.reload({})}}}const as=["pawn","knight","bishop","rook","queen"];let cs=!1,ls=!1,ds=!1;function us(e,t,o){if(0===hs.length?ls=!0:(cs=!0,ds||ms(e)),!et(e))return!1;if("pawn"===t&&("1"===o[1]||"8"===o[1]))return!1;const n=e.possibleDrops;if(null==n)return!0;return(n.match(/.{2}/g)||[]).includes(o)}const hs=[];function ps(e){const t=window.Mousetrap;let o;const n=()=>{if(o&&document.body.classList.remove(o),hs.length>0){const s=as[hs[hs.length-1]-1],r=e.data.player.color,i=e.data.crazyhouse;if(!i)return;const a=i.pockets["white"===r?0:1][s];t=e.chessground.state,n=a>0?{color:r,role:s}:void 0,t.dropmode={active:!0,piece:n},ao(t),o=`cursor-${r}-${s}`,document.body.classList.add(o)}else!function(e){e.dropmode={active:!1}}(e.chessground.state),o=void 0;var t,n};lichess.pubsub.on("ply",(()=>{hs.length>0&&n()}));for(let e=1;e<=5;e++){const o=e.toString();t.bind(o,(()=>{hs.includes(e)||(hs.push(e),n())})).bind(o,(()=>{const t=hs.indexOf(e);t>=0&&(hs.splice(t,1),t===hs.length&&n())}),"keyup")}const s=()=>{hs.length>0&&(hs.length=0,n())};window.addEventListener("blur",s),window.addEventListener("focus",(e=>{e.target&&"input"===e.target.localName&&s()}),{capture:!0}),"0"!==lichess.storage.get("crazyKeyHist")&&ms(e.data)}function ms(e){const t=e.player.color[0];for(const e of"PNBRQ")fetch(lichess.assetUrl(`piece/cburnett/${t}${e}.svg`));ds=!0}const fs={P:"pawn",N:"knight",B:"bishop",R:"rook",Q:"queen",K:"king"};function gs(e){return p("div.keyboard-move",[p("input",{attrs:{spellcheck:!1,autocomplete:!1},hook:oe((t=>lichess.loadModule("round.keyboardMove").then((()=>e.registerHandler(lichess.keyboardMove({input:t,ctrl:e}))))))}),e.hasFocus()?p("em","Enter SAN (Nc3) or UCI (b1c3) moves, or type / to focus chat"):p("strong","Press <enter> to focus")])}function vs(e,t){return e.trans("aiNameLevelAiLevel","Stockfish",t)}function bs(e,t){return t.user?(t.user.title?t.user.title+" ":"")+t.user.username:t.ai?vs(e,t.ai):e.noarg("anonymous")}let ws=!1;const ks=e=>e.split(" ")[0];const ys=e=>e.userJump(e.ply-1),Cs=e=>e.userJump(e.ply+1);class Ts{constructor(e,t){var o;this.opts=e,this.redraw=t,this.firstSeconds=!0,this.flip=!1,this.loading=!1,this.redirecting=!1,this.goneBerserk={},this.resignConfirm=void 0,this.drawConfirm=void 0,this.autoScroll=()=>{},this.challengeRematched=!1,this.shouldSendMoveTime=!1,this.sign=Math.random().toString(36),this.showExpiration=()=>{this.data.expiration&&(this.redraw(),setTimeout(this.showExpiration,250))},this.onUserMove=(e,t,o)=>{!this.keyboardMove||this.keyboardMove.usedSan,gn(this,e,t,o)||this.sendMove(e,t,void 0,o)},this.onUserNewPiece=(e,t,o)=>{!this.replaying()&&us(this.data,e,t)?this.sendNewPiece(e,t,!!o.predrop):this.jump(this.ply)},this.onMove=(e,t,o)=>{o||this.enpassant(e,t)?"atomic"===this.data.game.variant.key?(sn(),function(e,t){const o=[],n=new Map,s=I(t),r=Math.max(0,s[0]-1),i=Math.min(7,s[0]+1),a=Math.max(0,s[1]-1),c=Math.min(7,s[1]+1);for(let s=r;s<=i;s++)for(let r=a;r<=c;r++){const i=B([s,r]);o.push(i);const a=e.chessground.state.pieces.get(i);a&&(i===t||"pawn"!==a.role)&&n.set(i,void 0)}e.chessground.setPieces(n),e.chessground.explode(o)}(this,t)):on():tn()},this.onPremove=(e,t,o)=>{gn(this,e,t,o)},this.onCancelPremove=()=>{bn(this)},this.onPredrop=(e,t)=>{this.preDrop=e,this.redraw()},this.isSimulHost=()=>this.data.simul&&this.data.simul.hostId===this.opts.userId,this.enpassant=(e,t)=>{var o;if(e[0]===t[0]||"pawn"!==(null===(o=this.chessground.state.pieces.get(t))||void 0===o?void 0:o.role))return!1;const n=t[0]+e[1];return this.chessground.setPieces(new Map([[n,void 0]])),!0},this.lastPly=()=>Fe(this.data),this.makeCgHooks=()=>({onUserMove:this.onUserMove,onUserNewPiece:this.onUserNewPiece,onMove:this.onMove,onNewPiece:tn,onPremove:this.onPremove,onCancelPremove:this.onCancelPremove,onPredrop:this.onPredrop}),this.replaying=()=>this.ply!==this.lastPly(),this.userJump=e=>{this.cancelMove(),this.chessground.selectSquare(null),e!=this.ply&&this.jump(e)?((e,t)=>{Dn((o=>o.step(e.stepAt(t),!0)))})(this,this.ply):this.redraw()},this.isPlaying=()=>Ze(this.data),this.jump=e=>{const t=(e=Math.max(qe(this.data),Math.min(this.lastPly(),e)))===this.ply+1;this.ply=e,this.justDropped=void 0,this.preDrop=void 0;const o=this.stepAt(e),n={fen:o.fen,lastMove:te(o.uci),check:!!o.check,turnColor:this.ply%2==0?"white":"black"};return this.replaying()?this.chessground.stop():n.movable={color:this.isPlaying()?this.data.player.color:void 0,dests:se(this.data.possibleMoves)},this.chessground.set(n),o.san&&t&&(o.san.includes("x")?on():tn(),/[+#]/.test(o.san)&&nn()),this.autoScroll(),this.keyboardMove&&this.keyboardMove.update(o),lichess.pubsub.emit("ply",e),!0},this.replayEnabledByPref=()=>{const e=this.data;return 2===e.pref.replay||1===e.pref.replay&&("classical"===e.game.speed||"unlimited"===e.game.speed||"correspondence"===e.game.speed)},this.isLate=()=>this.replaying()&&Je(this.data),this.playerAt=e=>this.flip^"top"===e?this.data.opponent:this.data.player,this.flipNow=()=>{this.flip=!this.nvui&&!this.flip,this.chessground.set({orientation:Go(this.data,this.flip)}),this.redraw()},this.setTitle=()=>mn(this),this.actualSendMove=(e,t,o={})=>{const n={sign:this.sign,ackable:!0};if(this.clock)if(n.withLag=!this.shouldSendMoveTime||!this.clock.isRunning(),o.premove&&this.shouldSendMoveTime)this.clock.hardStopClock(),n.millis=0;else{const e=this.clock.stopClock();void 0!==e&&this.shouldSendMoveTime&&(n.millis=e)}this.socket.send(e,t,n),this.justDropped=o.justDropped,this.justCaptured=o.justCaptured,this.preDrop=void 0,this.transientMove.register(),this.redraw()},this.sendMove=(e,t,o,n)=>{const s={u:e+t};o&&(s.u+="knight"===o?"n":o[0]),xn()&&(s.b=1),this.resign(!1),this.data.pref.submitMove&&!n.premove?(this.moveToSubmit=s,this.redraw()):this.actualSendMove("move",s,{justCaptured:n.captured,premove:n.premove})},this.sendNewPiece=(e,t,o)=>{const n={role:e,pos:t};xn()&&(n.b=1),this.resign(!1),this.data.pref.submitMove&&!o?(this.dropToSubmit=n,this.redraw()):this.actualSendMove("drop",n,{justDropped:e,premove:o})},this.showYourMoveNotification=()=>{const e=this.data;et(e)?Vo((()=>{let t=this.noarg("yourTurn");const o=bs(this,e.opponent);if(this.ply<1)t=`${o}\njoined the game.\n${t}`;else{let n=e.steps[e.steps.length-1].san;n=`${Math.floor((this.ply-1)/2)+1}${this.ply%2==1?".":"..."} ${n}`,t=`${o}\nplayed ${n}.\n${t}`}return t})):this.isPlaying()&&this.ply<1&&Vo((()=>bs(this,e.opponent)+"\njoined the game."))},this.playerByColor=e=>this.data[e===this.data.player.color?"player":"opponent"],this.apiMove=e=>{var t,o;const n=this.data,s=this.isPlaying();n.game.turns=e.ply,n.game.player=e.ply%2==0?"white":"black";const r=e.ply%2==0?"black":"white",i=n.player.color===n.game.player;if(e.status&&(n.game.status=e.status),e.winner&&(n.game.winner=e.winner),this.playerByColor("white").offeringDraw=e.wDraw,this.playerByColor("black").offeringDraw=e.bDraw,n.possibleMoves=i?e.dests:void 0,n.possibleDrops=i?e.drops:void 0,n.crazyhouse=e.crazyhouse,this.setTitle(),!this.replaying()){if(this.ply++,e.role)this.chessground.newPiece({role:e.role,color:r},e.uci.substr(2,2));else{const n=te(e.uci),s=this.chessground.state.pieces;(!e.castle||"king"===(null===(t=s.get(e.castle.king[0]))||void 0===t?void 0:t.role)&&"rook"===(null===(o=s.get(e.castle.rook[0]))||void 0===o?void 0:o.role))&&this.chessground.move(n[0],n[1])}e.promotion&&Ho(this.chessground,e.promotion.key,e.promotion.pieceClass),this.chessground.set({turnColor:n.game.player,movable:{dests:s?se(n.possibleMoves):new Map},check:!!e.check}),e.check&&nn(),Mn=Date.now()+1e3,lichess.pubsub.emit("ply",this.ply)}n.game.threefold=!!e.threefold;const a={ply:this.lastPly()+1,fen:e.fen,san:e.san,uci:e.uci,check:e.check,crazy:e.crazyhouse};if(n.steps.push(a),this.justDropped=void 0,this.justCaptured=void 0,lt(n,r,!0),this.data.forecastCount=void 0,e.clock){this.shouldSendMoveTime=!0;const t=e.clock,o=s&&i?0:t.lag||1;this.clock?this.clock.setClock(n,t.white,t.black,o):this.corresClock&&this.corresClock.update(t.white,t.black)}if(this.data.expiration&&(this.data.steps.length>2?this.data.expiration=void 0:this.data.expiration.movedAt=Date.now()),this.redraw(),s&&r==n.player.color&&(this.transientMove.clear(),this.moveOn.next(),function(e,t){e.opponent.ai&&lichess.storage.fire("ceval.fen",t.fen)}(n,e)),!this.replaying()&&r!=n.player.color){const e="atomic"===n.game.variant.key?100:1;setTimeout((()=>{this.chessground.playPremove()||this.playPredrop()||(wn(this),this.showYourMoveNotification())}),e)}return this.autoScroll(),this.onChange(),this.keyboardMove&&this.keyboardMove.update(a,r!=n.player.color),this.music&&this.music.jump(e),(e=>{Dn((t=>t.step(e,!1)))})(a),!0},this.playPredrop=()=>this.chessground.playPredrop((e=>us(this.data,e.role,e.key))),this.reload=e=>{e.steps.length!==this.data.steps.length&&(this.ply=e.steps[e.steps.length-1].ply),Ke(e),this.data=e,this.clearJust(),this.shouldSendMoveTime=!1,this.clock&&this.clock.setClock(e,e.clock.white,e.clock.black),this.corresClock&&this.corresClock.update(e.correspondence.white,e.correspondence.black),this.replaying()||function(e){e.chessground.set(Fo(e))}(this),this.setTitle(),this.moveOn.next(),this.setQuietMode(),this.redraw(),this.autoScroll(),this.onChange(),this.setLoading(!1),this.keyboardMove&&this.keyboardMove.update(e.steps[e.steps.length-1])},this.endWithData=e=>{var t,o;const n=this.data;if(n.game.winner=e.winner,n.game.status=e.status,n.game.boosted=e.boosted,this.userJump(this.lastPly()),this.chessground.stop(),e.ratingDiff&&(n.player.ratingDiff=e.ratingDiff[n.player.color],n.opponent.ratingDiff=e.ratingDiff[n.opponent.color]),!n.player.spectator&&n.game.turns>1){const s=e.winner?n.player.color===e.winner?"victory":"defeat":"draw";lichess.sound.play(s),"victory"!=s&&n.game.turns>6&&!n.tournament&&!n.swiss&&"1"==lichess.storage.get("courtesy")&&(null===(o=null===(t=this.opts.chat)||void 0===t?void 0:t.instance)||void 0===o||o.then((e=>e.post("Good game, well played"))))}n.crazyhouse&&function(){const e=lichess.storage.make("crazyKeyHist");if(cs)e.set(10);else if(ls){const t=parseInt(e.get());t>0&&t<=10?e.set(t-1):0!==t&&e.set(3)}}(),this.clearJust(),this.setTitle(),this.moveOn.next(),this.setQuietMode(),this.setLoading(!1),this.clock&&e.clock&&this.clock.setClock(n,.01*e.clock.wc,.01*e.clock.bc),this.redraw(),this.autoScroll(),this.onChange(),n.tv&&setTimeout(lichess.reload,1e4),Ln(this)},this.challengeRematch=()=>{var e;this.challengeRematched=!0,(e=this.data.game.id,S("/challenge/rematch-of/"+e,{method:"post"})).then((()=>{lichess.pubsub.emit("challenge-app.open"),lichess.once("rematch-challenge")&&setTimeout((()=>{lichess.hopscotch((function(){window.hopscotch.configure({i18n:{doneBtn:"OK, got it"}}).startTour({id:"rematch-challenge",showPrevButton:!0,steps:[{title:"Challenged to a rematch",content:"Your opponent is offline, but they can accept this challenge later!",target:"#challenge-app",placement:"bottom"}]})}))}),1e3)}),(e=>{this.challengeRematched=!1}))},this.makeCorrespondenceClock=()=>{this.data.correspondence&&!this.corresClock&&(this.corresClock=function(e,t,o){const n=.1/t.increment;let s;function r(e,t){s={white:1e3*e,black:1e3*t,lastUpdate:performance.now()}}return r(t.white,t.black),{root:e,data:t,timePercent:e=>Math.max(0,Math.min(100,s[e]*n)),millisOf:e=>Math.max(0,s[e]),update:r,tick:function(e){const t=performance.now();s[e]-=t-s.lastUpdate,s.lastUpdate=t,s[e]<=0&&o()}}}(this,this.data.correspondence,this.socket.outoftime))},this.corresClockTick=()=>{this.corresClock&&Qe(this.data)&&this.corresClock.tick(this.data.game.player)},this.setQuietMode=()=>{const e=lichess.quietMode,t=this.isPlaying();e!==t&&(lichess.quietMode=t,$("body").toggleClass("playing",t).toggleClass("no-select",t&&this.clock&&this.clock.millisOf(this.data.player.color)<=3e5))},this.takebackYes=()=>{this.socket.sendLoading("takeback-yes"),this.chessground.cancelPremove(),wn(this)},this.resign=(e,t)=>{e?(this.resignConfirm||!this.data.pref.confirmResign||t?(this.socket.sendLoading("resign"),clearTimeout(this.resignConfirm)):this.resignConfirm=setTimeout((()=>this.resign(!1)),3e3),this.redraw()):this.resignConfirm&&(clearTimeout(this.resignConfirm),this.resignConfirm=void 0,this.redraw())},this.goBerserk=()=>{this.socket.berserk(),lichess.sound.play("berserk")},this.setBerserk=e=>{this.goneBerserk[e]||(this.goneBerserk[e]=!0,e!==this.data.player.color&&lichess.sound.play("berserk"),this.redraw(),$('<i data-icon="`">').appendTo($(`.game__meta .player.${e} .user-link`)))},this.setLoading=(e,t=1500)=>{clearTimeout(this.loadingTimeout),e?(this.loading=!0,this.loadingTimeout=setTimeout((()=>{this.loading=!1,this.redraw()}),t),this.redraw()):this.loading&&(this.loading=!1,this.redraw())},this.setRedirecting=()=>{this.redirecting=!0,lichess.unload.expected=!0,setTimeout((()=>{this.redirecting=!1,this.redraw()}),2500),this.redraw()},this.submitMove=e=>{const t=this.moveToSubmit||this.dropToSubmit;e&&t?(this.moveToSubmit?this.actualSendMove("move",this.moveToSubmit):this.actualSendMove("drop",this.dropToSubmit),lichess.sound.play("confirmation")):this.jump(this.ply),this.cancelMove(),t&&this.setLoading(!0,300)},this.cancelMove=()=>{this.moveToSubmit=void 0,this.dropToSubmit=void 0},this.onChange=()=>{this.opts.onChange&&setTimeout((()=>this.opts.onChange(this.data)),150)},this.setGone=e=>{dt(this.data,this.data.opponent.color,e),clearTimeout(this.goneTick),Number(e)>1&&(this.goneTick=setTimeout((()=>{const e=Number(this.opponentGone());e>1&&this.setGone(e-1)}),1e3)),this.redraw()},this.opponentGone=()=>{const e=this.data;return!1!==e.opponent.gone&&!et(e)&&rt(e)&&e.opponent.gone},this.canOfferDraw=()=>{return e=this.data,Qe(e)&&e.game.turns>=2&&!e.player.offeringDraw&&!ct(e)&&(this.lastDrawOfferAtPly||-99)<this.ply-20;var e},this.offerDraw=e=>{this.canOfferDraw()&&(this.drawConfirm?(e&&this.doOfferDraw(),clearTimeout(this.drawConfirm),this.drawConfirm=void 0):e&&(this.data.pref.confirmResign?this.drawConfirm=setTimeout((()=>{this.offerDraw(!1)}),3e3):this.doOfferDraw())),this.redraw()},this.doOfferDraw=()=>{this.lastDrawOfferAtPly=this.ply,this.socket.sendLoading("draw-yes",null)},this.setChessground=e=>{this.chessground=e,this.data.pref.keyboardMove&&(this.keyboardMove=function(e,t,o){let n,s=!1,r=t.fen,i=performance.now();const a=e.chessground.state,c=t=>{a.selected===t?e.chessground.cancelMove():(e.chessground.selectSquare(t,!0),i=performance.now())};let l=!1;return{drop(t,o){const n=fs[o],s=e.data.crazyhouse,r=e.data.player.color;n&&s&&!a.pieces.has(t)&&s.pockets["white"===r?0:1][n]&&us(e.data,n,t)&&(e.chessground.cancelMove(),e.chessground.newPiece({role:n,color:r},t),e.sendNewPiece(n,t,!1))},promote(t,o,n){const s=fs[n];s&&"pawn"!=s&&(e.chessground.cancelMove(),fn(e,t,o,s,{premove:!1}))},update(e,t=!1){n?n(e.fen,a.movable.dests,t):r=e.fen},registerHandler(e){n=e,r&&n(r,a.movable.dests)},hasFocus:()=>s,setFocus(e){s=e,o()},san(t,o){l=!0,e.chessground.cancelMove(),c(t),c(o)},select:c,hasSelected:()=>a.selected,confirmMove(){e.submitMove(!0)},usedSan:l,jump(t){e.userJump(e.ply+t),o()},justSelected:()=>performance.now()-i<500,clock:()=>e.clock,resign:e.resign}}(this,this.stepAt(this.ply),this.redraw),requestAnimationFrame((()=>this.redraw())))},this.stepAt=e=>Ge(this.data,e),this.delayedInit=()=>{const e=this.data;var t,o;this.isPlaying()&&0===(t=e,o=e.player.color,Math.floor((t.game.turns+("white"==o?1:0))/2))&&!this.isSimulHost()&&lichess.sound.play("genericNotify"),lichess.requestIdleCallback((()=>{const e=this.data;this.isPlaying()&&(e.simul||(e.steps.length>2||(Mn=Date.now()+1e4),window.addEventListener("focus",(()=>Tn=Date.now()))),window.addEventListener("focus",pn),this.setTitle(),e.crazyhouse&&ps(this),window.addEventListener("beforeunload",(e=>{const t=this.data;if(lichess.unload.expected||this.nvui||!Qe(t)||!t.clock||t.opponent.ai||this.isSimulHost())return;this.socket.send("bye2");const o="There is a game in progress!";return(e||window.event).returnValue=o,o})),!this.nvui&&e.pref.submitMove&&window.Mousetrap.bind("esc",(()=>{this.submitMove(!1),this.chessground.cancelMove()})).bind("return",(()=>this.submitMove(!0))),function(e){var t;e.data.opponent.ai||!e.data.game.rated&&e.opts.userId||"BOT"!=(null===(t=e.data.player.user)||void 0===t?void 0:t.title)&&(lichess.storage.fire("ceval.disable"),lichess.storage.make("ceval.fen").listen((t=>{const o=e.data,n=He(e.data);!ws&&n.ply>14&&e.isPlaying()&&t.value&&ks(n.fen)==ks(t.value)&&(P(`/jslog/${o.game.id}${o.player.id}?n=ceval`,{method:"post"}),ws=!0)})))}(this)),this.nvui||(e=>{window.Mousetrap.bind(["left","h"],(()=>{ys(e),e.redraw()})).bind(["right","l"],(()=>{Cs(e),e.redraw()})).bind(["up","k"],(()=>{e.userJump(0),e.redraw()})).bind(["down","j"],(()=>{e.userJump(e.data.steps.length-1),e.redraw()})).bind("f",e.flipNow).bind("z",(()=>lichess.pubsub.emit("zen")))})(this),(e=>{lichess.pubsub.on("speech.enabled",Pn(e)),Pn(e)(lichess.sound.speech())})(this),this.onChange()}),800)},Ke(e.data);const n=this.data=e.data;this.ply=Fe(n),this.goneBerserk[n.player.color]=n.player.berserk,this.goneBerserk[n.opponent.color]=n.opponent.berserk,setTimeout((()=>{this.firstSeconds=!1,this.redraw()}),3e3),this.socket=function(e,t){function o(e,s){e&&e.t?(t.setLoading(!1),n[e.t](e.d)):Qo(t).then((n=>{lichess.socket.getVersion()>n.player.version?s?lichess.reload():o(e,!0):t.reload(n)}),lichess.reload)}lichess.socket.sign(t.sign);const n={takebackOffers(e){t.setLoading(!1),t.data.player.proposingTakeback=e[t.data.player.color],(t.data.opponent.proposingTakeback=e[t.data.opponent.color])&&Vo(t.noarg("yourOpponentProposesATakeback")),t.redraw()},move:t.apiMove,drop:t.apiMove,reload:o,redirect:t.setRedirecting,clockInc(e){t.clock&&(t.clock.addTime(e.color,e.time),t.redraw())},cclock(e){t.corresClock&&(t.data.correspondence.white=e.white,t.data.correspondence.black=e.black,t.corresClock.update(e.white,e.black),t.redraw())},crowd(e){["white","black"].forEach((o=>{y(e[o])&&lt(t.data,o,e[o])})),t.redraw()},endData:t.endWithData,rematchOffer(e){t.data.player.offeringRematch=e===t.data.player.color,(t.data.opponent.offeringRematch=e===t.data.opponent.color)&&Vo(t.noarg("yourOpponentWantsToPlayANewGameWithYou")),t.redraw()},rematchTaken(e){t.data.game.rematch=e,t.data.player.spectator?t.redraw():t.setLoading(!0)},drawOffer(e){if(t.isPlaying()&&(t.data.player.offeringDraw=e===t.data.player.color,(t.data.opponent.offeringDraw=e===t.data.opponent.color)&&Vo(t.noarg("yourOpponentOffersADraw"))),e){let o=t.lastPly();"white"==e==(o%2==0)&&o++,t.data.game.drawOffers=(t.data.game.drawOffers||[]).concat([o])}t.redraw()},berserk(e){t.setBerserk(e)},gone:t.setGone,goneIn:t.setGone,checkCount(e){t.data.player.checks="white"==t.data.player.color?e.white:e.black,t.data.opponent.checks="white"==t.data.opponent.color?e.white:e.black,t.redraw()},simulPlayerMove(e){t.opts.userId&&t.data.simul&&t.opts.userId==t.data.simul.hostId&&e!==t.data.game.id&&t.moveOn.get()&&!et(t.data)&&(t.setRedirecting(),tn(),location.href="/"+e)},simulEnd(e){lichess.loadCssPath("modal"),Jo($(`<p>Simul complete!</p><br /><br /><a class="button" href="/simul/${e.id}">Back to ${e.name} simul</a>`))}};return lichess.pubsub.on("ab.rep",(t=>e("rep",{n:t}))),{send:e,handlers:n,moreTime:Xo(300,(()=>e("moretime"))),outoftime:rn(500,1.1,(()=>e("flag",t.data.game.player))),berserk:Xo(200,(()=>e("berserk",null,{ackable:!0}))),sendLoading(o,n){t.setLoading(!0),e(o,n)},receive:(e,t)=>!!n[e]&&(n[e](t),!0),reload:o}}(e.socketSend,this),lichess.RoundNVUI&&(this.nvui=lichess.RoundNVUI(t)),n.clock?this.clock=new ss(n,{onFlag:this.socket.outoftime,soundColor:n.simul||n.player.spectator||!n.pref.clockSound?void 0:n.player.color,nvui:!!this.nvui}):(this.makeCorrespondenceClock(),setInterval(this.corresClockTick,1e3)),this.setQuietMode(),this.moveOn=new rs(this,"move-on"),this.transientMove=new is(this.socket),this.trans=lichess.trans(e.i18n),this.noarg=this.trans.noarg,setTimeout(this.delayedInit,200),setTimeout(this.showExpiration,350),(null===(o=document.referrer)||void 0===o?void 0:o.includes("/serviceWorker."))||setTimeout(this.showYourMoveNotification,500),lichess.pubsub.on("jump",(e=>{this.jump(parseInt(e)),this.redraw()})),lichess.pubsub.on("sound_set",(e=>{this.music||"music"!==e||lichess.loadScript("javascripts/music/play.js").then((()=>{this.music=lichess.playMusic()})),this.music&&"music"!==e&&(this.music=void 0)})),lichess.pubsub.on("zen",(()=>{if(this.isPlaying()){const e=!$("body").hasClass("zen");$("body").toggleClass("zen",e),window.dispatchEvent(new Event("resize")),Zo(e)}})),this.isPlaying()}clearJust(){this.justDropped=void 0,this.justCaptured=void 0,this.preDrop=void 0}}const Ms=["mousedown","touchstart"];function xs(e,t,o){const n=Ge(e.data,e.ply);if(!n.crazy)return;const s=e.justDropped,r=e.preDrop,i=n.crazy.pockets["white"===t?0:1],a=o===(e.flip?"top":"bottom")&&!e.replaying()&&e.isPlaying(),c=t===e.data.player.color,l=e.justCaptured,d=l&&(l.promoted?"pawn":l.role);return p("div.pocket.is2d.pocket-"+o,{class:{usable:a},hook:oe((t=>Ms.forEach((n=>t.addEventListener(n,(t=>{o===(e.flip?"top":"bottom")&&0==hs.length&&function(e,t){if(void 0!==t.button&&0!==t.button)return;if(e.replaying()||!e.isPlaying())return;const o=t.target,n=o.getAttribute("data-role"),s=o.getAttribute("data-color"),r=o.getAttribute("data-nb");n&&s&&"0"!==r&&(t.stopPropagation(),t.preventDefault(),no(e.chessground.state,{color:s,role:n},t))}(e,t)}))))))},as.map((e=>{let o=i[e]||0;return c&&(s===e&&o--,d===e&&o++),p("div.pocket-c1",p("div.pocket-c2",p("piece."+e+"."+t,{class:{premove:c&&r===e},attrs:{"data-role":e,"data-color":t,"data-nb":o}})))})))}const Ss=(e,t)=>(e/Math.pow(10,t)).toFixed(t).substr(2),Ps=e=>`<b>${e}</b>`;function Ls(e,t,o,n,s){const r=e.millisOf(o),i=e=>{e.innerHTML=function(e,t){const o=new Date(t),n=Ss(o.getUTCMinutes(),2),s=Ss(o.getSeconds(),2);let r,i="";if(t>=864e5){const t=o.getUTCDate()-1;r=o.getUTCHours(),i+=(1===t?e("oneDay"):e.plural("nbDays",t))+" ",0!==r&&(i+=e.plural("nbHours",r))}else t>=36e5?(r=o.getUTCHours(),i+=Ps(Ss(r,2))+":"+Ps(n)):i+=Ps(n)+":"+Ps(s);return i}(t,r)},a=e.root.data.player.color===o;return p("div.rclock.rclock-correspondence.rclock-"+n,{class:{outoftime:r<=0,running:s===o}},[e.data.showBar?p("div.bar",[p("span",{attrs:{style:`width: ${e.timePercent(o)}%`}})]):null,p("div.time",{hook:{insert:e=>i(e.elm),postpatch:(e,t)=>i(t.elm)}}),a?null:Un(e.root)])}let Ds="init";function Es(){return"string"==typeof Ds&&("init"==Ds&&(window.addEventListener("resize",(()=>{Ds="rec"})),navigator.userAgent.indexOf("Edge/")>-1&&requestAnimationFrame((()=>{Ds="rec"}))),Ds=!!getComputedStyle(document.body).getPropertyValue("--col1")),Ds}const Os="u8t",As="i5z".toUpperCase(),$s=Xo(100,((e,t)=>window.requestAnimationFrame((()=>{if(t.data.steps.length<7)return;let o;if(t.ply<3)o=0;else if(t.ply==Fe(t.data))o=99999;else{const t=e.querySelector(".a1t");t&&(o=Es()?t.offsetLeft-e.offsetWidth/2+t.offsetWidth/2:t.offsetTop-e.offsetHeight/2+t.offsetHeight/2)}"number"==typeof o&&(99999==o?e.scrollLeft=e.scrollTop=o:Es()?e.scrollLeft=o:e.scrollTop=o)}))));function Ns(e,t,o,n){return e?p(Os,{class:{a1t:e.ply===t}},["P"===e.san[0]?e.san.slice(1):e.san,n.has(e.ply)?p("draw",{attrs:{title:"Draw offer"}},"½?"):void 0]):o?p(Os,"…"):void 0}function js(e){let t;if(Ve(e.data))switch(e.data.game.winner){case"white":t="1-0";break;case"black":t="0-1";break;default:t="½-½"}if(t||Xe(e.data)){const o=e.data.game.winner;return p("div.result-wrap",[p("p.result",t||""),p("p.status",{hook:oe((()=>{e.autoScroll?e.autoScroll():setTimeout((()=>e.autoScroll()),200)}))},[Sn(e),o?" • "+e.noarg(o+"IsVictorious"):""])])}}function Bs(e){const t=e.data.forecastCount;return Ve(o=e.data)||Qe(o)&&(!o.clock||!Ze(o))?p("a.fbt.analysis",{class:{text:!!t},attrs:{title:e.noarg("analysis"),href:En(e.data,e.data.player.color)+"/analysis#"+e.ply,"data-icon":"A"}},t?[""+t]:[]):void 0;var o}function Is(e){const t=e.data,o=qe(t),n=Fe(t);return p("div.buttons",{hook:ne("mousedown",(o=>{const n=o.target,s=parseInt(n.getAttribute("data-ply")||"");if(isNaN(s)){"flip"===(n.getAttribute("data-act")||n.parentNode.getAttribute("data-act"))&&(t.tv?location.href="/tv/"+t.tv.channel+(t.tv.flip?"":"?flip=1"):t.player.spectator?location.href=En(t,t.opponent.color):e.flipNow())}else e.userJump(s)}),e.redraw)},[p("button.fbt.flip",{class:{active:e.flip},attrs:{title:e.noarg("flipBoard"),"data-act":"flip","data-icon":"B"}}),...[["W",o],["Y",e.ply-1],["X",e.ply+1],["V",n]].map(((t,s)=>{const r=e.ply!==t[1]&&t[1]>=o&&t[1]<=n;return p("button.fbt",{class:{glowing:3===s&&e.isLate()},attrs:{disabled:!r,"data-icon":t[0],"data-ply":r?t[1]:"-"}})})),Bs(e)||p("div.noop")])}function Rs(e,t){return Qe(e)&&0===e.game.turns&&!e.player.spectator?p("div.message",ee(""),[p("div",[t("white"===e.player.color?"youPlayTheWhitePieces":"youPlayTheBlackPieces"),..."white"===e.player.color?[p("br"),p("strong",t("itsYourTurn"))]:[]])]):null}function _s(e,t,o,n){return n?null:p("button.fbt",{attrs:{disabled:n,"data-icon":o,"data-ply":e.ply+t},hook:ne("mousedown",(o=>{o.preventDefault(),e.userJump(e.ply+t),e.redraw()}))})}function zs(e){const t=e.data,o=e.replayEnabledByPref()&&p("l4x",{hook:oe((t=>{t.addEventListener("mousedown",(t=>{let o=t.target,n=-2;if(o.tagName===Os.toUpperCase())for(;o=o.previousSibling;)if(n++,o.tagName===As){e.userJump(2*parseInt(o.textContent||"")+n),e.redraw();break}})),e.autoScroll=()=>$s(t,e),e.autoScroll()}))},function(e){const t=e.data.steps,o=qe(e.data),n=Fe(e.data),s=new Set(e.data.game.drawOffers||[]);if(void 0===n)return[];const r=[];let i=1;o%2==1&&(r.push([null,t[1]]),i=2);for(let e=i;e<t.length;e+=2)r.push([t[e],t[e+1]]);const a=[],c=e.ply;for(let e=0;e<r.length;e++)a.push(p("i5z",e+1+"")),a.push(Ns(r[e][0],c,!0,s)),a.push(Ns(r[e][1],c,!1,s));return a.push(js(e)),a}(e));return e.nvui?void 0:p("rm6",[Is(e),Rs(t,e.trans.noarg)||(o?Es()?p("div.col1-moves",[_s(e,-1,"Y",e.ply==qe(t)),o,_s(e,1,"X",e.ply==Fe(t))]):o:js(e))])}let qs=!1;function Fs(e){const t=Qe(e.data)&&e.data.expiration;if(!t)return;const o=Math.max(0,t.movedAt-Date.now()+t.millisToMove),n=Math.floor(o/1e3),s=et(e.data),r=s&&o<8e3;!qs&&r&&(lichess.sound.play("lowTime"),qs=!0);return p("div.expiration.expiration-"+(s!=e.flip?"bottom":"top"),{class:{emerg:r,"bar-glider":s}},e.trans.vdomPlural("nbSecondsToPlayTheFirstMove",n,p("strong",""+n)))}function Hs(e,t){const o=e.playerAt(t);return e.nvui?void 0:o.ai?p("div.user-link.online.ruser.ruser-"+t,[p("i.line"),p("name",vs(e,o.ai))]):function(e,t,o){const n=e.data,s=t.user,r=s?s.perfs[n.game.perf]:null,i=t.rating?t.rating:r&&r.rating,a=t.ratingDiff,c=0===a?p("span","±0"):a&&a>0?p("good","+"+a):a&&a<0?p("bad","−"+-a):void 0;if(s){const n=!t.onGame&&e.firstSeconds&&s.online;return p(`div.ruser-${o}.ruser.user-link`,{class:{online:t.onGame,offline:!t.onGame,long:s.username.length>16,connecting:n}},[p("i.line"+(s.patron?".patron":""),{attrs:{title:n?"Connecting to the game":t.onGame?"Joined the game":"Left the game"}}),p("a.text.ulpt",{attrs:Object.assign({"data-pt-pos":"s",href:"/@/"+s.username},e.isPlaying()?{target:"_blank",rel:"noopener"}:{})},s.title?[p("span.utitle","BOT"==s.title?{attrs:{"data-bot":!0}}:{},s.title)," ",s.username]:[s.username]),i?p("rating",i+(t.provisional?"?":"")):null,c,t.engine?p("span",{attrs:{"data-icon":"j",title:e.noarg("thisAccountViolatedTos")}}):null])}const l=!t.onGame&&e.firstSeconds;return p(`div.ruser-${o}.ruser.user-link`,{class:{online:t.onGame,offline:!t.onGame,connecting:l}},[p("i.line",{attrs:{title:l?"Connecting to the game":t.onGame?"Joined the game":"Left the game"}}),p("name",t.name||e.noarg("anonymous"))])}(e,o,t)}const Gs=e=>e.loading||e.redirecting,Ks=()=>p("i.ddloader"),Us=(e,t)=>[zs(e),t.find((e=>!!e))?p("div.rcontrols",t):null],Ws=e=>Us(e,[Gs(e)?Ks():Gn(e)||Kn(e)||Wn(e)]),Ys=e=>Us(e,[Gs(e)?Ks():Qe(e.data)?void 0:Yn(e)]),Vs=e=>{const t=e.data,o=Gs(e),n=function(e){return e.moveToSubmit||e.dropToSubmit?p("div.negotiation.move-confirm",[Fn(e,(()=>e.submitMove(!1)),"cancel"),p("p",e.noarg("confirmMove")),qn(e,"confirm-yes",(()=>e.submitMove(!0)))]):void 0}(e),s=o||n?[]:[nt(t)?An(e,void 0,"L","abortGame","abort"):An(e,st,"i","proposeATakeback","takeback-yes",e.takebackYes),e.drawConfirm?Bn(e):An(e,e.canOfferDraw,"2","offerDraw","draw-yes",(()=>e.offerDraw(!0))),e.resignConfirm?jn(e):An(e,rt,"b","resign","resign",(()=>e.resign(!0))),Bs(e)],r=o?[Ks()]:n?[n]:[$n(e),In(e),Rn(e),_n(e),zn(e),Hn(e)];return[zs(e),p("div.rcontrols",[...r,p("div.ricons",{class:{confirm:!(!e.drawConfirm&&!e.resignConfirm)}},s)])]};function Xs(e,t){const o=e.playerAt(t);return e.clock?function(e,t,o){const n=e.clock,s=n.millisOf(t.color),r=e.data.player.color===t.color,i=t.color===n.times.activeColor,a=e=>{const o=n.elements[t.color],s=n.millisOf(t.color),r=t.color===n.times.activeColor;o.time=e,o.clock=e.parentElement,e.innerHTML=Qn(s,n.showTenths(s),r,n.opts.nvui)},c={insert:e=>a(e.elm),postpatch:(e,t)=>a(t.elm)};return p("div.rclock.rclock-"+o,{class:{outoftime:s<=0,running:i,emerg:s<n.emergMs}},n.opts.nvui?[p("div.time",{attrs:{role:"timer"},hook:c})]:[n.showBar&&ot(e.data)?Zn(e,t.color):void 0,p("div.time",{class:{hour:s>36e5},hook:c}),ts(e,t.color,o),r?os(e):Un(e),ns(e,t.color,o)])}(e,o,t):e.data.correspondence&&e.data.game.turns>1?Ls(e.corresClock,e.trans,o.color,t,e.data.game.player):function(e,t,o){const n=e.data;if(!Ve(n)&&!Xe(n))return p("div.rclock.rclock-turn.rclock-"+o,[n.game.player===t?p("div.rclock-turn__text",n.player.spectator?e.trans(n.game.player+"Plays"):e.trans(n.game.player===n.player.color?"yourTurn":"waitingForOpponent")):null])}(e,o.color,t)}const Js=e=>[p("div.round__app__table"),Fs(e),Hs(e,"top"),...e.data.player.spectator?Ys(e):Qe(e.data)?Vs(e):Ws(e),Hs(e,"bottom"),Xs(e,"top"),Xs(e,"bottom")];function Qs(e,t,o,n){const s=[];let r,i;for(r in e)if(e[r]>0){const t=[];for(i=0;i<e[r];i++)t.push(p("mpiece."+r));s.push(p("div",t))}if(n)for(i=0;i<n;i++)s.push(p("div",p("mpiece.king")));return t>0&&s.push(p("score","+"+t)),p("div.material.material-"+o,s)}const Zs={white:{},black:{}};function er(e){const t=e.data,o=e.chessground&&e.chessground.state,n=t[e.flip?"player":"opponent"].color,s=t[e.flip?"opponent":"player"].color;let r,i=0;if(t.pref.showCaptured){const t=o?o.pieces:_t(Ge(e.data,e.ply).fen);r=function(e){const t={white:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0},black:{king:0,queen:0,rook:0,bishop:0,knight:0,pawn:0}};for(const o of e.values()){const e=t[z(o.color)];e[o.role]>0?e[o.role]--:t[o.color][o.role]++}return t}(t),i=function(e){let t=0;for(const o of e.values())t+=Z[o.role]*("white"===o.color?1:-1);return t}(t)*("white"===s?1:-1)}else r=Zs;const a=t.player.checks||t.opponent.checks?function(e,t){const o=Object.assign({},re);for(const n of e){if(t<n.ply)break;n.check&&(n.ply%2==1?o.white++:o.black++)}return o}(e.data.steps,e.ply):re;return e.nvui?e.nvui.render(e):p("div.round__app.variant-"+t.game.variant.key,[p("div.round__app__board.main-board"+(e.data.pref.blindfold?".blindfold":""),{hook:"ontouchstart"in window?void 0:ne("wheel",(t=>function(e,t){e.isPlaying()||(t.preventDefault(),t.deltaY>0?Cs(e):t.deltaY<0&&ys(e),e.redraw())}(e,t)),void 0,!1)},[Ko(e),Cn(e)]),xs(e,n,"top")||Qs(r[n],-i,"top",a[n]),...Js(e),xs(e,s,"bottom")||Qs(r[s],i,"bottom",a[s]),e.keyboardMove?gs(e.keyboardMove):null])}const tr=u([k,b]);return window.LichessChat=function(e,t){const o=u([k,b]),n=be(t,(function(){r=o(r,_e(n))})),s=_e(n);e.innerHTML="";let r=o(e,s);return n},window.Chessground=_o,e.app=function(e){const t=new Ts(e,s),o=er(t);e.element.innerHTML="";let n=tr(e.element,o);function s(){n=tr(n,er(t))}return window.addEventListener("resize",s),t.isPlaying()&&function(){if("ontouchstart"in window)return;let e,t;const o=o=>{e=o.pageX,t=o.pageY};let n={};$("#topnav.hover").each((function(){const s=$(this).removeClass("hover"),r=()=>s.toggleClass("hover"),i=()=>{Math.sqrt((n.pX-e)*(n.pX-e)+(n.pY-t)*(n.pY-t))<8?(s.off(n.event,o),delete n.timeoutId,n.isActive=!0,r()):(n.pX=e,n.pY=t,n.timeoutId=setTimeout(i,200))},a=function(e){n.timeoutId&&(n.timeoutId=clearTimeout(n.timeoutId));const t=n.event="mousemove";if("mouseover"==e.type){if(n.isActive||e.buttons)return;n.pX=e.pageX,n.pY=e.pageY,s.off(t,o).on(t,o),n.timeoutId=setTimeout(i,200)}else{if(!n.isActive)return;s.off(t,o),n={},r()}};s.on("mouseover",a).on("mouseleave",a)}))}(),lichess.sound.preloadBoardSounds(),{socketReceive:t.socket.receive,moveOn:t.moveOn}},e.boot=function(e){var t;const o=document.querySelector(".round__app"),n=e.data;function s(){n.tournament&&$(".game__tournament .clock").each((function(){$(this).clock({time:parseFloat($(this).data("time"))})}))}function r(e){if(!e.player.spectator)return e.steps.length<4?"start":e.game.status.id>=30?"end":void 0}n.tournament&&$("body").data("tournament-id",n.tournament.id),lichess.socket=new lichess.StrongSocket(n.url.socket,n.player.version,{params:{userTv:n.userTv&&n.userTv.id},receive(e,t){i.socketReceive(e,t)},events:{tvSelect(e){n.tv&&n.tv.channel==e.channel?lichess.reload():$(".tv-channels ."+e.channel+" .champion").html(e.player?[e.player.title,e.player.name,e.player.rating].filter((e=>e)).join("&nbsp"):"Anonymous")},end(){P(`${n.tv?"/tv":""}/${n.game.id}/${n.player.color}/sides`).then((e=>{const t=$(e),o=t.find(".game__meta");o.length&&$(".game__meta").replaceWith(o),$(".crosstable").replaceWith(t.find(".crosstable")),s(),lichess.contentLoaded()}))},tourStanding(t){var o,n,s;(null===(o=e.chat)||void 0===o?void 0:o.plugin)&&(null===(s=null===(n=e.chat)||void 0===n?void 0:n.instance)||void 0===s||s.then((o=>{e.chat.plugin.set(t),o.redraw()})))}}}),e.element=o,e.socketSend=lichess.socket.send;const i=window.LichessRound.app(e),a=e.chat;var c,l;a&&((null===(t=n.tournament)||void 0===t?void 0:t.top)?(a.plugin=(c=n.tournament.top,l=n.tournament.team,{set(e){c=e},tab:{key:"tourStanding",name:e.i18n.standing},view:()=>p("div",{hook:oe((e=>{lichess.loadCssPath("round.tour-standing")}))},[l?p("h3.text",{attrs:{"data-icon":"f"}},l.name):null,p("table.slist",[p("tbody",c.map(((e,t)=>p("tr."+e.n,[p("td.name",[p("span.rank",""+(t+1)),p("a.user-link.ulpt",{attrs:{href:`/@/${e.n}`}},(e.t?e.t+" ":"")+e.n)]),p("td.total",e.f?{class:{"is-gold":!0},attrs:{"data-icon":"Q"}}:{},""+e.s)]))))])])}),a.alwaysEnabled=!0):n.simul||n.swiss||(a.preset=r(n),a.parseMoves=!0),a.noteId&&(a.noteAge||0)<10&&(a.noteText=""),a.instance=lichess.makeChat(a),n.tournament||n.simul||n.swiss||(e.onChange=e=>a.instance.then((t=>t.preset.setGroup(r(e)))))),s(),$(".round__now-playing .move-on input").on("change",i.moveOn.toggle).prop("checked",i.moveOn.get()).on("click","a",(()=>(lichess.unload.expected=!0,!0))),0===location.pathname.lastIndexOf("/round-next/",0)&&history.replaceState(null,"","/"+n.game.id),$("#zentog").on("click",(()=>lichess.pubsub.emit("zen"))),lichess.storage.make("reload-round-tabs").listen(lichess.reload)},Object.defineProperty(e,"__esModule",{value:!0}),e}({});
