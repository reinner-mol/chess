!function(e){"use strict";function t(e,t,o,n,r){return{sel:e,data:t,children:o,text:n,elm:r,key:void 0===t?void 0:t.key}}const o=Array.isArray;function n(e){return"string"==typeof e||"number"==typeof e}function r(e,t,o){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==o&&void 0!==t)for(let e=0;e<t.length;++e){const o=t[e].data;void 0!==o&&r(o,t[e].children,t[e].sel)}}function a(e,a,s){let i,c,l,d={};if(void 0!==s?(null!==a&&(d=a),o(s)?i=s:n(s)?c=s:s&&s.sel&&(i=[s])):null!=a&&(o(a)?i=a:n(a)?c=a:a&&a.sel?i=[a]:d=a),void 0!==i)for(l=0;l<i.length;++l)n(i[l])&&(i[l]=t(void 0,void 0,void 0,i[l],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||r(d,i,e),t(e,d,i,c,void 0)}const s={cache:"no-cache",credentials:"same-origin"},i={"X-Requested-With":"XMLHttpRequest"},c=(e,t={})=>l(e,t).then((e=>{if(e.ok)return e.text();throw e.statusText})),l=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},s),{headers:Object.assign({},i)}),t)),d=["white","black"],u=["a","b","c","d","e","f","g","h"],p=["1","2","3","4","5","6","7","8"],f=[...p].reverse(),h=Array.prototype.concat(...u.map((e=>p.map((t=>e+t))))),g=e=>h[8*e[0]+e[1]],m=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],b=h.map(m);const v=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},w=e=>"white"===e?"black":"white",y=(e,t)=>{const o=e[0]-t[0],n=e[1]-t[1];return o*o+n*n},k=(e,t)=>e.role===t.role&&e.color===t.color,C=(e,t,o,n)=>[(t?e[0]:7-e[0])*o,(t?7-e[1]:e[1])*n],x=e=>{const t=e.width/8,o=e.height/8;return(e,n)=>C(e,n,t,o)},M=(e,t)=>C(e,t,100,100),S=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},P=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},A=(e,t)=>{e.style.visibility=t?"visible":"hidden"},q=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},L=e=>2===e.buttons||2===e.button,E=(e,t)=>{const o=document.createElement(e);return t&&(o.className=t),o};function N(e,t,o){const n=m(e);return t||(n[0]=7-n[0],n[1]=7-n[1]),[o.left+o.width*n[0]/8+o.width/16,o.top+o.height*(7-n[1])/8+o.height/16]}function K(e,t){return Math.abs(e-t)}const D=(e,t,o,n)=>{const r=K(e,o),a=K(t,n);return 1===r&&2===a||2===r&&1===a},O=(e,t,o,n)=>K(e,o)===K(t,n),T=(e,t,o,n)=>e===o||t===n,B=(e,t,o,n)=>O(e,t,o,n)||T(e,t,o,n);function j(e,t,o){const n=e.get(t);if(!n)return[];const r=m(t),a=n.role,s="pawn"===a?(i=n.color,(e,t,o,n)=>K(e,o)<2&&("white"===i?n===t+1||t<=1&&n===t+2&&e===o:n===t-1||t>=6&&n===t-2&&e===o)):"knight"===a?D:"bishop"===a?O:"rook"===a?T:"queen"===a?B:function(e,t,o){return(n,r,a,s)=>K(n,a)<2&&K(r,s)<2||o&&r===s&&r===("white"===e?0:7)&&(4===n&&(2===a&&t.includes(0)||6===a&&t.includes(7))||t.includes(a))}(n.color,function(e,t){const o="white"===t?"1":"8",n=[];for(const[r,a]of e)r[1]===o&&a.color===t&&"rook"===a.role&&n.push(m(r)[0]);return n}(e,n.color),o);var i;return b.filter((e=>(r[0]!==e[0]||r[1]!==e[1])&&s(r[0],r[1],e[0],e[1]))).map(g)}function R(e,...t){e&&setTimeout((()=>e(...t)),1)}function z(e){e.premovable.current&&(e.premovable.current=void 0,R(e.premovable.events.unset))}function F(e){const t=e.predroppable;t.current&&(t.current=void 0,R(t.events.unset))}function I(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);if(t===o||!n)return!1;const a=r&&r.color!==n.color?r:void 0;return o===e.selected&&G(e),R(e.events.move,t,o,a),function(e,t,o){if(!e.autoCastle)return!1;const n=e.pieces.get(t);if(!n||"king"!==n.role)return!1;const r=m(t),a=m(o);if(0!==r[1]&&7!==r[1]||r[1]!==a[1])return!1;4!==r[0]||e.pieces.has(o)||(6===a[0]?o=g([7,a[1]]):2===a[0]&&(o=g([0,a[1]])));const s=e.pieces.get(o);return!(!s||s.color!==n.color||"rook"!==s.role||(e.pieces.delete(t),e.pieces.delete(o),r[0]<a[0]?(e.pieces.set(g([6,a[1]]),n),e.pieces.set(g([5,a[1]]),s)):(e.pieces.set(g([2,a[1]]),n),e.pieces.set(g([3,a[1]]),s)),0))}(e,t,o)||(e.pieces.set(o,n),e.pieces.delete(t)),e.lastMove=[t,o],e.check=void 0,R(e.events.change),a||!0}function W(e,t,o,n){if(e.pieces.has(o)){if(!n)return!1;e.pieces.delete(o)}return R(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,R(e.events.change),e.movable.dests=void 0,e.turnColor=w(e.turnColor),!0}function U(e,t,o){const n=I(e,t,o);return n&&(e.movable.dests=void 0,e.turnColor=w(e.turnColor),e.animation.current=void 0),n}function X(e,t,o){if(Y(e,t,o)){const n=U(e,t,o);if(n){const r=e.hold.stop();G(e);const a={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return!0!==n&&(a.captured=n),R(e.movable.events.after,t,o,a),!0}}else if(function(e,t,o){return t!==o&&_(e,t)&&j(e.pieces,t,e.premovable.castle).includes(o)}(e,t,o))return function(e,t,o,n){F(e),e.premovable.current=[t,o],R(e.premovable.events.set,t,o,n)}(e,t,o,{ctrlKey:e.stats.ctrlKey}),G(e),!0;return G(e),!1}function H(e,t,o,n){const r=e.pieces.get(t);r&&(function(e,t,o){const n=e.pieces.get(t);return!(!n||t!==o&&e.pieces.has(o)||"both"!==e.movable.color&&(e.movable.color!==n.color||e.turnColor!==n.color))}(e,t,o)||n)?(e.pieces.delete(t),W(e,r,o,n),R(e.movable.events.afterNewPiece,r.role,o,{premove:!1,predrop:!1})):r&&function(e,t,o){const n=e.pieces.get(t),r=e.pieces.get(o);return!!n&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==n.role||"1"!==o[1]&&"8"!==o[1])&&e.movable.color===n.color&&e.turnColor!==n.color}(e,t,o)?function(e,t,o){z(e),e.predroppable.current={role:t,key:o},R(e.predroppable.events.set,t,o)}(e,r.role,o):(z(e),F(e)),e.pieces.delete(t),G(e)}function Q(e,t,o){if(R(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return G(e),void e.hold.cancel();if((e.selectable.enabled||o)&&e.selected!==t&&X(e,e.selected,t))return void(e.stats.dragged=!1)}(Z(e,t)||_(e,t))&&(V(e,t),e.hold.start())}function V(e,t){e.selected=t,_(e,t)?e.premovable.dests=j(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function G(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Z(e,t){const o=e.pieces.get(t);return!!o&&("both"===e.movable.color||e.movable.color===o.color&&e.turnColor===o.color)}function Y(e,t,o){var n,r;return t!==o&&Z(e,t)&&(e.movable.free||!!(null===(r=null===(n=e.movable.dests)||void 0===n?void 0:n.get(t))||void 0===r?void 0:r.includes(o)))}function _(e,t){const o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}function J(e){const t=e.premovable.current;if(!t)return!1;const o=t[0],n=t[1];let r=!1;if(Y(e,o,n)){const t=U(e,o,n);if(t){const a={premove:!0};!0!==t&&(a.captured=t),R(e.movable.events.after,o,n,a),r=!0}}return z(e),r}function ee(e){z(e),F(e),G(e)}function te(e){e.movable.color=e.movable.dests=e.animation.current=void 0,ee(e)}function oe(e,t,o){let n=Math.floor(8*(e[0]-o.left)/o.width);t||(n=7-n);let r=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(r=7-r),n>=0&&n<8&&r>=0&&r<8?g([n,r]):void 0}function ne(e){return"white"===e.orientation}const re="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",ae={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},se={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function ie(e){"start"===e&&(e=re);const t=new Map;let o=7,n=0;for(const r of e)switch(r){case" ":return t;case"/":if(--o,o<0)return t;n=0;break;case"~":{const e=t.get(g([n,o]));e&&(e.promoted=!0);break}default:{const e=r.charCodeAt(0);if(e<57)n+=e-48;else{const e=r.toLowerCase();t.set(g([n,o]),{role:ae[e],color:r===e?"black":"white"}),++n}}}return t}function ce(e,t){var o,n;if((null===(o=t.movable)||void 0===o?void 0:o.dests)&&(e.movable.dests=void 0),(null===(n=t.drawable)||void 0===n?void 0:n.autoShapes)&&(e.drawable.autoShapes=[]),le(e,t),t.fen&&(e.pieces=ie(t.fen),e.drawable.shapes=[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[o,n]of e.pieces)"king"===n.role&&n.color===t&&(e.check=o)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&V(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",o="e"+t,n=e.movable.dests.get(o),r=e.pieces.get(o);if(!n||!r||"king"!==r.role)return;e.movable.dests.set(o,n.filter((e=>!(e==="a"+t&&n.includes("c"+t)||e==="h"+t&&n.includes("g"+t)))))}}function le(e,t){for(const o in t)de(e[o])&&de(t[o])?le(e[o],t[o]):e[o]=t[o]}function de(e){return"object"==typeof e}function ue(e,t){return t.animation.enabled?function(e,t){const o=new Map(t.pieces),n=e(t),r=function(e,t){const o=new Map,n=[],r=new Map,a=[],s=[],i=new Map;let c,l,d;for(const[t,o]of e)i.set(t,fe(t,o));for(const e of h)c=t.pieces.get(e),l=i.get(e),c?l?k(c,l.piece)||(a.push(l),s.push(fe(e,c))):s.push(fe(e,c)):l&&a.push(l);for(const e of s)l=he(e,a.filter((t=>k(e.piece,t.piece)))),l&&(d=[l.pos[0]-e.pos[0],l.pos[1]-e.pos[1]],o.set(e.key,d.concat(d)),n.push(l.key));for(const e of a)n.includes(e.key)||r.set(e.key,e.piece);return{anims:o,fadings:r}}(o,t);if(r.anims.size||r.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},e||ge(t,performance.now())}else t.dom.redraw();return n}(e,t):pe(e,t)}function pe(e,t){const o=e(t);return t.dom.redraw(),o}function fe(e,t){return{key:e,pos:m(e),piece:t}}function he(e,t){return t.sort(((t,o)=>y(e.pos,t.pos)-y(e.pos,o.pos)))[0]}function ge(e,t){const o=e.animation.current;if(void 0===o)return void(e.dom.destroyed||e.dom.redrawNow());const n=1-(t-o.start)*o.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=(r=n)<.5?4*r*r*r:(r-1)*(2*r-2)*(2*r-2)+1;for(const e of o.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>ge(e,t)))}var r}const me=["green","red","blue","yellow"];function be(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?G(e):ee(e);const o=q(t),n=oe(o,ne(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:o,brush:Ce(t),snapToValidMove:e.drawable.defaultSnapToValidMove},ve(e))}function ve(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const o=oe(t.pos,ne(e),e.dom.bounds());o||(t.snapToValidMove=!1);const n=t.snapToValidMove?function(e,t,o,n){const r=m(e),a=b.filter((e=>B(r[0],r[1],e[0],e[1])||D(r[0],r[1],e[0],e[1]))),s=a.map((e=>N(g(e),o,n))).map((e=>y(t,e))),[,i]=s.reduce(((e,t,o)=>e[0]<t?e:[t,o]),[s[0],0]);return g(a[i])}(t.orig,t.pos,ne(e),e.dom.bounds()):o;n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),ve(e)}}))}function we(e,t){e.drawable.current&&(e.drawable.current.pos=q(t))}function ye(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const o=e=>e.orig===t.orig&&e.dest===t.dest,n=e.shapes.find(o);n&&(e.shapes=e.shapes.filter((e=>!o(e))));n&&n.brush===t.brush||e.shapes.push(t);$e(e)}(e.drawable,t),ke(e))}function ke(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Ce(e){var t;const o=(e.shiftKey||e.ctrlKey)&&L(e),n=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return me[(o?1:0)+(n?2:0)]}function $e(e){e.onChange&&e.onChange(e.shapes)}function xe(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const o=e.dom.bounds(),n=q(t),r=oe(n,ne(e),o);if(!r)return;const a=e.pieces.get(r),s=e.selected;var i;s||!e.drawable.enabled||!e.drawable.eraseOnClick&&a&&a.color===e.turnColor||(i=e).drawable.shapes.length&&(i.drawable.shapes=[],i.dom.redraw(),$e(i.drawable)),!1===t.cancelable||t.touches&&e.movable.color&&!a&&!s&&!function(e,t){const o=ne(e),n=e.dom.bounds(),r=Math.pow(n.width/8,2);for(const a in e.pieces){const e=N(a,o,n);if(y(e,t)<=r)return!0}return!1}(e,n)||t.preventDefault();const c=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Y(e,e.selected,r)?ue((e=>Q(e,r)),e):Q(e,r);const d=e.selected===r,u=Le(e,r);if(a&&u&&d&&function(e,t){const o=e.pieces.get(t);return!!o&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}(e,r)){e.draggable.current={orig:r,piece:a,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:s,originTarget:t.target},u.cgDragging=!0,u.classList.add("dragging");const i=e.dom.elements.ghost;i&&(i.className=`ghost ${a.color} ${a.role}`,S(i,x(o)(m(r),ne(e))),A(i,!0)),Me(e)}else c&&z(e),l&&F(e);e.dom.redraw()}function Me(e){requestAnimationFrame((()=>{var t;const o=e.draggable.current;if(!o)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(o.orig))&&(e.animation.current=void 0);const n=e.pieces.get(o.orig);if(n&&k(n,o.piece)){if(!o.started&&y(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if("function"==typeof o.element){const e=o.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),o.element=e}const t=e.dom.bounds();S(o.element,[o.pos[0]-t.left-t.width/16,o.pos[1]-t.top-t.height/16])}}else Ae(e);Me(e)}))}function Se(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=q(t))}function Pe(e,t){const o=e.draggable.current;if(!o)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&o.originTarget!==t.target&&!o.newPiece)return void(e.draggable.current=void 0);z(e),F(e);const n=oe(q(t)||o.pos,ne(e),e.dom.bounds());n&&o.started&&o.orig!==n?o.newPiece?H(e,o.orig,n,o.force):(e.stats.ctrlKey=t.ctrlKey,X(e,o.orig,n)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!n&&(e.pieces.delete(o.orig),R(e.events.change)),(o.orig!==o.previouslySelected||o.orig!==n&&n)&&e.selectable.enabled||G(e),qe(e),e.draggable.current=void 0,e.dom.redraw()}function Ae(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,G(e),qe(e),e.dom.redraw())}function qe(e){const t=e.dom.elements;t.ghost&&A(t.ghost,!1)}function Le(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&"PIECE"===o.tagName)return o;o=o.nextSibling}}function Ee(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Ne(e,t){function o(){!function(e){e.orientation=w(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&o(),(t.fen?ue:pe)((e=>ce(e,t)),e)},state:e,getFen:()=>{return t=e.pieces,f.map((e=>u.map((o=>{const n=t.get(o+e);if(n){const e=se[n.role];return"white"===n.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:o,setPieces(t){ue((e=>function(e,t){for(const[o,n]of t)n?e.pieces.set(o,n):e.pieces.delete(o)}(e,t)),e)},selectSquare(t,o){t?ue((e=>Q(e,t,o)),e):e.selected&&(G(e),e.dom.redraw())},move(t,o){ue((e=>I(e,t,o)),e)},newPiece(t,o){ue((e=>W(e,t,o)),e)},playPremove(){if(e.premovable.current){if(ue(J,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const o=function(e,t){const o=e.predroppable.current;let n=!1;if(!o)return!1;t(o)&&W(e,{role:o.role,color:e.movable.color},o.key)&&(R(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),n=!0);return F(e),n}(e,t);return e.dom.redraw(),o}return!1},cancelPremove(){pe(z,e)},cancelPredrop(){pe(F,e)},cancelMove(){pe((e=>{ee(e),Ae(e)}),e)},stop(){pe((e=>{te(e),Ae(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{Ee(e,2),setTimeout((()=>Ee(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){pe((e=>e.drawable.autoShapes=t),e)},setShapes(t){pe((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>oe(t,ne(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,o,n){!function(e,t,o,n){const r="a0";e.pieces.set(r,t),e.dom.redraw();const a=q(o);e.draggable.current={orig:r,piece:t,origPos:a,pos:a,started:!0,element:()=>Le(e,r),originTarget:o.target,newPiece:!0,force:!!n},Me(e)}(e,t,o,n)},destroy(){te(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Ke(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function De(e,t,o){const n=e.drawable,r=n.current,a=r&&r.mouseSq?r:void 0,s=new Map,i=e.dom.bounds();for(const e of n.shapes.concat(n.autoShapes).concat(a?[a]:[]))e.dest&&s.set(e.dest,(s.get(e.dest)||0)+1);const c=n.shapes.concat(n.autoShapes).map((e=>({shape:e,current:!1,hash:Te(e,s,!1,i)})));a&&c.push({shape:a,current:!0,hash:Te(a,s,!0,i)});const l=c.map((e=>e.hash)).join(";");if(l===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=l;const d=t.querySelector("defs"),u=t.querySelector("g"),p=o.querySelector("g");!function(e,t,o){const n=new Map;let r;for(const o of t)o.shape.dest&&(r=e.brushes[o.shape.brush],o.shape.modifiers&&(r=We(r,o.shape.modifiers)),n.set(r.key,r));const a=new Set;let s=o.firstChild;for(;s;)a.add(s.getAttribute("cgKey")),s=s.nextSibling;for(const[e,t]of n.entries())a.has(e)||o.appendChild(ze(t))}(n,c,d),Oe(e,c.filter((e=>!e.shape.customSvg)),n.brushes,s,u),Oe(e,c.filter((e=>e.shape.customSvg)),n.brushes,s,p)}function Oe(e,t,o,n,r){const a=e.dom.bounds(),s=new Map,i=[];for(const e of t)s.set(e.hash,!1);let c,l=r.firstChild;for(;l;)c=l.getAttribute("cgHash"),s.has(c)?s.set(c,!0):i.push(l),l=l.nextSibling;for(const e of i)r.removeChild(e);for(const i of t)s.get(i.hash)||r.appendChild(Re(e,i,o,n,a))}function Te({orig:e,dest:t,brush:o,piece:n,modifiers:r,customSvg:a},s,i,c){return[c.width,c.height,i,e,t,o,t&&(s.get(t)||0)>1,n&&Be(n),r&&(l=r,""+(l.lineWidth||"")),a&&je(a)].filter((e=>e)).join(",");var l}function Be(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function je(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return"custom-"+t.toString()}function Re(e,{shape:t,current:o,hash:n},r,a,s){let i;if(t.customSvg){const o=Ie(m(t.orig),e.orientation);i=function(e,t,o){const{width:n,height:r}=o,a=n/8,s=r/8,i=t[0]*a,c=(7-t[1])*s,l=Fe(Ke("g"),{transform:`translate(${i},${c})`}),d=Fe(Ke("svg"),{width:a,height:s,viewBox:"0 0 100 100"});return l.appendChild(d),d.innerHTML=e,l}(t.customSvg,o,s)}else if(t.piece)i=function(e,t,o,n){const r=He(t,n),a=n.width/8*(o.scale||1),s=o.color[0]+("knight"===o.role?"n":o.role[0]).toUpperCase();return Fe(Ke("image"),{className:`${o.role} ${o.color}`,x:r[0]-a/2,y:r[1]-a/2,width:a,height:a,href:e+s+".svg"})}(e.drawable.pieces.baseUrl,Ie(m(t.orig),e.orientation),t.piece,s);else{const n=Ie(m(t.orig),e.orientation);if(t.dest){let c=r[t.brush];t.modifiers&&(c=We(c,t.modifiers)),i=function(e,t,o,n,r,a){const s=function(e,t){return(t?20:10)/512*e.width}(a,r&&!n),i=He(t,a),c=He(o,a),l=c[0]-i[0],d=c[1]-i[1],u=Math.atan2(d,l),p=Math.cos(u)*s,f=Math.sin(u)*s;return Fe(Ke("line"),{stroke:e.color,"stroke-width":Ue(e,n,a),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:Xe(e,n),x1:i[0],y1:i[1],x2:c[0]-p,y2:c[1]-f})}(c,n,Ie(m(t.dest),e.orientation),o,(a.get(t.dest)||0)>1,s)}else i=function(e,t,o,n){const r=He(t,n),a=function(e){const t=e.width/512;return[3*t,4*t]}(n),s=(n.width+n.height)/32;return Fe(Ke("circle"),{stroke:e.color,"stroke-width":a[o?0:1],fill:"none",opacity:Xe(e,o),cx:r[0],cy:r[1],r:s-a[1]/2})}(r[t.brush],n,o,s)}return i.setAttribute("cgHash",n),i}function ze(e){const t=Fe(Ke("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(Fe(Ke("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Fe(e,t){for(const o in t)e.setAttribute(o,t[o]);return e}function Ie(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function We(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function Ue(e,t,o){return(e.lineWidth||10)*(t?.85:1)/512*o.width}function Xe(e,t){return(e.opacity||1)*(t?.9:1)}function He(e,t){return[(e[0]+.5)*t.width/8,(7.5-e[1])*t.height/8]}function Qe(e,t){const o=E("coords",t);let n;for(const t of e)n=E("coord"),n.textContent=t,o.appendChild(n);return o}function Ve(e,t){const o=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(o)}if(e.viewOnly)return;const n=function(e){return t=>{e.draggable.current?Ae(e):e.drawable.current?ke(e):t.shiftKey||L(t)?e.drawable.enabled&&be(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;z(e),F(e);const o=e.dropmode.piece;if(o){e.pieces.set("a0",o);const n=q(t),r=n&&oe(n,ne(e),e.dom.bounds());r&&H(e,"a0",r)}e.dom.redraw()}(e,t):xe(e,t))}}(e);o.addEventListener("touchstart",n,{passive:!1}),o.addEventListener("mousedown",n,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",(e=>e.preventDefault()))}function Ge(e,t,o,n){return e.addEventListener(t,o,n),()=>e.removeEventListener(t,o,n)}function Ze(e,t,o){return n=>{e.drawable.current?e.drawable.enabled&&o(e,n):e.viewOnly||t(e,n)}}function Ye(e){const t=ne(e),o=e.dom.relative?M:x(e.dom.bounds()),n=e.dom.relative?P:S,r=e.dom.elements.board,a=e.pieces,s=e.animation.current,i=s?s.plan.anims:new Map,c=s?s.plan.fadings:new Map,l=e.draggable.current,d=function(e){var t;const o=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)nt(o,t,"last-move");e.check&&e.highlight.check&&nt(o,e.check,"check");if(e.selected&&(nt(o,e.selected,"selected"),e.movable.showDests)){const n=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(n)for(const t of n)nt(o,t,"move-dest"+(e.pieces.has(t)?" oc":""));const r=e.premovable.dests;if(r)for(const t of r)nt(o,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const n=e.premovable.current;if(n)for(const e of n)nt(o,e,"current-premove");else e.predroppable.current&&nt(o,e.predroppable.current.key,"current-premove");const r=e.exploding;if(r)for(const e of r.keys)nt(o,e,"exploding"+r.stage);return o}(e),u=new Set,p=new Set,f=new Map,h=new Map;let g,b,v,w,y,k,C,$,A,q;for(b=r.firstChild;b;){if(g=b.cgKey,_e(b))if(v=a.get(g),y=i.get(g),k=c.get(g),w=b.cgPiece,!b.cgDragging||l&&l.orig===g||(b.classList.remove("dragging"),n(b,o(m(g),t)),b.cgDragging=!1),!k&&b.cgFading&&(b.cgFading=!1,b.classList.remove("fading")),v){if(y&&b.cgAnimating&&w===ot(v)){const e=m(g);e[0]+=y[2],e[1]+=y[3],b.classList.add("anim"),n(b,o(e,t))}else b.cgAnimating&&(b.cgAnimating=!1,b.classList.remove("anim"),n(b,o(m(g),t)),e.addPieceZIndex&&(b.style.zIndex=tt(m(g),t)));w!==ot(v)||k&&b.cgFading?k&&w===ot(k)?(b.classList.add("fading"),b.cgFading=!0):rt(f,w,b):u.add(g)}else rt(f,w,b);else if(Je(b)){const e=b.className;d.get(g)===e?p.add(g):rt(h,e,b)}b=b.nextSibling}for(const[e,a]of d)if(!p.has(e)){A=h.get(a),q=A&&A.pop();const s=o(m(e),t);if(q)q.cgKey=e,n(q,s);else{const t=E("square",a);t.cgKey=e,n(t,s),r.insertBefore(t,r.firstChild)}}for(const[s,c]of a)if(y=i.get(s),!u.has(s))if(C=f.get(ot(c)),$=C&&C.pop(),$){$.cgKey=s,$.cgFading&&($.classList.remove("fading"),$.cgFading=!1);const r=m(s);e.addPieceZIndex&&($.style.zIndex=tt(r,t)),y&&($.cgAnimating=!0,$.classList.add("anim"),r[0]+=y[2],r[1]+=y[3]),n($,o(r,t))}else{const a=ot(c),i=E("piece",a),l=m(s);i.cgPiece=a,i.cgKey=s,y&&(i.cgAnimating=!0,l[0]+=y[2],l[1]+=y[3]),n(i,o(l,t)),e.addPieceZIndex&&(i.style.zIndex=tt(l,t)),r.appendChild(i)}for(const t of f.values())et(e,t);for(const t of h.values())et(e,t)}function _e(e){return"PIECE"===e.tagName}function Je(e){return"SQUARE"===e.tagName}function et(e,t){for(const o of t)e.dom.elements.board.removeChild(o)}function tt(e,t){let o=2+8*e[1]+(7-e[0]);return t&&(o=67-o),o+""}function ot(e){return`${e.color} ${e.role}`}function nt(e,t,o){const n=e.get(t);n?e.set(t,`${n} ${o}`):e.set(t,o)}function rt(e,t,o){const n=e.get(t);n?n.push(o):e.set(t,[o])}function at(e,t){const o={pieces:ie(re),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:v()};function n(){const t="dom"in o?o.dom.unbind:void 0,n=o.viewOnly&&!o.drawable.visible,r=function(e,t,o){e.innerHTML="",e.classList.add("cg-wrap");for(const o of d)e.classList.toggle("orientation-"+o,t.orientation===o);e.classList.toggle("manipulable",!t.viewOnly);const n=E("cg-helper");e.appendChild(n);const r=E("cg-container");n.appendChild(r);const a=E("cg-board");let s,i,c;if(r.appendChild(a),t.drawable.visible&&!o&&(s=Fe(Ke("svg"),{class:"cg-shapes"}),s.appendChild(Ke("defs")),s.appendChild(Ke("g")),i=Fe(Ke("svg"),{class:"cg-custom-svgs"}),i.appendChild(Ke("g")),r.appendChild(s),r.appendChild(i)),t.coordinates){const e="black"===t.orientation?" black":"";r.appendChild(Qe(p,"ranks"+e)),r.appendChild(Qe(u,"files"+e))}return t.draggable.showGhost&&!o&&(c=E("piece","ghost"),A(c,!1),r.appendChild(c)),{board:a,container:r,ghost:c,svg:s,customSvg:i}}(e,o,n),a=function(e){let t;const o=()=>(void 0===t&&(t=e()),t);return o.clear=()=>{t=void 0},o}((()=>r.board.getBoundingClientRect())),s=e=>{Ye(c),!e&&r.svg&&De(c,r.svg,r.customSvg)},i=()=>{a.clear(),function(e){if(e.dom.relative)return;const t=ne(e),o=x(e.dom.bounds());let n=e.dom.elements.board.firstChild;for(;n;)(_e(n)&&!n.cgAnimating||Je(n))&&S(n,o(m(n.cgKey),t)),n=n.nextSibling}(c),r.svg&&De(c,r.svg,r.customSvg)},c=o;return c.dom={elements:r,bounds:a,redraw:st(s),redrawNow:s,unbind:t,relative:n},c.drawable.prevSvgHash="",s(!1),Ve(c,i),t||(c.dom.unbind=function(e,t){const o=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||o.push(Ge(document.body,"chessground.resize",t)),!e.viewOnly){const t=Ze(e,Se,we),n=Ze(e,Pe,ye);for(const e of["touchmove","mousemove"])o.push(Ge(document,e,t));for(const e of["touchend","mouseup"])o.push(Ge(document,e,n));const r=()=>e.dom.bounds.clear();o.push(Ge(document,"scroll",r,{capture:!0,passive:!0})),o.push(Ge(window,"resize",r,{passive:!0}))}return()=>o.forEach((e=>e()))}(c,i)),c.events.insert&&c.events.insert(r),c}return ce(o,t||{}),Ne(n(),n)}function st(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}function it(e,t,o,n){if(0===t)return;const r=document.createElement("cg-resize");e.container.appendChild(r);const a=e=>{e.preventDefault();const t="touchstart"===e.type?"touchmove":"mousemove",o="touchstart"===e.type?"touchend":"mouseup",n=ct(e),r=parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"));let a=r;const s=function(e,t,o=!1){let n,r=0;return function(...a){const s=this;n&&clearTimeout(n),n=void 0;const i=performance.now()-r;r=performance.now(),o&&i>t?e.apply(s,a):n=setTimeout((()=>{n=void 0,e.apply(s,a)}),t)}}((()=>c(`/pref/zoom?v=${100+a}`,{method:"post"})),700),i=e=>{const t=ct(e),o=t[0]-n[0]+t[1]-n[1];a=Math.round(Math.min(100,Math.max(0,r+o/10))),document.body.setAttribute("style","--zoom:"+a),window.dispatchEvent(new Event("resize")),s()};document.body.classList.add("resizing"),document.addEventListener(t,i),document.addEventListener(o,(()=>{document.removeEventListener(t,i),document.body.classList.remove("resizing")}),{once:!0})};if(r.addEventListener("touchstart",a,{passive:!1}),r.addEventListener("mousedown",a,{passive:!1}),1===t){const e=e=>r.classList.toggle("none",n?!n(e):e>=2);e(o),lichess.pubsub.on("ply",e)}}function ct(e){var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0}function lt(e){const t=e.data.pref,o=e.makeCgOpts(),n={turnColor:o.turnColor,fen:o.fen,check:o.check,lastMove:o.lastMove,orientation:e.bottomColor(),coordinates:0!==t.coords&&!e.embed,addPieceZIndex:t.is3d,viewOnly:!!e.embed,movable:{free:!1,color:o.movable.color,dests:o.movable.dests,showDests:t.destination,rookCastle:t.rookCastle},events:{move:e.userMove,dropNewPiece:e.userNewPiece,insert(t){e.embed||it(t,2,e.node.ply),e.embed||1!=e.data.pref.coords||(()=>{const e={blue:"#DEE3E6 #788a94",blue2:"#97b2c7 #546f82",blue3:"#d9e0e6 #315991",canvas:"#d7daeb #547388",wood:"#d8a45b #9b4d0f",wood2:"#a38b5d #6c5017",wood3:"#d0ceca #755839",wood4:"#caaf7d #7b5330",maple:"#e8ceab #bc7944",maple2:"#E2C89F #996633",leather:"#d1d1c9 #c28e16",green:"#FFFFDD #6d8753",brown:"#F0D9B5 #946f51",pink:"#E8E9B7 #ED7272",marble:"#93ab91 #4f644e","blue-marble":"#EAE6DD #7C7F87","green-plastic":"#f2f9bb #59935d",grey:"#b8b8b8 #7d7d7d",metal:"#c9c9c9 #727272",olive:"#b8b19f #6d6655",newspaper:"#fff #8d8d8d",purple:"#9f90b0 #7d4a8d","purple-diag":"#E5DAF0 #957AB0",ic:"#ececec #c1c18e",horsey:"#F0D9B5 #946f51"};for(const t of document.body.className.split(" "))if(t in e){const o=document.documentElement.style,n=e[t].split(" ");o.setProperty("--cg-coord-color-white",n[0]),o.setProperty("--cg-coord-color-black",n[1]),o.setProperty("--cg-coord-shadow","none")}})()}},premovable:{enabled:o.premovable.enabled,showDests:t.destination,events:{set:e.onPremoveSet}},drawable:{enabled:!e.embed,eraseOnClick:!e.opts.study||!!e.opts.practice,defaultSnapToValidMove:"0"!=(lichess.storage.get("arrow.snap")||1)},highlight:{lastMove:t.highlight,check:t.highlight},animation:{duration:t.animationDuration},disableContextMenu:!0};return e.study&&e.study.mutateCgConfig(n),n}function dt(e){return{choices:e.choices,get:()=>e.storage.get()||e.default,set:t=>(e.storage.set(t),t)}}function ut(e,t){const o=e.get();return a("select",{hook:{insert(o){o.elm.addEventListener("change",(o=>{e.set(o.target.value),t()}))}}},e.choices.map((e=>{const[t,n]=e;return a("option",{attrs:{value:""+t,selected:t===o}},n)})))}const pt={a:"alpha",b:"bravo",c:"charlie",d:"delta",e:"echo",f:"foxtrot",g:"golf",h:"hotel"},ft={a:"anna",b:"bella",c:"cesar",d:"david",e:"eva",f:"felix",g:"gustav",h:"hector"},ht={P:"pawn",R:"rook",N:"knight",B:"bishop",Q:"queen",K:"king"},gt={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"},mt={p:"p",r:"r",n:"n",b:"b",q:"q",k:"k",P:"p",R:"r",N:"n",B:"b",Q:"q",K:"k"},bt={p:"p",r:"r",n:"n",b:"b",q:"q",k:"k",P:"P",R:"R",N:"N",B:"B",Q:"Q",K:"K"},vt={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king",P:"pawn",R:"rook",N:"knight",B:"bishop",Q:"queen",K:"king"},wt={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king",P:"Pawn",R:"Rook",N:"Knight",B:"Bishop",Q:"Queen",K:"King"},yt={"!":"a","@":"b","#":"c",$:"d","%":"e","^":"f","&":"g","*":"h"};function kt(e,t,o){if(!e)return"";let n;return n=e.includes("O-O-O")?"long castling":e.includes("O-O")?"short castling":"san"===o?e.replace(/[\+#]/,""):"uci"===o?t||e:e.replace(/[\+#]/,"").split("").map((e=>{if("x"==e)return"takes";if("+"==e)return"check";if("#"==e)return"checkmate";if("="==e)return"promotion";const t=e.charCodeAt(0);return t>48&&t<58?e:t>96&&t<105?xt(e,o):ht[e]||e})).join(" "),e.includes("+")&&(n+=" check"),e.includes("#")&&(n+=" checkmate"),n}function Ct(e,t){return a("div",["white","black"].map((o=>{const n=[];return["king","queen","rook","bishop","knight","pawn"].forEach((t=>{const r=[];for(const[n,a]of e)a.color===o&&a.role===t&&r.push(n);r.length&&n.push([`${t}${r.length>1?"s":""}`,...r])})),a("div",[a("h3",`${o} pieces`),...n.map((e=>`${e[0]}: ${e.slice(1).map((e=>Mt(e,t))).join(", ")}`)).join(", ")])})))}function $t(e,t,o,n,r,s){const i=e=>a("th",{attrs:{scope:"row"}},e),c=()=>{const e=u.map((e=>a("th",{attrs:{scope:"col"}},e)));return"black"===t&&e.reverse(),a("tr",[a("td"),...e,a("td")])},l=(e,t,o)=>{switch(r){case"before":return t.toUpperCase()+e+" "+o;case"after":return o+" "+t.toUpperCase()+e;case"none":return o}},d=(e,t,o,n,r)=>a("button",{attrs:{rank:e,file:t,piece:o.toLowerCase(),color:n}},r),p=(t,r)=>{const i=r+t,c=e.get(i),u="table"===s?"td":"span";if(c){const e=gt[c.role],s=((e,t)=>{switch(t){case"letter":return mt[e];case"white uppercase letter":return bt[e];case"name":return vt[e];case"white uppercase name":return wt[e]}})("white"===c.color?e.toUpperCase():e,o),i=((e,t)=>{switch(t){case"letter":return e.charAt(0);case"name":return e+" ";case"none":return""}})(c.color,n),p=l(t,r,i+s);return a(u,d(t,r,e,c.color,p))}{const e=(i.charCodeAt(0)+i.charCodeAt(1))%2?"-":"+",o=l(t,r,e);return a(u,d(t,r,e,"none",o))}},h=[];return"table"===s&&h.push(c()),h.push(...f.map((e=>((e,t)=>{const o=[];return"table"===s&&o.push(i(t)),o.push(...u.map((e=>p(t,e)))),"table"===s&&o.push(i(t)),"black"===e&&o.reverse(),a("table"===s?"tr":"div",o)})(t,e)))),"table"===s&&h.push(c()),"black"===t&&h.reverse(),a("table"===s?"table.board-wrapper":"div.board-wrapper",h)}function xt(e,t){return"nato"===t?pt[e]:"anna"===t?ft[e]:e}function Mt(e,t){return`${xt(e[0],t)} ${e[1]}`}function St(){return e=>{var t,o;const n=$(e.target),r=null!==(t=n.attr("file"))&&void 0!==t?t:"",a=null!==(o=n.attr("rank"))&&void 0!==o?o:"";let s="",i="";if(e.key.match(/^[1-8]$/))s=e.key,i=r;else{if(!e.key.match(/^[!@#$%^&*]$/))return!0;s=a,i=function(e){var t;return null!==(t=yt[e])&&void 0!==t?t:""}(e.key)}const c=document.querySelector('.board-wrapper button[rank="'+s+'"][file="'+i+'"]');return!c||(c.focus(),!1)}}class Pt{constructor(e,t=3e3){this.redraw=e,this.timeout=t,this.set=e=>{this.notification&&this.notification.text==e&&(e+=" "),this.notification={text:e,date:new Date},lichess.requestIdleCallback(this.redraw,500)},this.currentText=()=>this.notification&&this.notification.date.getTime()>Date.now()-this.timeout?this.notification.text:"",this.render=()=>a("div.notify",{attrs:{"aria-live":"assertive","aria-atomic":"true"}},this.currentText())}}const At={piece:{help:"p: Read locations of a piece type. Example: p N, p k.",apply:(e,t,o)=>qt(e,/^p ([p|n|b|r|q|k])$/i,(e=>function(e,t,o){const n=`${t===t.toUpperCase()?"white":"black"} ${ht[t.toUpperCase()]}`,r=[];for(const[t,o]of e)o&&`${o.color} ${o.role}`===n&&r.push(t);return`${n}: ${r.length?r.map((e=>Mt(e,o))).join(", "):"none"}`}(t,e,o)))},scan:{help:"s: Read pieces on a rank or file. Example: s a, s 1.",apply:(e,t,o)=>qt(e,/^s ([a-h1-8])$/i,(e=>function(e,t,o){const n=[];for(const r of h)if(r.includes(t)){const t=e.get(r);t&&n.push(`${Mt(r,o)} ${t.color} ${t.role}`)}return n.length?n.join(", "):"blank"}(t,e,o)))}};function qt(e,t,o){if(e.match(t))return o(e.replace(t,"$1"))}lichess.storage,[...Array(8).keys()].map((e=>a(3===e?"tick.zero":"tick",{attrs:{style:`height: ${12.5*(e+1)}%`}}))),lichess.storage.make("ceval.disable").listen((()=>{const e=document.getElementById("analyse-toggle-ceval");(null==e?void 0:e.checked)&&e.click()}));const Lt=e=>Math.floor((e-1)/2)+1;function Et(e,t,o){return function(e){return{insert:t=>e(t.elm)}}((n=>function(e,t,o,n){e.addEventListener(t,(e=>{const t=o(e);return!1===t&&e.preventDefault(),n&&n(),t}))}(n,e,t,o)))}const Nt=e=>function(e,t){let o,n=0;return function(...r){const a=this,s=performance.now()-n;function i(){o=void 0,n=performance.now(),t.apply(a,r)}o&&clearTimeout(o),s>e?i():o=setTimeout(i,e-s)}}(100,(()=>lichess.sound.play(e))),Kt=Nt("select"),Dt=Nt("wrapAround"),Ot=Nt("outOfBound"),Tt=Nt("error");lichess.AnalyseNVUI=function(e){const t=new Pt(e),o=dt({choices:[["san","SAN: Nxf3"],["uci","UCI: g1f3"],["literate","Literate: knight takes f 3"],["anna","Anna: knight takes felix 3"],["nato","Nato: knight takes foxtrot 3"]],default:"anna",storage:lichess.storage.make("nvui.moveNotation")}),n=dt({choices:[["letter","Letter: p, p"],["white uppercase letter","White uppecase letter: P, p"],["name","Name: pawn, pawn"],["white uppercase name","White uppercase name: Pawn, pawn"]],default:"letter",storage:lichess.storage.make("nvui.pieceStyle")}),r=dt({choices:[["letter","Letter: w/b"],["name","Name: white/black"],["none","None"]],default:"letter",storage:lichess.storage.make("nvui.prefixStyle")}),s=dt({choices:[["before","before: c2: wp"],["after","after: wp: c2"],["none","none"]],default:"before",storage:lichess.storage.make("nvui.positionStyle")}),i=dt({choices:[["plain","plain: layout with no semantic rows or columns"],["table","table: layout using a table with rank and file columns and row headers"]],default:"plain",storage:lichess.storage.make("nvui.boardLayout")}),c=(e=>{let t=e;return function(e){return(e=>void 0!==e)(e)&&(t=e),t}})(!1);return lichess.pubsub.on("analysis.server.progress",(e=>{e.analysis&&!e.analysis.partial&&t.set("Server-side analysis complete")})),{render(e){const l=e.data,d=o.get();return e.chessground||(e.chessground=at(document.createElement("div"),Object.assign(Object.assign({},lt(e)),{animation:{enabled:!1},drawable:{enabled:!1},coordinates:!1}))),a("main.analyse",[a("div.nvui",[a("h1","Textual representation"),a("h2","Game info"),...["white","black"].map((t=>a("p",[t+" player: ",Ut(e,Xt(l,t))]))),a("p",`${l.game.rated?"Rated":"Casual"} ${l.game.perf}`),l.clock?a("p",`Clock: ${l.clock.initial/60} + ${l.clock.increment}`):null,a("h2","Moves"),a("p.moves",{attrs:{role:"log","aria-live":"off"}},Ft(e.mainline,e.path,d)),a("h2","Pieces"),a("div.pieces",Ct(e.chessground.state.pieces,d)),a("h2","Current position"),a("p.position",{attrs:{"aria-live":"assertive","aria-atomic":"true"}},It(e.node,d)),a("h2","Move form"),a("form",{hook:{insert(n){const r=$(n.elm),a=r.find(".move").val("");a[0].focus(),r.on("submit",function(e,t,o,n){return function(){let r=n.val().trim();return function(e){return Bt.includes(e.split(" ")[0])}(r)&&(r="/"+r),"/"===r[0]?function(e,t,o,n){const r=e.chessground.state.pieces;t(At.piece.apply(o,r,n)||At.scan.apply(o,r,n)||`Invalid command: ${o}`)}(e,t,r.slice(1),o()):t("Invalid command"),n.val(""),!1}}(e,t.set,o.get,a))}}},[a("label",["Command input",a("input.move.mousetrap",{attrs:{name:"move",type:"text",autocomplete:"off",autofocus:!0}})])]),t.render(),a("h2","Computer analysis"),...Rt(e,d)||[zt(e,c,t.set)],a("h2","Board"),a("div.board",{hook:{insert:t=>{const o=$(t.elm);o.on("keypress",(e=>{var t,o;const n=$(e.target),r=$(".boardstatus"),a=(null!==(t=n.attr("file"))&&void 0!==t?t:"")+(null!==(o=n.attr("rank"))&&void 0!==o?o:"");if("o"===e.key)return r.text(),r.text(a),!1;if("l"===e.key){const e=$("p.lastMove").text();return r.text(),r.text(e),!1}return"t"!==e.key||(r.text(),r.text($(".nvui .botc").text()+", "+$(".nvui .topc").text()),!1)}));const n=o.find("button");n.on("click",function(e,t){return o=>{var n,r;const a=$(o.target),s=a.attr("rank"),i=(null!==(n=a.attr("file"))&&void 0!==n?n:"")+s,c=$(".boardstatus"),l="black"===e?"8":"1",d=$(document.querySelector("input.move"));if(!d)return!1;if(""===d.val()){if(a.attr("color")===e)return!1;a.text().match(/^[^\-+]+/g)&&(d.val(i),t())}else{if(a.attr("color")===("black"===e?"white":"black"))return!1;const t=d.val(),o=$('.board-wrapper [file="'+t[0]+'"][rank="'+t[1]+'"]');if(d.val(d.val()+i),s===l&&"p"===(null===(r=o.attr("piece"))||void 0===r?void 0:r.toLowerCase()))return a.attr("promotion","true"),c.text("Promote to? q for queen, n for knight, r for rook, b for bishop"),!1;const n=d.parent().parent(),u=new Event("submit",{cancelable:!0,bubbles:!0});n.trigger(u)}return!1}}(e.data.opponent.color,Kt)),n.on("keydown",function(e,t){return o=>{var n;const r=$(o.target),a="white"===e;let s=null!==(n=r.attr("file"))&&void 0!==n?n:" ",i=Number(r.attr("rank"));if("ArrowUp"===o.key)i=a?i+=1:i-=1;else if("ArrowDown"===o.key)i=a?i-=1:i+=1;else if("ArrowLeft"===o.key)s=String.fromCharCode(a?s.charCodeAt(0)-1:s.charCodeAt(0)+1);else{if("ArrowRight"!==o.key)return!0;s=String.fromCharCode(a?s.charCodeAt(0)+1:s.charCodeAt(0)-1)}const c=document.querySelector('.board-wrapper [file="'+s+'"][rank="'+i+'"]');return c?c.focus():t(),o.preventDefault(),!1}}(e.data.player.color,Ot)),n.on("keypress",St()),n.on("keypress",function(e,t){return o=>{if(!o.key.match(/^[kqrbnp]$/i))return!0;const n=$(o.target);if("true"===n.attr("promotion")){const e=$("input.move"),t=$(".boardstatus"),r=o.key.toLowerCase(),a=e.parent().parent();if(!r.match(/^[qnrb]$/))return t.text("Invalid promotion piece. q for queen, n for knight, r for rook, b for bisho"),!1;e.val(e.val()+r),n.removeAttr("promotion");const s=new Event("submit",{cancelable:!0,bubbles:!0});return a.trigger(s),!1}const r='.board-wrapper [rank="'+n.attr("rank")+'"][file="'+n.attr("file")+'"]',a=$('.board-wrapper [piece="'+o.key.toLowerCase()+'"], '+r),s=a.index(r),i=o.key.toLowerCase()===o.key,c=i?a.slice(s+1):a.slice(0,s),l=i?c.get(0):c.get(c.length-1);if(l)l.focus();else if(a.length>=2){const t=i?a.get(0):a.get(a.length-1);null==t||t.focus(),e()}else t();return!1}}(Dt,Tt))}}},$t(e.chessground.state.pieces,e.data.player.color,n.get(),r.get(),s.get(),i.get())),a("div.content",{hook:{insert:e=>{const o=$(e.elm);o.append($(".blind-content").removeClass("none")),o.find(".copy-pgn").on("click",(()=>{o.find(".game-pgn").attr("type","text")[0].select(),document.execCommand("copy"),o.find(".game-pgn").attr("type","hidden"),t.set("PGN copied into clipboard.")}))}}}),a("h2","Settings"),a("label",["Move notation",ut(o,e.redraw)]),a("h3","Board Settings"),a("label",["Piece style",ut(n,e.redraw)]),a("label",["Piece prefix style",ut(r,e.redraw)]),a("label",["Show position",ut(s,e.redraw)]),a("label",["Board layout",ut(i,e.redraw)]),a("h2","Keyboard shortcuts"),a("p",["Use arrow keys to navigate in the game."]),a("h2","Board Mode commands"),a("p",["Use these commands when focused on the board itself.",a("br"),"o: announce current position.",a("br"),"c: announce last move's captured piece.",a("br"),"l: display last move.",a("br"),"t: display clocks.",a("br"),"arrow keys: move left, right, up or down.",a("br"),"kqrbnp/KQRBNP: move forward/backward to a piece.",a("br"),"1-8: move to rank 1-8.",a("br"),"Shift+1-8: move to file a-h.",a("br"),"",a("br")]),a("h2","Commands"),a("p",["Type these commands in the command input.",a("br"),At.piece.help,a("br"),At.scan.help,a("br")])])])}}};const Bt=["p","scan"];const jt=["?!","?","??"];function Rt(e,t){const o=e.data.analysis;if(!o)return;const n=e.mainline.filter((e=>(e.glyphs||[]).find((e=>jt.includes(e.symbol))))),r=[];return["white","black"].forEach((s=>{const i=o[s].acpl;r.push(a("h3",`${s} player: ${i} ACPL`)),r.push(a("select",{hook:Et("change",(t=>{e.jumpToMain(parseInt(t.target.value)),e.redraw()}))},n.filter((e=>e.ply%2==1==("white"===s))).map((o=>a("option",{attrs:{value:o.ply,selected:o.ply===e.node.ply}},[Lt(o.ply),kt(o.san,o.uci,t),Wt(o,t)].join(" "))))))})),r}function zt(e,t,o){return t()?a("p","Server-side analysis in progress"):e.ongoing||e.synthetic?void 0:a("button",{hook:Et("click",(n=>c(`/${e.data.game.id}/request-analysis`,{method:"post"}).then((()=>{t(!0),o("Server-side analysis in progress")}),(e=>o("Cannot run server-side analysis")))))},"Request a computer analysis")}function Ft(e,t,o){const n=[];let r="";return e.forEach((e=>{if(!e.san||!e.uci)return;r+=e.id;const s=[1&e.ply?Lt(e.ply)+" ":null,kt(e.san,e.uci,o)];n.push(a("move",{attrs:{p:r},class:{active:r===t}},s)),n.push(Wt(e,o)),n.push(", "),e.ply%2==0&&n.push(a("br"))})),n}function It(e,t){return e.san&&e.uci?[Lt(e.ply),kt(e.san,e.uci,t),Wt(e,t)].join(" "):"Initial position"}function Wt(e,t){return e.comments?(e.comments||[]).map((e=>function(e,t){return"lichess"===e.by?e.text.replace(/Best move was (.+)\./,((e,o)=>"Best move was "+kt(o,void 0,t))):e.text}(e,t))).join(". "):""}function Ut(e,t){return t.ai?e.trans("aiNameLevelAiLevel","Stockfish",t.ai):function(e,t){const o=e.data,n=t.user,r=n?n.perfs[o.game.perf]:null,s=t.rating?t.rating:r&&r.rating,i=t.ratingDiff,c=i?i>0?"+"+i:i<0?"−"+-i:"":"";return n?a("span",[a("a",{attrs:{href:"/@/"+n.username}},n.title?`${n.title} ${n.username}`:n.username),s?` ${s}`:""," "+c]):"Anonymous"}(e,t)}function Xt(e,t){return t===e.player.color?e.player:e.opponent}e.throttled=Nt,Object.defineProperty(e,"__esModule",{value:!0})}({});
