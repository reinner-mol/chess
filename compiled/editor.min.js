var LichessEditor=function(){"use strict";const e={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,n){return document.createElementNS(e,t,n)},createTextNode:function(e){return document.createTextNode(e)},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,n){e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){e.appendChild(t)},parentNode:function(e){return e.parentNode},nextSibling:function(e){return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType}};function t(e,t,n,r,o){return{sel:e,data:t,children:n,text:r,elm:o,key:void 0===t?void 0:t.key}}const n=Array.isArray;function r(e){return"string"==typeof e||"number"==typeof e}function o(e){return void 0===e}function s(e){return void 0!==e}const i=t("",{},[],void 0,void 0);function a(e,t){var n,r;const o=e.key===t.key,s=(null===(n=e.data)||void 0===n?void 0:n.is)===(null===(r=t.data)||void 0===r?void 0:r.is);return e.sel===t.sel&&o&&s}function c(e,t,n){var r;const o={};for(let s=t;s<=n;++s){const t=null===(r=e[s])||void 0===r?void 0:r.key;void 0!==t&&(o[t]=s)}return o}const u=["create","update","remove","destroy","pre","post"];function l(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let e=0;e<t.length;++e){const n=t[e].data;void 0!==n&&l(n,t[e].children,t[e].sel)}}function h(e,o,s){let i,a,c,u={};if(void 0!==s?(null!==o&&(u=o),n(s)?i=s:r(s)?a=s:s&&s.sel&&(i=[s])):null!=o&&(n(o)?i=o:r(o)?a=o:o&&o.sel?i=[o]:u=o),void 0!==i)for(c=0;c<i.length;++c)r(i[c])&&(i[c]=t(void 0,void 0,void 0,i[c],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||l(u,i,e),t(e,u,i,a,void 0)}function d(e,t){let n;const r=t.elm;let o=e.data.attrs,s=t.data.attrs;if((o||s)&&o!==s){for(n in o=o||{},s=s||{},s){const e=s[n];o[n]!==e&&(!0===e?r.setAttribute(n,""):!1===e?r.removeAttribute(n):120!==n.charCodeAt(0)?r.setAttribute(n,e):58===n.charCodeAt(3)?r.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,e):58===n.charCodeAt(5)?r.setAttributeNS("http://www.w3.org/1999/xlink",n,e):r.setAttribute(n,e))}for(n in o)n in s||r.removeAttribute(n)}}const p={create:d,update:d};function f(e,t){let n,r;const o=t.elm;let s=e.data.class,i=t.data.class;if((s||i)&&s!==i){for(r in s=s||{},i=i||{},s)s[r]&&!Object.prototype.hasOwnProperty.call(i,r)&&o.classList.remove(r);for(r in i)n=i[r],n!==s[r]&&o.classList[n?"add":"remove"](r)}}const m={create:f,update:f};function g(e,t,n){if("function"==typeof e)e.call(t,n,t);else if("object"==typeof e)for(let r=0;r<e.length;r++)g(e[r],t,n)}function b(e,t){const n=e.type,r=t.data.on;r&&r[n]&&g(r[n],t,e)}function v(e,t){const n=e.data.on,r=e.listener,o=e.elm,s=t&&t.data.on,i=t&&t.elm;let a;if(n!==s){if(n&&r)if(s)for(a in n)s[a]||o.removeEventListener(a,r,!1);else for(a in n)o.removeEventListener(a,r,!1);if(s){const r=t.listener=e.listener||function e(t){b(t,e.vnode)};if(r.vnode=t,n)for(a in s)n[a]||i.addEventListener(a,r,!1);else for(a in s)i.addEventListener(a,r,!1)}}}const k={create:v,update:v,destroy:v};function w(e,t){let n,r,o;const s=t.elm;let i=e.data.props,a=t.data.props;if((i||a)&&i!==a)for(n in i=i||{},a=a||{},a)r=a[n],o=i[n],o===r||"value"===n&&s[n]===r||(s[n]=r)}const y={create:w,update:w},C=["K","Q","k","q"],S=["a","b","c","d","e","f","g","h"],E=["1","2","3","4","5","6","7","8"],q=["white","black"],x=["pawn","knight","bishop","rook","queen","king"],M=["a","h"];function A(e){return"role"in e}function P(e){return e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24}function O(e){return(e=e>>>8&16711935|(16711935&e)<<8)>>>16&65535|(65535&e)<<16}function R(e){return O(e=(e=(e=e>>>1&1431655765|(1431655765&e)<<1)>>>2&858993459|(858993459&e)<<2)>>>4&252645135|(252645135&e)<<4)}class F{constructor(e,t){this.lo=e,this.hi=t,this.lo=0|e,this.hi=0|t}static fromSquare(e){return e>=32?new F(0,1<<e-32):new F(1<<e,0)}static fromRank(e){return new F(255,0).shl64(8*e)}static fromFile(e){return new F(16843009<<e,16843009<<e)}static empty(){return new F(0,0)}static full(){return new F(4294967295,4294967295)}static corners(){return new F(129,2164260864)}static center(){return new F(402653184,24)}static backranks(){return new F(255,4278190080)}static backrank(e){return"white"===e?new F(255,0):new F(0,4278190080)}static lightSquares(){return new F(1437226410,1437226410)}static darkSquares(){return new F(2857740885,2857740885)}complement(){return new F(~this.lo,~this.hi)}xor(e){return new F(this.lo^e.lo,this.hi^e.hi)}union(e){return new F(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new F(this.lo&e.lo,this.hi&e.hi)}diff(e){return new F(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?F.empty():e>=32?new F(this.hi>>>e-32,0):e>0?new F(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?F.empty():e>=32?new F(0,this.lo<<e-32):e>0?new F(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new F(O(this.hi),O(this.lo))}rbit64(){return new F(R(this.hi),R(this.lo))}minus64(e){const t=this.lo-e.lo,n=(t&e.lo&1)+(e.lo>>>1)+(t>>>1)>>>31;return new F(t,this.hi-(e.hi+n))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return P(this.lo)+P(this.hi)}isEmpty(){return 0===this.lo&&0===this.hi}nonEmpty(){return 0!==this.lo||0!==this.hi}has(e){return 0!=(e>=32?this.hi&1<<e-32:this.lo&1<<e)}set(e,t){return t?this.with(e):this.without(e)}with(e){return e>=32?new F(this.lo,this.hi|1<<e-32):new F(this.lo|1<<e,this.hi)}without(e){return e>=32?new F(this.lo,this.hi&~(1<<e-32)):new F(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new F(this.lo,this.hi^1<<e-32):new F(this.lo^1<<e,this.hi)}last(){return 0!==this.hi?63-Math.clz32(this.hi):0!==this.lo?31-Math.clz32(this.lo):void 0}first(){return 0!==this.lo?31-Math.clz32(this.lo&-this.lo):0!==this.hi?63-Math.clz32(this.hi&-this.hi):void 0}withoutFirst(){return 0!==this.lo?new F(this.lo&this.lo-1,this.hi):new F(0,this.hi&this.hi-1)}moreThanOne(){return 0!==this.hi&&0!==this.lo||0!=(this.lo&this.lo-1)||0!=(this.hi&this.hi-1)}singleSquare(){return this.moreThanOne()?void 0:this.last()}isSingleSquare(){return this.nonEmpty()&&!this.moreThanOne()}*[Symbol.iterator](){let e=this.lo,t=this.hi;for(;0!==e;){const t=31-Math.clz32(e&-e);e^=1<<t,yield t}for(;0!==t;){const e=31-Math.clz32(t&-t);t^=1<<e,yield 32+e}}*reversed(){let e=this.lo,t=this.hi;for(;0!==t;){const e=31-Math.clz32(t);t^=1<<e,yield 32+e}for(;0!==e;){const t=31-Math.clz32(e);e^=1<<t,yield t}}}class T{constructor(){}static default(){const e=new T;return e.reset(),e}static racingKings(){const e=new T;return e.occupied=new F(65535,0),e.promoted=F.empty(),e.white=new F(61680,0),e.black=new F(3855,0),e.pawn=F.empty(),e.knight=new F(6168,0),e.bishop=new F(9252,0),e.rook=new F(16962,0),e.queen=new F(129,0),e.king=new F(33024,0),e}static horde(){const e=new T;return e.occupied=new F(4294967295,4294901862),e.promoted=F.empty(),e.white=new F(4294967295,102),e.black=new F(0,4294901760),e.pawn=new F(4294967295,16711782),e.knight=new F(0,1107296256),e.bishop=new F(0,603979776),e.rook=new F(0,2164260864),e.queen=new F(0,134217728),e.king=new F(0,268435456),e}reset(){this.occupied=new F(65535,4294901760),this.promoted=F.empty(),this.white=new F(65535,0),this.black=new F(0,4294901760),this.pawn=new F(65280,16711680),this.knight=new F(66,1107296256),this.bishop=new F(36,603979776),this.rook=new F(129,2164260864),this.queen=new F(8,134217728),this.king=new F(16,268435456)}static empty(){const e=new T;return e.clear(),e}clear(){this.occupied=F.empty(),this.promoted=F.empty();for(const e of q)this[e]=F.empty();for(const e of x)this[e]=F.empty()}clone(){const e=new T;e.occupied=this.occupied,e.promoted=this.promoted;for(const t of q)e[t]=this[t];for(const t of x)e[t]=this[t];return e}equalsIgnorePromoted(e){return!!this.white.equals(e.white)&&x.every((t=>this[t].equals(e[t])))}equals(e){return this.equalsIgnorePromoted(e)&&this.promoted.equals(e.promoted)}getColor(e){return this.white.has(e)?"white":this.black.has(e)?"black":void 0}getRole(e){for(const t of x)if(this[t].has(e))return t}get(e){const t=this.getColor(e);if(!t)return;return{color:t,role:this.getRole(e),promoted:this.promoted.has(e)}}take(e){const t=this.get(e);return t&&(this.occupied=this.occupied.without(e),this[t.color]=this[t.color].without(e),this[t.role]=this[t.role].without(e),t.promoted&&(this.promoted=this.promoted.without(e))),t}set(e,t){const n=this.take(e);return this.occupied=this.occupied.with(e),this[t.color]=this[t.color].with(e),this[t.role]=this[t.role].with(e),t.promoted&&(this.promoted=this.promoted.with(e)),n}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,t){return this[e].intersect(this[t])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.king.intersect(this[e]).diff(this.promoted).singleSquare()}}class K{constructor(){}static empty(){const e=new K;for(const t of x)e[t]=0;return e}static fromBoard(e,t){const n=new K;for(const r of x)n[r]=e.pieces(t,r).size();return n}clone(){const e=new K;for(const t of x)e[t]=this[t];return e}equals(e){return x.every((t=>this[t]===e[t]))}add(e){const t=new K;for(const n of x)t[n]=this[n]+e[n];return t}nonEmpty(){return x.some((e=>this[e]>0))}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}count(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class N{constructor(e,t){this.white=e,this.black=t}static empty(){return new N(K.empty(),K.empty())}static fromBoard(e){return new N(K.fromBoard(e,"white"),K.fromBoard(e,"black"))}clone(){return new N(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new N(this.white.add(e.white),this.black.add(e.black))}count(){return this.white.count()+this.black.count()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class D{constructor(e,t){this.white=e,this.black=t}static default(){return new D(3,3)}clone(){return new D(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}function I(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,e.__proto__=t}var B,L=function(){function e(){}var t=e.prototype;return t.unwrap=function(e,t){var n=this._chain((function(t){return B.ok(e?e(t):t)}),(function(e){return t?B.ok(t(e)):B.err(e)}));if(n.isErr)throw n.error;return n.value},t.map=function(e,t){return this._chain((function(t){return B.ok(e(t))}),(function(e){return B.err(t?t(e):e)}))},t.chain=function(e,t){return this._chain(e,t||function(e){return B.err(e)})},e}(),z=function(e){function t(t){var n;return(n=e.call(this)||this).value=t,n.isOk=!0,n.isErr=!1,n}return I(t,e),t.prototype._chain=function(e,t){return e(this.value)},t}(L),_=function(e){function t(t){var n;return(n=e.call(this)||this).error=t,n.isOk=!1,n.isErr=!0,n}return I(t,e),t.prototype._chain=function(e,t){return t(this.error)},t}(L);function U(e){return void 0!==e}function V(e){return"white"===e?"black":"white"}function j(e){return e>>3}function H(e){return 7&e}function Q(e){switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}}function W(e,t){return"white"===e?"a"===t?2:6:"a"===t?58:62}function X(e,t){let n=F.empty();for(const r of t){const t=e+r;0<=t&&t<64&&Math.abs(H(e)-H(t))<=2&&(n=n.with(t))}return n}function G(e){const t=[];for(let n=0;n<64;n++)t[n]=e(n);return t}!function(e){e.ok=function(e){return new z(e)},e.err=function(e){return new _(e||new Error)},e.all=function(t){if(Array.isArray(t)){for(var n=[],r=0;r<t.length;r++){var o=t[r];if(o.isErr)return o;n.push(o.value)}return e.ok(n)}for(var s={},i=Object.keys(t),a=0;a<i.length;a++){var c=t[i[a]];if(c.isErr)return c;s[i[a]]=c.value}return e.ok(s)}}(B||(B={}));const Y=G((e=>X(e,[-9,-8,-7,-1,1,7,8,9]))),Z=G((e=>X(e,[-17,-15,-10,-6,6,10,15,17]))),J={white:G((e=>X(e,[7,9]))),black:G((e=>X(e,[-7,-9])))};function ee(e){return Y[e]}function te(e){return Z[e]}function ne(e,t){return J[e][t]}const re=G((e=>F.fromFile(H(e)).without(e))),oe=G((e=>F.fromRank(j(e)).without(e))),se=G((e=>{const t=new F(134480385,2151686160),n=8*(j(e)-H(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)})),ie=G((e=>{const t=new F(270549120,16909320),n=8*(j(e)+H(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}));function ae(e,t,n){let r=n.intersect(t),o=r.bswap64();return r=r.minus64(e),o=o.minus64(e.bswap64()),r.xor(o.bswap64()).intersect(t)}function ce(e,t){const n=F.fromSquare(e);return ae(n,se[e],t).xor(ae(n,ie[e],t))}function ue(e,t){return function(e,t){return ae(F.fromSquare(e),re[e],t)}(e,t).xor(function(e,t){const n=oe[e];let r=t.intersect(n),o=r.rbit64();return r=r.minus64(F.fromSquare(e)),o=o.minus64(F.fromSquare(63-e)),r.xor(o.rbit64()).intersect(n)}(e,t))}function le(e,t){return ce(e,t).xor(ue(e,t))}function he(e,t){const n=F.fromSquare(t);return oe[e].intersects(n)?oe[e].with(e):ie[e].intersects(n)?ie[e].with(e):se[e].intersects(n)?se[e].with(e):re[e].intersects(n)?re[e].with(e):F.empty()}function de(e,t){return he(e,t).intersect(F.full().shl64(e).xor(F.full().shl64(t))).withoutFirst()}var pe;!function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.ImpossibleCheck="ERR_IMPOSSIBLE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"}(pe||(pe={}));class fe extends Error{}function me(e,t){return"white"===e?"a"===t?3:5:"a"===t?59:61}class ge{constructor(){}static default(){const e=new ge;return e.unmovedRooks=F.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new F(14,0),h:new F(96,0)},black:{a:new F(0,234881024),h:new F(0,1610612736)}},e}static empty(){const e=new ge;return e.unmovedRooks=F.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:F.empty(),h:F.empty()},black:{a:F.empty(),h:F.empty()}},e}clone(){const e=new ge;return e.unmovedRooks=this.unmovedRooks,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,t,n,r){const o=W(e,t),s=me(e,t);this.unmovedRooks=this.unmovedRooks.with(r),this.rook[e][t]=r,this.path[e][t]=de(r,s).with(s).union(de(n,o).with(o)).without(n).without(r)}static fromSetup(e){const t=ge.empty(),n=e.unmovedRooks.intersect(e.board.rook);for(const r of q){const o=F.backrank(r),s=e.board.kingOf(r);if(!U(s)||!o.has(s))continue;const i=n.intersect(e.board[r]).intersect(o),a=i.first();U(a)&&a<s&&t.add(r,"a",s,a);const c=i.last();U(c)&&s<c&&t.add(r,"h",s,c)}return t}discardRook(e){if(this.unmovedRooks.has(e)){this.unmovedRooks=this.unmovedRooks.without(e);for(const t of q)for(const n of M)this.rook[t][n]===e&&(this.rook[t][n]=void 0)}}discardSide(e){this.unmovedRooks=this.unmovedRooks.diff(F.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}class be extends class{constructor(e){this.rules=e}kingAttackers(e,t,n){return function(e,t,n,r){return n[t].intersect(ue(e,r).intersect(n.rooksAndQueens()).union(ce(e,r).intersect(n.bishopsAndQueens())).union(te(e).intersect(n.knight)).union(ee(e).intersect(n.king)).union(ne(V(t),e).intersect(n.pawn)))}(e,t,this.board,n)}dropDests(e){return F.empty()}playCaptureAt(e,t){this.halfmoves=0,"rook"===t.role&&this.castles.discardRook(e),this.pockets&&this.pockets[V(t.color)][t.role]++}ctx(){const e=this.isVariantEnd(),t=this.board.kingOf(this.turn);if(!U(t))return{king:t,blockers:F.empty(),checkers:F.empty(),variantEnd:e,mustCapture:!1};const n=ue(t,F.empty()).intersect(this.board.rooksAndQueens()).union(ce(t,F.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[V(this.turn)]);let r=F.empty();for(const e of n){const n=de(t,e).intersect(this.board.occupied);n.moreThanOne()||(r=r.union(n))}return{king:t,blockers:r,checkers:this.kingAttackers(t,V(this.turn),this.board.occupied),variantEnd:e,mustCapture:!1}}clone(){var e,t;const n=new this.constructor;return n.board=this.board.clone(),n.pockets=null===(e=this.pockets)||void 0===e?void 0:e.clone(),n.turn=this.turn,n.castles=this.castles.clone(),n.epSquare=this.epSquare,n.remainingChecks=null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),n.halfmoves=this.halfmoves,n.fullmoves=this.fullmoves,n}equalsIgnoreMoves(e){var t,n;return this.rules===e.rules&&(this.pockets?this.board.equals(e.board):this.board.equalsIgnorePromoted(e.board))&&(e.pockets&&(null===(t=this.pockets)||void 0===t?void 0:t.equals(e.pockets))||!this.pockets&&!e.pockets)&&this.turn===e.turn&&this.castles.unmovedRooks.equals(e.castles.unmovedRooks)&&this.legalEpSquare()===e.legalEpSquare()&&(e.remainingChecks&&(null===(n=this.remainingChecks)||void 0===n?void 0:n.equals(e.remainingChecks))||!this.remainingChecks&&!e.remainingChecks)}toSetup(){var e,t;return{board:this.board.clone(),pockets:null===(e=this.pockets)||void 0===e?void 0:e.clone(),turn:this.turn,unmovedRooks:this.castles.unmovedRooks,epSquare:this.legalEpSquare(),remainingChecks:null===(t=this.remainingChecks)||void 0===t?void 0:t.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return q.every((e=>this.hasInsufficientMaterial(e)))}hasDests(e){e=e||this.ctx();for(const t of this.board[this.turn])if(this.dests(t,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,t){if(A(e))return!(!this.pockets||this.pockets[this.turn][e.role]<=0)&&(("pawn"!==e.role||!F.backranks().has(e.to))&&this.dropDests(t).has(e.to));{if("pawn"===e.promotion)return!1;if("king"===e.promotion&&"antichess"!==this.rules)return!1;if(!!e.promotion!==(this.board.pawn.has(e.from)&&F.backranks().has(e.to)))return!1;const n=this.dests(e.from,t);return n.has(e.to)||n.has(this.normalizeMove(e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return U(e)&&this.kingAttackers(e,V(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return!!(e?e.variantEnd:this.isVariantEnd())||(this.isInsufficientMaterial()||!this.hasDests(e))}isCheckmate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return!(e=e||this.ctx()).variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const t=this.variantOutcome(e);return t||(e=e||this.ctx(),this.isCheckmate(e)?{winner:V(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const t=new Map;if(e.variantEnd)return t;for(const n of this.board[this.turn])t.set(n,this.dests(n,e));return t}castlingSide(e){if(A(e))return;const t=e.to-e.from;return(2===Math.abs(t)||this.board[this.turn].has(e.to))&&this.board.king.has(e.from)?t>0?"h":"a":void 0}normalizeMove(e){const t=this.castlingSide(e);if(!t)return e;const n=this.castles.rook[this.turn][t];return{from:e.from,to:U(n)?n:e.to}}play(e){const t=this.turn,n=this.epSquare,r=this.castlingSide(e);if(this.epSquare=void 0,this.halfmoves+=1,"black"===t&&(this.fullmoves+=1),this.turn=V(t),A(e))this.board.set(e.to,{role:e.role,color:t}),this.pockets&&this.pockets[t][e.role]--,"pawn"===e.role&&(this.halfmoves=0);else{const o=this.board.take(e.from);if(!o)return;let s;if("pawn"===o.role){this.halfmoves=0,e.to===n&&(s=this.board.take(e.to+("white"===t?-8:8)));const r=e.from-e.to;16===Math.abs(r)&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(o.role=e.promotion,o.promoted=!0)}else if("rook"===o.role)this.castles.discardRook(e.from);else if("king"===o.role){if(r){const e=this.castles.rook[t][r];if(U(e)){const n=this.board.take(e);this.board.set(W(t,r),o),n&&this.board.set(me(t,r),n)}}if(this.castles.discardSide(t),r)return}const i=this.board.set(e.to,o)||s;i&&this.playCaptureAt(e.to,i)}}legalEpSquare(e){if(!U(this.epSquare))return;e=e||this.ctx();const t=this.board.pieces(this.turn,"pawn").intersect(ne(V(this.turn),this.epSquare));for(const n of t)if(this.dests(n,e).has(this.epSquare))return this.epSquare}}{constructor(e){super(e||"chess")}static default(){const e=new this;return e.board=T.default(),e.pockets=void 0,e.turn="white",e.castles=ge.default(),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){const t=new this;return t.board=e.board.clone(),t.pockets=void 0,t.turn=e.turn,t.castles=ge.fromSetup(e),t.epSquare=t.validEpSquare(e.epSquare),t.remainingChecks=void 0,t.halfmoves=e.halfmoves,t.fullmoves=e.fullmoves,t.validate().map((e=>t))}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return B.err(new fe(pe.Empty));if(2!==this.board.king.size())return B.err(new fe(pe.Kings));if(!U(this.board.kingOf(this.turn)))return B.err(new fe(pe.Kings));const e=this.board.kingOf(V(this.turn));return U(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?B.err(new fe(pe.OppositeCheck)):F.backranks().intersects(this.board.pawn)?B.err(new fe(pe.PawnsOnBackrank)):this.validateCheckers():B.err(new fe(pe.Kings))}validateCheckers(){const e=this.board.kingOf(this.turn);if(U(e)){const t=this.kingAttackers(e,V(this.turn),this.board.occupied);if(t.size()>2||2===t.size()&&he(t.first(),t.last()).has(e))return B.err(new fe(pe.ImpossibleCheck));if(U(this.epSquare))for(const n of t)if(he(n,this.epSquare).has(e))return B.err(new fe(pe.ImpossibleCheck))}return B.ok(void 0)}validEpSquare(e){if(!U(e))return;const t="white"===this.turn?5:2,n="white"===this.turn?8:-8;if(j(e)!==t)return;if(this.board.occupied.has(e+n))return;const r=e-n;return this.board.pawn.has(r)&&this.board[V(this.turn)].has(r)?e:void 0}castlingDest(e,t){if(!U(t.king)||t.checkers.nonEmpty())return F.empty();const n=this.castles.rook[this.turn][e];if(!U(n))return F.empty();if(this.castles.path[this.turn][e].intersects(this.board.occupied))return F.empty();const r=W(this.turn,e),o=de(t.king,r),s=this.board.occupied.without(t.king);for(const e of o)if(this.kingAttackers(e,V(this.turn),s).nonEmpty())return F.empty();const i=me(this.turn,e),a=this.board.occupied.toggle(t.king).toggle(n).toggle(i);return this.kingAttackers(r,V(this.turn),a).nonEmpty()?F.empty():F.fromSquare(n)}canCaptureEp(e,t){if(!U(this.epSquare))return!1;if(!ne(this.turn,e).has(this.epSquare))return!1;if(!U(t.king))return!0;const n=this.epSquare+("white"===this.turn?-8:8),r=this.board.occupied.toggle(e).toggle(this.epSquare).toggle(n);return!this.kingAttackers(t.king,V(this.turn),r).intersects(r)}pseudoDests(e,t){if(t.variantEnd)return F.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return F.empty();let r=function(e,t,n){switch(e.role){case"pawn":return ne(e.color,t);case"knight":return te(t);case"bishop":return ce(t,n);case"rook":return ue(t,n);case"queen":return le(t,n);case"king":return ee(t)}}(n,e,this.board.occupied);if("pawn"===n.role){let t=this.board[V(this.turn)];U(this.epSquare)&&(t=t.with(this.epSquare)),r=r.intersect(t);const n="white"===this.turn?8:-8,o=e+n;if(0<=o&&o<64&&!this.board.occupied.has(o)){r=r.with(o);const t=o+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(r=r.with(t))}return r}return r=r.diff(this.board[this.turn]),e===t.king?r.union(this.castlingDest("a",t)).union(this.castlingDest("h",t)):r}dests(e,t){if((t=t||this.ctx()).variantEnd)return F.empty();const n=this.board.get(e);if(!n||n.color!==this.turn)return F.empty();let r,o;if("pawn"===n.role){r=ne(this.turn,e).intersect(this.board[V(this.turn)]);const n="white"===this.turn?8:-8,s=e+n;if(0<=s&&s<64&&!this.board.occupied.has(s)){r=r.with(s);const t=s+n;("white"===this.turn?e<16:e>=48)&&!this.board.occupied.has(t)&&(r=r.with(t))}if(U(this.epSquare)&&this.canCaptureEp(e,t)){const e=this.epSquare-n;(t.checkers.isEmpty()||t.checkers.singleSquare()===e)&&(o=F.fromSquare(this.epSquare))}}else r="bishop"===n.role?ce(e,this.board.occupied):"knight"===n.role?te(e):"rook"===n.role?ue(e,this.board.occupied):"queen"===n.role?le(e,this.board.occupied):ee(e);if(r=r.diff(this.board[this.turn]),U(t.king)){if("king"===n.role){const n=this.board.occupied.without(e);for(const e of r)this.kingAttackers(e,V(this.turn),n).nonEmpty()&&(r=r.without(e));return r.union(this.castlingDest("a",t)).union(this.castlingDest("h",t))}if(t.checkers.nonEmpty()){const e=t.checkers.singleSquare();if(!U(e))return F.empty();r=r.intersect(de(e,t.king).with(e))}t.blockers.has(e)&&(r=r.intersect(he(e,t.king)))}return o&&(r=r.union(o)),r}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){if(this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty())return!1;if(this.board[e].intersects(this.board.knight))return this.board[e].size()<=2&&this.board[V(e)].diff(this.board.king).diff(this.board.queen).isEmpty();if(this.board[e].intersects(this.board.bishop)){return(!this.board.bishop.intersects(F.darkSquares())||!this.board.bishop.intersects(F.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty()}return!0}}class ve extends be{constructor(){super("crazyhouse")}static default(){const e=super.default();return e.pockets=N.empty(),e}static fromSetup(e){return super.fromSetup(e).map((t=>(t.pockets=e.pockets?e.pockets.clone():N.empty(),t)))}validate(){return super.validate().chain((e=>this.pockets&&(this.pockets.white.king>0||this.pockets.black.king>0)?B.err(new fe(pe.Kings)):(this.pockets?this.pockets.count():0)+this.board.occupied.size()>64?B.err(new fe(pe.Variant)):B.ok(void 0)))}clone(){return super.clone()}hasInsufficientMaterial(e){return this.pockets?this.board.occupied.size()+this.pockets.count()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.white.pawn<=0&&this.pockets.black.pawn<=0&&this.pockets.white.rook<=0&&this.pockets.black.rook<=0&&this.pockets.white.queen<=0&&this.pockets.black.queen<=0:super.hasInsufficientMaterial(e)}dropDests(e){var t,n;const r=this.board.occupied.complement().intersect((null===(t=this.pockets)||void 0===t?void 0:t[this.turn].hasNonPawns())?F.full():(null===(n=this.pockets)||void 0===n?void 0:n[this.turn].hasPawns())?F.backranks().complement():F.empty());if(U((e=e||this.ctx()).king)&&e.checkers.nonEmpty()){const t=e.checkers.singleSquare();return U(t)?r.intersect(de(t,e.king)):F.empty()}return r}}class ke extends be{constructor(){super("atomic")}static default(){return super.default()}static fromSetup(e){return super.fromSetup(e)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return B.err(new fe(pe.Empty));if(this.board.king.size()>2)return B.err(new fe(pe.Kings));const e=this.board.kingOf(V(this.turn));return U(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?B.err(new fe(pe.OppositeCheck)):F.backranks().intersects(this.board.pawn)?B.err(new fe(pe.PawnsOnBackrank)):B.ok(void 0):B.err(new fe(pe.Kings))}kingAttackers(e,t,n){return ee(e).intersects(this.board.pieces(t,"king"))?F.empty():super.kingAttackers(e,t,n)}playCaptureAt(e,t){super.playCaptureAt(e,t),this.board.take(e);for(const t of ee(e).intersect(this.board.occupied).diff(this.board.pawn)){const e=this.board.take(t);e&&"rook"===e.role&&this.castles.discardRook(t),e&&"king"===e.role&&this.castles.discardSide(e.color)}}hasInsufficientMaterial(e){if(this.board.pieces(V(e),"king").isEmpty())return!1;if(this.board[e].diff(this.board.king).isEmpty())return!0;if(this.board[V(e)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(F.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(F.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(F.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(F.darkSquares())}return!1}return!this.board.queen.nonEmpty()&&!this.board.pawn.nonEmpty()&&(!!this.board.knight.union(this.board.bishop).union(this.board.rook).isSingleSquare()||!!this.board.occupied.equals(this.board.knight.union(this.board.king))&&this.board.knight.size()<=2)}dests(e,t){t=t||this.ctx();let n=F.empty();for(const r of this.pseudoDests(e,t)){const t=this.clone();t.play({from:e,to:r});const o=t.board.kingOf(this.turn);!U(o)||U(t.board.kingOf(t.turn))&&!t.kingAttackers(o,t.turn,t.board.occupied).isEmpty()||(n=n.with(r))}return n}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(e){for(const e of q)if(this.board.pieces(e,"king").isEmpty())return{winner:V(e)}}}class we extends be{constructor(){super("antichess")}static default(){const e=super.default();return e.castles=ge.empty(),e}static fromSetup(e){return super.fromSetup(e).map((e=>(e.castles=ge.empty(),e)))}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?B.err(new fe(pe.Empty)):F.backranks().intersects(this.board.pawn)?B.err(new fe(pe.PawnsOnBackrank)):B.ok(void 0)}kingAttackers(e,t,n){return F.empty()}ctx(){const e=super.ctx(),t=this.board[V(this.turn)];for(const n of this.board[this.turn])if(this.pseudoDests(n,e).intersects(t)){e.mustCapture=!0;break}return e}dests(e,t){t=t||this.ctx();const n=this.pseudoDests(e,t);return t.mustCapture?n.intersect(this.board[V(this.turn)]):n}hasInsufficientMaterial(e){if(this.board.occupied.equals(this.board.bishop)){const t=this.board[e].intersects(F.lightSquares()),n=this.board[e].intersects(F.darkSquares()),r=this.board[V(e)].isDisjoint(F.lightSquares()),o=this.board[V(e)].isDisjoint(F.darkSquares());return t&&r||n&&o}return!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(e){if((e=e||this.ctx()).variantEnd||this.isStalemate(e))return{winner:this.turn}}}class ye extends be{constructor(){super("kingofthehill")}static default(){return super.default()}static fromSetup(e){return super.fromSetup(e)}clone(){return super.clone()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.king.intersects(F.center())}variantOutcome(e){for(const e of q)if(this.board.pieces(e,"king").intersects(F.center()))return{winner:e}}}class Ce extends be{constructor(){super("3check")}static default(){const e=super.default();return e.remainingChecks=D.default(),e}static fromSetup(e){return super.fromSetup(e).map((t=>(t.remainingChecks=e.remainingChecks?e.remainingChecks.clone():D.default(),t)))}clone(){return super.clone()}hasInsufficientMaterial(e){return this.board.pieces(e,"king").equals(this.board[e])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(e){if(this.remainingChecks)for(const e of q)if(this.remainingChecks[e]<=0)return{winner:e}}}class Se extends be{constructor(){super("racingkings")}static default(){const e=new this;return e.board=T.racingKings(),e.pockets=void 0,e.turn="white",e.castles=ge.empty(),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){return super.fromSetup(e).map((e=>(e.castles=ge.empty(),e)))}validate(){return this.isCheck()?B.err(new fe(pe.ImpossibleCheck)):this.board.pawn.nonEmpty()?B.err(new fe(pe.Variant)):super.validate()}clone(){return super.clone()}dests(e,t){if(e===(t=t||this.ctx()).king)return super.dests(e,t);let n=F.empty();for(const r of super.dests(e,t)){const t={from:e,to:r},o=this.clone();o.play(t),o.isCheck()||(n=n.with(r))}return n}hasInsufficientMaterial(e){return!1}isVariantEnd(){const e=F.fromRank(7),t=this.board.king.intersect(e);if(t.isEmpty())return!1;if("white"===this.turn||t.intersects(this.board.black))return!0;const n=this.board.kingOf("black");if(U(n)){const t=this.board.occupied.without(n);for(const r of ee(n).intersect(e).diff(this.board.black))if(this.kingAttackers(r,"white",t).isEmpty())return!1}return!0}variantOutcome(e){if(e?!e.variantEnd:!this.isVariantEnd())return;const t=F.fromRank(7),n=this.board.pieces("black","king").intersects(t),r=this.board.pieces("white","king").intersects(t);return n&&!r?{winner:"black"}:r&&!n?{winner:"white"}:{winner:void 0}}}class Ee extends be{constructor(){super("horde")}static default(){const e=new this;return e.board=T.horde(),e.pockets=void 0,e.turn="white",e.castles=ge.default(),e.castles.discardSide("white"),e.epSquare=void 0,e.remainingChecks=void 0,e.halfmoves=0,e.fullmoves=1,e}static fromSetup(e){return super.fromSetup(e)}validate(){if(this.board.occupied.isEmpty())return B.err(new fe(pe.Empty));if(!this.board.king.isSingleSquare())return B.err(new fe(pe.Kings));if(!this.board.king.diff(this.board.promoted).isSingleSquare())return B.err(new fe(pe.Kings));const e=this.board.kingOf(V(this.turn));if(U(e)&&this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty())return B.err(new fe(pe.OppositeCheck));for(const e of q)if(this.board.pieces(e,"pawn").intersects(F.backrank(V(e))))return B.err(new fe(pe.PawnsOnBackrank));return this.validateCheckers()}clone(){return super.clone()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(e){return this.board.white.isEmpty()?{winner:"black"}:this.board.black.isEmpty()?{winner:"white"}:void 0}}function qe(e,t){switch(e){case"chess":return be.fromSetup(t);case"antichess":return we.fromSetup(t);case"atomic":return ke.fromSetup(t);case"horde":return Ee.fromSetup(t);case"racingkings":return Se.fromSetup(t);case"kingofthehill":return ye.fromSetup(t);case"3check":return Ce.fromSetup(t);case"crazyhouse":return ve.fromSetup(t)}}const xe="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq -",Me=xe+" 0 1",Ae="8/8/8/8/8/8/8/8 w - - 0 1";var Pe;!function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"}(Pe||(Pe={}));class Oe extends Error{}function Re(e){return/^\d{1,4}$/.test(e)?parseInt(e,10):void 0}function Fe(e){const t=function(e){switch(e){case"P":case"p":return"pawn";case"N":case"n":return"knight";case"B":case"b":return"bishop";case"R":case"r":return"rook";case"Q":case"q":return"queen";case"K":case"k":return"king";default:return}}(e);return t&&{role:t,color:e.toLowerCase()===e?"black":"white"}}function Te(e){const t=T.empty();let n=7,r=0;for(let o=0;o<e.length;o++){const s=e[o];if("/"===s&&8===r)r=0,n--;else{const i=parseInt(s,10);if(i>0)r+=i;else{if(r>=8||n<0)return B.err(new Oe(Pe.Board));const i=r+8*n,a=Fe(s);if(!a)return B.err(new Oe(Pe.Board));"~"===e[o+1]&&(a.promoted=!0,o++),t.set(i,a),r++}}}return 0!==n||8!==r?B.err(new Oe(Pe.Board)):B.ok(t)}function Ke(e){if(e.length>64)return B.err(new Oe(Pe.Pockets));const t=N.empty();for(const n of e){const e=Fe(n);if(!e)return B.err(new Oe(Pe.Pockets));t[e.color][e.role]++}return B.ok(t)}function Ne(e,t){let n=F.empty();if("-"===t)return B.ok(n);if(!/^[KQABCDEFGH]{0,2}[kqabcdefgh]{0,2}$/.test(t))return B.err(new Oe(Pe.Castling));for(const r of t){const t=r.toLowerCase(),o=r===t?"black":"white",s=F.backrank(o).intersect(e[o]);let i;i="q"===t?s:"k"===t?s.reversed():F.fromSquare(t.charCodeAt(0)-"a".charCodeAt(0)).intersect(s);for(const t of i){if(e.king.has(t)&&!e.promoted.has(t))break;if(e.rook.has(t)){n=n.with(t);break}}}return B.ok(n)}function De(e){const t=e.split("+");if(3===t.length&&""===t[0]){const e=Re(t[1]),n=Re(t[2]);return!U(e)||e>3||!U(n)||n>3?B.err(new Oe(Pe.RemainingChecks)):B.ok(new D(3-e,3-n))}if(2===t.length){const e=Re(t[0]),n=Re(t[1]);return!U(e)||e>3||!U(n)||n>3?B.err(new Oe(Pe.RemainingChecks)):B.ok(new D(e,n))}return B.err(new Oe(Pe.RemainingChecks))}function Ie(e){const t=e.split(" "),n=t.shift();let r,o,s=B.ok(void 0);if(n.endsWith("]")){const e=n.indexOf("[");if(-1===e)return B.err(new Oe(Pe.Fen));r=Te(n.substr(0,e)),s=Ke(n.substr(e+1,n.length-1-e-1))}else{const e=function(e,t,n){let r=e.indexOf(t);for(;n-- >0&&-1!==r;)r=e.indexOf(t,r+t.length);return r}(n,"/",7);-1===e?r=Te(n):(r=Te(n.substr(0,e)),s=Ke(n.substr(e+1)))}const i=t.shift();if(U(i)&&"w"!==i){if("b"!==i)return B.err(new Oe(Pe.Turn));o="black"}else o="white";return r.chain((e=>{const n=t.shift(),r=U(n)?Ne(e,n):B.ok(F.empty()),i=t.shift();let a;if(U(i)&&"-"!==i&&(a=function(e){if(2!==e.length)return;const t=e.charCodeAt(0)-"a".charCodeAt(0),n=e.charCodeAt(1)-"1".charCodeAt(0);return t<0||t>=8||n<0||n>=8?void 0:t+8*n}(i),!U(a)))return B.err(new Oe(Pe.EpSquare));let c,u=t.shift();U(u)&&u.includes("+")&&(c=De(u),u=t.shift());const l=U(u)?Re(u):0;if(!U(l))return B.err(new Oe(Pe.Halfmoves));const h=t.shift(),d=U(h)?Re(h):1;if(!U(d))return B.err(new Oe(Pe.Fullmoves));const p=t.shift();let f=B.ok(void 0);if(U(p)){if(U(c))return B.err(new Oe(Pe.RemainingChecks));f=De(p)}else U(c)&&(f=c);return t.length>0?B.err(new Oe(Pe.Fen)):s.chain((t=>r.chain((n=>f.map((r=>({board:e,pockets:t,turn:o,unmovedRooks:n,remainingChecks:r,epSquare:a,halfmoves:l,fullmoves:Math.max(1,d)})))))))}))}function Be(e,t){let n=Q(e.role);return"white"===e.color&&(n=n.toUpperCase()),(null==t?void 0:t.promoted)&&e.promoted&&(n+="~"),n}function Le(e,t){let n="",r=0;for(let o=7;o>=0;o--)for(let s=0;s<8;s++){const i=s+8*o,a=e.get(i);a?(r>0&&(n+=r,r=0),n+=Be(a,t)):r++,7===s&&(r>0&&(n+=r,r=0),0!==o&&(n+="/"))}return n}function ze(e){return x.map((t=>Q(t).repeat(e[t]))).join("")}function $e(e,t,n){const r=null==n?void 0:n.shredder;let o="";for(const n of q){const s=F.backrank(n),i=e.kingOf(n);if(!U(i)||!s.has(i))continue;const a=e.pieces(n,"rook").intersect(s);for(const e of t.intersect(a).reversed())if(!r&&e===a.first()&&e<i)o+="white"===n?"Q":"q";else if(!r&&e===a.last()&&i<e)o+="white"===n?"K":"k";else{const t=S[H(e)];o+="white"===n?t.toUpperCase():t}}return o||"-"}function _e(e,t){return[Le(e.board,t)+(e.pockets?`[${o=e.pockets,ze(o.white).toUpperCase()+ze(o.black)}]`:""),e.turn[0],$e(e.board,e.unmovedRooks,t),U(e.epSquare)?(r=e.epSquare,S[H(r)]+E[j(r)]):"-",...e.remainingChecks?[(n=e.remainingChecks,`${n.white}+${n.black}`)]:[],...(null==t?void 0:t.epd)?[]:[Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))]].join(" ");var n,r,o}const Ue=e=>void 0!==e;class Ve{constructor(e,t){this.cfg=e,this.options=e.options||{},this.trans=lichess.trans(this.cfg.i18n),this.selected=(e=>{let t=e;return function(e){return Ue(e)&&(t=e),t}})("pointer"),this.extraPositions=[{fen:Me,epd:xe,name:this.trans("startPosition")},{fen:"prompt",name:this.trans("loadPosition")}],e.positions&&e.positions.forEach((e=>e.epd=e.fen.split(" ").splice(0,4).join(" "))),window.Mousetrap.bind("f",(()=>{this.chessground&&this.chessground.toggleOrientation(),t()})),this.castlingToggles={K:!1,Q:!1,k:!1,q:!1},this.rules=!this.cfg.embed&&window.history.state&&window.history.state.rules?window.history.state.rules:"chess",this.redraw=()=>{},this.setFen(e.fen),this.redraw=t}onChange(){const e=this.getFen();if(!this.cfg.embed){const t={rules:this.rules};e==Me?window.history.replaceState(t,"","/editor"):window.history.replaceState(t,"",this.makeUrl("/editor/",e))}this.options.onChange&&this.options.onChange(e),this.redraw()}castlingToggleFen(){let e="";for(const t of C)this.castlingToggles[t]&&(e+=t);return e}getSetup(){const e=Ie(this.chessground?this.chessground.getFen():this.cfg.fen).unwrap((e=>e.board),(e=>T.empty()));return{board:e,pockets:this.pockets,turn:this.turn,unmovedRooks:this.unmovedRooks||Ne(e,this.castlingToggleFen()).unwrap(),epSquare:this.epSquare,remainingChecks:this.remainingChecks,halfmoves:this.halfmoves,fullmoves:this.fullmoves}}getFen(){return _e(this.getSetup(),{promoted:"crazyhouse"==this.rules})}getLegalFen(){return qe(this.rules,this.getSetup()).unwrap((e=>_e(e.toSetup(),{promoted:"crazyhouse"==e.rules})),(e=>{}))}isPlayable(){return qe(this.rules,this.getSetup()).unwrap((e=>!e.isEnd()),(e=>!1))}getState(){return{fen:this.getFen(),legalFen:this.getLegalFen(),playable:"chess"==this.rules&&this.isPlayable()}}makeAnalysisUrl(e){switch(this.rules){case"chess":return this.makeUrl("/analysis/",e);case"3check":return this.makeUrl("/analysis/threeCheck/",e);case"kingofthehill":return this.makeUrl("/analysis/kingOfTheHill/",e);case"racingkings":return this.makeUrl("/analysis/racingKings/",e);case"antichess":case"atomic":case"horde":case"crazyhouse":return this.makeUrl(`/analysis/${this.rules}/`,e)}}makeUrl(e,t){return e+encodeURIComponent(t).replace(/%20/g,"_").replace(/%2F/g,"/")}bottomColor(){return this.chessground?this.chessground.state.orientation:this.options.orientation||"white"}setCastlingToggle(e,t){this.castlingToggles[e]!=t&&(this.unmovedRooks=void 0),this.castlingToggles[e]=t,this.onChange()}setTurn(e){this.turn=e,this.onChange()}startPosition(){this.setFen(Me)}clearBoard(){this.setFen(Ae)}loadNewFen(e){("prompt"!==e||(e=(prompt("Paste FEN position")||"").trim()))&&this.setFen(e)}setFen(e){return Ie(e).unwrap((t=>{this.chessground&&this.chessground.set({fen:e}),this.pockets=t.pockets,this.turn=t.turn,this.unmovedRooks=t.unmovedRooks,this.epSquare=t.epSquare,this.remainingChecks=t.remainingChecks,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves;const n=ge.fromSetup(t);return this.castlingToggles.K=Ue(n.rook.white.h),this.castlingToggles.Q=Ue(n.rook.white.a),this.castlingToggles.k=Ue(n.rook.black.h),this.castlingToggles.q=Ue(n.rook.black.a),this.onChange(),!0}),(e=>!1))}setRules(e){this.rules=e,"crazyhouse"!=e?this.pockets=void 0:this.pockets||(this.pockets=N.empty()),"3check"!=e?this.remainingChecks=void 0:this.remainingChecks||(this.remainingChecks=D.default()),this.onChange()}setOrientation(e){this.options.orientation=e,this.chessground.state.orientation!==e&&this.chessground.toggleOrientation(),this.redraw()}}const je=["white","black"],He=["a","b","c","d","e","f","g","h"],Qe=["1","2","3","4","5","6","7","8"],We=[...Qe].reverse(),Xe=Array.prototype.concat(...He.map((e=>Qe.map((t=>e+t))))),Ge=e=>Xe[8*e[0]+e[1]],Ye=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],Ze=Xe.map(Ye);const Je=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},et=e=>"white"===e?"black":"white",tt=(e,t)=>{const n=e[0]-t[0],r=e[1]-t[1];return n*n+r*r},nt=(e,t)=>e.role===t.role&&e.color===t.color,rt=(e,t,n,r)=>[(t?e[0]:7-e[0])*n,(t?7-e[1]:e[1])*r],ot=e=>{const t=e.width/8,n=e.height/8;return(e,r)=>rt(e,r,t,n)},st=(e,t)=>rt(e,t,100,100),it=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},at=(e,t)=>{e.style.transform=`translate(${t[0]}%,${t[1]}%)`},ct=(e,t)=>{e.style.visibility=t?"visible":"hidden"},ut=e=>{var t;return e.clientX||0===e.clientX?[e.clientX,e.clientY]:(null===(t=e.targetTouches)||void 0===t?void 0:t[0])?[e.targetTouches[0].clientX,e.targetTouches[0].clientY]:void 0},lt=e=>2===e.buttons||2===e.button,ht=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function dt(e,t,n){const r=Ye(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[n.left+n.width*r[0]/8+n.width/16,n.top+n.height*(7-r[1])/8+n.height/16]}function pt(e,t){return Math.abs(e-t)}const ft=(e,t,n,r)=>{const o=pt(e,n),s=pt(t,r);return 1===o&&2===s||2===o&&1===s},mt=(e,t,n,r)=>pt(e,n)===pt(t,r),gt=(e,t,n,r)=>e===n||t===r,bt=(e,t,n,r)=>mt(e,t,n,r)||gt(e,t,n,r);function vt(e,t,n){const r=e.get(t);if(!r)return[];const o=Ye(t),s=r.role,i="pawn"===s?(a=r.color,(e,t,n,r)=>pt(e,n)<2&&("white"===a?r===t+1||t<=1&&r===t+2&&e===n:r===t-1||t>=6&&r===t-2&&e===n)):"knight"===s?ft:"bishop"===s?mt:"rook"===s?gt:"queen"===s?bt:function(e,t,n){return(r,o,s,i)=>pt(r,s)<2&&pt(o,i)<2||n&&o===i&&o===("white"===e?0:7)&&(4===r&&(2===s&&t.includes(0)||6===s&&t.includes(7))||t.includes(s))}(r.color,function(e,t){const n="white"===t?"1":"8",r=[];for(const[o,s]of e)o[1]===n&&s.color===t&&"rook"===s.role&&r.push(Ye(o)[0]);return r}(e,r.color),n);var a;return Ze.filter((e=>(o[0]!==e[0]||o[1]!==e[1])&&i(o[0],o[1],e[0],e[1]))).map(Ge)}function kt(e,...t){e&&setTimeout((()=>e(...t)),1)}function wt(e){e.premovable.current&&(e.premovable.current=void 0,kt(e.premovable.events.unset))}function yt(e){const t=e.predroppable;t.current&&(t.current=void 0,kt(t.events.unset))}function Ct(e,t,n){const r=e.pieces.get(t),o=e.pieces.get(n);if(t===n||!r)return!1;const s=o&&o.color!==r.color?o:void 0;return n===e.selected&&Pt(e),kt(e.events.move,t,n,s),function(e,t,n){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||"king"!==r.role)return!1;const o=Ye(t),s=Ye(n);if(0!==o[1]&&7!==o[1]||o[1]!==s[1])return!1;4!==o[0]||e.pieces.has(n)||(6===s[0]?n=Ge([7,s[1]]):2===s[0]&&(n=Ge([0,s[1]])));const i=e.pieces.get(n);return!(!i||i.color!==r.color||"rook"!==i.role||(e.pieces.delete(t),e.pieces.delete(n),o[0]<s[0]?(e.pieces.set(Ge([6,s[1]]),r),e.pieces.set(Ge([5,s[1]]),i)):(e.pieces.set(Ge([2,s[1]]),r),e.pieces.set(Ge([3,s[1]]),i)),0))}(e,t,n)||(e.pieces.set(n,r),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,kt(e.events.change),s||!0}function St(e,t,n,r){if(e.pieces.has(n)){if(!r)return!1;e.pieces.delete(n)}return kt(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,kt(e.events.change),e.movable.dests=void 0,e.turnColor=et(e.turnColor),!0}function Et(e,t,n){const r=Ct(e,t,n);return r&&(e.movable.dests=void 0,e.turnColor=et(e.turnColor),e.animation.current=void 0),r}function qt(e,t,n){if(Rt(e,t,n)){const r=Et(e,t,n);if(r){const o=e.hold.stop();Pt(e);const s={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:o};return!0!==r&&(s.captured=r),kt(e.movable.events.after,t,n,s),!0}}else if(function(e,t,n){return t!==n&&Ft(e,t)&&vt(e.pieces,t,e.premovable.castle).includes(n)}(e,t,n))return function(e,t,n,r){yt(e),e.premovable.current=[t,n],kt(e.premovable.events.set,t,n,r)}(e,t,n,{ctrlKey:e.stats.ctrlKey}),Pt(e),!0;return Pt(e),!1}function xt(e,t,n,r){const o=e.pieces.get(t);o&&(function(e,t,n){const r=e.pieces.get(t);return!(!r||t!==n&&e.pieces.has(n)||"both"!==e.movable.color&&(e.movable.color!==r.color||e.turnColor!==r.color))}(e,t,n)||r)?(e.pieces.delete(t),St(e,o,n,r),kt(e.movable.events.afterNewPiece,o.role,n,{premove:!1,predrop:!1})):o&&function(e,t,n){const r=e.pieces.get(t),o=e.pieces.get(n);return!!r&&(!o||o.color!==e.movable.color)&&e.predroppable.enabled&&("pawn"!==r.role||"1"!==n[1]&&"8"!==n[1])&&e.movable.color===r.color&&e.turnColor!==r.color}(e,t,n)?function(e,t,n){wt(e),e.predroppable.current={role:t,key:n},kt(e.predroppable.events.set,t,n)}(e,o.role,n):(wt(e),yt(e)),e.pieces.delete(t),Pt(e)}function Mt(e,t,n){if(kt(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled)return Pt(e),void e.hold.cancel();if((e.selectable.enabled||n)&&e.selected!==t&&qt(e,e.selected,t))return void(e.stats.dragged=!1)}(Ot(e,t)||Ft(e,t))&&(At(e,t),e.hold.start())}function At(e,t){e.selected=t,Ft(e,t)?e.premovable.dests=vt(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function Pt(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Ot(e,t){const n=e.pieces.get(t);return!!n&&("both"===e.movable.color||e.movable.color===n.color&&e.turnColor===n.color)}function Rt(e,t,n){var r,o;return t!==n&&Ot(e,t)&&(e.movable.free||!!(null===(o=null===(r=e.movable.dests)||void 0===r?void 0:r.get(t))||void 0===o?void 0:o.includes(n)))}function Ft(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function Tt(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],r=t[1];let o=!1;if(Rt(e,n,r)){const t=Et(e,n,r);if(t){const s={premove:!0};!0!==t&&(s.captured=t),kt(e.movable.events.after,n,r,s),o=!0}}return wt(e),o}function Kt(e){wt(e),yt(e),Pt(e)}function Nt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Kt(e)}function Dt(e,t,n){let r=Math.floor(8*(e[0]-n.left)/n.width);t||(r=7-r);let o=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(o=7-o),r>=0&&r<8&&o>=0&&o<8?Ge([r,o]):void 0}function It(e){return"white"===e.orientation}const Bt=["green","red","blue","yellow"];function Lt(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?Pt(e):Kt(e);const n=ut(t),r=Dt(n,It(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:n,brush:Vt(t),snapToValidMove:e.drawable.defaultSnapToValidMove},zt(e))}function zt(e){requestAnimationFrame((()=>{const t=e.drawable.current;if(t){const n=Dt(t.pos,It(e),e.dom.bounds());n||(t.snapToValidMove=!1);const r=t.snapToValidMove?function(e,t,n,r){const o=Ye(e),s=Ze.filter((e=>bt(o[0],o[1],e[0],e[1])||ft(o[0],o[1],e[0],e[1]))),i=s.map((e=>dt(Ge(e),n,r))).map((e=>tt(t,e))),[,a]=i.reduce(((e,t,n)=>e[0]<t?e:[t,n]),[i[0],0]);return Ge(s[a])}(t.orig,t.pos,It(e),e.dom.bounds()):n;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),zt(e)}}))}function $t(e,t){e.drawable.current&&(e.drawable.current.pos=ut(t))}function _t(e){const t=e.drawable.current;t&&(t.mouseSq&&function(e,t){const n=e=>e.orig===t.orig&&e.dest===t.dest,r=e.shapes.find(n);r&&(e.shapes=e.shapes.filter((e=>!n(e))));r&&r.brush===t.brush||e.shapes.push(t);jt(e)}(e.drawable,t),Ut(e))}function Ut(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Vt(e){var t;const n=(e.shiftKey||e.ctrlKey)&&lt(e),r=e.altKey||e.metaKey||(null===(t=e.getModifierState)||void 0===t?void 0:t.call(e,"AltGraph"));return Bt[(n?1:0)+(r?2:0)]}function jt(e){e.onChange&&e.onChange(e.shapes)}function Ht(e,t){return t.animation.enabled?function(e,t){const n=new Map(t.pieces),r=e(t),o=function(e,t){const n=new Map,r=[],o=new Map,s=[],i=[],a=new Map;let c,u,l;for(const[t,n]of e)a.set(t,Wt(t,n));for(const e of Xe)c=t.pieces.get(e),u=a.get(e),c?u?nt(c,u.piece)||(s.push(u),i.push(Wt(e,c))):i.push(Wt(e,c)):u&&s.push(u);for(const e of i)u=Xt(e,s.filter((t=>nt(e.piece,t.piece)))),u&&(l=[u.pos[0]-e.pos[0],u.pos[1]-e.pos[1]],n.set(e.key,l.concat(l)),r.push(u.key));for(const e of s)r.includes(e.key)||o.set(e.key,e.piece);return{anims:n,fadings:o}}(n,t);if(o.anims.size||o.fadings.size){const e=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:o},e||Gt(t,performance.now())}else t.dom.redraw();return r}(e,t):Qt(e,t)}function Qt(e,t){const n=e(t);return t.dom.redraw(),n}function Wt(e,t){return{key:e,pos:Ye(e),piece:t}}function Xt(e,t){return t.sort(((t,n)=>tt(e.pos,t.pos)-tt(e.pos,n.pos)))[0]}function Gt(e,t){const n=e.animation.current;if(void 0===n)return void(e.dom.destroyed||e.dom.redrawNow());const r=1-(t-n.start)*n.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const t=function(e){return e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1}(r);for(const e of n.plan.anims.values())e[2]=e[0]*t,e[3]=e[1]*t;e.dom.redrawNow(!0),requestAnimationFrame(((t=performance.now())=>Gt(e,t)))}}function Yt(e,t){if(!t.isTrusted||void 0!==t.button&&0!==t.button)return;if(t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),r=ut(t),o=Dt(r,It(e),n);if(!o)return;const s=e.pieces.get(o),i=e.selected;var a;i||!e.drawable.enabled||!e.drawable.eraseOnClick&&s&&s.color===e.turnColor||(a=e).drawable.shapes.length&&(a.drawable.shapes=[],a.dom.redraw(),jt(a.drawable)),!1===t.cancelable||t.touches&&e.movable.color&&!s&&!i&&!function(e,t){const n=It(e),r=e.dom.bounds(),o=Math.pow(r.width/8,2);for(const s in e.pieces){const e=dt(s,n,r);if(tt(e,t)<=o)return!0}return!1}(e,r)||t.preventDefault();const c=!!e.premovable.current,u=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Rt(e,e.selected,o)?Ht((e=>Mt(e,o)),e):Mt(e,o);const l=e.selected===o,h=on(e,o);if(s&&h&&l&&function(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&("both"===e.movable.color||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}(e,o)){e.draggable.current={orig:o,piece:s,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:h,previouslySelected:i,originTarget:t.target},h.cgDragging=!0,h.classList.add("dragging");const a=e.dom.elements.ghost;a&&(a.className=`ghost ${s.color} ${s.role}`,it(a,ot(n)(Ye(o),It(e))),ct(a,!0)),Jt(e)}else c&&wt(e),u&&yt(e);e.dom.redraw()}function Zt(e,t,n,r){const o="a0";e.pieces.set(o,t),e.dom.redraw();const s=ut(n);e.draggable.current={orig:o,piece:t,origPos:s,pos:s,started:!0,element:()=>on(e,o),originTarget:n.target,newPiece:!0,force:!!r},Jt(e)}function Jt(e){requestAnimationFrame((()=>{var t;const n=e.draggable.current;if(!n)return;(null===(t=e.animation.current)||void 0===t?void 0:t.plan.anims.has(n.orig))&&(e.animation.current=void 0);const r=e.pieces.get(n.orig);if(r&&nt(r,n.piece)){if(!n.started&&tt(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if("function"==typeof n.element){const e=n.element();if(!e)return;e.cgDragging=!0,e.classList.add("dragging"),n.element=e}const t=e.dom.bounds();it(n.element,[n.pos[0]-t.left-t.width/16,n.pos[1]-t.top-t.height/16])}}else nn(e);Jt(e)}))}function en(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=ut(t))}function tn(e,t){const n=e.draggable.current;if(!n)return;if("touchend"===t.type&&!1!==t.cancelable&&t.preventDefault(),"touchend"===t.type&&n.originTarget!==t.target&&!n.newPiece)return void(e.draggable.current=void 0);wt(e),yt(e);const r=Dt(ut(t)||n.pos,It(e),e.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?xt(e,n.orig,r,n.force):(e.stats.ctrlKey=t.ctrlKey,qt(e,n.orig,r)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(n.orig),kt(e.events.change)),(n.orig!==n.previouslySelected||n.orig!==r&&r)&&e.selectable.enabled||Pt(e),rn(e),e.draggable.current=void 0,e.dom.redraw()}function nn(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,Pt(e),rn(e),e.dom.redraw())}function rn(e){const t=e.dom.elements;t.ghost&&ct(t.ghost,!1)}function on(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&"PIECE"===n.tagName)return n;n=n.nextSibling}}function sn(e,t,n){sn.close();const r=$('<div id="modal-wrap"><span class="close" data-icon="L"></span></div>'),o=$(`<div id="modal-overlay" class="${t}">`).on("click",sn.close);return r.appendTo(o),e.clone().removeClass("none").appendTo(r),sn.onClose=n,r.find(".close").on("click",sn.close),r.on("click",(e=>e.stopPropagation())),$("body").addClass("overlayed").prepend(o),r}sn.close=()=>{$("body").removeClass("overlayed"),$("#modal-overlay").each((function(){sn.onClose&&sn.onClose(),$(this).remove()})),delete sn.onClose},sn.onClose=void 0;const an="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",cn={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},un={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function ln(e){"start"===e&&(e=an);const t=new Map;let n=7,r=0;for(const o of e)switch(o){case" ":return t;case"/":if(--n,n<0)return t;r=0;break;case"~":{const e=t.get(Ge([r,n]));e&&(e.promoted=!0);break}default:{const e=o.charCodeAt(0);if(e<57)r+=e-48;else{const e=o.toLowerCase();t.set(Ge([r,n]),{role:cn[e],color:o===e?"black":"white"}),++r}}}return t}function hn(e,t){var n,r;if((null===(n=t.movable)||void 0===n?void 0:n.dests)&&(e.movable.dests=void 0),(null===(r=t.drawable)||void 0===r?void 0:r.autoShapes)&&(e.drawable.autoShapes=[]),dn(e,t),t.fen&&(e.pieces=ln(t.fen),e.drawable.shapes=[]),"check"in t&&function(e,t){if(e.check=void 0,!0===t&&(t=e.turnColor),t)for(const[n,r]of e.pieces)"king"===r.role&&r.color===t&&(e.check=n)}(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&At(e,e.selected),(!e.animation.duration||e.animation.duration<100)&&(e.animation.enabled=!1),!e.movable.rookCastle&&e.movable.dests){const t="white"===e.movable.color?"1":"8",n="e"+t,r=e.movable.dests.get(n),o=e.pieces.get(n);if(!r||!o||"king"!==o.role)return;e.movable.dests.set(n,r.filter((e=>!(e==="a"+t&&r.includes("c"+t)||e==="h"+t&&r.includes("g"+t)))))}}function dn(e,t){for(const n in t)pn(e[n])&&pn(t[n])?dn(e[n],t[n]):e[n]=t[n]}function pn(e){return"object"==typeof e}function fn(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function mn(e,t){function n(){!function(e){e.orientation=et(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}(e),t()}return{set(t){t.orientation&&t.orientation!==e.orientation&&n(),(t.fen?Ht:Qt)((e=>hn(e,t)),e)},state:e,getFen:()=>{return t=e.pieces,We.map((e=>He.map((n=>{const r=t.get(n+e);if(r){const e=un[r.role];return"white"===r.color?e.toUpperCase():e}return"1"})).join(""))).join("/").replace(/1{2,}/g,(e=>e.length.toString()));var t},toggleOrientation:n,setPieces(t){Ht((e=>function(e,t){for(const[n,r]of t)r?e.pieces.set(n,r):e.pieces.delete(n)}(e,t)),e)},selectSquare(t,n){t?Ht((e=>Mt(e,t,n)),e):e.selected&&(Pt(e),e.dom.redraw())},move(t,n){Ht((e=>Ct(e,t,n)),e)},newPiece(t,n){Ht((e=>St(e,t,n)),e)},playPremove(){if(e.premovable.current){if(Ht(Tt,e))return!0;e.dom.redraw()}return!1},playPredrop(t){if(e.predroppable.current){const n=function(e,t){const n=e.predroppable.current;let r=!1;if(!n)return!1;t(n)&&St(e,{role:n.role,color:e.movable.color},n.key)&&(kt(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),r=!0);return yt(e),r}(e,t);return e.dom.redraw(),n}return!1},cancelPremove(){Qt(wt,e)},cancelPredrop(){Qt(yt,e)},cancelMove(){Qt((e=>{Kt(e),nn(e)}),e)},stop(){Qt((e=>{Nt(e),nn(e)}),e)},explode(t){!function(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout((()=>{fn(e,2),setTimeout((()=>fn(e,void 0)),120)}),120)}(e,t)},setAutoShapes(t){Qt((e=>e.drawable.autoShapes=t),e)},setShapes(t){Qt((e=>e.drawable.shapes=t),e)},getKeyAtDomPos:t=>Dt(t,It(e),e.dom.bounds()),redrawAll:t,dragNewPiece(t,n,r){Zt(e,t,n,r)},destroy(){Nt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function gn(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function bn(e,t,n){const r=e.drawable,o=r.current,s=o&&o.mouseSq?o:void 0,i=new Map,a=e.dom.bounds();for(const e of r.shapes.concat(r.autoShapes).concat(s?[s]:[]))e.dest&&i.set(e.dest,(i.get(e.dest)||0)+1);const c=r.shapes.concat(r.autoShapes).map((e=>({shape:e,current:!1,hash:kn(e,i,!1,a)})));s&&c.push({shape:s,current:!0,hash:kn(s,i,!0,a)});const u=c.map((e=>e.hash)).join(";");if(u===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=u;const l=t.querySelector("defs"),h=t.querySelector("g"),d=n.querySelector("g");!function(e,t,n){const r=new Map;let o;for(const n of t)n.shape.dest&&(o=e.brushes[n.shape.brush],n.shape.modifiers&&(o=xn(o,n.shape.modifiers)),r.set(o.key,o));const s=new Set;let i=n.firstChild;for(;i;)s.add(i.getAttribute("cgKey")),i=i.nextSibling;for(const[e,t]of r.entries())s.has(e)||n.appendChild(Sn(t))}(r,c,l),vn(e,c.filter((e=>!e.shape.customSvg)),r.brushes,i,h),vn(e,c.filter((e=>e.shape.customSvg)),r.brushes,i,d)}function vn(e,t,n,r,o){const s=e.dom.bounds(),i=new Map,a=[];for(const e of t)i.set(e.hash,!1);let c,u=o.firstChild;for(;u;)c=u.getAttribute("cgHash"),i.has(c)?i.set(c,!0):a.push(u),u=u.nextSibling;for(const e of a)o.removeChild(e);for(const a of t)i.get(a.hash)||o.appendChild(Cn(e,a,n,r,s))}function kn({orig:e,dest:t,brush:n,piece:r,modifiers:o,customSvg:s},i,a,c){return[c.width,c.height,a,e,t,n,t&&(i.get(t)||0)>1,r&&wn(r),o&&(u=o,""+(u.lineWidth||"")),s&&yn(s)].filter((e=>e)).join(",");var u}function wn(e){return[e.color,e.role,e.scale].filter((e=>e)).join(",")}function yn(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return"custom-"+t.toString()}function Cn(e,{shape:t,current:n,hash:r},o,s,i){let a;if(t.customSvg){const n=qn(Ye(t.orig),e.orientation);a=function(e,t,n){const{width:r,height:o}=n,s=r/8,i=o/8,a=t[0]*s,c=(7-t[1])*i,u=En(gn("g"),{transform:`translate(${a},${c})`}),l=En(gn("svg"),{width:s,height:i,viewBox:"0 0 100 100"});return u.appendChild(l),l.innerHTML=e,u}(t.customSvg,n,i)}else if(t.piece)a=function(e,t,n,r){const o=Pn(t,r),s=r.width/8*(n.scale||1),i=n.color[0]+("knight"===n.role?"n":n.role[0]).toUpperCase();return En(gn("image"),{className:`${n.role} ${n.color}`,x:o[0]-s/2,y:o[1]-s/2,width:s,height:s,href:e+i+".svg"})}(e.drawable.pieces.baseUrl,qn(Ye(t.orig),e.orientation),t.piece,i);else{const r=qn(Ye(t.orig),e.orientation);if(t.dest){let c=o[t.brush];t.modifiers&&(c=xn(c,t.modifiers)),a=function(e,t,n,r,o,s){const i=function(e,t){return(t?20:10)/512*e.width}(s,o&&!r),a=Pn(t,s),c=Pn(n,s),u=c[0]-a[0],l=c[1]-a[1],h=Math.atan2(l,u),d=Math.cos(h)*i,p=Math.sin(h)*i;return En(gn("line"),{stroke:e.color,"stroke-width":Mn(e,r,s),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:An(e,r),x1:a[0],y1:a[1],x2:c[0]-d,y2:c[1]-p})}(c,r,qn(Ye(t.dest),e.orientation),n,(s.get(t.dest)||0)>1,i)}else a=function(e,t,n,r){const o=Pn(t,r),s=function(e){const t=e.width/512;return[3*t,4*t]}(r),i=(r.width+r.height)/32;return En(gn("circle"),{stroke:e.color,"stroke-width":s[n?0:1],fill:"none",opacity:An(e,n),cx:o[0],cy:o[1],r:i-s[1]/2})}(o[t.brush],r,n,i)}return a.setAttribute("cgHash",r),a}function Sn(e){const t=En(gn("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(En(gn("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function En(e,t){for(const n in t)e.setAttribute(n,t[n]);return e}function qn(e,t){return"white"===t?e:[7-e[0],7-e[1]]}function xn(e,t){return{color:e.color,opacity:Math.round(10*e.opacity)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter((e=>e)).join("")}}function Mn(e,t,n){return(e.lineWidth||10)*(t?.85:1)/512*n.width}function An(e,t){return(e.opacity||1)*(t?.9:1)}function Pn(e,t){return[(e[0]+.5)*t.width/8,(7.5-e[1])*t.height/8]}function On(e,t){const n=ht("coords",t);let r;for(const t of e)r=ht("coord"),r.textContent=t,n.appendChild(r);return n}function Rn(e,t){const n=e.dom.elements.board;if(!e.dom.relative&&e.resizable&&"ResizeObserver"in window){new window.ResizeObserver(t).observe(n)}if(e.viewOnly)return;const r=function(e){return t=>{e.draggable.current?nn(e):e.drawable.current?Ut(e):t.shiftKey||lt(t)?e.drawable.enabled&&Lt(e,t):e.viewOnly||(e.dropmode.active?function(e,t){if(!e.dropmode.active)return;wt(e),yt(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const r=ut(t),o=r&&Dt(r,It(e),e.dom.bounds());o&&xt(e,"a0",o)}e.dom.redraw()}(e,t):Yt(e,t))}}(e);n.addEventListener("touchstart",r,{passive:!1}),n.addEventListener("mousedown",r,{passive:!1}),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",(e=>e.preventDefault()))}function Fn(e,t,n,r){return e.addEventListener(t,n,r),()=>e.removeEventListener(t,n,r)}function Tn(e,t,n){return r=>{e.drawable.current?e.drawable.enabled&&n(e,r):e.viewOnly||t(e,r)}}function Kn(e){const t=It(e),n=e.dom.relative?st:ot(e.dom.bounds()),r=e.dom.relative?at:it,o=e.dom.elements.board,s=e.pieces,i=e.animation.current,a=i?i.plan.anims:new Map,c=i?i.plan.fadings:new Map,u=e.draggable.current,l=function(e){var t;const n=new Map;if(e.lastMove&&e.highlight.lastMove)for(const t of e.lastMove)zn(n,t,"last-move");e.check&&e.highlight.check&&zn(n,e.check,"check");if(e.selected&&(zn(n,e.selected,"selected"),e.movable.showDests)){const r=null===(t=e.movable.dests)||void 0===t?void 0:t.get(e.selected);if(r)for(const t of r)zn(n,t,"move-dest"+(e.pieces.has(t)?" oc":""));const o=e.premovable.dests;if(o)for(const t of o)zn(n,t,"premove-dest"+(e.pieces.has(t)?" oc":""))}const r=e.premovable.current;if(r)for(const e of r)zn(n,e,"current-premove");else e.predroppable.current&&zn(n,e.predroppable.current.key,"current-premove");const o=e.exploding;if(o)for(const e of o.keys)zn(n,e,"exploding"+o.stage);return n}(e),h=new Set,d=new Set,p=new Map,f=new Map;let m,g,b,v,k,w,y,C,S,E;for(g=o.firstChild;g;){if(m=g.cgKey,Nn(g))if(b=s.get(m),k=a.get(m),w=c.get(m),v=g.cgPiece,!g.cgDragging||u&&u.orig===m||(g.classList.remove("dragging"),r(g,n(Ye(m),t)),g.cgDragging=!1),!w&&g.cgFading&&(g.cgFading=!1,g.classList.remove("fading")),b){if(k&&g.cgAnimating&&v===Ln(b)){const e=Ye(m);e[0]+=k[2],e[1]+=k[3],g.classList.add("anim"),r(g,n(e,t))}else g.cgAnimating&&(g.cgAnimating=!1,g.classList.remove("anim"),r(g,n(Ye(m),t)),e.addPieceZIndex&&(g.style.zIndex=Bn(Ye(m),t)));v!==Ln(b)||w&&g.cgFading?w&&v===Ln(w)?(g.classList.add("fading"),g.cgFading=!0):$n(p,v,g):h.add(m)}else $n(p,v,g);else if(Dn(g)){const e=g.className;l.get(m)===e?d.add(m):$n(f,e,g)}g=g.nextSibling}for(const[e,s]of l)if(!d.has(e)){S=f.get(s),E=S&&S.pop();const i=n(Ye(e),t);if(E)E.cgKey=e,r(E,i);else{const t=ht("square",s);t.cgKey=e,r(t,i),o.insertBefore(t,o.firstChild)}}for(const[i,c]of s)if(k=a.get(i),!h.has(i))if(y=p.get(Ln(c)),C=y&&y.pop(),C){C.cgKey=i,C.cgFading&&(C.classList.remove("fading"),C.cgFading=!1);const o=Ye(i);e.addPieceZIndex&&(C.style.zIndex=Bn(o,t)),k&&(C.cgAnimating=!0,C.classList.add("anim"),o[0]+=k[2],o[1]+=k[3]),r(C,n(o,t))}else{const s=Ln(c),a=ht("piece",s),u=Ye(i);a.cgPiece=s,a.cgKey=i,k&&(a.cgAnimating=!0,u[0]+=k[2],u[1]+=k[3]),r(a,n(u,t)),e.addPieceZIndex&&(a.style.zIndex=Bn(u,t)),o.appendChild(a)}for(const t of p.values())In(e,t);for(const t of f.values())In(e,t)}function Nn(e){return"PIECE"===e.tagName}function Dn(e){return"SQUARE"===e.tagName}function In(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function Bn(e,t){let n=2+8*e[1]+(7-e[0]);return t&&(n=67-n),n+""}function Ln(e){return`${e.color} ${e.role}`}function zn(e,t,n){const r=e.get(t);r?e.set(t,`${r} ${n}`):e.set(t,n)}function $n(e,t,n){const r=e.get(t);r?r.push(n):e.set(t,[n])}function _n(e,t){const n={pieces:ln(an),orientation:"white",turnColor:"white",coordinates:!0,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,resizable:!0,addPieceZIndex:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},pieces:{baseUrl:"https://lichess1.org/assets/piece/cburnett/"},prevSvgHash:""},hold:Je()};function r(){const t="dom"in n?n.dom.unbind:void 0,r=n.viewOnly&&!n.drawable.visible,o=function(e,t,n){e.innerHTML="",e.classList.add("cg-wrap");for(const n of je)e.classList.toggle("orientation-"+n,t.orientation===n);e.classList.toggle("manipulable",!t.viewOnly);const r=ht("cg-helper");e.appendChild(r);const o=ht("cg-container");r.appendChild(o);const s=ht("cg-board");let i,a,c;if(o.appendChild(s),t.drawable.visible&&!n&&(i=En(gn("svg"),{class:"cg-shapes"}),i.appendChild(gn("defs")),i.appendChild(gn("g")),a=En(gn("svg"),{class:"cg-custom-svgs"}),a.appendChild(gn("g")),o.appendChild(i),o.appendChild(a)),t.coordinates){const e="black"===t.orientation?" black":"";o.appendChild(On(Qe,"ranks"+e)),o.appendChild(On(He,"files"+e))}return t.draggable.showGhost&&!n&&(c=ht("piece","ghost"),ct(c,!1),o.appendChild(c)),{board:s,container:o,ghost:c,svg:i,customSvg:a}}(e,n,r),s=function(e){let t;const n=()=>(void 0===t&&(t=e()),t);return n.clear=()=>{t=void 0},n}((()=>o.board.getBoundingClientRect())),i=e=>{Kn(c),!e&&o.svg&&bn(c,o.svg,o.customSvg)},a=()=>{s.clear(),function(e){if(e.dom.relative)return;const t=It(e),n=ot(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(Nn(r)&&!r.cgAnimating||Dn(r))&&it(r,n(Ye(r.cgKey),t)),r=r.nextSibling}(c),o.svg&&bn(c,o.svg,o.customSvg)},c=n;return c.dom={elements:o,bounds:s,redraw:Un(i),redrawNow:i,unbind:t,relative:r},c.drawable.prevSvgHash="",i(!1),Rn(c,a),t||(c.dom.unbind=function(e,t){const n=[];if(e.dom.relative||!e.resizable||"ResizeObserver"in window||n.push(Fn(document.body,"chessground.resize",t)),!e.viewOnly){const t=Tn(e,en,$t),r=Tn(e,tn,_t);for(const e of["touchmove","mousemove"])n.push(Fn(document,e,t));for(const e of["touchend","mouseup"])n.push(Fn(document,e,r));const o=()=>e.dom.bounds.clear();n.push(Fn(document,"scroll",o,{capture:!0,passive:!0})),n.push(Fn(window,"resize",o,{passive:!0}))}return()=>n.forEach((e=>e()))}(c,a)),c.events.insert&&c.events.insert(o),c}return hn(n,t||{}),mn(r(),r)}function Un(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame((()=>{e(),t=!1})))}}const Vn=()=>{const e={blue:"#DEE3E6 #788a94",blue2:"#97b2c7 #546f82",blue3:"#d9e0e6 #315991",canvas:"#d7daeb #547388",wood:"#d8a45b #9b4d0f",wood2:"#a38b5d #6c5017",wood3:"#d0ceca #755839",wood4:"#caaf7d #7b5330",maple:"#e8ceab #bc7944",maple2:"#E2C89F #996633",leather:"#d1d1c9 #c28e16",green:"#FFFFDD #6d8753",brown:"#F0D9B5 #946f51",pink:"#E8E9B7 #ED7272",marble:"#93ab91 #4f644e","blue-marble":"#EAE6DD #7C7F87","green-plastic":"#f2f9bb #59935d",grey:"#b8b8b8 #7d7d7d",metal:"#c9c9c9 #727272",olive:"#b8b19f #6d6655",newspaper:"#fff #8d8d8d",purple:"#9f90b0 #7d4a8d","purple-diag":"#E5DAF0 #957AB0",ic:"#ececec #c1c18e",horsey:"#F0D9B5 #946f51"};for(const t of document.body.className.split(" "))if(t in e){const n=document.documentElement.style,r=e[t].split(" ");n.setProperty("--cg-coord-color-white",r[0]),n.setProperty("--cg-coord-color-black",r[1]),n.setProperty("--cg-coord-shadow","none")}};function jn(e){return h("div.cg-wrap",{hook:{insert:t=>{const n=t.elm;e.chessground=_n(n,function(e){return{fen:e.cfg.fen,orientation:e.options.orientation||"white",coordinates:!e.cfg.embed,autoCastle:!1,addPieceZIndex:e.cfg.is3d,movable:{free:!0,color:"both"},animation:{duration:e.cfg.animation.duration},premovable:{enabled:!1},drawable:{enabled:!0,defaultSnapToValidMove:"0"!=(lichess.storage.get("arrow.snap")||1)},draggable:{showGhost:!0,deleteOnDropOff:!0},selectable:{enabled:!1},highlight:{lastMove:!1},events:{change:e.onChange.bind(e),insert:Vn}}}(e)),function(e,t){const n=function(e){return function(t){const n=e.selected();if("pointer"===n||!1===t.cancelable||"touchstart"!==t.type&&"touchmove"!==t.type||t.preventDefault(),function(e){return Hn(e)&&!e.ctrlKey}(t)||"touchstart"===t.type||"touchmove"===t.type){if("pointer"===n||e.chessground&&e.chessground.state.draggable.current&&e.chessground.state.draggable.current.newPiece)return;const r=ut(t);if(!r)return;const o=e.chessground.getKeyAtDomPos(r);if(!o)return;if("mousedown"!==t.type&&"touchstart"!==t.type||(Qn=o),"trash"===n)Gn(e,o,t);else{const r=e.chessground.state.pieces.get(o),s={color:n[0],role:n[1]},i=r&&s.color==r.color&&s.role==r.role;if("mousedown"!==t.type&&"touchstart"!==t.type||!i)Xn||"mousedown"!==t.type&&"touchstart"!==t.type&&o===Wn||(e.chessground.setPieces(new Map([[o,s]])),e.onChange(),e.chessground.cancelMove());else{Gn(e,o,t),Xn=!0;const n={mousedown:"mouseup",touchstart:"touchend"};document.addEventListener(n[t.type],(()=>Xn=!1),{once:!0})}}Wn=o}else(function(e){return lt(e)||!!e.ctrlKey&&Hn(e)})(t)&&"pointer"!==n&&(e.chessground.state.drawable.current=void 0,e.chessground.state.drawable.shapes=[],"contextmenu"===t.type&&"trash"!=n&&(e.chessground.cancelMove(),n[0]=et(n[0]),e.redraw()))}}(t);["touchstart","touchmove","mousedown","mousemove","contextmenu"].forEach((function(t){e.addEventListener(t,n)}))}(n,e)},destroy:t=>e.chessground.destroy()}})}function Hn(e){return 1===e.buttons||1===e.button}let Qn,Wn,Xn;function Gn(e,t,n){"touchstart"===n.type?(e.chessground.state.pieces.has(t)&&(e.chessground.state.draggable.current.element.style.display="none",e.chessground.cancelMove()),document.addEventListener("touchend",(()=>Yn(e,t)),{once:!0})):"mousedown"!==n.type&&t===Qn||Yn(e,t)}function Yn(e,t){e.chessground.setPieces(new Map([[t,void 0]])),e.onChange()}function Zn(e,t,n,r){const o=h("input",{attrs:{type:"checkbox",checked:e.castlingToggles[t]},on:{change(n){e.setCastlingToggle(t,n.target.checked)}}});return h("label",r?[o,n]:[n,o])}function Jn(e,t){return h("optgroup",{attrs:{label:e}},t)}function er(e,t){return h("form",{attrs:{method:"post",action:"/study/as"}},[h("input",{attrs:{type:"hidden",name:"orientation",value:e.bottomColor()}}),h("input",{attrs:{type:"hidden",name:"variant",value:e.rules}}),h("input",{attrs:{type:"hidden",name:"fen",value:t.legalFen||""}}),h("button",{attrs:{type:"submit","data-icon":"4",disabled:!t.legalFen},class:{button:!0,"button-empty":!0,text:!0,disabled:!t.legalFen}},e.trans.noarg("toStudy"))])}const tr=[["chess","Standard"],["antichess","Antichess"],["atomic","Atomic"],["crazyhouse","Crazyhouse"],["horde","Horde"],["kingofthehill","King of the Hill"],["racingkings","Racing Kings"],["3check","Three-check"]];function nr(e,t){const n=function(e){return h("option",{attrs:{value:e.epd||e.fen,"data-fen":e.fen}},e.eco?`${e.eco} ${e.name}`:e.name)};return h("div.board-editor__tools",[...e.cfg.embed||!e.cfg.positions?[]:[h("div",[h("select.positions",{props:{value:t.fen.split(" ").slice(0,4).join(" ")},on:{change(t){const n=t.target;let r=n.selectedOptions[0].getAttribute("data-fen");"prompt"==r&&(r=(prompt("Paste FEN")||"").trim()),r&&e.setFen(r)||(n.value="")}}},[Jn(e.trans.noarg("setTheBoard"),[h("option",{attrs:{selected:!0}},`- ${e.trans.noarg("boardEditor")}  -`),...e.extraPositions.map(n)]),Jn(e.trans.noarg("popularOpenings"),e.cfg.positions.map(n))])])],h("div.metadata",[h("div.color",h("select",{on:{change(t){e.setTurn(t.target.value)}}},["whitePlays","blackPlays"].map((function(t){return h("option",{attrs:{value:"w"==t[0]?"white":"black",selected:e.turn[0]===t[0]}},e.trans(t))})))),h("div.castling",[h("strong",e.trans.noarg("castling")),h("div",[Zn(e,"K",e.trans.noarg("whiteCastlingKingside"),!!e.options.inlineCastling),Zn(e,"Q","O-O-O",!0)]),h("div",[Zn(e,"k",e.trans.noarg("blackCastlingKingside"),!!e.options.inlineCastling),Zn(e,"q","O-O-O",!0)])])]),...e.cfg.embed?[h("div.actions",[h("a.button.button-empty",{on:{click(){e.startPosition()}}},e.trans.noarg("startPosition")),h("a.button.button-empty",{on:{click(){e.clearBoard()}}},e.trans.noarg("clearBoard"))])]:[h("div",[h("select",{attrs:{id:"variants"},on:{change(t){e.setRules(t.target.value)}}},tr.map((t=>function(e,t,n){return h("option",{attrs:{value:e,selected:e==n.rules}},`${n.trans.noarg("variant")} | ${t}`)}(t[0],t[1],e))))]),h("div.actions",[h("a.button.button-empty.text",{attrs:{"data-icon":"q"},on:{click(){e.setFen(Ae)}}},e.trans.noarg("clearBoard")),h("a.button.button-empty.text",{attrs:{"data-icon":"B"},on:{click(){e.chessground.toggleOrientation(),e.redraw()}}},e.trans.noarg("flipBoard")),h("a",{attrs:Object.assign({"data-icon":"A",rel:"nofollow"},t.legalFen?{href:e.makeAnalysisUrl(t.legalFen)}:{}),class:{button:!0,"button-empty":!0,text:!0,disabled:!t.legalFen}},e.trans.noarg("analysis")),h("a",{class:{button:!0,"button-empty":!0,disabled:!t.playable},on:{click:()=>{t.playable&&sn($(".continue-with"))}}},[h("span.text",{attrs:{"data-icon":"U"}},e.trans.noarg("continueFromHere"))]),er(e,t)]),h("div.continue-with.none",[h("a.button",{attrs:{href:"/?fen="+t.legalFen+"#ai",rel:"nofollow"}},e.trans.noarg("playWithTheMachine")),h("a.button",{attrs:{href:"/?fen="+t.legalFen+"#friend",rel:"nofollow"}},e.trans.noarg("playWithAFriend"))])]])}function rr(e,t){if(!e.cfg.embed)return h("div.copyables",[h("p",[h("strong","FEN"),h("input.copyable",{attrs:{spellcheck:!1},props:{value:t},on:{change(t){const n=t.target;e.setFen(n.value.trim()),n.reportValidity()},input(e){const t=e.target,n=Ie(t.value.trim()).isOk;t.setCustomValidity(n?"":"Invalid FEN")},blur(t){const n=t.target;n.value=e.getFen(),n.setCustomValidity("")}}})]),h("p",[h("strong.name","URL"),h("input.copyable.autoselect",{attrs:{readonly:!0,spellcheck:!1,value:e.makeUrl(e.cfg.baseUrl,t)}})])])}function or(e){return"pointer"===e||"trash"===e?e:e.join(" ")}let sr;function ir(e,t,n,r){const o=or(e.selected()),s=["king","queen","rook","bishop","knight","pawn"].map((function(e){return[t,e]}));return h("div",{attrs:{class:["spare","spare-"+r,"spare-"+t].join(" ")}},["pointer",...s,"trash"].map((t=>{const n=or(t),r=Object.assign({class:n},"pointer"!==t&&"trash"!==t?{"data-color":t[0],"data-role":t[1]}:{});return h("div",{class:{"no-square":!0,pointer:"pointer"===t,trash:"trash"===t,"selected-square":!(o!==n||e.chessground&&e.chessground.state.draggable.current&&e.chessground.state.draggable.current.newPiece)},on:{mousedown:ar(e,t,"mouseup"),touchstart:ar(e,t,"touchend"),touchmove:e=>{sr=ut(e)}}},[h("div",[h("piece",{attrs:r})])])})))}function ar(e,t,n){return function(r){r.preventDefault(),"pointer"===t||"trash"===t?(e.selected(t),e.redraw()):(e.selected("pointer"),Zt(e.chessground.state,{color:t[0],role:t[1]},r,!0),document.addEventListener(n,(n=>{const r=ut(n)||sr;r&&e.chessground.getKeyAtDomPos(r)?e.selected("pointer"):e.selected(t),e.redraw()}),{once:!0}))}}function cr(e){if("pointer"===e)return"pointer";const t="trash"===e?"trash":e.join("-");return`url('${lichess.assetUrl("cursors/"+t+".cur")}'), default !important`}function ur(e){const t=e.getState(),n=e.bottomColor();return h("div.board-editor",{attrs:{style:`cursor: ${cr(e.selected())}`}},[ir(e,et(n),0,"top"),h("div.main-board",[jn(e)]),ir(e,n,0,"bottom"),nr(e,t),rr(e,t.fen)])}const lr=function(l,h){let d,p;const f={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},m=void 0!==h?h:e;for(d=0;d<u.length;++d)for(f[u[d]]=[],p=0;p<l.length;++p){const e=l[p][u[d]];void 0!==e&&f[u[d]].push(e)}function g(e){const n=e.id?"#"+e.id:"",r=e.className?"."+e.className.split(" ").join("."):"";return t(m.tagName(e).toLowerCase()+n+r,{},[],void 0,e)}function b(e,t){return function(){if(0==--t){const t=m.parentNode(e);m.removeChild(t,e)}}}function v(e,t){var a,c;let u,l=e.data;if(void 0!==l){const t=null===(a=l.hook)||void 0===a?void 0:a.init;s(t)&&(t(e),l=e.data)}const h=e.children,d=e.sel;if("!"===d)o(e.text)&&(e.text=""),e.elm=m.createComment(e.text);else if(void 0!==d){const o=d.indexOf("#"),a=d.indexOf(".",o),p=o>0?o:d.length,g=a>0?a:d.length,b=-1!==o||-1!==a?d.slice(0,Math.min(p,g)):d,k=e.elm=s(l)&&s(u=l.ns)?m.createElementNS(u,b,l):m.createElement(b,l);for(p<g&&k.setAttribute("id",d.slice(p+1,g)),a>0&&k.setAttribute("class",d.slice(g+1).replace(/\./g," ")),u=0;u<f.create.length;++u)f.create[u](i,e);if(n(h))for(u=0;u<h.length;++u){const e=h[u];null!=e&&m.appendChild(k,v(e,t))}else r(e.text)&&m.appendChild(k,m.createTextNode(e.text));const w=e.data.hook;s(w)&&(null===(c=w.create)||void 0===c||c.call(w,i,e),w.insert&&t.push(e))}else e.elm=m.createTextNode(e.text);return e.elm}function k(e,t,n,r,o,s){for(;r<=o;++r){const o=n[r];null!=o&&m.insertBefore(e,v(o,s),t)}}function w(e){var t,n;const r=e.data;if(void 0!==r){null===(n=null===(t=null==r?void 0:r.hook)||void 0===t?void 0:t.destroy)||void 0===n||n.call(t,e);for(let t=0;t<f.destroy.length;++t)f.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const n=e.children[t];null!=n&&"string"!=typeof n&&w(n)}}}function y(e,t,n,r){for(var o,i;n<=r;++n){let r,a;const c=t[n];if(null!=c)if(s(c.sel)){w(c),r=f.remove.length+1,a=b(c.elm,r);for(let e=0;e<f.remove.length;++e)f.remove[e](c,a);const e=null===(i=null===(o=null==c?void 0:c.data)||void 0===o?void 0:o.hook)||void 0===i?void 0:i.remove;s(e)?e(c,a):a()}else m.removeChild(e,c.elm)}}function C(e,t,n){var r,i,u,l,h;const d=null===(r=t.data)||void 0===r?void 0:r.hook;null===(i=null==d?void 0:d.prepatch)||void 0===i||i.call(d,e,t);const p=t.elm=e.elm,g=e.children,b=t.children;if(e!==t){if(void 0!==t.data){for(let n=0;n<f.update.length;++n)f.update[n](e,t);null===(l=null===(u=t.data.hook)||void 0===u?void 0:u.update)||void 0===l||l.call(u,e,t)}o(t.text)?s(g)&&s(b)?g!==b&&function(e,t,n,r){let s,i,u,l,h=0,d=0,p=t.length-1,f=t[0],g=t[p],b=n.length-1,w=n[0],S=n[b];for(;h<=p&&d<=b;)null==f?f=t[++h]:null==g?g=t[--p]:null==w?w=n[++d]:null==S?S=n[--b]:a(f,w)?(C(f,w,r),f=t[++h],w=n[++d]):a(g,S)?(C(g,S,r),g=t[--p],S=n[--b]):a(f,S)?(C(f,S,r),m.insertBefore(e,f.elm,m.nextSibling(g.elm)),f=t[++h],S=n[--b]):a(g,w)?(C(g,w,r),m.insertBefore(e,g.elm,f.elm),g=t[--p],w=n[++d]):(void 0===s&&(s=c(t,h,p)),i=s[w.key],o(i)?m.insertBefore(e,v(w,r),f.elm):(u=t[i],u.sel!==w.sel?m.insertBefore(e,v(w,r),f.elm):(C(u,w,r),t[i]=void 0,m.insertBefore(e,u.elm,f.elm))),w=n[++d]);(h<=p||d<=b)&&(h>p?(l=null==n[b+1]?null:n[b+1].elm,k(e,l,n,d,b,r)):y(e,t,h,p))}(p,g,b,n):s(b)?(s(e.text)&&m.setTextContent(p,""),k(p,null,b,0,b.length-1,n)):s(g)?y(p,g,0,g.length-1):s(e.text)&&m.setTextContent(p,""):e.text!==t.text&&(s(g)&&y(p,g,0,g.length-1),m.setTextContent(p,t.text)),null===(h=null==d?void 0:d.postpatch)||void 0===h||h.call(d,e,t)}}return function(e,t){let n,r,o;const s=[];for(n=0;n<f.pre.length;++n)f.pre[n]();for(function(e){return void 0!==e.sel}(e)||(e=g(e)),a(e,t)?C(e,t,s):(r=e.elm,o=m.parentNode(r),v(t,s),null!==o&&(m.insertBefore(o,t.elm,m.nextSibling(r)),y(o,[e],0,0))),n=0;n<s.length;++n)s[n].data.hook.insert(s[n]);for(n=0;n<f.post.length;++n)f.post[n]();return t}}([m,p,y,k]);return window.Chessground=_n,function(e,t){const n=new Ve(t,(function(){o=lr(o,ur(n))}));e.innerHTML="";const r=document.createElement("div");e.appendChild(r);let o=lr(r,ur(n));return function(){if("ontouchstart"in window)return;let e,t;const n=n=>{e=n.pageX,t=n.pageY};let r={};$("#topnav.hover").each((function(){const o=$(this).removeClass("hover"),s=()=>o.toggleClass("hover"),i=()=>{Math.sqrt((r.pX-e)*(r.pX-e)+(r.pY-t)*(r.pY-t))<8?(o.off(r.event,n),delete r.timeoutId,r.isActive=!0,s()):(r.pX=e,r.pY=t,r.timeoutId=setTimeout(i,200))},a=function(e){r.timeoutId&&(r.timeoutId=clearTimeout(r.timeoutId));const t=r.event="mousemove";if("mouseover"==e.type){if(r.isActive||e.buttons)return;r.pX=e.pageX,r.pY=e.pageY,o.off(t,n).on(t,n),r.timeoutId=setTimeout(i,200)}else{if(!r.isActive)return;o.off(t,n),r={},s()}};o.on("mouseover",a).on("mouseleave",a)}))}(),{getFen:n.getFen.bind(n),setOrientation:n.setOrientation.bind(n)}}}();
