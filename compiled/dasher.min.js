var LichessDasher=function(){"use strict";const e={createElement:function(e,t){return document.createElement(e,t)},createElementNS:function(e,t,n){return document.createElementNS(e,t,n)},createTextNode:function(e){return document.createTextNode(e)},createComment:function(e){return document.createComment(e)},insertBefore:function(e,t,n){e.insertBefore(t,n)},removeChild:function(e,t){e.removeChild(t)},appendChild:function(e,t){e.appendChild(t)},parentNode:function(e){return e.parentNode},nextSibling:function(e){return e.nextSibling},tagName:function(e){return e.tagName},setTextContent:function(e,t){e.textContent=t},getTextContent:function(e){return e.textContent},isElement:function(e){return 1===e.nodeType},isText:function(e){return 3===e.nodeType},isComment:function(e){return 8===e.nodeType}};function t(e,t,n,o,r){return{sel:e,data:t,children:n,text:o,elm:r,key:void 0===t?void 0:t.key}}const n=Array.isArray;function o(e){return"string"==typeof e||"number"==typeof e}function r(e){return void 0===e}function s(e){return void 0!==e}const a=t("",{},[],void 0,void 0);function i(e,t){var n,o;const r=e.key===t.key,s=(null===(n=e.data)||void 0===n?void 0:n.is)===(null===(o=t.data)||void 0===o?void 0:o.is);return e.sel===t.sel&&r&&s}function c(e,t,n){var o;const r={};for(let s=t;s<=n;++s){const t=null===(o=e[s])||void 0===o?void 0:o.key;void 0!==t&&(r[t]=s)}return r}const l=["create","update","remove","destroy","pre","post"];function d(e,t,n){if(e.ns="http://www.w3.org/2000/svg","foreignObject"!==n&&void 0!==t)for(let e=0;e<t.length;++e){const n=t[e].data;void 0!==n&&d(n,t[e].children,t[e].sel)}}function u(e,r,s){let a,i,c,l={};if(void 0!==s?(null!==r&&(l=r),n(s)?a=s:o(s)?i=s:s&&s.sel&&(a=[s])):null!=r&&(n(r)?a=r:o(r)?i=r:r&&r.sel?a=[r]:l=r),void 0!==a)for(c=0;c<a.length;++c)o(a[c])&&(a[c]=t(void 0,void 0,void 0,a[c],void 0));return"s"!==e[0]||"v"!==e[1]||"g"!==e[2]||3!==e.length&&"."!==e[3]&&"#"!==e[3]||d(l,a,e),t(e,l,a,i,void 0)}function p(e,t){let n;const o=t.elm;let r=e.data.attrs,s=t.data.attrs;if((r||s)&&r!==s){for(n in r=r||{},s=s||{},s){const e=s[n];r[n]!==e&&(!0===e?o.setAttribute(n,""):!1===e?o.removeAttribute(n):120!==n.charCodeAt(0)?o.setAttribute(n,e):58===n.charCodeAt(3)?o.setAttributeNS("http://www.w3.org/XML/1998/namespace",n,e):58===n.charCodeAt(5)?o.setAttributeNS("http://www.w3.org/1999/xlink",n,e):o.setAttribute(n,e))}for(n in r)n in s||o.removeAttribute(n)}}function m(e,t){let n,o;const r=t.elm;let s=e.data.class,a=t.data.class;if((s||a)&&s!==a){for(o in s=s||{},a=a||{},s)s[o]&&!Object.prototype.hasOwnProperty.call(a,o)&&r.classList.remove(o);for(o in a)n=a[o],n!==s[o]&&r.classList[n?"add":"remove"](o)}}function h(e){return void 0!==e}function f(e,t,n){return{insert:o=>{o.elm.addEventListener(e,(e=>(e.stopPropagation(),t(e),n&&n(),!1)))}}}function g(e,t){return u("a.head.text",{attrs:{"data-icon":"I"},hook:f("click",t)},e)}function v(e){const t=e.ping?e.ping<150?4:e.ping<300?3:e.ping<500?2:1:0,n=[];for(let e=1;e<=4;e++)n.push(u(e<=t?"i":"i.off"));return u("signal.q"+t,n)}function b(e){const t=e.data;return u("a.status",{attrs:{href:"/lag"}},[v(t),u("span.ping",{attrs:{title:"PING: "+e.trans.noarg("networkLagBetweenYouAndLichess")}},[u("em","PING"),u("strong",h(t.ping)?""+t.ping:"?"),u("em","ms")]),u("span.server",{attrs:{title:"SERVER: "+e.trans.noarg("timeToProcessAMoveOnLichessServer")}},[u("em","SERVER"),u("strong",h(t.server)?(n=t.server,[""+Math.floor(n),u("small","."+Math.round(10*(n-Math.floor(n))))]):["?"]),u("em","ms")])]);var n}function k(e,t,n){const o=new Set(e.accepted);return{list:()=>[...e.list.filter((e=>o.has(e[0]))),...e.list],current:e.current,accepted:o,trans:t,close:n}}function y(e,t){let n,o=0;return function(...r){const s=this,a=performance.now()-o;function i(){n=void 0,o=performance.now(),t.apply(s,r)}n&&clearTimeout(n),a>e?i():n=setTimeout(i,e-a)}}const x={Accept:"application/vnd.lichess.v5+json"},w={cache:"no-cache",credentials:"same-origin"},C={"X-Requested-With":"XMLHttpRequest"},E=(e,t={})=>S(e,t).then((e=>{if(e.ok)return e.text();throw e.statusText})),S=(e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},w),{headers:Object.assign({},C)}),t)),N=e=>{const t=new FormData;for(const n of Object.keys(e))t.append(n,e[n]);return t};function T(e,t,n,o){const r=e.map((e=>e.split(" "))),s=lichess.sound,a=e=>E("/pref/soundSet",{body:N({set:e}),method:"post"}).catch((()=>lichess.announce({msg:"Failed to save sound preference"})));return{makeList(){var e;const t=null===(e=window.speechSynthesis)||void 0===e?void 0:e.getVoices().length;return r.filter((e=>"speech"!=e[0]||t))},api:s,set(e){s.speech("speech"==e),lichess.pubsub.emit("speech.enabled",s.speech()),s.speech()?(s.changeSet("standard"),a("standard"),s.say("Speech synthesis ready")):(s.changeSet(e),s.play("genericNotify"),a(e)),n()},volume(e){s.setVolume(e),s.sayOrPlay("move","knight F 7")},redraw:n,trans:t,close:o}}function A(e,t){return n=>u("a.text",{hook:f("click",(()=>e.set(n[0]))),class:{active:t===n[0]},attrs:{"data-icon":"E"}},n[1])}function B(e,t,n=!1){let o,r=0;return function(...s){const a=this;o&&clearTimeout(o),o=void 0;const i=performance.now()-r;r=performance.now(),n&&i>t?e.apply(a,s):o=setTimeout((()=>{o=void 0,e.apply(a,s)}),t)}}function j(e,t,n,o){const r=[{key:"light",name:t.noarg("light")},{key:"dark",name:t.noarg("dark")},{key:"darkBoard",name:"Dark Board",title:"Like Dark, but chess boards are also darker"},{key:"transp",name:t.noarg("transparent")}],s=()=>lichess.announce({msg:"Failed to save background preference"}),a=()=>{window.Highcharts&&lichess.reload()};return{list:r,trans:t,get:()=>e.current,set:y(700,(t=>{e.current=t,E("/pref/bg",{body:N({bg:t}),method:"post"}).then(a,s),F(e,r),n()})),getImage:()=>e.image,setImage(t){e.image=t,E("/pref/bgImg",{body:N({bgImg:t}),method:"post"}).then(a,s),F(e,r),n()},close:o}}function O(e){return u("div.image",[u("p",e.trans.noarg("backgroundImageUrl")),u("input",{attrs:{type:"text",placeholder:"https://",value:e.getImage()},hook:{insert:t=>{$(t.elm).on("change keyup paste",B((function(){const t=this.value.trim();(t.startsWith("https://")||t.startsWith("//"))&&t.length>=10&&t.length<=400&&e.setImage(t)}),300))}}})])}function F(e,t){const n=e.current,o="transp"==n?"dark transp":"darkBoard"==n?"dark dark-board":n;$("body").removeClass([...t.map((e=>e.key)),"dark-board"].join(" ")).addClass(o);const r=$("body").data("theme"),s="darkBoard"==n?"dark":n;if($("body").data("theme",s),$('link[href*=".'+r+'."]').each((function(){const e=document.createElement("link");e.rel="stylesheet",e.href=this.href.replace("."+r+".","."+s+"."),e.onload=()=>setTimeout((()=>this.remove()),100),document.head.appendChild(e)})),"transp"===n){const t=document.getElementById("bg-data");t?t.innerHTML="body.transp::before{background-image:url("+e.image+");}":$("head").append('<style id="bg-data">body.transp::before{background-image:url('+e.image+");}</style>")}}function I(e,t,n,o){const r=()=>parseInt(getComputedStyle(document.body).getPropertyValue("--zoom"))+100,s=B((()=>E("/pref/zoom?v="+r(),{method:"post"}).catch((()=>lichess.announce({msg:"Failed to save zoom"})))),1e3);return{data:e,trans:t,setIs3d(t){e.is3d=t,E("/pref/is3d",{body:N({is3d:t}),method:"post"}).then(lichess.reload,(e=>lichess.announce({msg:"Failed to save geometry  preference"}))),n()},readZoom:r,setZoom(e){document.body.setAttribute("style","--zoom:"+(e-100)),window.dispatchEvent(new Event("resize")),n(),s()},close:o}}function L(e,t,n,o,r){function s(){return e[n()]}return{dimension:n,trans:t,data:s,set(e){const t=s();t.current=e,function(e,t){$("body").removeClass(t.join(" ")).addClass(e),(()=>{const e={blue:"#DEE3E6 #788a94",blue2:"#97b2c7 #546f82",blue3:"#d9e0e6 #315991",canvas:"#d7daeb #547388",wood:"#d8a45b #9b4d0f",wood2:"#a38b5d #6c5017",wood3:"#d0ceca #755839",wood4:"#caaf7d #7b5330",maple:"#e8ceab #bc7944",maple2:"#E2C89F #996633",leather:"#d1d1c9 #c28e16",green:"#FFFFDD #6d8753",brown:"#F0D9B5 #946f51",pink:"#E8E9B7 #ED7272",marble:"#93ab91 #4f644e","blue-marble":"#EAE6DD #7C7F87","green-plastic":"#f2f9bb #59935d",grey:"#b8b8b8 #7d7d7d",metal:"#c9c9c9 #727272",olive:"#b8b19f #6d6655",newspaper:"#fff #8d8d8d",purple:"#9f90b0 #7d4a8d","purple-diag":"#E5DAF0 #957AB0",ic:"#ececec #c1c18e",horsey:"#F0D9B5 #946f51"};for(const t of document.body.className.split(" "))if(t in e){const n=document.documentElement.style,o=e[t].split(" ");n.setProperty("--cg-coord-color-white",o[0]),n.setProperty("--cg-coord-color-black",o[1]),n.setProperty("--cg-coord-shadow","none")}})()}(e,t.list),E("/pref/theme"+("d3"===n()?"3d":""),{body:N({theme:e}),method:"post"}).catch((()=>lichess.announce({msg:"Failed to save theme preference"}))),o()},open:r}}function D(e,t,n,o,r){function s(){return e[n()]}return{dimension:n,trans:t,data:s,set(e){const t=s();t.current=e,function(e,t,n){if(n)$("body").removeClass(t.join(" ")).addClass(e);else{const t=document.getElementById("piece-sprite");t.href=t.href.replace(/\w+\.css/,e+".css")}}(e,t.list,"d3"===n()),E("/pref/pieceSet"+("d3"===n()?"3d":""),{body:N({set:e}),method:"post"}).catch((()=>lichess.announce({msg:"Failed to save piece set  preference"}))),o()},open:r}}function z(e,t){if(t){return`images/staunton/piece/${e}/White-Knight${"Staunton"==e?"-Preview":""}.png`}return`piece/${e}/wN.svg`}const M="links";function P(e,t,n){const o=lichess.trans(t.i18n),r=function(e){let t=e;return function(e){return void 0!==e&&(t=e),t}}(M);function s(e){r(e),n()}function a(){s(M)}const i=function(e,t){const n={ping:void 0,server:void 0},o=lichess.pubsub;return o.emit("socket.send","moveLat",!0),o.on("socket.lag",(e=>{n.ping=Math.round(e),t()})),o.on("socket.in.mlat",(e=>{n.server=e,t()})),{data:n,trans:e}}(o,n),c={langs:k(t.lang,o,a),sound:T(t.sound.list,o,n,a),background:j(t.background,o,n,a),board:I(t.board,o,n,a),theme:L(t.theme,o,(()=>t.board.is3d?"d3":"d2"),n,s),piece:D(t.piece,o,(()=>t.board.is3d?"d3":"d2"),n,s)};return lichess.pubsub.on("top.toggle.user_tag",(()=>s(M))),{mode:r,setMode:s,data:t,trans:o,ping:i,subs:c,opts:e}}const R=(e,t,n)=>({attrs:Object.assign({href:e,"data-icon":t},n||{})});function V(e,t){return{hook:f("click",(()=>e.setMode(t))),attrs:{"data-icon":"H"}}}function H(){return u("div#dasher_app.dropdown",u("div.initiating",u("div.spinner",[u("svg",{attrs:{viewBox:"0 0 40 40"}},[u("circle",{attrs:{cx:20,cy:20,r:18,fill:"none"}})])])))}function Z(e){let t;switch(e.mode()){case"langs":t=function(e){return u("div.sub.langs",[g(e.trans.noarg("language"),e.close),u("form",{attrs:{method:"post",action:"/translation/select"}},e.list().map((t=e.current,n=e.accepted,e=>u("button"+(t===e[0]?".current":"")+(n.has(e[0])?".accepted":""),{attrs:{type:"submit",name:"lang",value:e[0],title:e[0]}},e[1])))),u("a.help.text",{attrs:{href:"https://crowdin.com/project/lichess","data-icon":""}},"Help translate Lichess")]);var t,n}(e.subs.langs);break;case"sound":t=function(e){const t=e.api.speech()?"speech":e.api.soundSet;return u("div.sub.sound."+t,{hook:{insert(){window.speechSynthesis&&(window.speechSynthesis.onvoiceschanged=e.redraw)}}},[g(e.trans("sound"),e.close),u("div.content",[u("input",{attrs:{type:"range",min:0,max:1,step:.01,value:e.api.getVolume(),orient:"vertical"},hook:{insert(t){const n=t.elm,o=y(150,e.volume);$(n).on("input",(()=>o(parseFloat(n.value))))}}}),u("div.selector",e.makeList().map(A(e,t)))])])}(e.subs.sound);break;case"background":t=function(e){const t=e.get();return u("div.sub.background",[g(e.trans.noarg("background"),e.close),u("div.selector.large",e.list.map((n=>u("a.text",{class:{active:t===n.key},attrs:{"data-icon":"E",title:n.title||""},hook:f("click",(()=>e.set(n.key)))},n.name)))),"transp"===t?O(e):null])}(e.subs.background);break;case"board":t=function(e){const t=e.readZoom();return u("div.sub.board",[g(e.trans.noarg("boardGeometry"),e.close),u("div.selector.large",[u("a.text",{class:{active:!e.data.is3d},attrs:{"data-icon":"E"},hook:f("click",(()=>e.setIs3d(!1)))},"2D"),u("a.text",{class:{active:e.data.is3d},attrs:{"data-icon":"E"},hook:f("click",(()=>e.setIs3d(!0)))},"3D")]),u("div.zoom",isNaN(t)?[u("p","No board to zoom here!")]:[u("p",[e.trans.noarg("boardSize"),": ",t-100,"%"]),u("input.range",{attrs:{type:"range",min:100,max:200,step:1,value:e.readZoom()},hook:{insert(t){const n=t.elm;$(n).on("input",(()=>e.setZoom(parseInt(n.value))))}}})])])}(e.subs.board);break;case"theme":t=function(e){const t=e.data();return u("div.sub.theme."+e.dimension(),[g(e.trans.noarg("boardTheme"),(()=>e.open("links"))),u("div.list",t.list.map((n=t.current,o=e.set,e=>u("a",{hook:f("click",(()=>o(e))),attrs:{title:e},class:{active:n===e}},[u("span."+e)]))))]);var n,o}(e.subs.theme);break;case"piece":t=function(e){const t=e.data();return u("div.sub.piece."+e.dimension(),[g(e.trans.noarg("pieceSet"),(()=>e.open("links"))),u("div.list",t.list.map((n=t.current,o=e.set,r="d3"==e.dimension(),e=>u("a.no-square",{attrs:{title:e},hook:f("click",(()=>o(e))),class:{active:n===e}},[u("piece",{attrs:{style:`background-image:url(${lichess.assetUrl(z(e,r))})`}})]))))]);var n,o,r}(e.subs.piece);break;default:t=function(e){const t=e.data,n=e.trans.noarg,o=u("a.sub",V(e,"langs"),n("language")),r=u("a.sub",V(e,"sound"),n("sound")),s=u("a.sub",V(e,"background"),n("background")),a=u("a.sub",V(e,"board"),n("boardGeometry")),i=u("a.sub",V(e,"theme"),n("boardTheme")),c=u("a.sub",V(e,"piece"),n("pieceSet")),l=e.opts.playing?u("div.zen.selector",[u("a.text",{attrs:{"data-icon":"K",title:"Keyboard: z"},hook:f("click",(()=>lichess.pubsub.emit("zen")))},n("zenMode"))]):null;return u("div",[t.user?u("div.links",[u("a.user-link.online.text.is-green",R(`/@/${t.user.name}`,t.user.patron?"":""),n("profile")),u("a.text",R("/inbox","e"),n("inbox")),u("a.text",R("/account/preferences/game-display","%",e.opts.playing?{target:"_blank",rel:"noopener"}:void 0),n("preferences")),t.coach?u("a.text",R("/coach/edit",":"),"Coach manager"):null,t.streamer?u("a.text",R("/streamer/edit",""),"Streamer manager"):null,u("form.logout",{attrs:{method:"post",action:"/logout"}},[u("button.text",{attrs:{type:"submit","data-icon":"w"}},n("logOut"))])]):null,u("div.subs",[o,r,s,a,i,c,l]),b(e.ping)])}(e)}return u("div#dasher_app.dropdown",t)}const q=function(d,u){let p,m;const h={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},f=void 0!==u?u:e;for(p=0;p<l.length;++p)for(h[l[p]]=[],m=0;m<d.length;++m){const e=d[m][l[p]];void 0!==e&&h[l[p]].push(e)}function g(e){const n=e.id?"#"+e.id:"",o=e.className?"."+e.className.split(" ").join("."):"";return t(f.tagName(e).toLowerCase()+n+o,{},[],void 0,e)}function v(e,t){return function(){if(0==--t){const t=f.parentNode(e);f.removeChild(t,e)}}}function b(e,t){var i,c;let l,d=e.data;if(void 0!==d){const t=null===(i=d.hook)||void 0===i?void 0:i.init;s(t)&&(t(e),d=e.data)}const u=e.children,p=e.sel;if("!"===p)r(e.text)&&(e.text=""),e.elm=f.createComment(e.text);else if(void 0!==p){const r=p.indexOf("#"),i=p.indexOf(".",r),m=r>0?r:p.length,g=i>0?i:p.length,v=-1!==r||-1!==i?p.slice(0,Math.min(m,g)):p,k=e.elm=s(d)&&s(l=d.ns)?f.createElementNS(l,v,d):f.createElement(v,d);for(m<g&&k.setAttribute("id",p.slice(m+1,g)),i>0&&k.setAttribute("class",p.slice(g+1).replace(/\./g," ")),l=0;l<h.create.length;++l)h.create[l](a,e);if(n(u))for(l=0;l<u.length;++l){const e=u[l];null!=e&&f.appendChild(k,b(e,t))}else o(e.text)&&f.appendChild(k,f.createTextNode(e.text));const y=e.data.hook;s(y)&&(null===(c=y.create)||void 0===c||c.call(y,a,e),y.insert&&t.push(e))}else e.elm=f.createTextNode(e.text);return e.elm}function k(e,t,n,o,r,s){for(;o<=r;++o){const r=n[o];null!=r&&f.insertBefore(e,b(r,s),t)}}function y(e){var t,n;const o=e.data;if(void 0!==o){null===(n=null===(t=null==o?void 0:o.hook)||void 0===t?void 0:t.destroy)||void 0===n||n.call(t,e);for(let t=0;t<h.destroy.length;++t)h.destroy[t](e);if(void 0!==e.children)for(let t=0;t<e.children.length;++t){const n=e.children[t];null!=n&&"string"!=typeof n&&y(n)}}}function x(e,t,n,o){for(var r,a;n<=o;++n){let o,i;const c=t[n];if(null!=c)if(s(c.sel)){y(c),o=h.remove.length+1,i=v(c.elm,o);for(let e=0;e<h.remove.length;++e)h.remove[e](c,i);const e=null===(a=null===(r=null==c?void 0:c.data)||void 0===r?void 0:r.hook)||void 0===a?void 0:a.remove;s(e)?e(c,i):i()}else f.removeChild(e,c.elm)}}function w(e,t,n){var o,a,l,d,u;const p=null===(o=t.data)||void 0===o?void 0:o.hook;null===(a=null==p?void 0:p.prepatch)||void 0===a||a.call(p,e,t);const m=t.elm=e.elm,g=e.children,v=t.children;if(e!==t){if(void 0!==t.data){for(let n=0;n<h.update.length;++n)h.update[n](e,t);null===(d=null===(l=t.data.hook)||void 0===l?void 0:l.update)||void 0===d||d.call(l,e,t)}r(t.text)?s(g)&&s(v)?g!==v&&function(e,t,n,o){let s,a,l,d,u=0,p=0,m=t.length-1,h=t[0],g=t[m],v=n.length-1,y=n[0],C=n[v];for(;u<=m&&p<=v;)null==h?h=t[++u]:null==g?g=t[--m]:null==y?y=n[++p]:null==C?C=n[--v]:i(h,y)?(w(h,y,o),h=t[++u],y=n[++p]):i(g,C)?(w(g,C,o),g=t[--m],C=n[--v]):i(h,C)?(w(h,C,o),f.insertBefore(e,h.elm,f.nextSibling(g.elm)),h=t[++u],C=n[--v]):i(g,y)?(w(g,y,o),f.insertBefore(e,g.elm,h.elm),g=t[--m],y=n[++p]):(void 0===s&&(s=c(t,u,m)),a=s[y.key],r(a)?f.insertBefore(e,b(y,o),h.elm):(l=t[a],l.sel!==y.sel?f.insertBefore(e,b(y,o),h.elm):(w(l,y,o),t[a]=void 0,f.insertBefore(e,l.elm,h.elm))),y=n[++p]);(u<=m||p<=v)&&(u>m?(d=null==n[v+1]?null:n[v+1].elm,k(e,d,n,p,v,o)):x(e,t,u,m))}(m,g,v,n):s(v)?(s(e.text)&&f.setTextContent(m,""),k(m,null,v,0,v.length-1,n)):s(g)?x(m,g,0,g.length-1):s(e.text)&&f.setTextContent(m,""):e.text!==t.text&&(s(g)&&x(m,g,0,g.length-1),f.setTextContent(m,t.text)),null===(u=null==p?void 0:p.postpatch)||void 0===u||u.call(p,e,t)}}return function(e,t){let n,o,r;const s=[];for(n=0;n<h.pre.length;++n)h.pre[n]();for(function(e){return void 0!==e.sel}(e)||(e=g(e)),i(e,t)?w(e,t,s):(o=e.elm,r=f.parentNode(o),b(t,s),null!==r&&(f.insertBefore(r,t.elm,f.nextSibling(o)),x(r,[e],0,0))),n=0;n<s.length;++n)s[n].data.hook.insert(s[n]);for(n=0;n<h.post.length;++n)h.post[n]();return t}}([{create:m,update:m},{create:p,update:p}]);return function(e,t){let n,o;const r=()=>{n=q(n||e,o?Z(o):H())};return r(),((e,t={})=>fetch(e,Object.assign(Object.assign(Object.assign({},w),{headers:Object.assign(Object.assign({},x),C)}),t)).then((e=>{if(e.ok)return e.json();throw e.statusText})))("/dasher").then((e=>(o=P(t,e,r),r(),o)))}}();
